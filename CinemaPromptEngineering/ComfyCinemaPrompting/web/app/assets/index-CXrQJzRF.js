var e,t,n,a,r,i,s,o,l,c,d,u,h,p,m,f,g,v,y,x,b,_,w,S,M,C,E,k,T,N,P,j,A,R,I,L,D,U,O,F,z,B,H,$,V,W,G,X,q,K,Y,J,Z,Q,ee,te,ne,ae,re,ie,se,oe,le,ce,de,ue,he,pe,me,fe,ge,ve,ye,xe,be,_e,we,Se,Me,Ce,Ee,ke,Te,Ne,Pe,je,Ae,Re=Object.defineProperty,Ie=e=>{throw TypeError(e)},Le=(e,t,n)=>((e,t,n)=>t in e?Re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n),De=(e,t,n)=>t.has(e)||Ie("Cannot "+n),Ue=(e,t,n)=>(De(e,t,"read from private field"),n?n.call(e):t.get(e)),Oe=(e,t,n)=>t.has(e)?Ie("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),Fe=(e,t,n,a)=>(De(e,t,"write to private field"),a?a.call(e,n):t.set(e,n),n),ze=(e,t,n)=>(De(e,t,"access private method"),n),Be=(e,t,n,a)=>({set _(a){Fe(e,t,a,n)},get _(){return Ue(e,t,a)}});!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var He="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function $e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ve={exports:{}},We={},Ge={exports:{}},Xe={},qe=Symbol.for("react.element"),Ke=Symbol.for("react.portal"),Ye=Symbol.for("react.fragment"),Je=Symbol.for("react.strict_mode"),Ze=Symbol.for("react.profiler"),Qe=Symbol.for("react.provider"),et=Symbol.for("react.context"),tt=Symbol.for("react.forward_ref"),nt=Symbol.for("react.suspense"),at=Symbol.for("react.memo"),rt=Symbol.for("react.lazy"),it=Symbol.iterator;var st={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},ot=Object.assign,lt={};function ct(e,t,n){this.props=e,this.context=t,this.refs=lt,this.updater=n||st}function dt(){}function ut(e,t,n){this.props=e,this.context=t,this.refs=lt,this.updater=n||st}ct.prototype.isReactComponent={},ct.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},ct.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},dt.prototype=ct.prototype;var ht=ut.prototype=new dt;ht.constructor=ut,ot(ht,ct.prototype),ht.isPureReactComponent=!0;var pt=Array.isArray,mt=Object.prototype.hasOwnProperty,ft={current:null},gt={key:!0,ref:!0,__self:!0,__source:!0};function vt(e,t,n){var a,r={},i=null,s=null;if(null!=t)for(a in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(i=""+t.key),t)mt.call(t,a)&&!gt.hasOwnProperty(a)&&(r[a]=t[a]);var o=arguments.length-2;if(1===o)r.children=n;else if(1<o){for(var l=Array(o),c=0;c<o;c++)l[c]=arguments[c+2];r.children=l}if(e&&e.defaultProps)for(a in o=e.defaultProps)void 0===r[a]&&(r[a]=o[a]);return{$$typeof:qe,type:e,key:i,ref:s,props:r,_owner:ft.current}}function yt(e){return"object"==typeof e&&null!==e&&e.$$typeof===qe}var xt=/\/+/g;function bt(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,function(e){return t[e]})}(""+e.key):t.toString(36)}function _t(e,t,n,a,r){var i=typeof e;"undefined"!==i&&"boolean"!==i||(e=null);var s=!1;if(null===e)s=!0;else switch(i){case"string":case"number":s=!0;break;case"object":switch(e.$$typeof){case qe:case Ke:s=!0}}if(s)return r=r(s=e),e=""===a?"."+bt(s,0):a,pt(r)?(n="",null!=e&&(n=e.replace(xt,"$&/")+"/"),_t(r,t,n,"",function(e){return e})):null!=r&&(yt(r)&&(r=function(e,t){return{$$typeof:qe,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(r,n+(!r.key||s&&s.key===r.key?"":(""+r.key).replace(xt,"$&/")+"/")+e)),t.push(r)),1;if(s=0,a=""===a?".":a+":",pt(e))for(var o=0;o<e.length;o++){var l=a+bt(i=e[o],o);s+=_t(i,t,n,l,r)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=it&&e[it]||e["@@iterator"])?e:null}(e),"function"==typeof l)for(e=l.call(e),o=0;!(i=e.next()).done;)s+=_t(i=i.value,t,n,l=a+bt(i,o++),r);else if("object"===i)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return s}function wt(e,t,n){if(null==e)return e;var a=[],r=0;return _t(e,a,"","",function(e){return t.call(n,e,r++)}),a}function St(e){if(-1===e._status){var t=e._result;(t=t()).then(function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)},function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)}),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var Mt={current:null},Ct={transition:null},Et={ReactCurrentDispatcher:Mt,ReactCurrentBatchConfig:Ct,ReactCurrentOwner:ft};function kt(){throw Error("act(...) is not supported in production builds of React.")}Xe.Children={map:wt,forEach:function(e,t,n){wt(e,function(){t.apply(this,arguments)},n)},count:function(e){var t=0;return wt(e,function(){t++}),t},toArray:function(e){return wt(e,function(e){return e})||[]},only:function(e){if(!yt(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},Xe.Component=ct,Xe.Fragment=Ye,Xe.Profiler=Ze,Xe.PureComponent=ut,Xe.StrictMode=Je,Xe.Suspense=nt,Xe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Et,Xe.act=kt,Xe.cloneElement=function(e,t,n){if(null==e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var a=ot({},e.props),r=e.key,i=e.ref,s=e._owner;if(null!=t){if(void 0!==t.ref&&(i=t.ref,s=ft.current),void 0!==t.key&&(r=""+t.key),e.type&&e.type.defaultProps)var o=e.type.defaultProps;for(l in t)mt.call(t,l)&&!gt.hasOwnProperty(l)&&(a[l]=void 0===t[l]&&void 0!==o?o[l]:t[l])}var l=arguments.length-2;if(1===l)a.children=n;else if(1<l){o=Array(l);for(var c=0;c<l;c++)o[c]=arguments[c+2];a.children=o}return{$$typeof:qe,type:e.type,key:r,ref:i,props:a,_owner:s}},Xe.createContext=function(e){return(e={$$typeof:et,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:Qe,_context:e},e.Consumer=e},Xe.createElement=vt,Xe.createFactory=function(e){var t=vt.bind(null,e);return t.type=e,t},Xe.createRef=function(){return{current:null}},Xe.forwardRef=function(e){return{$$typeof:tt,render:e}},Xe.isValidElement=yt,Xe.lazy=function(e){return{$$typeof:rt,_payload:{_status:-1,_result:e},_init:St}},Xe.memo=function(e,t){return{$$typeof:at,type:e,compare:void 0===t?null:t}},Xe.startTransition=function(e){var t=Ct.transition;Ct.transition={};try{e()}finally{Ct.transition=t}},Xe.unstable_act=kt,Xe.useCallback=function(e,t){return Mt.current.useCallback(e,t)},Xe.useContext=function(e){return Mt.current.useContext(e)},Xe.useDebugValue=function(){},Xe.useDeferredValue=function(e){return Mt.current.useDeferredValue(e)},Xe.useEffect=function(e,t){return Mt.current.useEffect(e,t)},Xe.useId=function(){return Mt.current.useId()},Xe.useImperativeHandle=function(e,t,n){return Mt.current.useImperativeHandle(e,t,n)},Xe.useInsertionEffect=function(e,t){return Mt.current.useInsertionEffect(e,t)},Xe.useLayoutEffect=function(e,t){return Mt.current.useLayoutEffect(e,t)},Xe.useMemo=function(e,t){return Mt.current.useMemo(e,t)},Xe.useReducer=function(e,t,n){return Mt.current.useReducer(e,t,n)},Xe.useRef=function(e){return Mt.current.useRef(e)},Xe.useState=function(e){return Mt.current.useState(e)},Xe.useSyncExternalStore=function(e,t,n){return Mt.current.useSyncExternalStore(e,t,n)},Xe.useTransition=function(){return Mt.current.useTransition()},Xe.version="18.3.1",Ge.exports=Xe;var Tt=Ge.exports;const Nt=$e(Tt);
/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Pt=Tt,jt=Symbol.for("react.element"),At=Symbol.for("react.fragment"),Rt=Object.prototype.hasOwnProperty,It=Pt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Lt={key:!0,ref:!0,__self:!0,__source:!0};function Dt(e,t,n){var a,r={},i=null,s=null;for(a in void 0!==n&&(i=""+n),void 0!==t.key&&(i=""+t.key),void 0!==t.ref&&(s=t.ref),t)Rt.call(t,a)&&!Lt.hasOwnProperty(a)&&(r[a]=t[a]);if(e&&e.defaultProps)for(a in t=e.defaultProps)void 0===r[a]&&(r[a]=t[a]);return{$$typeof:jt,type:e,key:i,ref:s,props:r,_owner:It.current}}We.Fragment=At,We.jsx=Dt,We.jsxs=Dt,Ve.exports=We;var Ut=Ve.exports,Ot={},Ft={exports:{}},zt={},Bt={exports:{}},Ht={};
/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
!function(e){function t(e,t){var n=e.length;e.push(t);e:for(;0<n;){var a=n-1>>>1,i=e[a];if(!(0<r(i,t)))break e;e[a]=t,e[n]=i,n=a}}function n(e){return 0===e.length?null:e[0]}function a(e){if(0===e.length)return null;var t=e[0],n=e.pop();if(n!==t){e[0]=n;e:for(var a=0,i=e.length,s=i>>>1;a<s;){var o=2*(a+1)-1,l=e[o],c=o+1,d=e[c];if(0>r(l,n))c<i&&0>r(d,l)?(e[a]=d,e[c]=n,a=c):(e[a]=l,e[o]=n,a=o);else{if(!(c<i&&0>r(d,n)))break e;e[a]=d,e[c]=n,a=c}}}return t}function r(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("object"==typeof performance&&"function"==typeof performance.now){var i=performance;e.unstable_now=function(){return i.now()}}else{var s=Date,o=s.now();e.unstable_now=function(){return s.now()-o}}var l=[],c=[],d=1,u=null,h=3,p=!1,m=!1,f=!1,g="function"==typeof setTimeout?setTimeout:null,v="function"==typeof clearTimeout?clearTimeout:null,y="undefined"!=typeof setImmediate?setImmediate:null;function x(e){for(var r=n(c);null!==r;){if(null===r.callback)a(c);else{if(!(r.startTime<=e))break;a(c),r.sortIndex=r.expirationTime,t(l,r)}r=n(c)}}function b(e){if(f=!1,x(e),!m)if(null!==n(l))m=!0,A(_);else{var t=n(c);null!==t&&R(b,t.startTime-e)}}function _(t,r){m=!1,f&&(f=!1,v(C),C=-1),p=!0;var i=h;try{for(x(r),u=n(l);null!==u&&(!(u.expirationTime>r)||t&&!T());){var s=u.callback;if("function"==typeof s){u.callback=null,h=u.priorityLevel;var o=s(u.expirationTime<=r);r=e.unstable_now(),"function"==typeof o?u.callback=o:u===n(l)&&a(l),x(r)}else a(l);u=n(l)}if(null!==u)var d=!0;else{var g=n(c);null!==g&&R(b,g.startTime-r),d=!1}return d}finally{u=null,h=i,p=!1}}"undefined"!=typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var w,S=!1,M=null,C=-1,E=5,k=-1;function T(){return!(e.unstable_now()-k<E)}function N(){if(null!==M){var t=e.unstable_now();k=t;var n=!0;try{n=M(!0,t)}finally{n?w():(S=!1,M=null)}}else S=!1}if("function"==typeof y)w=function(){y(N)};else if("undefined"!=typeof MessageChannel){var P=new MessageChannel,j=P.port2;P.port1.onmessage=N,w=function(){j.postMessage(null)}}else w=function(){g(N,0)};function A(e){M=e,S||(S=!0,w())}function R(t,n){C=g(function(){t(e.unstable_now())},n)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(e){e.callback=null},e.unstable_continueExecution=function(){m||p||(m=!0,A(_))},e.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):E=0<e?Math.floor(1e3/e):5},e.unstable_getCurrentPriorityLevel=function(){return h},e.unstable_getFirstCallbackNode=function(){return n(l)},e.unstable_next=function(e){switch(h){case 1:case 2:case 3:var t=3;break;default:t=h}var n=h;h=t;try{return e()}finally{h=n}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=function(){},e.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=h;h=e;try{return t()}finally{h=n}},e.unstable_scheduleCallback=function(a,r,i){var s=e.unstable_now();switch("object"==typeof i&&null!==i?i="number"==typeof(i=i.delay)&&0<i?s+i:s:i=s,a){case 1:var o=-1;break;case 2:o=250;break;case 5:o=1073741823;break;case 4:o=1e4;break;default:o=5e3}return a={id:d++,callback:r,priorityLevel:a,startTime:i,expirationTime:o=i+o,sortIndex:-1},i>s?(a.sortIndex=i,t(c,a),null===n(l)&&a===n(c)&&(f?(v(C),C=-1):f=!0,R(b,i-s))):(a.sortIndex=o,t(l,a),m||p||(m=!0,A(_))),a},e.unstable_shouldYield=T,e.unstable_wrapCallback=function(e){var t=h;return function(){var n=h;h=t;try{return e.apply(this,arguments)}finally{h=n}}}}(Ht),Bt.exports=Ht;var $t=Bt.exports,Vt=Tt,Wt=$t;
/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function Gt(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var Xt=new Set,qt={};function Kt(e,t){Yt(e,t),Yt(e+"Capture",t)}function Yt(e,t){for(qt[e]=t,e=0;e<t.length;e++)Xt.add(t[e])}var Jt=!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement),Zt=Object.prototype.hasOwnProperty,Qt=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,en={},tn={};function nn(e,t,n,a,r,i,s){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=a,this.attributeNamespace=r,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=i,this.removeEmptyString=s}var an={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(e){an[e]=new nn(e,0,!1,e,null,!1,!1)}),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(e){var t=e[0];an[t]=new nn(t,1,!1,e[1],null,!1,!1)}),["contentEditable","draggable","spellCheck","value"].forEach(function(e){an[e]=new nn(e,2,!1,e.toLowerCase(),null,!1,!1)}),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(e){an[e]=new nn(e,2,!1,e,null,!1,!1)}),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(e){an[e]=new nn(e,3,!1,e.toLowerCase(),null,!1,!1)}),["checked","multiple","muted","selected"].forEach(function(e){an[e]=new nn(e,3,!0,e,null,!1,!1)}),["capture","download"].forEach(function(e){an[e]=new nn(e,4,!1,e,null,!1,!1)}),["cols","rows","size","span"].forEach(function(e){an[e]=new nn(e,6,!1,e,null,!1,!1)}),["rowSpan","start"].forEach(function(e){an[e]=new nn(e,5,!1,e.toLowerCase(),null,!1,!1)});var rn=/[\-:]([a-z])/g;function sn(e){return e[1].toUpperCase()}function on(e,t,n,a){var r=an.hasOwnProperty(t)?an[t]:null;(null!==r?0!==r.type:a||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,n,a){if(null==t||function(e,t,n,a){if(null!==n&&0===n.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!a&&(null!==n?!n.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,n,a))return!0;if(a)return!1;if(null!==n)switch(n.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,n,r,a)&&(n=null),a||null===r?function(e){return!!Zt.call(tn,e)||!Zt.call(en,e)&&(Qt.test(e)?tn[e]=!0:(en[e]=!0,!1))}(t)&&(null===n?e.removeAttribute(t):e.setAttribute(t,""+n)):r.mustUseProperty?e[r.propertyName]=null===n?3!==r.type&&"":n:(t=r.attributeName,a=r.attributeNamespace,null===n?e.removeAttribute(t):(n=3===(r=r.type)||4===r&&!0===n?"":""+n,a?e.setAttributeNS(a,t,n):e.setAttribute(t,n))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(e){var t=e.replace(rn,sn);an[t]=new nn(t,1,!1,e,null,!1,!1)}),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(e){var t=e.replace(rn,sn);an[t]=new nn(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)}),["xml:base","xml:lang","xml:space"].forEach(function(e){var t=e.replace(rn,sn);an[t]=new nn(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)}),["tabIndex","crossOrigin"].forEach(function(e){an[e]=new nn(e,1,!1,e.toLowerCase(),null,!1,!1)}),an.xlinkHref=new nn("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach(function(e){an[e]=new nn(e,1,!1,e.toLowerCase(),null,!0,!0)});var ln=Vt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,cn=Symbol.for("react.element"),dn=Symbol.for("react.portal"),un=Symbol.for("react.fragment"),hn=Symbol.for("react.strict_mode"),pn=Symbol.for("react.profiler"),mn=Symbol.for("react.provider"),fn=Symbol.for("react.context"),gn=Symbol.for("react.forward_ref"),vn=Symbol.for("react.suspense"),yn=Symbol.for("react.suspense_list"),xn=Symbol.for("react.memo"),bn=Symbol.for("react.lazy"),_n=Symbol.for("react.offscreen"),wn=Symbol.iterator;function Sn(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=wn&&e[wn]||e["@@iterator"])?e:null}var Mn,Cn=Object.assign;function En(e){if(void 0===Mn)try{throw Error()}catch(n){var t=n.stack.trim().match(/\n( *(at )?)/);Mn=t&&t[1]||""}return"\n"+Mn+e}var kn=!1;function Tn(e,t){if(!e||kn)return"";kn=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(c){var a=c}Reflect.construct(e,[],t)}else{try{t.call()}catch(c){a=c}e.call(t.prototype)}else{try{throw Error()}catch(c){a=c}e()}}catch(c){if(c&&a&&"string"==typeof c.stack){for(var r=c.stack.split("\n"),i=a.stack.split("\n"),s=r.length-1,o=i.length-1;1<=s&&0<=o&&r[s]!==i[o];)o--;for(;1<=s&&0<=o;s--,o--)if(r[s]!==i[o]){if(1!==s||1!==o)do{if(s--,0>--o||r[s]!==i[o]){var l="\n"+r[s].replace(" at new "," at ");return e.displayName&&l.includes("<anonymous>")&&(l=l.replace("<anonymous>",e.displayName)),l}}while(1<=s&&0<=o);break}}}finally{kn=!1,Error.prepareStackTrace=n}return(e=e?e.displayName||e.name:"")?En(e):""}function Nn(e){switch(e.tag){case 5:return En(e.type);case 16:return En("Lazy");case 13:return En("Suspense");case 19:return En("SuspenseList");case 0:case 2:case 15:return e=Tn(e.type,!1);case 11:return e=Tn(e.type.render,!1);case 1:return e=Tn(e.type,!0);default:return""}}function Pn(e){if(null==e)return null;if("function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case un:return"Fragment";case dn:return"Portal";case pn:return"Profiler";case hn:return"StrictMode";case vn:return"Suspense";case yn:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case fn:return(e.displayName||"Context")+".Consumer";case mn:return(e._context.displayName||"Context")+".Provider";case gn:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case xn:return null!==(t=e.displayName||null)?t:Pn(e.type)||"Memo";case bn:t=e._payload,e=e._init;try{return Pn(e(t))}catch(n){}}return null}function jn(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return Pn(t);case 8:return t===hn?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"==typeof t)return t.displayName||t.name||null;if("string"==typeof t)return t}return null}function An(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function Rn(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function In(e){e._valueTracker||(e._valueTracker=function(e){var t=Rn(e)?"checked":"value",n=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),a=""+e[t];if(!e.hasOwnProperty(t)&&void 0!==n&&"function"==typeof n.get&&"function"==typeof n.set){var r=n.get,i=n.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return r.call(this)},set:function(e){a=""+e,i.call(this,e)}}),Object.defineProperty(e,t,{enumerable:n.enumerable}),{getValue:function(){return a},setValue:function(e){a=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function Ln(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var n=t.getValue(),a="";return e&&(a=Rn(e)?e.checked?"true":"false":e.value),(e=a)!==n&&(t.setValue(e),!0)}function Dn(e){if(void 0===(e=e||("undefined"!=typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function Un(e,t){var n=t.checked;return Cn({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=n?n:e._wrapperState.initialChecked})}function On(e,t){var n=null==t.defaultValue?"":t.defaultValue,a=null!=t.checked?t.checked:t.defaultChecked;n=An(null!=t.value?t.value:n),e._wrapperState={initialChecked:a,initialValue:n,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function Fn(e,t){null!=(t=t.checked)&&on(e,"checked",t,!1)}function zn(e,t){Fn(e,t);var n=An(t.value),a=t.type;if(null!=n)"number"===a?(0===n&&""===e.value||e.value!=n)&&(e.value=""+n):e.value!==""+n&&(e.value=""+n);else if("submit"===a||"reset"===a)return void e.removeAttribute("value");t.hasOwnProperty("value")?Hn(e,t.type,n):t.hasOwnProperty("defaultValue")&&Hn(e,t.type,An(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function Bn(e,t,n){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var a=t.type;if(!("submit"!==a&&"reset"!==a||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,n||t===e.value||(e.value=t),e.defaultValue=t}""!==(n=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==n&&(e.name=n)}function Hn(e,t,n){"number"===t&&Dn(e.ownerDocument)===e||(null==n?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+n&&(e.defaultValue=""+n))}var $n=Array.isArray;function Vn(e,t,n,a){if(e=e.options,t){t={};for(var r=0;r<n.length;r++)t["$"+n[r]]=!0;for(n=0;n<e.length;n++)r=t.hasOwnProperty("$"+e[n].value),e[n].selected!==r&&(e[n].selected=r),r&&a&&(e[n].defaultSelected=!0)}else{for(n=""+An(n),t=null,r=0;r<e.length;r++){if(e[r].value===n)return e[r].selected=!0,void(a&&(e[r].defaultSelected=!0));null!==t||e[r].disabled||(t=e[r])}null!==t&&(t.selected=!0)}}function Wn(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(Gt(91));return Cn({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function Gn(e,t){var n=t.value;if(null==n){if(n=t.children,t=t.defaultValue,null!=n){if(null!=t)throw Error(Gt(92));if($n(n)){if(1<n.length)throw Error(Gt(93));n=n[0]}t=n}null==t&&(t=""),n=t}e._wrapperState={initialValue:An(n)}}function Xn(e,t){var n=An(t.value),a=An(t.defaultValue);null!=n&&((n=""+n)!==e.value&&(e.value=n),null==t.defaultValue&&e.defaultValue!==n&&(e.defaultValue=n)),null!=a&&(e.defaultValue=""+a)}function qn(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function Kn(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Yn(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?Kn(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var Jn,Zn,Qn=(Zn=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((Jn=Jn||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=Jn.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!=typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,n,a){MSApp.execUnsafeLocalFunction(function(){return Zn(e,t)})}:Zn);function ea(e,t){if(t){var n=e.firstChild;if(n&&n===e.lastChild&&3===n.nodeType)return void(n.nodeValue=t)}e.textContent=t}var ta={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},na=["Webkit","ms","Moz","O"];function aa(e,t,n){return null==t||"boolean"==typeof t||""===t?"":n||"number"!=typeof t||0===t||ta.hasOwnProperty(e)&&ta[e]?(""+t).trim():t+"px"}function ra(e,t){for(var n in e=e.style,t)if(t.hasOwnProperty(n)){var a=0===n.indexOf("--"),r=aa(n,t[n],a);"float"===n&&(n="cssFloat"),a?e.setProperty(n,r):e[n]=r}}Object.keys(ta).forEach(function(e){na.forEach(function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),ta[t]=ta[e]})});var ia=Cn({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function sa(e,t){if(t){if(ia[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(Gt(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(Gt(60));if("object"!=typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(Gt(61))}if(null!=t.style&&"object"!=typeof t.style)throw Error(Gt(62))}}function oa(e,t){if(-1===e.indexOf("-"))return"string"==typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var la=null;function ca(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var da=null,ua=null,ha=null;function pa(e){if(e=so(e)){if("function"!=typeof da)throw Error(Gt(280));var t=e.stateNode;t&&(t=lo(t),da(e.stateNode,e.type,t))}}function ma(e){ua?ha?ha.push(e):ha=[e]:ua=e}function fa(){if(ua){var e=ua,t=ha;if(ha=ua=null,pa(e),t)for(e=0;e<t.length;e++)pa(t[e])}}function ga(e,t){return e(t)}function va(){}var ya=!1;function xa(e,t,n){if(ya)return e(t,n);ya=!0;try{return ga(e,t,n)}finally{ya=!1,(null!==ua||null!==ha)&&(va(),fa())}}function ba(e,t){var n=e.stateNode;if(null===n)return null;var a=lo(n);if(null===a)return null;n=a[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(a=!a.disabled)||(a=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!a;break e;default:e=!1}if(e)return null;if(n&&"function"!=typeof n)throw Error(Gt(231,t,typeof n));return n}var _a=!1;if(Jt)try{var wa={};Object.defineProperty(wa,"passive",{get:function(){_a=!0}}),window.addEventListener("test",wa,wa),window.removeEventListener("test",wa,wa)}catch(Zn){_a=!1}function Sa(e,t,n,a,r,i,s,o,l){var c=Array.prototype.slice.call(arguments,3);try{t.apply(n,c)}catch(d){this.onError(d)}}var Ma=!1,Ca=null,Ea=!1,ka=null,Ta={onError:function(e){Ma=!0,Ca=e}};function Na(e,t,n,a,r,i,s,o,l){Ma=!1,Ca=null,Sa.apply(Ta,arguments)}function Pa(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{!!(4098&(t=e).flags)&&(n=t.return),e=t.return}while(e)}return 3===t.tag?n:null}function ja(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function Aa(e){if(Pa(e)!==e)throw Error(Gt(188))}function Ra(e){return null!==(e=function(e){var t=e.alternate;if(!t){if(null===(t=Pa(e)))throw Error(Gt(188));return t!==e?null:e}for(var n=e,a=t;;){var r=n.return;if(null===r)break;var i=r.alternate;if(null===i){if(null!==(a=r.return)){n=a;continue}break}if(r.child===i.child){for(i=r.child;i;){if(i===n)return Aa(r),e;if(i===a)return Aa(r),t;i=i.sibling}throw Error(Gt(188))}if(n.return!==a.return)n=r,a=i;else{for(var s=!1,o=r.child;o;){if(o===n){s=!0,n=r,a=i;break}if(o===a){s=!0,a=r,n=i;break}o=o.sibling}if(!s){for(o=i.child;o;){if(o===n){s=!0,n=i,a=r;break}if(o===a){s=!0,a=i,n=r;break}o=o.sibling}if(!s)throw Error(Gt(189))}}if(n.alternate!==a)throw Error(Gt(190))}if(3!==n.tag)throw Error(Gt(188));return n.stateNode.current===n?e:t}(e))?Ia(e):null}function Ia(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=Ia(e);if(null!==t)return t;e=e.sibling}return null}var La=Wt.unstable_scheduleCallback,Da=Wt.unstable_cancelCallback,Ua=Wt.unstable_shouldYield,Oa=Wt.unstable_requestPaint,Fa=Wt.unstable_now,za=Wt.unstable_getCurrentPriorityLevel,Ba=Wt.unstable_ImmediatePriority,Ha=Wt.unstable_UserBlockingPriority,$a=Wt.unstable_NormalPriority,Va=Wt.unstable_LowPriority,Wa=Wt.unstable_IdlePriority,Ga=null,Xa=null;var qa=Math.clz32?Math.clz32:function(e){return e>>>=0,0===e?32:31-(Ka(e)/Ya|0)|0},Ka=Math.log,Ya=Math.LN2;var Ja=64,Za=4194304;function Qa(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function er(e,t){var n=e.pendingLanes;if(0===n)return 0;var a=0,r=e.suspendedLanes,i=e.pingedLanes,s=268435455&n;if(0!==s){var o=s&~r;0!==o?a=Qa(o):0!==(i&=s)&&(a=Qa(i))}else 0!==(s=n&~r)?a=Qa(s):0!==i&&(a=Qa(i));if(0===a)return 0;if(0!==t&&t!==a&&0===(t&r)&&((r=a&-a)>=(i=t&-t)||16===r&&4194240&i))return t;if(4&a&&(a|=16&n),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=a;0<t;)r=1<<(n=31-qa(t)),a|=e[n],t&=~r;return a}function tr(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function nr(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function ar(){var e=Ja;return!(4194240&(Ja<<=1))&&(Ja=64),e}function rr(e){for(var t=[],n=0;31>n;n++)t.push(e);return t}function ir(e,t,n){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-qa(t)]=n}function sr(e,t){var n=e.entangledLanes|=t;for(e=e.entanglements;n;){var a=31-qa(n),r=1<<a;r&t|e[a]&t&&(e[a]|=t),n&=~r}}var or=0;function lr(e){return 1<(e&=-e)?4<e?268435455&e?16:536870912:4:1}var cr,dr,ur,hr,pr,mr=!1,fr=[],gr=null,vr=null,yr=null,xr=new Map,br=new Map,_r=[],wr="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Sr(e,t){switch(e){case"focusin":case"focusout":gr=null;break;case"dragenter":case"dragleave":vr=null;break;case"mouseover":case"mouseout":yr=null;break;case"pointerover":case"pointerout":xr.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":br.delete(t.pointerId)}}function Mr(e,t,n,a,r,i){return null===e||e.nativeEvent!==i?(e={blockedOn:t,domEventName:n,eventSystemFlags:a,nativeEvent:i,targetContainers:[r]},null!==t&&(null!==(t=so(t))&&dr(t)),e):(e.eventSystemFlags|=a,t=e.targetContainers,null!==r&&-1===t.indexOf(r)&&t.push(r),e)}function Cr(e){var t=io(e.target);if(null!==t){var n=Pa(t);if(null!==n)if(13===(t=n.tag)){if(null!==(t=ja(n)))return e.blockedOn=t,void pr(e.priority,function(){ur(n)})}else if(3===t&&n.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===n.tag?n.stateNode.containerInfo:null)}e.blockedOn=null}function Er(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var n=Ur(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==n)return null!==(t=so(n))&&dr(t),e.blockedOn=n,!1;var a=new(n=e.nativeEvent).constructor(n.type,n);la=a,n.target.dispatchEvent(a),la=null,t.shift()}return!0}function kr(e,t,n){Er(e)&&n.delete(t)}function Tr(){mr=!1,null!==gr&&Er(gr)&&(gr=null),null!==vr&&Er(vr)&&(vr=null),null!==yr&&Er(yr)&&(yr=null),xr.forEach(kr),br.forEach(kr)}function Nr(e,t){e.blockedOn===t&&(e.blockedOn=null,mr||(mr=!0,Wt.unstable_scheduleCallback(Wt.unstable_NormalPriority,Tr)))}function Pr(e){function t(t){return Nr(t,e)}if(0<fr.length){Nr(fr[0],e);for(var n=1;n<fr.length;n++){var a=fr[n];a.blockedOn===e&&(a.blockedOn=null)}}for(null!==gr&&Nr(gr,e),null!==vr&&Nr(vr,e),null!==yr&&Nr(yr,e),xr.forEach(t),br.forEach(t),n=0;n<_r.length;n++)(a=_r[n]).blockedOn===e&&(a.blockedOn=null);for(;0<_r.length&&null===(n=_r[0]).blockedOn;)Cr(n),null===n.blockedOn&&_r.shift()}var jr=ln.ReactCurrentBatchConfig,Ar=!0;function Rr(e,t,n,a){var r=or,i=jr.transition;jr.transition=null;try{or=1,Lr(e,t,n,a)}finally{or=r,jr.transition=i}}function Ir(e,t,n,a){var r=or,i=jr.transition;jr.transition=null;try{or=4,Lr(e,t,n,a)}finally{or=r,jr.transition=i}}function Lr(e,t,n,a){if(Ar){var r=Ur(e,t,n,a);if(null===r)js(e,t,a,Dr,n),Sr(e,a);else if(function(e,t,n,a,r){switch(t){case"focusin":return gr=Mr(gr,e,t,n,a,r),!0;case"dragenter":return vr=Mr(vr,e,t,n,a,r),!0;case"mouseover":return yr=Mr(yr,e,t,n,a,r),!0;case"pointerover":var i=r.pointerId;return xr.set(i,Mr(xr.get(i)||null,e,t,n,a,r)),!0;case"gotpointercapture":return i=r.pointerId,br.set(i,Mr(br.get(i)||null,e,t,n,a,r)),!0}return!1}(r,e,t,n,a))a.stopPropagation();else if(Sr(e,a),4&t&&-1<wr.indexOf(e)){for(;null!==r;){var i=so(r);if(null!==i&&cr(i),null===(i=Ur(e,t,n,a))&&js(e,t,a,Dr,n),i===r)break;r=i}null!==r&&a.stopPropagation()}else js(e,t,a,null,n)}}var Dr=null;function Ur(e,t,n,a){if(Dr=null,null!==(e=io(e=ca(a))))if(null===(t=Pa(e)))e=null;else if(13===(n=t.tag)){if(null!==(e=ja(t)))return e;e=null}else if(3===n){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return Dr=e,null}function Or(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(za()){case Ba:return 1;case Ha:return 4;case $a:case Va:return 16;case Wa:return 536870912;default:return 16}default:return 16}}var Fr=null,zr=null,Br=null;function Hr(){if(Br)return Br;var e,t,n=zr,a=n.length,r="value"in Fr?Fr.value:Fr.textContent,i=r.length;for(e=0;e<a&&n[e]===r[e];e++);var s=a-e;for(t=1;t<=s&&n[a-t]===r[i-t];t++);return Br=r.slice(e,1<t?1-t:void 0)}function $r(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function Vr(){return!0}function Wr(){return!1}function Gr(e){function t(t,n,a,r,i){for(var s in this._reactName=t,this._targetInst=a,this.type=n,this.nativeEvent=r,this.target=i,this.currentTarget=null,e)e.hasOwnProperty(s)&&(t=e[s],this[s]=t?t(r):r[s]);return this.isDefaultPrevented=(null!=r.defaultPrevented?r.defaultPrevented:!1===r.returnValue)?Vr:Wr,this.isPropagationStopped=Wr,this}return Cn(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!=typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=Vr)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!=typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=Vr)},persist:function(){},isPersistent:Vr}),t}var Xr,qr,Kr,Yr={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Jr=Gr(Yr),Zr=Cn({},Yr,{view:0,detail:0}),Qr=Gr(Zr),ei=Cn({},Zr,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:hi,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==Kr&&(Kr&&"mousemove"===e.type?(Xr=e.screenX-Kr.screenX,qr=e.screenY-Kr.screenY):qr=Xr=0,Kr=e),Xr)},movementY:function(e){return"movementY"in e?e.movementY:qr}}),ti=Gr(ei),ni=Gr(Cn({},ei,{dataTransfer:0})),ai=Gr(Cn({},Zr,{relatedTarget:0})),ri=Gr(Cn({},Yr,{animationName:0,elapsedTime:0,pseudoElement:0})),ii=Cn({},Yr,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),si=Gr(ii),oi=Gr(Cn({},Yr,{data:0})),li={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},ci={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},di={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function ui(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=di[e])&&!!t[e]}function hi(){return ui}var pi=Cn({},Zr,{key:function(e){if(e.key){var t=li[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=$r(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?ci[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:hi,charCode:function(e){return"keypress"===e.type?$r(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?$r(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),mi=Gr(pi),fi=Gr(Cn({},ei,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),gi=Gr(Cn({},Zr,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:hi})),vi=Gr(Cn({},Yr,{propertyName:0,elapsedTime:0,pseudoElement:0})),yi=Cn({},ei,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),xi=Gr(yi),bi=[9,13,27,32],_i=Jt&&"CompositionEvent"in window,wi=null;Jt&&"documentMode"in document&&(wi=document.documentMode);var Si=Jt&&"TextEvent"in window&&!wi,Mi=Jt&&(!_i||wi&&8<wi&&11>=wi),Ci=String.fromCharCode(32),Ei=!1;function ki(e,t){switch(e){case"keyup":return-1!==bi.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Ti(e){return"object"==typeof(e=e.detail)&&"data"in e?e.data:null}var Ni=!1;var Pi={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function ji(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Pi[e.type]:"textarea"===t}function Ai(e,t,n,a){ma(a),0<(t=Rs(t,"onChange")).length&&(n=new Jr("onChange","change",null,n,a),e.push({event:n,listeners:t}))}var Ri=null,Ii=null;function Li(e){Cs(e,0)}function Di(e){if(Ln(oo(e)))return e}function Ui(e,t){if("change"===e)return t}var Oi=!1;if(Jt){var Fi;if(Jt){var zi="oninput"in document;if(!zi){var Bi=document.createElement("div");Bi.setAttribute("oninput","return;"),zi="function"==typeof Bi.oninput}Fi=zi}else Fi=!1;Oi=Fi&&(!document.documentMode||9<document.documentMode)}function Hi(){Ri&&(Ri.detachEvent("onpropertychange",$i),Ii=Ri=null)}function $i(e){if("value"===e.propertyName&&Di(Ii)){var t=[];Ai(t,Ii,e,ca(e)),xa(Li,t)}}function Vi(e,t,n){"focusin"===e?(Hi(),Ii=n,(Ri=t).attachEvent("onpropertychange",$i)):"focusout"===e&&Hi()}function Wi(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Di(Ii)}function Gi(e,t){if("click"===e)return Di(t)}function Xi(e,t){if("input"===e||"change"===e)return Di(t)}var qi="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t};function Ki(e,t){if(qi(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;var n=Object.keys(e),a=Object.keys(t);if(n.length!==a.length)return!1;for(a=0;a<n.length;a++){var r=n[a];if(!Zt.call(t,r)||!qi(e[r],t[r]))return!1}return!0}function Yi(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function Ji(e,t){var n,a=Yi(e);for(e=0;a;){if(3===a.nodeType){if(n=e+a.textContent.length,e<=t&&n>=t)return{node:a,offset:t-e};e=n}e:{for(;a;){if(a.nextSibling){a=a.nextSibling;break e}a=a.parentNode}a=void 0}a=Yi(a)}}function Zi(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?Zi(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function Qi(){for(var e=window,t=Dn();t instanceof e.HTMLIFrameElement;){try{var n="string"==typeof t.contentWindow.location.href}catch(a){n=!1}if(!n)break;t=Dn((e=t.contentWindow).document)}return t}function es(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function ts(e){var t=Qi(),n=e.focusedElem,a=e.selectionRange;if(t!==n&&n&&n.ownerDocument&&Zi(n.ownerDocument.documentElement,n)){if(null!==a&&es(n))if(t=a.start,void 0===(e=a.end)&&(e=t),"selectionStart"in n)n.selectionStart=t,n.selectionEnd=Math.min(e,n.value.length);else if((e=(t=n.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var r=n.textContent.length,i=Math.min(a.start,r);a=void 0===a.end?i:Math.min(a.end,r),!e.extend&&i>a&&(r=a,a=i,i=r),r=Ji(n,i);var s=Ji(n,a);r&&s&&(1!==e.rangeCount||e.anchorNode!==r.node||e.anchorOffset!==r.offset||e.focusNode!==s.node||e.focusOffset!==s.offset)&&((t=t.createRange()).setStart(r.node,r.offset),e.removeAllRanges(),i>a?(e.addRange(t),e.extend(s.node,s.offset)):(t.setEnd(s.node,s.offset),e.addRange(t)))}for(t=[],e=n;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"==typeof n.focus&&n.focus(),n=0;n<t.length;n++)(e=t[n]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var ns=Jt&&"documentMode"in document&&11>=document.documentMode,as=null,rs=null,is=null,ss=!1;function os(e,t,n){var a=n.window===n?n.document:9===n.nodeType?n:n.ownerDocument;ss||null==as||as!==Dn(a)||("selectionStart"in(a=as)&&es(a)?a={start:a.selectionStart,end:a.selectionEnd}:a={anchorNode:(a=(a.ownerDocument&&a.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:a.anchorOffset,focusNode:a.focusNode,focusOffset:a.focusOffset},is&&Ki(is,a)||(is=a,0<(a=Rs(rs,"onSelect")).length&&(t=new Jr("onSelect","select",null,t,n),e.push({event:t,listeners:a}),t.target=as)))}function ls(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n}var cs={animationend:ls("Animation","AnimationEnd"),animationiteration:ls("Animation","AnimationIteration"),animationstart:ls("Animation","AnimationStart"),transitionend:ls("Transition","TransitionEnd")},ds={},us={};function hs(e){if(ds[e])return ds[e];if(!cs[e])return e;var t,n=cs[e];for(t in n)if(n.hasOwnProperty(t)&&t in us)return ds[e]=n[t];return e}Jt&&(us=document.createElement("div").style,"AnimationEvent"in window||(delete cs.animationend.animation,delete cs.animationiteration.animation,delete cs.animationstart.animation),"TransitionEvent"in window||delete cs.transitionend.transition);var ps=hs("animationend"),ms=hs("animationiteration"),fs=hs("animationstart"),gs=hs("transitionend"),vs=new Map,ys="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function xs(e,t){vs.set(e,t),Kt(t,[e])}for(var bs=0;bs<ys.length;bs++){var _s=ys[bs];xs(_s.toLowerCase(),"on"+(_s[0].toUpperCase()+_s.slice(1)))}xs(ps,"onAnimationEnd"),xs(ms,"onAnimationIteration"),xs(fs,"onAnimationStart"),xs("dblclick","onDoubleClick"),xs("focusin","onFocus"),xs("focusout","onBlur"),xs(gs,"onTransitionEnd"),Yt("onMouseEnter",["mouseout","mouseover"]),Yt("onMouseLeave",["mouseout","mouseover"]),Yt("onPointerEnter",["pointerout","pointerover"]),Yt("onPointerLeave",["pointerout","pointerover"]),Kt("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Kt("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Kt("onBeforeInput",["compositionend","keypress","textInput","paste"]),Kt("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Kt("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Kt("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var ws="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Ss=new Set("cancel close invalid load scroll toggle".split(" ").concat(ws));function Ms(e,t,n){var a=e.type||"unknown-event";e.currentTarget=n,function(e,t,n,a,r,i,s,o,l){if(Na.apply(this,arguments),Ma){if(!Ma)throw Error(Gt(198));var c=Ca;Ma=!1,Ca=null,Ea||(Ea=!0,ka=c)}}(a,t,void 0,e),e.currentTarget=null}function Cs(e,t){t=!!(4&t);for(var n=0;n<e.length;n++){var a=e[n],r=a.event;a=a.listeners;e:{var i=void 0;if(t)for(var s=a.length-1;0<=s;s--){var o=a[s],l=o.instance,c=o.currentTarget;if(o=o.listener,l!==i&&r.isPropagationStopped())break e;Ms(r,o,c),i=l}else for(s=0;s<a.length;s++){if(l=(o=a[s]).instance,c=o.currentTarget,o=o.listener,l!==i&&r.isPropagationStopped())break e;Ms(r,o,c),i=l}}}if(Ea)throw e=ka,Ea=!1,ka=null,e}function Es(e,t){var n=t[no];void 0===n&&(n=t[no]=new Set);var a=e+"__bubble";n.has(a)||(Ps(t,e,2,!1),n.add(a))}function ks(e,t,n){var a=0;t&&(a|=4),Ps(n,e,a,t)}var Ts="_reactListening"+Math.random().toString(36).slice(2);function Ns(e){if(!e[Ts]){e[Ts]=!0,Xt.forEach(function(t){"selectionchange"!==t&&(Ss.has(t)||ks(t,!1,e),ks(t,!0,e))});var t=9===e.nodeType?e:e.ownerDocument;null===t||t[Ts]||(t[Ts]=!0,ks("selectionchange",!1,t))}}function Ps(e,t,n,a){switch(Or(t)){case 1:var r=Rr;break;case 4:r=Ir;break;default:r=Lr}n=r.bind(null,t,n,e),r=void 0,!_a||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(r=!0),a?void 0!==r?e.addEventListener(t,n,{capture:!0,passive:r}):e.addEventListener(t,n,!0):void 0!==r?e.addEventListener(t,n,{passive:r}):e.addEventListener(t,n,!1)}function js(e,t,n,a,r){var i=a;if(!(1&t||2&t||null===a))e:for(;;){if(null===a)return;var s=a.tag;if(3===s||4===s){var o=a.stateNode.containerInfo;if(o===r||8===o.nodeType&&o.parentNode===r)break;if(4===s)for(s=a.return;null!==s;){var l=s.tag;if((3===l||4===l)&&((l=s.stateNode.containerInfo)===r||8===l.nodeType&&l.parentNode===r))return;s=s.return}for(;null!==o;){if(null===(s=io(o)))return;if(5===(l=s.tag)||6===l){a=i=s;continue e}o=o.parentNode}}a=a.return}xa(function(){var a=i,r=ca(n),s=[];e:{var o=vs.get(e);if(void 0!==o){var l=Jr,c=e;switch(e){case"keypress":if(0===$r(n))break e;case"keydown":case"keyup":l=mi;break;case"focusin":c="focus",l=ai;break;case"focusout":c="blur",l=ai;break;case"beforeblur":case"afterblur":l=ai;break;case"click":if(2===n.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":l=ti;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":l=ni;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":l=gi;break;case ps:case ms:case fs:l=ri;break;case gs:l=vi;break;case"scroll":l=Qr;break;case"wheel":l=xi;break;case"copy":case"cut":case"paste":l=si;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":l=fi}var d=!!(4&t),u=!d&&"scroll"===e,h=d?null!==o?o+"Capture":null:o;d=[];for(var p,m=a;null!==m;){var f=(p=m).stateNode;if(5===p.tag&&null!==f&&(p=f,null!==h&&(null!=(f=ba(m,h))&&d.push(As(m,f,p)))),u)break;m=m.return}0<d.length&&(o=new l(o,c,null,n,r),s.push({event:o,listeners:d}))}}if(!(7&t)){if(l="mouseout"===e||"pointerout"===e,(!(o="mouseover"===e||"pointerover"===e)||n===la||!(c=n.relatedTarget||n.fromElement)||!io(c)&&!c[to])&&(l||o)&&(o=r.window===r?r:(o=r.ownerDocument)?o.defaultView||o.parentWindow:window,l?(l=a,null!==(c=(c=n.relatedTarget||n.toElement)?io(c):null)&&(c!==(u=Pa(c))||5!==c.tag&&6!==c.tag)&&(c=null)):(l=null,c=a),l!==c)){if(d=ti,f="onMouseLeave",h="onMouseEnter",m="mouse","pointerout"!==e&&"pointerover"!==e||(d=fi,f="onPointerLeave",h="onPointerEnter",m="pointer"),u=null==l?o:oo(l),p=null==c?o:oo(c),(o=new d(f,m+"leave",l,n,r)).target=u,o.relatedTarget=p,f=null,io(r)===a&&((d=new d(h,m+"enter",c,n,r)).target=p,d.relatedTarget=u,f=d),u=f,l&&c)e:{for(h=c,m=0,p=d=l;p;p=Is(p))m++;for(p=0,f=h;f;f=Is(f))p++;for(;0<m-p;)d=Is(d),m--;for(;0<p-m;)h=Is(h),p--;for(;m--;){if(d===h||null!==h&&d===h.alternate)break e;d=Is(d),h=Is(h)}d=null}else d=null;null!==l&&Ls(s,o,l,d,!1),null!==c&&null!==u&&Ls(s,u,c,d,!0)}if("select"===(l=(o=a?oo(a):window).nodeName&&o.nodeName.toLowerCase())||"input"===l&&"file"===o.type)var g=Ui;else if(ji(o))if(Oi)g=Xi;else{g=Wi;var v=Vi}else(l=o.nodeName)&&"input"===l.toLowerCase()&&("checkbox"===o.type||"radio"===o.type)&&(g=Gi);switch(g&&(g=g(e,a))?Ai(s,g,n,r):(v&&v(e,o,a),"focusout"===e&&(v=o._wrapperState)&&v.controlled&&"number"===o.type&&Hn(o,"number",o.value)),v=a?oo(a):window,e){case"focusin":(ji(v)||"true"===v.contentEditable)&&(as=v,rs=a,is=null);break;case"focusout":is=rs=as=null;break;case"mousedown":ss=!0;break;case"contextmenu":case"mouseup":case"dragend":ss=!1,os(s,n,r);break;case"selectionchange":if(ns)break;case"keydown":case"keyup":os(s,n,r)}var y;if(_i)e:{switch(e){case"compositionstart":var x="onCompositionStart";break e;case"compositionend":x="onCompositionEnd";break e;case"compositionupdate":x="onCompositionUpdate";break e}x=void 0}else Ni?ki(e,n)&&(x="onCompositionEnd"):"keydown"===e&&229===n.keyCode&&(x="onCompositionStart");x&&(Mi&&"ko"!==n.locale&&(Ni||"onCompositionStart"!==x?"onCompositionEnd"===x&&Ni&&(y=Hr()):(zr="value"in(Fr=r)?Fr.value:Fr.textContent,Ni=!0)),0<(v=Rs(a,x)).length&&(x=new oi(x,e,null,n,r),s.push({event:x,listeners:v}),y?x.data=y:null!==(y=Ti(n))&&(x.data=y))),(y=Si?function(e,t){switch(e){case"compositionend":return Ti(t);case"keypress":return 32!==t.which?null:(Ei=!0,Ci);case"textInput":return(e=t.data)===Ci&&Ei?null:e;default:return null}}(e,n):function(e,t){if(Ni)return"compositionend"===e||!_i&&ki(e,t)?(e=Hr(),Br=zr=Fr=null,Ni=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return Mi&&"ko"!==t.locale?null:t.data}}(e,n))&&(0<(a=Rs(a,"onBeforeInput")).length&&(r=new oi("onBeforeInput","beforeinput",null,n,r),s.push({event:r,listeners:a}),r.data=y))}Cs(s,t)})}function As(e,t,n){return{instance:e,listener:t,currentTarget:n}}function Rs(e,t){for(var n=t+"Capture",a=[];null!==e;){var r=e,i=r.stateNode;5===r.tag&&null!==i&&(r=i,null!=(i=ba(e,n))&&a.unshift(As(e,i,r)),null!=(i=ba(e,t))&&a.push(As(e,i,r))),e=e.return}return a}function Is(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function Ls(e,t,n,a,r){for(var i=t._reactName,s=[];null!==n&&n!==a;){var o=n,l=o.alternate,c=o.stateNode;if(null!==l&&l===a)break;5===o.tag&&null!==c&&(o=c,r?null!=(l=ba(n,i))&&s.unshift(As(n,l,o)):r||null!=(l=ba(n,i))&&s.push(As(n,l,o))),n=n.return}0!==s.length&&e.push({event:t,listeners:s})}var Ds=/\r\n?/g,Us=/\u0000|\uFFFD/g;function Os(e){return("string"==typeof e?e:""+e).replace(Ds,"\n").replace(Us,"")}function Fs(e,t,n){if(t=Os(t),Os(e)!==t&&n)throw Error(Gt(425))}function zs(){}var Bs=null,Hs=null;function $s(e,t){return"textarea"===e||"noscript"===e||"string"==typeof t.children||"number"==typeof t.children||"object"==typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var Vs="function"==typeof setTimeout?setTimeout:void 0,Ws="function"==typeof clearTimeout?clearTimeout:void 0,Gs="function"==typeof Promise?Promise:void 0,Xs="function"==typeof queueMicrotask?queueMicrotask:void 0!==Gs?function(e){return Gs.resolve(null).then(e).catch(qs)}:Vs;function qs(e){setTimeout(function(){throw e})}function Ks(e,t){var n=t,a=0;do{var r=n.nextSibling;if(e.removeChild(n),r&&8===r.nodeType)if("/$"===(n=r.data)){if(0===a)return e.removeChild(r),void Pr(t);a--}else"$"!==n&&"$?"!==n&&"$!"!==n||a++;n=r}while(n);Pr(t)}function Ys(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function Js(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var n=e.data;if("$"===n||"$!"===n||"$?"===n){if(0===t)return e;t--}else"/$"===n&&t++}e=e.previousSibling}return null}var Zs=Math.random().toString(36).slice(2),Qs="__reactFiber$"+Zs,eo="__reactProps$"+Zs,to="__reactContainer$"+Zs,no="__reactEvents$"+Zs,ao="__reactListeners$"+Zs,ro="__reactHandles$"+Zs;function io(e){var t=e[Qs];if(t)return t;for(var n=e.parentNode;n;){if(t=n[to]||n[Qs]){if(n=t.alternate,null!==t.child||null!==n&&null!==n.child)for(e=Js(e);null!==e;){if(n=e[Qs])return n;e=Js(e)}return t}n=(e=n).parentNode}return null}function so(e){return!(e=e[Qs]||e[to])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function oo(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(Gt(33))}function lo(e){return e[eo]||null}var co=[],uo=-1;function ho(e){return{current:e}}function po(e){0>uo||(e.current=co[uo],co[uo]=null,uo--)}function mo(e,t){uo++,co[uo]=e.current,e.current=t}var fo={},go=ho(fo),vo=ho(!1),yo=fo;function xo(e,t){var n=e.type.contextTypes;if(!n)return fo;var a=e.stateNode;if(a&&a.__reactInternalMemoizedUnmaskedChildContext===t)return a.__reactInternalMemoizedMaskedChildContext;var r,i={};for(r in n)i[r]=t[r];return a&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=i),i}function bo(e){return null!=(e=e.childContextTypes)}function _o(){po(vo),po(go)}function wo(e,t,n){if(go.current!==fo)throw Error(Gt(168));mo(go,t),mo(vo,n)}function So(e,t,n){var a=e.stateNode;if(t=t.childContextTypes,"function"!=typeof a.getChildContext)return n;for(var r in a=a.getChildContext())if(!(r in t))throw Error(Gt(108,jn(e)||"Unknown",r));return Cn({},n,a)}function Mo(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||fo,yo=go.current,mo(go,e),mo(vo,vo.current),!0}function Co(e,t,n){var a=e.stateNode;if(!a)throw Error(Gt(169));n?(e=So(e,t,yo),a.__reactInternalMemoizedMergedChildContext=e,po(vo),po(go),mo(go,e)):po(vo),mo(vo,n)}var Eo=null,ko=!1,To=!1;function No(e){null===Eo?Eo=[e]:Eo.push(e)}function Po(){if(!To&&null!==Eo){To=!0;var e=0,t=or;try{var n=Eo;for(or=1;e<n.length;e++){var a=n[e];do{a=a(!0)}while(null!==a)}Eo=null,ko=!1}catch(r){throw null!==Eo&&(Eo=Eo.slice(e+1)),La(Ba,Po),r}finally{or=t,To=!1}}return null}var jo=[],Ao=0,Ro=null,Io=0,Lo=[],Do=0,Uo=null,Oo=1,Fo="";function zo(e,t){jo[Ao++]=Io,jo[Ao++]=Ro,Ro=e,Io=t}function Bo(e,t,n){Lo[Do++]=Oo,Lo[Do++]=Fo,Lo[Do++]=Uo,Uo=e;var a=Oo;e=Fo;var r=32-qa(a)-1;a&=~(1<<r),n+=1;var i=32-qa(t)+r;if(30<i){var s=r-r%5;i=(a&(1<<s)-1).toString(32),a>>=s,r-=s,Oo=1<<32-qa(t)+r|n<<r|a,Fo=i+e}else Oo=1<<i|n<<r|a,Fo=e}function Ho(e){null!==e.return&&(zo(e,1),Bo(e,1,0))}function $o(e){for(;e===Ro;)Ro=jo[--Ao],jo[Ao]=null,Io=jo[--Ao],jo[Ao]=null;for(;e===Uo;)Uo=Lo[--Do],Lo[Do]=null,Fo=Lo[--Do],Lo[Do]=null,Oo=Lo[--Do],Lo[Do]=null}var Vo=null,Wo=null,Go=!1,Xo=null;function qo(e,t){var n=yh(5,null,null,0);n.elementType="DELETED",n.stateNode=t,n.return=e,null===(t=e.deletions)?(e.deletions=[n],e.flags|=16):t.push(n)}function Ko(e,t){switch(e.tag){case 5:var n=e.type;return null!==(t=1!==t.nodeType||n.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,Vo=e,Wo=Ys(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,Vo=e,Wo=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(n=null!==Uo?{id:Oo,overflow:Fo}:null,e.memoizedState={dehydrated:t,treeContext:n,retryLane:1073741824},(n=yh(18,null,null,0)).stateNode=t,n.return=e,e.child=n,Vo=e,Wo=null,!0);default:return!1}}function Yo(e){return!(!(1&e.mode)||128&e.flags)}function Jo(e){if(Go){var t=Wo;if(t){var n=t;if(!Ko(e,t)){if(Yo(e))throw Error(Gt(418));t=Ys(n.nextSibling);var a=Vo;t&&Ko(e,t)?qo(a,n):(e.flags=-4097&e.flags|2,Go=!1,Vo=e)}}else{if(Yo(e))throw Error(Gt(418));e.flags=-4097&e.flags|2,Go=!1,Vo=e}}}function Zo(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;Vo=e}function Qo(e){if(e!==Vo)return!1;if(!Go)return Zo(e),Go=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!$s(e.type,e.memoizedProps)),t&&(t=Wo)){if(Yo(e))throw el(),Error(Gt(418));for(;t;)qo(e,t),t=Ys(t.nextSibling)}if(Zo(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(Gt(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var n=e.data;if("/$"===n){if(0===t){Wo=Ys(e.nextSibling);break e}t--}else"$"!==n&&"$!"!==n&&"$?"!==n||t++}e=e.nextSibling}Wo=null}}else Wo=Vo?Ys(e.stateNode.nextSibling):null;return!0}function el(){for(var e=Wo;e;)e=Ys(e.nextSibling)}function tl(){Wo=Vo=null,Go=!1}function nl(e){null===Xo?Xo=[e]:Xo.push(e)}var al=ln.ReactCurrentBatchConfig;function rl(e,t,n){if(null!==(e=n.ref)&&"function"!=typeof e&&"object"!=typeof e){if(n._owner){if(n=n._owner){if(1!==n.tag)throw Error(Gt(309));var a=n.stateNode}if(!a)throw Error(Gt(147,e));var r=a,i=""+e;return null!==t&&null!==t.ref&&"function"==typeof t.ref&&t.ref._stringRef===i?t.ref:((t=function(e){var t=r.refs;null===e?delete t[i]:t[i]=e})._stringRef=i,t)}if("string"!=typeof e)throw Error(Gt(284));if(!n._owner)throw Error(Gt(290,e))}return e}function il(e,t){throw e=Object.prototype.toString.call(t),Error(Gt(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function sl(e){return(0,e._init)(e._payload)}function ol(e){function t(t,n){if(e){var a=t.deletions;null===a?(t.deletions=[n],t.flags|=16):a.push(n)}}function n(n,a){if(!e)return null;for(;null!==a;)t(n,a),a=a.sibling;return null}function a(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function r(e,t){return(e=bh(e,t)).index=0,e.sibling=null,e}function i(t,n,a){return t.index=a,e?null!==(a=t.alternate)?(a=a.index)<n?(t.flags|=2,n):a:(t.flags|=2,n):(t.flags|=1048576,n)}function s(t){return e&&null===t.alternate&&(t.flags|=2),t}function o(e,t,n,a){return null===t||6!==t.tag?((t=Mh(n,e.mode,a)).return=e,t):((t=r(t,n)).return=e,t)}function l(e,t,n,a){var i=n.type;return i===un?d(e,t,n.props.children,a,n.key):null!==t&&(t.elementType===i||"object"==typeof i&&null!==i&&i.$$typeof===bn&&sl(i)===t.type)?((a=r(t,n.props)).ref=rl(e,t,n),a.return=e,a):((a=_h(n.type,n.key,n.props,null,e.mode,a)).ref=rl(e,t,n),a.return=e,a)}function c(e,t,n,a){return null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation?((t=Ch(n,e.mode,a)).return=e,t):((t=r(t,n.children||[])).return=e,t)}function d(e,t,n,a,i){return null===t||7!==t.tag?((t=wh(n,e.mode,a,i)).return=e,t):((t=r(t,n)).return=e,t)}function u(e,t,n){if("string"==typeof t&&""!==t||"number"==typeof t)return(t=Mh(""+t,e.mode,n)).return=e,t;if("object"==typeof t&&null!==t){switch(t.$$typeof){case cn:return(n=_h(t.type,t.key,t.props,null,e.mode,n)).ref=rl(e,null,t),n.return=e,n;case dn:return(t=Ch(t,e.mode,n)).return=e,t;case bn:return u(e,(0,t._init)(t._payload),n)}if($n(t)||Sn(t))return(t=wh(t,e.mode,n,null)).return=e,t;il(e,t)}return null}function h(e,t,n,a){var r=null!==t?t.key:null;if("string"==typeof n&&""!==n||"number"==typeof n)return null!==r?null:o(e,t,""+n,a);if("object"==typeof n&&null!==n){switch(n.$$typeof){case cn:return n.key===r?l(e,t,n,a):null;case dn:return n.key===r?c(e,t,n,a):null;case bn:return h(e,t,(r=n._init)(n._payload),a)}if($n(n)||Sn(n))return null!==r?null:d(e,t,n,a,null);il(e,n)}return null}function p(e,t,n,a,r){if("string"==typeof a&&""!==a||"number"==typeof a)return o(t,e=e.get(n)||null,""+a,r);if("object"==typeof a&&null!==a){switch(a.$$typeof){case cn:return l(t,e=e.get(null===a.key?n:a.key)||null,a,r);case dn:return c(t,e=e.get(null===a.key?n:a.key)||null,a,r);case bn:return p(e,t,n,(0,a._init)(a._payload),r)}if($n(a)||Sn(a))return d(t,e=e.get(n)||null,a,r,null);il(t,a)}return null}return function o(l,c,d,m){if("object"==typeof d&&null!==d&&d.type===un&&null===d.key&&(d=d.props.children),"object"==typeof d&&null!==d){switch(d.$$typeof){case cn:e:{for(var f=d.key,g=c;null!==g;){if(g.key===f){if((f=d.type)===un){if(7===g.tag){n(l,g.sibling),(c=r(g,d.props.children)).return=l,l=c;break e}}else if(g.elementType===f||"object"==typeof f&&null!==f&&f.$$typeof===bn&&sl(f)===g.type){n(l,g.sibling),(c=r(g,d.props)).ref=rl(l,g,d),c.return=l,l=c;break e}n(l,g);break}t(l,g),g=g.sibling}d.type===un?((c=wh(d.props.children,l.mode,m,d.key)).return=l,l=c):((m=_h(d.type,d.key,d.props,null,l.mode,m)).ref=rl(l,c,d),m.return=l,l=m)}return s(l);case dn:e:{for(g=d.key;null!==c;){if(c.key===g){if(4===c.tag&&c.stateNode.containerInfo===d.containerInfo&&c.stateNode.implementation===d.implementation){n(l,c.sibling),(c=r(c,d.children||[])).return=l,l=c;break e}n(l,c);break}t(l,c),c=c.sibling}(c=Ch(d,l.mode,m)).return=l,l=c}return s(l);case bn:return o(l,c,(g=d._init)(d._payload),m)}if($n(d))return function(r,s,o,l){for(var c=null,d=null,m=s,f=s=0,g=null;null!==m&&f<o.length;f++){m.index>f?(g=m,m=null):g=m.sibling;var v=h(r,m,o[f],l);if(null===v){null===m&&(m=g);break}e&&m&&null===v.alternate&&t(r,m),s=i(v,s,f),null===d?c=v:d.sibling=v,d=v,m=g}if(f===o.length)return n(r,m),Go&&zo(r,f),c;if(null===m){for(;f<o.length;f++)null!==(m=u(r,o[f],l))&&(s=i(m,s,f),null===d?c=m:d.sibling=m,d=m);return Go&&zo(r,f),c}for(m=a(r,m);f<o.length;f++)null!==(g=p(m,r,f,o[f],l))&&(e&&null!==g.alternate&&m.delete(null===g.key?f:g.key),s=i(g,s,f),null===d?c=g:d.sibling=g,d=g);return e&&m.forEach(function(e){return t(r,e)}),Go&&zo(r,f),c}(l,c,d,m);if(Sn(d))return function(r,s,o,l){var c=Sn(o);if("function"!=typeof c)throw Error(Gt(150));if(null==(o=c.call(o)))throw Error(Gt(151));for(var d=c=null,m=s,f=s=0,g=null,v=o.next();null!==m&&!v.done;f++,v=o.next()){m.index>f?(g=m,m=null):g=m.sibling;var y=h(r,m,v.value,l);if(null===y){null===m&&(m=g);break}e&&m&&null===y.alternate&&t(r,m),s=i(y,s,f),null===d?c=y:d.sibling=y,d=y,m=g}if(v.done)return n(r,m),Go&&zo(r,f),c;if(null===m){for(;!v.done;f++,v=o.next())null!==(v=u(r,v.value,l))&&(s=i(v,s,f),null===d?c=v:d.sibling=v,d=v);return Go&&zo(r,f),c}for(m=a(r,m);!v.done;f++,v=o.next())null!==(v=p(m,r,f,v.value,l))&&(e&&null!==v.alternate&&m.delete(null===v.key?f:v.key),s=i(v,s,f),null===d?c=v:d.sibling=v,d=v);return e&&m.forEach(function(e){return t(r,e)}),Go&&zo(r,f),c}(l,c,d,m);il(l,d)}return"string"==typeof d&&""!==d||"number"==typeof d?(d=""+d,null!==c&&6===c.tag?(n(l,c.sibling),(c=r(c,d)).return=l,l=c):(n(l,c),(c=Mh(d,l.mode,m)).return=l,l=c),s(l)):n(l,c)}}var ll=ol(!0),cl=ol(!1),dl=ho(null),ul=null,hl=null,pl=null;function ml(){pl=hl=ul=null}function fl(e){var t=dl.current;po(dl),e._currentValue=t}function gl(e,t,n){for(;null!==e;){var a=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==a&&(a.childLanes|=t)):null!==a&&(a.childLanes&t)!==t&&(a.childLanes|=t),e===n)break;e=e.return}}function vl(e,t){ul=e,pl=hl=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!==(e.lanes&t)&&(sd=!0),e.firstContext=null)}function yl(e){var t=e._currentValue;if(pl!==e)if(e={context:e,memoizedValue:t,next:null},null===hl){if(null===ul)throw Error(Gt(308));hl=e,ul.dependencies={lanes:0,firstContext:e}}else hl=hl.next=e;return t}var xl=null;function bl(e){null===xl?xl=[e]:xl.push(e)}function _l(e,t,n,a){var r=t.interleaved;return null===r?(n.next=n,bl(t)):(n.next=r.next,r.next=n),t.interleaved=n,wl(e,a)}function wl(e,t){e.lanes|=t;var n=e.alternate;for(null!==n&&(n.lanes|=t),n=e,e=e.return;null!==e;)e.childLanes|=t,null!==(n=e.alternate)&&(n.childLanes|=t),n=e,e=e.return;return 3===n.tag?n.stateNode:null}var Sl=!1;function Ml(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Cl(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function El(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function kl(e,t,n){var a=e.updateQueue;if(null===a)return null;if(a=a.shared,2&fu){var r=a.pending;return null===r?t.next=t:(t.next=r.next,r.next=t),a.pending=t,wl(e,n)}return null===(r=a.interleaved)?(t.next=t,bl(a)):(t.next=r.next,r.next=t),a.interleaved=t,wl(e,n)}function Tl(e,t,n){if(null!==(t=t.updateQueue)&&(t=t.shared,4194240&n)){var a=t.lanes;n|=a&=e.pendingLanes,t.lanes=n,sr(e,n)}}function Nl(e,t){var n=e.updateQueue,a=e.alternate;if(null!==a&&n===(a=a.updateQueue)){var r=null,i=null;if(null!==(n=n.firstBaseUpdate)){do{var s={eventTime:n.eventTime,lane:n.lane,tag:n.tag,payload:n.payload,callback:n.callback,next:null};null===i?r=i=s:i=i.next=s,n=n.next}while(null!==n);null===i?r=i=t:i=i.next=t}else r=i=t;return n={baseState:a.baseState,firstBaseUpdate:r,lastBaseUpdate:i,shared:a.shared,effects:a.effects},void(e.updateQueue=n)}null===(e=n.lastBaseUpdate)?n.firstBaseUpdate=t:e.next=t,n.lastBaseUpdate=t}function Pl(e,t,n,a){var r=e.updateQueue;Sl=!1;var i=r.firstBaseUpdate,s=r.lastBaseUpdate,o=r.shared.pending;if(null!==o){r.shared.pending=null;var l=o,c=l.next;l.next=null,null===s?i=c:s.next=c,s=l;var d=e.alternate;null!==d&&((o=(d=d.updateQueue).lastBaseUpdate)!==s&&(null===o?d.firstBaseUpdate=c:o.next=c,d.lastBaseUpdate=l))}if(null!==i){var u=r.baseState;for(s=0,d=c=l=null,o=i;;){var h=o.lane,p=o.eventTime;if((a&h)===h){null!==d&&(d=d.next={eventTime:p,lane:0,tag:o.tag,payload:o.payload,callback:o.callback,next:null});e:{var m=e,f=o;switch(h=t,p=n,f.tag){case 1:if("function"==typeof(m=f.payload)){u=m.call(p,u,h);break e}u=m;break e;case 3:m.flags=-65537&m.flags|128;case 0:if(null==(h="function"==typeof(m=f.payload)?m.call(p,u,h):m))break e;u=Cn({},u,h);break e;case 2:Sl=!0}}null!==o.callback&&0!==o.lane&&(e.flags|=64,null===(h=r.effects)?r.effects=[o]:h.push(o))}else p={eventTime:p,lane:h,tag:o.tag,payload:o.payload,callback:o.callback,next:null},null===d?(c=d=p,l=u):d=d.next=p,s|=h;if(null===(o=o.next)){if(null===(o=r.shared.pending))break;o=(h=o).next,h.next=null,r.lastBaseUpdate=h,r.shared.pending=null}}if(null===d&&(l=u),r.baseState=l,r.firstBaseUpdate=c,r.lastBaseUpdate=d,null!==(t=r.shared.interleaved)){r=t;do{s|=r.lane,r=r.next}while(r!==t)}else null===i&&(r.shared.lanes=0);Su|=s,e.lanes=s,e.memoizedState=u}}function jl(e,t,n){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var a=e[t],r=a.callback;if(null!==r){if(a.callback=null,a=n,"function"!=typeof r)throw Error(Gt(191,r));r.call(a)}}}var Al={},Rl=ho(Al),Il=ho(Al),Ll=ho(Al);function Dl(e){if(e===Al)throw Error(Gt(174));return e}function Ul(e,t){switch(mo(Ll,t),mo(Il,e),mo(Rl,Al),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:Yn(null,"");break;default:t=Yn(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}po(Rl),mo(Rl,t)}function Ol(){po(Rl),po(Il),po(Ll)}function Fl(e){Dl(Ll.current);var t=Dl(Rl.current),n=Yn(t,e.type);t!==n&&(mo(Il,e),mo(Rl,n))}function zl(e){Il.current===e&&(po(Rl),po(Il))}var Bl=ho(0);function Hl(e){for(var t=e;null!==t;){if(13===t.tag){var n=t.memoizedState;if(null!==n&&(null===(n=n.dehydrated)||"$?"===n.data||"$!"===n.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(128&t.flags)return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var $l=[];function Vl(){for(var e=0;e<$l.length;e++)$l[e]._workInProgressVersionPrimary=null;$l.length=0}var Wl=ln.ReactCurrentDispatcher,Gl=ln.ReactCurrentBatchConfig,Xl=0,ql=null,Kl=null,Yl=null,Jl=!1,Zl=!1,Ql=0,ec=0;function tc(){throw Error(Gt(321))}function nc(e,t){if(null===t)return!1;for(var n=0;n<t.length&&n<e.length;n++)if(!qi(e[n],t[n]))return!1;return!0}function ac(e,t,n,a,r,i){if(Xl=i,ql=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,Wl.current=null===e||null===e.memoizedState?zc:Bc,e=n(a,r),Zl){i=0;do{if(Zl=!1,Ql=0,25<=i)throw Error(Gt(301));i+=1,Yl=Kl=null,t.updateQueue=null,Wl.current=Hc,e=n(a,r)}while(Zl)}if(Wl.current=Fc,t=null!==Kl&&null!==Kl.next,Xl=0,Yl=Kl=ql=null,Jl=!1,t)throw Error(Gt(300));return e}function rc(){var e=0!==Ql;return Ql=0,e}function ic(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===Yl?ql.memoizedState=Yl=e:Yl=Yl.next=e,Yl}function sc(){if(null===Kl){var e=ql.alternate;e=null!==e?e.memoizedState:null}else e=Kl.next;var t=null===Yl?ql.memoizedState:Yl.next;if(null!==t)Yl=t,Kl=e;else{if(null===e)throw Error(Gt(310));e={memoizedState:(Kl=e).memoizedState,baseState:Kl.baseState,baseQueue:Kl.baseQueue,queue:Kl.queue,next:null},null===Yl?ql.memoizedState=Yl=e:Yl=Yl.next=e}return Yl}function oc(e,t){return"function"==typeof t?t(e):t}function lc(e){var t=sc(),n=t.queue;if(null===n)throw Error(Gt(311));n.lastRenderedReducer=e;var a=Kl,r=a.baseQueue,i=n.pending;if(null!==i){if(null!==r){var s=r.next;r.next=i.next,i.next=s}a.baseQueue=r=i,n.pending=null}if(null!==r){i=r.next,a=a.baseState;var o=s=null,l=null,c=i;do{var d=c.lane;if((Xl&d)===d)null!==l&&(l=l.next={lane:0,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null}),a=c.hasEagerState?c.eagerState:e(a,c.action);else{var u={lane:d,action:c.action,hasEagerState:c.hasEagerState,eagerState:c.eagerState,next:null};null===l?(o=l=u,s=a):l=l.next=u,ql.lanes|=d,Su|=d}c=c.next}while(null!==c&&c!==i);null===l?s=a:l.next=o,qi(a,t.memoizedState)||(sd=!0),t.memoizedState=a,t.baseState=s,t.baseQueue=l,n.lastRenderedState=a}if(null!==(e=n.interleaved)){r=e;do{i=r.lane,ql.lanes|=i,Su|=i,r=r.next}while(r!==e)}else null===r&&(n.lanes=0);return[t.memoizedState,n.dispatch]}function cc(e){var t=sc(),n=t.queue;if(null===n)throw Error(Gt(311));n.lastRenderedReducer=e;var a=n.dispatch,r=n.pending,i=t.memoizedState;if(null!==r){n.pending=null;var s=r=r.next;do{i=e(i,s.action),s=s.next}while(s!==r);qi(i,t.memoizedState)||(sd=!0),t.memoizedState=i,null===t.baseQueue&&(t.baseState=i),n.lastRenderedState=i}return[i,a]}function dc(){}function uc(e,t){var n=ql,a=sc(),r=t(),i=!qi(a.memoizedState,r);if(i&&(a.memoizedState=r,sd=!0),a=a.queue,Sc(mc.bind(null,n,a,e),[e]),a.getSnapshot!==t||i||null!==Yl&&1&Yl.memoizedState.tag){if(n.flags|=2048,yc(9,pc.bind(null,n,a,r,t),void 0,null),null===gu)throw Error(Gt(349));30&Xl||hc(n,t,r)}return r}function hc(e,t,n){e.flags|=16384,e={getSnapshot:t,value:n},null===(t=ql.updateQueue)?(t={lastEffect:null,stores:null},ql.updateQueue=t,t.stores=[e]):null===(n=t.stores)?t.stores=[e]:n.push(e)}function pc(e,t,n,a){t.value=n,t.getSnapshot=a,fc(t)&&gc(e)}function mc(e,t,n){return n(function(){fc(t)&&gc(e)})}function fc(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!qi(e,n)}catch(a){return!0}}function gc(e){var t=wl(e,1);null!==t&&$u(t,e,1,-1)}function vc(e){var t=ic();return"function"==typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:oc,lastRenderedState:e},t.queue=e,e=e.dispatch=Lc.bind(null,ql,e),[t.memoizedState,e]}function yc(e,t,n,a){return e={tag:e,create:t,destroy:n,deps:a,next:null},null===(t=ql.updateQueue)?(t={lastEffect:null,stores:null},ql.updateQueue=t,t.lastEffect=e.next=e):null===(n=t.lastEffect)?t.lastEffect=e.next=e:(a=n.next,n.next=e,e.next=a,t.lastEffect=e),e}function xc(){return sc().memoizedState}function bc(e,t,n,a){var r=ic();ql.flags|=e,r.memoizedState=yc(1|t,n,void 0,void 0===a?null:a)}function _c(e,t,n,a){var r=sc();a=void 0===a?null:a;var i=void 0;if(null!==Kl){var s=Kl.memoizedState;if(i=s.destroy,null!==a&&nc(a,s.deps))return void(r.memoizedState=yc(t,n,i,a))}ql.flags|=e,r.memoizedState=yc(1|t,n,i,a)}function wc(e,t){return bc(8390656,8,e,t)}function Sc(e,t){return _c(2048,8,e,t)}function Mc(e,t){return _c(4,2,e,t)}function Cc(e,t){return _c(4,4,e,t)}function Ec(e,t){return"function"==typeof t?(e=e(),t(e),function(){t(null)}):null!=t?(e=e(),t.current=e,function(){t.current=null}):void 0}function kc(e,t,n){return n=null!=n?n.concat([e]):null,_c(4,4,Ec.bind(null,t,e),n)}function Tc(){}function Nc(e,t){var n=sc();t=void 0===t?null:t;var a=n.memoizedState;return null!==a&&null!==t&&nc(t,a[1])?a[0]:(n.memoizedState=[e,t],e)}function Pc(e,t){var n=sc();t=void 0===t?null:t;var a=n.memoizedState;return null!==a&&null!==t&&nc(t,a[1])?a[0]:(e=e(),n.memoizedState=[e,t],e)}function jc(e,t,n){return 21&Xl?(qi(n,t)||(n=ar(),ql.lanes|=n,Su|=n,e.baseState=!0),t):(e.baseState&&(e.baseState=!1,sd=!0),e.memoizedState=n)}function Ac(e,t){var n=or;or=0!==n&&4>n?n:4,e(!0);var a=Gl.transition;Gl.transition={};try{e(!1),t()}finally{or=n,Gl.transition=a}}function Rc(){return sc().memoizedState}function Ic(e,t,n){var a=Hu(e);if(n={lane:a,action:n,hasEagerState:!1,eagerState:null,next:null},Dc(e))Uc(t,n);else if(null!==(n=_l(e,t,n,a))){$u(n,e,a,Bu()),Oc(n,t,a)}}function Lc(e,t,n){var a=Hu(e),r={lane:a,action:n,hasEagerState:!1,eagerState:null,next:null};if(Dc(e))Uc(t,r);else{var i=e.alternate;if(0===e.lanes&&(null===i||0===i.lanes)&&null!==(i=t.lastRenderedReducer))try{var s=t.lastRenderedState,o=i(s,n);if(r.hasEagerState=!0,r.eagerState=o,qi(o,s)){var l=t.interleaved;return null===l?(r.next=r,bl(t)):(r.next=l.next,l.next=r),void(t.interleaved=r)}}catch(c){}null!==(n=_l(e,t,r,a))&&($u(n,e,a,r=Bu()),Oc(n,t,a))}}function Dc(e){var t=e.alternate;return e===ql||null!==t&&t===ql}function Uc(e,t){Zl=Jl=!0;var n=e.pending;null===n?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function Oc(e,t,n){if(4194240&n){var a=t.lanes;n|=a&=e.pendingLanes,t.lanes=n,sr(e,n)}}var Fc={readContext:yl,useCallback:tc,useContext:tc,useEffect:tc,useImperativeHandle:tc,useInsertionEffect:tc,useLayoutEffect:tc,useMemo:tc,useReducer:tc,useRef:tc,useState:tc,useDebugValue:tc,useDeferredValue:tc,useTransition:tc,useMutableSource:tc,useSyncExternalStore:tc,useId:tc,unstable_isNewReconciler:!1},zc={readContext:yl,useCallback:function(e,t){return ic().memoizedState=[e,void 0===t?null:t],e},useContext:yl,useEffect:wc,useImperativeHandle:function(e,t,n){return n=null!=n?n.concat([e]):null,bc(4194308,4,Ec.bind(null,t,e),n)},useLayoutEffect:function(e,t){return bc(4194308,4,e,t)},useInsertionEffect:function(e,t){return bc(4,2,e,t)},useMemo:function(e,t){var n=ic();return t=void 0===t?null:t,e=e(),n.memoizedState=[e,t],e},useReducer:function(e,t,n){var a=ic();return t=void 0!==n?n(t):t,a.memoizedState=a.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},a.queue=e,e=e.dispatch=Ic.bind(null,ql,e),[a.memoizedState,e]},useRef:function(e){return e={current:e},ic().memoizedState=e},useState:vc,useDebugValue:Tc,useDeferredValue:function(e){return ic().memoizedState=e},useTransition:function(){var e=vc(!1),t=e[0];return e=Ac.bind(null,e[1]),ic().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,n){var a=ql,r=ic();if(Go){if(void 0===n)throw Error(Gt(407));n=n()}else{if(n=t(),null===gu)throw Error(Gt(349));30&Xl||hc(a,t,n)}r.memoizedState=n;var i={value:n,getSnapshot:t};return r.queue=i,wc(mc.bind(null,a,i,e),[e]),a.flags|=2048,yc(9,pc.bind(null,a,i,n,t),void 0,null),n},useId:function(){var e=ic(),t=gu.identifierPrefix;if(Go){var n=Fo;t=":"+t+"R"+(n=(Oo&~(1<<32-qa(Oo)-1)).toString(32)+n),0<(n=Ql++)&&(t+="H"+n.toString(32)),t+=":"}else t=":"+t+"r"+(n=ec++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},Bc={readContext:yl,useCallback:Nc,useContext:yl,useEffect:Sc,useImperativeHandle:kc,useInsertionEffect:Mc,useLayoutEffect:Cc,useMemo:Pc,useReducer:lc,useRef:xc,useState:function(){return lc(oc)},useDebugValue:Tc,useDeferredValue:function(e){return jc(sc(),Kl.memoizedState,e)},useTransition:function(){return[lc(oc)[0],sc().memoizedState]},useMutableSource:dc,useSyncExternalStore:uc,useId:Rc,unstable_isNewReconciler:!1},Hc={readContext:yl,useCallback:Nc,useContext:yl,useEffect:Sc,useImperativeHandle:kc,useInsertionEffect:Mc,useLayoutEffect:Cc,useMemo:Pc,useReducer:cc,useRef:xc,useState:function(){return cc(oc)},useDebugValue:Tc,useDeferredValue:function(e){var t=sc();return null===Kl?t.memoizedState=e:jc(t,Kl.memoizedState,e)},useTransition:function(){return[cc(oc)[0],sc().memoizedState]},useMutableSource:dc,useSyncExternalStore:uc,useId:Rc,unstable_isNewReconciler:!1};function $c(e,t){if(e&&e.defaultProps){for(var n in t=Cn({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}function Vc(e,t,n,a){n=null==(n=n(a,t=e.memoizedState))?t:Cn({},t,n),e.memoizedState=n,0===e.lanes&&(e.updateQueue.baseState=n)}var Wc={isMounted:function(e){return!!(e=e._reactInternals)&&Pa(e)===e},enqueueSetState:function(e,t,n){e=e._reactInternals;var a=Bu(),r=Hu(e),i=El(a,r);i.payload=t,null!=n&&(i.callback=n),null!==(t=kl(e,i,r))&&($u(t,e,r,a),Tl(t,e,r))},enqueueReplaceState:function(e,t,n){e=e._reactInternals;var a=Bu(),r=Hu(e),i=El(a,r);i.tag=1,i.payload=t,null!=n&&(i.callback=n),null!==(t=kl(e,i,r))&&($u(t,e,r,a),Tl(t,e,r))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var n=Bu(),a=Hu(e),r=El(n,a);r.tag=2,null!=t&&(r.callback=t),null!==(t=kl(e,r,a))&&($u(t,e,a,n),Tl(t,e,a))}};function Gc(e,t,n,a,r,i,s){return"function"==typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(a,i,s):!t.prototype||!t.prototype.isPureReactComponent||(!Ki(n,a)||!Ki(r,i))}function Xc(e,t,n){var a=!1,r=fo,i=t.contextType;return"object"==typeof i&&null!==i?i=yl(i):(r=bo(t)?yo:go.current,i=(a=null!=(a=t.contextTypes))?xo(e,r):fo),t=new t(n,i),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=Wc,e.stateNode=t,t._reactInternals=e,a&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=r,e.__reactInternalMemoizedMaskedChildContext=i),t}function qc(e,t,n,a){e=t.state,"function"==typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(n,a),"function"==typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(n,a),t.state!==e&&Wc.enqueueReplaceState(t,t.state,null)}function Kc(e,t,n,a){var r=e.stateNode;r.props=n,r.state=e.memoizedState,r.refs={},Ml(e);var i=t.contextType;"object"==typeof i&&null!==i?r.context=yl(i):(i=bo(t)?yo:go.current,r.context=xo(e,i)),r.state=e.memoizedState,"function"==typeof(i=t.getDerivedStateFromProps)&&(Vc(e,t,i,n),r.state=e.memoizedState),"function"==typeof t.getDerivedStateFromProps||"function"==typeof r.getSnapshotBeforeUpdate||"function"!=typeof r.UNSAFE_componentWillMount&&"function"!=typeof r.componentWillMount||(t=r.state,"function"==typeof r.componentWillMount&&r.componentWillMount(),"function"==typeof r.UNSAFE_componentWillMount&&r.UNSAFE_componentWillMount(),t!==r.state&&Wc.enqueueReplaceState(r,r.state,null),Pl(e,n,r,a),r.state=e.memoizedState),"function"==typeof r.componentDidMount&&(e.flags|=4194308)}function Yc(e,t){try{var n="",a=t;do{n+=Nn(a),a=a.return}while(a);var r=n}catch(i){r="\nError generating stack: "+i.message+"\n"+i.stack}return{value:e,source:t,stack:r,digest:null}}function Jc(e,t,n){return{value:e,source:null,stack:null!=n?n:null,digest:null!=t?t:null}}function Zc(e,t){try{console.error(t.value)}catch(n){setTimeout(function(){throw n})}}var Qc="function"==typeof WeakMap?WeakMap:Map;function ed(e,t,n){(n=El(-1,n)).tag=3,n.payload={element:null};var a=t.value;return n.callback=function(){ju||(ju=!0,Au=a),Zc(0,t)},n}function td(e,t,n){(n=El(-1,n)).tag=3;var a=e.type.getDerivedStateFromError;if("function"==typeof a){var r=t.value;n.payload=function(){return a(r)},n.callback=function(){Zc(0,t)}}var i=e.stateNode;return null!==i&&"function"==typeof i.componentDidCatch&&(n.callback=function(){Zc(0,t),"function"!=typeof a&&(null===Ru?Ru=new Set([this]):Ru.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),n}function nd(e,t,n){var a=e.pingCache;if(null===a){a=e.pingCache=new Qc;var r=new Set;a.set(t,r)}else void 0===(r=a.get(t))&&(r=new Set,a.set(t,r));r.has(n)||(r.add(n),e=hh.bind(null,e,t,n),t.then(e,e))}function ad(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function rd(e,t,n,a,r){return 1&e.mode?(e.flags|=65536,e.lanes=r,e):(e===t?e.flags|=65536:(e.flags|=128,n.flags|=131072,n.flags&=-52805,1===n.tag&&(null===n.alternate?n.tag=17:((t=El(-1,1)).tag=2,kl(n,t,1))),n.lanes|=1),e)}var id=ln.ReactCurrentOwner,sd=!1;function od(e,t,n,a){t.child=null===e?cl(t,null,n,a):ll(t,e.child,n,a)}function ld(e,t,n,a,r){n=n.render;var i=t.ref;return vl(t,r),a=ac(e,t,n,a,i,r),n=rc(),null===e||sd?(Go&&n&&Ho(t),t.flags|=1,od(e,t,a,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,jd(e,t,r))}function cd(e,t,n,a,r){if(null===e){var i=n.type;return"function"!=typeof i||xh(i)||void 0!==i.defaultProps||null!==n.compare||void 0!==n.defaultProps?((e=_h(n.type,null,a,t,t.mode,r)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=i,dd(e,t,i,a,r))}if(i=e.child,0===(e.lanes&r)){var s=i.memoizedProps;if((n=null!==(n=n.compare)?n:Ki)(s,a)&&e.ref===t.ref)return jd(e,t,r)}return t.flags|=1,(e=bh(i,a)).ref=t.ref,e.return=t,t.child=e}function dd(e,t,n,a,r){if(null!==e){var i=e.memoizedProps;if(Ki(i,a)&&e.ref===t.ref){if(sd=!1,t.pendingProps=a=i,0===(e.lanes&r))return t.lanes=e.lanes,jd(e,t,r);131072&e.flags&&(sd=!0)}}return pd(e,t,n,a,r)}function ud(e,t,n){var a=t.pendingProps,r=a.children,i=null!==e?e.memoizedState:null;if("hidden"===a.mode)if(1&t.mode){if(!(1073741824&n))return e=null!==i?i.baseLanes|n:n,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,mo(bu,xu),xu|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},a=null!==i?i.baseLanes:n,mo(bu,xu),xu|=a}else t.memoizedState={baseLanes:0,cachePool:null,transitions:null},mo(bu,xu),xu|=n;else null!==i?(a=i.baseLanes|n,t.memoizedState=null):a=n,mo(bu,xu),xu|=a;return od(e,t,r,n),t.child}function hd(e,t){var n=t.ref;(null===e&&null!==n||null!==e&&e.ref!==n)&&(t.flags|=512,t.flags|=2097152)}function pd(e,t,n,a,r){var i=bo(n)?yo:go.current;return i=xo(t,i),vl(t,r),n=ac(e,t,n,a,i,r),a=rc(),null===e||sd?(Go&&a&&Ho(t),t.flags|=1,od(e,t,n,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,jd(e,t,r))}function md(e,t,n,a,r){if(bo(n)){var i=!0;Mo(t)}else i=!1;if(vl(t,r),null===t.stateNode)Pd(e,t),Xc(t,n,a),Kc(t,n,a,r),a=!0;else if(null===e){var s=t.stateNode,o=t.memoizedProps;s.props=o;var l=s.context,c=n.contextType;"object"==typeof c&&null!==c?c=yl(c):c=xo(t,c=bo(n)?yo:go.current);var d=n.getDerivedStateFromProps,u="function"==typeof d||"function"==typeof s.getSnapshotBeforeUpdate;u||"function"!=typeof s.UNSAFE_componentWillReceiveProps&&"function"!=typeof s.componentWillReceiveProps||(o!==a||l!==c)&&qc(t,s,a,c),Sl=!1;var h=t.memoizedState;s.state=h,Pl(t,a,s,r),l=t.memoizedState,o!==a||h!==l||vo.current||Sl?("function"==typeof d&&(Vc(t,n,d,a),l=t.memoizedState),(o=Sl||Gc(t,n,o,a,h,l,c))?(u||"function"!=typeof s.UNSAFE_componentWillMount&&"function"!=typeof s.componentWillMount||("function"==typeof s.componentWillMount&&s.componentWillMount(),"function"==typeof s.UNSAFE_componentWillMount&&s.UNSAFE_componentWillMount()),"function"==typeof s.componentDidMount&&(t.flags|=4194308)):("function"==typeof s.componentDidMount&&(t.flags|=4194308),t.memoizedProps=a,t.memoizedState=l),s.props=a,s.state=l,s.context=c,a=o):("function"==typeof s.componentDidMount&&(t.flags|=4194308),a=!1)}else{s=t.stateNode,Cl(e,t),o=t.memoizedProps,c=t.type===t.elementType?o:$c(t.type,o),s.props=c,u=t.pendingProps,h=s.context,"object"==typeof(l=n.contextType)&&null!==l?l=yl(l):l=xo(t,l=bo(n)?yo:go.current);var p=n.getDerivedStateFromProps;(d="function"==typeof p||"function"==typeof s.getSnapshotBeforeUpdate)||"function"!=typeof s.UNSAFE_componentWillReceiveProps&&"function"!=typeof s.componentWillReceiveProps||(o!==u||h!==l)&&qc(t,s,a,l),Sl=!1,h=t.memoizedState,s.state=h,Pl(t,a,s,r);var m=t.memoizedState;o!==u||h!==m||vo.current||Sl?("function"==typeof p&&(Vc(t,n,p,a),m=t.memoizedState),(c=Sl||Gc(t,n,c,a,h,m,l)||!1)?(d||"function"!=typeof s.UNSAFE_componentWillUpdate&&"function"!=typeof s.componentWillUpdate||("function"==typeof s.componentWillUpdate&&s.componentWillUpdate(a,m,l),"function"==typeof s.UNSAFE_componentWillUpdate&&s.UNSAFE_componentWillUpdate(a,m,l)),"function"==typeof s.componentDidUpdate&&(t.flags|=4),"function"==typeof s.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!=typeof s.componentDidUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!=typeof s.getSnapshotBeforeUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),t.memoizedProps=a,t.memoizedState=m),s.props=a,s.state=m,s.context=l,a=c):("function"!=typeof s.componentDidUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!=typeof s.getSnapshotBeforeUpdate||o===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),a=!1)}return fd(e,t,n,a,i,r)}function fd(e,t,n,a,r,i){hd(e,t);var s=!!(128&t.flags);if(!a&&!s)return r&&Co(t,n,!1),jd(e,t,i);a=t.stateNode,id.current=t;var o=s&&"function"!=typeof n.getDerivedStateFromError?null:a.render();return t.flags|=1,null!==e&&s?(t.child=ll(t,e.child,null,i),t.child=ll(t,null,o,i)):od(e,t,o,i),t.memoizedState=a.state,r&&Co(t,n,!0),t.child}function gd(e){var t=e.stateNode;t.pendingContext?wo(0,t.pendingContext,t.pendingContext!==t.context):t.context&&wo(0,t.context,!1),Ul(e,t.containerInfo)}function vd(e,t,n,a,r){return tl(),nl(r),t.flags|=256,od(e,t,n,a),t.child}var yd,xd,bd,_d,wd={dehydrated:null,treeContext:null,retryLane:0};function Sd(e){return{baseLanes:e,cachePool:null,transitions:null}}function Md(e,t,n){var a,r=t.pendingProps,i=Bl.current,s=!1,o=!!(128&t.flags);if((a=o)||(a=(null===e||null!==e.memoizedState)&&!!(2&i)),a?(s=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(i|=1),mo(Bl,1&i),null===e)return Jo(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(1&t.mode?"$!"===e.data?t.lanes=8:t.lanes=1073741824:t.lanes=1,null):(o=r.children,e=r.fallback,s?(r=t.mode,s=t.child,o={mode:"hidden",children:o},1&r||null===s?s=Sh(o,r,0,null):(s.childLanes=0,s.pendingProps=o),e=wh(e,r,n,null),s.return=t,e.return=t,s.sibling=e,t.child=s,t.child.memoizedState=Sd(n),t.memoizedState=wd,e):Cd(t,o));if(null!==(i=e.memoizedState)&&null!==(a=i.dehydrated))return function(e,t,n,a,r,i,s){if(n)return 256&t.flags?(t.flags&=-257,Ed(e,t,s,a=Jc(Error(Gt(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(i=a.fallback,r=t.mode,a=Sh({mode:"visible",children:a.children},r,0,null),(i=wh(i,r,s,null)).flags|=2,a.return=t,i.return=t,a.sibling=i,t.child=a,1&t.mode&&ll(t,e.child,null,s),t.child.memoizedState=Sd(s),t.memoizedState=wd,i);if(!(1&t.mode))return Ed(e,t,s,null);if("$!"===r.data){if(a=r.nextSibling&&r.nextSibling.dataset)var o=a.dgst;return a=o,Ed(e,t,s,a=Jc(i=Error(Gt(419)),a,void 0))}if(o=0!==(s&e.childLanes),sd||o){if(null!==(a=gu)){switch(s&-s){case 4:r=2;break;case 16:r=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:r=32;break;case 536870912:r=268435456;break;default:r=0}0!==(r=0!==(r&(a.suspendedLanes|s))?0:r)&&r!==i.retryLane&&(i.retryLane=r,wl(e,r),$u(a,e,r,-1))}return nh(),Ed(e,t,s,a=Jc(Error(Gt(421))))}return"$?"===r.data?(t.flags|=128,t.child=e.child,t=mh.bind(null,e),r._reactRetry=t,null):(e=i.treeContext,Wo=Ys(r.nextSibling),Vo=t,Go=!0,Xo=null,null!==e&&(Lo[Do++]=Oo,Lo[Do++]=Fo,Lo[Do++]=Uo,Oo=e.id,Fo=e.overflow,Uo=t),t=Cd(t,a.children),t.flags|=4096,t)}(e,t,o,r,a,i,n);if(s){s=r.fallback,o=t.mode,a=(i=e.child).sibling;var l={mode:"hidden",children:r.children};return 1&o||t.child===i?(r=bh(i,l)).subtreeFlags=14680064&i.subtreeFlags:((r=t.child).childLanes=0,r.pendingProps=l,t.deletions=null),null!==a?s=bh(a,s):(s=wh(s,o,n,null)).flags|=2,s.return=t,r.return=t,r.sibling=s,t.child=r,r=s,s=t.child,o=null===(o=e.child.memoizedState)?Sd(n):{baseLanes:o.baseLanes|n,cachePool:null,transitions:o.transitions},s.memoizedState=o,s.childLanes=e.childLanes&~n,t.memoizedState=wd,r}return e=(s=e.child).sibling,r=bh(s,{mode:"visible",children:r.children}),!(1&t.mode)&&(r.lanes=n),r.return=t,r.sibling=null,null!==e&&(null===(n=t.deletions)?(t.deletions=[e],t.flags|=16):n.push(e)),t.child=r,t.memoizedState=null,r}function Cd(e,t){return(t=Sh({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function Ed(e,t,n,a){return null!==a&&nl(a),ll(t,e.child,null,n),(e=Cd(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function kd(e,t,n){e.lanes|=t;var a=e.alternate;null!==a&&(a.lanes|=t),gl(e.return,t,n)}function Td(e,t,n,a,r){var i=e.memoizedState;null===i?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:a,tail:n,tailMode:r}:(i.isBackwards=t,i.rendering=null,i.renderingStartTime=0,i.last=a,i.tail=n,i.tailMode=r)}function Nd(e,t,n){var a=t.pendingProps,r=a.revealOrder,i=a.tail;if(od(e,t,a.children,n),2&(a=Bl.current))a=1&a|2,t.flags|=128;else{if(null!==e&&128&e.flags)e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&kd(e,n,t);else if(19===e.tag)kd(e,n,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}a&=1}if(mo(Bl,a),1&t.mode)switch(r){case"forwards":for(n=t.child,r=null;null!==n;)null!==(e=n.alternate)&&null===Hl(e)&&(r=n),n=n.sibling;null===(n=r)?(r=t.child,t.child=null):(r=n.sibling,n.sibling=null),Td(t,!1,r,n,i);break;case"backwards":for(n=null,r=t.child,t.child=null;null!==r;){if(null!==(e=r.alternate)&&null===Hl(e)){t.child=r;break}e=r.sibling,r.sibling=n,n=r,r=e}Td(t,!0,n,null,i);break;case"together":Td(t,!1,null,null,void 0);break;default:t.memoizedState=null}else t.memoizedState=null;return t.child}function Pd(e,t){!(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function jd(e,t,n){if(null!==e&&(t.dependencies=e.dependencies),Su|=t.lanes,0===(n&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(Gt(153));if(null!==t.child){for(n=bh(e=t.child,e.pendingProps),t.child=n,n.return=t;null!==e.sibling;)e=e.sibling,(n=n.sibling=bh(e,e.pendingProps)).return=t;n.sibling=null}return t.child}function Ad(e,t){if(!Go)switch(e.tailMode){case"hidden":t=e.tail;for(var n=null;null!==t;)null!==t.alternate&&(n=t),t=t.sibling;null===n?e.tail=null:n.sibling=null;break;case"collapsed":n=e.tail;for(var a=null;null!==n;)null!==n.alternate&&(a=n),n=n.sibling;null===a?t||null===e.tail?e.tail=null:e.tail.sibling=null:a.sibling=null}}function Rd(e){var t=null!==e.alternate&&e.alternate.child===e.child,n=0,a=0;if(t)for(var r=e.child;null!==r;)n|=r.lanes|r.childLanes,a|=14680064&r.subtreeFlags,a|=14680064&r.flags,r.return=e,r=r.sibling;else for(r=e.child;null!==r;)n|=r.lanes|r.childLanes,a|=r.subtreeFlags,a|=r.flags,r.return=e,r=r.sibling;return e.subtreeFlags|=a,e.childLanes=n,t}function Id(e,t,n){var a=t.pendingProps;switch($o(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Rd(t),null;case 1:case 17:return bo(t.type)&&_o(),Rd(t),null;case 3:return a=t.stateNode,Ol(),po(vo),po(go),Vl(),a.pendingContext&&(a.context=a.pendingContext,a.pendingContext=null),null!==e&&null!==e.child||(Qo(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&!(256&t.flags)||(t.flags|=1024,null!==Xo&&(Xu(Xo),Xo=null))),xd(e,t),Rd(t),null;case 5:zl(t);var r=Dl(Ll.current);if(n=t.type,null!==e&&null!=t.stateNode)bd(e,t,n,a,r),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!a){if(null===t.stateNode)throw Error(Gt(166));return Rd(t),null}if(e=Dl(Rl.current),Qo(t)){a=t.stateNode,n=t.type;var i=t.memoizedProps;switch(a[Qs]=t,a[eo]=i,e=!!(1&t.mode),n){case"dialog":Es("cancel",a),Es("close",a);break;case"iframe":case"object":case"embed":Es("load",a);break;case"video":case"audio":for(r=0;r<ws.length;r++)Es(ws[r],a);break;case"source":Es("error",a);break;case"img":case"image":case"link":Es("error",a),Es("load",a);break;case"details":Es("toggle",a);break;case"input":On(a,i),Es("invalid",a);break;case"select":a._wrapperState={wasMultiple:!!i.multiple},Es("invalid",a);break;case"textarea":Gn(a,i),Es("invalid",a)}for(var s in sa(n,i),r=null,i)if(i.hasOwnProperty(s)){var o=i[s];"children"===s?"string"==typeof o?a.textContent!==o&&(!0!==i.suppressHydrationWarning&&Fs(a.textContent,o,e),r=["children",o]):"number"==typeof o&&a.textContent!==""+o&&(!0!==i.suppressHydrationWarning&&Fs(a.textContent,o,e),r=["children",""+o]):qt.hasOwnProperty(s)&&null!=o&&"onScroll"===s&&Es("scroll",a)}switch(n){case"input":In(a),Bn(a,i,!0);break;case"textarea":In(a),qn(a);break;case"select":case"option":break;default:"function"==typeof i.onClick&&(a.onclick=zs)}a=r,t.updateQueue=a,null!==a&&(t.flags|=4)}else{s=9===r.nodeType?r:r.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=Kn(n)),"http://www.w3.org/1999/xhtml"===e?"script"===n?((e=s.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"==typeof a.is?e=s.createElement(n,{is:a.is}):(e=s.createElement(n),"select"===n&&(s=e,a.multiple?s.multiple=!0:a.size&&(s.size=a.size))):e=s.createElementNS(e,n),e[Qs]=t,e[eo]=a,yd(e,t,!1,!1),t.stateNode=e;e:{switch(s=oa(n,a),n){case"dialog":Es("cancel",e),Es("close",e),r=a;break;case"iframe":case"object":case"embed":Es("load",e),r=a;break;case"video":case"audio":for(r=0;r<ws.length;r++)Es(ws[r],e);r=a;break;case"source":Es("error",e),r=a;break;case"img":case"image":case"link":Es("error",e),Es("load",e),r=a;break;case"details":Es("toggle",e),r=a;break;case"input":On(e,a),r=Un(e,a),Es("invalid",e);break;case"option":default:r=a;break;case"select":e._wrapperState={wasMultiple:!!a.multiple},r=Cn({},a,{value:void 0}),Es("invalid",e);break;case"textarea":Gn(e,a),r=Wn(e,a),Es("invalid",e)}for(i in sa(n,r),o=r)if(o.hasOwnProperty(i)){var l=o[i];"style"===i?ra(e,l):"dangerouslySetInnerHTML"===i?null!=(l=l?l.__html:void 0)&&Qn(e,l):"children"===i?"string"==typeof l?("textarea"!==n||""!==l)&&ea(e,l):"number"==typeof l&&ea(e,""+l):"suppressContentEditableWarning"!==i&&"suppressHydrationWarning"!==i&&"autoFocus"!==i&&(qt.hasOwnProperty(i)?null!=l&&"onScroll"===i&&Es("scroll",e):null!=l&&on(e,i,l,s))}switch(n){case"input":In(e),Bn(e,a,!1);break;case"textarea":In(e),qn(e);break;case"option":null!=a.value&&e.setAttribute("value",""+An(a.value));break;case"select":e.multiple=!!a.multiple,null!=(i=a.value)?Vn(e,!!a.multiple,i,!1):null!=a.defaultValue&&Vn(e,!!a.multiple,a.defaultValue,!0);break;default:"function"==typeof r.onClick&&(e.onclick=zs)}switch(n){case"button":case"input":case"select":case"textarea":a=!!a.autoFocus;break e;case"img":a=!0;break e;default:a=!1}}a&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return Rd(t),null;case 6:if(e&&null!=t.stateNode)_d(e,t,e.memoizedProps,a);else{if("string"!=typeof a&&null===t.stateNode)throw Error(Gt(166));if(n=Dl(Ll.current),Dl(Rl.current),Qo(t)){if(a=t.stateNode,n=t.memoizedProps,a[Qs]=t,(i=a.nodeValue!==n)&&null!==(e=Vo))switch(e.tag){case 3:Fs(a.nodeValue,n,!!(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Fs(a.nodeValue,n,!!(1&e.mode))}i&&(t.flags|=4)}else(a=(9===n.nodeType?n:n.ownerDocument).createTextNode(a))[Qs]=t,t.stateNode=a}return Rd(t),null;case 13:if(po(Bl),a=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(Go&&null!==Wo&&1&t.mode&&!(128&t.flags))el(),tl(),t.flags|=98560,i=!1;else if(i=Qo(t),null!==a&&null!==a.dehydrated){if(null===e){if(!i)throw Error(Gt(318));if(!(i=null!==(i=t.memoizedState)?i.dehydrated:null))throw Error(Gt(317));i[Qs]=t}else tl(),!(128&t.flags)&&(t.memoizedState=null),t.flags|=4;Rd(t),i=!1}else null!==Xo&&(Xu(Xo),Xo=null),i=!0;if(!i)return 65536&t.flags?t:null}return 128&t.flags?(t.lanes=n,t):((a=null!==a)!==(null!==e&&null!==e.memoizedState)&&a&&(t.child.flags|=8192,1&t.mode&&(null===e||1&Bl.current?0===_u&&(_u=3):nh())),null!==t.updateQueue&&(t.flags|=4),Rd(t),null);case 4:return Ol(),xd(e,t),null===e&&Ns(t.stateNode.containerInfo),Rd(t),null;case 10:return fl(t.type._context),Rd(t),null;case 19:if(po(Bl),null===(i=t.memoizedState))return Rd(t),null;if(a=!!(128&t.flags),null===(s=i.rendering))if(a)Ad(i,!1);else{if(0!==_u||null!==e&&128&e.flags)for(e=t.child;null!==e;){if(null!==(s=Hl(e))){for(t.flags|=128,Ad(i,!1),null!==(a=s.updateQueue)&&(t.updateQueue=a,t.flags|=4),t.subtreeFlags=0,a=n,n=t.child;null!==n;)e=a,(i=n).flags&=14680066,null===(s=i.alternate)?(i.childLanes=0,i.lanes=e,i.child=null,i.subtreeFlags=0,i.memoizedProps=null,i.memoizedState=null,i.updateQueue=null,i.dependencies=null,i.stateNode=null):(i.childLanes=s.childLanes,i.lanes=s.lanes,i.child=s.child,i.subtreeFlags=0,i.deletions=null,i.memoizedProps=s.memoizedProps,i.memoizedState=s.memoizedState,i.updateQueue=s.updateQueue,i.type=s.type,e=s.dependencies,i.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),n=n.sibling;return mo(Bl,1&Bl.current|2),t.child}e=e.sibling}null!==i.tail&&Fa()>Nu&&(t.flags|=128,a=!0,Ad(i,!1),t.lanes=4194304)}else{if(!a)if(null!==(e=Hl(s))){if(t.flags|=128,a=!0,null!==(n=e.updateQueue)&&(t.updateQueue=n,t.flags|=4),Ad(i,!0),null===i.tail&&"hidden"===i.tailMode&&!s.alternate&&!Go)return Rd(t),null}else 2*Fa()-i.renderingStartTime>Nu&&1073741824!==n&&(t.flags|=128,a=!0,Ad(i,!1),t.lanes=4194304);i.isBackwards?(s.sibling=t.child,t.child=s):(null!==(n=i.last)?n.sibling=s:t.child=s,i.last=s)}return null!==i.tail?(t=i.tail,i.rendering=t,i.tail=t.sibling,i.renderingStartTime=Fa(),t.sibling=null,n=Bl.current,mo(Bl,a?1&n|2:1&n),t):(Rd(t),null);case 22:case 23:return Zu(),a=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==a&&(t.flags|=8192),a&&1&t.mode?!!(1073741824&xu)&&(Rd(t),6&t.subtreeFlags&&(t.flags|=8192)):Rd(t),null;case 24:case 25:return null}throw Error(Gt(156,t.tag))}function Ld(e,t){switch($o(t),t.tag){case 1:return bo(t.type)&&_o(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return Ol(),po(vo),po(go),Vl(),65536&(e=t.flags)&&!(128&e)?(t.flags=-65537&e|128,t):null;case 5:return zl(t),null;case 13:if(po(Bl),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(Gt(340));tl()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return po(Bl),null;case 4:return Ol(),null;case 10:return fl(t.type._context),null;case 22:case 23:return Zu(),null;default:return null}}yd=function(e,t){for(var n=t.child;null!==n;){if(5===n.tag||6===n.tag)e.appendChild(n.stateNode);else if(4!==n.tag&&null!==n.child){n.child.return=n,n=n.child;continue}if(n===t)break;for(;null===n.sibling;){if(null===n.return||n.return===t)return;n=n.return}n.sibling.return=n.return,n=n.sibling}},xd=function(){},bd=function(e,t,n,a){var r=e.memoizedProps;if(r!==a){e=t.stateNode,Dl(Rl.current);var i,s=null;switch(n){case"input":r=Un(e,r),a=Un(e,a),s=[];break;case"select":r=Cn({},r,{value:void 0}),a=Cn({},a,{value:void 0}),s=[];break;case"textarea":r=Wn(e,r),a=Wn(e,a),s=[];break;default:"function"!=typeof r.onClick&&"function"==typeof a.onClick&&(e.onclick=zs)}for(c in sa(n,a),n=null,r)if(!a.hasOwnProperty(c)&&r.hasOwnProperty(c)&&null!=r[c])if("style"===c){var o=r[c];for(i in o)o.hasOwnProperty(i)&&(n||(n={}),n[i]="")}else"dangerouslySetInnerHTML"!==c&&"children"!==c&&"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&"autoFocus"!==c&&(qt.hasOwnProperty(c)?s||(s=[]):(s=s||[]).push(c,null));for(c in a){var l=a[c];if(o=null!=r?r[c]:void 0,a.hasOwnProperty(c)&&l!==o&&(null!=l||null!=o))if("style"===c)if(o){for(i in o)!o.hasOwnProperty(i)||l&&l.hasOwnProperty(i)||(n||(n={}),n[i]="");for(i in l)l.hasOwnProperty(i)&&o[i]!==l[i]&&(n||(n={}),n[i]=l[i])}else n||(s||(s=[]),s.push(c,n)),n=l;else"dangerouslySetInnerHTML"===c?(l=l?l.__html:void 0,o=o?o.__html:void 0,null!=l&&o!==l&&(s=s||[]).push(c,l)):"children"===c?"string"!=typeof l&&"number"!=typeof l||(s=s||[]).push(c,""+l):"suppressContentEditableWarning"!==c&&"suppressHydrationWarning"!==c&&(qt.hasOwnProperty(c)?(null!=l&&"onScroll"===c&&Es("scroll",e),s||o===l||(s=[])):(s=s||[]).push(c,l))}n&&(s=s||[]).push("style",n);var c=s;(t.updateQueue=c)&&(t.flags|=4)}},_d=function(e,t,n,a){n!==a&&(t.flags|=4)};var Dd=!1,Ud=!1,Od="function"==typeof WeakSet?WeakSet:Set,Fd=null;function zd(e,t){var n=e.ref;if(null!==n)if("function"==typeof n)try{n(null)}catch(a){uh(e,t,a)}else n.current=null}function Bd(e,t,n){try{n()}catch(a){uh(e,t,a)}}var Hd=!1;function $d(e,t,n){var a=t.updateQueue;if(null!==(a=null!==a?a.lastEffect:null)){var r=a=a.next;do{if((r.tag&e)===e){var i=r.destroy;r.destroy=void 0,void 0!==i&&Bd(t,n,i)}r=r.next}while(r!==a)}}function Vd(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var n=t=t.next;do{if((n.tag&e)===e){var a=n.create;n.destroy=a()}n=n.next}while(n!==t)}}function Wd(e){var t=e.ref;if(null!==t){var n=e.stateNode;e.tag,e=n,"function"==typeof t?t(e):t.current=e}}function Gd(e){var t=e.alternate;null!==t&&(e.alternate=null,Gd(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&(delete t[Qs],delete t[eo],delete t[no],delete t[ao],delete t[ro])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function Xd(e){return 5===e.tag||3===e.tag||4===e.tag}function qd(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||Xd(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function Kd(e,t,n){var a=e.tag;if(5===a||6===a)e=e.stateNode,t?8===n.nodeType?n.parentNode.insertBefore(e,t):n.insertBefore(e,t):(8===n.nodeType?(t=n.parentNode).insertBefore(e,n):(t=n).appendChild(e),null!=(n=n._reactRootContainer)||null!==t.onclick||(t.onclick=zs));else if(4!==a&&null!==(e=e.child))for(Kd(e,t,n),e=e.sibling;null!==e;)Kd(e,t,n),e=e.sibling}function Yd(e,t,n){var a=e.tag;if(5===a||6===a)e=e.stateNode,t?n.insertBefore(e,t):n.appendChild(e);else if(4!==a&&null!==(e=e.child))for(Yd(e,t,n),e=e.sibling;null!==e;)Yd(e,t,n),e=e.sibling}var Jd=null,Zd=!1;function Qd(e,t,n){for(n=n.child;null!==n;)eu(e,t,n),n=n.sibling}function eu(e,t,n){if(Xa&&"function"==typeof Xa.onCommitFiberUnmount)try{Xa.onCommitFiberUnmount(Ga,n)}catch(o){}switch(n.tag){case 5:Ud||zd(n,t);case 6:var a=Jd,r=Zd;Jd=null,Qd(e,t,n),Zd=r,null!==(Jd=a)&&(Zd?(e=Jd,n=n.stateNode,8===e.nodeType?e.parentNode.removeChild(n):e.removeChild(n)):Jd.removeChild(n.stateNode));break;case 18:null!==Jd&&(Zd?(e=Jd,n=n.stateNode,8===e.nodeType?Ks(e.parentNode,n):1===e.nodeType&&Ks(e,n),Pr(e)):Ks(Jd,n.stateNode));break;case 4:a=Jd,r=Zd,Jd=n.stateNode.containerInfo,Zd=!0,Qd(e,t,n),Jd=a,Zd=r;break;case 0:case 11:case 14:case 15:if(!Ud&&(null!==(a=n.updateQueue)&&null!==(a=a.lastEffect))){r=a=a.next;do{var i=r,s=i.destroy;i=i.tag,void 0!==s&&(2&i||4&i)&&Bd(n,t,s),r=r.next}while(r!==a)}Qd(e,t,n);break;case 1:if(!Ud&&(zd(n,t),"function"==typeof(a=n.stateNode).componentWillUnmount))try{a.props=n.memoizedProps,a.state=n.memoizedState,a.componentWillUnmount()}catch(o){uh(n,t,o)}Qd(e,t,n);break;case 21:Qd(e,t,n);break;case 22:1&n.mode?(Ud=(a=Ud)||null!==n.memoizedState,Qd(e,t,n),Ud=a):Qd(e,t,n);break;default:Qd(e,t,n)}}function tu(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var n=e.stateNode;null===n&&(n=e.stateNode=new Od),t.forEach(function(t){var a=fh.bind(null,e,t);n.has(t)||(n.add(t),t.then(a,a))})}}function nu(e,t){var n=t.deletions;if(null!==n)for(var a=0;a<n.length;a++){var r=n[a];try{var i=e,s=t,o=s;e:for(;null!==o;){switch(o.tag){case 5:Jd=o.stateNode,Zd=!1;break e;case 3:case 4:Jd=o.stateNode.containerInfo,Zd=!0;break e}o=o.return}if(null===Jd)throw Error(Gt(160));eu(i,s,r),Jd=null,Zd=!1;var l=r.alternate;null!==l&&(l.return=null),r.return=null}catch(c){uh(r,t,c)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)au(t,e),t=t.sibling}function au(e,t){var n=e.alternate,a=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(nu(t,e),ru(e),4&a){try{$d(3,e,e.return),Vd(3,e)}catch(f){uh(e,e.return,f)}try{$d(5,e,e.return)}catch(f){uh(e,e.return,f)}}break;case 1:nu(t,e),ru(e),512&a&&null!==n&&zd(n,n.return);break;case 5:if(nu(t,e),ru(e),512&a&&null!==n&&zd(n,n.return),32&e.flags){var r=e.stateNode;try{ea(r,"")}catch(f){uh(e,e.return,f)}}if(4&a&&null!=(r=e.stateNode)){var i=e.memoizedProps,s=null!==n?n.memoizedProps:i,o=e.type,l=e.updateQueue;if(e.updateQueue=null,null!==l)try{"input"===o&&"radio"===i.type&&null!=i.name&&Fn(r,i),oa(o,s);var c=oa(o,i);for(s=0;s<l.length;s+=2){var d=l[s],u=l[s+1];"style"===d?ra(r,u):"dangerouslySetInnerHTML"===d?Qn(r,u):"children"===d?ea(r,u):on(r,d,u,c)}switch(o){case"input":zn(r,i);break;case"textarea":Xn(r,i);break;case"select":var h=r._wrapperState.wasMultiple;r._wrapperState.wasMultiple=!!i.multiple;var p=i.value;null!=p?Vn(r,!!i.multiple,p,!1):h!==!!i.multiple&&(null!=i.defaultValue?Vn(r,!!i.multiple,i.defaultValue,!0):Vn(r,!!i.multiple,i.multiple?[]:"",!1))}r[eo]=i}catch(f){uh(e,e.return,f)}}break;case 6:if(nu(t,e),ru(e),4&a){if(null===e.stateNode)throw Error(Gt(162));r=e.stateNode,i=e.memoizedProps;try{r.nodeValue=i}catch(f){uh(e,e.return,f)}}break;case 3:if(nu(t,e),ru(e),4&a&&null!==n&&n.memoizedState.isDehydrated)try{Pr(t.containerInfo)}catch(f){uh(e,e.return,f)}break;case 4:default:nu(t,e),ru(e);break;case 13:nu(t,e),ru(e),8192&(r=e.child).flags&&(i=null!==r.memoizedState,r.stateNode.isHidden=i,!i||null!==r.alternate&&null!==r.alternate.memoizedState||(Tu=Fa())),4&a&&tu(e);break;case 22:if(d=null!==n&&null!==n.memoizedState,1&e.mode?(Ud=(c=Ud)||d,nu(t,e),Ud=c):nu(t,e),ru(e),8192&a){if(c=null!==e.memoizedState,(e.stateNode.isHidden=c)&&!d&&1&e.mode)for(Fd=e,d=e.child;null!==d;){for(u=Fd=d;null!==Fd;){switch(p=(h=Fd).child,h.tag){case 0:case 11:case 14:case 15:$d(4,h,h.return);break;case 1:zd(h,h.return);var m=h.stateNode;if("function"==typeof m.componentWillUnmount){a=h,n=h.return;try{t=a,m.props=t.memoizedProps,m.state=t.memoizedState,m.componentWillUnmount()}catch(f){uh(a,n,f)}}break;case 5:zd(h,h.return);break;case 22:if(null!==h.memoizedState){lu(u);continue}}null!==p?(p.return=h,Fd=p):lu(u)}d=d.sibling}e:for(d=null,u=e;;){if(5===u.tag){if(null===d){d=u;try{r=u.stateNode,c?"function"==typeof(i=r.style).setProperty?i.setProperty("display","none","important"):i.display="none":(o=u.stateNode,s=null!=(l=u.memoizedProps.style)&&l.hasOwnProperty("display")?l.display:null,o.style.display=aa("display",s))}catch(f){uh(e,e.return,f)}}}else if(6===u.tag){if(null===d)try{u.stateNode.nodeValue=c?"":u.memoizedProps}catch(f){uh(e,e.return,f)}}else if((22!==u.tag&&23!==u.tag||null===u.memoizedState||u===e)&&null!==u.child){u.child.return=u,u=u.child;continue}if(u===e)break e;for(;null===u.sibling;){if(null===u.return||u.return===e)break e;d===u&&(d=null),u=u.return}d===u&&(d=null),u.sibling.return=u.return,u=u.sibling}}break;case 19:nu(t,e),ru(e),4&a&&tu(e);case 21:}}function ru(e){var t=e.flags;if(2&t){try{e:{for(var n=e.return;null!==n;){if(Xd(n)){var a=n;break e}n=n.return}throw Error(Gt(160))}switch(a.tag){case 5:var r=a.stateNode;32&a.flags&&(ea(r,""),a.flags&=-33),Yd(e,qd(e),r);break;case 3:case 4:var i=a.stateNode.containerInfo;Kd(e,qd(e),i);break;default:throw Error(Gt(161))}}catch(s){uh(e,e.return,s)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function iu(e,t,n){Fd=e,su(e)}function su(e,t,n){for(var a=!!(1&e.mode);null!==Fd;){var r=Fd,i=r.child;if(22===r.tag&&a){var s=null!==r.memoizedState||Dd;if(!s){var o=r.alternate,l=null!==o&&null!==o.memoizedState||Ud;o=Dd;var c=Ud;if(Dd=s,(Ud=l)&&!c)for(Fd=r;null!==Fd;)l=(s=Fd).child,22===s.tag&&null!==s.memoizedState?cu(r):null!==l?(l.return=s,Fd=l):cu(r);for(;null!==i;)Fd=i,su(i),i=i.sibling;Fd=r,Dd=o,Ud=c}ou(e)}else 8772&r.subtreeFlags&&null!==i?(i.return=r,Fd=i):ou(e)}}function ou(e){for(;null!==Fd;){var t=Fd;if(8772&t.flags){var n=t.alternate;try{if(8772&t.flags)switch(t.tag){case 0:case 11:case 15:Ud||Vd(5,t);break;case 1:var a=t.stateNode;if(4&t.flags&&!Ud)if(null===n)a.componentDidMount();else{var r=t.elementType===t.type?n.memoizedProps:$c(t.type,n.memoizedProps);a.componentDidUpdate(r,n.memoizedState,a.__reactInternalSnapshotBeforeUpdate)}var i=t.updateQueue;null!==i&&jl(t,i,a);break;case 3:var s=t.updateQueue;if(null!==s){if(n=null,null!==t.child)switch(t.child.tag){case 5:case 1:n=t.child.stateNode}jl(t,s,n)}break;case 5:var o=t.stateNode;if(null===n&&4&t.flags){n=o;var l=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&n.focus();break;case"img":l.src&&(n.src=l.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var c=t.alternate;if(null!==c){var d=c.memoizedState;if(null!==d){var u=d.dehydrated;null!==u&&Pr(u)}}}break;default:throw Error(Gt(163))}Ud||512&t.flags&&Wd(t)}catch(h){uh(t,t.return,h)}}if(t===e){Fd=null;break}if(null!==(n=t.sibling)){n.return=t.return,Fd=n;break}Fd=t.return}}function lu(e){for(;null!==Fd;){var t=Fd;if(t===e){Fd=null;break}var n=t.sibling;if(null!==n){n.return=t.return,Fd=n;break}Fd=t.return}}function cu(e){for(;null!==Fd;){var t=Fd;try{switch(t.tag){case 0:case 11:case 15:var n=t.return;try{Vd(4,t)}catch(l){uh(t,n,l)}break;case 1:var a=t.stateNode;if("function"==typeof a.componentDidMount){var r=t.return;try{a.componentDidMount()}catch(l){uh(t,r,l)}}var i=t.return;try{Wd(t)}catch(l){uh(t,i,l)}break;case 5:var s=t.return;try{Wd(t)}catch(l){uh(t,s,l)}}}catch(l){uh(t,t.return,l)}if(t===e){Fd=null;break}var o=t.sibling;if(null!==o){o.return=t.return,Fd=o;break}Fd=t.return}}var du,uu=Math.ceil,hu=ln.ReactCurrentDispatcher,pu=ln.ReactCurrentOwner,mu=ln.ReactCurrentBatchConfig,fu=0,gu=null,vu=null,yu=0,xu=0,bu=ho(0),_u=0,wu=null,Su=0,Mu=0,Cu=0,Eu=null,ku=null,Tu=0,Nu=1/0,Pu=null,ju=!1,Au=null,Ru=null,Iu=!1,Lu=null,Du=0,Uu=0,Ou=null,Fu=-1,zu=0;function Bu(){return 6&fu?Fa():-1!==Fu?Fu:Fu=Fa()}function Hu(e){return 1&e.mode?2&fu&&0!==yu?yu&-yu:null!==al.transition?(0===zu&&(zu=ar()),zu):0!==(e=or)?e:e=void 0===(e=window.event)?16:Or(e.type):1}function $u(e,t,n,a){if(50<Uu)throw Uu=0,Ou=null,Error(Gt(185));ir(e,n,a),2&fu&&e===gu||(e===gu&&(!(2&fu)&&(Mu|=n),4===_u&&qu(e,yu)),Vu(e,a),1===n&&0===fu&&!(1&t.mode)&&(Nu=Fa()+500,ko&&Po()))}function Vu(e,t){var n=e.callbackNode;!function(e,t){for(var n=e.suspendedLanes,a=e.pingedLanes,r=e.expirationTimes,i=e.pendingLanes;0<i;){var s=31-qa(i),o=1<<s,l=r[s];-1===l?0!==(o&n)&&0===(o&a)||(r[s]=tr(o,t)):l<=t&&(e.expiredLanes|=o),i&=~o}}(e,t);var a=er(e,e===gu?yu:0);if(0===a)null!==n&&Da(n),e.callbackNode=null,e.callbackPriority=0;else if(t=a&-a,e.callbackPriority!==t){if(null!=n&&Da(n),1===t)0===e.tag?function(e){ko=!0,No(e)}(Ku.bind(null,e)):No(Ku.bind(null,e)),Xs(function(){!(6&fu)&&Po()}),n=null;else{switch(lr(a)){case 1:n=Ba;break;case 4:n=Ha;break;case 16:default:n=$a;break;case 536870912:n=Wa}n=gh(n,Wu.bind(null,e))}e.callbackPriority=t,e.callbackNode=n}}function Wu(e,t){if(Fu=-1,zu=0,6&fu)throw Error(Gt(327));var n=e.callbackNode;if(ch()&&e.callbackNode!==n)return null;var a=er(e,e===gu?yu:0);if(0===a)return null;if(30&a||0!==(a&e.expiredLanes)||t)t=ah(e,a);else{t=a;var r=fu;fu|=2;var i=th();for(gu===e&&yu===t||(Pu=null,Nu=Fa()+500,Qu(e,t));;)try{ih();break}catch(o){eh(e,o)}ml(),hu.current=i,fu=r,null!==vu?t=0:(gu=null,yu=0,t=_u)}if(0!==t){if(2===t&&(0!==(r=nr(e))&&(a=r,t=Gu(e,r))),1===t)throw n=wu,Qu(e,0),qu(e,a),Vu(e,Fa()),n;if(6===t)qu(e,a);else{if(r=e.current.alternate,!(30&a||function(e){for(var t=e;;){if(16384&t.flags){var n=t.updateQueue;if(null!==n&&null!==(n=n.stores))for(var a=0;a<n.length;a++){var r=n[a],i=r.getSnapshot;r=r.value;try{if(!qi(i(),r))return!1}catch(s){return!1}}}if(n=t.child,16384&t.subtreeFlags&&null!==n)n.return=t,t=n;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(r)||(t=ah(e,a),2===t&&(i=nr(e),0!==i&&(a=i,t=Gu(e,i))),1!==t)))throw n=wu,Qu(e,0),qu(e,a),Vu(e,Fa()),n;switch(e.finishedWork=r,e.finishedLanes=a,t){case 0:case 1:throw Error(Gt(345));case 2:case 5:lh(e,ku,Pu);break;case 3:if(qu(e,a),(130023424&a)===a&&10<(t=Tu+500-Fa())){if(0!==er(e,0))break;if(((r=e.suspendedLanes)&a)!==a){Bu(),e.pingedLanes|=e.suspendedLanes&r;break}e.timeoutHandle=Vs(lh.bind(null,e,ku,Pu),t);break}lh(e,ku,Pu);break;case 4:if(qu(e,a),(4194240&a)===a)break;for(t=e.eventTimes,r=-1;0<a;){var s=31-qa(a);i=1<<s,(s=t[s])>r&&(r=s),a&=~i}if(a=r,10<(a=(120>(a=Fa()-a)?120:480>a?480:1080>a?1080:1920>a?1920:3e3>a?3e3:4320>a?4320:1960*uu(a/1960))-a)){e.timeoutHandle=Vs(lh.bind(null,e,ku,Pu),a);break}lh(e,ku,Pu);break;default:throw Error(Gt(329))}}}return Vu(e,Fa()),e.callbackNode===n?Wu.bind(null,e):null}function Gu(e,t){var n=Eu;return e.current.memoizedState.isDehydrated&&(Qu(e,t).flags|=256),2!==(e=ah(e,t))&&(t=ku,ku=n,null!==t&&Xu(t)),e}function Xu(e){null===ku?ku=e:ku.push.apply(ku,e)}function qu(e,t){for(t&=~Cu,t&=~Mu,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var n=31-qa(t),a=1<<n;e[n]=-1,t&=~a}}function Ku(e){if(6&fu)throw Error(Gt(327));ch();var t=er(e,0);if(!(1&t))return Vu(e,Fa()),null;var n=ah(e,t);if(0!==e.tag&&2===n){var a=nr(e);0!==a&&(t=a,n=Gu(e,a))}if(1===n)throw n=wu,Qu(e,0),qu(e,t),Vu(e,Fa()),n;if(6===n)throw Error(Gt(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,lh(e,ku,Pu),Vu(e,Fa()),null}function Yu(e,t){var n=fu;fu|=1;try{return e(t)}finally{0===(fu=n)&&(Nu=Fa()+500,ko&&Po())}}function Ju(e){null!==Lu&&0===Lu.tag&&!(6&fu)&&ch();var t=fu;fu|=1;var n=mu.transition,a=or;try{if(mu.transition=null,or=1,e)return e()}finally{or=a,mu.transition=n,!(6&(fu=t))&&Po()}}function Zu(){xu=bu.current,po(bu)}function Qu(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(-1!==n&&(e.timeoutHandle=-1,Ws(n)),null!==vu)for(n=vu.return;null!==n;){var a=n;switch($o(a),a.tag){case 1:null!=(a=a.type.childContextTypes)&&_o();break;case 3:Ol(),po(vo),po(go),Vl();break;case 5:zl(a);break;case 4:Ol();break;case 13:case 19:po(Bl);break;case 10:fl(a.type._context);break;case 22:case 23:Zu()}n=n.return}if(gu=e,vu=e=bh(e.current,null),yu=xu=t,_u=0,wu=null,Cu=Mu=Su=0,ku=Eu=null,null!==xl){for(t=0;t<xl.length;t++)if(null!==(a=(n=xl[t]).interleaved)){n.interleaved=null;var r=a.next,i=n.pending;if(null!==i){var s=i.next;i.next=r,a.next=s}n.pending=a}xl=null}return e}function eh(e,t){for(;;){var n=vu;try{if(ml(),Wl.current=Fc,Jl){for(var a=ql.memoizedState;null!==a;){var r=a.queue;null!==r&&(r.pending=null),a=a.next}Jl=!1}if(Xl=0,Yl=Kl=ql=null,Zl=!1,Ql=0,pu.current=null,null===n||null===n.return){_u=1,wu=t,vu=null;break}e:{var i=e,s=n.return,o=n,l=t;if(t=yu,o.flags|=32768,null!==l&&"object"==typeof l&&"function"==typeof l.then){var c=l,d=o,u=d.tag;if(!(1&d.mode||0!==u&&11!==u&&15!==u)){var h=d.alternate;h?(d.updateQueue=h.updateQueue,d.memoizedState=h.memoizedState,d.lanes=h.lanes):(d.updateQueue=null,d.memoizedState=null)}var p=ad(s);if(null!==p){p.flags&=-257,rd(p,s,o,0,t),1&p.mode&&nd(i,c,t),l=c;var m=(t=p).updateQueue;if(null===m){var f=new Set;f.add(l),t.updateQueue=f}else m.add(l);break e}if(!(1&t)){nd(i,c,t),nh();break e}l=Error(Gt(426))}else if(Go&&1&o.mode){var g=ad(s);if(null!==g){!(65536&g.flags)&&(g.flags|=256),rd(g,s,o,0,t),nl(Yc(l,o));break e}}i=l=Yc(l,o),4!==_u&&(_u=2),null===Eu?Eu=[i]:Eu.push(i),i=s;do{switch(i.tag){case 3:i.flags|=65536,t&=-t,i.lanes|=t,Nl(i,ed(0,l,t));break e;case 1:o=l;var v=i.type,y=i.stateNode;if(!(128&i.flags||"function"!=typeof v.getDerivedStateFromError&&(null===y||"function"!=typeof y.componentDidCatch||null!==Ru&&Ru.has(y)))){i.flags|=65536,t&=-t,i.lanes|=t,Nl(i,td(i,o,t));break e}}i=i.return}while(null!==i)}oh(n)}catch(x){t=x,vu===n&&null!==n&&(vu=n=n.return);continue}break}}function th(){var e=hu.current;return hu.current=Fc,null===e?Fc:e}function nh(){0!==_u&&3!==_u&&2!==_u||(_u=4),null===gu||!(268435455&Su)&&!(268435455&Mu)||qu(gu,yu)}function ah(e,t){var n=fu;fu|=2;var a=th();for(gu===e&&yu===t||(Pu=null,Qu(e,t));;)try{rh();break}catch(r){eh(e,r)}if(ml(),fu=n,hu.current=a,null!==vu)throw Error(Gt(261));return gu=null,yu=0,_u}function rh(){for(;null!==vu;)sh(vu)}function ih(){for(;null!==vu&&!Ua();)sh(vu)}function sh(e){var t=du(e.alternate,e,xu);e.memoizedProps=e.pendingProps,null===t?oh(e):vu=t,pu.current=null}function oh(e){var t=e;do{var n=t.alternate;if(e=t.return,32768&t.flags){if(null!==(n=Ld(n,t)))return n.flags&=32767,void(vu=n);if(null===e)return _u=6,void(vu=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}else if(null!==(n=Id(n,t,xu)))return void(vu=n);if(null!==(t=t.sibling))return void(vu=t);vu=t=e}while(null!==t);0===_u&&(_u=5)}function lh(e,t,n){var a=or,r=mu.transition;try{mu.transition=null,or=1,function(e,t,n,a){do{ch()}while(null!==Lu);if(6&fu)throw Error(Gt(327));n=e.finishedWork;var r=e.finishedLanes;if(null===n)return null;if(e.finishedWork=null,e.finishedLanes=0,n===e.current)throw Error(Gt(177));e.callbackNode=null,e.callbackPriority=0;var i=n.lanes|n.childLanes;if(function(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var a=e.eventTimes;for(e=e.expirationTimes;0<n;){var r=31-qa(n),i=1<<r;t[r]=0,a[r]=-1,e[r]=-1,n&=~i}}(e,i),e===gu&&(vu=gu=null,yu=0),!(2064&n.subtreeFlags)&&!(2064&n.flags)||Iu||(Iu=!0,gh($a,function(){return ch(),null})),i=!!(15990&n.flags),!!(15990&n.subtreeFlags)||i){i=mu.transition,mu.transition=null;var s=or;or=1;var o=fu;fu|=4,pu.current=null,function(e,t){if(Bs=Ar,es(e=Qi())){if("selectionStart"in e)var n={start:e.selectionStart,end:e.selectionEnd};else e:{var a=(n=(n=e.ownerDocument)&&n.defaultView||window).getSelection&&n.getSelection();if(a&&0!==a.rangeCount){n=a.anchorNode;var r=a.anchorOffset,i=a.focusNode;a=a.focusOffset;try{n.nodeType,i.nodeType}catch(b){n=null;break e}var s=0,o=-1,l=-1,c=0,d=0,u=e,h=null;t:for(;;){for(var p;u!==n||0!==r&&3!==u.nodeType||(o=s+r),u!==i||0!==a&&3!==u.nodeType||(l=s+a),3===u.nodeType&&(s+=u.nodeValue.length),null!==(p=u.firstChild);)h=u,u=p;for(;;){if(u===e)break t;if(h===n&&++c===r&&(o=s),h===i&&++d===a&&(l=s),null!==(p=u.nextSibling))break;h=(u=h).parentNode}u=p}n=-1===o||-1===l?null:{start:o,end:l}}else n=null}n=n||{start:0,end:0}}else n=null;for(Hs={focusedElem:e,selectionRange:n},Ar=!1,Fd=t;null!==Fd;)if(e=(t=Fd).child,1028&t.subtreeFlags&&null!==e)e.return=t,Fd=e;else for(;null!==Fd;){t=Fd;try{var m=t.alternate;if(1024&t.flags)switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==m){var f=m.memoizedProps,g=m.memoizedState,v=t.stateNode,y=v.getSnapshotBeforeUpdate(t.elementType===t.type?f:$c(t.type,f),g);v.__reactInternalSnapshotBeforeUpdate=y}break;case 3:var x=t.stateNode.containerInfo;1===x.nodeType?x.textContent="":9===x.nodeType&&x.documentElement&&x.removeChild(x.documentElement);break;default:throw Error(Gt(163))}}catch(b){uh(t,t.return,b)}if(null!==(e=t.sibling)){e.return=t.return,Fd=e;break}Fd=t.return}m=Hd,Hd=!1}(e,n),au(n,e),ts(Hs),Ar=!!Bs,Hs=Bs=null,e.current=n,iu(n),Oa(),fu=o,or=s,mu.transition=i}else e.current=n;if(Iu&&(Iu=!1,Lu=e,Du=r),i=e.pendingLanes,0===i&&(Ru=null),function(e){if(Xa&&"function"==typeof Xa.onCommitFiberRoot)try{Xa.onCommitFiberRoot(Ga,e,void 0,!(128&~e.current.flags))}catch(t){}}(n.stateNode),Vu(e,Fa()),null!==t)for(a=e.onRecoverableError,n=0;n<t.length;n++)r=t[n],a(r.value,{componentStack:r.stack,digest:r.digest});if(ju)throw ju=!1,e=Au,Au=null,e;!!(1&Du)&&0!==e.tag&&ch(),i=e.pendingLanes,1&i?e===Ou?Uu++:(Uu=0,Ou=e):Uu=0,Po()}(e,t,n,a)}finally{mu.transition=r,or=a}return null}function ch(){if(null!==Lu){var e=lr(Du),t=mu.transition,n=or;try{if(mu.transition=null,or=16>e?16:e,null===Lu)var a=!1;else{if(e=Lu,Lu=null,Du=0,6&fu)throw Error(Gt(331));var r=fu;for(fu|=4,Fd=e.current;null!==Fd;){var i=Fd,s=i.child;if(16&Fd.flags){var o=i.deletions;if(null!==o){for(var l=0;l<o.length;l++){var c=o[l];for(Fd=c;null!==Fd;){var d=Fd;switch(d.tag){case 0:case 11:case 15:$d(8,d,i)}var u=d.child;if(null!==u)u.return=d,Fd=u;else for(;null!==Fd;){var h=(d=Fd).sibling,p=d.return;if(Gd(d),d===c){Fd=null;break}if(null!==h){h.return=p,Fd=h;break}Fd=p}}}var m=i.alternate;if(null!==m){var f=m.child;if(null!==f){m.child=null;do{var g=f.sibling;f.sibling=null,f=g}while(null!==f)}}Fd=i}}if(2064&i.subtreeFlags&&null!==s)s.return=i,Fd=s;else e:for(;null!==Fd;){if(2048&(i=Fd).flags)switch(i.tag){case 0:case 11:case 15:$d(9,i,i.return)}var v=i.sibling;if(null!==v){v.return=i.return,Fd=v;break e}Fd=i.return}}var y=e.current;for(Fd=y;null!==Fd;){var x=(s=Fd).child;if(2064&s.subtreeFlags&&null!==x)x.return=s,Fd=x;else e:for(s=y;null!==Fd;){if(2048&(o=Fd).flags)try{switch(o.tag){case 0:case 11:case 15:Vd(9,o)}}catch(_){uh(o,o.return,_)}if(o===s){Fd=null;break e}var b=o.sibling;if(null!==b){b.return=o.return,Fd=b;break e}Fd=o.return}}if(fu=r,Po(),Xa&&"function"==typeof Xa.onPostCommitFiberRoot)try{Xa.onPostCommitFiberRoot(Ga,e)}catch(_){}a=!0}return a}finally{or=n,mu.transition=t}}return!1}function dh(e,t,n){e=kl(e,t=ed(0,t=Yc(n,t),1),1),t=Bu(),null!==e&&(ir(e,1,t),Vu(e,t))}function uh(e,t,n){if(3===e.tag)dh(e,e,n);else for(;null!==t;){if(3===t.tag){dh(t,e,n);break}if(1===t.tag){var a=t.stateNode;if("function"==typeof t.type.getDerivedStateFromError||"function"==typeof a.componentDidCatch&&(null===Ru||!Ru.has(a))){t=kl(t,e=td(t,e=Yc(n,e),1),1),e=Bu(),null!==t&&(ir(t,1,e),Vu(t,e));break}}t=t.return}}function hh(e,t,n){var a=e.pingCache;null!==a&&a.delete(t),t=Bu(),e.pingedLanes|=e.suspendedLanes&n,gu===e&&(yu&n)===n&&(4===_u||3===_u&&(130023424&yu)===yu&&500>Fa()-Tu?Qu(e,0):Cu|=n),Vu(e,t)}function ph(e,t){0===t&&(1&e.mode?(t=Za,!(130023424&(Za<<=1))&&(Za=4194304)):t=1);var n=Bu();null!==(e=wl(e,t))&&(ir(e,t,n),Vu(e,n))}function mh(e){var t=e.memoizedState,n=0;null!==t&&(n=t.retryLane),ph(e,n)}function fh(e,t){var n=0;switch(e.tag){case 13:var a=e.stateNode,r=e.memoizedState;null!==r&&(n=r.retryLane);break;case 19:a=e.stateNode;break;default:throw Error(Gt(314))}null!==a&&a.delete(t),ph(e,n)}function gh(e,t){return La(e,t)}function vh(e,t,n,a){this.tag=e,this.key=n,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=a,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function yh(e,t,n,a){return new vh(e,t,n,a)}function xh(e){return!(!(e=e.prototype)||!e.isReactComponent)}function bh(e,t){var n=e.alternate;return null===n?((n=yh(e.tag,t,e.key,e.mode)).elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null),n.flags=14680064&e.flags,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue,t=e.dependencies,n.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n}function _h(e,t,n,a,r,i){var s=2;if(a=e,"function"==typeof e)xh(e)&&(s=1);else if("string"==typeof e)s=5;else e:switch(e){case un:return wh(n.children,r,i,t);case hn:s=8,r|=8;break;case pn:return(e=yh(12,n,t,2|r)).elementType=pn,e.lanes=i,e;case vn:return(e=yh(13,n,t,r)).elementType=vn,e.lanes=i,e;case yn:return(e=yh(19,n,t,r)).elementType=yn,e.lanes=i,e;case _n:return Sh(n,r,i,t);default:if("object"==typeof e&&null!==e)switch(e.$$typeof){case mn:s=10;break e;case fn:s=9;break e;case gn:s=11;break e;case xn:s=14;break e;case bn:s=16,a=null;break e}throw Error(Gt(130,null==e?e:typeof e,""))}return(t=yh(s,n,t,r)).elementType=e,t.type=a,t.lanes=i,t}function wh(e,t,n,a){return(e=yh(7,e,a,t)).lanes=n,e}function Sh(e,t,n,a){return(e=yh(22,e,a,t)).elementType=_n,e.lanes=n,e.stateNode={isHidden:!1},e}function Mh(e,t,n){return(e=yh(6,e,null,t)).lanes=n,e}function Ch(e,t,n){return(t=yh(4,null!==e.children?e.children:[],e.key,t)).lanes=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Eh(e,t,n,a,r){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=rr(0),this.expirationTimes=rr(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=rr(0),this.identifierPrefix=a,this.onRecoverableError=r,this.mutableSourceEagerHydrationData=null}function kh(e,t,n,a,r,i,s,o,l){return e=new Eh(e,t,n,o,l),1===t?(t=1,!0===i&&(t|=8)):t=0,i=yh(3,null,null,t),e.current=i,i.stateNode=e,i.memoizedState={element:a,isDehydrated:n,cache:null,transitions:null,pendingSuspenseBoundaries:null},Ml(i),e}function Th(e){if(!e)return fo;e:{if(Pa(e=e._reactInternals)!==e||1!==e.tag)throw Error(Gt(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(bo(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(Gt(171))}if(1===e.tag){var n=e.type;if(bo(n))return So(e,n,t)}return t}function Nh(e,t,n,a,r,i,s,o,l){return(e=kh(n,a,!0,e,0,i,0,o,l)).context=Th(null),n=e.current,(i=El(a=Bu(),r=Hu(n))).callback=null!=t?t:null,kl(n,i,r),e.current.lanes=r,ir(e,r,a),Vu(e,a),e}function Ph(e,t,n,a){var r=t.current,i=Bu(),s=Hu(r);return n=Th(n),null===t.context?t.context=n:t.pendingContext=n,(t=El(i,s)).payload={element:e},null!==(a=void 0===a?null:a)&&(t.callback=a),null!==(e=kl(r,t,s))&&($u(e,r,s,i),Tl(e,r,s)),s}function jh(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function Ah(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var n=e.retryLane;e.retryLane=0!==n&&n<t?n:t}}function Rh(e,t){Ah(e,t),(e=e.alternate)&&Ah(e,t)}du=function(e,t,n){if(null!==e)if(e.memoizedProps!==t.pendingProps||vo.current)sd=!0;else{if(0===(e.lanes&n)&&!(128&t.flags))return sd=!1,function(e,t,n){switch(t.tag){case 3:gd(t),tl();break;case 5:Fl(t);break;case 1:bo(t.type)&&Mo(t);break;case 4:Ul(t,t.stateNode.containerInfo);break;case 10:var a=t.type._context,r=t.memoizedProps.value;mo(dl,a._currentValue),a._currentValue=r;break;case 13:if(null!==(a=t.memoizedState))return null!==a.dehydrated?(mo(Bl,1&Bl.current),t.flags|=128,null):0!==(n&t.child.childLanes)?Md(e,t,n):(mo(Bl,1&Bl.current),null!==(e=jd(e,t,n))?e.sibling:null);mo(Bl,1&Bl.current);break;case 19:if(a=0!==(n&t.childLanes),128&e.flags){if(a)return Nd(e,t,n);t.flags|=128}if(null!==(r=t.memoizedState)&&(r.rendering=null,r.tail=null,r.lastEffect=null),mo(Bl,Bl.current),a)break;return null;case 22:case 23:return t.lanes=0,ud(e,t,n)}return jd(e,t,n)}(e,t,n);sd=!!(131072&e.flags)}else sd=!1,Go&&1048576&t.flags&&Bo(t,Io,t.index);switch(t.lanes=0,t.tag){case 2:var a=t.type;Pd(e,t),e=t.pendingProps;var r=xo(t,go.current);vl(t,n),r=ac(null,t,a,e,r,n);var i=rc();return t.flags|=1,"object"==typeof r&&null!==r&&"function"==typeof r.render&&void 0===r.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,bo(a)?(i=!0,Mo(t)):i=!1,t.memoizedState=null!==r.state&&void 0!==r.state?r.state:null,Ml(t),r.updater=Wc,t.stateNode=r,r._reactInternals=t,Kc(t,a,e,n),t=fd(null,t,a,!0,i,n)):(t.tag=0,Go&&i&&Ho(t),od(null,t,r,n),t=t.child),t;case 16:a=t.elementType;e:{switch(Pd(e,t),e=t.pendingProps,a=(r=a._init)(a._payload),t.type=a,r=t.tag=function(e){if("function"==typeof e)return xh(e)?1:0;if(null!=e){if((e=e.$$typeof)===gn)return 11;if(e===xn)return 14}return 2}(a),e=$c(a,e),r){case 0:t=pd(null,t,a,e,n);break e;case 1:t=md(null,t,a,e,n);break e;case 11:t=ld(null,t,a,e,n);break e;case 14:t=cd(null,t,a,$c(a.type,e),n);break e}throw Error(Gt(306,a,""))}return t;case 0:return a=t.type,r=t.pendingProps,pd(e,t,a,r=t.elementType===a?r:$c(a,r),n);case 1:return a=t.type,r=t.pendingProps,md(e,t,a,r=t.elementType===a?r:$c(a,r),n);case 3:e:{if(gd(t),null===e)throw Error(Gt(387));a=t.pendingProps,r=(i=t.memoizedState).element,Cl(e,t),Pl(t,a,null,n);var s=t.memoizedState;if(a=s.element,i.isDehydrated){if(i={element:a,isDehydrated:!1,cache:s.cache,pendingSuspenseBoundaries:s.pendingSuspenseBoundaries,transitions:s.transitions},t.updateQueue.baseState=i,t.memoizedState=i,256&t.flags){t=vd(e,t,a,n,r=Yc(Error(Gt(423)),t));break e}if(a!==r){t=vd(e,t,a,n,r=Yc(Error(Gt(424)),t));break e}for(Wo=Ys(t.stateNode.containerInfo.firstChild),Vo=t,Go=!0,Xo=null,n=cl(t,null,a,n),t.child=n;n;)n.flags=-3&n.flags|4096,n=n.sibling}else{if(tl(),a===r){t=jd(e,t,n);break e}od(e,t,a,n)}t=t.child}return t;case 5:return Fl(t),null===e&&Jo(t),a=t.type,r=t.pendingProps,i=null!==e?e.memoizedProps:null,s=r.children,$s(a,r)?s=null:null!==i&&$s(a,i)&&(t.flags|=32),hd(e,t),od(e,t,s,n),t.child;case 6:return null===e&&Jo(t),null;case 13:return Md(e,t,n);case 4:return Ul(t,t.stateNode.containerInfo),a=t.pendingProps,null===e?t.child=ll(t,null,a,n):od(e,t,a,n),t.child;case 11:return a=t.type,r=t.pendingProps,ld(e,t,a,r=t.elementType===a?r:$c(a,r),n);case 7:return od(e,t,t.pendingProps,n),t.child;case 8:case 12:return od(e,t,t.pendingProps.children,n),t.child;case 10:e:{if(a=t.type._context,r=t.pendingProps,i=t.memoizedProps,s=r.value,mo(dl,a._currentValue),a._currentValue=s,null!==i)if(qi(i.value,s)){if(i.children===r.children&&!vo.current){t=jd(e,t,n);break e}}else for(null!==(i=t.child)&&(i.return=t);null!==i;){var o=i.dependencies;if(null!==o){s=i.child;for(var l=o.firstContext;null!==l;){if(l.context===a){if(1===i.tag){(l=El(-1,n&-n)).tag=2;var c=i.updateQueue;if(null!==c){var d=(c=c.shared).pending;null===d?l.next=l:(l.next=d.next,d.next=l),c.pending=l}}i.lanes|=n,null!==(l=i.alternate)&&(l.lanes|=n),gl(i.return,n,t),o.lanes|=n;break}l=l.next}}else if(10===i.tag)s=i.type===t.type?null:i.child;else if(18===i.tag){if(null===(s=i.return))throw Error(Gt(341));s.lanes|=n,null!==(o=s.alternate)&&(o.lanes|=n),gl(s,n,t),s=i.sibling}else s=i.child;if(null!==s)s.return=i;else for(s=i;null!==s;){if(s===t){s=null;break}if(null!==(i=s.sibling)){i.return=s.return,s=i;break}s=s.return}i=s}od(e,t,r.children,n),t=t.child}return t;case 9:return r=t.type,a=t.pendingProps.children,vl(t,n),a=a(r=yl(r)),t.flags|=1,od(e,t,a,n),t.child;case 14:return r=$c(a=t.type,t.pendingProps),cd(e,t,a,r=$c(a.type,r),n);case 15:return dd(e,t,t.type,t.pendingProps,n);case 17:return a=t.type,r=t.pendingProps,r=t.elementType===a?r:$c(a,r),Pd(e,t),t.tag=1,bo(a)?(e=!0,Mo(t)):e=!1,vl(t,n),Xc(t,a,r),Kc(t,a,r,n),fd(null,t,a,!0,e,n);case 19:return Nd(e,t,n);case 22:return ud(e,t,n)}throw Error(Gt(156,t.tag))};var Ih="function"==typeof reportError?reportError:function(e){console.error(e)};function Lh(e){this._internalRoot=e}function Dh(e){this._internalRoot=e}function Uh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Oh(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function Fh(){}function zh(e,t,n,a,r){var i=n._reactRootContainer;if(i){var s=i;if("function"==typeof r){var o=r;r=function(){var e=jh(s);o.call(e)}}Ph(t,s,e,r)}else s=function(e,t,n,a,r){if(r){if("function"==typeof a){var i=a;a=function(){var e=jh(s);i.call(e)}}var s=Nh(t,a,e,0,null,!1,0,"",Fh);return e._reactRootContainer=s,e[to]=s.current,Ns(8===e.nodeType?e.parentNode:e),Ju(),s}for(;r=e.lastChild;)e.removeChild(r);if("function"==typeof a){var o=a;a=function(){var e=jh(l);o.call(e)}}var l=kh(e,0,!1,null,0,!1,0,"",Fh);return e._reactRootContainer=l,e[to]=l.current,Ns(8===e.nodeType?e.parentNode:e),Ju(function(){Ph(t,l,n,a)}),l}(n,t,e,r,a);return jh(s)}Dh.prototype.render=Lh.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(Gt(409));Ph(e,t,null,null)},Dh.prototype.unmount=Lh.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;Ju(function(){Ph(null,e,null,null)}),t[to]=null}},Dh.prototype.unstable_scheduleHydration=function(e){if(e){var t=hr();e={blockedOn:null,target:e,priority:t};for(var n=0;n<_r.length&&0!==t&&t<_r[n].priority;n++);_r.splice(n,0,e),0===n&&Cr(e)}},cr=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var n=Qa(t.pendingLanes);0!==n&&(sr(t,1|n),Vu(t,Fa()),!(6&fu)&&(Nu=Fa()+500,Po()))}break;case 13:Ju(function(){var t=wl(e,1);if(null!==t){var n=Bu();$u(t,e,1,n)}}),Rh(e,1)}},dr=function(e){if(13===e.tag){var t=wl(e,134217728);if(null!==t)$u(t,e,134217728,Bu());Rh(e,134217728)}},ur=function(e){if(13===e.tag){var t=Hu(e),n=wl(e,t);if(null!==n)$u(n,e,t,Bu());Rh(e,t)}},hr=function(){return or},pr=function(e,t){var n=or;try{return or=e,t()}finally{or=n}},da=function(e,t,n){switch(t){case"input":if(zn(e,n),t=n.name,"radio"===n.type&&null!=t){for(n=e;n.parentNode;)n=n.parentNode;for(n=n.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<n.length;t++){var a=n[t];if(a!==e&&a.form===e.form){var r=lo(a);if(!r)throw Error(Gt(90));Ln(a),zn(a,r)}}}break;case"textarea":Xn(e,n);break;case"select":null!=(t=n.value)&&Vn(e,!!n.multiple,t,!1)}},ga=Yu,va=Ju;var Bh={usingClientEntryPoint:!1,Events:[so,oo,lo,ma,fa,Yu]},Hh={findFiberByHostInstance:io,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},$h={bundleType:Hh.bundleType,version:Hh.version,rendererPackageName:Hh.rendererPackageName,rendererConfig:Hh.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:ln.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=Ra(e))?null:e.stateNode},findFiberByHostInstance:Hh.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var Vh=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Vh.isDisabled&&Vh.supportsFiber)try{Ga=Vh.inject($h),Xa=Vh}catch(Zn){}}zt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Bh,zt.createPortal=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Uh(t))throw Error(Gt(200));return function(e,t,n){var a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:dn,key:null==a?null:""+a,children:e,containerInfo:t,implementation:n}}(e,t,null,n)},zt.createRoot=function(e,t){if(!Uh(e))throw Error(Gt(299));var n=!1,a="",r=Ih;return null!=t&&(!0===t.unstable_strictMode&&(n=!0),void 0!==t.identifierPrefix&&(a=t.identifierPrefix),void 0!==t.onRecoverableError&&(r=t.onRecoverableError)),t=kh(e,1,!1,null,0,n,0,a,r),e[to]=t.current,Ns(8===e.nodeType?e.parentNode:e),new Lh(t)},zt.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"==typeof e.render)throw Error(Gt(188));throw e=Object.keys(e).join(","),Error(Gt(268,e))}return e=null===(e=Ra(t))?null:e.stateNode},zt.flushSync=function(e){return Ju(e)},zt.hydrate=function(e,t,n){if(!Oh(t))throw Error(Gt(200));return zh(null,e,t,!0,n)},zt.hydrateRoot=function(e,t,n){if(!Uh(e))throw Error(Gt(405));var a=null!=n&&n.hydratedSources||null,r=!1,i="",s=Ih;if(null!=n&&(!0===n.unstable_strictMode&&(r=!0),void 0!==n.identifierPrefix&&(i=n.identifierPrefix),void 0!==n.onRecoverableError&&(s=n.onRecoverableError)),t=Nh(t,null,e,1,null!=n?n:null,r,0,i,s),e[to]=t.current,Ns(e),a)for(e=0;e<a.length;e++)r=(r=(n=a[e])._getVersion)(n._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[n,r]:t.mutableSourceEagerHydrationData.push(n,r);return new Dh(t)},zt.render=function(e,t,n){if(!Oh(t))throw Error(Gt(200));return zh(null,e,t,!1,n)},zt.unmountComponentAtNode=function(e){if(!Oh(e))throw Error(Gt(40));return!!e._reactRootContainer&&(Ju(function(){zh(null,null,e,!1,function(){e._reactRootContainer=null,e[to]=null})}),!0)},zt.unstable_batchedUpdates=Yu,zt.unstable_renderSubtreeIntoContainer=function(e,t,n,a){if(!Oh(n))throw Error(Gt(200));if(null==e||void 0===e._reactInternals)throw Error(Gt(38));return zh(e,t,n,!1,a)},zt.version="18.3.1-next-f1338f8080-20240426",function e(){if("undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(t){console.error(t)}}(),Ft.exports=zt;var Wh=Ft.exports;const Gh=$e(Wh);var Xh=Wh;Ot.createRoot=Xh.createRoot,Ot.hydrateRoot=Xh.hydrateRoot;var qh=class{constructor(){this.listeners=new Set,this.subscribe=this.subscribe.bind(this)}subscribe(e){return this.listeners.add(e),this.onSubscribe(),()=>{this.listeners.delete(e),this.onUnsubscribe()}}hasListeners(){return this.listeners.size>0}onSubscribe(){}onUnsubscribe(){}},Kh={setTimeout:(e,t)=>setTimeout(e,t),clearTimeout:e=>clearTimeout(e),setInterval:(e,t)=>setInterval(e,t),clearInterval:e=>clearInterval(e)},Yh=new(n=class{constructor(){Oe(this,e,Kh),Oe(this,t,!1)}setTimeoutProvider(t){Fe(this,e,t)}setTimeout(t,n){return Ue(this,e).setTimeout(t,n)}clearTimeout(t){Ue(this,e).clearTimeout(t)}setInterval(t,n){return Ue(this,e).setInterval(t,n)}clearInterval(t){Ue(this,e).clearInterval(t)}},e=new WeakMap,t=new WeakMap,n);var Jh="undefined"==typeof window||"Deno"in globalThis;function Zh(){}function Qh(e){return"number"==typeof e&&e>=0&&e!==1/0}function ep(e,t){return Math.max(e+(t||0)-Date.now(),0)}function tp(e,t){return"function"==typeof e?e(t):e}function np(e,t){return"function"==typeof e?e(t):e}function ap(e,t){const{type:n="all",exact:a,fetchStatus:r,predicate:i,queryKey:s,stale:o}=e;if(s)if(a){if(t.queryHash!==ip(s,t.options))return!1}else if(!op(t.queryKey,s))return!1;if("all"!==n){const e=t.isActive();if("active"===n&&!e)return!1;if("inactive"===n&&e)return!1}return("boolean"!=typeof o||t.isStale()===o)&&((!r||r===t.state.fetchStatus)&&!(i&&!i(t)))}function rp(e,t){const{exact:n,status:a,predicate:r,mutationKey:i}=e;if(i){if(!t.options.mutationKey)return!1;if(n){if(sp(t.options.mutationKey)!==sp(i))return!1}else if(!op(t.options.mutationKey,i))return!1}return(!a||t.state.status===a)&&!(r&&!r(t))}function ip(e,t){return((null==t?void 0:t.queryKeyHashFn)||sp)(e)}function sp(e){return JSON.stringify(e,(e,t)=>hp(t)?Object.keys(t).sort().reduce((e,n)=>(e[n]=t[n],e),{}):t)}function op(e,t){return e===t||typeof e==typeof t&&(!(!e||!t||"object"!=typeof e||"object"!=typeof t)&&Object.keys(t).every(n=>op(e[n],t[n])))}var lp=Object.prototype.hasOwnProperty;function cp(e,t,n=0){if(e===t)return e;if(n>500)return t;const a=up(e)&&up(t);if(!(a||hp(e)&&hp(t)))return t;const r=(a?e:Object.keys(e)).length,i=a?t:Object.keys(t),s=i.length,o=a?new Array(s):{};let l=0;for(let c=0;c<s;c++){const s=a?c:i[c],d=e[s],u=t[s];if(d===u){o[s]=d,(a?c<r:lp.call(e,s))&&l++;continue}if(null===d||null===u||"object"!=typeof d||"object"!=typeof u){o[s]=u;continue}const h=cp(d,u,n+1);o[s]=h,h===d&&l++}return r===s&&l===r?e:o}function dp(e,t){if(!t||Object.keys(e).length!==Object.keys(t).length)return!1;for(const n in e)if(e[n]!==t[n])return!1;return!0}function up(e){return Array.isArray(e)&&e.length===Object.keys(e).length}function hp(e){if(!pp(e))return!1;const t=e.constructor;if(void 0===t)return!0;const n=t.prototype;return!!pp(n)&&(!!n.hasOwnProperty("isPrototypeOf")&&Object.getPrototypeOf(e)===Object.prototype)}function pp(e){return"[object Object]"===Object.prototype.toString.call(e)}function mp(e,t,n){return"function"==typeof n.structuralSharing?n.structuralSharing(e,t):!1!==n.structuralSharing?cp(e,t):t}function fp(e,t,n=0){const a=[...e,t];return n&&a.length>n?a.slice(1):a}function gp(e,t,n=0){const a=[t,...e];return n&&a.length>n?a.slice(0,-1):a}var vp=Symbol();function yp(e,t){return!e.queryFn&&(null==t?void 0:t.initialPromise)?()=>t.initialPromise:e.queryFn&&e.queryFn!==vp?e.queryFn:()=>Promise.reject(new Error(`Missing queryFn: '${e.queryHash}'`))}function xp(e,t){return"function"==typeof e?e(...t):!!e}var bp=new(s=class extends qh{constructor(){super(),Oe(this,a),Oe(this,r),Oe(this,i),Fe(this,i,e=>{if(!Jh&&window.addEventListener){const t=()=>e();return window.addEventListener("visibilitychange",t,!1),()=>{window.removeEventListener("visibilitychange",t)}}})}onSubscribe(){Ue(this,r)||this.setEventListener(Ue(this,i))}onUnsubscribe(){var e;this.hasListeners()||(null==(e=Ue(this,r))||e.call(this),Fe(this,r,void 0))}setEventListener(e){var t;Fe(this,i,e),null==(t=Ue(this,r))||t.call(this),Fe(this,r,e(e=>{"boolean"==typeof e?this.setFocused(e):this.onFocus()}))}setFocused(e){Ue(this,a)!==e&&(Fe(this,a,e),this.onFocus())}onFocus(){const e=this.isFocused();this.listeners.forEach(t=>{t(e)})}isFocused(){var e;return"boolean"==typeof Ue(this,a)?Ue(this,a):"hidden"!==(null==(e=globalThis.document)?void 0:e.visibilityState)}},a=new WeakMap,r=new WeakMap,i=new WeakMap,s);function _p(){let e,t;const n=new Promise((n,a)=>{e=n,t=a});function a(e){Object.assign(n,e),delete n.resolve,delete n.reject}return n.status="pending",n.catch(()=>{}),n.resolve=t=>{a({status:"fulfilled",value:t}),e(t)},n.reject=e=>{a({status:"rejected",reason:e}),t(e)},n}var wp=function(e){setTimeout(e,0)};var Sp=function(){let e=[],t=0,n=e=>{e()},a=e=>{e()},r=wp;const i=a=>{t?e.push(a):r(()=>{n(a)})};return{batch:i=>{let s;t++;try{s=i()}finally{t--,t||(()=>{const t=e;e=[],t.length&&r(()=>{a(()=>{t.forEach(e=>{n(e)})})})})()}return s},batchCalls:e=>(...t)=>{i(()=>{e(...t)})},schedule:i,setNotifyFunction:e=>{n=e},setBatchNotifyFunction:e=>{a=e},setScheduler:e=>{r=e}}}(),Mp=new(d=class extends qh{constructor(){super(),Oe(this,o,!0),Oe(this,l),Oe(this,c),Fe(this,c,e=>{if(!Jh&&window.addEventListener){const t=()=>e(!0),n=()=>e(!1);return window.addEventListener("online",t,!1),window.addEventListener("offline",n,!1),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",n)}}})}onSubscribe(){Ue(this,l)||this.setEventListener(Ue(this,c))}onUnsubscribe(){var e;this.hasListeners()||(null==(e=Ue(this,l))||e.call(this),Fe(this,l,void 0))}setEventListener(e){var t;Fe(this,c,e),null==(t=Ue(this,l))||t.call(this),Fe(this,l,e(this.setOnline.bind(this)))}setOnline(e){Ue(this,o)!==e&&(Fe(this,o,e),this.listeners.forEach(t=>{t(e)}))}isOnline(){return Ue(this,o)}},o=new WeakMap,l=new WeakMap,c=new WeakMap,d);function Cp(e){return Math.min(1e3*2**e,3e4)}function Ep(e){return"online"!==(e??"online")||Mp.isOnline()}var kp=class extends Error{constructor(e){super("CancelledError"),this.revert=null==e?void 0:e.revert,this.silent=null==e?void 0:e.silent}};function Tp(e){let t,n=!1,a=0;const r=_p(),i=()=>"pending"!==r.status,s=()=>bp.isFocused()&&("always"===e.networkMode||Mp.isOnline())&&e.canRun(),o=()=>Ep(e.networkMode)&&e.canRun(),l=e=>{i()||(null==t||t(),r.resolve(e))},c=e=>{i()||(null==t||t(),r.reject(e))},d=()=>new Promise(n=>{var a;t=e=>{(i()||s())&&n(e)},null==(a=e.onPause)||a.call(e)}).then(()=>{var n;t=void 0,i()||null==(n=e.onContinue)||n.call(e)}),u=()=>{if(i())return;let t;const r=0===a?e.initialPromise:void 0;try{t=r??e.fn()}catch(o){t=Promise.reject(o)}Promise.resolve(t).then(l).catch(t=>{var r;if(i())return;const o=e.retry??(Jh?0:3),l=e.retryDelay??Cp,h="function"==typeof l?l(a,t):l,p=!0===o||"number"==typeof o&&a<o||"function"==typeof o&&o(a,t);var m;!n&&p?(a++,null==(r=e.onFail)||r.call(e,a,t),(m=h,new Promise(e=>{Yh.setTimeout(e,m)})).then(()=>s()?void 0:d()).then(()=>{n?c(t):u()})):c(t)})};return{promise:r,status:()=>r.status,cancel:t=>{var n;if(!i()){const a=new kp(t);c(a),null==(n=e.onCancel)||n.call(e,a)}},continue:()=>(null==t||t(),r),cancelRetry:()=>{n=!0},continueRetry:()=>{n=!1},canStart:o,start:()=>(o()?u():d().then(u),r)}}var Np=(h=class{constructor(){Oe(this,u)}destroy(){this.clearGcTimeout()}scheduleGc(){this.clearGcTimeout(),Qh(this.gcTime)&&Fe(this,u,Yh.setTimeout(()=>{this.optionalRemove()},this.gcTime))}updateGcTime(e){this.gcTime=Math.max(this.gcTime||0,e??(Jh?1/0:3e5))}clearGcTimeout(){Ue(this,u)&&(Yh.clearTimeout(Ue(this,u)),Fe(this,u,void 0))}},u=new WeakMap,h),Pp=(w=class extends Np{constructor(e){super(),Oe(this,b),Oe(this,p),Oe(this,m),Oe(this,f),Oe(this,g),Oe(this,v),Oe(this,y),Oe(this,x),Fe(this,x,!1),Fe(this,y,e.defaultOptions),this.setOptions(e.options),this.observers=[],Fe(this,g,e.client),Fe(this,f,Ue(this,g).getQueryCache()),this.queryKey=e.queryKey,this.queryHash=e.queryHash,Fe(this,p,Rp(this.options)),this.state=e.state??Ue(this,p),this.scheduleGc()}get meta(){return this.options.meta}get promise(){var e;return null==(e=Ue(this,v))?void 0:e.promise}setOptions(e){if(this.options={...Ue(this,y),...e},this.updateGcTime(this.options.gcTime),this.state&&void 0===this.state.data){const e=Rp(this.options);void 0!==e.data&&(this.setState(Ap(e.data,e.dataUpdatedAt)),Fe(this,p,e))}}optionalRemove(){this.observers.length||"idle"!==this.state.fetchStatus||Ue(this,f).remove(this)}setData(e,t){const n=mp(this.state.data,e,this.options);return ze(this,b,_).call(this,{data:n,type:"success",dataUpdatedAt:null==t?void 0:t.updatedAt,manual:null==t?void 0:t.manual}),n}setState(e,t){ze(this,b,_).call(this,{type:"setState",state:e,setStateOptions:t})}cancel(e){var t,n;const a=null==(t=Ue(this,v))?void 0:t.promise;return null==(n=Ue(this,v))||n.cancel(e),a?a.then(Zh).catch(Zh):Promise.resolve()}destroy(){super.destroy(),this.cancel({silent:!0})}reset(){this.destroy(),this.setState(Ue(this,p))}isActive(){return this.observers.some(e=>!1!==np(e.options.enabled,this))}isDisabled(){return this.getObserversCount()>0?!this.isActive():this.options.queryFn===vp||this.state.dataUpdateCount+this.state.errorUpdateCount===0}isStatic(){return this.getObserversCount()>0&&this.observers.some(e=>"static"===tp(e.options.staleTime,this))}isStale(){return this.getObserversCount()>0?this.observers.some(e=>e.getCurrentResult().isStale):void 0===this.state.data||this.state.isInvalidated}isStaleByTime(e=0){return void 0===this.state.data||"static"!==e&&(!!this.state.isInvalidated||!ep(this.state.dataUpdatedAt,e))}onFocus(){var e;const t=this.observers.find(e=>e.shouldFetchOnWindowFocus());null==t||t.refetch({cancelRefetch:!1}),null==(e=Ue(this,v))||e.continue()}onOnline(){var e;const t=this.observers.find(e=>e.shouldFetchOnReconnect());null==t||t.refetch({cancelRefetch:!1}),null==(e=Ue(this,v))||e.continue()}addObserver(e){this.observers.includes(e)||(this.observers.push(e),this.clearGcTimeout(),Ue(this,f).notify({type:"observerAdded",query:this,observer:e}))}removeObserver(e){this.observers.includes(e)&&(this.observers=this.observers.filter(t=>t!==e),this.observers.length||(Ue(this,v)&&(Ue(this,x)?Ue(this,v).cancel({revert:!0}):Ue(this,v).cancelRetry()),this.scheduleGc()),Ue(this,f).notify({type:"observerRemoved",query:this,observer:e}))}getObserversCount(){return this.observers.length}invalidate(){this.state.isInvalidated||ze(this,b,_).call(this,{type:"invalidate"})}async fetch(e,t){var n,a,r,i,s,o,l,c,d,u,h,p;if("idle"!==this.state.fetchStatus&&"rejected"!==(null==(n=Ue(this,v))?void 0:n.status()))if(void 0!==this.state.data&&(null==t?void 0:t.cancelRefetch))this.cancel({silent:!0});else if(Ue(this,v))return Ue(this,v).continueRetry(),Ue(this,v).promise;if(e&&this.setOptions(e),!this.options.queryFn){const e=this.observers.find(e=>e.options.queryFn);e&&this.setOptions(e.options)}const y=new AbortController,w=e=>{Object.defineProperty(e,"signal",{enumerable:!0,get:()=>(Fe(this,x,!0),y.signal)})},S=()=>{const e=yp(this.options,t),n=(()=>{const e={client:Ue(this,g),queryKey:this.queryKey,meta:this.meta};return w(e),e})();return Fe(this,x,!1),this.options.persister?this.options.persister(e,n,this):e(n)},M=(()=>{const e={fetchOptions:t,options:this.options,queryKey:this.queryKey,client:Ue(this,g),state:this.state,fetchFn:S};return w(e),e})();null==(a=this.options.behavior)||a.onFetch(M,this),Fe(this,m,this.state),"idle"!==this.state.fetchStatus&&this.state.fetchMeta===(null==(r=M.fetchOptions)?void 0:r.meta)||ze(this,b,_).call(this,{type:"fetch",meta:null==(i=M.fetchOptions)?void 0:i.meta}),Fe(this,v,Tp({initialPromise:null==t?void 0:t.initialPromise,fn:M.fetchFn,onCancel:e=>{e instanceof kp&&e.revert&&this.setState({...Ue(this,m),fetchStatus:"idle"}),y.abort()},onFail:(e,t)=>{ze(this,b,_).call(this,{type:"failed",failureCount:e,error:t})},onPause:()=>{ze(this,b,_).call(this,{type:"pause"})},onContinue:()=>{ze(this,b,_).call(this,{type:"continue"})},retry:M.options.retry,retryDelay:M.options.retryDelay,networkMode:M.options.networkMode,canRun:()=>!0}));try{const e=await Ue(this,v).start();if(void 0===e)throw new Error(`${this.queryHash} data is undefined`);return this.setData(e),null==(o=(s=Ue(this,f).config).onSuccess)||o.call(s,e,this),null==(c=(l=Ue(this,f).config).onSettled)||c.call(l,e,this.state.error,this),e}catch(C){if(C instanceof kp){if(C.silent)return Ue(this,v).promise;if(C.revert){if(void 0===this.state.data)throw C;return this.state.data}}throw ze(this,b,_).call(this,{type:"error",error:C}),null==(u=(d=Ue(this,f).config).onError)||u.call(d,C,this),null==(p=(h=Ue(this,f).config).onSettled)||p.call(h,this.state.data,C,this),C}finally{this.scheduleGc()}}},p=new WeakMap,m=new WeakMap,f=new WeakMap,g=new WeakMap,v=new WeakMap,y=new WeakMap,x=new WeakMap,b=new WeakSet,_=function(e){this.state=(t=>{switch(e.type){case"failed":return{...t,fetchFailureCount:e.failureCount,fetchFailureReason:e.error};case"pause":return{...t,fetchStatus:"paused"};case"continue":return{...t,fetchStatus:"fetching"};case"fetch":return{...t,...jp(t.data,this.options),fetchMeta:e.meta??null};case"success":const n={...t,...Ap(e.data,e.dataUpdatedAt),dataUpdateCount:t.dataUpdateCount+1,...!e.manual&&{fetchStatus:"idle",fetchFailureCount:0,fetchFailureReason:null}};return Fe(this,m,e.manual?n:void 0),n;case"error":const a=e.error;return{...t,error:a,errorUpdateCount:t.errorUpdateCount+1,errorUpdatedAt:Date.now(),fetchFailureCount:t.fetchFailureCount+1,fetchFailureReason:a,fetchStatus:"idle",status:"error",isInvalidated:!0};case"invalidate":return{...t,isInvalidated:!0};case"setState":return{...t,...e.state}}})(this.state),Sp.batch(()=>{this.observers.forEach(e=>{e.onQueryUpdate()}),Ue(this,f).notify({query:this,type:"updated",action:e})})},w);function jp(e,t){return{fetchFailureCount:0,fetchFailureReason:null,fetchStatus:Ep(t.networkMode)?"fetching":"paused",...void 0===e&&{error:null,status:"pending"}}}function Ap(e,t){return{data:e,dataUpdatedAt:t??Date.now(),error:null,isInvalidated:!1,status:"success"}}function Rp(e){const t="function"==typeof e.initialData?e.initialData():e.initialData,n=void 0!==t,a=n?"function"==typeof e.initialDataUpdatedAt?e.initialDataUpdatedAt():e.initialDataUpdatedAt:0;return{data:t,dataUpdateCount:0,dataUpdatedAt:n?a??Date.now():0,error:null,errorUpdateCount:0,errorUpdatedAt:0,fetchFailureCount:0,fetchFailureReason:null,fetchMeta:null,isInvalidated:!1,status:n?"success":"pending",fetchStatus:"idle"}}var Ip=(q=class extends qh{constructor(e,t){super(),Oe(this,O),Oe(this,S),Oe(this,M),Oe(this,C),Oe(this,E),Oe(this,k),Oe(this,T),Oe(this,N),Oe(this,P),Oe(this,j),Oe(this,A),Oe(this,R),Oe(this,I),Oe(this,L),Oe(this,D),Oe(this,U,new Set),this.options=t,Fe(this,S,e),Fe(this,P,null),Fe(this,N,_p()),this.bindMethods(),this.setOptions(t)}bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){1===this.listeners.size&&(Ue(this,M).addObserver(this),Lp(Ue(this,M),this.options)?ze(this,O,F).call(this):this.updateResult(),ze(this,O,$).call(this))}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return Dp(Ue(this,M),this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return Dp(Ue(this,M),this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,ze(this,O,V).call(this),ze(this,O,W).call(this),Ue(this,M).removeObserver(this)}setOptions(e){const t=this.options,n=Ue(this,M);if(this.options=Ue(this,S).defaultQueryOptions(e),void 0!==this.options.enabled&&"boolean"!=typeof this.options.enabled&&"function"!=typeof this.options.enabled&&"boolean"!=typeof np(this.options.enabled,Ue(this,M)))throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");ze(this,O,G).call(this),Ue(this,M).setOptions(this.options),t._defaulted&&!dp(this.options,t)&&Ue(this,S).getQueryCache().notify({type:"observerOptionsUpdated",query:Ue(this,M),observer:this});const a=this.hasListeners();a&&Up(Ue(this,M),n,this.options,t)&&ze(this,O,F).call(this),this.updateResult(),!a||Ue(this,M)===n&&np(this.options.enabled,Ue(this,M))===np(t.enabled,Ue(this,M))&&tp(this.options.staleTime,Ue(this,M))===tp(t.staleTime,Ue(this,M))||ze(this,O,z).call(this);const r=ze(this,O,B).call(this);!a||Ue(this,M)===n&&np(this.options.enabled,Ue(this,M))===np(t.enabled,Ue(this,M))&&r===Ue(this,D)||ze(this,O,H).call(this,r)}getOptimisticResult(e){const t=Ue(this,S).getQueryCache().build(Ue(this,S),e),n=this.createResult(t,e);return function(e,t){if(!dp(e.getCurrentResult(),t))return!0;return!1}(this,n)&&(Fe(this,E,n),Fe(this,T,this.options),Fe(this,k,Ue(this,M).state)),n}getCurrentResult(){return Ue(this,E)}trackResult(e,t){return new Proxy(e,{get:(e,n)=>(this.trackProp(n),null==t||t(n),"promise"===n&&(this.trackProp("data"),this.options.experimental_prefetchInRender||"pending"!==Ue(this,N).status||Ue(this,N).reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(e,n))})}trackProp(e){Ue(this,U).add(e)}getCurrentQuery(){return Ue(this,M)}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const t=Ue(this,S).defaultQueryOptions(e),n=Ue(this,S).getQueryCache().build(Ue(this,S),t);return n.fetch().then(()=>this.createResult(n,t))}fetch(e){return ze(this,O,F).call(this,{...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),Ue(this,E)))}createResult(e,t){var n;const a=Ue(this,M),r=this.options,i=Ue(this,E),s=Ue(this,k),o=Ue(this,T),l=e!==a?e.state:Ue(this,C),{state:c}=e;let d,u={...c},h=!1;if(t._optimisticResults){const n=this.hasListeners(),i=!n&&Lp(e,t),s=n&&Up(e,a,t,r);(i||s)&&(u={...u,...jp(c.data,e.options)}),"isRestoring"===t._optimisticResults&&(u.fetchStatus="idle")}let{error:p,errorUpdatedAt:m,status:f}=u;d=u.data;let g=!1;if(void 0!==t.placeholderData&&void 0===d&&"pending"===f){let e;(null==i?void 0:i.isPlaceholderData)&&t.placeholderData===(null==o?void 0:o.placeholderData)?(e=i.data,g=!0):e="function"==typeof t.placeholderData?t.placeholderData(null==(n=Ue(this,R))?void 0:n.state.data,Ue(this,R)):t.placeholderData,void 0!==e&&(f="success",d=mp(null==i?void 0:i.data,e,t),h=!0)}if(t.select&&void 0!==d&&!g)if(i&&d===(null==s?void 0:s.data)&&t.select===Ue(this,j))d=Ue(this,A);else try{Fe(this,j,t.select),d=t.select(d),d=mp(null==i?void 0:i.data,d,t),Fe(this,A,d),Fe(this,P,null)}catch(S){Fe(this,P,S)}Ue(this,P)&&(p=Ue(this,P),d=Ue(this,A),m=Date.now(),f="error");const v="fetching"===u.fetchStatus,y="pending"===f,x="error"===f,b=y&&v,_=void 0!==d,w={status:f,fetchStatus:u.fetchStatus,isPending:y,isSuccess:"success"===f,isError:x,isInitialLoading:b,isLoading:b,data:d,dataUpdatedAt:u.dataUpdatedAt,error:p,errorUpdatedAt:m,failureCount:u.fetchFailureCount,failureReason:u.fetchFailureReason,errorUpdateCount:u.errorUpdateCount,isFetched:u.dataUpdateCount>0||u.errorUpdateCount>0,isFetchedAfterMount:u.dataUpdateCount>l.dataUpdateCount||u.errorUpdateCount>l.errorUpdateCount,isFetching:v,isRefetching:v&&!y,isLoadingError:x&&!_,isPaused:"paused"===u.fetchStatus,isPlaceholderData:h,isRefetchError:x&&_,isStale:Op(e,t),refetch:this.refetch,promise:Ue(this,N),isEnabled:!1!==np(t.enabled,e)};if(this.options.experimental_prefetchInRender){const t=void 0!==w.data,n="error"===w.status&&!t,r=e=>{n?e.reject(w.error):t&&e.resolve(w.data)},i=()=>{const e=Fe(this,N,w.promise=_p());r(e)},s=Ue(this,N);switch(s.status){case"pending":e.queryHash===a.queryHash&&r(s);break;case"fulfilled":(n||w.data!==s.value)&&i();break;case"rejected":n&&w.error===s.reason||i()}}return w}updateResult(){const e=Ue(this,E),t=this.createResult(Ue(this,M),this.options);if(Fe(this,k,Ue(this,M).state),Fe(this,T,this.options),void 0!==Ue(this,k).data&&Fe(this,R,Ue(this,M)),dp(t,e))return;Fe(this,E,t);ze(this,O,X).call(this,{listeners:(()=>{if(!e)return!0;const{notifyOnChangeProps:t}=this.options,n="function"==typeof t?t():t;if("all"===n||!n&&!Ue(this,U).size)return!0;const a=new Set(n??Ue(this,U));return this.options.throwOnError&&a.add("error"),Object.keys(Ue(this,E)).some(t=>{const n=t;return Ue(this,E)[n]!==e[n]&&a.has(n)})})()})}onQueryUpdate(){this.updateResult(),this.hasListeners()&&ze(this,O,$).call(this)}},S=new WeakMap,M=new WeakMap,C=new WeakMap,E=new WeakMap,k=new WeakMap,T=new WeakMap,N=new WeakMap,P=new WeakMap,j=new WeakMap,A=new WeakMap,R=new WeakMap,I=new WeakMap,L=new WeakMap,D=new WeakMap,U=new WeakMap,O=new WeakSet,F=function(e){ze(this,O,G).call(this);let t=Ue(this,M).fetch(this.options,e);return(null==e?void 0:e.throwOnError)||(t=t.catch(Zh)),t},z=function(){ze(this,O,V).call(this);const e=tp(this.options.staleTime,Ue(this,M));if(Jh||Ue(this,E).isStale||!Qh(e))return;const t=ep(Ue(this,E).dataUpdatedAt,e)+1;Fe(this,I,Yh.setTimeout(()=>{Ue(this,E).isStale||this.updateResult()},t))},B=function(){return("function"==typeof this.options.refetchInterval?this.options.refetchInterval(Ue(this,M)):this.options.refetchInterval)??!1},H=function(e){ze(this,O,W).call(this),Fe(this,D,e),!Jh&&!1!==np(this.options.enabled,Ue(this,M))&&Qh(Ue(this,D))&&0!==Ue(this,D)&&Fe(this,L,Yh.setInterval(()=>{(this.options.refetchIntervalInBackground||bp.isFocused())&&ze(this,O,F).call(this)},Ue(this,D)))},$=function(){ze(this,O,z).call(this),ze(this,O,H).call(this,ze(this,O,B).call(this))},V=function(){Ue(this,I)&&(Yh.clearTimeout(Ue(this,I)),Fe(this,I,void 0))},W=function(){Ue(this,L)&&(Yh.clearInterval(Ue(this,L)),Fe(this,L,void 0))},G=function(){const e=Ue(this,S).getQueryCache().build(Ue(this,S),this.options);if(e===Ue(this,M))return;const t=Ue(this,M);Fe(this,M,e),Fe(this,C,e.state),this.hasListeners()&&(null==t||t.removeObserver(this),e.addObserver(this))},X=function(e){Sp.batch(()=>{e.listeners&&this.listeners.forEach(e=>{e(Ue(this,E))}),Ue(this,S).getQueryCache().notify({query:Ue(this,M),type:"observerResultsUpdated"})})},q);function Lp(e,t){return function(e,t){return!1!==np(t.enabled,e)&&void 0===e.state.data&&!("error"===e.state.status&&!1===t.retryOnMount)}(e,t)||void 0!==e.state.data&&Dp(e,t,t.refetchOnMount)}function Dp(e,t,n){if(!1!==np(t.enabled,e)&&"static"!==tp(t.staleTime,e)){const a="function"==typeof n?n(e):n;return"always"===a||!1!==a&&Op(e,t)}return!1}function Up(e,t,n,a){return(e!==t||!1===np(a.enabled,e))&&(!n.suspense||"error"!==e.state.status)&&Op(e,n)}function Op(e,t){return!1!==np(t.enabled,e)&&e.isStaleByTime(tp(t.staleTime,e))}function Fp(e){return{onFetch:(t,n)=>{var a,r,i,s,o;const l=t.options,c=null==(i=null==(r=null==(a=t.fetchOptions)?void 0:a.meta)?void 0:r.fetchMore)?void 0:i.direction,d=(null==(s=t.state.data)?void 0:s.pages)||[],u=(null==(o=t.state.data)?void 0:o.pageParams)||[];let h={pages:[],pageParams:[]},p=0;const m=async()=>{let n=!1;const a=e=>{!function(e,t,n){let a,r=!1;Object.defineProperty(e,"signal",{enumerable:!0,get:()=>(a??(a=t()),r||(r=!0,a.aborted?n():a.addEventListener("abort",n,{once:!0})),a)})}(e,()=>t.signal,()=>n=!0)},r=yp(t.options,t.fetchOptions),i=async(e,i,s)=>{if(n)return Promise.reject();if(null==i&&e.pages.length)return Promise.resolve(e);const o=(()=>{const e={client:t.client,queryKey:t.queryKey,pageParam:i,direction:s?"backward":"forward",meta:t.options.meta};return a(e),e})(),l=await r(o),{maxPages:c}=t.options,d=s?gp:fp;return{pages:d(e.pages,l,c),pageParams:d(e.pageParams,i,c)}};if(c&&d.length){const e="backward"===c,t={pages:d,pageParams:u},n=(e?Bp:zp)(l,t);h=await i(t,n,e)}else{const t=e??d.length;do{const e=0===p?u[0]??l.initialPageParam:zp(l,h);if(p>0&&null==e)break;h=await i(h,e),p++}while(p<t)}return h};t.options.persister?t.fetchFn=()=>{var e,a;return null==(a=(e=t.options).persister)?void 0:a.call(e,m,{client:t.client,queryKey:t.queryKey,meta:t.options.meta,signal:t.signal},n)}:t.fetchFn=m}}}function zp(e,{pages:t,pageParams:n}){const a=t.length-1;return t.length>0?e.getNextPageParam(t[a],t,n[a],n):void 0}function Bp(e,{pages:t,pageParams:n}){var a;return t.length>0?null==(a=e.getPreviousPageParam)?void 0:a.call(e,t[0],t,n[0],n):void 0}var Hp=(te=class extends Np{constructor(e){super(),Oe(this,Q),Oe(this,K),Oe(this,Y),Oe(this,J),Oe(this,Z),Fe(this,K,e.client),this.mutationId=e.mutationId,Fe(this,J,e.mutationCache),Fe(this,Y,[]),this.state=e.state||{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0},this.setOptions(e.options),this.scheduleGc()}setOptions(e){this.options=e,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(e){Ue(this,Y).includes(e)||(Ue(this,Y).push(e),this.clearGcTimeout(),Ue(this,J).notify({type:"observerAdded",mutation:this,observer:e}))}removeObserver(e){Fe(this,Y,Ue(this,Y).filter(t=>t!==e)),this.scheduleGc(),Ue(this,J).notify({type:"observerRemoved",mutation:this,observer:e})}optionalRemove(){Ue(this,Y).length||("pending"===this.state.status?this.scheduleGc():Ue(this,J).remove(this))}continue(){var e;return(null==(e=Ue(this,Z))?void 0:e.continue())??this.execute(this.state.variables)}async execute(e){var t,n,a,r,i,s,o,l,c,d,u,h,p,m,f,g,v,y,x,b;const _=()=>{ze(this,Q,ee).call(this,{type:"continue"})},w={client:Ue(this,K),meta:this.options.meta,mutationKey:this.options.mutationKey};Fe(this,Z,Tp({fn:()=>this.options.mutationFn?this.options.mutationFn(e,w):Promise.reject(new Error("No mutationFn found")),onFail:(e,t)=>{ze(this,Q,ee).call(this,{type:"failed",failureCount:e,error:t})},onPause:()=>{ze(this,Q,ee).call(this,{type:"pause"})},onContinue:_,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>Ue(this,J).canRun(this)}));const S="pending"===this.state.status,M=!Ue(this,Z).canStart();try{if(S)_();else{ze(this,Q,ee).call(this,{type:"pending",variables:e,isPaused:M}),await(null==(n=(t=Ue(this,J).config).onMutate)?void 0:n.call(t,e,this,w));const i=await(null==(r=(a=this.options).onMutate)?void 0:r.call(a,e,w));i!==this.state.context&&ze(this,Q,ee).call(this,{type:"pending",context:i,variables:e,isPaused:M})}const p=await Ue(this,Z).start();return await(null==(s=(i=Ue(this,J).config).onSuccess)?void 0:s.call(i,p,e,this.state.context,this,w)),await(null==(l=(o=this.options).onSuccess)?void 0:l.call(o,p,e,this.state.context,w)),await(null==(d=(c=Ue(this,J).config).onSettled)?void 0:d.call(c,p,null,this.state.variables,this.state.context,this,w)),await(null==(h=(u=this.options).onSettled)?void 0:h.call(u,p,null,e,this.state.context,w)),ze(this,Q,ee).call(this,{type:"success",data:p}),p}catch(C){try{await(null==(m=(p=Ue(this,J).config).onError)?void 0:m.call(p,C,e,this.state.context,this,w))}catch(E){Promise.reject(E)}try{await(null==(g=(f=this.options).onError)?void 0:g.call(f,C,e,this.state.context,w))}catch(E){Promise.reject(E)}try{await(null==(y=(v=Ue(this,J).config).onSettled)?void 0:y.call(v,void 0,C,this.state.variables,this.state.context,this,w))}catch(E){Promise.reject(E)}try{await(null==(b=(x=this.options).onSettled)?void 0:b.call(x,void 0,C,e,this.state.context,w))}catch(E){Promise.reject(E)}throw ze(this,Q,ee).call(this,{type:"error",error:C}),C}finally{Ue(this,J).runNext(this)}}},K=new WeakMap,Y=new WeakMap,J=new WeakMap,Z=new WeakMap,Q=new WeakSet,ee=function(e){this.state=(t=>{switch(e.type){case"failed":return{...t,failureCount:e.failureCount,failureReason:e.error};case"pause":return{...t,isPaused:!0};case"continue":return{...t,isPaused:!1};case"pending":return{...t,context:e.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:e.isPaused,status:"pending",variables:e.variables,submittedAt:Date.now()};case"success":return{...t,data:e.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...t,data:void 0,error:e.error,failureCount:t.failureCount+1,failureReason:e.error,isPaused:!1,status:"error"}}})(this.state),Sp.batch(()=>{Ue(this,Y).forEach(t=>{t.onMutationUpdate(e)}),Ue(this,J).notify({mutation:this,type:"updated",action:e})})},te);var $p=(ie=class extends qh{constructor(e={}){super(),Oe(this,ne),Oe(this,ae),Oe(this,re),this.config=e,Fe(this,ne,new Set),Fe(this,ae,new Map),Fe(this,re,0)}build(e,t,n){const a=new Hp({client:e,mutationCache:this,mutationId:++Be(this,re)._,options:e.defaultMutationOptions(t),state:n});return this.add(a),a}add(e){Ue(this,ne).add(e);const t=Vp(e);if("string"==typeof t){const n=Ue(this,ae).get(t);n?n.push(e):Ue(this,ae).set(t,[e])}this.notify({type:"added",mutation:e})}remove(e){if(Ue(this,ne).delete(e)){const t=Vp(e);if("string"==typeof t){const n=Ue(this,ae).get(t);if(n)if(n.length>1){const t=n.indexOf(e);-1!==t&&n.splice(t,1)}else n[0]===e&&Ue(this,ae).delete(t)}}this.notify({type:"removed",mutation:e})}canRun(e){const t=Vp(e);if("string"==typeof t){const n=Ue(this,ae).get(t),a=null==n?void 0:n.find(e=>"pending"===e.state.status);return!a||a===e}return!0}runNext(e){var t;const n=Vp(e);if("string"==typeof n){const a=null==(t=Ue(this,ae).get(n))?void 0:t.find(t=>t!==e&&t.state.isPaused);return(null==a?void 0:a.continue())??Promise.resolve()}return Promise.resolve()}clear(){Sp.batch(()=>{Ue(this,ne).forEach(e=>{this.notify({type:"removed",mutation:e})}),Ue(this,ne).clear(),Ue(this,ae).clear()})}getAll(){return Array.from(Ue(this,ne))}find(e){const t={exact:!0,...e};return this.getAll().find(e=>rp(t,e))}findAll(e={}){return this.getAll().filter(t=>rp(e,t))}notify(e){Sp.batch(()=>{this.listeners.forEach(t=>{t(e)})})}resumePausedMutations(){const e=this.getAll().filter(e=>e.state.isPaused);return Sp.batch(()=>Promise.all(e.map(e=>e.continue().catch(Zh))))}},ne=new WeakMap,ae=new WeakMap,re=new WeakMap,ie);function Vp(e){var t;return null==(t=e.options.scope)?void 0:t.id}function Wp(e,t){const n=new Set(t);return e.filter(e=>!n.has(e))}var Gp=(_e=class extends qh{constructor(e,t,n){super(),Oe(this,fe),Oe(this,se),Oe(this,oe),Oe(this,le),Oe(this,ce),Oe(this,de),Oe(this,ue),Oe(this,he),Oe(this,pe),Oe(this,me,[]),Fe(this,se,e),Fe(this,ce,n),Fe(this,le,[]),Fe(this,de,[]),Fe(this,oe,[]),this.setQueries(t)}onSubscribe(){1===this.listeners.size&&Ue(this,de).forEach(e=>{e.subscribe(t=>{ze(this,fe,xe).call(this,e,t)})})}onUnsubscribe(){this.listeners.size||this.destroy()}destroy(){this.listeners=new Set,Ue(this,de).forEach(e=>{e.destroy()})}setQueries(e,t){Fe(this,le,e),Fe(this,ce,t),Sp.batch(()=>{const e=Ue(this,de),t=ze(this,fe,ye).call(this,Ue(this,le));t.forEach(e=>e.observer.setOptions(e.defaultedQueryOptions));const n=t.map(e=>e.observer),a=n.map(e=>e.getCurrentResult()),r=e.length!==n.length,i=n.some((t,n)=>t!==e[n]),s=r||i,o=!!s||a.some((e,t)=>{const n=Ue(this,oe)[t];return!n||!dp(e,n)});(s||o)&&(s&&(Fe(this,me,t),Fe(this,de,n)),Fe(this,oe,a),this.hasListeners()&&(s&&(Wp(e,n).forEach(e=>{e.destroy()}),Wp(n,e).forEach(e=>{e.subscribe(t=>{ze(this,fe,xe).call(this,e,t)})})),ze(this,fe,be).call(this)))})}getCurrentResult(){return Ue(this,oe)}getQueries(){return Ue(this,de).map(e=>e.getCurrentQuery())}getObservers(){return Ue(this,de)}getOptimisticResult(e,t){const n=ze(this,fe,ye).call(this,e),a=n.map(e=>e.observer.getOptimisticResult(e.defaultedQueryOptions));return[a,e=>ze(this,fe,ve).call(this,e??a,t),()=>ze(this,fe,ge).call(this,a,n)]}},se=new WeakMap,oe=new WeakMap,le=new WeakMap,ce=new WeakMap,de=new WeakMap,ue=new WeakMap,he=new WeakMap,pe=new WeakMap,me=new WeakMap,fe=new WeakSet,ge=function(e,t){return t.map((n,a)=>{const r=e[a];return n.defaultedQueryOptions.notifyOnChangeProps?r:n.observer.trackResult(r,e=>{t.forEach(t=>{t.observer.trackProp(e)})})})},ve=function(e,t){return t?(Ue(this,ue)&&Ue(this,oe)===Ue(this,pe)&&t===Ue(this,he)||(Fe(this,he,t),Fe(this,pe,Ue(this,oe)),Fe(this,ue,cp(Ue(this,ue),t(e)))),Ue(this,ue)):e},ye=function(e){const t=new Map;Ue(this,de).forEach(e=>{const n=e.options.queryHash;if(!n)return;const a=t.get(n);a?a.push(e):t.set(n,[e])});const n=[];return e.forEach(e=>{var a;const r=Ue(this,se).defaultQueryOptions(e),i=(null==(a=t.get(r.queryHash))?void 0:a.shift())??new Ip(Ue(this,se),r);n.push({defaultedQueryOptions:r,observer:i})}),n},xe=function(e,t){const n=Ue(this,de).indexOf(e);-1!==n&&(Fe(this,oe,function(e,t,n){const a=e.slice(0);return a[t]=n,a}(Ue(this,oe),n,t)),ze(this,fe,be).call(this))},be=function(){var e;if(this.hasListeners()){const t=Ue(this,ue),n=ze(this,fe,ge).call(this,Ue(this,oe),Ue(this,me));t!==ze(this,fe,ve).call(this,n,null==(e=Ue(this,ce))?void 0:e.combine)&&Sp.batch(()=>{this.listeners.forEach(e=>{e(Ue(this,oe))})})}},_e),Xp=(Se=class extends qh{constructor(e={}){super(),Oe(this,we),this.config=e,Fe(this,we,new Map)}build(e,t,n){const a=t.queryKey,r=t.queryHash??ip(a,t);let i=this.get(r);return i||(i=new Pp({client:e,queryKey:a,queryHash:r,options:e.defaultQueryOptions(t),state:n,defaultOptions:e.getQueryDefaults(a)}),this.add(i)),i}add(e){Ue(this,we).has(e.queryHash)||(Ue(this,we).set(e.queryHash,e),this.notify({type:"added",query:e}))}remove(e){const t=Ue(this,we).get(e.queryHash);t&&(e.destroy(),t===e&&Ue(this,we).delete(e.queryHash),this.notify({type:"removed",query:e}))}clear(){Sp.batch(()=>{this.getAll().forEach(e=>{this.remove(e)})})}get(e){return Ue(this,we).get(e)}getAll(){return[...Ue(this,we).values()]}find(e){const t={exact:!0,...e};return this.getAll().find(e=>ap(t,e))}findAll(e={}){const t=this.getAll();return Object.keys(e).length>0?t.filter(t=>ap(e,t)):t}notify(e){Sp.batch(()=>{this.listeners.forEach(t=>{t(e)})})}onFocus(){Sp.batch(()=>{this.getAll().forEach(e=>{e.onFocus()})})}onOnline(){Sp.batch(()=>{this.getAll().forEach(e=>{e.onOnline()})})}},we=new WeakMap,Se),qp=(Ae=class{constructor(e={}){Oe(this,Me),Oe(this,Ce),Oe(this,Ee),Oe(this,ke),Oe(this,Te),Oe(this,Ne),Oe(this,Pe),Oe(this,je),Fe(this,Me,e.queryCache||new Xp),Fe(this,Ce,e.mutationCache||new $p),Fe(this,Ee,e.defaultOptions||{}),Fe(this,ke,new Map),Fe(this,Te,new Map),Fe(this,Ne,0)}mount(){Be(this,Ne)._++,1===Ue(this,Ne)&&(Fe(this,Pe,bp.subscribe(async e=>{e&&(await this.resumePausedMutations(),Ue(this,Me).onFocus())})),Fe(this,je,Mp.subscribe(async e=>{e&&(await this.resumePausedMutations(),Ue(this,Me).onOnline())})))}unmount(){var e,t;Be(this,Ne)._--,0===Ue(this,Ne)&&(null==(e=Ue(this,Pe))||e.call(this),Fe(this,Pe,void 0),null==(t=Ue(this,je))||t.call(this),Fe(this,je,void 0))}isFetching(e){return Ue(this,Me).findAll({...e,fetchStatus:"fetching"}).length}isMutating(e){return Ue(this,Ce).findAll({...e,status:"pending"}).length}getQueryData(e){var t;const n=this.defaultQueryOptions({queryKey:e});return null==(t=Ue(this,Me).get(n.queryHash))?void 0:t.state.data}ensureQueryData(e){const t=this.defaultQueryOptions(e),n=Ue(this,Me).build(this,t),a=n.state.data;return void 0===a?this.fetchQuery(e):(e.revalidateIfStale&&n.isStaleByTime(tp(t.staleTime,n))&&this.prefetchQuery(t),Promise.resolve(a))}getQueriesData(e){return Ue(this,Me).findAll(e).map(({queryKey:e,state:t})=>[e,t.data])}setQueryData(e,t,n){const a=this.defaultQueryOptions({queryKey:e}),r=Ue(this,Me).get(a.queryHash),i=function(e,t){return"function"==typeof e?e(t):e}(t,null==r?void 0:r.state.data);if(void 0!==i)return Ue(this,Me).build(this,a).setData(i,{...n,manual:!0})}setQueriesData(e,t,n){return Sp.batch(()=>Ue(this,Me).findAll(e).map(({queryKey:e})=>[e,this.setQueryData(e,t,n)]))}getQueryState(e){var t;const n=this.defaultQueryOptions({queryKey:e});return null==(t=Ue(this,Me).get(n.queryHash))?void 0:t.state}removeQueries(e){const t=Ue(this,Me);Sp.batch(()=>{t.findAll(e).forEach(e=>{t.remove(e)})})}resetQueries(e,t){const n=Ue(this,Me);return Sp.batch(()=>(n.findAll(e).forEach(e=>{e.reset()}),this.refetchQueries({type:"active",...e},t)))}cancelQueries(e,t={}){const n={revert:!0,...t},a=Sp.batch(()=>Ue(this,Me).findAll(e).map(e=>e.cancel(n)));return Promise.all(a).then(Zh).catch(Zh)}invalidateQueries(e,t={}){return Sp.batch(()=>(Ue(this,Me).findAll(e).forEach(e=>{e.invalidate()}),"none"===(null==e?void 0:e.refetchType)?Promise.resolve():this.refetchQueries({...e,type:(null==e?void 0:e.refetchType)??(null==e?void 0:e.type)??"active"},t)))}refetchQueries(e,t={}){const n={...t,cancelRefetch:t.cancelRefetch??!0},a=Sp.batch(()=>Ue(this,Me).findAll(e).filter(e=>!e.isDisabled()&&!e.isStatic()).map(e=>{let t=e.fetch(void 0,n);return n.throwOnError||(t=t.catch(Zh)),"paused"===e.state.fetchStatus?Promise.resolve():t}));return Promise.all(a).then(Zh)}fetchQuery(e){const t=this.defaultQueryOptions(e);void 0===t.retry&&(t.retry=!1);const n=Ue(this,Me).build(this,t);return n.isStaleByTime(tp(t.staleTime,n))?n.fetch(t):Promise.resolve(n.state.data)}prefetchQuery(e){return this.fetchQuery(e).then(Zh).catch(Zh)}fetchInfiniteQuery(e){return e.behavior=Fp(e.pages),this.fetchQuery(e)}prefetchInfiniteQuery(e){return this.fetchInfiniteQuery(e).then(Zh).catch(Zh)}ensureInfiniteQueryData(e){return e.behavior=Fp(e.pages),this.ensureQueryData(e)}resumePausedMutations(){return Mp.isOnline()?Ue(this,Ce).resumePausedMutations():Promise.resolve()}getQueryCache(){return Ue(this,Me)}getMutationCache(){return Ue(this,Ce)}getDefaultOptions(){return Ue(this,Ee)}setDefaultOptions(e){Fe(this,Ee,e)}setQueryDefaults(e,t){Ue(this,ke).set(sp(e),{queryKey:e,defaultOptions:t})}getQueryDefaults(e){const t=[...Ue(this,ke).values()],n={};return t.forEach(t=>{op(e,t.queryKey)&&Object.assign(n,t.defaultOptions)}),n}setMutationDefaults(e,t){Ue(this,Te).set(sp(e),{mutationKey:e,defaultOptions:t})}getMutationDefaults(e){const t=[...Ue(this,Te).values()],n={};return t.forEach(t=>{op(e,t.mutationKey)&&Object.assign(n,t.defaultOptions)}),n}defaultQueryOptions(e){if(e._defaulted)return e;const t={...Ue(this,Ee).queries,...this.getQueryDefaults(e.queryKey),...e,_defaulted:!0};return t.queryHash||(t.queryHash=ip(t.queryKey,t)),void 0===t.refetchOnReconnect&&(t.refetchOnReconnect="always"!==t.networkMode),void 0===t.throwOnError&&(t.throwOnError=!!t.suspense),!t.networkMode&&t.persister&&(t.networkMode="offlineFirst"),t.queryFn===vp&&(t.enabled=!1),t}defaultMutationOptions(e){return(null==e?void 0:e._defaulted)?e:{...Ue(this,Ee).mutations,...(null==e?void 0:e.mutationKey)&&this.getMutationDefaults(e.mutationKey),...e,_defaulted:!0}}clear(){Ue(this,Me).clear(),Ue(this,Ce).clear()}},Me=new WeakMap,Ce=new WeakMap,Ee=new WeakMap,ke=new WeakMap,Te=new WeakMap,Ne=new WeakMap,Pe=new WeakMap,je=new WeakMap,Ae),Kp=Tt.createContext(void 0),Yp=({client:e,children:t})=>(Tt.useEffect(()=>(e.mount(),()=>{e.unmount()}),[e]),Ut.jsx(Kp.Provider,{value:e,children:t})),Jp=Tt.createContext(!1);Jp.Provider;var Zp=Tt.createContext(function(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}()),Qp=(e,t)=>(null==e?void 0:e.suspense)&&t.isPending,em=(e,t,n)=>t.fetchOptimistic(e).catch(()=>{n.clearReset()});function tm({queries:e,...t},n){const a=(()=>{const e=Tt.useContext(Kp);if(!e)throw new Error("No QueryClient set, use QueryClientProvider to set one");return e})(),r=Tt.useContext(Jp),i=Tt.useContext(Zp),s=Tt.useMemo(()=>e.map(e=>{const t=a.defaultQueryOptions(e);return t._optimisticResults=r?"isRestoring":"optimistic",t}),[e,a,r]);s.forEach(e=>{(e=>{if(e.suspense){const t=1e3,n=e=>"static"===e?e:Math.max(e??t,t),a=e.staleTime;e.staleTime="function"==typeof a?(...e)=>n(a(...e)):n(a),"number"==typeof e.gcTime&&(e.gcTime=Math.max(e.gcTime,t))}})(e);const t=a.getQueryCache().get(e.queryHash);((e,t,n)=>{const a=(null==n?void 0:n.state.error)&&"function"==typeof e.throwOnError?xp(e.throwOnError,[n.state.error,n]):e.throwOnError;(e.suspense||e.experimental_prefetchInRender||a)&&(t.isReset()||(e.retryOnMount=!1))})(e,i,t)}),(e=>{Tt.useEffect(()=>{e.clearReset()},[e])})(i);const[o]=Tt.useState(()=>new Gp(a,s,t)),[l,c,d]=o.getOptimisticResult(s,t.combine),u=!r&&!1!==t.subscribed;Tt.useSyncExternalStore(Tt.useCallback(e=>u?o.subscribe(Sp.batchCalls(e)):Zh,[o,u]),()=>o.getCurrentResult(),()=>o.getCurrentResult()),Tt.useEffect(()=>{o.setQueries(s,t)},[s,t,o]);const h=l.some((e,t)=>Qp(s[t],e))?l.flatMap((e,t)=>{const n=s[t];if(n){const t=new Ip(a,n);if(Qp(n,e))return em(n,t,i);((e,t)=>e.isLoading&&e.isFetching&&!t)(e,r)&&em(n,t,i)}return[]}):[];if(h.length>0)throw Promise.all(h);const p=l.find((e,t)=>{const n=s[t];return n&&(({result:e,errorResetBoundary:t,throwOnError:n,query:a,suspense:r})=>e.isError&&!t.isReset()&&!e.isFetching&&a&&(r&&void 0===e.data||xp(n,[e.error,a])))({result:e,errorResetBoundary:i,throwOnError:n.throwOnError,query:a.getQueryCache().get(n.queryHash),suspense:n.suspense})});if(null==p?void 0:p.error)throw p.error;return c(d())}const nm={},am=e=>{let t;const n=new Set,a=(e,a)=>{const r="function"==typeof e?e(t):e;if(!Object.is(r,t)){const e=t;t=(null!=a?a:"object"!=typeof r||null===r)?r:Object.assign({},t,r),n.forEach(n=>n(t,e))}},r=()=>t,i={setState:a,getState:r,getInitialState:()=>s,subscribe:e=>(n.add(e),()=>n.delete(e)),destroy:()=>{"production"!==(nm?"production":void 0)&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},s=t=e(a,r,i);return i};var rm={exports:{}},im={},sm={exports:{}},om={},lm=Tt;var cm="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},dm=lm.useState,um=lm.useEffect,hm=lm.useLayoutEffect,pm=lm.useDebugValue;function mm(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!cm(e,n)}catch(a){return!0}}var fm="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var n=t(),a=dm({inst:{value:n,getSnapshot:t}}),r=a[0].inst,i=a[1];return hm(function(){r.value=n,r.getSnapshot=t,mm(r)&&i({inst:r})},[e,n,t]),um(function(){return mm(r)&&i({inst:r}),e(function(){mm(r)&&i({inst:r})})},[e]),pm(n),n};om.useSyncExternalStore=void 0!==lm.useSyncExternalStore?lm.useSyncExternalStore:fm,sm.exports=om;var gm=sm.exports,vm=Tt,ym=gm;
/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var xm="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},bm=ym.useSyncExternalStore,_m=vm.useRef,wm=vm.useEffect,Sm=vm.useMemo,Mm=vm.useDebugValue;im.useSyncExternalStoreWithSelector=function(e,t,n,a,r){var i=_m(null);if(null===i.current){var s={hasValue:!1,value:null};i.current=s}else s=i.current;i=Sm(function(){function e(e){if(!l){if(l=!0,i=e,e=a(e),void 0!==r&&s.hasValue){var t=s.value;if(r(t,e))return o=t}return o=e}if(t=o,xm(i,e))return t;var n=a(e);return void 0!==r&&r(t,n)?(i=e,t):(i=e,o=n)}var i,o,l=!1,c=void 0===n?null:n;return[function(){return e(t())},null===c?void 0:function(){return e(c())}]},[t,n,a,r]);var o=bm(e,i[0],i[1]);return wm(function(){s.hasValue=!0,s.value=o},[o]),Mm(o),o},rm.exports=im;const Cm=$e(rm.exports),Em={},{useDebugValue:km}=Nt,{useSyncExternalStoreWithSelector:Tm}=Cm;let Nm=!1;const Pm=e=>e;const jm=e=>{"production"!==(Em?"production":void 0)&&"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t="function"==typeof e?(e=>e?am(e):am)(e):e,n=(e,n)=>function(e,t=Pm,n){"production"!==(Em?"production":void 0)&&n&&!Nm&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Nm=!0);const a=Tm(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,n);return km(a),a}(t,e,n);return Object.assign(n,t),n},Am=e=>e?jm(e):jm,Rm={camera:{camera_type:"Digital",manufacturer:"ARRI",body:"Alexa_35",sensor:"Super35",weight_class:"Medium",film_stock:"None",aspect_ratio:"1.85:1"},lens:{manufacturer:"ARRI",family:"ARRI_Signature_Prime",focal_length_mm:35,is_anamorphic:!1},movement:{equipment:"Static",movement_type:"Static",timing:"Static"},lighting:{time_of_day:"Afternoon",source:"Sun",style:"Naturalistic"},visual_grammar:{shot_size:"MS",composition:"Rule_of_Thirds",mood:"Contemplative",color_tone:"Neutral_Saturated"}},Im={medium:"2D",style_domain:"Anime",rendering:{line_treatment:"Clean",color_application:"Cel",lighting_model:"Naturalistic_Simulated",surface_detail:"Smooth"},motion:{motion_style:"Full",virtual_camera:"Digital_Pan"},visual_grammar:{shot_size:"MS",composition:"Rule_of_Thirds",mood:"Contemplative",color_tone:"Neutral_Saturated"}},Lm=Am(e=>({projectType:"live_action",setProjectType:t=>e({projectType:t}),liveActionConfig:Rm,animationConfig:Im,setLiveActionConfig:t=>e({liveActionConfig:t}),setAnimationConfig:t=>e({animationConfig:t}),updateLiveAction:(t,n)=>e(e=>({liveActionConfig:{...e.liveActionConfig,[t]:"object"==typeof e.liveActionConfig[t]?{...e.liveActionConfig[t],...n}:n}})),updateAnimation:(t,n)=>e(e=>({animationConfig:{...e.animationConfig,[t]:"object"==typeof e.animationConfig[t]?{...e.animationConfig[t],...n}:n}})),validationResult:null,setValidationResult:t=>e({validationResult:t}),generatedPrompt:"",negativePrompt:null,setGeneratedPrompt:(t,n=null)=>e({generatedPrompt:t,negativePrompt:n}),targetModel:"generic",setTargetModel:t=>e({targetModel:t}),selectedLiveActionPreset:null,selectedAnimationPreset:null,liveActionPresetList:[],animationPresetList:[],setSelectedLiveActionPreset:t=>e({selectedLiveActionPreset:t}),setSelectedAnimationPreset:t=>e({selectedAnimationPreset:t}),setLiveActionPresetList:t=>e({liveActionPresetList:t}),setAnimationPresetList:t=>e({animationPresetList:t}),applyLiveActionPresetConfig:(t,n)=>e({liveActionConfig:t,selectedLiveActionPreset:n,validationResult:null,generatedPrompt:"",negativePrompt:null}),applyAnimationPresetConfig:(t,n)=>e({animationConfig:t,selectedAnimationPreset:n,validationResult:null,generatedPrompt:"",negativePrompt:null}),clearPreset:()=>e({selectedLiveActionPreset:null,selectedAnimationPreset:null}),resetConfig:()=>e({liveActionConfig:Rm,animationConfig:Im,validationResult:null,generatedPrompt:"",negativePrompt:null,selectedLiveActionPreset:null,selectedAnimationPreset:null}),cpePromptForStoryboard:null,setCpePromptForStoryboard:t=>e({cpePromptForStoryboard:t})}));const Dm=new class{async fetch(e,t){const n=await fetch(`${e}`,{...t,headers:{"Content-Type":"application/json",...null==t?void 0:t.headers}});if(!n.ok){const e=await n.json().catch(()=>({}));throw new Error(e.detail||`API error: ${n.status}`)}return n.json()}async getOptions(e,t,n){return this.fetch("/options",{method:"POST",body:JSON.stringify({project_type:e,field_path:t,current_config:n})})}async getEnumValues(e){return(await this.fetch(`/enums/${e}`)).values}async listEnums(){return this.fetch("/enums")}async validateLiveAction(e){return this.fetch("/validate",{method:"POST",body:JSON.stringify({project_type:"live_action",config:e})})}async validateAnimation(e){return this.fetch("/validate",{method:"POST",body:JSON.stringify({project_type:"animation",config:e})})}async generateLiveActionPrompt(e,t="generic"){return this.fetch("/generate-prompt",{method:"POST",body:JSON.stringify({project_type:"live_action",config:e,target_model:t})})}async generateAnimationPrompt(e,t="generic"){return this.fetch("/generate-prompt",{method:"POST",body:JSON.stringify({project_type:"animation",config:e,target_model:t})})}async getLiveActionPresets(){return this.fetch("/presets/live-action")}async getAnimationPresets(){return this.fetch("/presets/animation")}async getLiveActionPreset(e){return this.fetch(`/presets/live-action/${e}`)}async getCinematographyStyle(e){return this.fetch(`/presets/live-action/${e}/cinematography-style`)}async getAnimationPreset(e){return this.fetch(`/presets/animation/${e}`)}async applyLiveActionPreset(e,t){return this.fetch("/apply-preset/live-action",{method:"POST",body:JSON.stringify({preset_id:e,overrides:t??null})})}async applyAnimationPreset(e,t){return this.fetch("/apply-preset/animation",{method:"POST",body:JSON.stringify({preset_id:e,overrides:t??null})})}async searchPresets(e,t,n){const a=new URLSearchParams({q:e});return t&&a.append("project_type",t),n&&a.append("limit",n.toString()),this.fetch(`/presets/search?${a.toString()}`)}async getEras(){return this.fetch("/presets/eras")}async getDomains(){return this.fetch("/presets/domains")}async listProviders(){return this.fetch("/settings/providers")}async getProvider(e){return this.fetch(`/settings/providers/${e}`)}async testProviderConnection(e,t){return this.fetch(`/settings/providers/${e}/test`,{method:"POST",body:JSON.stringify({endpoint:null==t?void 0:t.endpoint,api_key:null==t?void 0:t.apiKey})})}async detectLocalProviders(){return this.fetch("/settings/providers/local/detect")}async testCustomEndpoint(e,t){return this.fetch("/settings/custom-endpoint/test",{method:"POST",body:JSON.stringify({endpoint:e,api_key:t})})}async listOAuthProviders(){return this.fetch("/settings/oauth/providers")}async initiateOAuth(e,t,n){return this.fetch(`/settings/oauth/${e}/authorize`,{method:"POST",body:JSON.stringify({client_id:n||"",redirect_uri:t})})}async exchangeOAuthCode(e,t,n,a,r,i){return this.fetch(`/settings/oauth/${e}/callback`,{method:"POST",body:JSON.stringify({code:t,state:n,client_id:r||"",client_secret:i,redirect_uri:a})})}async getOAuthFlowType(e){return this.fetch(`/settings/oauth/${e}/flow-type`)}async requestDeviceCode(e,t){return this.fetch(`/settings/oauth/${e}/device-code`,{method:"POST",body:JSON.stringify({client_id:t||null})})}async pollDeviceToken(e,t,n){return this.fetch(`/settings/oauth/${e}/device-poll`,{method:"POST",body:JSON.stringify({client_id:n||null,device_code:t})})}async startCallbackServer(e,t,n,a){return this.fetch(`/settings/oauth/${e}/start-callback-server`,{method:"POST",body:JSON.stringify({state:t,code_verifier:n||null,custom_redirect_uri:a||null})})}async pollCallbackToken(e,t){return this.fetch(`/settings/oauth/${e}/poll-token?state=${encodeURIComponent(t)}`)}async stopCallbackServer(e,t){return this.fetch(`/settings/oauth/${e}/callback-server?state=${encodeURIComponent(t)}`,{method:"DELETE"})}async getCallbackServerStatus(e,t){return this.fetch(`/settings/oauth/${e}/callback-server-status?state=${encodeURIComponent(t)}`)}async refreshOAuthToken(e){return this.fetch(`/settings/oauth/${e}/refresh`,{method:"POST"})}async enhancePrompt(e){return this.fetch("/enhance-prompt",{method:"POST",body:JSON.stringify({user_prompt:e.userPrompt,llm_provider:e.llmProvider,llm_model:e.llmModel,target_model:e.targetModel,project_type:e.projectType,config:e.config,credentials:{api_key:e.credentials.apiKey,endpoint:e.credentials.endpoint,oauth_token:e.credentials.oauthToken}})})}async fetchLlmModels(e){return this.fetch("/llm/models",{method:"POST",body:JSON.stringify({provider:e.provider,credentials:{api_key:e.credentials.apiKey,endpoint:e.credentials.endpoint,oauth_token:e.credentials.oauthToken}})})}async getTargetModels(){return this.fetch("/target-models")}async getAllCredentials(){return this.fetch("/credentials")}async getProviderCredentials(e){return this.fetch(`/credentials/${e}`)}async updateProviderCredentials(e,t){return this.fetch(`/credentials/${e}`,{method:"PUT",body:JSON.stringify({api_key:t.api_key,endpoint:t.endpoint,oauth_token:t.oauth_token,oauth_refresh_token:t.oauth_refresh_token,oauth_client_id:t.oauth_client_id,oauth_client_secret:t.oauth_client_secret})})}async deleteProviderCredentials(e){return this.fetch(`/credentials/${e}`,{method:"DELETE"})}async getSettings(){return this.fetch("/settings")}async updateSettings(e){return this.fetch("/settings",{method:"PUT",body:JSON.stringify({active_provider:e.active_provider,selected_model:e.selected_model,target_model:e.target_model})})}async importCredentials(e){return this.fetch("/credentials/import",{method:"POST",body:JSON.stringify({data:e})})}},Um="cinema-ai-provider-settings",Om="cinema-llm-settings",Fm="cinema-target-model",zm="cinema-credentials-migrated",Bm=[{id:"openai",name:"OpenAI",type:"api_key",description:"GPT-4, GPT-4V for prompt enhancement and analysis",defaultEndpoint:"https://api.openai.com/v1",docsUrl:"https://platform.openai.com/docs"},{id:"google",name:"Google AI (Gemini)",type:"api_key",description:"Gemini Pro for multimodal prompt generation",defaultEndpoint:"https://generativelanguage.googleapis.com/v1",docsUrl:"https://ai.google.dev/docs"},{id:"anthropic",name:"Anthropic",type:"api_key",description:"Claude for prompt refinement and analysis",defaultEndpoint:"https://api.anthropic.com/v1",docsUrl:"https://docs.anthropic.com"},{id:"openrouter",name:"OpenRouter",type:"api_key",description:"Aggregated access to multiple AI models",defaultEndpoint:"https://openrouter.ai/api/v1",docsUrl:"https://openrouter.ai/docs"},{id:"replicate",name:"Replicate",type:"api_key",description:"Run open-source models including Llama, Mistral",defaultEndpoint:"https://api.replicate.com/v1",docsUrl:"https://replicate.com/docs"},{id:"stability",name:"Stability AI",type:"api_key",description:"Stable LM and language models",defaultEndpoint:"https://api.stability.ai/v1",docsUrl:"https://platform.stability.ai/docs"},{id:"ollama",name:"Ollama",type:"local",description:"Local LLM server (Llama, Mistral, etc.)",defaultEndpoint:"http://localhost:11434",docsUrl:"https://ollama.ai/docs"},{id:"lmstudio",name:"LM Studio",type:"local",description:"Local LLM with OpenAI-compatible API",defaultEndpoint:"http://localhost:1234/v1",docsUrl:"https://lmstudio.ai/docs"},{id:"github_copilot",name:"GitHub Copilot",type:"oauth",description:"AI assistance via GitHub OAuth (device flow)",docsUrl:"https://docs.github.com/en/copilot"},{id:"github_models",name:"GitHub Models",type:"api_key",description:"Access GPT-4o, Claude, Llama via GitHub PAT (requires models:read permission)",docsUrl:"https://docs.github.com/en/github-models/quickstart"},{id:"antigravity",name:"Antigravity (Gemini/Claude)",type:"oauth",description:"Google OAuth for Gemini 3 Pro and Claude models via Antigravity",docsUrl:"https://github.com/NoeFabris/opencode-antigravity-auth"},{id:"openai_codex",name:"OpenAI Codex (ChatGPT Plus/Pro)",type:"oauth",description:"OAuth for GPT-5.x models with ChatGPT subscription",docsUrl:"https://help.openai.com/en/articles/11369540-using-codex-with-your-chatgpt-plan"}],Hm={overlay:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",justifyContent:"flex-end",zIndex:1e3,backdropFilter:"blur(4px)"},panel:{width:"420px",maxWidth:"100%",height:"100%",backgroundColor:"var(--bg-medium)",borderLeft:"1px solid var(--border-subtle)",display:"flex",flexDirection:"column",overflow:"hidden",animation:"slideInRight 0.2s ease-out"},header:{padding:"1.25rem 1.5rem",borderBottom:"1px solid var(--border-subtle)",display:"flex",alignItems:"center",justifyContent:"space-between",backgroundColor:"var(--bg-dark)"},headerTitle:{fontSize:"1.1rem",fontWeight:600,color:"var(--text-primary)",margin:0},closeButton:{background:"none",border:"none",color:"var(--text-muted)",cursor:"pointer",padding:"0.5rem",borderRadius:"6px",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.15s ease"},content:{flex:1,overflowY:"auto",padding:"1.5rem"},section:{marginBottom:"1.5rem"},sectionTitle:{fontSize:"0.75rem",fontWeight:600,color:"var(--text-muted)",textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:"0.75rem"},label:{display:"block",fontSize:"0.85rem",color:"var(--text-secondary)",marginBottom:"0.5rem"},select:{width:"100%",padding:"0.65rem 0.75rem",backgroundColor:"var(--bg-dark)",border:"1px solid var(--border-subtle)",borderRadius:"6px",color:"var(--text-primary)",fontSize:"0.9rem",outline:"none",cursor:"pointer",transition:"border-color 0.15s ease",appearance:"none",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E\")",backgroundRepeat:"no-repeat",backgroundPosition:"right 0.75rem center"},providerInfo:{backgroundColor:"var(--bg-dark)",border:"1px solid var(--border-subtle)",borderRadius:"8px",padding:"1rem",marginTop:"1rem"},providerName:{fontSize:"1rem",fontWeight:500,color:"var(--text-primary)",marginBottom:"0.35rem"},providerDescription:{fontSize:"0.8rem",color:"var(--text-muted)",marginBottom:"1rem",lineHeight:1.4},inputGroup:{marginBottom:"0.75rem"},inputLabel:{display:"block",fontSize:"0.75rem",color:"var(--text-secondary)",marginBottom:"0.35rem"},input:{width:"100%",padding:"0.6rem 0.75rem",backgroundColor:"var(--bg-medium)",border:"1px solid var(--border-subtle)",borderRadius:"6px",color:"var(--text-primary)",fontSize:"0.85rem",outline:"none",transition:"border-color 0.15s ease",boxSizing:"border-box"},buttonRow:{display:"flex",gap:"0.5rem",marginTop:"1rem"},button:{padding:"0.5rem 0.85rem",borderRadius:"6px",fontSize:"0.8rem",fontWeight:500,cursor:"pointer",transition:"all 0.15s ease",border:"none"},buttonPrimary:{backgroundColor:"var(--accent-primary)",color:"white"},buttonSecondary:{backgroundColor:"var(--bg-light)",color:"var(--text-primary)",border:"1px solid var(--border-subtle)"},buttonOAuth:{backgroundColor:"var(--bg-light)",color:"var(--text-primary)",border:"1px solid var(--border-subtle)",display:"flex",alignItems:"center",gap:"0.5rem",width:"100%",justifyContent:"center",padding:"0.65rem 1rem"},statusRow:{display:"flex",alignItems:"center",gap:"0.5rem",marginTop:"0.75rem",padding:"0.5rem 0.75rem",backgroundColor:"var(--bg-medium)",borderRadius:"6px",fontSize:"0.8rem"},statusDot:{width:"8px",height:"8px",borderRadius:"50%",flexShrink:0},footer:{padding:"1rem 1.5rem",borderTop:"1px solid var(--border-subtle)",backgroundColor:"var(--bg-dark)",display:"flex",justifyContent:"flex-end",gap:"0.75rem"},errorText:{fontSize:"0.75rem",color:"var(--error)",marginTop:"0.35rem"},successText:{fontSize:"0.75rem",color:"var(--success)",marginTop:"0.35rem"},docsLink:{fontSize:"0.75rem",color:"var(--accent-primary)",textDecoration:"none",display:"inline-flex",alignItems:"center",gap:"0.25rem",marginTop:"0.5rem"}};function $m(){try{const e=localStorage.getItem(Um);if(e)return JSON.parse(e)}catch(e){console.error("Failed to load settings from localStorage:",e)}return{activeProvider:null,providers:{}}}function Vm(){localStorage.setItem(zm,"true")}async function Wm(e,t){try{await Dm.updateProviderCredentials(e,{api_key:t.apiKey,endpoint:t.endpoint,oauth_token:t.oauthToken,oauth_refresh_token:t.oauthRefreshToken,oauth_client_id:t.oauthClientId,oauth_client_secret:t.oauthClientSecret})}catch(n){throw console.error(`Failed to save credentials for ${e} to server:`,n),n}}async function Gm(){try{if("true"===localStorage.getItem(zm))return!1;const e=$m();if(!(e.activeProvider||Object.keys(e.providers).length>0))return Vm(),!1;const t=await Dm.getAllCredentials();if(t.active_provider||Object.keys(t.providers).length>0)return Vm(),!1;console.log("[Settings] Migrating credentials from localStorage to server..."),await Dm.importCredentials({activeProvider:e.activeProvider||void 0,providers:e.providers});const n=Ym();n&&await Dm.updateSettings({selected_model:n.model});const a=tf();return a&&await Dm.updateSettings({target_model:a}),Vm(),console.log("[Settings] Migration complete!"),!0}catch(e){return console.error("Failed to migrate localStorage to server:",e),!1}}function Xm(){return $m()}function qm(e){!function(e){try{localStorage.setItem(Um,JSON.stringify(e))}catch(t){console.error("Failed to save settings to localStorage:",t)}}(e)}function Km(e){return{disconnected:"Not connected",connecting:"Connecting...",connected:"Connected",error:"Connection failed"}[e]}function Ym(){try{const e=localStorage.getItem(Om);if(e)return JSON.parse(e)}catch(e){console.error("Failed to load LLM settings from localStorage:",e)}return null}function Jm(e){try{localStorage.setItem(Om,JSON.stringify(e))}catch(t){console.error("Failed to save LLM settings to localStorage:",t)}}function Zm(){return Ym()}function Qm(e){Jm(e),async function(e){try{await Dm.updateSettings({selected_model:`${e.provider}:${e.model}`}),Jm(e)}catch(t){console.error("Failed to save LLM settings to server:",t),Jm(e)}}(e).catch(console.error)}function ef(){return Zm()}function tf(){try{return localStorage.getItem(Fm)}catch(e){return console.error("Failed to load target model from localStorage:",e),null}}function nf(e){try{localStorage.setItem(Fm,e)}catch(t){console.error("Failed to save target model to localStorage:",t)}}function af(e){nf(e),async function(e){try{await Dm.updateSettings({target_model:e}),nf(e)}catch(t){console.error("Failed to save target model to server:",t),nf(e)}}(e).catch(console.error)}function rf({isOpen:e,onClose:t}){const[n,a]=Tt.useState(null),[r,i]=Tt.useState({}),[s,o]=Tt.useState("disconnected"),[l,c]=Tt.useState(null),[d,u]=Tt.useState(!1),[h,p]=Tt.useState(!1),[m,f]=Tt.useState(!1),[g,v]=Tt.useState(""),[y,x]=Tt.useState(""),[b,_]=Tt.useState([]),[w,S]=Tt.useState(!1),[M,C]=Tt.useState(null),[E,k]=Tt.useState(!1),[T,N]=Tt.useState(null),[P,j]=Tt.useState(!1),A=async e=>{var t,n;const a={...e};if((null==(t=e.github_copilot)?void 0:t.oauthRefreshToken)&&(null==(n=e.github_copilot)?void 0:n.oauthToken))try{const t=e.github_copilot.oauthToken;if(t.startsWith("eyJ"))try{const e=JSON.parse(atob(t.split(".")[1])),n=e.exp?1e3*e.exp:0,r=Date.now();if(n>0&&n-r<3e5){console.log("[Settings] GitHub Copilot token expires soon, refreshing...");const e=await Dm.refreshOAuthToken("github_copilot");e.success&&e.oauth_token?(console.log("[Settings] GitHub Copilot token refreshed successfully"),a.github_copilot={...a.github_copilot,oauthToken:e.oauth_token}):console.warn("[Settings] Failed to refresh GitHub Copilot token:",e.error_description)}}catch(r){console.log("[Settings] Could not decode token expiration, attempting refresh...");const e=await Dm.refreshOAuthToken("github_copilot");e.success&&e.oauth_token&&(a.github_copilot={...a.github_copilot,oauthToken:e.oauth_token})}}catch(i){console.warn("[Settings] Error refreshing GitHub Copilot token:",i)}return a};Tt.useEffect(()=>{if(!e)return;let t=!0;return(async()=>{try{await Gm();let e=await async function(){try{const t=await Dm.getAllCredentials(),n={};for(const a of Object.keys(t.providers))try{const e=await Dm.getProviderCredentials(a);e.exists&&(n[a]={apiKey:e.api_key,endpoint:e.endpoint,oauthToken:e.oauth_token,oauthRefreshToken:e.oauth_refresh_token,oauthClientId:e.oauth_client_id,oauthClientSecret:e.oauth_client_secret})}catch(e){console.warn(`Failed to load credentials for ${a}:`,e)}return{activeProvider:t.active_provider,providers:n}}catch(t){return console.error("Failed to load settings from server:",t),$m()}}();if(!t)return;if(e={...e,providers:await A(e.providers)},!t)return;a(e.activeProvider),i(e.providers),o("disconnected"),c(null),p(!1);const n=await async function(){try{const e=await Dm.getSettings();if(e.selected_model){const t=e.selected_model.indexOf(":");return-1!==t?{provider:e.selected_model.substring(0,t),model:e.selected_model.substring(t+1)}:{provider:"",model:e.selected_model}}return null}catch(e){return console.error("Failed to load LLM settings from server:",e),Ym()}}();n&&t&&(v(n.provider),x(n.model))}catch(e){if(console.error("Failed to load settings from server, falling back to localStorage:",e),!t)return;const n=Xm();a(n.activeProvider),i(n.providers),o("disconnected"),c(null),p(!1);const r=Zm();r&&(v(r.provider),x(r.model))}})(),()=>{t=!1}},[e]),Tt.useEffect(()=>{if(!g)return void _([]);const e=r[g],t=Bm.find(e=>e.id===g);if(!("api_key"===(null==t?void 0:t.type)&&(null==e?void 0:e.apiKey)||"oauth"===(null==t?void 0:t.type)&&(null==e?void 0:e.oauthToken)||"local"===(null==t?void 0:t.type)&&((null==e?void 0:e.endpoint)||(null==t?void 0:t.defaultEndpoint)))){const e=sf[g]||"Configure credentials to fetch available models.";return _([{id:"",name:` ${e}`,recommended:!1}]),void x("")}S(!0),Dm.fetchLlmModels({provider:g,credentials:{apiKey:null==e?void 0:e.apiKey,endpoint:null==e?void 0:e.endpoint,oauthToken:null==e?void 0:e.oauthToken}}).then(e=>{var t;if(e.success&&e.models.length>0){if(_(e.models),!e.models.find(e=>e.id===y)){const n=e.models.find(e=>e.recommended);x((null==n?void 0:n.id)||(null==(t=e.models[0])?void 0:t.id)||"")}}else{const t=e.error||"No models available. Check your credentials or provider status.";_([{id:"",name:` ${t}`,recommended:!1}]),x("")}}).catch(e=>{const t=(null==e?void 0:e.message)||"Failed to fetch models. Check your connection and credentials.";_([{id:"",name:` ${t}`,recommended:!1}]),x("")}).finally(()=>S(!1))},[g,r]);const R=n?Bm.find(e=>e.id===n):null,I=n&&r[n]||{};Tt.useEffect(()=>{n&&"oauth"===(null==R?void 0:R.type)?Dm.getOAuthFlowType(n).then(e=>{j(e.has_builtin_client||!1)}).catch(e=>{console.error("Failed to fetch OAuth flow type:",e),j(!1)}):j(!1)},[n,null==R?void 0:R.type]);const L=Tt.useCallback(e=>{a(e||null),o("disconnected"),c(null),p(!0)},[]),D=Tt.useCallback((e,t)=>{n&&(i(a=>{const r={...a,[n]:{...a[n],[e]:t||void 0}};if("oauthToken"===e||"oauthRefreshToken"===e||"oauthClientId"===e||"oauthClientSecret"===e){const t=r[n];Wm(n,t).catch(t=>{console.error(`Failed to persist ${e} to server:`,t)})}return r}),p(!0),o("disconnected"))},[n]),U=Tt.useCallback(async()=>{if(n&&R){u(!0),o("connecting"),c(null);try{const e=r[n]||{},t=await Dm.testProviderConnection(n,{endpoint:e.endpoint,apiKey:e.apiKey});o(t.status),t.success||c(t.message)}catch(e){o("error"),c(e instanceof Error?e.message:"Connection test failed")}finally{u(!1)}}},[n,R,r]),O=Tt.useCallback(async()=>{if(n&&R){o("connecting"),c(null),N(null);try{const t=await Dm.getOAuthFlowType(n);if("device"===t.flow_type){const e=r[n]||{},t=await Dm.requestDeviceCode(n,e.oauthClientId);C({userCode:t.user_code,verificationUri:t.verification_uri,deviceCode:t.device_code,interval:t.interval,expiresIn:t.expires_in}),k(!0);const a=1e3*t.interval,i=Date.now()+1e3*t.expires_in,s=async()=>{if(Date.now()>i)return k(!1),C(null),o("error"),void c("Authorization timed out. Please try again.");try{const r=await Dm.pollDeviceToken(n,t.device_code,e.oauthClientId);if(r.success&&r.access_token)k(!1),C(null),"github_copilot"===n&&r.copilot_token?(D("oauthToken",r.copilot_token),D("oauthRefreshToken",r.access_token)):(D("oauthToken",r.access_token),r.refresh_token&&D("oauthRefreshToken",r.refresh_token)),o("connected");else if(r.should_continue){const e=r.slow_down?2*a:a;setTimeout(s,e)}else k(!1),C(null),o("error"),c(r.error_description||r.error||"Authorization failed")}catch(r){k(!1),C(null),o("error"),c(r instanceof Error?r.message:"Polling failed")}};setTimeout(s,a)}else{const a=!!(null==(e=window.pywebview)?void 0:e.api);let i;i=a?`http://localhost:${8765}/oauth-callback`:`${window.location.origin}/oauth/callback`;const l=r[n]||{},d=await Dm.initiateOAuth(n,i,l.oauthClientId);if(!d.authorization_url)throw new Error("Failed to get authorization URL");sessionStorage.setItem("oauth_state",d.state),sessionStorage.setItem("oauth_provider",n);if(null!=t.redirect_uri||a){const e=await Dm.startCallbackServer(n,d.state,void 0,a&&!t.redirect_uri?i:void 0);if(!e.success)throw new Error(e.error_description||e.error||"Failed to start callback server");let r=null;if(a)await(async e=>{var t;const n=null==(t=window.pywebview)?void 0:t.api;if(null==n?void 0:n.open_in_browser)try{return await n.open_in_browser(e),!0}catch(r){console.error("Failed to open URL via pywebview API:",r)}const a=document.createElement("a");return a.href=e,a.target="_blank",a.rel="noopener noreferrer",document.body.appendChild(a),a.click(),document.body.removeChild(a),!0})(d.authorization_url);else if(r=window.open(d.authorization_url,"oauth-popup","width=600,height=700,scrollbars=yes"),!r)return void(window.location.href=d.authorization_url);k(!0);const s=2e3,l=Date.now()+3e5,u=async()=>{if(Date.now()>l)return k(!1),o("error"),c("Authorization timed out. Please try again."),void(await Dm.stopCallbackServer(n,d.state));try{const e=await Dm.pollCallbackToken(n,d.state);if(e.success&&e.access_token){if(k(!1),D("oauthToken",e.access_token),e.refresh_token&&D("oauthRefreshToken",e.refresh_token),o("connected"),r)try{r.close()}catch{}}else if(e.pending)setTimeout(u,s);else if(k(!1),o("error"),c(e.error_description||e.error||"Authorization failed"),r)try{r.close()}catch{}}catch(e){if(k(!1),o("error"),c(e instanceof Error?e.message:"Polling failed"),r)try{r.close()}catch{}}};setTimeout(u,s)}else{if(!window.open(d.authorization_url,"oauth-popup","width=600,height=700,scrollbars=yes"))throw new Error("Popup blocked. Please allow popups for this site.");const e=t=>{var n;t.origin===window.location.origin&&"oauth_callback"===(null==(n=t.data)?void 0:n.type)&&(window.removeEventListener("message",e),t.data.error?(o("error"),c(t.data.error_description||t.data.error)):t.data.access_token&&(D("oauthToken",t.data.access_token),t.data.refresh_token&&D("oauthRefreshToken",t.data.refresh_token),o("connected")))};window.addEventListener("message",e),setTimeout(()=>{window.removeEventListener("message",e),"connecting"===s&&(o("disconnected"),c("Authorization timed out or was cancelled. You can paste your access token manually below."))},12e4)}}}catch(t){o("error"),c(t instanceof Error?t.message:"OAuth initiation failed"),C(null)}var e}},[n,R,D,s]),F=Tt.useCallback(()=>{k(!1),C(null),o("disconnected"),N(null)},[]),z=Tt.useCallback(async()=>{u(!0);try{const e=await Dm.detectLocalProviders();if(e.count>0){const t={...r};e.detected.forEach(({provider_id:e,endpoint:n})=>{t[e]={...t[e],endpoint:n}}),i(t),p(!0);e.detected.find(e=>e.provider_id===n)&&o("connected")}}catch(e){console.error("Auto-detect failed:",e)}finally{u(!1)}},[n,r]),B=Tt.useCallback(async()=>{try{for(const[t,n]of Object.entries(r))(n.apiKey||n.endpoint||n.oauthToken)&&await Wm(t,n);const e=g&&y?`${g}:${y}`:null;await async function(e,t){try{await Dm.updateSettings({active_provider:e||void 0,selected_model:t||void 0})}catch(n){throw console.error("Failed to save settings to server:",n),n}}(n,e);qm({activeProvider:n,providers:r}),g&&y&&Qm({provider:g,model:y}),p(!1),t()}catch(e){console.error("Failed to save settings to server:",e);qm({activeProvider:n,providers:r}),g&&y&&Qm({provider:g,model:y}),p(!1),t()}},[n,r,g,y,t]),H=Tt.useCallback(()=>{if(h){if(!window.confirm("You have unsaved changes. Discard them?"))return}t()},[h,t]);return e?Ut.jsxs("div",{style:Hm.overlay,onClick:e=>e.target===e.currentTarget&&H(),role:"dialog","aria-modal":"true","aria-labelledby":"settings-title",children:[Ut.jsxs("div",{style:Hm.panel,children:[Ut.jsxs("header",{style:Hm.header,children:[Ut.jsx("h2",{id:"settings-title",style:Hm.headerTitle,children:"AI Provider Settings"}),Ut.jsx("button",{style:Hm.closeButton,onClick:H,"aria-label":"Close settings",onMouseEnter:e=>{e.currentTarget.style.backgroundColor="var(--bg-light)",e.currentTarget.style.color="var(--text-primary)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent",e.currentTarget.style.color="var(--text-muted)"},children:Ut.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Ut.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),Ut.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),Ut.jsxs("div",{style:Hm.content,children:[Ut.jsxs("section",{style:Hm.section,children:[Ut.jsx("label",{style:Hm.label,htmlFor:"provider-select",children:"Select AI Provider"}),Ut.jsxs("select",{id:"provider-select",style:Hm.select,value:n||"",onChange:e=>L(e.target.value),children:[Ut.jsx("option",{value:"",children:"-- Select a provider --"}),Ut.jsx("optgroup",{label:"Cloud API (API Key)",children:Bm.filter(e=>"api_key"===e.type).map(e=>Ut.jsx("option",{value:e.id,children:e.name},e.id))}),Ut.jsx("optgroup",{label:"Local (No Auth)",children:Bm.filter(e=>"local"===e.type).map(e=>Ut.jsx("option",{value:e.id,children:e.name},e.id))}),Ut.jsx("optgroup",{label:"OAuth",children:Bm.filter(e=>"oauth"===e.type).map(e=>Ut.jsx("option",{value:e.id,children:e.name},e.id))})]})]}),R&&Ut.jsxs("section",{style:Hm.section,children:[Ut.jsx("h3",{style:Hm.sectionTitle,children:"Configuration"}),Ut.jsxs("div",{style:Hm.providerInfo,children:[Ut.jsx("div",{style:Hm.providerName,children:R.name}),Ut.jsx("p",{style:Hm.providerDescription,children:R.description}),"api_key"===R.type&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{style:Hm.inputGroup,children:[Ut.jsx("label",{style:Hm.inputLabel,htmlFor:"api-key",children:"API Key"}),Ut.jsxs("div",{style:{position:"relative"},children:[Ut.jsx("input",{id:"api-key",type:m?"text":"password",style:Hm.input,placeholder:"Enter your API key",value:I.apiKey||"",onChange:e=>D("apiKey",e.target.value),autoComplete:"off"}),Ut.jsx("button",{type:"button",onClick:()=>f(!m),style:{position:"absolute",right:"8px",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",color:"var(--text-muted)",cursor:"pointer",padding:"4px",fontSize:"0.75rem"},children:m?"Hide":"Show"})]})]}),Ut.jsxs("div",{style:Hm.inputGroup,children:[Ut.jsx("label",{style:Hm.inputLabel,htmlFor:"endpoint",children:"Custom Endpoint (optional)"}),Ut.jsx("input",{id:"endpoint",type:"text",style:Hm.input,placeholder:R.defaultEndpoint,value:I.endpoint||"",onChange:e=>D("endpoint",e.target.value)})]}),Ut.jsx("div",{style:Hm.buttonRow,children:Ut.jsx("button",{style:{...Hm.button,...Hm.buttonSecondary,opacity:d?.6:1},onClick:U,disabled:!I.apiKey||d,children:d?"Testing...":"Test Connection"})})]}),"local"===R.type&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{style:Hm.inputGroup,children:[Ut.jsx("label",{style:Hm.inputLabel,htmlFor:"endpoint",children:"Endpoint URL"}),Ut.jsx("input",{id:"endpoint",type:"text",style:Hm.input,placeholder:R.defaultEndpoint,value:I.endpoint||R.defaultEndpoint||"",onChange:e=>D("endpoint",e.target.value)})]}),Ut.jsxs("div",{style:Hm.buttonRow,children:[Ut.jsx("button",{style:{...Hm.button,...Hm.buttonSecondary,opacity:d?.6:1},onClick:U,disabled:d,children:d?"Testing...":"Test Connection"}),Ut.jsx("button",{style:{...Hm.button,...Hm.buttonSecondary,opacity:d?.6:1},onClick:z,disabled:d,children:"Auto-Detect"})]})]}),"oauth"===R.type&&Ut.jsx(Ut.Fragment,{children:I.oauthToken?Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{style:Hm.statusRow,children:[Ut.jsx("span",{style:{...Hm.statusDot,backgroundColor:"var(--success)"}}),Ut.jsx("span",{style:{color:"var(--text-secondary)"},children:"Connected via OAuth"})]}),Ut.jsx("div",{style:Hm.buttonRow,children:Ut.jsx("button",{style:{...Hm.button,...Hm.buttonSecondary,flex:1},onClick:()=>{D("oauthToken",""),D("oauthRefreshToken",""),o("disconnected")},children:"Disconnect"})})]}):M?Ut.jsxs("div",{style:{backgroundColor:"var(--bg-medium)",border:"1px solid var(--border-subtle)",borderRadius:"8px",padding:"1.25rem",textAlign:"center"},children:[Ut.jsx("p",{style:{fontSize:"0.85rem",color:"var(--text-secondary)",marginBottom:"0.75rem"},children:"Enter this code at the link below:"}),Ut.jsx("div",{style:{fontSize:"1.75rem",fontFamily:"monospace",fontWeight:700,color:"var(--accent-primary)",letterSpacing:"0.15em",padding:"0.75rem 1rem",backgroundColor:"var(--bg-dark)",borderRadius:"6px",marginBottom:"1rem",userSelect:"all",cursor:"pointer"},title:"Click to select",onClick:e=>{const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e.currentTarget),null==t||t.removeAllRanges(),null==t||t.addRange(n)},children:M.userCode}),Ut.jsxs("a",{href:M.verificationUri,target:"_blank",rel:"noopener noreferrer",style:{display:"inline-flex",alignItems:"center",gap:"0.5rem",padding:"0.6rem 1rem",backgroundColor:"var(--accent-primary)",color:"white",textDecoration:"none",borderRadius:"6px",fontSize:"0.85rem",fontWeight:500,marginBottom:"1rem"},children:[Ut.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Ut.jsx("path",{d:"M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"}),Ut.jsx("path",{d:"M15 3h6v6"}),Ut.jsx("path",{d:"M10 14L21 3"})]}),"Open ",M.verificationUri.replace("https://","")]}),E&&Ut.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",gap:"0.5rem",color:"var(--text-muted)",fontSize:"0.8rem",marginBottom:"1rem"},children:[Ut.jsx("span",{style:{width:"12px",height:"12px",border:"2px solid var(--text-muted)",borderTopColor:"transparent",borderRadius:"50%",animation:"spin 1s linear infinite"}}),"Waiting for authorization..."]}),T&&Ut.jsx("p",{style:{...Hm.errorText,marginBottom:"0.75rem"},children:T}),Ut.jsx("button",{style:{...Hm.button,...Hm.buttonSecondary,width:"100%"},onClick:F,children:"Cancel"})]}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("button",{style:{...Hm.button,...Hm.buttonOAuth},onClick:O,disabled:E,children:["github_copilot"===n?Ut.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Ut.jsx("path",{d:"M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"})}):"openai_codex"===n?Ut.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:Ut.jsx("path",{d:"M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.896zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.392.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.597 1.5-2.607-1.5z"})}):Ut.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor",children:[Ut.jsx("path",{d:"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"}),Ut.jsx("path",{d:"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"}),Ut.jsx("path",{d:"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"}),Ut.jsx("path",{d:"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"})]}),"Connect with ",R.name]}),Ut.jsx("div",{style:{marginTop:"1rem"},children:Ut.jsxs("div",{style:Hm.inputGroup,children:[Ut.jsx("label",{style:Hm.inputLabel,htmlFor:"oauth-token",children:"Or paste access token manually"}),Ut.jsx("input",{id:"oauth-token",type:"password",style:Hm.input,placeholder:"Access token",value:I.oauthToken||"",onChange:e=>D("oauthToken",e.target.value),autoComplete:"off"})]})})]})}),"disconnected"!==s&&Ut.jsxs("div",{style:Hm.statusRow,children:[Ut.jsx("span",{style:{...Hm.statusDot,backgroundColor:($=s,{disconnected:"var(--text-muted)",connecting:"var(--warning)",connected:"var(--success)",error:"var(--error)"}[$])}}),Ut.jsx("span",{style:{color:"var(--text-secondary)"},children:Km(s)})]}),l&&Ut.jsx("p",{style:Hm.errorText,children:l}),"connected"===s&&Ut.jsx("p",{style:Hm.successText,children:"Connection successful!"}),R.docsUrl&&Ut.jsxs("a",{href:R.docsUrl,target:"_blank",rel:"noopener noreferrer",style:Hm.docsLink,children:[Ut.jsxs("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Ut.jsx("path",{d:"M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"}),Ut.jsx("path",{d:"M15 3h6v6"}),Ut.jsx("path",{d:"M10 14L21 3"})]}),"View documentation"]})]})]}),Ut.jsxs("section",{style:Hm.section,children:[Ut.jsx("h3",{style:Hm.sectionTitle,children:"Default LLM Model"}),Ut.jsx("p",{style:{fontSize:"0.8rem",color:"var(--text-muted)",marginBottom:"1rem",lineHeight:1.4},children:"Select the default provider and model for AI prompt enhancement. This persists across sessions."}),Ut.jsxs("div",{style:Hm.inputGroup,children:[Ut.jsx("label",{style:Hm.inputLabel,htmlFor:"llm-provider-select",children:"LLM Provider"}),Ut.jsxs("select",{id:"llm-provider-select",style:Hm.select,value:g,onChange:e=>{v(e.target.value),x(""),p(!0)},children:[Ut.jsx("option",{value:"",children:"-- Select provider --"}),Bm.map(e=>{const t=r[e.id],n="api_key"===e.type&&(null==t?void 0:t.apiKey)||"oauth"===e.type&&(null==t?void 0:t.oauthToken)||"local"===e.type&&((null==t?void 0:t.endpoint)||e.defaultEndpoint);return Ut.jsxs("option",{value:e.id,disabled:!n,children:[e.name," ",n?"":"(not configured)"]},e.id)})]})]}),g&&Ut.jsxs("div",{style:Hm.inputGroup,children:[Ut.jsxs("label",{style:Hm.inputLabel,htmlFor:"llm-model-select",children:["Model ",w&&Ut.jsx("span",{style:{color:"var(--text-muted)"},children:"(loading...)"})]}),Ut.jsxs("select",{id:"llm-model-select",style:Hm.select,value:y,onChange:e=>{x(e.target.value),p(!0)},disabled:w||0===b.length,children:[Ut.jsx("option",{value:"",children:"-- Select model --"}),b.map(e=>Ut.jsxs("option",{value:e.id,children:[e.name," ",e.recommended?"(recommended)":""]},e.id))]})]})]}),!R&&Ut.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"var(--text-muted)",fontSize:"0.9rem"},children:"Select an AI provider to configure it for prompt enhancement."})]}),Ut.jsxs("footer",{style:Hm.footer,children:[Ut.jsx("button",{style:{...Hm.button,...Hm.buttonSecondary},onClick:H,children:"Cancel"}),Ut.jsx("button",{style:{...Hm.button,...Hm.buttonPrimary,opacity:h?1:.5},onClick:B,disabled:!h,children:"Save Changes"})]})]}),Ut.jsx("style",{children:"\n        @keyframes slideInRight {\n          from {\n            transform: translateX(100%);\n          }\n          to {\n            transform: translateX(0);\n          }\n        }\n        @keyframes spin {\n          from {\n            transform: rotate(0deg);\n          }\n          to {\n            transform: rotate(360deg);\n          }\n        }\n      "})]}):null;var $}const sf={openai:"Enter your OpenAI API key to fetch available models.",anthropic:"Enter your Anthropic API key to fetch available models.",google:"Enter your Google AI API key to fetch available models.",openrouter:"Enter your OpenRouter API key to fetch available models.",replicate:"Enter your Replicate API token to fetch available models.",stability:"Enter your Stability AI API key to fetch available models.",ollama:"Ensure Ollama is running locally to fetch available models.",lmstudio:"Ensure LM Studio is running locally to fetch available models.",github_copilot:"Enter your GitHub PAT with models:read permission to fetch available models.",antigravity:"Complete Google OAuth authentication to fetch available models.",openai_codex:"Complete ChatGPT OAuth authentication to fetch available models."};function of(){const e=Xm(),t=[];for(const n of Bm){const a=e.providers[n.id];("api_key"===n.type&&(null==a?void 0:a.apiKey)||"oauth"===n.type&&(null==a?void 0:a.oauthToken)||"local"===n.type&&((null==a?void 0:a.endpoint)||n.defaultEndpoint))&&t.push({providerId:n.id,providerName:n.name,providerType:n.type,credentials:a||{},models:[],isActive:e.activeProvider===n.id})}return t}const lf={camera_type:["Digital","Film"],camera_manufacturer:["ARRI","RED","Sony","Canon","Blackmagic","Panasonic","DJI","Nikon"],camera_manufacturer_film:["ARRI_Film","Eclair","Panavision","Mitchell","IMAX","Vintage"],camera_body:["Alexa_35","Alexa_Mini","Alexa_Mini_LF","Alexa_LF","Alexa_65","V_Raptor","V_Raptor_X","V_Raptor_XL","Komodo_X","Monstro_8K","Venice_2","FX9","FX6","C700_FF","C500_Mark_II","C300_Mark_III","Ursa_Mini_Pro_12K","Pocket_6K","Varicam_LT","S1H","Z9","Inspire_3","Mavic_3_Cine"],camera_body_film:["Arricam_ST","Arricam_LT","ARRI_535B","ARRI_35BL","ARRI_35_III","Arriflex_35","Arriflex_35BL","Arriflex_435","Eclair_NPR","Panavision_Millennium_XL2","Panavision_Millennium","Panavision_Platinum","Panavision_Gold","Panavision_Panastar","Panavision_Panaflex","Super_Panavision_70","Ultra_Panavision_70","Panavision_XL","Mitchell_BNC","Mitchell_BNCR","Mitchell_BFC_65","IMAX_MSM_9802","IMAX_MKIV","IMAX_GT","Alexa","Alexa_XT","RED_One","UFA_Custom","Pathe_Studio"],film_stock:["Kodak_Vision3_500T_5219","Kodak_Vision3_250D_5207","Kodak_Vision3_200T_5213","Kodak_Vision3_50D_5203","Kodak_Vision2_500T_5218","Kodak_Vision2_200T_5217","Kodak_Vision_500T_5279","Kodak_Vision_320T_5277","Kodak_Double_X_5222","Kodak_Tri_X","Eastman_Double_X","Eastman_Plus_X","Eastman_5247","Eastman_5293","Eastman_5294","Eastman_5250","Eastman_5254","Technicolor","Kodachrome","Fuji_Eterna_500T","Fuji_Eterna_250D","Fuji_Eterna_250T"],film_stock_65mm:["Kodak_65mm_500T","Kodak_65mm_250D","Kodak_65mm_200T"],film_stock_imax:["IMAX_500T","IMAX_250D"],aspect_ratio:["1.33:1","1.37:1","1.66:1","1.78:1","1.85:1","2.20:1","2.35:1","2.39:1","2.76:1","1.43:1","1.90:1"],lens_manufacturer:["ARRI","Zeiss","Cooke","Panavision","Angenieux","Leica","Canon","Sony","Sigma","Fujifilm","Hawk","Hasselblad","Technovision","Bausch_Lomb","Todd_AO","Kowa","Vintage","Warner_Bros","Paramount","Pathe"],lens_family:["ARRI_Signature_Prime","ARRI_Master_Prime","ARRI_Ultra_Prime","ARRI_Prime_65","ARRI_Prime_DNA","Zeiss_Supreme_Prime","Zeiss_Master_Prime","Zeiss_CP3","Zeiss_Super_Speed","Zeiss_Standard_Speed","Zeiss_Ultra_Prime","Zeiss_Planar_f0.7","Cooke_S7","Cooke_S4","Cooke_Panchro","Cooke_Speed_Panchro","Panavision_Primo","Panavision_Primo_70","Panavision_C_Series","Panavision_E_Series","Panavision_Super_Speed","Panavision_Standard","Panavision_Ultra_Speed","Panavision_Auto_Panatar","Ultra_Panavision_Optics","Angenieux_Optimo","Leica_Summicron_C","Leica_Summilux_C","Canon_Sumire","Canon_K35","Sony_CineAlta","Sigma_Cine","Hawk_V_Lite","Hawk_V_Plus","Hasselblad_HC","Hasselblad_V","IMAX_Optics","Bausch_Lomb_Super_Baltar","Bausch_Lomb_Baltar","Todd_AO","Kowa_Anamorphic","Vintage_Spherical","Vintage_Anamorphic"],focal_length_mm:[14,18,21,24,28,32,35,40,50,65,75,85,100,135,150,200],movement_equipment:["Static","Handheld","Steadicam","Gimbal","Dolly","Crane","Jib","Technocrane","Drone"],movement_type:["Static","Pan","Tilt","Track_In","Track_Out","Arc","Crane_Up","Crane_Down","Dolly_Zoom"],movement_timing:["Static","Very_Slow","Slow","Moderate","Fast","Whip_Fast"],time_of_day:["Dawn","Morning","Midday","Afternoon","Golden_Hour","Blue_Hour","Dusk","Night"],lighting_source:["Sun","Moon","Tungsten","HMI","LED","Kino_Flo","Neon","Practical","Mixed"],lighting_style:["High_Key","Low_Key","Soft","Hard","Naturalistic","Expressionistic","Chiaroscuro"],animation_medium:["2D","3D","Hybrid","StopMotion"],style_domain:["Anime","Manga","ThreeD","Illustration"],line_treatment:["Clean","Sketchy","Bold","Thin","Variable","None"],color_application:["Cel","Gradient","Watercolor","Flat","Textured","Monochrome","Monochrome_Ink"],lighting_model:["Flat","Cel_Shaded","Soft_Shaded","Naturalistic_Simulated","Raytraced"],surface_detail:["Smooth","Textured","Detailed","Photoreal","Stylized"],motion_style:["None","Limited","Full","Exaggerated","Snappy","Fluid"],virtual_camera:["Locked","Digital_Pan","Digital_Zoom","Parallax","Free_3D","Simulated_Handheld","Motion_Comic"],shot_size:["EWS","WS","MWS","MS","MCU","CU","BCU","ECU","OTS","POV"],composition:["Rule_of_Thirds","Centered","Symmetrical","Asymmetrical","Negative_Space","Leading_Lines"],mood:["Cheerful","Happy","Hopeful","Whimsical","Adventurous","Romantic","Sensual","Passionate","Intimate","Melancholic","Somber","Reflective","Contemplative","Introspective","Tender","Bittersweet","Nostalgic","Surreal","Dreamlike","Hallucinatory","Transcendent","Meditative","Philosophical","Psychedelic","Gloomy","Menacing","Oppressive","Paranoid","Tense","Anxious","Claustrophobic","Brutal","Traumatic","Unsettling","Ominous","Suspenseful","Mysterious","Haunting","Bleak","Tragic","Lonely","Aggressive","Angry","Rebellious","Kinetic","Urgent","Provocative","Unhinged","Chaotic","Frantic","Intense","Noir","Hardboiled","Fatalistic","Cynical","World_Weary","Gothic","Macabre","Grotesque","Eldritch","Dread","Documentary","Realistic","Observational","Journalistic","Verite","Epic","Serene"],color_tone:["Warm_Saturated","Warm_Desaturated","Cool_Saturated","Cool_Desaturated","Neutral_Saturated","Neutral_Desaturated","Monochrome","Sepia","Teal_Orange"],target_model:["generic","midjourney","flux.1","flux.1_pro","flux_kontext","flux_krea","dall-e_3","gpt-image","ideogram_2.0","leonardo_ai","sdxl","stable_diffusion_3","z-image_turbo","qwen_image","sora","sora_2","veo_2","veo_3","runway_gen-3","runway_gen-4","kling_1.6","pika_2.0","luma_dream_machine","ltx_2","cogvideox","hunyuan","wan_2.1","wan_2.2","minimax_video","qwen_vl"]},cf={generic:"Generic",midjourney:"Midjourney","flux.1":"FLUX.1","flux.1_pro":"FLUX.1 Pro",flux_kontext:"Flux Kontext",flux_krea:"Flux Krea","dall-e_3":"DALL-E 3","gpt-image":"GPT-Image (4o)","ideogram_2.0":"Ideogram 2.0",leonardo_ai:"Leonardo AI",sdxl:"Stable Diffusion XL",stable_diffusion_3:"Stable Diffusion 3","z-image_turbo":"Z-Image Turbo",qwen_image:"Qwen-Image",sora:"Sora",sora_2:"Sora 2",veo_2:"Veo 2",veo_3:"Veo 3","runway_gen-3":"Runway Gen-3","runway_gen-4":"Runway Gen-4","kling_1.6":"Kling 1.6","pika_2.0":"Pika 2.0",luma_dream_machine:"Luma Dream Machine",ltx_2:"LTX-2",cogvideox:"CogVideoX",hunyuan:"Hunyuan Video","wan_2.1":"Wan 2.1","wan_2.2":"Wan 2.2",minimax_video:"Minimax Video",qwen_vl:"Qwen VL"},df=new Set(["midjourney","flux.1","flux.1_pro","flux_kontext","flux_krea","dall-e_3","gpt-image","ideogram_2.0","leonardo_ai","sdxl","stable_diffusion_3","z-image_turbo","qwen_image"]),uf={EWS:"Extreme Wide Shot (EWS)",WS:"Wide Shot (WS)",MWS:"Medium Wide Shot (MWS)",MS:"Medium Shot (MS)",MCU:"Medium Close-Up (MCU)",CU:"Close-Up (CU)",BCU:"Big Close-Up (BCU)",ECU:"Extreme Close-Up (ECU)",OTS:"Over-The-Shoulder (OTS)",POV:"Point-of-View (POV)"},hf={Alexa_35:"ARRI Alexa 35",Alexa_Mini:"ARRI Alexa Mini",Alexa_Mini_LF:"ARRI Alexa Mini LF",Alexa_LF:"ARRI Alexa LF",Alexa_65:"ARRI Alexa 65",V_Raptor:"RED V-Raptor",V_Raptor_X:"RED V-Raptor X",V_Raptor_XL:"RED V-Raptor XL",Komodo_X:"RED Komodo-X",Monstro_8K:"RED Monstro 8K",Venice_2:"Sony Venice 2",FX9:"Sony FX9",FX6:"Sony FX6",C700_FF:"Canon C700 FF",C500_Mark_II:"Canon C500 Mark II",C300_Mark_III:"Canon C300 Mark III",Ursa_Mini_Pro_12K:"Blackmagic URSA Mini Pro 12K",Pocket_6K:"Blackmagic Pocket Cinema 6K",Varicam_LT:"Panasonic VariCam LT",S1H:"Panasonic S1H",Z9:"Nikon Z9",Inspire_3:"DJI Inspire 3",Mavic_3_Cine:"DJI Mavic 3 Cine",Arricam_ST:"ARRI Arricam ST",Arricam_LT:"ARRI Arricam LT",ARRI_535B:"ARRI 535B",ARRI_35BL:"ARRI 35BL",ARRI_35_III:"ARRI 35 III",Panavision_Millennium_XL2:"Panavision Millennium XL2",Panavision_Millennium:"Panavision Millennium",Panavision_Platinum:"Panavision Platinum",Panavision_Gold:"Panavision Gold",Panavision_Panastar:"Panavision Panastar",Panavision_Panaflex:"Panavision Panaflex",Super_Panavision_70:"Super Panavision 70",Ultra_Panavision_70:"Ultra Panavision 70 (MGM)",Mitchell_BNC:"Mitchell BNC",Mitchell_BNCR:"Mitchell BNCR",Mitchell_BFC_65:"Mitchell BFC 65mm",IMAX_MSM_9802:"IMAX MSM 9802",IMAX_MKIV:"IMAX MKIV",IMAX_GT:"IMAX GT"},pf={ARRI_Signature_Prime:"ARRI Signature Prime",ARRI_Master_Prime:"ARRI/Zeiss Master Prime",ARRI_Ultra_Prime:"ARRI/Zeiss Ultra Prime",ARRI_Prime_65:"ARRI Prime 65 (65mm Format)",ARRI_Prime_DNA:"ARRI Prime DNA LF",Zeiss_Supreme_Prime:"Zeiss Supreme Prime",Zeiss_Master_Prime:"Zeiss Master Prime",Zeiss_CP3:"Zeiss CP.3",Cooke_S7:"Cooke S7/i Full Frame",Cooke_S4:"Cooke S4/i",Cooke_Panchro:"Cooke Panchro/i Classic",Cooke_Speed_Panchro:"Cooke Speed Panchro (Vintage)",Panavision_Primo:"Panavision Primo",Panavision_Primo_70:"Panavision Primo 70",Panavision_C_Series:"Panavision C-Series Anamorphic",Panavision_E_Series:"Panavision E-Series Anamorphic",Panavision_Super_Speed:"Panavision Super Speed (Z-Series)",Panavision_Standard:"Panavision Standard (Pre-1970)",Panavision_Ultra_Speed:"Panavision Ultra Speed",Panavision_Auto_Panatar:"Panavision Auto Panatar",Angenieux_Optimo:"Angnieux Optimo",Leica_Summicron_C:"Leica Summicron-C",Leica_Summilux_C:"Leica Summilux-C",Canon_Sumire:"Canon Sumire Prime",Sony_CineAlta:"Sony CineAlta",Sigma_Cine:"Sigma Cine",Bausch_Lomb_Super_Baltar:"Bausch & Lomb Super Baltar",Bausch_Lomb_Baltar:"Bausch & Lomb Baltar",Zeiss_Planar_f07:"Zeiss Planar f/0.7 (Kubrick)",Zeiss_Super_Speed:"Zeiss Super Speed",Zeiss_Standard_Speed:"Zeiss Standard Speed (Mk II/III)",Canon_K35:"Canon K35",Kowa_Anamorphic:"Kowa Anamorphic (Cinerama)",Todd_AO:"Todd-AO 70mm Optics",Ultra_Panavision_Optics:"Ultra Panavision 70 Optics",Vintage_Spherical:"Vintage Spherical (Generic)",Vintage_Anamorphic:"Vintage Anamorphic (Generic)",Hawk_V_Lite:"Hawk V-Lite Anamorphic",Hawk_V_Plus:"Hawk V-Plus Anamorphic",Hasselblad_HC:"Hasselblad HC (Medium Format)",Hasselblad_V:"Hasselblad V-System (Carl Zeiss)",IMAX_Optics:"IMAX Custom Optics"},mf={Alexa_35:"Medium",Alexa_Mini:"Light",Alexa_Mini_LF:"Medium",Alexa_LF:"Medium",Alexa_65:"Heavy",V_Raptor:"Light",V_Raptor_X:"Light",V_Raptor_XL:"Medium",Komodo_X:"Light",Monstro_8K:"Medium",Venice_2:"Heavy",FX9:"Heavy",FX6:"Light",C700_FF:"Heavy",C500_Mark_II:"Medium",C300_Mark_III:"Medium",Ursa_Mini_Pro_12K:"Heavy",Pocket_6K:"Light",Varicam_LT:"Medium",S1H:"Light",Z9:"Light",Inspire_3:"Light",Mavic_3_Cine:"Light",Arricam_ST:"Heavy",Arricam_LT:"Medium",ARRI_535B:"Heavy",ARRI_35BL:"Heavy",ARRI_35_III:"Medium",Panavision_Millennium_XL2:"Heavy",Panavision_Millennium:"Heavy",Panavision_Platinum:"Heavy",Panavision_Gold:"Heavy",Panavision_Panastar:"Heavy",Panavision_Panaflex:"Heavy",Super_Panavision_70:"Heavy",Ultra_Panavision_70:"Heavy",Mitchell_BNC:"Heavy",Mitchell_BNCR:"Heavy",Mitchell_BFC_65:"Heavy",IMAX_MSM_9802:"Heavy",IMAX_MKIV:"Heavy",IMAX_GT:"Heavy"},ff={ARRI:["Alexa_35","Alexa_Mini","Alexa_Mini_LF","Alexa_LF","Alexa_65"],RED:["V_Raptor","V_Raptor_X","V_Raptor_XL","Komodo_X","Monstro_8K"],Sony:["Venice_2","FX9","FX6"],Canon:["C700_FF","C500_Mark_II","C300_Mark_III"],Blackmagic:["Ursa_Mini_Pro_12K","Pocket_6K"],Panasonic:["Varicam_LT","S1H"],Nikon:["Z9"],DJI:["Inspire_3","Mavic_3_Cine"],ARRI_Film:["Arricam_ST","Arricam_LT","ARRI_535B","ARRI_35BL","ARRI_35_III","Arriflex_35","Arriflex_35BL","Arriflex_435"],Eclair:["Eclair_NPR"],Panavision:["Panavision_Millennium_XL2","Panavision_Millennium","Panavision_Platinum","Panavision_Gold","Panavision_Panastar","Panavision_Panaflex","Super_Panavision_70","Ultra_Panavision_70","Panavision_XL"],Mitchell:["Mitchell_BNC","Mitchell_BNCR","Mitchell_BFC_65"],IMAX:["IMAX_MSM_9802","IMAX_MKIV","IMAX_GT"],Vintage:["UFA_Custom","Pathe_Studio","Alexa","Alexa_XT","RED_One"]},gf=["Handheld","Gimbal","Drone"],vf={Static:["Static"],Handheld:["Static","Pan","Tilt"],Steadicam:["Static","Pan","Tilt","Track_In","Track_Out","Arc"],Gimbal:["Static","Pan","Tilt","Track_In","Track_Out","Arc"],Dolly:["Static","Track_In","Track_Out","Dolly_Zoom"],Slider:["Static","Track_In","Track_Out","Dolly_Zoom"],Crane:["Static","Crane_Up","Crane_Down","Arc"],Jib:["Static","Crane_Up","Crane_Down","Arc"],Technocrane:["Static","Pan","Tilt","Track_In","Track_Out","Crane_Up","Crane_Down","Arc"],Drone:["Static","Track_In","Track_Out","Crane_Up","Crane_Down","Arc"]},yf={Dolly_Zoom:["Dolly","Slider"]},xf={Dolly_Zoom:["Static","Very_Slow","Slow","Moderate"]},bf={Night:["Moon","Tungsten","HMI","LED","Kino_Flo","Neon","Practical","Mixed"],Blue_Hour:["Moon","Tungsten","HMI","LED","Kino_Flo","Neon","Practical","Mixed"],Midday:["Sun","HMI","LED","Kino_Flo","Practical","Mixed"]},_f={HMI:1972,Kino_Flo:1987,LED:2002},wf={Midday:["High_Key","Soft","Hard","Naturalistic"]},Sf={Cheerful:{disallowed:["Low_Key"],preferred:["High_Key","Soft"]},Hopeful:{disallowed:["Low_Key"],preferred:["High_Key","Soft","Naturalistic"]},Gloomy:{disallowed:[],preferred:["Low_Key","Hard"]},Menacing:{disallowed:[],preferred:["Low_Key","Hard","Chiaroscuro"]},Noir:{disallowed:[],preferred:["Low_Key","Chiaroscuro","Hard"]},Paranoid:{disallowed:[],preferred:["Low_Key","Hard"]}},Mf={Manga:{disallowed_colors:["Cel","Gradient","Watercolor","Flat","Textured"],disallowed_cameras:["Digital_Pan","Digital_Zoom","Parallax","Free_3D","Simulated_Handheld"],disallowed_motion:["Limited","Full","Exaggerated","Snappy","Fluid"],required_lighting:["Flat"]},Illustration:{disallowed_motion:["Limited","Full","Exaggerated","Snappy","Fluid"],disallowed_cameras:["Digital_Pan","Digital_Zoom","Parallax","Free_3D","Simulated_Handheld"]},Anime:{disallowed_cameras:["Simulated_Handheld"],disallowed_lighting:["Raytraced"]},ThreeD:{disallowed_lighting:["Flat"]}},Cf={"2D":["Free_3D"]},Ef={None:["Digital_Pan","Digital_Zoom","Parallax","Free_3D","Simulated_Handheld"]};function kf(e,t){return e<=24&&["CU","BCU","ECU"].includes(t)?`Wide lens (${e}mm) on ${t} causes facial distortion`:e<=18&&["MCU"].includes(t)?`Very wide lens (${e}mm) on ${t} may cause noticeable distortion`:e>=135&&["EWS","WS"].includes(t)?`Long lens (${e}mm) on ${t} creates extreme compression`:e>=100&&"EWS"===t?`Telephoto (${e}mm) on EWS is unusual - extreme distance required`:"ECU"===t&&e<85?"ECU typically uses 85-135mm lenses for flattering perspective":"EWS"===t&&e>35?"EWS typically uses 14-24mm for maximum environmental context":null}const Tf={Alexa_35:"S35",Alexa_Mini:"S35",Alexa_Mini_LF:"LF",Alexa_LF:"LF",Alexa_65:"65mm",V_Raptor:"FF",V_Raptor_X:"FF",V_Raptor_XL:"FF",Komodo_X:"S35",Monstro_8K:"FF",Venice_2:"FF",FX9:"FF",FX6:"FF",C700_FF:"FF",C500_Mark_II:"FF",C300_Mark_III:"S35",Ursa_Mini_Pro_12K:"S35",Pocket_6K:"S35",Varicam_LT:"S35",S1H:"FF",Z9:"FF",Inspire_3:"FF",Mavic_3_Cine:"M43",Arricam_ST:"S35",Arricam_LT:"S35",ARRI_535B:"S35",ARRI_35BL:"S35",ARRI_35_III:"S35",Panavision_Millennium_XL2:"S35",Panavision_Millennium:"S35",Panavision_Platinum:"S35",Panavision_Gold:"S35",Panavision_Panastar:"S35",Panavision_Panaflex:"S35",Super_Panavision_70:"65mm",Ultra_Panavision_70:"65mm",Mitchell_BNC:"S35",Mitchell_BNCR:"S35",Mitchell_BFC_65:"65mm",IMAX_MSM_9802:"IMAX_15perf",IMAX_MKIV:"IMAX_15perf",IMAX_GT:"IMAX_15perf"},Nf={Alexa_35:"LPL",Alexa_Mini:"PL",Alexa_Mini_LF:"LPL",Alexa_LF:"LPL",Alexa_65:"XPL",V_Raptor:"RF",V_Raptor_X:"RF",V_Raptor_XL:"RF",Komodo_X:"RF",Monstro_8K:"PL",Venice_2:"PL",FX9:"E",FX6:"E",C700_FF:"PL",C500_Mark_II:"EF",C300_Mark_III:"EF",Ursa_Mini_Pro_12K:"PL",Pocket_6K:"EF",Varicam_LT:"PL",S1H:"L",Z9:"Z",Inspire_3:"DL",Mavic_3_Cine:"Fixed",Arricam_ST:"PL",Arricam_LT:"PL",ARRI_535B:"PL",ARRI_35BL:"PL",ARRI_35_III:"PL",Panavision_Millennium_XL2:"Panavision",Panavision_Millennium:"Panavision",Panavision_Platinum:"Panavision",Panavision_Gold:"Panavision",Panavision_Panastar:"Panavision",Panavision_Panaflex:"Panavision",Super_Panavision_70:"Panavision_65",Ultra_Panavision_70:"Panavision_65",Mitchell_BNC:"Mitchell_Standard",Mitchell_BNCR:"Mitchell_Standard",Mitchell_BFC_65:"Mitchell_Standard",IMAX_MSM_9802:"IMAX_Standard",IMAX_MKIV:"IMAX_Standard",IMAX_GT:"IMAX_Standard"},Pf={ARRI_Ultra_Prime:["S35"],ARRI_Master_Prime:["S35"],ARRI_Signature_Prime:["S35","FF","LF"],ARRI_Prime_65:["LF","65mm"],ARRI_Prime_DNA:["LF","65mm"],Zeiss_Master_Prime:["S35"],Zeiss_CP3:["S35","FF"],Zeiss_Supreme_Prime:["S35","FF","LF"],Cooke_S4:["S35"],Cooke_Panchro:["S35"],Cooke_Speed_Panchro:["S35"],Cooke_S7:["S35","FF","LF"],Panavision_Primo:["S35"],Panavision_C_Series:["S35"],Panavision_E_Series:["S35"],Panavision_Super_Speed:["S35"],Panavision_Standard:["S35"],Panavision_Ultra_Speed:["S35"],Panavision_Auto_Panatar:["S35"],Panavision_Primo_70:["S35","FF","LF","65mm"],Ultra_Panavision_Optics:["65mm"],Angenieux_Optimo:["S35","FF"],Leica_Summicron_C:["S35","FF"],Leica_Summilux_C:["S35","FF"],Canon_Sumire:["S35","FF"],Canon_K35:["S35"],Sony_CineAlta:["S35","FF"],Sigma_Cine:["S35","FF"],Bausch_Lomb_Super_Baltar:["S35"],Bausch_Lomb_Baltar:["S35"],Zeiss_Planar_f07:["S35"],Zeiss_Super_Speed:["S35"],Zeiss_Standard_Speed:["S35"],Kowa_Anamorphic:["S35"],Todd_AO:["65mm","IMAX_15perf"],Hasselblad_HC:["FF","LF","65mm"],Hasselblad_V:["FF","LF","65mm","IMAX_15perf"],IMAX_Optics:["IMAX_15perf","65mm","LF"]},jf={ARRI_Ultra_Prime:["PL","LPL"],ARRI_Master_Prime:["PL","LPL"],ARRI_Signature_Prime:["LPL","PL"],ARRI_Prime_65:["XPL"],ARRI_Prime_DNA:["LPL"],Zeiss_Master_Prime:["PL","LPL"],Zeiss_CP3:["PL","LPL","EF"],Zeiss_Supreme_Prime:["PL","LPL"],Cooke_S4:["PL","LPL"],Cooke_Panchro:["PL","LPL"],Cooke_S7:["PL","LPL"],Cooke_Speed_Panchro:["PL"],Angenieux_Optimo:["PL","LPL"],Leica_Summicron_C:["PL","LPL"],Leica_Summilux_C:["PL","LPL"],Canon_Sumire:["PL","EF"],Canon_K35:["PL"],Sony_CineAlta:["PL","E"],Sigma_Cine:["PL","EF","E"],Panavision_Primo:["Panavision"],Panavision_Primo_70:["Panavision","Panavision_65","XPL"],Panavision_C_Series:["Panavision"],Panavision_E_Series:["Panavision"],Panavision_Super_Speed:["Panavision"],Panavision_Standard:["Panavision"],Panavision_Ultra_Speed:["Panavision"],Panavision_Auto_Panatar:["Panavision"],Ultra_Panavision_Optics:["Panavision_65"],Bausch_Lomb_Super_Baltar:["PL","Mitchell_Standard"],Bausch_Lomb_Baltar:["PL","Mitchell_Standard"],Zeiss_Planar_f07:["PL"],Zeiss_Super_Speed:["PL"],Zeiss_Standard_Speed:["PL"],Kowa_Anamorphic:["PL","Mitchell_Standard"],Todd_AO:["Mitchell_Standard","IMAX_Standard"]},Af={ARRI:["ARRI_Signature_Prime","ARRI_Master_Prime","ARRI_Ultra_Prime","ARRI_Prime_65","ARRI_Prime_DNA"],Zeiss:["Zeiss_Supreme_Prime","Zeiss_Master_Prime","Zeiss_CP3","Zeiss_Super_Speed","Zeiss_Standard_Speed","Zeiss_Ultra_Prime","Zeiss_Planar_f0.7"],Cooke:["Cooke_S7","Cooke_S4","Cooke_Panchro","Cooke_Speed_Panchro"],Panavision:["Panavision_Primo","Panavision_Primo_70","Panavision_C_Series","Panavision_E_Series","Panavision_Super_Speed","Panavision_Standard","Panavision_Ultra_Speed","Panavision_Auto_Panatar","Ultra_Panavision_Optics"],Angenieux:["Angenieux_Optimo"],Leica:["Leica_Summicron_C","Leica_Summilux_C"],Canon:["Canon_Sumire","Canon_K35"],Sony:["Sony_CineAlta"],Sigma:["Sigma_Cine"],Fujifilm:[],Hawk:["Hawk_V_Lite","Hawk_V_Plus"],Technovision:["Vintage_Anamorphic"],Bausch_Lomb:["Bausch_Lomb_Super_Baltar","Bausch_Lomb_Baltar"],Todd_AO:["Todd_AO"],Kowa:["Kowa_Anamorphic"],Vintage:["Vintage_Spherical","Vintage_Anamorphic"],Hasselblad:["Hasselblad_HC","Hasselblad_V","IMAX_Optics"],IMAX:["IMAX_Optics","Hasselblad_V"],Warner_Bros:["Vintage_Spherical"],Paramount:["Vintage_Spherical"],Pathe:["Vintage_Spherical"]},Rf={ARRI_Signature_Prime:[12,15,18,21,25,29,35,40,47,58,75,95,125,150],ARRI_Master_Prime:[12,14,16,18,21,25,27,32,35,40,50,65,75,100,135],ARRI_Ultra_Prime:[8,10,12,14,16,20,24,28,32,40,50,65,85,100,135],ARRI_Prime_65:[24,28,35,50,80,100,150],ARRI_Prime_DNA:[18,21,25,32,35,50,65,80,100,135],Zeiss_Supreme_Prime:[15,18,21,25,29,35,50,65,85,100,135],Zeiss_Master_Prime:[12,14,16,18,21,25,27,32,35,40,50,65,75,100,135],Zeiss_CP3:[15,18,21,25,28,35,50,85,100,135],Cooke_S7:[16,18,21,25,32,40,50,65,75,100,135],Cooke_S4:[12,14,16,18,21,25,27,32,35,40,50,65,75,100,135],Cooke_Panchro:[18,21,25,32,40,50,75,100],Panavision_Primo:[14,17,21,27,35,40,50,75,100],Panavision_Primo_70:[27,35,40,50,65,80,100,125,150,200],Panavision_C_Series:[17,21,27,35,40,50,75,100],Angenieux_Optimo:[15,24,28,35,40,50,70,100,135,200,290],Leica_Summicron_C:[15,18,21,25,29,35,40,50,75,100,135],Leica_Summilux_C:[16,18,21,25,29,35,40,50,65,75,100],Canon_Sumire:[14,20,24,35,50,85,135],Sony_CineAlta:[20,24,35,50,85,100,135],Sigma_Cine:[14,20,24,28,35,40,50,85,105,135],Hasselblad_HC:[24,28,35,50,80,100,120,150,210],Hasselblad_V:[40,50,60,80,100,120,150,180,250],IMAX_Optics:[35,40,50,80,100,110,150]},If={Alexa_65:{required_families:["ARRI_Prime_65","ARRI_Prime_DNA","Panavision_Primo_70","Hasselblad_V"],reason:"65mm sensor requires specialized 65mm format lenses"}};function Lf(e){if(e.includes("Panavision")||e.startsWith("Super_Panavision")||e.startsWith("Ultra_Panavision"))return"Panavision cameras require Panavision lenses (closed ecosystem)";const t=If[e];if(null==t?void 0:t.reason)return t.reason;const n=Tf[e];return"LF"===n?"Large Format camera - S35-only lenses excluded":"65mm"===n?"65mm sensor - requires specialized 65mm format lenses":null}const Df={ARRI:"German precision. Industry-leading color science, exceptional highlight handling. Alexa is the gold standard.",RED:"American high-resolution pioneer. Compact bodies, 8K capable. Popular for indie to blockbuster.",Sony:"Japanese innovation. Dual ISO, excellent low-light. Venice for cinema, FX for broadcast.",Canon:"Japanese reliability. Cinema EOS line bridges photo/video. Strong autofocus, organic color.",Blackmagic:"Australian value leader. Affordable cinema cameras with DaVinci color science.",Panasonic:"Japanese innovation. VariCam for broadcast, S-series for hybrid. Dual native ISO.",Nikon:"Japanese stills heritage. Z-mount system pushing into cinema with Z9.",DJI:"Chinese aerial pioneers. Integrated camera/gimbal drones. Aerial cinematography standard.",ARRI_Film:"German film cameras (1917-present). Arricam series for modern film, 35 III/BL for classics. Industry workhorse.",Panavision:"Hollywood exclusive. Closed ecosystem (cameras + lenses). Rental-only. Millennium XL2 is modern standard.",Mitchell:"American classic (1920s-1970s). BNC was the Hollywood standard. Quiet for sync-sound. Now vintage/specialty.",IMAX:"Canadian large-format pioneer. 65mm/70mm film for immersive exhibition. 15-perf for ultimate resolution."},Uf={ARRI:"German engineering. Clean, modern, technically precise. Signature Prime and Master Prime series.",Zeiss:"Legendary optics. Clinical sharpness, minimal distortion. Supreme and Master series.",Cooke:'British warmth. The "Cooke Look"flattering skin tones, organic feel. S4 and S7 series.',Panavision:"Hollywood exclusive. Rental-only ecosystem. Primo series, anamorphic heritage.",Angenieux:"French zoom masters. Cinema-quality zooms that rival primes. Optimo series.",Leica:"German micro-contrast. Legendary still lens rendering brought to cinema. Summilux/Summicron.",Canon:"Japanese reliability. Warm, organic Sumire series for digital cinema.",Sony:"Matched to Venice cameras. CineAlta series optimized for Sony color science.",Sigma:"Japanese value. Sharp, modern cine lenses at accessible price points.",Fujifilm:"Japanese broadcast heritage. Fujinon series for cinema and broadcast.",Bausch_Lomb:"American classic. Super Baltar lenses defined Golden Age Hollywood. Warm, glowing highlights.",Todd_AO:"American large-format pioneer. 70mm optics for epic roadshow presentations.",Kowa:"Japanese anamorphic. Cinerama-era optics. Distinctive flares, vintage character."},Of={Alexa_35:"ARRI flagship S35 camera. 4.6K sensor with exceptional highlight handling and organic color science. Industry standard for narrative filmmaking.",Alexa_Mini:"Compact S35 workhorse. Same sensor as larger ALEXAs but in gimbal-friendly form factor. Versatile for documentary to blockbuster.",Alexa_Mini_LF:"Large format version of Mini. Shallower depth of field and wider field of view. Popular for cinematic drama.",Alexa_LF:"ARRI Large Format camera. Same sensor as Mini LF in traditional body. Exceptional image quality.",Alexa_65:"Ultra-large 65mm format. Requires specialized optics. Used for epic visuals (Dune, Joker). Heavyno handheld.",V_Raptor:"RED's 8K VistaVision camera. Compact, high resolution. Popular for episodic TV and indie features.",V_Raptor_X:"RED V-Raptor [X]. Enhanced sensor with improved low-light performance.",V_Raptor_XL:"Larger V-Raptor with internal ND filters and XLR audio. Studio-friendly configuration.",Komodo_X:"RED compact body. S35 6K sensor in ultra-small package. Run-and-gun and gimbal favorite.",Monstro_8K:"RED 8K sensor. Large format with exceptional resolution. High-end production standard.",Venice_2:"Sony dual ISO marvel. 8.6K full-frame. Exceptional low-light performance. Heavystudio/dolly use.",FX9:"Sony full-frame camcorder. Built-in ND, XLR. Documentary and broadcast standard.",FX6:"Compact full-frame Sony. Run-and-gun form factor with Venice color science.",Arricam_ST:"ARRI Studio model. Quiet for sync-sound. Standard size for studio work. Modern film workhorse.",Arricam_LT:"ARRI Lite model. Lighter for handheld/Steadicam. Same gate as ST, smaller body.",ARRI_535B:"ARRI 535 evolution. 4-perf with crystal sync. Last generation before digital transition.",ARRI_35BL:"ARRI Blimped. Ultra-quiet for sync-sound. 1970s-2000s television standard.",ARRI_35_III:"ARRI lightweight. Popular for documentary, news, handheld narrative. Compact and reliable.",Panavision_Millennium_XL2:"Modern Panavision standard. Ultra-quiet, anamorphic-ready. Most rented film camera 2000-2015.",Panavision_Millennium:"Original Millennium. First truly quiet Panavision. Late 1990s flagship.",Panavision_Platinum:"Panavision 1980s flagship. Used on countless blockbusters. Heavy but reliable.",Panavision_Gold:"Panavision 1970s standard. The Empire Strikes Back, Blade Runner era.",Panavision_Panastar:"High-speed Panavision. Built for slow-motion. Action sequences, sports.",Panavision_Panaflex:"Original Panaflex. First self-blimped Panavision. Revolutionary quiet operation.",Super_Panavision_70:"Spherical 65mm. Lawrence of Arabia, 2001. Epic scale without anamorphic squeeze.",Ultra_Panavision_70:"Anamorphic 65mm. Ben-Hur, The Hateful Eight. Widest theatrical ratio (2.76:1).",Mitchell_BNC:"Mitchell Blimped Newsreel Camera. Hollywood studio standard 1930s-1960s. Whisper-quiet.",Mitchell_BNCR:"Mitchell Reflex. Added through-the-lens viewing. Easier operator workflow.",Mitchell_BFC_65:"Mitchell 65mm. Used for Todd-AO, early widescreen epics. Oklahoma!, Around the World.",IMAX_MSM_9802:"IMAX standard camera. 15-perf 65mm. Used for documentaries, nature films.",IMAX_MKIV:"IMAX Mark IV. Lighter than 9802. Enabled more dynamic IMAX shooting.",IMAX_GT:"IMAX Grand Theatre. Largest format camera. IMAX Dome/OMNIMAX presentations."},Ff={Static:"Tripod-mounted. Rock-solid stability for dialogue, interviews, architectural shots. No operator fatigue.",Handheld:"Shoulder-mounted or body-braced. Organic energy, documentary feel. Limited by camera weightheavy cameras cause fatigue.",Steadicam:"Vest-mounted stabilizer. Smooth floating movement. Classic long takes (Goodfellas hallway). Requires trained operator.",Gimbal:"Electronic 3-axis stabilizer. Modern alternative to Steadicam. Weight-limited, typically under 3kg.",Dolly:"Wheeled platform on track. Precise, repeatable moves. Essential for Dolly Zoom (Vertigo effect).",Crane:"Elevated arm for sweeping vertical moves. Dramatic reveals, establishing shots. Requires setup time.",Jib:"Smaller crane arm. Crane-style moves in tighter spaces. More portable than full crane.",Technocrane:"Telescoping crane with remote head. Complex compound moves. High-end commercial/film standard.",Drone:"Aerial platform. Sweeping establishing shots, impossible angles. Weight-limited, outdoor-preferred."},zf={Static:"No camera movement. Lets blocking and performance drive energy. Theatre-derived staging.",Pan:"Horizontal rotation on tripod head. Follows action left-right. Reveals space laterally.",Tilt:"Vertical rotation on tripod head. Reveals height, follows vertical action.",Track_In:"Camera moves toward subject. Increases intimacy, reveals detail. Push-in intensifies moment.",Track_Out:"Camera moves away from subject. Reveals context, creates distance. Pull-out diminishes subject.",Arc:"Camera orbits around subject. Adds dimensionality, shows all sides. Dynamic without cutting.",Crane_Up:"Camera rises vertically. Triumphant, revelatory. Often ends establishing shots.",Crane_Down:"Camera descends. Arrival, focus narrowing. Often begins scenes with overview.",Dolly_Zoom:"Vertigo effect: dolly + opposing zoom. Disorientation, realization. Requires Dolly or Slider equipment."},Bf={Static:"No movementcamera holds position. Contemplative, observational.",Very_Slow:"Extremely deliberate pace. Meditative, hypnotic. Art cinema, contemplative sequences.",Slow:"Deliberate, meditative pace. Builds atmosphere, prolongs tension. Tarkovsky, slow cinema.",Moderate:"Natural conversational pace. Unobtrusive, standard coverage.",Fast:"Energetic, urgent movement. Action sequences, chase scenes. Can be disorienting if excessive.",Whip_Fast:"Ultra-rapid whip pans/tilts. Comedic timing, sudden reveals. Wes Anderson, Edgar Wright."},Hf={Dawn:"Pre-sunrise. Cool blue ambient transitioning to warm. Quiet, hopeful, new beginnings.",Morning:"Low warm sun angle. Long shadows. Fresh energy. Soft backlight opportunities.",Midday:"Harsh overhead sun. High contrast, strong shadows. Challenging for faces. Use fill or find shade.",Afternoon:"Sun lowering. Warmer tones beginning. Most flexible natural light window.",Golden_Hour:"Magic hour near sunset. Warm, soft, directional. Cinematographer's favorite. Brief window.",Blue_Hour:"Post-sunset twilight. Cool ambient with artificial lights gaining prominence. Magical quality.",Dusk:"Transition to night. Mixed natural/artificial. Nostalgic, end-of-day feeling.",Night:"After dark. Requires artificial sources. High drama potential. No sun available."},$f={Sun:"Natural daylight. Hard source, warm. Unavailable at night. Golden hour = soft; midday = harsh.",Moon:"Night ambience. Typically simulated with HMI + diffusion. Cool blue cast. Low level.",Tungsten:"Classic incandescent. Warm 3200K. Traditional film lighting. Softens with diffusion.",HMI:"Daylight-balanced arcs. High output, can simulate sun through windows. Available since 1972.",LED:"Modern solid-state. Variable color temperature, low power. Available widespread since ~2002.",Kino_Flo:"Fluorescent tubes designed for film. Soft, even. Available since 1987. Portrait favorite.",Neon:"Practical neon tubes. Colored accent light. Cyberpunk, noir aesthetic.",Practical:"In-frame light sourceslamps, signs, screens. Motivated light. Adds realism.",Mixed:"Multiple source types. Complex setups. Color temperature mismatches can be stylistic."},Vf={High_Key:"Bright, even lighting. Minimal shadows. Comedies, sitcoms, commercials. Upbeat mood.",Low_Key:"High contrast, deep shadows. Noir, thriller. Cannot achieve at midday without blackout.",Soft:"Diffused sources, gentle gradients. Flattering for faces. Romantic, dreamy.",Hard:"Direct sources, sharp shadows. Dramatic, edgy. Can be unflattering.",Naturalistic:"Motivated by scene logic. Windows provide light because windows exist. Subtle intervention.",Expressionistic:"Stylized beyond realism. Colored gels, unusual angles. Horror, fantasy, music video.",Chiaroscuro:"Renaissance painting style. Strong directional light, deep black shadows. Caravaggio influence."},Wf={EWS:"Extreme Wide Shot. Vast landscapes, establishing scale. Subject tiny in frame. Best with 14-24mm.",WS:"Wide Shot. Full environment context. Subject head-to-toe with surroundings.",MWS:"Medium Wide Shot. Subject with significant environment. Waist-up with room around.",MS:"Medium Shot. Waist-up framing. Dialogue standard. Balances face and gesture.",MCU:"Medium Close-Up. Chest-up framing. Emotional emphasis while showing some body language.",CU:"Close-Up. Face fills frame. Maximum emotional impact. Typically 50-100mm lens.",BCU:"Big Close-Up. Eyes to chin. Intense, intimate. Reveals micro-expressions.",ECU:"Extreme Close-Up. Single feature (eye, mouth, hand). Abstract, hyper-detailed. Best with 85-135mm.",OTS:"Over-The-Shoulder. Conversation framing with foreground shoulder. Establishes spatial relationship.",POV:"Point-of-View. Through character's eyes. Subjective experience. Often handheld."},Gf={Rule_of_Thirds:"Subject on grid intersections. Dynamic, natural-feeling. Most common technique.",Centered:"Subject dead center. Formal, confrontational. Wes Anderson, Stanley Kubrick.",Symmetrical:"Mirror-balanced frame. Order, stability, unease (context-dependent).",Asymmetrical:"Intentionally unbalanced. Tension, instability. Weight on one side.",Negative_Space:"Large empty areas. Isolation, loneliness, anticipation. Subject small in frame.",Leading_Lines:"Environmental lines draw eye to subject. Roads, hallways, architecture."},Xf={Cheerful:"Light, happy, optimistic. Requires bright lightingincompatible with Low-Key.",Happy:"Joyful, upbeat energy. High-key lighting, warm colors. Feel-good moments.",Hopeful:"Aspirational, forward-looking. Often warm tones, rising camera moves.",Whimsical:"Playful, quirky. Unusual angles, bright colors. Wes Anderson territory.",Adventurous:"Excitement and discovery. Dynamic movement, expansive framing.",Romantic:"Intimate, warm. Soft lighting, close framing. Golden hues.",Sensual:"Physical intimacy emphasized. Close framing, shallow focus, warm tones.",Passionate:"Intense emotional/physical connection. Dynamic, warm, urgent.",Intimate:"Personal, close. Quiet moments, private spaces.",Melancholic:"Sad but beautiful. Muted colors, soft light. Autumnal feel.",Somber:"Grave, serious tone. Muted palette, measured pacing.",Reflective:"Looking inward or back. Often static, natural light.",Contemplative:"Thoughtful, introspective. Slow pacing, quiet moments.",Introspective:"Internal focus. Close-ups, negative space, silence.",Tender:"Gentle emotional vulnerability. Soft light, close framing.",Bittersweet:"Joy tinged with sadness. Warm but muted. Nostalgic undertones.",Nostalgic:"Warm recollection. Often sepia or warm desaturated. Period feel.",Serene:"Peaceful, calm. Static or slow movement. Balanced composition.",Surreal:"Dream-like, illogical. Unusual angles, unexpected lighting.",Dreamlike:"Soft, ethereal. Diffusion, bloom. Often overexposed edges.",Hallucinatory:"Distorted reality. Warped visuals, unstable framing, vivid colors.",Transcendent:"Beyond ordinary experience. Ethereal light, expansive space.",Meditative:"Deeply calm, trance-like. Minimal movement, extended takes.",Philosophical:"Contemplating existence. Often static, faces in thought.",Psychedelic:"Altered consciousness. Saturated colors, distortion, disorientation.",Gloomy:"Persistent darkness. Low-key required. Minimal color.",Menacing:"Active threat present. Low angles, shadows encroaching.",Oppressive:"Suffocating pressure. Tight framing, heavy shadows, claustrophobic.",Paranoid:"Threatened from all sides. Wide angles, looking around.",Tense:"Building pressure. Tight framing, restricted movement.",Anxious:"Uncomfortable uncertainty. Handheld, tight, distorted.",Claustrophobic:"Trapped, no escape. Tight spaces, close walls, shallow depth.",Brutal:"Harsh, unforgiving violence. Hard light, stark framing.",Traumatic:"Psychological damage. Fragmented, unstable, overwhelming.",Unsettling:"Something wrong but unclear. Slightly off framing, odd timing.",Ominous:"Impending doom. Low angles, heavy shadows.",Suspenseful:"Anticipating threat. Slow reveals, sound design crucial.",Mysterious:"Intriguing unknowns. Shadows, partial reveals. Cool or neutral tones.",Haunting:"Lingering unease. Cool tones, slow drift.",Bleak:"Hopeless emptiness. Desaturated, harsh environments.",Tragic:"Profound loss. Often static, allowing weight to settle.",Lonely:"Isolation emphasized. Negative space, single subjects.",Aggressive:"Confrontational energy. Fast movement, tight angles.",Angry:"Visible rage. Tight close-ups, red accents, unstable framing.",Rebellious:"Defiant energy. Dutch angles, punk aesthetic, bold choices.",Kinetic:"Pure motion energy. Fast cuts, dynamic camera, action-driven.",Urgent:"Time-critical pressure. Fast pacing, close framing, breathless.",Provocative:"Deliberately challenging. Bold framing, direct confrontation.",Unhinged:"Lost control. Erratic movement, unpredictable framing.",Chaotic:"Disorder and confusion. Handheld, rapid cutting.",Frantic:"Desperate urgency. Fast, unstable, breathless.",Intense:"High stakes focus. Close, direct, immediate.",Noir:"Classic film noir aesthetic. High contrast, shadows, morally ambiguous.",Hardboiled:"Tough, cynical detective fiction. Urban night, practical lighting.",Fatalistic:"Inevitable doom accepted. Static, resigned framing.",Cynical:"Distrustful, world-weary. Cool tones, detached framing.",World_Weary:"Exhausted by experience. Heavy, slow, desaturated.",Gothic:"Dark romanticism. Architecture, shadows, supernatural undertones.",Macabre:"Death and decay fascination. Shadow, texture, unsettling beauty.",Grotesque:"Distorted, disturbing forms. Wide angles, harsh light.",Eldritch:"Cosmic, unknowable horror. Vast scale, alien geometry.",Dread:"Paralyzing fear of what comes. Static, inevitable approach.",Documentary:"Observational realism. Natural light, handheld, unobtrusive.",Realistic:"Naturalistic presentation. Motivated lighting, believable blocking.",Observational:"Fly-on-wall perspective. Distance, patience, non-intervention.",Journalistic:"News/reportage style. Handheld, available light, urgent.",Verite:"Cinema veritetruth of the moment. Raw, unpolished, authentic.",Epic:"Grand scale. Wide shots, sweeping movements, orchestral feel."},qf={Warm_Saturated:"Rich, vivid warm colors. Energetic, inviting. Summer, nostalgia.",Warm_Desaturated:"Muted warm tones. Period films, memory sequences. Sepia influence.",Cool_Saturated:"Vivid blues and cyans. Sci-fi, night exteriors. Electric feel.",Cool_Desaturated:"Muted blues. Noir, thriller, depression. Clinical or bleak.",Neutral_Saturated:"Balanced vivid colors. Commercials, bright films.",Neutral_Desaturated:"Muted neutral palette. Documentary, realism. Low intervention.",Monochrome:"Black and white. Classic, graphic, timeless. Bold artistic choice.",Sepia:"Brown-toned monochrome. Historical, aged, nostalgic.",Teal_Orange:"Complementary color grade. Blockbuster look. Skin pops against teal shadows."},Kf={ARRI_Signature_Prime:"Modern LF lenses. Clean with subtle character. Gentle fall-off. Current ARRI flagship.",ARRI_Master_Prime:"Ultra-sharp S35 lenses. Clinical precision. High contrast. Technical perfection.",ARRI_Ultra_Prime:"Compact S35 primes. Neutral rendering. Documentary and narrative workhorse.",ARRI_Prime_65:"65mm format lenses for Alexa 65. Cinema-scale optics. XPL mount. Used on Roma, The Revenant.",ARRI_Prime_DNA:"DNA Large Format lenses. Organic character with modern resolution. Beautiful flares. Used on Parasite.",Zeiss_Supreme_Prime:"Modern high-speed LF lenses. Smooth bokeh, gentle flares. Clean aesthetic.",Zeiss_Master_Prime:"S35 reference standard. Maximum sharpness. Minimal distortion.",Zeiss_CP3:"Compact primes. Good value, solid performance. Indie production favorite.",Cooke_S7:"Full-frame Cooke Look. Warm skin tones, gentle rolloff. Organic character.",Cooke_S4:"Classic S35 primes. The definitive Cooke Look. Slight warmth, beautiful faces.",Cooke_Panchro:"Vintage rehoused classics. Period character. Soft, romantic.",Panavision_Primo:"Hollywood standard S35. Exclusive ecosystem. Pristine but characterful.",Panavision_Primo_70:"65mm format coverage. For Alexa 65 and large format. Epic scale optics.",Panavision_C_Series:"Compact anamorphic. Squeezed 2x. Classic anamorphic flares and bokeh.",Angenieux_Optimo:"Premium zoom lenses. Rare prime-like zoom quality. Versatile focal ranges.",Leica_Summicron_C:"Cinema rehoused Leicas. Legendary Leica rendering. Subtle micro-contrast.",Leica_Summilux_C:"Fast Leica cine primes. Faster than Summicron. More bokeh potential.",Canon_Sumire:"Warm, organic primes. Intended for digital cinema. Pleasing skin tones.",Sony_CineAlta:"Matched to Venice cameras. Optimized for Sony color science.",Sigma_Cine:"High-value cine lenses. Sharp, modern. Excellent cost-performance."},Yf={"2D":"Traditional flat animation. Hand-drawn or digital. Classic anime, Disney, independent animation.","3D":"Computer-generated 3D. Full dimensional lighting and camera freedom. Pixar, modern features.",Hybrid:"Mix of 2D and 3D elements. 3D backgrounds with 2D characters, or vice versa. Spider-Verse style.",StopMotion:"Physical puppets/models photographed frame-by-frame. Laika, Aardman. Tactile, handcrafted."},Jf={Anime:"Japanese animation tradition. 2D/hybrid. Expressive, stylized. Limited to full animation range.",Manga:"Japanese comic style. Static, monochrome only. High contrast ink aesthetic. No motion.",ThreeD:"3D computer animation. Dimensional lighting required. Smooth to exaggerated motion.",Illustration:"Static artwork. Single frame presentation. No motion, locked frame only."},Zf={Clean:"Smooth, uniform outlines. Professional anime standard. Digital precision.",Sketchy:"Rough, hand-drawn appearance. Artistic, unpolished charm. Indie aesthetic.",Bold:"Thick, prominent outlines. High contrast, graphic impact. Cartoon/comic style.",Thin:"Delicate, fine lines. Detailed, elegant. Illustration quality.",Variable:"Line weight varies with pressure/form. Dynamic, expressive. Traditional art feel.",None:"No outlines (lineless). Shapes defined by color only. 3D or painterly styles."},Qf={Cel:"Traditional anime cel coloring. Flat colors with hard shadows. Classic look.",Gradient:"Smooth color transitions. Softer, more dimensional than cel.",Watercolor:"Painted, textured appearance. Artistic, handcrafted feel.",Flat:"Solid colors, no shading. Graphic design influence. Bold, simple.",Textured:"Surface texture in color fills. Adds tactile quality.",Monochrome:"Single color or grayscale. Stylistic choice for color animation.",Monochrome_Ink:"Black and white ink style. Required for Manga domain."},eg={Flat:"No dimensional shading. Graphic, 2D. Cannot use for 3D domain.",Cel_Shaded:"Hard shadow edges. Anime standard. Stylized dimensionality.",Soft_Shaded:"Smooth shadow gradients. More realistic while still stylized.",Naturalistic_Simulated:"Realistic light behavior simulated in 2D. Complex, labor-intensive.",Raytraced:"Physically accurate 3D lighting. Photorealistic. Not for anime style."},tg={Smooth:"Clean, untextured surfaces. Classic anime look. Fast to render.",Textured:"Subtle surface variation. Adds visual interest without overwhelming.",Detailed:"Rich surface complexity. Fabric weave, skin pores, material specifics.",Photoreal:"Photorealistic surface rendering. Full material simulation. 3D only.",Stylized:"Artistic interpretation of surfaces. Hand-painted textures, illustrative."},ng={None:"Static image. No animation. Required for Manga and Illustration domains.",Limited:"Traditional anime efficiency. 8-12 fps on twos/threes. Strategic movement.",Full:"Full animation. 24 fps on ones. Disney-quality. High budget.",Exaggerated:"Beyond reality. Squash and stretch. Cartoon physics.",Snappy:"Quick, punchy timing. Modern digital animation trend.",Fluid:"Smooth, continuous motion. Graceful, flowing. High frame count."},ag={Locked:"Static frame. No camera movement. Required for Manga/Illustration.",Digital_Pan:"Horizontal digital movement across artwork. Classic anime technique.",Digital_Zoom:"Scale change on artwork. Ken Burns effect. Creates depth illusion.",Parallax:"Layered movement at different speeds. Creates depth in 2D.",Free_3D:"Full 3D camera movement. Requires 3D medium.",Simulated_Handheld:"Artificial shake/drift. Adds documentary feel. Not for anime.",Motion_Comic:"Panel-to-panel reveals. Comic book presentation style."},rg="Camera brand. ARRI, RED, and Sony dominate professional cinema. Each has unique color science and sensor technology.",ig="The specific camera model. Determines sensor size (S35, Full Frame, 65mm), resolution, weight class, and compatible lens mounts.",sg="Lens brand. Each manufacturer has a signature rendering styleCooke is warm, Zeiss is clinical, ARRI is balanced.",og="The lens series. Different families have different optical character, coverage (S35 vs Full Frame), and focal length options.",lg="Lens focal length in millimeters. Wide (14-24mm) for environments, Normal (35-50mm) for natural look, Long (85-135mm) for close-ups.",cg="Anamorphic lenses squeeze a wider field of view onto the sensor, creating the classic widescreen look with oval bokeh and horizontal flares.",dg="Physical support system. Determines what camera movements are possible. Heavy cameras restrict to Tripod/Dolly/Crane.",ug="The specific camera move. Each creates different emotional effectspush-in intensifies, pull-out reveals context.",hg="Speed of camera movement. Slow builds atmosphere, Fast adds energy. Dolly Zoom requires slower timing for effect.",pg="Scene time setting. Determines available natural light and shadows. Night eliminates Sun as a source option.",mg="Primary light source in the scene. Filtered by time of day and erano LED before 2002, no Sun at night.",fg="Overall lighting approach. High-Key is bright/even (comedy), Low-Key is dark/contrasty (noir). Some moods restrict options.",gg="How much of the subject fills the frame. Wide shots establish environment, close-ups show emotion and detail.",vg="Frame arrangement principles. Rule of Thirds is most common, Centered is formal/confrontational (Kubrick, Anderson).",yg="Emotional tone of the shot. Some presets restrict moodsBlade Runner blocks Cheerful, etc. Affects lighting compatibility.",xg="Color grading direction. Warm/Cool temperature and Saturated/Desaturated intensity. Sets the emotional palette.",bg="2D (traditional/digital flat) or 3D (computer generated). Affects available rendering and camera options.",_g="Animation tradition. Anime (Japanese 2D), Manga (static comics), 3D (Pixar-style), or Illustration (single frame art).",wg="How outlines are rendered. Anime typically uses clean dark lines, 3D may have no lines (lineless) or stylized edges.",Sg="How color fills shapes. Cel = flat with hard shadows, Gradient = smooth transitions. Manga must be Monochrome_Ink.",Mg="How light/shadow is represented. Flat = no shading, Cel_Shaded = hard shadows, Raytraced = photorealistic (3D only).",Cg="Texture complexity. Minimal for clean anime look, Detailed for complex surfaces. Affects rendering style.",Eg="Animation approach. Limited = efficient 12fps (anime), Full = 24fps fluid (Disney). Manga/Illustration must be None.",kg="Camera movement in animation. 2D uses pans/zooms over artwork, 3D has free movement. Static domains require Locked.";function Tg(e,t="Digital"){const n=ff[e]||[];return("Film"===t?lf.camera_body_film:lf.camera_body).map(t=>{var a,r;const i=null==(a=Of)?void 0:a[t];if(n.length>0&&!n.includes(t)){const n=(null==(r=Object.entries(ff).find(([e,n])=>n.includes(t)))?void 0:r[0])||"another manufacturer";return{value:t,disabled:!0,reason:`${hf[t]||t.replace(/_/g," ")} is made by ${n}, not ${e}.`,description:i}}return{value:t,disabled:!1,description:i}})}function Ng(e,t){const n=mf[e]||"Medium",a=yf[t];return lf.movement_equipment.map(r=>{var i;const s=null==(i=Ff)?void 0:i[r];return"Heavy"===n&&gf.includes(r)?{value:r,disabled:!0,reason:` ${hf[e]||e} (~${"Heavy"===n?">4kg":"3-4kg"}) exceeds ${r} weight limit. ${r} typically supports <${"Drone"===r?"3kg":"4kg"} payloads.`,description:s}:a&&!a.includes(r)?{value:r,disabled:!0,reason:` ${t} requires ${a.join(" or ")}physically impossible with ${r}.`,description:s}:{value:r,disabled:!1,description:s}})}function Pg(e){const t=vf[e]||lf.movement_type;return lf.movement_type.map(n=>{var a;const r=null==(a=zf)?void 0:a[n];if(!t.includes(n)){let t=` ${e} cannot perform ${n}`;return t+="Static"===e?"static mount has no movement capability.":"Handheld"===e?"handheld is limited to pan/tilt rotations.":"Crane"===e||"Jib"===e?"arm-based equipment cannot track horizontally.":"Dolly"===e?"dolly can only track (forward/back), not lift.":"Drone"===e?"drone movement is primarily aerial translation.":`physically limited by ${e} mechanics.`,{value:n,disabled:!0,reason:t,description:r}}return{value:n,disabled:!1,description:r}})}function jg(e,t,n,a){const r=bf[e],i=n?function(e){if(!e)return[];const t=[];for(const[n,a]of Object.entries(_f))e<a&&t.push(n);return t}(n):[];return lf.lighting_source.map(s=>{var o;const l=null==(o=$f)?void 0:o[s];if(r&&!r.includes(s))return"Sun"!==s||"Night"!==e&&"Blue_Hour"!==e?"Moon"===s&&"Midday"===e?{value:s,disabled:!0,reason:" Moonlight is too faint to compete with midday sunwould be invisible.",description:l}:{value:s,disabled:!0,reason:` ${s} unavailable at ${e.replace(/_/g," ")}.`,description:l}:{value:s,disabled:!0,reason:` Sun is below horizon at ${e.replace(/_/g," ")}physically impossible as primary source.`,description:l};if(t.includes(s))return{value:s,disabled:!0,reason:` ${s} conflicts with ${a||"preset"} aestheticwould break period/style consistency.`,description:l};if(i.includes(s)){return{value:s,disabled:!0,reason:` ${s} technology didn't exist in ${n}invented ${_f[s]}. Would be historically anachronistic.`,description:l}}return{value:s,disabled:!1,description:l}})}function Ag(e,t){const n=wf[e],a=t?Sf[t]:null;return lf.lighting_style.map(r=>{var i;const s=null==(i=Vf)?void 0:i[r];return n&&!n.includes(r)?"Low_Key"===r&&"Midday"===e?{value:r,disabled:!0,reason:" Low-Key requires controlled darknessmidday sun floods scene with ambient light. Need blackout or interior.",description:s}:{value:r,disabled:!0,reason:` ${r} not achievable at ${e.replace(/_/g," ")}.`,description:s}:t&&(null==a?void 0:a.disallowed.includes(r))?{value:r,disabled:!0,reason:` ${r.replace(/_/g," ")} creates tonal dissonance with "${t}" moodshadows and contrast undermine ${t.toLowerCase()} emotional intent.`,description:s}:{value:r,disabled:!1,description:s}})}function Rg(e){const t=xf[e];return lf.movement_timing.map(n=>{var a;const r=null==(a=Bf)?void 0:a[n];return t&&!t.includes(n)?"Dolly_Zoom"===e?{value:n,disabled:!0,reason:` Dolly Zoom (Vertigo effect) at ${n.replace(/_/g," ")} speed is disorientingthe simultaneous zoom/dolly becomes unreadable. Use Slow or Moderate for the effect to register psychologically.`,description:r}:{value:n,disabled:!0,reason:` ${n.replace(/_/g," ")} is too fast for ${e.replace(/_/g," ")}.`,description:r}:{value:n,disabled:!1,description:r}})}function Ig(e,t){return lf.mood.map(n=>{var a;const r=null==(a=Xf)?void 0:a[n];return e.length>0?e.includes(n)?{value:n,disabled:!1,reason:` Recommended for ${t||"this style"}aligns with the preset's visual identity.`,description:r}:{value:n,disabled:!1,reason:` Not typical for ${t||"this style"}. Recommended moods: ${e.join(", ")}.`,description:r}:{value:n,disabled:!1,description:r}})}function Lg(e,t){const n=Tf[e],a=Nf[e],r=If[e],i=t?Af[t]:null;return lf.lens_family.map(s=>{var o,l;const c=null==(o=Kf)?void 0:o[s];if(i&&!i.includes(s)){const e=null==(l=Object.entries(Af).find(([e,t])=>t.includes(s)))?void 0:l[0];return{value:s,disabled:!0,reason:` ${pf[s]||s.replace(/_/g," ")} is made by ${e}, not ${t}. Change manufacturer filter to use these lenses.`,description:c}}if((null==r?void 0:r.required_families)&&!r.required_families.includes(s))return{value:s,disabled:!0,reason:` ${hf[e]||e}'s ${n} sensor (65mm) requires specialized large-format optics. Only ${r.required_families.map(e=>pf[e]||e).join(", ")} covers this format.`,description:c};const d=Pf[s];if(d){if("65mm"===n&&!d.includes("65mm"))return{value:s,disabled:!0,reason:` ${pf[s]||s.replace(/_/g," ")} cannot cover 65mm sensorwould vignette severely. Designed for ${d.join("/")}.`,description:c};if("LF"===n&&!d.includes("LF")&&!d.includes("FF"))return{value:s,disabled:!0,reason:` ${pf[s]||s.replace(/_/g," ")} is S35-onlywould show dark corners (vignette) on Large Format sensor.`,description:c}}const u=jf[s];if(u&&a){if(!(u.includes(a)||"LPL"===a&&u.includes("PL")||"RF"===a&&u.includes("PL")||"E"===a&&(u.includes("PL")||u.includes("E"))))return{value:s,disabled:!0,reason:` ${pf[s]||s.replace(/_/g," ")} uses ${u.join("/")} mountincompatible with ${hf[e]||e}'s ${a} mount without adapter.`,description:c}}return{value:s,disabled:!1,description:c}})}function Dg(e){const t=Rf[e];return lf.focal_length_mm.map(n=>{let a="";if(a=n<=18?`Ultra-wide ${n}mm. Dramatic perspective, environment emphasis. Distorts faces up close.`:n<=28?`Wide ${n}mm. Environmental context with subject. Some perspective distortion.`:n<=40?`Normal ${n}mm. Close to human vision. Versatile, neutral perspective.`:n<=65?`Standard ${n}mm. Classic portrait range begins. Flattering for faces.`:n<=100?`Portrait ${n}mm. Compressed perspective, beautiful bokeh. Intimate close-ups.`:`Telephoto ${n}mm. Strong compression, shallow depth. Surveillance, sports, intimate detail.`,t&&!t.includes(n)){const r=t.reduce((e,t)=>Math.abs(t-n)<Math.abs(e-n)?t:e);return{value:String(n),disabled:!0,reason:` ${pf[e]||e.replace(/_/g," ")} isn't manufactured in ${n}mm. Nearest available: ${r}mm. Lens sets have specific focal lengths.`,description:a}}return{value:String(n),disabled:!1,description:a}})}function Ug(e){return e.startsWith("IMAX_")?["1.43:1","1.90:1","2.20:1"]:"Ultra_Panavision_70"===e?["2.76:1","2.39:1","2.20:1"]:"Super_Panavision_70"===e?["2.20:1","2.35:1","2.39:1"]:lf.aspect_ratio}function Og(e){const t=Mf[e];return lf.color_application.map(n=>{var a,r;const i=null==(a=Qf)?void 0:a[n];return(null==(r=null==t?void 0:t.disallowed_colors)?void 0:r.includes(n))?"Manga"===e?{value:n,disabled:!0,reason:" Manga is defined by monochrome ink aestheticcolor would fundamentally change the medium.",description:i}:{value:n,disabled:!0,reason:` ${n} not available for ${e}.`,description:i}:{value:n,disabled:!1,description:i}})}function Fg(e,t,n){const a=Mf[e],r=Cf[t],i=n?Ef[n]:null;return lf.virtual_camera.map(n=>{var s,o;const l=null==(s=ag)?void 0:s[n];return(null==(o=null==a?void 0:a.disallowed_cameras)?void 0:o.includes(n))?"Anime"===e&&"Simulated_Handheld"===n?{value:n,disabled:!0,reason:" Anime tradition relies on deliberate, controlled framingsimulated handheld conflicts with the aesthetic.",description:l}:"Manga"===e?{value:n,disabled:!0,reason:" Manga is printed static artworkcamera movement doesn't exist in the medium.",description:l}:"Illustration"===e?{value:n,disabled:!0,reason:" Illustration is a single static imageno temporal dimension for camera movement.",description:l}:{value:n,disabled:!0,reason:` ${n} not compatible with ${e}.`,description:l}:(null==r?void 0:r.includes(n))?{value:n,disabled:!0,reason:` ${n} requires true 3D geometry${t} medium lacks the dimensional data for free camera movement.`,description:l}:(null==i?void 0:i.includes(n))?{value:n,disabled:!0,reason:' Motion Style is "None"camera movement requires animated frames to be perceptible.',description:l}:{value:n,disabled:!1,description:l}})}function zg(e){const t=Mf[e];return lf.motion_style.map(n=>{var a,r;const i=null==(a=ng)?void 0:a[n];return(null==(r=null==t?void 0:t.disallowed_motion)?void 0:r.includes(n))?"Manga"===e?{value:n,disabled:!0,reason:" Manga is printed static artworkmotion exists only in reader's imagination through visual storytelling.",description:i}:"Illustration"===e?{value:n,disabled:!0,reason:" Illustration is a single frameno animation component exists.",description:i}:{value:n,disabled:!0,reason:` ${e} is staticno motion animation.`,description:i}:{value:n,disabled:!1,description:i}})}function Bg(e){const t=Mf[e];return lf.lighting_model.map(n=>{var a,r;const i=null==(a=eg)?void 0:a[n];return(null==t?void 0:t.required_lighting)&&!t.required_lighting.includes(n)?{value:n,disabled:!0,reason:` ${e} requires ${t.required_lighting.join("/")} lightingdimensional shading conflicts with the graphic ink aesthetic.`,description:i}:(null==(r=null==t?void 0:t.disallowed_lighting)?void 0:r.includes(n))?"Anime"===e&&"Raytraced"===n?{value:n,disabled:!0,reason:" Raytracing produces photorealistic lightingconflicts with anime's stylized cel-shaded aesthetic.",description:i}:"ThreeD"===e&&"Flat"===n?{value:n,disabled:!0,reason:" 3D animation requires dimensional lightingflat lighting defeats the purpose of 3D geometry.",description:i}:{value:n,disabled:!0,reason:` ${n} not compatible with ${e}.`,description:i}:{value:n,disabled:!1,description:i}})}function Hg(e){const t={amelie:"amlie",an_andalusian_dog:"andalusian-dog",un_chien_andalou:"andalusian-dog",battle_of_algiers:"the-battle-of-algiers",one_flew_over_cuckoos_nest:"one-flew-over-the-cuckoos-nest",star_wars_anh:"star-wars-a-new-hope",la_la_land:null,the_social_network:null,joker:null,drive:null,solaris:"solaris",spirited_away:null,princess_mononoke:null,your_name:null,perfect_blue:null,paprika:null,toy_story:null,wall_e:null,spider_verse:"spider-verse",ratatouille:null,finding_nemo:null,arcane:"arcane",love_death_robots:null,into_the_spider_verse:"spider-verse",studio_ghibli_generic:null};if(e in t){const n=t[e];return null===n?null:`/movie-frames/${n}.jpg`}return`/movie-frames/${e.replace(/_/g,"-").toLowerCase()}.jpg`}function $g(e){return e.disabled&&e.reason?e.description?`${e.reason}\n\n ${e.description}`:e.reason:e.description||""}const Vg=["camera.camera_type","camera.manufacturer","camera.body","camera.film_stock","camera.aspect_ratio","lens.manufacturer","lens.family","movement.equipment","movement.movement_type","movement.timing","lighting.time_of_day","lighting.source","lighting.style","visual_grammar.shot_size","visual_grammar.composition","visual_grammar.mood","visual_grammar.color_tone"],Wg=["medium","style_domain","rendering.line_treatment","rendering.color_application","rendering.lighting_model","rendering.surface_detail","motion.motion_style","motion.virtual_camera","visual_grammar.shot_size","visual_grammar.composition","visual_grammar.mood","visual_grammar.color_tone"];function Gg(){const{projectType:e,setProjectType:t,liveActionConfig:n,animationConfig:a,setLiveActionConfig:r,setAnimationConfig:i,updateLiveAction:s,updateAnimation:o,validationResult:l,setValidationResult:c,generatedPrompt:d,negativePrompt:u,setGeneratedPrompt:h,targetModel:p,setTargetModel:m,selectedLiveActionPreset:f,selectedAnimationPreset:g,liveActionPresetList:v,animationPresetList:y,setLiveActionPresetList:x,setAnimationPresetList:b,applyLiveActionPresetConfig:_,applyAnimationPresetConfig:w,clearPreset:S,setCpePromptForStoryboard:M}=Lm(),[C,E]=Tt.useState(!1),[k,T]=Tt.useState(!1),[N,P]=Tt.useState(!1),[j,A]=Tt.useState(!1),[R,I]=Tt.useState(""),[L,D]=Tt.useState(null),[U,O]=Tt.useState(!1),[F,z]=Tt.useState(!1),[B,H]=Tt.useState({type:"live_action",config:n});Tt.useEffect(()=>{const t=setTimeout(()=>{H({type:e,config:"live_action"===e?n:a})},300);return()=>clearTimeout(t)},[e,n,a]);const $=tm({queries:("live_action"===e?Vg:Wg).map(e=>({queryKey:["options",B.type,e,B.config],queryFn:()=>Dm.getOptions(B.type,e,B.config),staleTime:6e4,retry:!1}))}),V=Tt.useMemo(()=>{const e={};return $.forEach(t=>{t.data&&(e[t.data.field_path]=t.data)}),e},[$]),W=Tt.useCallback((e,t)=>{const n=V[e];if(!n)return t;const a=new Map(t.map(e=>[e.value,e])),r=new Set([...t.map(e=>e.value),...n.options,...n.disabled_options]),i=Array.from(r).sort((e,n)=>{const a=t.findIndex(t=>t.value===e),r=t.findIndex(e=>e.value===n);return-1!==a&&-1!==r?a-r:-1!==a?-1:-1!==r?1:0});return i.map(e=>{const t=a.get(e),r=n.disabled_options.includes(e),i=n.options.includes(e);let s=(null==t?void 0:t.disabled)??!1,o=null==t?void 0:t.reason;return r?(s=!0,o=n.disabled_reasons[e]||o):i&&(s=!1,o=void 0),{value:e,disabled:s,reason:o,description:null==t?void 0:t.description}})},[V]),[G,X]=Tt.useState(""),q=Tt.useRef(!1),[K,Y]=Tt.useState(()=>{const e=ef();return(null==e?void 0:e.provider)||""}),[J,Z]=Tt.useState(()=>{const e=ef();return(null==e?void 0:e.model)||""}),[Q,ee]=Tt.useState([]),[te,ne]=Tt.useState(!1),[ae,re]=Tt.useState(null),[ie,se]=Tt.useState(""),[oe,le]=Tt.useState([]),[ce,de]=Tt.useState([]),[ue,he]=Tt.useState(!1),pe=Tt.useMemo(()=>{const e=ce.find(e=>e.id===p);return e?"Image"===e.category:df.has(p)},[ce,p]),me=Tt.useMemo(()=>{if("live_action"===e){const e=n.movement;return!!e&&"Static"!==e.movement_type}return!1},[e,n,a]),[fe,ge]=Tt.useState(()=>{const e=localStorage.getItem("cpe-ui-state");if(e)try{return JSON.parse(e).isPresetPanelOpen??!0}catch{}const t=localStorage.getItem("presetPanelOpen");return null===t||"true"===t}),[ve,ye]=Tt.useState(()=>{const e=localStorage.getItem("cpe-ui-state");if(e)try{return JSON.parse(e).presetPanelWidth??360}catch{}const t=localStorage.getItem("presetPanelWidth");return t?parseInt(t,10):360}),[xe,be]=Tt.useState(()=>{const e=localStorage.getItem("cpe-ui-state");if(e)try{return JSON.parse(e).presetPanelTab??"browser"}catch{}return"browser"}),[_e,we]=Tt.useState(!1),Se=Tt.useRef(null),Me=Tt.useRef(!0),Ce=Tt.useRef(null);Tt.useEffect(()=>{if(!Me.current)return Ce.current&&clearTimeout(Ce.current),Ce.current=setTimeout(async()=>{A(!0);try{const t="live_action"===e?await Dm.validateLiveAction(n):await Dm.validateAnimation(a);c(t)}catch(t){console.error("Validation error:",t)}finally{A(!1)}},300),()=>{Ce.current&&clearTimeout(Ce.current)};Me.current=!1},[e,n,a,c]),Tt.useEffect(()=>{const e=e=>{var n;if(!e.data||"INIT_CONFIG"!==e.data.type)return;const a=e.data.payload;if(!(null==a?void 0:a.config))return;Ee.current=!0,"live_action"===a.projectType?(t("live_action"),r(a.config)):"animation"===a.projectType&&(t("animation"),i(a.config));const s=a.userPrompt??(null==(n=a.config)?void 0:n.user_prompt)??"";void 0!==s&&(q.current=!0,X(s)),void 0!==a.prompt&&h(a.prompt||"",null),void 0!==a.enhancedPrompt&&se(a.enhancedPrompt||"")};return window.addEventListener("message",e),window.parent&&window.parent!==window&&window.parent.postMessage({type:"READY"},"*"),()=>window.removeEventListener("message",e)},[t,r,i,h]);const Ee=Tt.useRef(!1);Tt.useEffect(()=>{const e=of();ee(e);const t=ef();t?(Y(t.provider),Z(t.model)):e.length>0&&!K&&(Y(e[0].providerId),e[0].models.length>0&&Z(e[0].models[0]))},[F]),Tt.useEffect(()=>{const e=tf();e&&m(e),he(!0),Dm.getTargetModels().then(t=>{de(t);const n=e||p;t.length>0&&!t.find(e=>e.id===n)&&m(t[0].id)}).catch(e=>{console.error("Failed to fetch target models:",e)}).finally(()=>{he(!1)})},[]),Tt.useEffect(()=>{const e={isPresetPanelOpen:fe,presetPanelWidth:ve,presetPanelTab:xe};localStorage.setItem("cpe-ui-state",JSON.stringify(e)),localStorage.setItem("presetPanelOpen",String(fe)),localStorage.setItem("presetPanelWidth",String(ve))},[fe,ve,xe]),Tt.useEffect(()=>{af(p)},[p]);const ke=Tt.useCallback(e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget;if("pointerId"in e&&t.setPointerCapture)try{t.setPointerCapture(e.pointerId)}catch{}we(!0),document.body.classList.add("preset-panel-resizing")},[]),Te=Tt.useCallback(e=>{if(!fe)return;const t=Se.current;if(!t)return;const n=t.getBoundingClientRect();e.clientX-n.left<=12&&ke(e)},[fe,ke]);Tt.useEffect(()=>{if(!_e)return;const e=e=>{e.preventDefault();const t=window.innerWidth-e.clientX,n=Math.max(280,window.innerWidth-40),a=Math.max(280,Math.min(n,t));ye(a)},t=()=>{we(!1),document.body.classList.remove("preset-panel-resizing")};return document.addEventListener("pointermove",e),document.addEventListener("pointerup",t),document.addEventListener("pointercancel",t),document.addEventListener("mousemove",e),document.addEventListener("mouseup",t),()=>{document.removeEventListener("pointermove",e),document.removeEventListener("pointerup",t),document.removeEventListener("pointercancel",t),document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t),document.body.classList.remove("preset-panel-resizing")}},[_e]),Tt.useEffect(()=>{(async()=>{T(!0);try{if("live_action"===e){const e=await Dm.getLiveActionPresets();x(e.presets)}else{const e=await Dm.getAnimationPresets();b(e.presets)}}catch(t){console.error("Failed to load presets:",t)}finally{T(!1)}})()},[e,x,b]);const Ne=Tt.useCallback(async t=>{P(!0),D(null);try{if("live_action"===e){const e=await Dm.applyLiveActionPreset(t);_(e.config,e.preset),c(e.validation),O(!0),Dm.getCinematographyStyle(t).then(e=>D(e)).catch(()=>D(null)).finally(()=>O(!1))}else{const e=await Dm.applyAnimationPreset(t);w(e.config,e.preset),c(e.validation)}}catch(n){console.error("Failed to apply preset:",n)}finally{P(!1)}},[e,_,w,c]),Pe=Tt.useCallback(async()=>{E(!0),le([]);try{const t="live_action"===e?await Dm.generateLiveActionPrompt(n,p):await Dm.generateAnimationPrompt(a,p);h(t.prompt,t.negative_prompt),c(t.validation)}catch(t){console.error("Failed to generate prompt:",t)}finally{E(!1)}},[e,n,a,p,h,c]),je=Tt.useCallback(()=>{navigator.clipboard.writeText(d)},[d]),Ae=Tt.useCallback(async()=>{if(le([]),!G.trim())return void re("Please enter a prompt idea to enhance");if(!K||!J)return void re("Please select an LLM provider and model. Configure providers in Settings.");const t=Q.find(e=>e.providerId===K);if(t){ne(!0),re(null);try{const r=await Dm.enhancePrompt({userPrompt:G.trim(),llmProvider:K,llmModel:J,targetModel:p,projectType:e,config:"live_action"===e?n:a,credentials:{apiKey:t.credentials.apiKey,endpoint:t.credentials.endpoint,oauthToken:t.credentials.oauthToken}});r.success?(se(r.enhanced_prompt),le(r.warnings??[])):re(r.error||"Enhancement failed")}catch(r){console.error("Failed to enhance prompt:",r),re(r instanceof Error?r.message:"Enhancement failed"),le([])}finally{ne(!1)}}else re("Selected provider not found. Please configure in Settings.")},[G,K,J,Q,p,e,n,a]),Re=e=>{switch(e){case"hard":return"hard";case"warning":return"warning";case"info":return"info";default:return""}};return Ut.jsxs("div",{className:"app app-with-panel "+(fe?"":"panel-collapsed"),style:{"--preset-panel-width":`${ve}px`},children:[Ut.jsxs("header",{className:"header cpe-toolbar",children:[Ut.jsx("textarea",{className:"toolbar-prompt",value:G,onChange:e=>X(e.target.value),placeholder:"Describe your scene...",rows:1}),Ut.jsx("select",{className:"toolbar-model",value:p,onChange:e=>m(e.target.value),disabled:ue,children:ce.length>0?Ut.jsx(Ut.Fragment,{children:["General","Image","Video"].map(e=>{const t=ce.filter(t=>t.category===e);return 0===t.length?null:Ut.jsx("optgroup",{label:` ${e} Models `,children:t.map(e=>Ut.jsx("option",{value:e.id,children:e.name},e.id))},e)})}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("optgroup",{label:" General Models ",children:lf.target_model.filter(e=>"generic"===e).map(e=>Ut.jsx("option",{value:e,children:cf[e]||e},e))}),Ut.jsx("optgroup",{label:" Image Models ",children:lf.target_model.filter(e=>["midjourney","flux.1","flux.1_pro","flux_kontext","flux_krea","dall-e_3","gpt-image","ideogram_2.0","leonardo_ai","sdxl","stable_diffusion_3","z-image_turbo","qwen_image"].includes(e)).map(e=>Ut.jsx("option",{value:e,children:cf[e]||e},e))}),Ut.jsx("optgroup",{label:" Video Models ",children:lf.target_model.filter(e=>["sora","sora_2","veo_2","veo_3","runway_gen-3","runway_gen-4","kling_1.6","pika_2.0","luma_dream_machine","ltx_2","cogvideox","hunyuan","wan_2.1","wan_2.2","minimax_video","qwen_vl"].includes(e)).map(e=>Ut.jsx("option",{value:e,children:cf[e]||e},e))})]})}),Ut.jsx("button",{className:"toolbar-btn primary",onClick:Pe,disabled:C,children:C?"Generating...":"Generate"}),Ut.jsx("button",{className:"toolbar-btn",onClick:Ae,disabled:te||!G.trim(),children:te?"Enhancing...":"Enhance with AI"}),Ut.jsx("button",{className:"toolbar-settings",onClick:()=>z(!0),children:Ut.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[Ut.jsx("circle",{cx:"12",cy:"12",r:"3"}),Ut.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]})})]}),Ut.jsx(rf,{isOpen:F,onClose:()=>z(!1)}),pe&&me&&Ut.jsx("div",{style:{margin:"0.75rem 1.25rem",padding:"0.6rem 0.8rem",borderRadius:"6px",backgroundColor:"rgba(245, 158, 11, 0.12)",color:"var(--text-primary)",border:"1px solid rgba(245, 158, 11, 0.4)",fontSize:"0.85rem"},children:"Motion settings are ignored for image models. Switch to a video model or set movement to Static."}),Ut.jsxs("div",{className:"output-panel",children:[Ut.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.5rem"},children:[Ut.jsxs("h2",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:["Prompt Generation",Ut.jsx("span",{title:"This panel generates AI prompts from your cinematography settings. Use 'Generate' for a simple prompt based on settings, or 'Enhance with AI' to have an LLM create a more detailed, professional prompt.",style:{cursor:"help",fontSize:"0.75rem",color:"var(--text-muted)",backgroundColor:"var(--bg-light)",borderRadius:"50%",width:"18px",height:"18px",display:"inline-flex",alignItems:"center",justifyContent:"center"},children:"?"})]}),Ut.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[j&&Ut.jsx("span",{className:"status-badge validating",children:"validating..."}),l&&!j&&Ut.jsx("span",{className:`status-badge ${l.status}`,children:l.status})]})]}),l&&l.messages.length>0&&Ut.jsx("div",{className:"validation-messages",style:{marginBottom:"0.75rem"},children:l.messages.map((e,t)=>Ut.jsxs("div",{className:`validation-message ${Re(e.severity)}`,children:[Ut.jsxs("strong",{children:[e.rule_id,":"]})," ",e.message]},t))}),Ut.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"1rem",marginBottom:"1rem"},children:[Ut.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:[Ut.jsxs("label",{style:{display:"block",fontSize:"0.75rem",color:"var(--text-muted)"},title:"Basic prompt generated from your cinematography settings.",children:["Simple Prompt ",Ut.jsx("span",{style:{cursor:"help"},children:"(?)"})]}),Ut.jsx("textarea",{readOnly:!0,value:d||'Click "Generate" to create a prompt from your settings...',style:{width:"100%",minHeight:"150px",padding:"0.75rem",fontSize:"0.85rem",borderRadius:"6px",border:"1px solid var(--border-subtle)",backgroundColor:"var(--bg-medium)",color:d?"var(--text-primary)":"var(--text-muted)",resize:"vertical",fontFamily:"inherit",boxSizing:"border-box",flex:1}}),Ut.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[Ut.jsx("button",{className:"secondary",onClick:je,disabled:!d,title:"Copy simple prompt to clipboard",style:{padding:"0.5rem 1rem",fontSize:"0.8rem",fontWeight:500,borderRadius:"5px",border:"1px solid var(--border-medium)",backgroundColor:"var(--bg-elevated)",color:"var(--text-secondary)",cursor:d?"pointer":"not-allowed",transition:"all 0.15s ease"},children:"Copy Simple Prompt"}),Ut.jsx("button",{className:"secondary",onClick:()=>M(d),disabled:!d,title:"Send this prompt to the Storyboard panel",style:{padding:"0.5rem 1rem",fontSize:"0.8rem",fontWeight:500,borderRadius:"5px",border:"1px solid var(--accent-primary)",backgroundColor:"var(--accent-primary)",color:"white",cursor:d?"pointer":"not-allowed",transition:"all 0.15s ease",opacity:d?1:.5},children:" Send to Storyboard"})]})]}),Ut.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem"},children:[Ut.jsxs("label",{style:{display:"block",fontSize:"0.75rem",color:"var(--text-muted)"},title:"Your prompt enhanced by AI with professional cinematography language.",children:["AI-Enhanced Prompt ",Ut.jsx("span",{style:{cursor:"help"},children:"(?)"})]}),Ut.jsx("textarea",{readOnly:!0,value:ie||'Click "Enhance with AI" to generate an enhanced prompt...',style:{width:"100%",minHeight:"150px",padding:"0.75rem",fontSize:"0.85rem",borderRadius:"6px",border:"1px solid var(--border-subtle)",backgroundColor:"var(--bg-medium)",color:ie?"var(--text-primary)":"var(--text-muted)",resize:"vertical",fontFamily:"inherit",boxSizing:"border-box",flex:1}}),Ut.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[Ut.jsx("button",{className:"secondary",onClick:()=>navigator.clipboard.writeText(ie),disabled:!ie,title:"Copy enhanced prompt to clipboard",style:{padding:"0.5rem 1rem",fontSize:"0.8rem",fontWeight:500,borderRadius:"5px",border:"1px solid var(--border-medium)",backgroundColor:"var(--bg-elevated)",color:"var(--text-secondary)",cursor:ie?"pointer":"not-allowed",transition:"all 0.15s ease"},children:"Copy Enhanced Prompt"}),Ut.jsx("button",{className:"secondary",onClick:()=>M(ie),disabled:!ie,title:"Send this prompt to the Storyboard panel",style:{padding:"0.5rem 1rem",fontSize:"0.8rem",fontWeight:500,borderRadius:"5px",border:"1px solid var(--accent-primary)",backgroundColor:"var(--accent-primary)",color:"white",cursor:ie?"pointer":"not-allowed",transition:"all 0.15s ease",opacity:ie?1:.5},children:" Send to Storyboard"})]})]})]}),Ut.jsxs("div",{style:{marginBottom:"1rem"},children:[Ut.jsx("label",{style:{display:"block",fontSize:"0.75rem",color:"var(--text-muted)",marginBottom:"0.25rem"},children:"Negative Prompt"}),Ut.jsx("textarea",{readOnly:!0,value:u||"Generated negative prompt will appear here...",style:{width:"100%",minHeight:"50px",padding:"0.75rem",fontSize:"0.85rem",borderRadius:"6px",border:"1px solid var(--border-subtle)",backgroundColor:"var(--bg-medium)",color:u?"var(--text-primary)":"var(--text-muted)",resize:"vertical",fontFamily:"inherit",boxSizing:"border-box"}})]}),oe.length>0&&Ut.jsxs("div",{style:{fontSize:"0.8rem",color:"var(--text-primary)",marginBottom:"0.75rem",padding:"0.5rem",backgroundColor:"rgba(245, 158, 11, 0.12)",borderRadius:"4px",border:"1px solid rgba(245, 158, 11, 0.35)"},children:[Ut.jsx("strong",{children:"Note:"}),Ut.jsx("ul",{style:{margin:"0.35rem 0 0 1rem"},children:oe.map((e,t)=>Ut.jsx("li",{children:e},t))})]}),ae&&Ut.jsx("p",{style:{fontSize:"0.8rem",color:"var(--error)",marginBottom:"0.75rem",padding:"0.5rem",backgroundColor:"rgba(239, 68, 68, 0.1)",borderRadius:"4px"},children:ae}),0===Q.length&&Ut.jsx("p",{style:{fontSize:"0.8rem",color:"var(--text-muted)",marginBottom:"0.75rem",textAlign:"center",padding:"0.5rem",backgroundColor:"var(--bg-medium)",borderRadius:"4px"},children:"Click the gear icon to configure an AI provider for prompt enhancement"})]}),Ut.jsxs("div",{className:"mode-toggle",children:[Ut.jsx("button",{className:"live_action"===e?"active":"",onClick:()=>t("live_action"),children:"Live-Action Cinema"}),Ut.jsx("button",{className:"animation"===e?"active":"",onClick:()=>t("animation"),children:"Animation"})]}),Ut.jsxs("div",{className:`preset-panel ${fe?"open":"collapsed"} ${_e?"resizing":""}`,style:{width:fe?ve:40},ref:Se,onMouseDown:Te,children:[Ut.jsx("div",{className:"panel-resize-handle",onMouseDown:ke,onPointerDown:ke}),Ut.jsx("button",{className:"panel-collapse-toggle",onClick:()=>ge(!fe),title:fe?"Collapse panel":"Expand panel",children:Ut.jsx("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"none",stroke:"currentColor",strokeWidth:"2",children:Ut.jsx("path",{d:"M10 4L6 8L10 12"})})}),Ut.jsxs("div",{className:"panel-header",children:[Ut.jsx("h2",{children:"live_action"===e?"Film Presets":"Animation Presets"}),(f||g)&&Ut.jsx("button",{className:"clear-preset-btn",onClick:S,children:"Clear"})]}),Ut.jsxs("div",{className:"panel-tabs",children:[Ut.jsx("button",{className:"browser"===xe?"active":"",onClick:()=>be("browser"),children:"Browser"}),Ut.jsx("button",{className:"info"===xe?"active":"",onClick:()=>be("info"),children:"Info"})]}),Ut.jsxs("div",{className:"panel-tab-content",children:["browser"===xe&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{className:"preset-search",children:Ut.jsx("input",{type:"text",placeholder:`Search ${"live_action"===e?"film":"animation"} presets...`,value:R,onChange:e=>I(e.target.value)})}),Ut.jsx("div",{className:"preset-list",children:k?Ut.jsx("div",{className:"loading",children:"Loading presets..."}):"live_action"===e?v.filter(e=>!R||e.name.toLowerCase().includes(R.toLowerCase())||e.era.toLowerCase().includes(R.toLowerCase())).map(e=>Ut.jsxs("button",{className:"preset-item "+((null==f?void 0:f.id)===e.id?"selected":""),onClick:()=>Ne(e.id),disabled:N,children:[Hg(e.id)&&Ut.jsx("div",{className:"preset-item-thumbnail",children:Ut.jsx("img",{src:Hg(e.id),alt:"",onError:e=>{e.target.parentElement.style.display="none"}})}),Ut.jsxs("div",{className:"preset-item-info",children:[Ut.jsx("span",{className:"preset-item-name",children:e.name}),Ut.jsxs("span",{className:"preset-item-meta",children:[e.year,"  ",e.era]})]})]},e.id)):y.filter(e=>!R||e.name.toLowerCase().includes(R.toLowerCase())||e.domain.toLowerCase().includes(R.toLowerCase())).map(e=>Ut.jsxs("button",{className:"preset-item "+((null==g?void 0:g.id)===e.id?"selected":""),onClick:()=>Ne(e.id),disabled:N,children:[Hg(e.id)&&Ut.jsx("div",{className:"preset-item-thumbnail",children:Ut.jsx("img",{src:Hg(e.id),alt:"",onError:e=>{e.target.parentElement.style.display="none"}})}),Ut.jsxs("div",{className:"preset-item-info",children:[Ut.jsx("span",{className:"preset-item-name",children:e.name}),Ut.jsxs("span",{className:"preset-item-meta",children:[e.domain,"  ",e.medium]})]})]},e.id))})]}),"info"===xe&&Ut.jsx(Ut.Fragment,{children:"live_action"===e&&f?Ut.jsxs("div",{className:"active-preset",children:[Ut.jsxs("div",{className:"active-preset-content",children:[Ut.jsxs("div",{className:"preset-info",children:[Ut.jsx("div",{className:"preset-name",children:f.name}),Ut.jsxs("div",{className:"preset-meta",children:[f.year,"  ",f.era]}),f.disallowed_moods.length>0&&Ut.jsxs("div",{className:"preset-constraints",children:[Ut.jsx("span",{className:"constraint-label",children:"Disallowed moods:"}),Ut.jsx("span",{className:"constraint-values",children:f.disallowed_moods.join(", ")})]})]}),Hg(f.id)&&Ut.jsx("div",{className:"preset-image-preview",children:Ut.jsx("img",{src:Hg(f.id),alt:`${f.name} frame`,onError:e=>{e.target.style.display="none"}})})]}),U&&Ut.jsx("div",{className:"cinematography-loading",children:"Loading cinematography details..."}),L&&Ut.jsxs("div",{className:"cinematography-details",children:[Ut.jsxs("div",{className:"cinematography-header",children:[Ut.jsx("span",{className:"cinematography-label",children:"Cinematographer"}),Ut.jsx("span",{className:"cinematography-value cinematographer-name",children:L.cinematographer})]}),Ut.jsxs("div",{className:"cinematography-grid",children:[Ut.jsxs("div",{className:"cinematography-item",children:[Ut.jsx("span",{className:"item-label",children:"Camera"}),Ut.jsx("span",{className:"item-value",children:L.camera})]}),Ut.jsxs("div",{className:"cinematography-item",children:[Ut.jsx("span",{className:"item-label",children:"Film Stock"}),Ut.jsx("span",{className:"item-value",children:L.film_stock})]}),Ut.jsxs("div",{className:"cinematography-item",children:[Ut.jsx("span",{className:"item-label",children:"Aspect Ratio"}),Ut.jsx("span",{className:"item-value",children:L.aspect_ratio})]}),Ut.jsxs("div",{className:"cinematography-item",children:[Ut.jsx("span",{className:"item-label",children:"Lenses"}),Ut.jsx("span",{className:"item-value",children:L.lens_info})]})]}),Ut.jsxs("div",{className:"cinematography-section",children:[Ut.jsx("span",{className:"section-label",children:"Lighting Signature"}),Ut.jsx("span",{className:"section-value",children:L.lighting_signature})]}),Ut.jsxs("div",{className:"cinematography-section",children:[Ut.jsx("span",{className:"section-label",children:"Color Palette"}),Ut.jsx("span",{className:"section-value",children:L.color_palette})]}),Ut.jsxs("div",{className:"cinematography-section",children:[Ut.jsx("span",{className:"section-label",children:"Notable Techniques"}),Ut.jsx("span",{className:"section-value",children:L.notable_techniques})]}),Ut.jsxs("div",{className:"cinematography-section",children:[Ut.jsx("span",{className:"section-label",children:"Movement Style"}),Ut.jsx("span",{className:"section-value",children:L.movement_style})]}),L.legacy&&Ut.jsxs("div",{className:"cinematography-section cinematography-legacy",children:[Ut.jsx("span",{className:"section-label",children:"Legacy & Influence"}),Ut.jsx("span",{className:"section-value",children:L.legacy})]})]})]}):"animation"===e&&g?Ut.jsx("div",{className:"active-preset",children:Ut.jsxs("div",{className:"active-preset-content",children:[Ut.jsxs("div",{className:"preset-info",children:[Ut.jsx("div",{className:"preset-name",children:g.name}),Ut.jsxs("div",{className:"preset-meta",children:[g.domain,"  ",g.medium]}),g.line_treatment&&Ut.jsxs("div",{className:"preset-detail",children:[Ut.jsx("span",{className:"detail-label",children:"Line Treatment:"}),Ut.jsx("span",{className:"detail-value",children:g.line_treatment.replace(/_/g," ")})]}),g.color_application&&Ut.jsxs("div",{className:"preset-detail",children:[Ut.jsx("span",{className:"detail-label",children:"Color:"}),Ut.jsx("span",{className:"detail-value",children:g.color_application.replace(/_/g," ")})]}),g.lighting_model&&Ut.jsxs("div",{className:"preset-detail",children:[Ut.jsx("span",{className:"detail-label",children:"Lighting:"}),Ut.jsx("span",{className:"detail-value",children:g.lighting_model.replace(/_/g," ")})]}),g.motion_style&&Ut.jsxs("div",{className:"preset-detail",children:[Ut.jsx("span",{className:"detail-label",children:"Motion:"}),Ut.jsx("span",{className:"detail-value",children:g.motion_style.replace(/_/g," ")})]}),g.reference_works&&g.reference_works.length>0&&Ut.jsxs("div",{className:"preset-detail",children:[Ut.jsx("span",{className:"detail-label",children:"Reference:"}),Ut.jsx("span",{className:"detail-value",children:g.reference_works.slice(0,2).join(", ")})]}),g.disallowed_motion.length>0&&Ut.jsxs("div",{className:"preset-constraints",children:[Ut.jsx("span",{className:"constraint-label",children:"Disallowed motion:"}),Ut.jsx("span",{className:"constraint-values",children:g.disallowed_motion.join(", ")})]})]}),Hg(g.id)&&Ut.jsx("div",{className:"preset-image-preview",children:Ut.jsx("img",{src:Hg(g.id),alt:`${g.name} frame`,onError:e=>{e.target.style.display="none"}})})]})}):Ut.jsx("div",{style:{textAlign:"center",color:"var(--text-muted)",padding:"2rem",fontSize:"0.85rem"},children:"Select a preset from the Browser tab to view details"})})]})]}),Ut.jsx("div",{className:"config-panel",children:"live_action"===e?Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Camera"}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:"Choose between digital cinema cameras or traditional film cameras",children:"Camera Type"}),Ut.jsx("select",{value:n.camera.camera_type||"Digital",onChange:e=>{const t=e.target.value,n=("Digital"===t?lf.camera_manufacturer:lf.camera_manufacturer_film)[0];s("camera",{camera_type:t,manufacturer:n,body:(ff[n]||[])[0]||"",film_stock:"Film"===t?"Kodak_Vision3_500T_5219":"None"})},children:W("camera.camera_type",lf.camera_type.map(e=>({value:e,disabled:!1}))).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:rg,children:"Manufacturer"}),Ut.jsx("select",{value:n.camera.manufacturer,onChange:e=>{const t=e.target.value,n=ff[t]||[];n.length>0?s("camera",{manufacturer:t,body:n[0]}):s("camera",{manufacturer:t})},children:W("camera.manufacturer",("Film"===n.camera.camera_type?lf.camera_manufacturer_film:lf.camera_manufacturer).map(e=>{var t;return{value:e,disabled:!1,description:null==(t=Df)?void 0:t[e]}})).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:ig,children:"Body"}),Ut.jsx("select",{value:n.camera.body,onChange:e=>s("camera",{body:e.target.value}),children:W("camera.body",Tg(n.camera.manufacturer,n.camera.camera_type||"Digital")).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:hf[e.value]||e.value.replace(/_/g," ")},e.value))})]}),"Film"===n.camera.camera_type&&Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:"Film stock determines the visual character - color rendition, grain, and latitude",children:"Film Stock"}),Ut.jsxs("select",{value:n.camera.film_stock||"",onChange:e=>s("camera",{film_stock:e.target.value}),children:[Ut.jsx("option",{value:"",children:"Select Film Stock..."}),W("camera.film_stock",(De=n.camera.body,De.startsWith("IMAX_")?lf.film_stock_imax:"Super_Panavision_70"===De||"Ultra_Panavision_70"===De||"Mitchell_BFC_65"===De?lf.film_stock_65mm:lf.film_stock).map(e=>({value:e,disabled:!1}))).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))]})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:"Aspect ratio determines the frame shape - wider ratios are more cinematic",children:"Aspect Ratio"}),Ut.jsx("select",{value:n.camera.aspect_ratio||"1.85:1",onChange:e=>s("camera",{aspect_ratio:e.target.value}),children:W("camera.aspect_ratio",Ug(n.camera.body).map(e=>({value:e,disabled:!1}))).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]})]}),Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Lens"}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:sg,children:"Manufacturer"}),Ut.jsx("select",{value:n.lens.manufacturer,onChange:e=>{const t=e.target.value,n=Af[t]||[];n.length>0?s("lens",{manufacturer:t,family:n[0]}):s("lens",{manufacturer:t})},children:W("lens.manufacturer",lf.lens_manufacturer.map(e=>{var t;return{value:e,disabled:!1,description:null==(t=Uf)?void 0:t[e]}})).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:og,children:["Lens Family",Lf(n.camera.body)&&Ut.jsxs("span",{className:"field-hint",children:["(",Lf(n.camera.body),")"]})]}),Ut.jsx("select",{value:n.lens.family,onChange:e=>s("lens",{family:e.target.value}),children:W("lens.family",Lg(n.camera.body,n.lens.manufacturer)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:pf[e.value]||e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:lg,children:["Focal Length (mm)",n.lens.family&&Ut.jsxs("span",{className:"field-hint",children:["(available for ",pf[n.lens.family]||n.lens.family.replace(/_/g," "),")"]})]}),Ut.jsx("select",{value:n.lens.focal_length_mm,onChange:e=>s("lens",{focal_length_mm:parseInt(e.target.value,10)}),children:W("lens.focal_length_mm",Dg(n.lens.family)).map(e=>Ut.jsxs("option",{value:e.value,title:$g(e),disabled:e.disabled,children:[e.value,"mm"]},e.value))})]}),Ut.jsx("div",{className:"field",children:Ut.jsxs("label",{title:cg,children:[Ut.jsx("input",{type:"checkbox",checked:n.lens.is_anamorphic,onChange:e=>{if(e.target.checked){const e={Panavision:"Panavision_C_Series",Kowa:"Kowa_Anamorphic",Vintage:"Vintage_Anamorphic"},t=n.lens.manufacturer;e[t]?s("lens",{is_anamorphic:!0,family:e[t]}):s("lens",{is_anamorphic:!0,manufacturer:"Panavision",family:"Panavision_C_Series"})}else{const e=n.lens.manufacturer,t=Af[e]||[],a=t.find(e=>!e.toLowerCase().includes("anamorphic"))||t[0]||"ARRI_Signature_Prime";s("lens",{is_anamorphic:!1,family:a})}}})," ","Anamorphic"]})})]}),Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Movement"}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:dg,children:["Equipment","Heavy"===mf[n.camera.body]&&Ut.jsx("span",{className:"field-hint",children:"(limited by camera weight)"}),"Dolly_Zoom"===n.movement.movement_type&&Ut.jsx("span",{className:"field-hint",children:"(Dolly Zoom requires Dolly/Slider)"})]}),Ut.jsx("select",{value:n.movement.equipment,onChange:e=>{const t=e.target.value,a=vf[t]||lf.movement_type;if("Static"===t)return void s("movement",{equipment:"Static",movement_type:"Static",timing:"Static"});const r=a.includes(n.movement.movement_type);s("movement",r?{equipment:t}:{equipment:t,movement_type:a[0]||"Static"})},children:W("movement.equipment",Ng(n.camera.body,n.movement.movement_type)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:ug,children:["Movement Type ",Ut.jsx("span",{className:"field-hint",children:"(filtered by equipment)"})]}),Ut.jsx("select",{value:n.movement.movement_type,onChange:e=>{const t=e.target.value,a=xf[t];a&&!a.includes(n.movement.timing)?s("movement",{movement_type:t,timing:"Moderate"}):s("movement",{movement_type:t})},children:W("movement.movement_type",Pg(n.movement.equipment)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:hg,children:["Timing","Dolly_Zoom"===n.movement.movement_type&&Ut.jsx("span",{className:"field-hint",children:"(Dolly Zoom requires slower timing)"})]}),Ut.jsx("select",{value:n.movement.timing,onChange:e=>s("movement",{timing:e.target.value}),children:W("movement.timing",Rg(n.movement.movement_type)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]})]}),Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Lighting"}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:pg,children:"Time of Day"}),Ut.jsx("select",{value:n.lighting.time_of_day,onChange:e=>{const t=e.target.value,a=bf[t],r=n.lighting.source,i=wf[t],o=n.lighting.style,l={time_of_day:t};a&&!a.includes(r)&&(l.source=a[0]),i&&!i.includes(o)&&(l.style=i[0]),s("lighting",l)},children:lf.time_of_day.map(e=>{var t;return Ut.jsx("option",{value:e,title:(null==(t=Hf)?void 0:t[e])||"",children:e.replace(/_/g," ")},e)})})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:mg,children:["Source",Ut.jsx("span",{className:"field-hint",children:f?f.year<2002?"(filtered by time + preset + era)":f.disallowed_sources.length>0?"(filtered by time + preset)":"(filtered by time)":"(filtered by time)"})]}),Ut.jsx("select",{value:n.lighting.source,onChange:e=>s("lighting",{source:e.target.value}),children:W("lighting.source",jg(n.lighting.time_of_day,(null==f?void 0:f.disallowed_sources)||[],null==f?void 0:f.year,null==f?void 0:f.name)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:fg,children:["Style ",Ut.jsx("span",{className:"field-hint",children:"(filtered by time & mood)"})]}),Ut.jsx("select",{value:n.lighting.style,onChange:e=>s("lighting",{style:e.target.value}),children:W("lighting.style",Ag(n.lighting.time_of_day,n.visual_grammar.mood)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]})]}),Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Visual Grammar"}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:gg,children:["Shot Size",kf(n.lens.focal_length_mm,n.visual_grammar.shot_size)&&Ut.jsxs("span",{className:"field-hint warning",children:["(",kf(n.lens.focal_length_mm,n.visual_grammar.shot_size),")"]})]}),Ut.jsx("select",{value:n.visual_grammar.shot_size,onChange:e=>s("visual_grammar",{shot_size:e.target.value}),children:lf.shot_size.map(e=>{var t;return Ut.jsx("option",{value:e,title:(null==(t=Wf)?void 0:t[e])||"",children:uf[e]||e},e)})})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:vg,children:"Composition"}),Ut.jsx("select",{value:n.visual_grammar.composition,onChange:e=>s("visual_grammar",{composition:e.target.value}),children:W("visual_grammar.composition",lf.composition.map(e=>{var t;return{value:e,disabled:!1,description:null==(t=Gf)?void 0:t[e]}})).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:yg,children:["Mood",f&&f.disallowed_moods.length>0&&Ut.jsx("span",{className:"field-hint",children:"(filtered by preset)"})]}),Ut.jsx("select",{value:n.visual_grammar.mood,onChange:e=>{var t;const a=e.target.value,r=Sf[a];if(null==r?void 0:r.disallowed.includes(n.lighting.style)){const e=lf.lighting_style.filter(e=>!r.disallowed.includes(e)),n=(null==(t=r.preferred)?void 0:t.find(t=>e.includes(t)))||e[0]||"High_Key";s("visual_grammar",{mood:a}),s("lighting",{style:n})}else s("visual_grammar",{mood:a})},children:W("visual_grammar.mood",(Ie=(null==f?void 0:f.disallowed_moods)||[],Le=null==f?void 0:f.name,lf.mood.map(e=>{var t;const n=null==(t=Xf)?void 0:t[e];return Ie.includes(e)?{value:e,disabled:!0,reason:` "${e}" conflicts with ${Le||"preset"}'s visual languagewould create tonal dissonance.`,description:n}:{value:e,disabled:!1,description:n}}))).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:xg,children:"Color Tone"}),Ut.jsx("select",{value:n.visual_grammar.color_tone,onChange:e=>s("visual_grammar",{color_tone:e.target.value}),children:lf.color_tone.map(e=>{var t;return Ut.jsx("option",{value:e,title:(null==(t=qf)?void 0:t[e])||"",children:e.replace(/_/g," ")},e)})})]})]})]}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Style"}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:bg,children:"Medium"}),Ut.jsx("select",{value:a.medium,onChange:e=>o("medium",e.target.value),children:W("medium",lf.animation_medium.map(e=>{var t;return{value:e,disabled:!1,description:null==(t=Yf)?void 0:t[e]}})).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:_g,children:"Style Domain"}),Ut.jsx("select",{value:a.style_domain,onChange:e=>{var t,n,r,i;const s=e.target.value,l=Mf[s],c={};if(null==(t=null==l?void 0:l.disallowed_colors)?void 0:t.includes(a.rendering.color_application)){const e=lf.color_application.filter(e=>{var t;return!(null==(t=l.disallowed_colors)?void 0:t.includes(e))});c.rendering={...a.rendering,color_application:e[0]||"Monochrome_Ink"}}if((null==(n=null==l?void 0:l.disallowed_motion)?void 0:n.includes(a.motion.motion_style))&&(c.motion={...a.motion,motion_style:"None"}),(null==(r=null==l?void 0:l.disallowed_cameras)?void 0:r.includes(a.motion.virtual_camera))&&(c.motion={...c.motion||a.motion,virtual_camera:"Locked"}),(null==l?void 0:l.required_lighting)&&!l.required_lighting.includes(a.rendering.lighting_model))c.rendering={...c.rendering||a.rendering,lighting_model:l.required_lighting[0]};else if(null==(i=null==l?void 0:l.disallowed_lighting)?void 0:i.includes(a.rendering.lighting_model)){const e=lf.lighting_model.filter(e=>{var t;return!(null==(t=l.disallowed_lighting)?void 0:t.includes(e))});c.rendering={...c.rendering||a.rendering,lighting_model:e[0]||"Cel_Shaded"}}o("style_domain",s),c.rendering&&o("rendering",c.rendering),c.motion&&o("motion",c.motion)},children:W("style_domain",lf.style_domain.map(e=>{var t;return{value:e,disabled:!1,description:null==(t=Jf)?void 0:t[e]}})).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]})]}),Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Rendering"}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:wg,children:"Line Treatment"}),Ut.jsx("select",{value:a.rendering.line_treatment,onChange:e=>o("rendering",{line_treatment:e.target.value}),children:W("rendering.line_treatment",lf.line_treatment.map(e=>{var t;return{value:e,disabled:!1,description:null==(t=Zf)?void 0:t[e]}})).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:Sg,children:["Color Application ","Manga"===a.style_domain&&Ut.jsx("span",{className:"field-hint",children:"(Manga: Monochrome only)"})]}),Ut.jsx("select",{value:a.rendering.color_application,onChange:e=>o("rendering",{color_application:e.target.value}),children:W("rendering.color_application",Og(a.style_domain)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:Mg,children:["Lighting Model","Manga"===a.style_domain&&Ut.jsx("span",{className:"field-hint",children:"(Manga: Graphic only)"}),"ThreeD"===a.style_domain&&Ut.jsx("span",{className:"field-hint",children:"(3D: No Flat lighting)"})]}),Ut.jsx("select",{value:a.rendering.lighting_model,onChange:e=>o("rendering",{lighting_model:e.target.value}),children:W("rendering.lighting_model",Bg(a.style_domain)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:Cg,children:"Surface Detail"}),Ut.jsx("select",{value:a.rendering.surface_detail,onChange:e=>o("rendering",{surface_detail:e.target.value}),children:W("rendering.surface_detail",lf.surface_detail.map(e=>{var t;return{value:e,disabled:!1,description:null==(t=tg)?void 0:t[e]}})).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]})]}),Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Motion"}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:Eg,children:["Motion Style ",("Manga"===a.style_domain||"Illustration"===a.style_domain)&&Ut.jsx("span",{className:"field-hint",children:"(static only)"})]}),Ut.jsx("select",{value:a.motion.motion_style,onChange:e=>o("motion",{motion_style:e.target.value}),children:W("motion.motion_style",zg(a.style_domain)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value},e.value))})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsxs("label",{title:kg,children:["Virtual Camera",Ut.jsxs("span",{className:"field-hint",children:["(filtered by domain/medium","None"===a.motion.motion_style?"/motion":"",")"]})]}),Ut.jsx("select",{value:a.motion.virtual_camera,onChange:e=>o("motion",{virtual_camera:e.target.value}),children:W("motion.virtual_camera",Fg(a.style_domain,a.medium,a.motion.motion_style)).map(e=>Ut.jsx("option",{value:e.value,title:$g(e),disabled:e.disabled,children:e.value.replace(/_/g," ")},e.value))})]})]}),Ut.jsxs("div",{className:"section",children:[Ut.jsx("h2",{children:"Visual Grammar"}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:gg,children:"Shot Size"}),Ut.jsx("select",{value:a.visual_grammar.shot_size,onChange:e=>o("visual_grammar",{shot_size:e.target.value}),children:lf.shot_size.map(e=>{var t;return Ut.jsx("option",{value:e,title:(null==(t=Wf)?void 0:t[e])||"",children:uf[e]||e},e)})})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:yg,children:"Mood"}),Ut.jsx("select",{value:a.visual_grammar.mood,onChange:e=>o("visual_grammar",{mood:e.target.value}),children:Ig((null==g?void 0:g.mood)||[],null==g?void 0:g.name).map(e=>{var t;return Ut.jsxs("option",{value:e.value,title:$g(e),children:[e.value,(null==(t=null==g?void 0:g.mood)?void 0:t.includes(e.value))?" ":""]},e.value)})})]}),Ut.jsxs("div",{className:"field",children:[Ut.jsx("label",{title:xg,children:"Color Tone"}),Ut.jsx("select",{value:a.visual_grammar.color_tone,onChange:e=>o("visual_grammar",{color_tone:e.target.value}),children:lf.color_tone.map(e=>{var t;return Ut.jsx("option",{value:e,title:(null==(t=qf)?void 0:t[e])||"",children:e.replace(/_/g," ")},e)})})]})]})]})})]});var Ie,Le,De}async function Xg(e,t,n){const a=1+4*t,r=new Uint8Array(a*n);for(let p=0;p<n;p++){r[p*a]=0;const n=p*t*4,i=p*a+1;r.set(e.subarray(n,n+4*t),i)}let i;try{const e=new CompressionStream("deflate"),t=e.writable.getWriter(),n=e.readable.getReader();t.write(r),t.close();const a=[];let s=0;for(;;){const{value:e,done:t}=await n.read();if(t)break;a.push(e),s+=e.byteLength}i=new Uint8Array(s);let o=0;for(const r of a)i.set(r,o),o+=r.byteLength}catch{i=function(e){const t=65535,n=Math.ceil(e.byteLength/t)||1,a=new Uint8Array(2+5*n+e.byteLength+4);let r=0;a[r++]=120,a[r++]=1;let i=e.byteLength,s=0;for(let d=0;d<n;d++){const o=Math.min(i,t),l=d===n-1;a[r++]=l?1:0,a[r++]=255&o,a[r++]=o>>8&255,a[r++]=255&~o,a[r++]=~o>>8&255,a.set(e.subarray(s,s+o),r),r+=o,s+=o,i-=o}let o=1,l=0;for(let d=0;d<e.byteLength;d++)o=(o+e[d])%65521,l=(l+o)%65521;const c=(l<<16|o)>>>0;return a[r++]=c>>24&255,a[r++]=c>>16&255,a[r++]=c>>8&255,a[r++]=255&c,a.subarray(0,r)}(r)}const s=[];s.push(new Uint8Array([137,80,78,71,13,10,26,10]));const o=new Uint8Array(13),l=new DataView(o.buffer);l.setUint32(0,t),l.setUint32(4,n),o[8]=8,o[9]=6,o[10]=0,o[11]=0,o[12]=0,s.push(qg("IHDR",o)),s.push(qg("IDAT",i)),s.push(qg("IEND",new Uint8Array(0)));const c=s.reduce((e,t)=>e+t.byteLength,0),d=new Uint8Array(c);let u=0;for(const p of s)d.set(p,u),u+=p.byteLength;const h=new Blob([d],{type:"image/png"});return new Promise((e,t)=>{const n=new FileReader;n.onload=()=>e(n.result),n.onerror=t,n.readAsDataURL(h)})}function qg(e,t){const n=new Uint8Array(8+t.byteLength+4),a=new DataView(n.buffer);a.setUint32(0,t.byteLength);for(let i=0;i<4;i++)n[4+i]=e.charCodeAt(i);n.set(t,8);const r=n.subarray(4,8+t.byteLength);return a.setUint32(8+t.byteLength,function(e){let t=4294967295;for(let n=0;n<e.byteLength;n++)t=Kg[255&(t^e[n])]^t>>>8;return(4294967295^t)>>>0}(r)),n}const Kg=[];!function(){for(let e=0;e<256;e++){let t=e;for(let e=0;e<8;e++)t=1&t?3988292384^t>>>1:t>>>1;Kg[e]=t}}();const Yg=[{label:"Free",ratio:null},{label:"1:1",ratio:1},{label:"4:3",ratio:4/3},{label:"16:9",ratio:16/9},{label:"2.35:1",ratio:2.35},{label:"9:16",ratio:9/16},{label:"3:4",ratio:3/4}];function Jg({imageData:e,mode:t,initialMask:n,initialCrop:a,initialPaint:r,onSave:i,onCancel:s}){const[o,l]=Tt.useState(t),[c,d]=Tt.useState(null),[u,h]=Tt.useState({x:0,y:0,width:0,height:0}),[p,m]=Tt.useState(!1),[f,g]=Tt.useState({x:0,y:0}),[v,y]=Tt.useState(!1),[x,b]=Tt.useState(!1),[_,w]=Tt.useState(null),[S,M]=Tt.useState({x:0,y:0}),[C,E]=Tt.useState({x:0,y:0,width:0,height:0}),[k,T]=Tt.useState(!1),[N,P]=Tt.useState(20),[j,A]=Tt.useState(.8),[R,I]=Tt.useState("add"),[L,D]=Tt.useState(!1),[U,O]=Tt.useState("#ff0000"),[F,z]=Tt.useState(15),[B,H]=Tt.useState("paint"),[$,V]=Tt.useState(null),W=Tt.useRef(null),G=Tt.useRef(null),X=Tt.useRef(null),q=Tt.useRef(null),K=Tt.useRef(null),Y=Tt.useRef(null),J=Tt.useRef(null),[Z,Q]=Tt.useState({width:0,height:0}),[ee,te]=Tt.useState(1),ne=Tt.useCallback(()=>{const e=X.current;if(!e)return;const t=W.current;if(!t)return;const i=t.clientWidth-40,s=t.clientHeight-40,o=e.naturalWidth/e.naturalHeight;let l,c;o>i/s?(l=i,c=i/o):(c=s,l=s*o),Q({width:l,height:c});const d=l/e.naturalWidth;te(d),h(a?{x:a.x*l,y:a.y*c,width:a.width*l,height:a.height*c}:{x:0,y:0,width:l,height:c});const u=q.current;if(u){u.width=e.naturalWidth,u.height=e.naturalHeight;const t=u.getContext("2d");if(t&&(t.fillStyle="black",t.fillRect(0,0,u.width,u.height),n)){const e=new Image;e.onload=()=>{t.drawImage(e,0,0,u.width,u.height);const n=K.current;if(n){const e=n.getContext("2d");if(e){const a=t.getImageData(0,0,u.width,u.height),r=e.createImageData(n.width,n.height);for(let e=0;e<n.height;e++)for(let t=0;t<n.width;t++){const i=Math.floor(t/d),s=4*(Math.floor(e/d)*u.width+i),o=4*(e*n.width+t),l=a.data[s];l>0&&(r.data[o]=255,r.data[o+1]=50,r.data[o+2]=50,r.data[o+3]=Math.floor(.8*l))}e.putImageData(r,0,0)}}},e.src=n}}const p=K.current;p&&(p.width=l,p.height=c);const m=Y.current;if(m){m.width=e.naturalWidth,m.height=e.naturalHeight;const t=m.getContext("2d");if(t&&(t.clearRect(0,0,m.width,m.height),r)){const e=new Image;e.onload=()=>{t.drawImage(e,0,0,m.width,m.height);const n=J.current;if(n){const t=n.getContext("2d");t&&(t.clearRect(0,0,n.width,n.height),t.drawImage(e,0,0,n.width,n.height))}},e.src=r}}const f=J.current;f&&(f.width=l,f.height=c)},[n,a,r]),ae=Tt.useCallback(e=>{const t=G.current;if(!t)return{x:0,y:0};const n=t.getBoundingClientRect();return{x:e.clientX-n.left,y:e.clientY-n.top}},[]),re=Tt.useCallback(e=>{e.preventDefault();const t=ae(e),n=t.x>=u.x-10&&t.x<=u.x+10&&t.y>=u.y-10&&t.y<=u.y+10,a=t.x>=u.x+u.width-10&&t.x<=u.x+u.width+10&&t.y>=u.y-10&&t.y<=u.y+10,r=t.x>=u.x-10&&t.x<=u.x+10&&t.y>=u.y+u.height-10&&t.y<=u.y+u.height+10,i=t.x>=u.x+u.width-10&&t.x<=u.x+u.width+10&&t.y>=u.y+u.height-10&&t.y<=u.y+u.height+10;n?(b(!0),w("tl"),E(u),g(t)):a?(b(!0),w("tr"),E(u),g(t)):r?(b(!0),w("bl"),E(u),g(t)):i?(b(!0),w("br"),E(u),g(t)):t.x>=u.x&&t.x<=u.x+u.width&&t.y>=u.y&&t.y<=u.y+u.height&&u.width>10?(y(!0),M(t),E(u)):(m(!0),g(t),h({x:t.x,y:t.y,width:0,height:0}))},[u,ae]),ie=Tt.useCallback(e=>{const t=ae(e);if(p){let e=t.x-f.x,n=t.y-f.y;if(null!==c){const t=Math.abs(e),a=Math.abs(n);t/c>a?n=n>0?t/c:-t/c:e=e>0?a*c:-a*c}h({x:e<0?f.x+e:f.x,y:n<0?f.y+n:f.y,width:Math.abs(e),height:Math.abs(n)})}else if(v){const e=t.x-S.x,n=t.y-S.y;let a=Math.max(0,Math.min(C.x+e,Z.width-C.width)),r=Math.max(0,Math.min(C.y+n,Z.height-C.height));h({x:a,y:r,width:C.width,height:C.height})}else if(x&&_){let e=C.x,n=C.y,a=C.width,r=C.height;switch(_){case"br":a=t.x-C.x,r=t.y-C.y;break;case"tr":a=t.x-C.x,r=C.y+C.height-t.y,n=t.y;break;case"bl":a=C.x+C.width-t.x,r=t.y-C.y,e=t.x;break;case"tl":a=C.x+C.width-t.x,r=C.y+C.height-t.y,e=t.x,n=t.y}null!==c&&("br"===_||"tl"===_?(r=a/c,"tl"===_&&(n=C.y+C.height-r)):(r=a/c,"tr"===_&&(n=C.y+C.height-r))),a>10&&r>10&&(e=Math.max(0,Math.min(e,Z.width-10)),n=Math.max(0,Math.min(n,Z.height-10)),a=Math.min(a,Z.width-e),r=Math.min(r,Z.height-n),h({x:e,y:n,width:a,height:r}))}},[p,v,x,_,f,S,C,c,Z,ae]),se=Tt.useCallback(()=>{m(!1),y(!1),b(!1),w(null)},[]),oe=Tt.useCallback(e=>{const t=K.current;if(!t)return null;const n=t.getBoundingClientRect(),a=e.clientX-n.left,r=e.clientY-n.top;return{x:a/ee,y:r/ee}},[ee]),le=Tt.useCallback(e=>{const t=oe(e);if(!t)return;const n=K.current,a=q.current;if(!n||!a)return;const r=n.getContext("2d"),i=a.getContext("2d");if(!r||!i)return;const s=t.x*ee,o=t.y*ee,l=N;"add"===R?(r.beginPath(),r.arc(s,o,l/2,0,2*Math.PI),r.fillStyle=`rgba(255, 50, 50, ${j})`,r.fill(),i.beginPath(),i.arc(t.x,t.y,N/ee/2,0,2*Math.PI),i.fillStyle="white",i.fill()):(r.globalCompositeOperation="destination-out",r.beginPath(),r.arc(s,o,l/2,0,2*Math.PI),r.fill(),r.globalCompositeOperation="source-over",i.beginPath(),i.arc(t.x,t.y,N/ee/2,0,2*Math.PI),i.fillStyle="black",i.fill())},[oe,N,j,R,ee]),ce=Tt.useCallback(e=>{e.preventDefault(),T(!0),le(e)},[le]),de=Tt.useCallback(e=>{k&&le(e)},[k,le]),ue=Tt.useCallback(()=>{T(!1)},[]),he=Tt.useCallback(e=>{const t=J.current;if(!t)return null;const n=t.getBoundingClientRect(),a=e.clientX-n.left,r=e.clientY-n.top;return{x:a/ee,y:r/ee}},[ee]),pe=Tt.useCallback((e,t)=>{const n=Y.current,a=J.current;if(!n||!a)return;const r=n.getContext("2d"),i=a.getContext("2d");if(!r||!i)return;const s=F/ee;if("paint"===B){r.lineCap="round",r.lineJoin="round",r.lineWidth=s,r.strokeStyle=U,r.fillStyle=U,e?(r.beginPath(),r.moveTo(e.x,e.y),r.lineTo(t.x,t.y),r.stroke()):(r.beginPath(),r.arc(t.x,t.y,s/2,0,2*Math.PI),r.fill()),i.lineCap="round",i.lineJoin="round",i.lineWidth=F,i.strokeStyle=U,i.fillStyle=U;const n=e?{x:e.x*ee,y:e.y*ee}:null,a={x:t.x*ee,y:t.y*ee};n?(i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(a.x,a.y),i.stroke()):(i.beginPath(),i.arc(a.x,a.y,F/2,0,2*Math.PI),i.fill())}else{r.globalCompositeOperation="destination-out",r.lineCap="round",r.lineJoin="round",r.lineWidth=s,e?(r.beginPath(),r.moveTo(e.x,e.y),r.lineTo(t.x,t.y),r.stroke()):(r.beginPath(),r.arc(t.x,t.y,s/2,0,2*Math.PI),r.fill()),r.globalCompositeOperation="source-over",i.globalCompositeOperation="destination-out",i.lineCap="round",i.lineJoin="round",i.lineWidth=F;const n=e?{x:e.x*ee,y:e.y*ee}:null,a={x:t.x*ee,y:t.y*ee};n?(i.beginPath(),i.moveTo(n.x,n.y),i.lineTo(a.x,a.y),i.stroke()):(i.beginPath(),i.arc(a.x,a.y,F/2,0,2*Math.PI),i.fill()),i.globalCompositeOperation="source-over"}},[F,B,U,ee]),me=Tt.useCallback(e=>{e.preventDefault();const t=he(e);t&&(D(!0),V(t),pe(null,t))},[he,pe]),fe=Tt.useCallback(e=>{if(!L)return;const t=he(e);t&&(pe($,t),V(t))},[L,he,$,pe]),ge=Tt.useCallback(()=>{D(!1),V(null)},[]),ve=Tt.useCallback(()=>{const e=Y.current,t=J.current;if(!e||!t)return;const n=e.getContext("2d"),a=t.getContext("2d");n&&a&&(n.clearRect(0,0,e.width,e.height),a.clearRect(0,0,t.width,t.height))},[]),ye=Tt.useCallback(()=>Math.abs(u.x)<2&&Math.abs(u.y)<2&&Math.abs(u.width-Z.width)<2&&Math.abs(u.height-Z.height)<2,[u,Z]),xe=Tt.useCallback(async()=>{const e=X.current,t=q.current,n=Y.current;if(!e)return console.error("[CropMaskEditor] No image ref"),void s();const a=!ye(),r=!!t&&function(e){const t=e.getContext("2d");if(!t)return!1;const n=t.getImageData(0,0,e.width,e.height).data;for(let a=0;a<n.length;a+=4)if(n[a]>0)return!0;return!1}(t),o=!!n&&function(e){const t=e.getContext("2d");if(!t)return!1;const n=t.getImageData(0,0,e.width,e.height).data;for(let a=3;a<n.length;a+=4)if(n[a]>0)return!0;return!1}(n);if(console.log("[CropMaskEditor] handleSave - hasPaint:",o,"hasMask:",r,"hasCrop:",a),console.log("[CropMaskEditor] handleSave - cropRect:",u),console.log("[CropMaskEditor] handleSave - imageSize:",Z),!a&&!r&&!o)return console.log("[CropMaskEditor] No changes detected, closing without saving"),void i(null,null,null,null);const l=a?{x:u.x/Z.width,y:u.y/Z.height,width:u.width/Z.width,height:u.height/Z.height}:null,c=u.x/ee,d=u.y/ee,h=u.width/ee,p=u.height/ee,m=document.createElement("canvas");m.width=e.naturalWidth,m.height=e.naturalHeight;const f=m.getContext("2d");if(!f)return console.error("[CropMaskEditor] Failed to create base canvas context"),void s();f.drawImage(e,0,0),o&&n&&(console.log("[CropMaskEditor] Applying paint layer"),f.drawImage(n,0,0));const g=o&&n?n.toDataURL("image/png"):null,v=r&&t?t.toDataURL("image/png"):null;let y="";if(a){console.log("[CropMaskEditor] Applying crop");const n=document.createElement("canvas");n.width=h,n.height=p;const a=n.getContext("2d");if(!a)return console.error("[CropMaskEditor] Failed to create cropped canvas context"),void s();if(a.drawImage(m,Math.max(0,c),Math.max(0,d),Math.min(h,e.naturalWidth-c),Math.min(p,e.naturalHeight-d),0,0,n.width,n.height),r&&t){console.log("[CropMaskEditor] Baking mask into alpha (post-crop, manual PNG encoder)");const e=a.getImageData(0,0,n.width,n.height).data,r=document.createElement("canvas");r.width=h,r.height=p;const i=r.getContext("2d");if(i){i.drawImage(t,Math.max(0,c),Math.max(0,d),Math.min(h,t.width-c),Math.min(p,t.height-d),0,0,r.width,r.height);const a=i.getImageData(0,0,r.width,r.height).data;for(let t=0;t<e.length;t+=4)e[t+3]=255-a[t];y=await Xg(e,n.width,n.height)}else y=n.toDataURL("image/png")}else y=n.toDataURL("image/png")}else if(r&&t){console.log("[CropMaskEditor] Baking mask into alpha (no crop, manual PNG encoder)");const e=f.getImageData(0,0,m.width,m.height).data,n=t.getContext("2d");if(!n)return console.error("[CropMaskEditor] Failed to get mask context"),void s();const a=n.getImageData(0,0,t.width,t.height).data;for(let t=0;t<e.length;t+=4)e[t+3]=255-a[t];y=await Xg(e,m.width,m.height)}else y=m.toDataURL("image/png");console.log("[CropMaskEditor] Result length:",y.length),i(y,v,l,g)},[u,Z,ee,ye,i,s]),be=Tt.useCallback(()=>{const e=q.current,t=K.current;if(!e||!t)return;const n=e.getContext("2d"),a=t.getContext("2d");n&&a&&(n.fillStyle="black",n.fillRect(0,0,e.width,e.height),a.clearRect(0,0,t.width,t.height))},[]),_e=Tt.useCallback(e=>{if(d(e),u.width>0&&u.height>0&&null!==e){const t=u.width/u.height,n=u.x+u.width/2,a=u.y+u.height/2;let r=u.width,i=u.height;t>e?i=r/e:r=i*e,r=Math.min(r,Z.width),i=Math.min(i,Z.height);let s=n-r/2,o=a-i/2;s=Math.max(0,Math.min(s,Z.width-r)),o=Math.max(0,Math.min(o,Z.height-i)),h({x:s,y:o,width:r,height:i})}},[u,Z]),we=Tt.useCallback(()=>{h({x:0,y:0,width:Z.width,height:Z.height}),d(null)},[Z]);return Ut.jsx("div",{className:"crop-mask-editor-overlay",children:Ut.jsxs("div",{className:"crop-mask-editor-modal",children:[Ut.jsxs("div",{className:"crop-mask-editor-header",children:[Ut.jsx("h3",{children:"crop"===o?"Crop Image":"mask"===o?"Edit Mask":"Paint on Image"}),Ut.jsxs("div",{className:"mode-toggle",children:[Ut.jsx("button",{className:"crop"===o?"active":"",onClick:()=>l("crop"),children:" Crop"}),Ut.jsx("button",{className:"mask"===o?"active":"",onClick:()=>l("mask"),children:" Mask"}),Ut.jsx("button",{className:"paint"===o?"active":"",onClick:()=>l("paint"),children:" Paint"})]}),Ut.jsx("button",{className:"close-btn",onClick:s,children:""})]}),Ut.jsxs("div",{className:"crop-mask-editor-toolbar",children:["crop"===o&&Ut.jsxs("div",{className:"crop-toolbar",children:[Ut.jsx("span",{children:"Aspect Ratio:"}),Ut.jsx("div",{className:"aspect-presets",children:Yg.map(e=>Ut.jsx("button",{className:c===e.ratio?"active":"",onClick:()=>_e(e.ratio),children:e.label},e.label))}),Ut.jsx("button",{className:"reset-crop-btn",onClick:we,title:"Reset crop to full image",children:" Reset"})]}),"mask"===o&&Ut.jsxs("div",{className:"mask-toolbar",children:[Ut.jsxs("div",{className:"brush-controls",children:[Ut.jsxs("label",{children:["Size:",Ut.jsx("input",{type:"range",min:"5",max:"100",value:N,onChange:e=>P(Number(e.target.value))}),Ut.jsxs("span",{children:[N,"px"]})]}),Ut.jsxs("label",{children:["Opacity:",Ut.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.1",value:j,onChange:e=>A(Number(e.target.value))}),Ut.jsxs("span",{children:[Math.round(100*j),"%"]})]})]}),Ut.jsxs("div",{className:"brush-modes",children:[Ut.jsx("button",{className:"add"===R?"active":"",onClick:()=>I("add"),children:" Add"}),Ut.jsx("button",{className:"erase"===R?"active":"",onClick:()=>I("erase"),children:" Erase"}),Ut.jsx("button",{onClick:be,children:" Clear"})]})]}),"paint"===o&&Ut.jsxs("div",{className:"paint-toolbar",children:[Ut.jsxs("div",{className:"brush-controls",children:[Ut.jsxs("label",{children:["Size:",Ut.jsx("input",{type:"range",min:"1",max:"100",value:F,onChange:e=>z(Number(e.target.value))}),Ut.jsxs("span",{children:[F,"px"]})]}),Ut.jsxs("label",{className:"color-picker-label",children:["Color:",Ut.jsx("input",{type:"color",value:U,onChange:e=>O(e.target.value),className:"color-picker"}),Ut.jsx("span",{className:"color-preview",style:{backgroundColor:U}})]})]}),Ut.jsxs("div",{className:"brush-modes",children:[Ut.jsx("button",{className:"paint"===B?"active":"",onClick:()=>H("paint"),children:" Paint"}),Ut.jsx("button",{className:"erase"===B?"active":"",onClick:()=>H("erase"),children:" Erase"}),Ut.jsx("button",{onClick:ve,children:" Clear"})]})]})]}),Ut.jsxs("div",{className:"crop-mask-editor-canvas",ref:W,children:[Ut.jsxs("div",{ref:G,className:"image-wrapper",style:{width:Z.width,height:Z.height,position:"relative"},children:[Ut.jsx("img",{ref:X,src:e,alt:"Source",onLoad:ne,style:{width:"100%",height:"100%",display:"block"}}),Ut.jsx("canvas",{ref:K,className:"mask-display-canvas",style:{display:"mask"===o?"block":"none",position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"mask"===o?"auto":"none"},onMouseDown:ce,onMouseMove:de,onMouseUp:ue,onMouseLeave:ue}),Ut.jsx("canvas",{ref:J,className:"paint-display-canvas",style:{display:"block",position:"absolute",left:0,top:0,width:"100%",height:"100%",pointerEvents:"paint"===o?"auto":"none"},onMouseDown:me,onMouseMove:fe,onMouseUp:ge,onMouseLeave:ge}),"crop"===o&&Ut.jsxs("div",{className:"crop-overlay",onMouseDown:re,onMouseMove:ie,onMouseUp:se,onMouseLeave:se,children:[Ut.jsx("div",{className:"crop-darken",style:{clipPath:`polygon(\n                    0 0, 100% 0, 100% 100%, 0 100%,\n                    0 ${u.y}px,\n                    ${u.x}px ${u.y}px,\n                    ${u.x}px ${u.y+u.height}px,\n                    ${u.x+u.width}px ${u.y+u.height}px,\n                    ${u.x+u.width}px ${u.y}px,\n                    ${u.x}px ${u.y}px,\n                    0 ${u.y}px\n                  )`}}),Ut.jsx("div",{className:"crop-rect",style:{left:u.x,top:u.y,width:u.width,height:u.height},children:Ut.jsxs("div",{className:"crop-handles",children:[Ut.jsx("div",{className:"crop-handle tl"}),Ut.jsx("div",{className:"crop-handle tr"}),Ut.jsx("div",{className:"crop-handle bl"}),Ut.jsx("div",{className:"crop-handle br"})]})})]})]}),Ut.jsx("canvas",{ref:q,className:"mask-canvas",style:{display:"none"}}),Ut.jsx("canvas",{ref:Y,className:"paint-canvas",style:{display:"none"}})]}),Ut.jsxs("div",{className:"crop-mask-editor-footer",children:[Ut.jsx("div",{className:"crop-info",children:"crop"===o&&u.width>0&&Ut.jsxs("span",{children:[Math.round(u.width/ee),"  ",Math.round(u.height/ee)," px"]})}),Ut.jsxs("div",{className:"action-buttons",children:[Ut.jsx("button",{className:"cancel-btn",onClick:s,children:"Cancel"}),Ut.jsx("button",{className:"save-btn",onClick:xe,children:"crop"===o?"Apply Crop":"mask"===o?"Save Mask":"Apply Changes"})]})]})]})})}function Zg({originalImage:e,cropRect:t,displayMask:n}){const a=Tt.useRef(null),[r,i]=Tt.useState(null);return Tt.useEffect(()=>{if(!t)return void i(e);const n=new Image;n.onload=()=>{const e=t.x*n.naturalWidth,a=t.y*n.naturalHeight,r=t.width*n.naturalWidth,s=t.height*n.naturalHeight,o=document.createElement("canvas");o.width=r,o.height=s;const l=o.getContext("2d");l&&(l.drawImage(n,e,a,r,s,0,0,r,s),i(o.toDataURL("image/png")))},n.src=e},[e,t]),Ut.jsxs("div",{ref:a,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%"},children:[r&&Ut.jsx("img",{src:r,alt:"Preview",style:{width:"100%",height:"100%",objectFit:"contain"}}),n&&Ut.jsx(Qg,{maskData:n})]})}function Qg({maskData:e}){const t=Tt.useRef(null);return Tt.useEffect(()=>{const n=t.current;if(!n)return;const a=n.getContext("2d");if(!a)return;const r=new Image;r.onload=()=>{n.width=r.width,n.height=r.height,a.drawImage(r,0,0);const e=a.getImageData(0,0,n.width,n.height).data,t=a.createImageData(n.width,n.height);for(let n=0;n<e.length;n+=4){const a=e[n];a>10?(t.data[n]=255,t.data[n+1]=50,t.data[n+2]=50,t.data[n+3]=Math.floor(.6*a)):(t.data[n]=0,t.data[n+1]=0,t.data[n+2]=0,t.data[n+3]=0)}a.clearRect(0,0,n.width,n.height),a.putImageData(t,0,0)},r.src=e},[e]),Ut.jsx("canvas",{ref:t,className:"mask-overlay"})}function ev({name:e,displayName:t,value:n,onChange:a,onBrowse:r,disabled:i=!1,acceptType:s="image",isBypassed:o=!1,onBypassChange:l,comfyUrl:c}){const[d,u]=Tt.useState(!1),[h,p]=Tt.useState(!1),[m,f]=Tt.useState(null),g=Tt.useRef(null),v=Tt.useCallback(()=>{switch(s){case"image":default:return"image/*";case"video":return"video/*";case"any":return"image/*,video/*"}},[s]),y=Tt.useCallback(e=>{const t=e.type.startsWith("image/"),n=e.type.startsWith("video/");switch(s){case"image":default:return t;case"video":return n;case"any":return t||n}},[s]),x=Tt.useCallback(e=>{console.log("[DropZone] DragEnter fired"),e.preventDefault(),e.stopPropagation(),i||(u(!0),p(!0))},[i]),b=Tt.useCallback(e=>{console.log("[DropZone] DragLeave fired"),e.preventDefault(),e.stopPropagation(),p(!1),u(!1)},[]),_=Tt.useCallback(e=>{e.preventDefault(),e.stopPropagation()},[]),w=Tt.useCallback(t=>{if(!y(t))return;const n=t.type.startsWith("video/");f(n?"video":"image"),A(null),I(null),D(null),O(null),z(null);const r=new FileReader;r.onload=t=>{var n;(null==(n=t.target)?void 0:n.result)&&a(e,t.target.result)},r.readAsDataURL(t)},[y,e,a]),S=Tt.useCallback(async t=>{if(console.log("[DropZone] Drop fired!"),t.preventDefault(),t.stopPropagation(),u(!1),p(!1),i)return void console.log("[DropZone] Drop ignored - disabled");console.log("[DropZone] Drop data types:",t.dataTransfer.types),console.log("[DropZone] Drop text data:",t.dataTransfer.getData("text/plain").substring(0,100));const n=t.dataTransfer.files;if(n.length>0)return void w(n[0]);const r=t.dataTransfer.getData("text/plain");if(r){A(null),I(null),D(null),O(null),z(null),f("video"===s?"video":"image");try{const t=JSON.parse(r),n="";if(t.url&&"string"==typeof t.url){console.log("[DropZone] Fetching media from URL:",t.url.substring(0,80));const r=t.url.toLowerCase();[".mp4",".mov",".avi",".webm",".mkv"].some(e=>r.includes(e))&&f("video");try{const n=await fetch(t.url);if(n.ok){const t=await n.blob();console.log("[DropZone] Got blob via direct fetch, size:",t.size);const r=new FileReader;return r.onload=()=>{console.log("[DropZone] FileReader loaded, calling onChange"),a(e,r.result)},r.onerror=e=>{console.error("[DropZone] FileReader error:",e)},void r.readAsDataURL(t)}}catch(o){console.log("[DropZone] Direct fetch failed (likely CORS), trying CPE proxy...");try{const r=await fetch(`${n}/api/fetch-image?url=${encodeURIComponent(t.url)}`),i=await r.json();if(i.success&&i.dataUrl)return console.log("[DropZone] Successfully fetched via CPE proxy"),void a(e,i.dataUrl);console.warn("[DropZone] CPE proxy failed:",i.message)}catch(l){console.warn("[DropZone] CPE proxy error:",l)}}}if(t.filePath&&"string"==typeof t.filePath){console.log("[DropZone] Trying CPE backend for filePath:",t.filePath);const r=await fetch(`${n}/api/read-image?path=${encodeURIComponent(t.filePath)}`),i=await r.json();if(i.success&&i.dataUrl)return void a(e,i.dataUrl)}}catch(c){console.warn("[DropZone] Error parsing/handling dropped data:",c)}r.startsWith("data:")&&a(e,r)}},[i,e,a,w]),M=Tt.useCallback(e=>{const t=e.target.files;t&&t.length>0&&w(t[0])},[w]),C=Tt.useCallback(()=>{var e;r?r():null==(e=g.current)||e.click()},[r]),E=Tt.useCallback(()=>{a(e,null),f(null),A(null),I(null),D(null),O(null),z(null)},[e,a]),[k,T]=Tt.useState(!1),[N,P]=Tt.useState("crop"),[j,A]=Tt.useState(null),[R,I]=Tt.useState(null),[L,D]=Tt.useState(null),[U,O]=Tt.useState(null),[F,z]=Tt.useState(null),B=Tt.useCallback(()=>{console.log("[ImageDropZone] handleCropClick called, value:",n?n.substring(0,50)+"...":"null"),console.log("[ImageDropZone] originalImage exists:",!!j),n&&!j&&(console.log("[ImageDropZone] Storing original image"),A(n)),P("crop"),T(!0)},[n,j]),H=Tt.useCallback(()=>{console.log("[ImageDropZone] handleMaskClick called, value:",n?n.substring(0,50)+"...":"null"),console.log("[ImageDropZone] originalImage exists:",!!j),n&&!j&&(console.log("[ImageDropZone] Storing original image"),A(n)),P("mask"),T(!0)},[n,j]),$=Tt.useCallback(()=>{console.log("[ImageDropZone] handlePaintClick called, value:",n?n.substring(0,50)+"...":"null"),console.log("[ImageDropZone] originalImage exists:",!!j),n&&!j&&(console.log("[ImageDropZone] Storing original image"),A(n)),P("paint"),T(!0)},[n,j]),V=Tt.useCallback((e,t,n)=>new Promise(a=>{if(!t)return void a(e);const r=new Image;r.onload=()=>{const n=new Image;n.onload=()=>{const i=t.x*r.naturalWidth,s=t.y*r.naturalHeight,o=t.width*r.naturalWidth,l=t.height*r.naturalHeight,c=document.createElement("canvas");c.width=o,c.height=l;const d=c.getContext("2d");d?(d.drawImage(n,i,s,o,l,0,0,o,l),a(c.toDataURL("image/png"))):a(e)},n.src=e},r.src=n}),[]),W=Tt.useCallback(async(t,n,r,i)=>{if(console.log("[ImageDropZone] handleCropMaskSave called"),console.log("[ImageDropZone] processedImage:",t?t.substring(0,50)+"...":"null"),console.log("[ImageDropZone] rawMaskData:",n?n.substring(0,50)+"...":"null"),console.log("[ImageDropZone] rawPaintData:",i?i.substring(0,50)+"...":"null"),console.log("[ImageDropZone] newCropRect:",r),!(t||n||r||i))return console.log("[ImageDropZone] No changes detected, closing dialog"),void T(!1);if(void 0!==r&&O(r),void 0!==n)if(I(n),n&&j){const e=await V(n,r,j);z(e)}else z(n);void 0!==i&&D(i),t&&(console.log("[ImageDropZone] Calling onChange with processed image"),a(e,t)),T(!1)},[e,a,j,V]),G=Tt.useCallback(()=>{T(!1)},[]),X=(null==n?void 0:n.startsWith("data:video"))?"video":m||"image",q=(()=>{switch(s){case"video":return{icon:"",text:d?"Drop video here":"Drag video or browse"};case"any":return{icon:"",text:d?"Drop media here":"Drag image/video or browse"};default:return{icon:"",text:d?"Drop image here":"Drag image from canvas or browse"}}})();return Ut.jsxs("div",{className:"image-drop-zone-container "+(o?"bypassed":""),children:[Ut.jsxs("div",{className:"image-drop-zone-header",children:[Ut.jsx("label",{className:"image-drop-zone-label",children:t}),l&&Ut.jsxs("label",{className:"bypass-toggle",title:o?"Enable this input":"Bypass this input (skip in workflow)",children:[Ut.jsx("input",{type:"checkbox",checked:o,onChange:e=>l(e.target.checked)}),Ut.jsx("span",{className:"bypass-label",children:o?"Bypassed":"Active"})]})]}),o?Ut.jsx("div",{className:"image-drop-zone bypassed-placeholder",children:Ut.jsxs("div",{className:"bypassed-content",children:[Ut.jsx("div",{className:"bypassed-icon",children:""}),Ut.jsx("div",{className:"bypassed-text",children:"Input bypassed"}),Ut.jsx("div",{className:"bypassed-hint",children:"This input will be skipped"})]})}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{className:`image-drop-zone ${h?"drag-over":""} ${n?"has-image":""} ${i?"disabled":""}`,onDragEnter:x,onDragLeave:b,onDragOver:_,onDrop:S,children:n?Ut.jsxs("div",{className:"image-preview",children:["video"===X?Ut.jsx("video",{src:n,controls:!0,muted:!0,style:{width:"100%",height:"100%",objectFit:"contain"}}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("img",{src:n,alt:t,style:{opacity:R?0:1}}),R&&j&&Ut.jsx(Zg,{originalImage:j,cropRect:U,displayMask:F})]}),Ut.jsxs("div",{className:"image-preview-actions",children:[Ut.jsx("button",{className:"image-action-btn crop-btn",onClick:B,disabled:i||"video"===X,title:"Crop image",children:""}),Ut.jsx("button",{className:"image-action-btn mask-btn",onClick:H,disabled:i||"video"===X,title:"Add mask",children:""}),Ut.jsx("button",{className:"image-action-btn paint-btn",onClick:$,disabled:i||"video"===X,title:"Paint on image",children:""}),Ut.jsx("button",{className:"image-action-btn clear-btn",onClick:E,disabled:i,title:"Remove media",children:""})]})]}):Ut.jsxs("div",{className:"drop-placeholder",children:[Ut.jsx("div",{className:"drop-icon",children:q.icon}),Ut.jsx("div",{className:"drop-text",children:q.text}),Ut.jsx("div",{className:"drop-actions",children:Ut.jsx("button",{className:"browse-btn",onClick:C,disabled:i,children:"Browse..."})})]})}),Ut.jsx("input",{ref:g,type:"file",accept:v(),onChange:M,style:{display:"none"}})]}),k&&n&&Ut.jsx(Jg,{imageData:j||n,mode:N,initialMask:R,initialCrop:U,initialPaint:L,onSave:W,onCancel:G})]})}const tv=["front","front-right quarter","right side","back-right quarter","back","back-left quarter","left side","front-left quarter"],nv=["low-angle","eye-level","elevated","high-angle"],av=["close-up","medium","wide"];function rv(e){return`<sks> ${e.direction} view ${e.height} shot ${e.size} shot`}function iv(e){return`${e.direction.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")} ${e.height.split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join("-")} ${e.size.charAt(0).toUpperCase()+e.size.slice(1)}`}const sv=function(){const e=[];for(const t of tv)for(const n of nv)for(const a of av){const r=`${t.replace(/\s+/g,"-")}_${n}_${a}`,i=rv({direction:t,height:n,size:a}),s=iv({direction:t,height:n,size:a});e.push({id:r,direction:t,height:n,size:a,prompt:i,displayName:s})}return e}();function ov(e){const t=e.match(/^<sks>\s+([\w\s-]+?)\s+view\s+([\w-]+?)\s+shot\s+([\w-]+?)\s+shot/i);if(!t)return null;const[,n,a,r]=t,i=function(e){const t=e.replace(/-/g," ").replace(/\s+/g," ").trim(),n=tv.find(e=>{const n=e.toLowerCase();return t===n});return n||null}(n.toLowerCase().trim()),s=function(e){const t=nv.find(t=>t.toLowerCase()===e);return t||null}(a.toLowerCase().trim()),o=function(e){const t=av.find(t=>t.toLowerCase()===e);return t||null}(r.toLowerCase().trim());return i&&s&&o?function(e,t,n){return sv.find(a=>a.direction===e&&a.height===t&&a.size===n)}(i,s,o)??null:null}function lv(e){return e.replace(/^<sks>\s+[\w\s-]+?\s+view\s+[\w-]+?\s+shot\s+[\w-]+?\s+shot\s*/i,"").trim()}
/**
 * @license
 * Copyright 2010-2023 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
const cv="162",dv=0,uv=1,hv=2,pv=0,mv=1,fv=2,gv=3,vv=0,yv=1,xv=2,bv=100,_v=101,wv=102,Sv=200,Mv=201,Cv=202,Ev=203,kv=204,Tv=205,Nv=206,Pv=207,jv=208,Av=209,Rv=210,Iv=211,Lv=212,Dv=213,Uv=214,Ov=301,Fv=302,zv=306,Bv=1e3,Hv=1001,$v=1002,Vv=1003,Wv=1004,Gv=1005,Xv=1006,qv=1007,Kv=1008,Yv=1009,Jv=1012,Zv=1013,Qv=1014,ey=1015,ty=1016,ny=1020,ay=1023,ry=1026,iy=1027,sy=33776,oy=33777,ly=33778,cy=33779,dy=36492,uy="",hy="srgb",py="srgb-linear",my="display-p3",fy="display-p3-linear",gy="linear",vy="srgb",yy="rec709",xy="p3",by=7680,_y=512,wy=513,Sy=514,My=515,Cy=516,Ey=517,ky=518,Ty=519,Ny="300 es",Py=1035,jy=2e3,Ay=2001;class Ry{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const n=this._listeners[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const n=t.slice(0);for(let t=0,a=n.length;t<a;t++)n[t].call(this,e);e.target=null}}}const Iy=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],Ly=Math.PI/180,Dy=180/Math.PI;function Uy(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,a=4294967295*Math.random()|0;return(Iy[255&e]+Iy[e>>8&255]+Iy[e>>16&255]+Iy[e>>24&255]+"-"+Iy[255&t]+Iy[t>>8&255]+"-"+Iy[t>>16&15|64]+Iy[t>>24&255]+"-"+Iy[63&n|128]+Iy[n>>8&255]+"-"+Iy[n>>16&255]+Iy[n>>24&255]+Iy[255&a]+Iy[a>>8&255]+Iy[a>>16&255]+Iy[a>>24&255]).toLowerCase()}function Oy(e,t,n){return Math.max(t,Math.min(n,e))}function Fy(e,t,n){return(1-n)*e+n*t}function zy(e){return!(e&e-1)&&0!==e}function By(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}function Hy(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function $y(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const Vy=Ly;class Wy{constructor(e=0,t=0){Wy.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,a=e.elements;return this.x=a[0]*t+a[3]*n+a[6],this.y=a[1]*t+a[4]*n+a[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Oy(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),a=Math.sin(t),r=this.x-e.x,i=this.y-e.y;return this.x=r*n-i*a+e.x,this.y=r*a+i*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Gy{constructor(e,t,n,a,r,i,s,o,l){Gy.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,n,a,r,i,s,o,l)}set(e,t,n,a,r,i,s,o,l){const c=this.elements;return c[0]=e,c[1]=a,c[2]=s,c[3]=t,c[4]=r,c[5]=o,c[6]=n,c[7]=i,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,a=t.elements,r=this.elements,i=n[0],s=n[3],o=n[6],l=n[1],c=n[4],d=n[7],u=n[2],h=n[5],p=n[8],m=a[0],f=a[3],g=a[6],v=a[1],y=a[4],x=a[7],b=a[2],_=a[5],w=a[8];return r[0]=i*m+s*v+o*b,r[3]=i*f+s*y+o*_,r[6]=i*g+s*x+o*w,r[1]=l*m+c*v+d*b,r[4]=l*f+c*y+d*_,r[7]=l*g+c*x+d*w,r[2]=u*m+h*v+p*b,r[5]=u*f+h*y+p*_,r[8]=u*g+h*x+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],a=e[2],r=e[3],i=e[4],s=e[5],o=e[6],l=e[7],c=e[8];return t*i*c-t*s*l-n*r*c+n*s*o+a*r*l-a*i*o}invert(){const e=this.elements,t=e[0],n=e[1],a=e[2],r=e[3],i=e[4],s=e[5],o=e[6],l=e[7],c=e[8],d=c*i-s*l,u=s*o-c*r,h=l*r-i*o,p=t*d+n*u+a*h;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return e[0]=d*m,e[1]=(a*l-c*n)*m,e[2]=(s*n-a*i)*m,e[3]=u*m,e[4]=(c*t-a*o)*m,e[5]=(a*r-s*t)*m,e[6]=h*m,e[7]=(n*o-l*t)*m,e[8]=(i*t-n*r)*m,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,a,r,i,s){const o=Math.cos(r),l=Math.sin(r);return this.set(n*o,n*l,-n*(o*i+l*s)+i+e,-a*l,a*o,-a*(-l*i+o*s)+s+t,0,0,1),this}scale(e,t){return this.premultiply(Xy.makeScale(e,t)),this}rotate(e){return this.premultiply(Xy.makeRotation(-e)),this}translate(e,t){return this.premultiply(Xy.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,n,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,n=e.elements;for(let a=0;a<9;a++)if(t[a]!==n[a])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const Xy=new Gy;function qy(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function Ky(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function Yy(){const e=Ky("canvas");return e.style.display="block",e}const Jy={};const Zy=(new Gy).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Qy=(new Gy).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),ex={[py]:{transfer:gy,primaries:yy,toReference:e=>e,fromReference:e=>e},[hy]:{transfer:vy,primaries:yy,toReference:e=>e.convertSRGBToLinear(),fromReference:e=>e.convertLinearToSRGB()},[fy]:{transfer:gy,primaries:xy,toReference:e=>e.applyMatrix3(Qy),fromReference:e=>e.applyMatrix3(Zy)},[my]:{transfer:vy,primaries:xy,toReference:e=>e.convertSRGBToLinear().applyMatrix3(Qy),fromReference:e=>e.applyMatrix3(Zy).convertLinearToSRGB()}},tx=new Set([py,fy]),nx={enabled:!0,_workingColorSpace:py,get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(e){if(!tx.has(e))throw new Error(`Unsupported working color space, "${e}".`);this._workingColorSpace=e},convert:function(e,t,n){if(!1===this.enabled||t===n||!t||!n)return e;const a=ex[t].toReference;return(0,ex[n].fromReference)(a(e))},fromWorkingColorSpace:function(e,t){return this.convert(e,this._workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this._workingColorSpace)},getPrimaries:function(e){return ex[e].primaries},getTransfer:function(e){return e===uy?gy:ex[e].transfer}};function ax(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function rx(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}let ix;class sx{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===ix&&(ix=Ky("canvas")),ix.width=e.width,ix.height=e.height;const n=ix.getContext("2d");e instanceof ImageData?n.putImageData(e,0,0):n.drawImage(e,0,0,e.width,e.height),t=ix}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=Ky("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const a=n.getImageData(0,0,e.width,e.height),r=a.data;for(let e=0;e<r.length;e++)r[e]=255*ax(r[e]/255);return n.putImageData(a,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*ax(t[e]/255)):t[e]=ax(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let ox=0;class lx{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:ox++}),this.uuid=Uy(),this.data=e,this.dataReady=!0,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const n={uuid:this.uuid,url:""},a=this.data;if(null!==a){let e;if(Array.isArray(a)){e=[];for(let t=0,n=a.length;t<n;t++)a[t].isDataTexture?e.push(cx(a[t].image)):e.push(cx(a[t]))}else e=cx(a);n.url=e}return t||(e.images[this.uuid]=n),n}}function cx(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?sx.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let dx=0;class ux extends Ry{constructor(e=ux.DEFAULT_IMAGE,t=ux.DEFAULT_MAPPING,n=1001,a=1001,r=1006,i=1008,s=1023,o=1009,l=ux.DEFAULT_ANISOTROPY,c=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:dx++}),this.uuid=Uy(),this.name="",this.source=new lx(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=n,this.wrapT=a,this.magFilter=r,this.minFilter=i,this.anisotropy=l,this.format=s,this.internalFormat=null,this.type=o,this.offset=new Wy(0,0),this.repeat=new Wy(1,1),this.center=new Wy(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Gy,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const n={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Bv:e.x=e.x-Math.floor(e.x);break;case Hv:e.x=e.x<0?0:1;break;case $v:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case Bv:e.y=e.y-Math.floor(e.y);break;case Hv:e.y=e.y<0?0:1;break;case $v:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}}ux.DEFAULT_IMAGE=null,ux.DEFAULT_MAPPING=300,ux.DEFAULT_ANISOTROPY=1;class hx{constructor(e=0,t=0,n=0,a=1){hx.prototype.isVector4=!0,this.x=e,this.y=t,this.z=n,this.w=a}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,a){return this.x=e,this.y=t,this.z=n,this.w=a,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,a=this.z,r=this.w,i=e.elements;return this.x=i[0]*t+i[4]*n+i[8]*a+i[12]*r,this.y=i[1]*t+i[5]*n+i[9]*a+i[13]*r,this.z=i[2]*t+i[6]*n+i[10]*a+i[14]*r,this.w=i[3]*t+i[7]*n+i[11]*a+i[15]*r,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,a,r;const i=.01,s=.1,o=e.elements,l=o[0],c=o[4],d=o[8],u=o[1],h=o[5],p=o[9],m=o[2],f=o[6],g=o[10];if(Math.abs(c-u)<i&&Math.abs(d-m)<i&&Math.abs(p-f)<i){if(Math.abs(c+u)<s&&Math.abs(d+m)<s&&Math.abs(p+f)<s&&Math.abs(l+h+g-3)<s)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(h+1)/2,v=(g+1)/2,y=(c+u)/4,x=(d+m)/4,b=(p+f)/4;return e>o&&e>v?e<i?(n=0,a=.707106781,r=.707106781):(n=Math.sqrt(e),a=y/n,r=x/n):o>v?o<i?(n=.707106781,a=0,r=.707106781):(a=Math.sqrt(o),n=y/a,r=b/a):v<i?(n=.707106781,a=.707106781,r=0):(r=Math.sqrt(v),n=x/r,a=b/r),this.set(n,a,r,t),this}let v=Math.sqrt((f-p)*(f-p)+(d-m)*(d-m)+(u-c)*(u-c));return Math.abs(v)<.001&&(v=1),this.x=(f-p)/v,this.y=(d-m)/v,this.z=(u-c)/v,this.w=Math.acos((l+h+g-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class px extends Ry{constructor(e=1,t=1,n={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new hx(0,0,e,t),this.scissorTest=!1,this.viewport=new hx(0,0,e,t);const a={width:e,height:t,depth:1};n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:Xv,depthBuffer:!0,stencilBuffer:!1,depthTexture:null,samples:0,count:1},n);const r=new ux(a,n.mapping,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.colorSpace);r.flipY=!1,r.generateMipmaps=n.generateMipmaps,r.internalFormat=n.internalFormat,this.textures=[];const i=n.count;for(let s=0;s<i;s++)this.textures[s]=r.clone(),this.textures[s].isRenderTargetTexture=!0;this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.depthTexture=n.depthTexture,this.samples=n.samples}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let a=0,r=this.textures.length;a<r;a++)this.textures[a].image.width=e,this.textures[a].image.height=t,this.textures[a].image.depth=n;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let n=0,a=e.textures.length;n<a;n++)this.textures[n]=e.textures[n].clone(),this.textures[n].isRenderTargetTexture=!0;const t=Object.assign({},e.texture.image);return this.texture.source=new lx(t),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class mx extends px{constructor(e=1,t=1,n={}){super(e,t,n),this.isWebGLRenderTarget=!0}}class fx extends ux{constructor(e=null,t=1,n=1,a=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:n,depth:a},this.magFilter=Vv,this.minFilter=Vv,this.wrapR=Hv,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class gx extends ux{constructor(e=null,t=1,n=1,a=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:n,depth:a},this.magFilter=Vv,this.minFilter=Vv,this.wrapR=Hv,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class vx{constructor(e=0,t=0,n=0,a=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=n,this._w=a}static slerpFlat(e,t,n,a,r,i,s){let o=n[a+0],l=n[a+1],c=n[a+2],d=n[a+3];const u=r[i+0],h=r[i+1],p=r[i+2],m=r[i+3];if(0===s)return e[t+0]=o,e[t+1]=l,e[t+2]=c,void(e[t+3]=d);if(1===s)return e[t+0]=u,e[t+1]=h,e[t+2]=p,void(e[t+3]=m);if(d!==m||o!==u||l!==h||c!==p){let e=1-s;const t=o*u+l*h+c*p+d*m,n=t>=0?1:-1,a=1-t*t;if(a>Number.EPSILON){const r=Math.sqrt(a),i=Math.atan2(r,t*n);e=Math.sin(e*i)/r,s=Math.sin(s*i)/r}const r=s*n;if(o=o*e+u*r,l=l*e+h*r,c=c*e+p*r,d=d*e+m*r,e===1-s){const e=1/Math.sqrt(o*o+l*l+c*c+d*d);o*=e,l*=e,c*=e,d*=e}}e[t]=o,e[t+1]=l,e[t+2]=c,e[t+3]=d}static multiplyQuaternionsFlat(e,t,n,a,r,i){const s=n[a],o=n[a+1],l=n[a+2],c=n[a+3],d=r[i],u=r[i+1],h=r[i+2],p=r[i+3];return e[t]=s*p+c*d+o*h-l*u,e[t+1]=o*p+c*u+l*d-s*h,e[t+2]=l*p+c*h+s*u-o*d,e[t+3]=c*p-s*d-o*u-l*h,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,a){return this._x=e,this._y=t,this._z=n,this._w=a,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const n=e._x,a=e._y,r=e._z,i=e._order,s=Math.cos,o=Math.sin,l=s(n/2),c=s(a/2),d=s(r/2),u=o(n/2),h=o(a/2),p=o(r/2);switch(i){case"XYZ":this._x=u*c*d+l*h*p,this._y=l*h*d-u*c*p,this._z=l*c*p+u*h*d,this._w=l*c*d-u*h*p;break;case"YXZ":this._x=u*c*d+l*h*p,this._y=l*h*d-u*c*p,this._z=l*c*p-u*h*d,this._w=l*c*d+u*h*p;break;case"ZXY":this._x=u*c*d-l*h*p,this._y=l*h*d+u*c*p,this._z=l*c*p+u*h*d,this._w=l*c*d-u*h*p;break;case"ZYX":this._x=u*c*d-l*h*p,this._y=l*h*d+u*c*p,this._z=l*c*p-u*h*d,this._w=l*c*d+u*h*p;break;case"YZX":this._x=u*c*d+l*h*p,this._y=l*h*d+u*c*p,this._z=l*c*p-u*h*d,this._w=l*c*d-u*h*p;break;case"XZY":this._x=u*c*d-l*h*p,this._y=l*h*d-u*c*p,this._z=l*c*p+u*h*d,this._w=l*c*d+u*h*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+i)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,a=Math.sin(n);return this._x=e.x*a,this._y=e.y*a,this._z=e.z*a,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],a=t[4],r=t[8],i=t[1],s=t[5],o=t[9],l=t[2],c=t[6],d=t[10],u=n+s+d;if(u>0){const e=.5/Math.sqrt(u+1);this._w=.25/e,this._x=(c-o)*e,this._y=(r-l)*e,this._z=(i-a)*e}else if(n>s&&n>d){const e=2*Math.sqrt(1+n-s-d);this._w=(c-o)/e,this._x=.25*e,this._y=(a+i)/e,this._z=(r+l)/e}else if(s>d){const e=2*Math.sqrt(1+s-n-d);this._w=(r-l)/e,this._x=(a+i)/e,this._y=.25*e,this._z=(o+c)/e}else{const e=2*Math.sqrt(1+d-n-s);this._w=(i-a)/e,this._x=(r+l)/e,this._y=(o+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<Number.EPSILON?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Oy(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(0===n)return this;const a=Math.min(1,t/n);return this.slerp(e,a),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,a=e._y,r=e._z,i=e._w,s=t._x,o=t._y,l=t._z,c=t._w;return this._x=n*c+i*s+a*l-r*o,this._y=a*c+i*o+r*s-n*l,this._z=r*c+i*l+n*o-a*s,this._w=i*c-n*s-a*o-r*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const n=this._x,a=this._y,r=this._z,i=this._w;let s=i*e._w+n*e._x+a*e._y+r*e._z;if(s<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,s=-s):this.copy(e),s>=1)return this._w=i,this._x=n,this._y=a,this._z=r,this;const o=1-s*s;if(o<=Number.EPSILON){const e=1-t;return this._w=e*i+t*this._w,this._x=e*n+t*this._x,this._y=e*a+t*this._y,this._z=e*r+t*this._z,this.normalize(),this}const l=Math.sqrt(o),c=Math.atan2(l,s),d=Math.sin((1-t)*c)/l,u=Math.sin(t*c)/l;return this._w=i*d+this._w*u,this._x=n*d+this._x*u,this._y=a*d+this._y*u,this._z=r*d+this._z*u,this._onChangeCallback(),this}slerpQuaternions(e,t,n){return this.copy(e).slerp(t,n)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),n=Math.random(),a=Math.sqrt(1-n),r=Math.sqrt(n);return this.set(a*Math.sin(e),a*Math.cos(e),r*Math.sin(t),r*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class yx{constructor(e=0,t=0,n=0){yx.prototype.isVector3=!0,this.x=e,this.y=t,this.z=n}set(e,t,n){return void 0===n&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(bx.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(bx.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,a=this.z,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6]*a,this.y=r[1]*t+r[4]*n+r[7]*a,this.z=r[2]*t+r[5]*n+r[8]*a,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,a=this.z,r=e.elements,i=1/(r[3]*t+r[7]*n+r[11]*a+r[15]);return this.x=(r[0]*t+r[4]*n+r[8]*a+r[12])*i,this.y=(r[1]*t+r[5]*n+r[9]*a+r[13])*i,this.z=(r[2]*t+r[6]*n+r[10]*a+r[14])*i,this}applyQuaternion(e){const t=this.x,n=this.y,a=this.z,r=e.x,i=e.y,s=e.z,o=e.w,l=2*(i*a-s*n),c=2*(s*t-r*a),d=2*(r*n-i*t);return this.x=t+o*l+i*d-s*c,this.y=n+o*c+s*l-r*d,this.z=a+o*d+r*c-i*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,a=this.z,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*a,this.y=r[1]*t+r[5]*n+r[9]*a,this.z=r[2]*t+r[6]*n+r[10]*a,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,a=e.y,r=e.z,i=t.x,s=t.y,o=t.z;return this.x=a*o-r*s,this.y=r*i-n*o,this.z=n*s-a*i,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return xx.copy(this).projectOnVector(e),this.sub(xx)}reflect(e){return this.sub(xx.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(Oy(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,a=this.z-e.z;return t*t+n*n+a*a}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const a=Math.sin(t)*e;return this.x=a*Math.sin(n),this.y=Math.cos(t)*e,this.z=a*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),a=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=a,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,n=Math.sqrt(1-t*t);return this.x=n*Math.cos(e),this.y=t,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const xx=new yx,bx=new vx;class _x{constructor(e=new yx(1/0,1/0,1/0),t=new yx(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t+=3)this.expandByPoint(Sx.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,n=e.count;t<n;t++)this.expandByPoint(Sx.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=Sx.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(void 0!==n){const a=n.getAttribute("position");if(!0===t&&void 0!==a&&!0!==e.isInstancedMesh)for(let t=0,n=a.count;t<n;t++)!0===e.isMesh?e.getVertexPosition(t,Sx):Sx.fromBufferAttribute(a,t),Sx.applyMatrix4(e.matrixWorld),this.expandByPoint(Sx);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Mx.copy(e.boundingBox)):(null===n.boundingBox&&n.computeBoundingBox(),Mx.copy(n.boundingBox)),Mx.applyMatrix4(e.matrixWorld),this.union(Mx)}const a=e.children;for(let r=0,i=a.length;r<i;r++)this.expandByObject(a[r],t);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,Sx),Sx.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(jx),Ax.subVectors(this.max,jx),Cx.subVectors(e.a,jx),Ex.subVectors(e.b,jx),kx.subVectors(e.c,jx),Tx.subVectors(Ex,Cx),Nx.subVectors(kx,Ex),Px.subVectors(Cx,kx);let t=[0,-Tx.z,Tx.y,0,-Nx.z,Nx.y,0,-Px.z,Px.y,Tx.z,0,-Tx.x,Nx.z,0,-Nx.x,Px.z,0,-Px.x,-Tx.y,Tx.x,0,-Nx.y,Nx.x,0,-Px.y,Px.x,0];return!!Lx(t,Cx,Ex,kx,Ax)&&(t=[1,0,0,0,1,0,0,0,1],!!Lx(t,Cx,Ex,kx,Ax)&&(Rx.crossVectors(Tx,Nx),t=[Rx.x,Rx.y,Rx.z],Lx(t,Cx,Ex,kx,Ax)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,Sx).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(Sx).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(wx[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),wx[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),wx[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),wx[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),wx[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),wx[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),wx[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),wx[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(wx)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const wx=[new yx,new yx,new yx,new yx,new yx,new yx,new yx,new yx],Sx=new yx,Mx=new _x,Cx=new yx,Ex=new yx,kx=new yx,Tx=new yx,Nx=new yx,Px=new yx,jx=new yx,Ax=new yx,Rx=new yx,Ix=new yx;function Lx(e,t,n,a,r){for(let i=0,s=e.length-3;i<=s;i+=3){Ix.fromArray(e,i);const s=r.x*Math.abs(Ix.x)+r.y*Math.abs(Ix.y)+r.z*Math.abs(Ix.z),o=t.dot(Ix),l=n.dot(Ix),c=a.dot(Ix);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>s)return!1}return!0}const Dx=new _x,Ux=new yx,Ox=new yx;class Fx{constructor(e=new yx,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;void 0!==t?n.copy(t):Dx.setFromPoints(e).getCenter(n);let a=0;for(let r=0,i=e.length;r<i;r++)a=Math.max(a,n.distanceToSquared(e[r]));return this.radius=Math.sqrt(a),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;Ux.subVectors(e,this.center);const t=Ux.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),n=.5*(e-this.radius);this.center.addScaledVector(Ux,n/e),this.radius+=n}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(Ox.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(Ux.copy(e.center).add(Ox)),this.expandByPoint(Ux.copy(e.center).sub(Ox))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const zx=new yx,Bx=new yx,Hx=new yx,$x=new yx,Vx=new yx,Wx=new yx,Gx=new yx;class Xx{constructor(e=new yx,t=new yx(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,zx)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=zx.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(zx.copy(this.origin).addScaledVector(this.direction,t),zx.distanceToSquared(e))}distanceSqToSegment(e,t,n,a){Bx.copy(e).add(t).multiplyScalar(.5),Hx.copy(t).sub(e).normalize(),$x.copy(this.origin).sub(Bx);const r=.5*e.distanceTo(t),i=-this.direction.dot(Hx),s=$x.dot(this.direction),o=-$x.dot(Hx),l=$x.lengthSq(),c=Math.abs(1-i*i);let d,u,h,p;if(c>0)if(d=i*o-s,u=i*s-o,p=r*c,d>=0)if(u>=-p)if(u<=p){const e=1/c;d*=e,u*=e,h=d*(d+i*u+2*s)+u*(i*d+u+2*o)+l}else u=r,d=Math.max(0,-(i*u+s)),h=-d*d+u*(u+2*o)+l;else u=-r,d=Math.max(0,-(i*u+s)),h=-d*d+u*(u+2*o)+l;else u<=-p?(d=Math.max(0,-(-i*r+s)),u=d>0?-r:Math.min(Math.max(-r,-o),r),h=-d*d+u*(u+2*o)+l):u<=p?(d=0,u=Math.min(Math.max(-r,-o),r),h=u*(u+2*o)+l):(d=Math.max(0,-(i*r+s)),u=d>0?r:Math.min(Math.max(-r,-o),r),h=-d*d+u*(u+2*o)+l);else u=i>0?-r:r,d=Math.max(0,-(i*u+s)),h=-d*d+u*(u+2*o)+l;return n&&n.copy(this.origin).addScaledVector(this.direction,d),a&&a.copy(Bx).addScaledVector(Hx,u),h}intersectSphere(e,t){zx.subVectors(e.center,this.origin);const n=zx.dot(this.direction),a=zx.dot(zx)-n*n,r=e.radius*e.radius;if(a>r)return null;const i=Math.sqrt(r-a),s=n-i,o=n+i;return o<0?null:s<0?this.at(o,t):this.at(s,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return null===n?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,a,r,i,s,o;const l=1/this.direction.x,c=1/this.direction.y,d=1/this.direction.z,u=this.origin;return l>=0?(n=(e.min.x-u.x)*l,a=(e.max.x-u.x)*l):(n=(e.max.x-u.x)*l,a=(e.min.x-u.x)*l),c>=0?(r=(e.min.y-u.y)*c,i=(e.max.y-u.y)*c):(r=(e.max.y-u.y)*c,i=(e.min.y-u.y)*c),n>i||r>a?null:((r>n||isNaN(n))&&(n=r),(i<a||isNaN(a))&&(a=i),d>=0?(s=(e.min.z-u.z)*d,o=(e.max.z-u.z)*d):(s=(e.max.z-u.z)*d,o=(e.min.z-u.z)*d),n>o||s>a?null:((s>n||n!=n)&&(n=s),(o<a||a!=a)&&(a=o),a<0?null:this.at(n>=0?n:a,t)))}intersectsBox(e){return null!==this.intersectBox(e,zx)}intersectTriangle(e,t,n,a,r){Vx.subVectors(t,e),Wx.subVectors(n,e),Gx.crossVectors(Vx,Wx);let i,s=this.direction.dot(Gx);if(s>0){if(a)return null;i=1}else{if(!(s<0))return null;i=-1,s=-s}$x.subVectors(this.origin,e);const o=i*this.direction.dot(Wx.crossVectors($x,Wx));if(o<0)return null;const l=i*this.direction.dot(Vx.cross($x));if(l<0)return null;if(o+l>s)return null;const c=-i*$x.dot(Gx);return c<0?null:this.at(c/s,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class qx{constructor(e,t,n,a,r,i,s,o,l,c,d,u,h,p,m,f){qx.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,n,a,r,i,s,o,l,c,d,u,h,p,m,f)}set(e,t,n,a,r,i,s,o,l,c,d,u,h,p,m,f){const g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=a,g[1]=r,g[5]=i,g[9]=s,g[13]=o,g[2]=l,g[6]=c,g[10]=d,g[14]=u,g[3]=h,g[7]=p,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new qx).fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,a=1/Kx.setFromMatrixColumn(e,0).length(),r=1/Kx.setFromMatrixColumn(e,1).length(),i=1/Kx.setFromMatrixColumn(e,2).length();return t[0]=n[0]*a,t[1]=n[1]*a,t[2]=n[2]*a,t[3]=0,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=0,t[8]=n[8]*i,t[9]=n[9]*i,t[10]=n[10]*i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,n=e.x,a=e.y,r=e.z,i=Math.cos(n),s=Math.sin(n),o=Math.cos(a),l=Math.sin(a),c=Math.cos(r),d=Math.sin(r);if("XYZ"===e.order){const e=i*c,n=i*d,a=s*c,r=s*d;t[0]=o*c,t[4]=-o*d,t[8]=l,t[1]=n+a*l,t[5]=e-r*l,t[9]=-s*o,t[2]=r-e*l,t[6]=a+n*l,t[10]=i*o}else if("YXZ"===e.order){const e=o*c,n=o*d,a=l*c,r=l*d;t[0]=e+r*s,t[4]=a*s-n,t[8]=i*l,t[1]=i*d,t[5]=i*c,t[9]=-s,t[2]=n*s-a,t[6]=r+e*s,t[10]=i*o}else if("ZXY"===e.order){const e=o*c,n=o*d,a=l*c,r=l*d;t[0]=e-r*s,t[4]=-i*d,t[8]=a+n*s,t[1]=n+a*s,t[5]=i*c,t[9]=r-e*s,t[2]=-i*l,t[6]=s,t[10]=i*o}else if("ZYX"===e.order){const e=i*c,n=i*d,a=s*c,r=s*d;t[0]=o*c,t[4]=a*l-n,t[8]=e*l+r,t[1]=o*d,t[5]=r*l+e,t[9]=n*l-a,t[2]=-l,t[6]=s*o,t[10]=i*o}else if("YZX"===e.order){const e=i*o,n=i*l,a=s*o,r=s*l;t[0]=o*c,t[4]=r-e*d,t[8]=a*d+n,t[1]=d,t[5]=i*c,t[9]=-s*c,t[2]=-l*c,t[6]=n*d+a,t[10]=e-r*d}else if("XZY"===e.order){const e=i*o,n=i*l,a=s*o,r=s*l;t[0]=o*c,t[4]=-d,t[8]=l*c,t[1]=e*d+r,t[5]=i*c,t[9]=n*d-a,t[2]=a*d-n,t[6]=s*c,t[10]=r*d+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Jx,e,Zx)}lookAt(e,t,n){const a=this.elements;return tb.subVectors(e,t),0===tb.lengthSq()&&(tb.z=1),tb.normalize(),Qx.crossVectors(n,tb),0===Qx.lengthSq()&&(1===Math.abs(n.z)?tb.x+=1e-4:tb.z+=1e-4,tb.normalize(),Qx.crossVectors(n,tb)),Qx.normalize(),eb.crossVectors(tb,Qx),a[0]=Qx.x,a[4]=eb.x,a[8]=tb.x,a[1]=Qx.y,a[5]=eb.y,a[9]=tb.y,a[2]=Qx.z,a[6]=eb.z,a[10]=tb.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,a=t.elements,r=this.elements,i=n[0],s=n[4],o=n[8],l=n[12],c=n[1],d=n[5],u=n[9],h=n[13],p=n[2],m=n[6],f=n[10],g=n[14],v=n[3],y=n[7],x=n[11],b=n[15],_=a[0],w=a[4],S=a[8],M=a[12],C=a[1],E=a[5],k=a[9],T=a[13],N=a[2],P=a[6],j=a[10],A=a[14],R=a[3],I=a[7],L=a[11],D=a[15];return r[0]=i*_+s*C+o*N+l*R,r[4]=i*w+s*E+o*P+l*I,r[8]=i*S+s*k+o*j+l*L,r[12]=i*M+s*T+o*A+l*D,r[1]=c*_+d*C+u*N+h*R,r[5]=c*w+d*E+u*P+h*I,r[9]=c*S+d*k+u*j+h*L,r[13]=c*M+d*T+u*A+h*D,r[2]=p*_+m*C+f*N+g*R,r[6]=p*w+m*E+f*P+g*I,r[10]=p*S+m*k+f*j+g*L,r[14]=p*M+m*T+f*A+g*D,r[3]=v*_+y*C+x*N+b*R,r[7]=v*w+y*E+x*P+b*I,r[11]=v*S+y*k+x*j+b*L,r[15]=v*M+y*T+x*A+b*D,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],a=e[8],r=e[12],i=e[1],s=e[5],o=e[9],l=e[13],c=e[2],d=e[6],u=e[10],h=e[14];return e[3]*(+r*o*d-a*l*d-r*s*u+n*l*u+a*s*h-n*o*h)+e[7]*(+t*o*h-t*l*u+r*i*u-a*i*h+a*l*c-r*o*c)+e[11]*(+t*l*d-t*s*h-r*i*d+n*i*h+r*s*c-n*l*c)+e[15]*(-a*s*c-t*o*d+t*s*u+a*i*d-n*i*u+n*o*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const a=this.elements;return e.isVector3?(a[12]=e.x,a[13]=e.y,a[14]=e.z):(a[12]=e,a[13]=t,a[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],a=e[2],r=e[3],i=e[4],s=e[5],o=e[6],l=e[7],c=e[8],d=e[9],u=e[10],h=e[11],p=e[12],m=e[13],f=e[14],g=e[15],v=d*f*l-m*u*l+m*o*h-s*f*h-d*o*g+s*u*g,y=p*u*l-c*f*l-p*o*h+i*f*h+c*o*g-i*u*g,x=c*m*l-p*d*l+p*s*h-i*m*h-c*s*g+i*d*g,b=p*d*o-c*m*o-p*s*u+i*m*u+c*s*f-i*d*f,_=t*v+n*y+a*x+r*b;if(0===_)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/_;return e[0]=v*w,e[1]=(m*u*r-d*f*r-m*a*h+n*f*h+d*a*g-n*u*g)*w,e[2]=(s*f*r-m*o*r+m*a*l-n*f*l-s*a*g+n*o*g)*w,e[3]=(d*o*r-s*u*r-d*a*l+n*u*l+s*a*h-n*o*h)*w,e[4]=y*w,e[5]=(c*f*r-p*u*r+p*a*h-t*f*h-c*a*g+t*u*g)*w,e[6]=(p*o*r-i*f*r-p*a*l+t*f*l+i*a*g-t*o*g)*w,e[7]=(i*u*r-c*o*r+c*a*l-t*u*l-i*a*h+t*o*h)*w,e[8]=x*w,e[9]=(p*d*r-c*m*r-p*n*h+t*m*h+c*n*g-t*d*g)*w,e[10]=(i*m*r-p*s*r+p*n*l-t*m*l-i*n*g+t*s*g)*w,e[11]=(c*s*r-i*d*r-c*n*l+t*d*l+i*n*h-t*s*h)*w,e[12]=b*w,e[13]=(c*m*a-p*d*a+p*n*u-t*m*u-c*n*f+t*d*f)*w,e[14]=(p*s*a-i*m*a-p*n*o+t*m*o+i*n*f-t*s*f)*w,e[15]=(i*d*a-c*s*a+c*n*o-t*d*o-i*n*u+t*s*u)*w,this}scale(e){const t=this.elements,n=e.x,a=e.y,r=e.z;return t[0]*=n,t[4]*=a,t[8]*=r,t[1]*=n,t[5]*=a,t[9]*=r,t[2]*=n,t[6]*=a,t[10]*=r,t[3]*=n,t[7]*=a,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],a=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,a))}makeTranslation(e,t,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),a=Math.sin(t),r=1-n,i=e.x,s=e.y,o=e.z,l=r*i,c=r*s;return this.set(l*i+n,l*s-a*o,l*o+a*s,0,l*s+a*o,c*s+n,c*o-a*i,0,l*o-a*s,c*o+a*i,r*o*o+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,a,r,i){return this.set(1,n,r,0,e,1,i,0,t,a,1,0,0,0,0,1),this}compose(e,t,n){const a=this.elements,r=t._x,i=t._y,s=t._z,o=t._w,l=r+r,c=i+i,d=s+s,u=r*l,h=r*c,p=r*d,m=i*c,f=i*d,g=s*d,v=o*l,y=o*c,x=o*d,b=n.x,_=n.y,w=n.z;return a[0]=(1-(m+g))*b,a[1]=(h+x)*b,a[2]=(p-y)*b,a[3]=0,a[4]=(h-x)*_,a[5]=(1-(u+g))*_,a[6]=(f+v)*_,a[7]=0,a[8]=(p+y)*w,a[9]=(f-v)*w,a[10]=(1-(u+m))*w,a[11]=0,a[12]=e.x,a[13]=e.y,a[14]=e.z,a[15]=1,this}decompose(e,t,n){const a=this.elements;let r=Kx.set(a[0],a[1],a[2]).length();const i=Kx.set(a[4],a[5],a[6]).length(),s=Kx.set(a[8],a[9],a[10]).length();this.determinant()<0&&(r=-r),e.x=a[12],e.y=a[13],e.z=a[14],Yx.copy(this);const o=1/r,l=1/i,c=1/s;return Yx.elements[0]*=o,Yx.elements[1]*=o,Yx.elements[2]*=o,Yx.elements[4]*=l,Yx.elements[5]*=l,Yx.elements[6]*=l,Yx.elements[8]*=c,Yx.elements[9]*=c,Yx.elements[10]*=c,t.setFromRotationMatrix(Yx),n.x=r,n.y=i,n.z=s,this}makePerspective(e,t,n,a,r,i,s=2e3){const o=this.elements,l=2*r/(t-e),c=2*r/(n-a),d=(t+e)/(t-e),u=(n+a)/(n-a);let h,p;if(s===jy)h=-(i+r)/(i-r),p=-2*i*r/(i-r);else{if(s!==Ay)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+s);h=-i/(i-r),p=-i*r/(i-r)}return o[0]=l,o[4]=0,o[8]=d,o[12]=0,o[1]=0,o[5]=c,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=h,o[14]=p,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,n,a,r,i,s=2e3){const o=this.elements,l=1/(t-e),c=1/(n-a),d=1/(i-r),u=(t+e)*l,h=(n+a)*c;let p,m;if(s===jy)p=(i+r)*d,m=-2*d;else{if(s!==Ay)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+s);p=r*d,m=-1*d}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-h,o[2]=0,o[6]=0,o[10]=m,o[14]=-p,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let a=0;a<16;a++)if(t[a]!==n[a])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}const Kx=new yx,Yx=new qx,Jx=new yx(0,0,0),Zx=new yx(1,1,1),Qx=new yx,eb=new yx,tb=new yx,nb=new qx,ab=new vx;class rb{constructor(e=0,t=0,n=0,a=rb.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=n,this._order=a}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,a=this._order){return this._x=e,this._y=t,this._z=n,this._order=a,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const a=e.elements,r=a[0],i=a[4],s=a[8],o=a[1],l=a[5],c=a[9],d=a[2],u=a[6],h=a[10];switch(t){case"XYZ":this._y=Math.asin(Oy(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(-c,h),this._z=Math.atan2(-i,r)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-Oy(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(s,h),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-d,r),this._z=0);break;case"ZXY":this._x=Math.asin(Oy(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-d,h),this._z=Math.atan2(-i,l)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-Oy(d,-1,1)),Math.abs(d)<.9999999?(this._x=Math.atan2(u,h),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-i,l));break;case"YZX":this._z=Math.asin(Oy(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-d,r)):(this._x=0,this._y=Math.atan2(s,h));break;case"XZY":this._z=Math.asin(-Oy(i,-1,1)),Math.abs(i)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(s,r)):(this._x=Math.atan2(-c,h),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===n&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return nb.makeRotationFromQuaternion(e),this.setFromRotationMatrix(nb,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return ab.setFromEuler(this),this.setFromQuaternion(ab,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}rb.DEFAULT_ORDER="XYZ";let ib=class{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}},sb=0;const ob=new yx,lb=new vx,cb=new qx,db=new yx,ub=new yx,hb=new yx,pb=new vx,mb=new yx(1,0,0),fb=new yx(0,1,0),gb=new yx(0,0,1),vb={type:"added"},yb={type:"removed"},xb={type:"childadded",child:null},bb={type:"childremoved",child:null};class _b extends Ry{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:sb++}),this.uuid=Uy(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=_b.DEFAULT_UP.clone();const e=new yx,t=new rb,n=new vx,a=new yx(1,1,1);t._onChange(function(){n.setFromEuler(t,!1)}),n._onChange(function(){t.setFromQuaternion(n,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:a},modelViewMatrix:{value:new qx},normalMatrix:{value:new Gy}}),this.matrix=new qx,this.matrixWorld=new qx,this.matrixAutoUpdate=_b.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=_b.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new ib,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return lb.setFromAxisAngle(e,t),this.quaternion.multiply(lb),this}rotateOnWorldAxis(e,t){return lb.setFromAxisAngle(e,t),this.quaternion.premultiply(lb),this}rotateX(e){return this.rotateOnAxis(mb,e)}rotateY(e){return this.rotateOnAxis(fb,e)}rotateZ(e){return this.rotateOnAxis(gb,e)}translateOnAxis(e,t){return ob.copy(e).applyQuaternion(this.quaternion),this.position.add(ob.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(mb,e)}translateY(e){return this.translateOnAxis(fb,e)}translateZ(e){return this.translateOnAxis(gb,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(cb.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?db.copy(e):db.set(e,t,n);const a=this.parent;this.updateWorldMatrix(!0,!1),ub.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?cb.lookAt(ub,db,this.up):cb.lookAt(db,ub,this.up),this.quaternion.setFromRotationMatrix(cb),a&&(cb.extractRotation(a.matrixWorld),lb.setFromRotationMatrix(cb),this.quaternion.premultiply(lb.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(vb),xb.child=e,this.dispatchEvent(xb),xb.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(yb),bb.child=e,this.dispatchEvent(bb),bb.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),cb.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),cb.multiply(e.parent.matrixWorld)),e.applyMatrix4(cb),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,a=this.children.length;n<a;n++){const a=this.children[n].getObjectByProperty(e,t);if(void 0!==a)return a}}getObjectsByProperty(e,t,n=[]){this[e]===t&&n.push(this);const a=this.children;for(let r=0,i=a.length;r<i;r++)a[r].getObjectsByProperty(e,t,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ub,e,hb),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(ub,pb,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,a=t.length;n<a;n++)t[n].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let n=0,a=t.length;n<a;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,a=t.length;n<a;n++){const a=t[n];!0!==a.matrixWorldAutoUpdate&&!0!==e||a.updateMatrixWorld(e)}}updateWorldMatrix(e,t){const n=this.parent;if(!0===e&&null!==n&&!0===n.matrixWorldAutoUpdate&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,n=e.length;t<n;t++){const n=e[t];!0===n.matrixWorldAutoUpdate&&n.updateWorldMatrix(!1,!0)}}}toJSON(e){const t=void 0===e||"string"==typeof e,n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const a={};function r(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}if(a.uuid=this.uuid,a.type=this.type,""!==this.name&&(a.name=this.name),!0===this.castShadow&&(a.castShadow=!0),!0===this.receiveShadow&&(a.receiveShadow=!0),!1===this.visible&&(a.visible=!1),!1===this.frustumCulled&&(a.frustumCulled=!1),0!==this.renderOrder&&(a.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(a.userData=this.userData),a.layers=this.layers.mask,a.matrix=this.matrix.toArray(),a.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(a.matrixAutoUpdate=!1),this.isInstancedMesh&&(a.type="InstancedMesh",a.count=this.count,a.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(a.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(a.type="BatchedMesh",a.perObjectFrustumCulled=this.perObjectFrustumCulled,a.sortObjects=this.sortObjects,a.drawRanges=this._drawRanges,a.reservedRanges=this._reservedRanges,a.visibility=this._visibility,a.active=this._active,a.bounds=this._bounds.map(e=>({boxInitialized:e.boxInitialized,boxMin:e.box.min.toArray(),boxMax:e.box.max.toArray(),sphereInitialized:e.sphereInitialized,sphereRadius:e.sphere.radius,sphereCenter:e.sphere.center.toArray()})),a.maxGeometryCount=this._maxGeometryCount,a.maxVertexCount=this._maxVertexCount,a.maxIndexCount=this._maxIndexCount,a.geometryInitialized=this._geometryInitialized,a.geometryCount=this._geometryCount,a.matricesTexture=this._matricesTexture.toJSON(e),null!==this.boundingSphere&&(a.boundingSphere={center:a.boundingSphere.center.toArray(),radius:a.boundingSphere.radius}),null!==this.boundingBox&&(a.boundingBox={min:a.boundingBox.min.toArray(),max:a.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?a.background=this.background.toJSON():this.background.isTexture&&(a.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(a.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){a.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const n=t.shapes;if(Array.isArray(n))for(let t=0,a=n.length;t<a;t++){const a=n[t];r(e.shapes,a)}else r(e.shapes,n)}}if(this.isSkinnedMesh&&(a.bindMode=this.bindMode,a.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),a.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let n=0,a=this.material.length;n<a;n++)t.push(r(e.materials,this.material[n]));a.material=t}else a.material=r(e.materials,this.material);if(this.children.length>0){a.children=[];for(let t=0;t<this.children.length;t++)a.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){a.animations=[];for(let t=0;t<this.animations.length;t++){const n=this.animations[t];a.animations.push(r(e.animations,n))}}if(t){const t=i(e.geometries),a=i(e.materials),r=i(e.textures),s=i(e.images),o=i(e.shapes),l=i(e.skeletons),c=i(e.animations),d=i(e.nodes);t.length>0&&(n.geometries=t),a.length>0&&(n.materials=a),r.length>0&&(n.textures=r),s.length>0&&(n.images=s),o.length>0&&(n.shapes=o),l.length>0&&(n.skeletons=l),c.length>0&&(n.animations=c),d.length>0&&(n.nodes=d)}return n.object=a,n;function i(e){const t=[];for(const n in e){const a=e[n];delete a.metadata,t.push(a)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let n=0;n<e.children.length;n++){const t=e.children[n];this.add(t.clone())}return this}}_b.DEFAULT_UP=new yx(0,1,0),_b.DEFAULT_MATRIX_AUTO_UPDATE=!0,_b.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const wb=new yx,Sb=new yx,Mb=new yx,Cb=new yx,Eb=new yx,kb=new yx,Tb=new yx,Nb=new yx,Pb=new yx,jb=new yx;class Ab{constructor(e=new yx,t=new yx,n=new yx){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,a){a.subVectors(n,t),wb.subVectors(e,t),a.cross(wb);const r=a.lengthSq();return r>0?a.multiplyScalar(1/Math.sqrt(r)):a.set(0,0,0)}static getBarycoord(e,t,n,a,r){wb.subVectors(a,t),Sb.subVectors(n,t),Mb.subVectors(e,t);const i=wb.dot(wb),s=wb.dot(Sb),o=wb.dot(Mb),l=Sb.dot(Sb),c=Sb.dot(Mb),d=i*l-s*s;if(0===d)return r.set(0,0,0),null;const u=1/d,h=(l*o-s*c)*u,p=(i*c-s*o)*u;return r.set(1-h-p,p,h)}static containsPoint(e,t,n,a){return null!==this.getBarycoord(e,t,n,a,Cb)&&(Cb.x>=0&&Cb.y>=0&&Cb.x+Cb.y<=1)}static getInterpolation(e,t,n,a,r,i,s,o){return null===this.getBarycoord(e,t,n,a,Cb)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(r,Cb.x),o.addScaledVector(i,Cb.y),o.addScaledVector(s,Cb.z),o)}static isFrontFacing(e,t,n,a){return wb.subVectors(n,t),Sb.subVectors(e,t),wb.cross(Sb).dot(a)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,a){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[a]),this}setFromAttributeAndIndices(e,t,n,a){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,a),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return wb.subVectors(this.c,this.b),Sb.subVectors(this.a,this.b),.5*wb.cross(Sb).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Ab.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Ab.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,n,a,r){return Ab.getInterpolation(e,this.a,this.b,this.c,t,n,a,r)}containsPoint(e){return Ab.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Ab.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,a=this.b,r=this.c;let i,s;Eb.subVectors(a,n),kb.subVectors(r,n),Nb.subVectors(e,n);const o=Eb.dot(Nb),l=kb.dot(Nb);if(o<=0&&l<=0)return t.copy(n);Pb.subVectors(e,a);const c=Eb.dot(Pb),d=kb.dot(Pb);if(c>=0&&d<=c)return t.copy(a);const u=o*d-c*l;if(u<=0&&o>=0&&c<=0)return i=o/(o-c),t.copy(n).addScaledVector(Eb,i);jb.subVectors(e,r);const h=Eb.dot(jb),p=kb.dot(jb);if(p>=0&&h<=p)return t.copy(r);const m=h*l-o*p;if(m<=0&&l>=0&&p<=0)return s=l/(l-p),t.copy(n).addScaledVector(kb,s);const f=c*p-h*d;if(f<=0&&d-c>=0&&h-p>=0)return Tb.subVectors(r,a),s=(d-c)/(d-c+(h-p)),t.copy(a).addScaledVector(Tb,s);const g=1/(f+m+u);return i=m*g,s=u*g,t.copy(n).addScaledVector(Eb,i).addScaledVector(kb,s)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const Rb={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Ib={h:0,s:0,l:0},Lb={h:0,s:0,l:0};function Db(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}class Ub{constructor(e,t,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,n)}set(e,t,n){if(void 0===t&&void 0===n){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=hy){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,nx.toWorkingColorSpace(this,t),this}setRGB(e,t,n,a=nx.workingColorSpace){return this.r=e,this.g=t,this.b=n,nx.toWorkingColorSpace(this,a),this}setHSL(e,t,n,a=nx.workingColorSpace){var r;if(e=(e%(r=1)+r)%r,t=Oy(t,0,1),n=Oy(n,0,1),0===t)this.r=this.g=this.b=n;else{const a=n<=.5?n*(1+t):n+t-n*t,r=2*n-a;this.r=Db(r,a,e+1/3),this.g=Db(r,a,e),this.b=Db(r,a,e-1/3)}return nx.toWorkingColorSpace(this,a),this}setStyle(e,t=hy){function n(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let a;if(a=/^(\w+)\(([^\)]*)\)/.exec(e)){let r;const i=a[1],s=a[2];switch(i){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return n(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,t);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return n(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,t);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(s))return n(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(a=/^\#([A-Fa-f\d]+)$/.exec(e)){const n=a[1],r=n.length;if(3===r)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,t);if(6===r)return this.setHex(parseInt(n,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=hy){const n=Rb[e.toLowerCase()];return void 0!==n?this.setHex(n,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=ax(e.r),this.g=ax(e.g),this.b=ax(e.b),this}copyLinearToSRGB(e){return this.r=rx(e.r),this.g=rx(e.g),this.b=rx(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=hy){return nx.fromWorkingColorSpace(Ob.copy(this),e),65536*Math.round(Oy(255*Ob.r,0,255))+256*Math.round(Oy(255*Ob.g,0,255))+Math.round(Oy(255*Ob.b,0,255))}getHexString(e=hy){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=nx.workingColorSpace){nx.fromWorkingColorSpace(Ob.copy(this),t);const n=Ob.r,a=Ob.g,r=Ob.b,i=Math.max(n,a,r),s=Math.min(n,a,r);let o,l;const c=(s+i)/2;if(s===i)o=0,l=0;else{const e=i-s;switch(l=c<=.5?e/(i+s):e/(2-i-s),i){case n:o=(a-r)/e+(a<r?6:0);break;case a:o=(r-n)/e+2;break;case r:o=(n-a)/e+4}o/=6}return e.h=o,e.s=l,e.l=c,e}getRGB(e,t=nx.workingColorSpace){return nx.fromWorkingColorSpace(Ob.copy(this),t),e.r=Ob.r,e.g=Ob.g,e.b=Ob.b,e}getStyle(e=hy){nx.fromWorkingColorSpace(Ob.copy(this),e);const t=Ob.r,n=Ob.g,a=Ob.b;return e!==hy?`color(${e} ${t.toFixed(3)} ${n.toFixed(3)} ${a.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*n)},${Math.round(255*a)})`}offsetHSL(e,t,n){return this.getHSL(Ib),this.setHSL(Ib.h+e,Ib.s+t,Ib.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL(Ib),e.getHSL(Lb);const n=Fy(Ib.h,Lb.h,t),a=Fy(Ib.s,Lb.s,t),r=Fy(Ib.l,Lb.l,t);return this.setHSL(n,a,r),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,n=this.g,a=this.b,r=e.elements;return this.r=r[0]*t+r[3]*n+r[6]*a,this.g=r[1]*t+r[4]*n+r[7]*a,this.b=r[2]*t+r[5]*n+r[8]*a,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Ob=new Ub;Ub.NAMES=Rb;let Fb=0;class zb extends Ry{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Fb++}),this.uuid=Uy(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=bv,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Ub(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=by,this.stencilZFail=by,this.stencilZPass=by,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const n=e[t];if(void 0===n){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const a=this[t];void 0!==a?a&&a.isColor?a.set(n):a&&a.isVector3&&n&&n.isVector3?a.copy(n):this[t]=n:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const n={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function a(e){const t=[];for(const n in e){const a=e[n];delete a.metadata,t.push(a)}return t}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.iridescence&&(n.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(n.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(n.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapRotation&&(n.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(n.blending=this.blending),0!==this.side&&(n.side=this.side),!0===this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=!0),204!==this.blendSrc&&(n.blendSrc=this.blendSrc),205!==this.blendDst&&(n.blendDst=this.blendDst),this.blendEquation!==bv&&(n.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(n.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(n.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(n.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(n.depthFunc=this.depthFunc),!1===this.depthTest&&(n.depthTest=this.depthTest),!1===this.depthWrite&&(n.depthWrite=this.depthWrite),!1===this.colorWrite&&(n.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(n.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(n.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(n.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==by&&(n.stencilFail=this.stencilFail),this.stencilZFail!==by&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==by&&(n.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(n.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaHash&&(n.alphaHash=!0),!0===this.alphaToCoverage&&(n.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=!0),!0===this.forceSinglePass&&(n.forceSinglePass=!0),!0===this.wireframe&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=!0),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData),t){const t=a(e.textures),r=a(e.images);t.length>0&&(n.textures=t),r.length>0&&(n.images=r)}return n}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(null!==t){const e=t.length;n=new Array(e);for(let a=0;a!==e;++a)n[a]=t[a].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}class Bb extends zb{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Ub(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rb,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const Hb=new yx,$b=new Wy;class Vb{constructor(e,t,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=n,this.usage=35044,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=ey,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}get updateRange(){var e;return(e="THREE.BufferAttribute: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead.")in Jy||(Jy[e]=!0,console.warn(e)),this._updateRange}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let a=0,r=this.itemSize;a<r;a++)this.array[e+a]=t.array[n+a];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,n=this.count;t<n;t++)$b.fromBufferAttribute(this,t),$b.applyMatrix3(e),this.setXY(t,$b.x,$b.y);else if(3===this.itemSize)for(let t=0,n=this.count;t<n;t++)Hb.fromBufferAttribute(this,t),Hb.applyMatrix3(e),this.setXYZ(t,Hb.x,Hb.y,Hb.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)Hb.fromBufferAttribute(this,t),Hb.applyMatrix4(e),this.setXYZ(t,Hb.x,Hb.y,Hb.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)Hb.fromBufferAttribute(this,t),Hb.applyNormalMatrix(e),this.setXYZ(t,Hb.x,Hb.y,Hb.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)Hb.fromBufferAttribute(this,t),Hb.transformDirection(e),this.setXYZ(t,Hb.x,Hb.y,Hb.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let n=this.array[e*this.itemSize+t];return this.normalized&&(n=Hy(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=$y(n,this.array)),this.array[e*this.itemSize+t]=n,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=Hy(t,this.array)),t}setX(e,t){return this.normalized&&(t=$y(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=Hy(t,this.array)),t}setY(e,t){return this.normalized&&(t=$y(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=Hy(t,this.array)),t}setZ(e,t){return this.normalized&&(t=$y(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=Hy(t,this.array)),t}setW(e,t){return this.normalized&&(t=$y(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=$y(t,this.array),n=$y(n,this.array)),this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,a){return e*=this.itemSize,this.normalized&&(t=$y(t,this.array),n=$y(n,this.array),a=$y(a,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=a,this}setXYZW(e,t,n,a,r){return e*=this.itemSize,this.normalized&&(t=$y(t,this.array),n=$y(n,this.array),a=$y(a,this.array),r=$y(r,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=a,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),e}}class Wb extends Vb{constructor(e,t,n){super(new Uint16Array(e),t,n)}}class Gb extends Vb{constructor(e,t,n){super(new Uint32Array(e),t,n)}}class Xb extends Vb{constructor(e,t,n){super(new Float32Array(e),t,n)}}let qb=0;const Kb=new qx,Yb=new _b,Jb=new yx,Zb=new _x,Qb=new _x,e_=new yx;class t_ extends Ry{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:qb++}),this.uuid=Uy(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(qy(e)?Gb:Wb)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const t=(new Gy).getNormalMatrix(e);n.applyNormalMatrix(t),n.needsUpdate=!0}const a=this.attributes.tangent;return void 0!==a&&(a.transformDirection(e),a.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return Kb.makeRotationFromQuaternion(e),this.applyMatrix4(Kb),this}rotateX(e){return Kb.makeRotationX(e),this.applyMatrix4(Kb),this}rotateY(e){return Kb.makeRotationY(e),this.applyMatrix4(Kb),this}rotateZ(e){return Kb.makeRotationZ(e),this.applyMatrix4(Kb),this}translate(e,t,n){return Kb.makeTranslation(e,t,n),this.applyMatrix4(Kb),this}scale(e,t,n){return Kb.makeScale(e,t,n),this.applyMatrix4(Kb),this}lookAt(e){return Yb.lookAt(e),Yb.updateMatrix(),this.applyMatrix4(Yb.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Jb).negate(),this.translate(Jb.x,Jb.y,Jb.z),this}setFromPoints(e){const t=[];for(let n=0,a=e.length;n<a;n++){const a=e[n];t.push(a.x,a.y,a.z||0)}return this.setAttribute("position",new Xb(t,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new _x);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new yx(-1/0,-1/0,-1/0),new yx(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let n=0,a=t.length;n<a;n++){const e=t[n];Zb.setFromBufferAttribute(e),this.morphTargetsRelative?(e_.addVectors(this.boundingBox.min,Zb.min),this.boundingBox.expandByPoint(e_),e_.addVectors(this.boundingBox.max,Zb.max),this.boundingBox.expandByPoint(e_)):(this.boundingBox.expandByPoint(Zb.min),this.boundingBox.expandByPoint(Zb.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Fx);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new yx,1/0);if(e){const n=this.boundingSphere.center;if(Zb.setFromBufferAttribute(e),t)for(let e=0,r=t.length;e<r;e++){const n=t[e];Qb.setFromBufferAttribute(n),this.morphTargetsRelative?(e_.addVectors(Zb.min,Qb.min),Zb.expandByPoint(e_),e_.addVectors(Zb.max,Qb.max),Zb.expandByPoint(e_)):(Zb.expandByPoint(Qb.min),Zb.expandByPoint(Qb.max))}Zb.getCenter(n);let a=0;for(let t=0,r=e.count;t<r;t++)e_.fromBufferAttribute(e,t),a=Math.max(a,n.distanceToSquared(e_));if(t)for(let r=0,i=t.length;r<i;r++){const i=t[r],s=this.morphTargetsRelative;for(let t=0,r=i.count;t<r;t++)e_.fromBufferAttribute(i,t),s&&(Jb.fromBufferAttribute(e,t),e_.add(Jb)),a=Math.max(a,n.distanceToSquared(e_))}this.boundingSphere.radius=Math.sqrt(a),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const n=t.position,a=t.normal,r=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Vb(new Float32Array(4*n.count),4));const i=this.getAttribute("tangent"),s=[],o=[];for(let S=0;S<n.count;S++)s[S]=new yx,o[S]=new yx;const l=new yx,c=new yx,d=new yx,u=new Wy,h=new Wy,p=new Wy,m=new yx,f=new yx;function g(e,t,a){l.fromBufferAttribute(n,e),c.fromBufferAttribute(n,t),d.fromBufferAttribute(n,a),u.fromBufferAttribute(r,e),h.fromBufferAttribute(r,t),p.fromBufferAttribute(r,a),c.sub(l),d.sub(l),h.sub(u),p.sub(u);const i=1/(h.x*p.y-p.x*h.y);isFinite(i)&&(m.copy(c).multiplyScalar(p.y).addScaledVector(d,-h.y).multiplyScalar(i),f.copy(d).multiplyScalar(h.x).addScaledVector(c,-p.x).multiplyScalar(i),s[e].add(m),s[t].add(m),s[a].add(m),o[e].add(f),o[t].add(f),o[a].add(f))}let v=this.groups;0===v.length&&(v=[{start:0,count:e.count}]);for(let S=0,M=v.length;S<M;++S){const t=v[S],n=t.start;for(let a=n,r=n+t.count;a<r;a+=3)g(e.getX(a+0),e.getX(a+1),e.getX(a+2))}const y=new yx,x=new yx,b=new yx,_=new yx;function w(e){b.fromBufferAttribute(a,e),_.copy(b);const t=s[e];y.copy(t),y.sub(b.multiplyScalar(b.dot(t))).normalize(),x.crossVectors(_,t);const n=x.dot(o[e])<0?-1:1;i.setXYZW(e,y.x,y.y,y.z,n)}for(let S=0,M=v.length;S<M;++S){const t=v[S],n=t.start;for(let a=n,r=n+t.count;a<r;a+=3)w(e.getX(a+0)),w(e.getX(a+1)),w(e.getX(a+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let n=this.getAttribute("normal");if(void 0===n)n=new Vb(new Float32Array(3*t.count),3),this.setAttribute("normal",n);else for(let e=0,t=n.count;e<t;e++)n.setXYZ(e,0,0,0);const a=new yx,r=new yx,i=new yx,s=new yx,o=new yx,l=new yx,c=new yx,d=new yx;if(e)for(let u=0,h=e.count;u<h;u+=3){const h=e.getX(u+0),p=e.getX(u+1),m=e.getX(u+2);a.fromBufferAttribute(t,h),r.fromBufferAttribute(t,p),i.fromBufferAttribute(t,m),c.subVectors(i,r),d.subVectors(a,r),c.cross(d),s.fromBufferAttribute(n,h),o.fromBufferAttribute(n,p),l.fromBufferAttribute(n,m),s.add(c),o.add(c),l.add(c),n.setXYZ(h,s.x,s.y,s.z),n.setXYZ(p,o.x,o.y,o.z),n.setXYZ(m,l.x,l.y,l.z)}else for(let e=0,u=t.count;e<u;e+=3)a.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),i.fromBufferAttribute(t,e+2),c.subVectors(i,r),d.subVectors(a,r),c.cross(d),n.setXYZ(e+0,c.x,c.y,c.z),n.setXYZ(e+1,c.x,c.y,c.z),n.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)e_.fromBufferAttribute(e,t),e_.normalize(),e.setXYZ(t,e_.x,e_.y,e_.z)}toNonIndexed(){function e(e,t){const n=e.array,a=e.itemSize,r=e.normalized,i=new n.constructor(t.length*a);let s=0,o=0;for(let l=0,c=t.length;l<c;l++){s=e.isInterleavedBufferAttribute?t[l]*e.data.stride+e.offset:t[l]*a;for(let e=0;e<a;e++)i[o++]=n[s++]}return new Vb(i,a,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new t_,n=this.index.array,a=this.attributes;for(const s in a){const r=e(a[s],n);t.setAttribute(s,r)}const r=this.morphAttributes;for(const s in r){const a=[],i=r[s];for(let t=0,r=i.length;t<r;t++){const r=e(i[t],n);a.push(r)}t.morphAttributes[s]=a}t.morphTargetsRelative=this.morphTargetsRelative;const i=this.groups;for(let s=0,o=i.length;s<o;s++){const e=i[s];t.addGroup(e.start,e.count,e.materialIndex)}return t}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const o in n){const t=n[o];e.data.attributes[o]=t.toJSON(e.data)}const a={};let r=!1;for(const o in this.morphAttributes){const t=this.morphAttributes[o],n=[];for(let a=0,r=t.length;a<r;a++){const r=t[a];n.push(r.toJSON(e.data))}n.length>0&&(a[o]=n,r=!0)}r&&(e.data.morphAttributes=a,e.data.morphTargetsRelative=this.morphTargetsRelative);const i=this.groups;i.length>0&&(e.data.groups=JSON.parse(JSON.stringify(i)));const s=this.boundingSphere;return null!==s&&(e.data.boundingSphere={center:s.center.toArray(),radius:s.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;null!==n&&this.setIndex(n.clone(t));const a=e.attributes;for(const l in a){const e=a[l];this.setAttribute(l,e.clone(t))}const r=e.morphAttributes;for(const l in r){const e=[],n=r[l];for(let a=0,r=n.length;a<r;a++)e.push(n[a].clone(t));this.morphAttributes[l]=e}this.morphTargetsRelative=e.morphTargetsRelative;const i=e.groups;for(let l=0,c=i.length;l<c;l++){const e=i[l];this.addGroup(e.start,e.count,e.materialIndex)}const s=e.boundingBox;null!==s&&(this.boundingBox=s.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const n_=new qx,a_=new Xx,r_=new Fx,i_=new yx,s_=new yx,o_=new yx,l_=new yx,c_=new yx,d_=new yx,u_=new Wy,h_=new Wy,p_=new Wy,m_=new yx,f_=new yx,g_=new yx,v_=new yx,y_=new yx;class x_ extends _b{constructor(e=new t_,t=new Bb){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const n=this.geometry,a=n.attributes.position,r=n.morphAttributes.position,i=n.morphTargetsRelative;t.fromBufferAttribute(a,e);const s=this.morphTargetInfluences;if(r&&s){d_.set(0,0,0);for(let n=0,a=r.length;n<a;n++){const a=s[n],o=r[n];0!==a&&(c_.fromBufferAttribute(o,e),i?d_.addScaledVector(c_,a):d_.addScaledVector(c_.sub(t),a))}t.add(d_)}return t}raycast(e,t){const n=this.geometry,a=this.material,r=this.matrixWorld;if(void 0!==a){if(null===n.boundingSphere&&n.computeBoundingSphere(),r_.copy(n.boundingSphere),r_.applyMatrix4(r),a_.copy(e.ray).recast(e.near),!1===r_.containsPoint(a_.origin)){if(null===a_.intersectSphere(r_,i_))return;if(a_.origin.distanceToSquared(i_)>(e.far-e.near)**2)return}n_.copy(r).invert(),a_.copy(e.ray).applyMatrix4(n_),null!==n.boundingBox&&!1===a_.intersectsBox(n.boundingBox)||this._computeIntersections(e,t,a_)}}_computeIntersections(e,t,n){let a;const r=this.geometry,i=this.material,s=r.index,o=r.attributes.position,l=r.attributes.uv,c=r.attributes.uv1,d=r.attributes.normal,u=r.groups,h=r.drawRange;if(null!==s)if(Array.isArray(i))for(let p=0,m=u.length;p<m;p++){const r=u[p],o=i[r.materialIndex];for(let i=Math.max(r.start,h.start),u=Math.min(s.count,Math.min(r.start+r.count,h.start+h.count));i<u;i+=3){a=b_(this,o,e,n,l,c,d,s.getX(i),s.getX(i+1),s.getX(i+2)),a&&(a.faceIndex=Math.floor(i/3),a.face.materialIndex=r.materialIndex,t.push(a))}}else{for(let r=Math.max(0,h.start),o=Math.min(s.count,h.start+h.count);r<o;r+=3){a=b_(this,i,e,n,l,c,d,s.getX(r),s.getX(r+1),s.getX(r+2)),a&&(a.faceIndex=Math.floor(r/3),t.push(a))}}else if(void 0!==o)if(Array.isArray(i))for(let p=0,m=u.length;p<m;p++){const r=u[p],s=i[r.materialIndex];for(let i=Math.max(r.start,h.start),u=Math.min(o.count,Math.min(r.start+r.count,h.start+h.count));i<u;i+=3){a=b_(this,s,e,n,l,c,d,i,i+1,i+2),a&&(a.faceIndex=Math.floor(i/3),a.face.materialIndex=r.materialIndex,t.push(a))}}else{for(let r=Math.max(0,h.start),s=Math.min(o.count,h.start+h.count);r<s;r+=3){a=b_(this,i,e,n,l,c,d,r,r+1,r+2),a&&(a.faceIndex=Math.floor(r/3),t.push(a))}}}}function b_(e,t,n,a,r,i,s,o,l,c){e.getVertexPosition(o,s_),e.getVertexPosition(l,o_),e.getVertexPosition(c,l_);const d=function(e,t,n,a,r,i,s,o){let l;if(l=1===t.side?a.intersectTriangle(s,i,r,!0,o):a.intersectTriangle(r,i,s,0===t.side,o),null===l)return null;y_.copy(o),y_.applyMatrix4(e.matrixWorld);const c=n.ray.origin.distanceTo(y_);return c<n.near||c>n.far?null:{distance:c,point:y_.clone(),object:e}}(e,t,n,a,s_,o_,l_,v_);if(d){r&&(u_.fromBufferAttribute(r,o),h_.fromBufferAttribute(r,l),p_.fromBufferAttribute(r,c),d.uv=Ab.getInterpolation(v_,s_,o_,l_,u_,h_,p_,new Wy)),i&&(u_.fromBufferAttribute(i,o),h_.fromBufferAttribute(i,l),p_.fromBufferAttribute(i,c),d.uv1=Ab.getInterpolation(v_,s_,o_,l_,u_,h_,p_,new Wy)),s&&(m_.fromBufferAttribute(s,o),f_.fromBufferAttribute(s,l),g_.fromBufferAttribute(s,c),d.normal=Ab.getInterpolation(v_,s_,o_,l_,m_,f_,g_,new yx),d.normal.dot(a.direction)>0&&d.normal.multiplyScalar(-1));const e={a:o,b:l,c:c,normal:new yx,materialIndex:0};Ab.getNormal(s_,o_,l_,e.normal),d.face=e}return d}class __ extends t_{constructor(e=1,t=1,n=1,a=1,r=1,i=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:a,heightSegments:r,depthSegments:i};const s=this;a=Math.floor(a),r=Math.floor(r),i=Math.floor(i);const o=[],l=[],c=[],d=[];let u=0,h=0;function p(e,t,n,a,r,i,p,m,f,g,v){const y=i/f,x=p/g,b=i/2,_=p/2,w=m/2,S=f+1,M=g+1;let C=0,E=0;const k=new yx;for(let s=0;s<M;s++){const i=s*x-_;for(let o=0;o<S;o++){const u=o*y-b;k[e]=u*a,k[t]=i*r,k[n]=w,l.push(k.x,k.y,k.z),k[e]=0,k[t]=0,k[n]=m>0?1:-1,c.push(k.x,k.y,k.z),d.push(o/f),d.push(1-s/g),C+=1}}for(let s=0;s<g;s++)for(let e=0;e<f;e++){const t=u+e+S*s,n=u+e+S*(s+1),a=u+(e+1)+S*(s+1),r=u+(e+1)+S*s;o.push(t,n,r),o.push(n,a,r),E+=6}s.addGroup(h,E,v),h+=E,u+=C}p("z","y","x",-1,-1,n,t,e,i,r,0),p("z","y","x",1,-1,n,t,-e,i,r,1),p("x","z","y",1,1,e,n,t,a,i,2),p("x","z","y",1,-1,e,n,-t,a,i,3),p("x","y","z",1,-1,e,t,n,a,r,4),p("x","y","z",-1,-1,e,t,-n,a,r,5),this.setIndex(o),this.setAttribute("position",new Xb(l,3)),this.setAttribute("normal",new Xb(c,3)),this.setAttribute("uv",new Xb(d,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new __(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function w_(e){const t={};for(const n in e){t[n]={};for(const a in e[n]){const r=e[n][a];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[n][a]=null):t[n][a]=r.clone():Array.isArray(r)?t[n][a]=r.slice():t[n][a]=r}}return t}function S_(e){const t={};for(let n=0;n<e.length;n++){const a=w_(e[n]);for(const e in a)t[e]=a[e]}return t}function M_(e){return null===e.getRenderTarget()?e.outputColorSpace:nx.workingColorSpace}const C_={clone:w_,merge:S_};class E_ extends zb{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1,clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=w_(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const a in this.uniforms){const n=this.uniforms[a].value;n&&n.isTexture?t.uniforms[a]={type:"t",value:n.toJSON(e).uuid}:n&&n.isColor?t.uniforms[a]={type:"c",value:n.getHex()}:n&&n.isVector2?t.uniforms[a]={type:"v2",value:n.toArray()}:n&&n.isVector3?t.uniforms[a]={type:"v3",value:n.toArray()}:n&&n.isVector4?t.uniforms[a]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?t.uniforms[a]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?t.uniforms[a]={type:"m4",value:n.toArray()}:t.uniforms[a]={value:n}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const n={};for(const a in this.extensions)!0===this.extensions[a]&&(n[a]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}}class k_ extends _b{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new qx,this.projectionMatrix=new qx,this.projectionMatrixInverse=new qx,this.coordinateSystem=jy}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const T_=new yx,N_=new Wy,P_=new Wy;class j_ extends k_{constructor(e=50,t=1,n=.1,a=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=a,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*Dy*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*Ly*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*Dy*Math.atan(Math.tan(.5*Ly*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,n){T_.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(T_.x,T_.y).multiplyScalar(-e/T_.z),T_.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set(T_.x,T_.y).multiplyScalar(-e/T_.z)}getViewSize(e,t){return this.getViewBounds(e,N_,P_),t.subVectors(P_,N_)}setViewOffset(e,t,n,a,r,i){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=a,this.view.width=r,this.view.height=i,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*Ly*this.fov)/this.zoom,n=2*t,a=this.aspect*n,r=-.5*a;const i=this.view;if(null!==this.view&&this.view.enabled){const e=i.fullWidth,s=i.fullHeight;r+=i.offsetX*a/e,t-=i.offsetY*n/s,a*=i.width/e,n*=i.height/s}const s=this.filmOffset;0!==s&&(r+=e*s/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+a,t,t-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const A_=-90;class R_ extends _b{constructor(e,t,n){super(),this.type="CubeCamera",this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;const a=new j_(A_,1,e,t);a.layers=this.layers,this.add(a);const r=new j_(A_,1,e,t);r.layers=this.layers,this.add(r);const i=new j_(A_,1,e,t);i.layers=this.layers,this.add(i);const s=new j_(A_,1,e,t);s.layers=this.layers,this.add(s);const o=new j_(A_,1,e,t);o.layers=this.layers,this.add(o);const l=new j_(A_,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[n,a,r,i,s,o]=t;for(const l of t)this.remove(l);if(e===jy)n.up.set(0,1,0),n.lookAt(1,0,0),a.up.set(0,1,0),a.lookAt(-1,0,0),r.up.set(0,0,-1),r.lookAt(0,1,0),i.up.set(0,0,1),i.lookAt(0,-1,0),s.up.set(0,1,0),s.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==Ay)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);n.up.set(0,-1,0),n.lookAt(-1,0,0),a.up.set(0,-1,0),a.lookAt(1,0,0),r.up.set(0,0,1),r.lookAt(0,1,0),i.up.set(0,0,-1),i.lookAt(0,-1,0),s.up.set(0,-1,0),s.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const l of t)this.add(l),l.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:n,activeMipmapLevel:a}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[r,i,s,o,l,c]=this.children,d=e.getRenderTarget(),u=e.getActiveCubeFace(),h=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;const m=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,a),e.render(t,r),e.setRenderTarget(n,1,a),e.render(t,i),e.setRenderTarget(n,2,a),e.render(t,s),e.setRenderTarget(n,3,a),e.render(t,o),e.setRenderTarget(n,4,a),e.render(t,l),n.texture.generateMipmaps=m,e.setRenderTarget(n,5,a),e.render(t,c),e.setRenderTarget(d,u,h),e.xr.enabled=p,n.texture.needsPMREMUpdate=!0}}class I_ extends ux{constructor(e,t,n,a,r,i,s,o,l,c){super(e=void 0!==e?e:[],t=void 0!==t?t:Ov,n,a,r,i,s,o,l,c),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class L_ extends mx{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const n={width:e,height:e,depth:1},a=[n,n,n,n,n,n];this.texture=new I_(a,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:Xv}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const n={uniforms:{tEquirect:{value:null}},vertexShader:"\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t"},a=new __(5,5,5),r=new E_({name:"CubemapFromEquirect",uniforms:w_(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:1,blending:0});r.uniforms.tEquirect.value=t;const i=new x_(a,r),s=t.minFilter;t.minFilter===Kv&&(t.minFilter=Xv);return new R_(1,10,this).update(e,i),t.minFilter=s,i.geometry.dispose(),i.material.dispose(),this}clear(e,t,n,a){const r=e.getRenderTarget();for(let i=0;i<6;i++)e.setRenderTarget(this,i),e.clear(t,n,a);e.setRenderTarget(r)}}const D_=new yx,U_=new yx,O_=new Gy;class F_{constructor(e=new yx(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,a){return this.normal.set(e,t,n),this.constant=a,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const a=D_.subVectors(n,t).cross(U_.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(a,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const n=e.delta(D_),a=this.normal.dot(n);if(0===a)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const r=-(e.start.dot(this.normal)+this.constant)/a;return r<0||r>1?null:t.copy(e.start).addScaledVector(n,r)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||O_.getNormalMatrix(e),a=this.coplanarPoint(D_).applyMatrix4(e),r=this.normal.applyMatrix3(n).normalize();return this.constant=-a.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const z_=new Fx,B_=new yx;class H_{constructor(e=new F_,t=new F_,n=new F_,a=new F_,r=new F_,i=new F_){this.planes=[e,t,n,a,r,i]}set(e,t,n,a,r,i){const s=this.planes;return s[0].copy(e),s[1].copy(t),s[2].copy(n),s[3].copy(a),s[4].copy(r),s[5].copy(i),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,t=2e3){const n=this.planes,a=e.elements,r=a[0],i=a[1],s=a[2],o=a[3],l=a[4],c=a[5],d=a[6],u=a[7],h=a[8],p=a[9],m=a[10],f=a[11],g=a[12],v=a[13],y=a[14],x=a[15];if(n[0].setComponents(o-r,u-l,f-h,x-g).normalize(),n[1].setComponents(o+r,u+l,f+h,x+g).normalize(),n[2].setComponents(o+i,u+c,f+p,x+v).normalize(),n[3].setComponents(o-i,u-c,f-p,x-v).normalize(),n[4].setComponents(o-s,u-d,f-m,x-y).normalize(),t===jy)n[5].setComponents(o+s,u+d,f+m,x+y).normalize();else{if(t!==Ay)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(s,d,m,y).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),z_.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),z_.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(z_)}intersectsSprite(e){return z_.center.set(0,0,0),z_.radius=.7071067811865476,z_.applyMatrix4(e.matrixWorld),this.intersectsSphere(z_)}intersectsSphere(e){const t=this.planes,n=e.center,a=-e.radius;for(let r=0;r<6;r++){if(t[r].distanceToPoint(n)<a)return!1}return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const a=t[n];if(B_.x=a.normal.x>0?e.max.x:e.min.x,B_.y=a.normal.y>0?e.max.y:e.min.y,B_.z=a.normal.z>0?e.max.z:e.min.z,a.distanceToPoint(B_)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function $_(){let e=null,t=!1,n=null,a=null;function r(t,i){n(t,i),a=e.requestAnimationFrame(r)}return{start:function(){!0!==t&&null!==n&&(a=e.requestAnimationFrame(r),t=!0)},stop:function(){e.cancelAnimationFrame(a),t=!1},setAnimationLoop:function(e){n=e},setContext:function(t){e=t}}}function V_(e,t){const n=t.isWebGL2,a=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),a.get(e)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);const n=a.get(t);n&&(e.deleteBuffer(n.buffer),a.delete(t))},update:function(t,r){if(t.isGLBufferAttribute){const e=a.get(t);return void((!e||e.version<t.version)&&a.set(t,{buffer:t.buffer,type:t.type,bytesPerElement:t.elementSize,version:t.version}))}t.isInterleavedBufferAttribute&&(t=t.data);const i=a.get(t);if(void 0===i)a.set(t,function(t,a){const r=t.array,i=t.usage,s=r.byteLength,o=e.createBuffer();let l;if(e.bindBuffer(a,o),e.bufferData(a,r,i),t.onUploadCallback(),r instanceof Float32Array)l=e.FLOAT;else if(r instanceof Uint16Array)if(t.isFloat16BufferAttribute){if(!n)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");l=e.HALF_FLOAT}else l=e.UNSIGNED_SHORT;else if(r instanceof Int16Array)l=e.SHORT;else if(r instanceof Uint32Array)l=e.UNSIGNED_INT;else if(r instanceof Int32Array)l=e.INT;else if(r instanceof Int8Array)l=e.BYTE;else if(r instanceof Uint8Array)l=e.UNSIGNED_BYTE;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+r);l=e.UNSIGNED_BYTE}return{buffer:o,type:l,bytesPerElement:r.BYTES_PER_ELEMENT,version:t.version,size:s}}(t,r));else if(i.version<t.version){if(i.size!==t.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,a,r){const i=a.array,s=a._updateRange,o=a.updateRanges;if(e.bindBuffer(r,t),-1===s.count&&0===o.length&&e.bufferSubData(r,0,i),0!==o.length){for(let t=0,a=o.length;t<a;t++){const a=o[t];n?e.bufferSubData(r,a.start*i.BYTES_PER_ELEMENT,i,a.start,a.count):e.bufferSubData(r,a.start*i.BYTES_PER_ELEMENT,i.subarray(a.start,a.start+a.count))}a.clearUpdateRanges()}-1!==s.count&&(n?e.bufferSubData(r,s.offset*i.BYTES_PER_ELEMENT,i,s.offset,s.count):e.bufferSubData(r,s.offset*i.BYTES_PER_ELEMENT,i.subarray(s.offset,s.offset+s.count)),s.count=-1),a.onUploadCallback()}(i.buffer,t,r),i.version=t.version}}}}class W_ extends t_{constructor(e=1,t=1,n=1,a=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:a};const r=e/2,i=t/2,s=Math.floor(n),o=Math.floor(a),l=s+1,c=o+1,d=e/s,u=t/o,h=[],p=[],m=[],f=[];for(let g=0;g<c;g++){const e=g*u-i;for(let t=0;t<l;t++){const n=t*d-r;p.push(n,-e,0),m.push(0,0,1),f.push(t/s),f.push(1-g/o)}}for(let g=0;g<o;g++)for(let e=0;e<s;e++){const t=e+l*g,n=e+l*(g+1),a=e+1+l*(g+1),r=e+1+l*g;h.push(t,n,r),h.push(n,a,r)}this.setIndex(h),this.setAttribute("position",new Xb(p,3)),this.setAttribute("normal",new Xb(m,3)),this.setAttribute("uv",new Xb(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new W_(e.width,e.height,e.widthSegments,e.heightSegments)}}const G_={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\tattribute float batchId;\n\tuniform highp sampler2D batchingTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( batchId );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat luminance( const in vec3 rgb ) {\n\tconst vec3 weights = vec3( 0.2126729, 0.7151522, 0.0721750 );\n\treturn dot( weights, rgb );\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"\nconst mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(\n\tvec3( 0.8224621, 0.177538, 0.0 ),\n\tvec3( 0.0331941, 0.9668058, 0.0 ),\n\tvec3( 0.0170827, 0.0723974, 0.9105199 )\n);\nconst mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.2249401, - 0.2249404, 0.0 ),\n\tvec3( - 0.0420569, 1.0420571, 0.0 ),\n\tvec3( - 0.0196376, - 0.0786361, 1.0982735 )\n);\nvec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );\n}\nvec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {\n\treturn vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );\n}\nvec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn sRGBTransferOETF( value );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t#if defined ( LEGACY_LIGHTS )\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\t\t}\n\t\treturn 1.0;\n\t#else\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tif ( cutoffDistance > 0.0 ) {\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t}\n\t\treturn distanceFalloff;\n\t#endif\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\t#else\n\t\tuniform float logDepthBufFC;\n\t#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\t#else\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\t\tgl_Position.z *= gl_Position.w;\n\t\t}\n\t#endif\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\t\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[MORPHTARGETS_COUNT];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\t#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t#endif\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\t#ifndef USE_INSTANCING_MORPH\n\t\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\t#endif\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t\t}\n\t#else\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\t\t#else\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\t\t#endif\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\t#ifdef MORPHTARGETS_TEXTURE\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t\t}\n\t#else\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\t\t#ifndef USE_MORPHNORMALS\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\t\t#endif\n\t#endif\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nvec2 packDepthToRG( in highp float v ) {\n\treturn packDepthToRGBA( v ).yx;\n}\nfloat unpackRGToDepth( const in highp vec2 v ) {\n\treturn unpackRGBAToDepth( vec4( v.xy, 0.0, 0.0 ) );\n}\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tfloat startCompression = 0.8 - 0.04;\n\tfloat desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min(color.r, min(color.g, color.b));\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max(color.r, max(color.g, color.b));\n\tif (peak < startCompression) return color;\n\tfloat d = 1. - startCompression;\n\tfloat newPeak = 1. - d * d / (peak + d - startCompression);\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / (desaturation * (peak - newPeak) + 1.);\n\treturn mix(color, vec3(1, 1, 1), g);\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\tvec3 transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},X_={common:{diffuse:{value:new Ub(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new Gy},alphaMap:{value:null},alphaMapTransform:{value:new Gy},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new Gy}},envmap:{envMap:{value:null},envMapRotation:{value:new Gy},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new Gy}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new Gy}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new Gy},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new Gy},normalScale:{value:new Wy(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new Gy},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new Gy}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new Gy}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new Gy}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Ub(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Ub(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new Gy},alphaTest:{value:0},uvTransform:{value:new Gy}},sprite:{diffuse:{value:new Ub(16777215)},opacity:{value:1},center:{value:new Wy(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new Gy},alphaMap:{value:null},alphaMapTransform:{value:new Gy},alphaTest:{value:0}}},q_={basic:{uniforms:S_([X_.common,X_.specularmap,X_.envmap,X_.aomap,X_.lightmap,X_.fog]),vertexShader:G_.meshbasic_vert,fragmentShader:G_.meshbasic_frag},lambert:{uniforms:S_([X_.common,X_.specularmap,X_.envmap,X_.aomap,X_.lightmap,X_.emissivemap,X_.bumpmap,X_.normalmap,X_.displacementmap,X_.fog,X_.lights,{emissive:{value:new Ub(0)}}]),vertexShader:G_.meshlambert_vert,fragmentShader:G_.meshlambert_frag},phong:{uniforms:S_([X_.common,X_.specularmap,X_.envmap,X_.aomap,X_.lightmap,X_.emissivemap,X_.bumpmap,X_.normalmap,X_.displacementmap,X_.fog,X_.lights,{emissive:{value:new Ub(0)},specular:{value:new Ub(1118481)},shininess:{value:30}}]),vertexShader:G_.meshphong_vert,fragmentShader:G_.meshphong_frag},standard:{uniforms:S_([X_.common,X_.envmap,X_.aomap,X_.lightmap,X_.emissivemap,X_.bumpmap,X_.normalmap,X_.displacementmap,X_.roughnessmap,X_.metalnessmap,X_.fog,X_.lights,{emissive:{value:new Ub(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:G_.meshphysical_vert,fragmentShader:G_.meshphysical_frag},toon:{uniforms:S_([X_.common,X_.aomap,X_.lightmap,X_.emissivemap,X_.bumpmap,X_.normalmap,X_.displacementmap,X_.gradientmap,X_.fog,X_.lights,{emissive:{value:new Ub(0)}}]),vertexShader:G_.meshtoon_vert,fragmentShader:G_.meshtoon_frag},matcap:{uniforms:S_([X_.common,X_.bumpmap,X_.normalmap,X_.displacementmap,X_.fog,{matcap:{value:null}}]),vertexShader:G_.meshmatcap_vert,fragmentShader:G_.meshmatcap_frag},points:{uniforms:S_([X_.points,X_.fog]),vertexShader:G_.points_vert,fragmentShader:G_.points_frag},dashed:{uniforms:S_([X_.common,X_.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:G_.linedashed_vert,fragmentShader:G_.linedashed_frag},depth:{uniforms:S_([X_.common,X_.displacementmap]),vertexShader:G_.depth_vert,fragmentShader:G_.depth_frag},normal:{uniforms:S_([X_.common,X_.bumpmap,X_.normalmap,X_.displacementmap,{opacity:{value:1}}]),vertexShader:G_.meshnormal_vert,fragmentShader:G_.meshnormal_frag},sprite:{uniforms:S_([X_.sprite,X_.fog]),vertexShader:G_.sprite_vert,fragmentShader:G_.sprite_frag},background:{uniforms:{uvTransform:{value:new Gy},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:G_.background_vert,fragmentShader:G_.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new Gy}},vertexShader:G_.backgroundCube_vert,fragmentShader:G_.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:G_.cube_vert,fragmentShader:G_.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:G_.equirect_vert,fragmentShader:G_.equirect_frag},distanceRGBA:{uniforms:S_([X_.common,X_.displacementmap,{referencePosition:{value:new yx},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:G_.distanceRGBA_vert,fragmentShader:G_.distanceRGBA_frag},shadow:{uniforms:S_([X_.lights,X_.fog,{color:{value:new Ub(0)},opacity:{value:1}}]),vertexShader:G_.shadow_vert,fragmentShader:G_.shadow_frag}};q_.physical={uniforms:S_([q_.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new Gy},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new Gy},clearcoatNormalScale:{value:new Wy(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new Gy},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new Gy},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new Gy},sheen:{value:0},sheenColor:{value:new Ub(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new Gy},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new Gy},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new Gy},transmissionSamplerSize:{value:new Wy},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new Gy},attenuationDistance:{value:0},attenuationColor:{value:new Ub(0)},specularColor:{value:new Ub(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new Gy},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new Gy},anisotropyVector:{value:new Wy},anisotropyMap:{value:null},anisotropyMapTransform:{value:new Gy}}]),vertexShader:G_.meshphysical_vert,fragmentShader:G_.meshphysical_frag};const K_={r:0,b:0,g:0},Y_=new rb,J_=new qx;function Z_(e,t,n,a,r,i,s){const o=new Ub(0);let l,c,d=!0===i?0:1,u=null,h=0,p=null;function m(t,n){t.getRGB(K_,M_(e)),a.buffers.color.setClear(K_.r,K_.g,K_.b,n,s)}return{getClearColor:function(){return o},setClearColor:function(e,t=1){o.set(e),d=t,m(o,d)},getClearAlpha:function(){return d},setClearAlpha:function(e){d=e,m(o,d)},render:function(i,f){let g=!1,v=!0===f.isScene?f.background:null;if(v&&v.isTexture){v=(f.backgroundBlurriness>0?n:t).get(v)}null===v?m(o,d):v&&v.isColor&&(m(v,1),g=!0);const y=e.xr.getEnvironmentBlendMode();"additive"===y?a.buffers.color.setClear(0,0,0,1,s):"alpha-blend"===y&&a.buffers.color.setClear(0,0,0,0,s),(e.autoClear||g)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),v&&(v.isCubeTexture||v.mapping===zv)?(void 0===c&&(c=new x_(new __(1,1,1),new E_({name:"BackgroundCubeMaterial",uniforms:w_(q_.backgroundCube.uniforms),vertexShader:q_.backgroundCube.vertexShader,fragmentShader:q_.backgroundCube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),c.geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),r.update(c)),Y_.copy(f.backgroundRotation),Y_.x*=-1,Y_.y*=-1,Y_.z*=-1,v.isCubeTexture&&!1===v.isRenderTargetTexture&&(Y_.y*=-1,Y_.z*=-1),c.material.uniforms.envMap.value=v,c.material.uniforms.flipEnvMap.value=v.isCubeTexture&&!1===v.isRenderTargetTexture?-1:1,c.material.uniforms.backgroundBlurriness.value=f.backgroundBlurriness,c.material.uniforms.backgroundIntensity.value=f.backgroundIntensity,c.material.uniforms.backgroundRotation.value.setFromMatrix4(J_.makeRotationFromEuler(Y_)),c.material.toneMapped=nx.getTransfer(v.colorSpace)!==vy,u===v&&h===v.version&&p===e.toneMapping||(c.material.needsUpdate=!0,u=v,h=v.version,p=e.toneMapping),c.layers.enableAll(),i.unshift(c,c.geometry,c.material,0,0,null)):v&&v.isTexture&&(void 0===l&&(l=new x_(new W_(2,2),new E_({name:"BackgroundMaterial",uniforms:w_(q_.background.uniforms),vertexShader:q_.background.vertexShader,fragmentShader:q_.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(l)),l.material.uniforms.t2D.value=v,l.material.uniforms.backgroundIntensity.value=f.backgroundIntensity,l.material.toneMapped=nx.getTransfer(v.colorSpace)!==vy,!0===v.matrixAutoUpdate&&v.updateMatrix(),l.material.uniforms.uvTransform.value.copy(v.matrix),u===v&&h===v.version&&p===e.toneMapping||(l.material.needsUpdate=!0,u=v,h=v.version,p=e.toneMapping),l.layers.enableAll(),i.unshift(l,l.geometry,l.material,0,0,null))}}}function Q_(e,t,n,a){const r=e.getParameter(e.MAX_VERTEX_ATTRIBS),i=a.isWebGL2?null:t.get("OES_vertex_array_object"),s=a.isWebGL2||null!==i,o={},l=p(null);let c=l,d=!1;function u(t){return a.isWebGL2?e.bindVertexArray(t):i.bindVertexArrayOES(t)}function h(t){return a.isWebGL2?e.deleteVertexArray(t):i.deleteVertexArrayOES(t)}function p(e){const t=[],n=[],a=[];for(let i=0;i<r;i++)t[i]=0,n[i]=0,a[i]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:n,attributeDivisors:a,object:e,attributes:{},index:null}}function m(){const e=c.newAttributes;for(let t=0,n=e.length;t<n;t++)e[t]=0}function f(e){g(e,0)}function g(n,r){const i=c.newAttributes,s=c.enabledAttributes,o=c.attributeDivisors;if(i[n]=1,0===s[n]&&(e.enableVertexAttribArray(n),s[n]=1),o[n]!==r){(a.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[a.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](n,r),o[n]=r}}function v(){const t=c.newAttributes,n=c.enabledAttributes;for(let a=0,r=n.length;a<r;a++)n[a]!==t[a]&&(e.disableVertexAttribArray(a),n[a]=0)}function y(t,n,a,r,i,s,o){!0===o?e.vertexAttribIPointer(t,n,a,i,s):e.vertexAttribPointer(t,n,a,r,i,s)}function x(){b(),d=!0,c!==l&&(c=l,u(c.object))}function b(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(r,l,h,x,b){let _=!1;if(s){const t=function(t,n,r){const s=!0===r.wireframe;let l=o[t.id];void 0===l&&(l={},o[t.id]=l);let c=l[n.id];void 0===c&&(c={},l[n.id]=c);let d=c[s];void 0===d&&(d=p(a.isWebGL2?e.createVertexArray():i.createVertexArrayOES()),c[s]=d);return d}(x,h,l);c!==t&&(c=t,u(c.object)),_=function(e,t,n,a){const r=c.attributes,i=t.attributes;let s=0;const o=n.getAttributes();for(const l in o){if(o[l].location>=0){const t=r[l];let n=i[l];if(void 0===n&&("instanceMatrix"===l&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===l&&e.instanceColor&&(n=e.instanceColor)),void 0===t)return!0;if(t.attribute!==n)return!0;if(n&&t.data!==n.data)return!0;s++}}return c.attributesNum!==s||c.index!==a}(r,x,h,b),_&&function(e,t,n,a){const r={},i=t.attributes;let s=0;const o=n.getAttributes();for(const l in o){if(o[l].location>=0){let t=i[l];void 0===t&&("instanceMatrix"===l&&e.instanceMatrix&&(t=e.instanceMatrix),"instanceColor"===l&&e.instanceColor&&(t=e.instanceColor));const n={};n.attribute=t,t&&t.data&&(n.data=t.data),r[l]=n,s++}}c.attributes=r,c.attributesNum=s,c.index=a}(r,x,h,b)}else{const e=!0===l.wireframe;c.geometry===x.id&&c.program===h.id&&c.wireframe===e||(c.geometry=x.id,c.program=h.id,c.wireframe=e,_=!0)}null!==b&&n.update(b,e.ELEMENT_ARRAY_BUFFER),(_||d)&&(d=!1,function(r,i,s,o){if(!1===a.isWebGL2&&(r.isInstancedMesh||o.isInstancedBufferGeometry)&&null===t.get("ANGLE_instanced_arrays"))return;m();const l=o.attributes,c=s.getAttributes(),d=i.defaultAttributeValues;for(const t in c){const i=c[t];if(i.location>=0){let s=l[t];if(void 0===s&&("instanceMatrix"===t&&r.instanceMatrix&&(s=r.instanceMatrix),"instanceColor"===t&&r.instanceColor&&(s=r.instanceColor)),void 0!==s){const t=s.normalized,l=s.itemSize,c=n.get(s);if(void 0===c)continue;const d=c.buffer,u=c.type,h=c.bytesPerElement,p=!0===a.isWebGL2&&(u===e.INT||u===e.UNSIGNED_INT||s.gpuType===Zv);if(s.isInterleavedBufferAttribute){const n=s.data,a=n.stride,c=s.offset;if(n.isInstancedInterleavedBuffer){for(let e=0;e<i.locationSize;e++)g(i.location+e,n.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=n.meshPerAttribute*n.count)}else for(let e=0;e<i.locationSize;e++)f(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,d);for(let e=0;e<i.locationSize;e++)y(i.location+e,l/i.locationSize,u,t,a*h,(c+l/i.locationSize*e)*h,p)}else{if(s.isInstancedBufferAttribute){for(let e=0;e<i.locationSize;e++)g(i.location+e,s.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=s.meshPerAttribute*s.count)}else for(let e=0;e<i.locationSize;e++)f(i.location+e);e.bindBuffer(e.ARRAY_BUFFER,d);for(let e=0;e<i.locationSize;e++)y(i.location+e,l/i.locationSize,u,t,l*h,l/i.locationSize*e*h,p)}}else if(void 0!==d){const n=d[t];if(void 0!==n)switch(n.length){case 2:e.vertexAttrib2fv(i.location,n);break;case 3:e.vertexAttrib3fv(i.location,n);break;case 4:e.vertexAttrib4fv(i.location,n);break;default:e.vertexAttrib1fv(i.location,n)}}}}v()}(r,l,h,x),null!==b&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.get(b).buffer))},reset:x,resetDefaultState:b,dispose:function(){x();for(const e in o){const t=o[e];for(const e in t){const n=t[e];for(const e in n)h(n[e].object),delete n[e];delete t[e]}delete o[e]}},releaseStatesOfGeometry:function(e){if(void 0===o[e.id])return;const t=o[e.id];for(const n in t){const e=t[n];for(const t in e)h(e[t].object),delete e[t];delete t[n]}delete o[e.id]},releaseStatesOfProgram:function(e){for(const t in o){const n=o[t];if(void 0===n[e.id])continue;const a=n[e.id];for(const e in a)h(a[e].object),delete a[e];delete n[e.id]}},initAttributes:m,enableAttribute:f,disableUnusedAttributes:v}}function ew(e,t,n,a){const r=a.isWebGL2;let i;this.setMode=function(e){i=e},this.render=function(t,a){e.drawArrays(i,t,a),n.update(a,i,1)},this.renderInstances=function(a,s,o){if(0===o)return;let l,c;if(r)l=e,c="drawArraysInstanced";else if(l=t.get("ANGLE_instanced_arrays"),c="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[c](i,a,s,o),n.update(s,i,o)},this.renderMultiDraw=function(e,a,r){if(0===r)return;const s=t.get("WEBGL_multi_draw");if(null===s)for(let t=0;t<r;t++)this.render(e[t],a[t]);else{s.multiDrawArraysWEBGL(i,e,0,a,0,r);let t=0;for(let e=0;e<r;e++)t+=a[e];n.update(t,i,1)}}}function tw(e,t,n){let a;function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const i="undefined"!=typeof WebGL2RenderingContext&&"WebGL2RenderingContext"===e.constructor.name;let s=void 0!==n.precision?n.precision:"highp";const o=r(s);o!==s&&(console.warn("THREE.WebGLRenderer:",s,"not supported, using",o,"instead."),s=o);const l=i||t.has("WEBGL_draw_buffers"),c=!0===n.logarithmicDepthBuffer,d=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),u=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_TEXTURE_SIZE),p=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),m=e.getParameter(e.MAX_VERTEX_ATTRIBS),f=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),g=e.getParameter(e.MAX_VARYING_VECTORS),v=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),y=u>0,x=i||t.has("OES_texture_float");return{isWebGL2:i,drawBuffers:l,getMaxAnisotropy:function(){if(void 0!==a)return a;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");a=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else a=0;return a},getMaxPrecision:r,precision:s,logarithmicDepthBuffer:c,maxTextures:d,maxVertexTextures:u,maxTextureSize:h,maxCubemapSize:p,maxAttributes:m,maxVertexUniforms:f,maxVaryings:g,maxFragmentUniforms:v,vertexTextures:y,floatFragmentTextures:x,floatVertexTextures:y&&x,maxSamples:i?e.getParameter(e.MAX_SAMPLES):0}}function nw(e){const t=this;let n=null,a=0,r=!1,i=!1;const s=new F_,o=new Gy,l={value:null,needsUpdate:!1};function c(e,n,a,r){const i=null!==e?e.length:0;let c=null;if(0!==i){if(c=l.value,!0!==r||null===c){const t=a+4*i,r=n.matrixWorldInverse;o.getNormalMatrix(r),(null===c||c.length<t)&&(c=new Float32Array(t));for(let n=0,l=a;n!==i;++n,l+=4)s.copy(e[n]).applyMatrix4(r,o),s.normal.toArray(c,l),c[l+3]=s.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=i,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const n=0!==e.length||t||0!==a||r;return r=t,a=e.length,n},this.beginShadows=function(){i=!0,c(null)},this.endShadows=function(){i=!1},this.setGlobalState=function(e,t){n=c(e,t,0)},this.setState=function(s,o,d){const u=s.clippingPlanes,h=s.clipIntersection,p=s.clipShadows,m=e.get(s);if(!r||null===u||0===u.length||i&&!p)i?c(null):function(){l.value!==n&&(l.value=n,l.needsUpdate=a>0);t.numPlanes=a,t.numIntersection=0}();else{const e=i?0:a,t=4*e;let r=m.clippingState||null;l.value=r,r=c(u,o,t,d);for(let a=0;a!==t;++a)r[a]=n[a];m.clippingState=r,this.numIntersection=h?this.numPlanes:0,this.numPlanes+=e}}}function aw(e){let t=new WeakMap;function n(e,t){return 303===t?e.mapping=Ov:304===t&&(e.mapping=Fv),e}function a(e){const n=e.target;n.removeEventListener("dispose",a);const r=t.get(n);void 0!==r&&(t.delete(n),r.dispose())}return{get:function(r){if(r&&r.isTexture){const i=r.mapping;if(303===i||304===i){if(t.has(r)){return n(t.get(r).texture,r.mapping)}{const i=r.image;if(i&&i.height>0){const s=new L_(i.height);return s.fromEquirectangularTexture(e,r),t.set(r,s),r.addEventListener("dispose",a),n(s.texture,r.mapping)}return null}}}return r},dispose:function(){t=new WeakMap}}}class rw extends k_{constructor(e=-1,t=1,n=1,a=-1,r=.1,i=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=a,this.near=r,this.far=i,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,n,a,r,i){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=a,this.view.width=r,this.view.height=i,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,a=(this.top+this.bottom)/2;let r=n-e,i=n+e,s=a+t,o=a-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,i=r+e*this.view.width,s-=t*this.view.offsetY,o=s-t*this.view.height}this.projectionMatrix.makeOrthographic(r,i,s,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}const iw=[.125,.215,.35,.446,.526,.582],sw=20,ow=new rw,lw=new Ub;let cw=null,dw=0,uw=0;const hw=(1+Math.sqrt(5))/2,pw=1/hw,mw=[new yx(1,1,1),new yx(-1,1,1),new yx(1,1,-1),new yx(-1,1,-1),new yx(0,hw,pw),new yx(0,hw,-pw),new yx(pw,0,hw),new yx(-pw,0,hw),new yx(hw,pw,0),new yx(-hw,pw,0)];class fw{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,n=.1,a=100){cw=this._renderer.getRenderTarget(),dw=this._renderer.getActiveCubeFace(),uw=this._renderer.getActiveMipmapLevel(),this._setSize(256);const r=this._allocateTargets();return r.depthBuffer=!0,this._sceneToCubeUV(e,n,a,r),t>0&&this._blur(r,0,0,t),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=xw(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=yw(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(cw,dw,uw),e.scissorTest=!1,vw(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===Ov||e.mapping===Fv?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),cw=this._renderer.getRenderTarget(),dw=this._renderer.getActiveCubeFace(),uw=this._renderer.getActiveMipmapLevel();const n=t||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,n={magFilter:Xv,minFilter:Xv,generateMipmaps:!1,type:ty,format:ay,colorSpace:py,depthBuffer:!1},a=gw(e,t,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=gw(e,t,n);const{_lodMax:a}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],n=[],a=[];let r=e;const i=e-4+1+iw.length;for(let s=0;s<i;s++){const i=Math.pow(2,r);n.push(i);let o=1/i;s>e-4?o=iw[s-e+4-1]:0===s&&(o=0),a.push(o);const l=1/(i-2),c=-l,d=1+l,u=[c,c,d,c,d,d,c,c,d,d,c,d],h=6,p=6,m=3,f=2,g=1,v=new Float32Array(m*p*h),y=new Float32Array(f*p*h),x=new Float32Array(g*p*h);for(let e=0;e<h;e++){const t=e%3*2/3-1,n=e>2?0:-1,a=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0];v.set(a,m*p*e),y.set(u,f*p*e);const r=[e,e,e,e,e,e];x.set(r,g*p*e)}const b=new t_;b.setAttribute("position",new Vb(v,m)),b.setAttribute("uv",new Vb(y,f)),b.setAttribute("faceIndex",new Vb(x,g)),t.push(b),r>4&&r--}return{lodPlanes:t,sizeLods:n,sigmas:a}}(a)),this._blurMaterial=function(e,t,n){const a=new Float32Array(sw),r=new yx(0,1,0),i=new E_({name:"SphericalGaussianBlur",defines:{n:sw,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/n,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:a},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:bw(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1});return i}(a,e,t)}return a}_compileMaterial(e){const t=new x_(this._lodPlanes[0],e);this._renderer.compile(t,ow)}_sceneToCubeUV(e,t,n,a){const r=new j_(90,1,t,n),i=[1,-1,1,1,1,1],s=[1,1,1,-1,-1,-1],o=this._renderer,l=o.autoClear,c=o.toneMapping;o.getClearColor(lw),o.toneMapping=0,o.autoClear=!1;const d=new Bb({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),u=new x_(new __,d);let h=!1;const p=e.background;p?p.isColor&&(d.color.copy(p),e.background=null,h=!0):(d.color.copy(lw),h=!0);for(let m=0;m<6;m++){const t=m%3;0===t?(r.up.set(0,i[m],0),r.lookAt(s[m],0,0)):1===t?(r.up.set(0,0,i[m]),r.lookAt(0,s[m],0)):(r.up.set(0,i[m],0),r.lookAt(0,0,s[m]));const n=this._cubeSize;vw(a,t*n,m>2?n:0,n,n),o.setRenderTarget(a),h&&o.render(u,r),o.render(e,r)}u.geometry.dispose(),u.material.dispose(),o.toneMapping=c,o.autoClear=l,e.background=p}_textureToCubeUV(e,t){const n=this._renderer,a=e.mapping===Ov||e.mapping===Fv;a?(null===this._cubemapMaterial&&(this._cubemapMaterial=xw()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=yw());const r=a?this._cubemapMaterial:this._equirectMaterial,i=new x_(this._lodPlanes[0],r);r.uniforms.envMap.value=e;const s=this._cubeSize;vw(t,0,0,3*s,2*s),n.setRenderTarget(t),n.render(i,ow)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;for(let a=1;a<this._lodPlanes.length;a++){const t=Math.sqrt(this._sigmas[a]*this._sigmas[a]-this._sigmas[a-1]*this._sigmas[a-1]),n=mw[(a-1)%mw.length];this._blur(e,a-1,a,t,n)}t.autoClear=n}_blur(e,t,n,a,r){const i=this._pingPongRenderTarget;this._halfBlur(e,i,t,n,a,"latitudinal",r),this._halfBlur(i,e,n,n,a,"longitudinal",r)}_halfBlur(e,t,n,a,r,i,s){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==i&&"longitudinal"!==i&&console.error("blur direction must be either latitudinal or longitudinal!");const c=new x_(this._lodPlanes[a],l),d=l.uniforms,u=this._sizeLods[n]-1,h=isFinite(r)?Math.PI/(2*u):2*Math.PI/39,p=r/h,m=isFinite(r)?1+Math.floor(3*p):sw;m>sw&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${m} samples when the maximum is set to 20`);const f=[];let g=0;for(let x=0;x<sw;++x){const e=x/p,t=Math.exp(-e*e/2);f.push(t),0===x?g+=t:x<m&&(g+=2*t)}for(let x=0;x<f.length;x++)f[x]=f[x]/g;d.envMap.value=e.texture,d.samples.value=m,d.weights.value=f,d.latitudinal.value="latitudinal"===i,s&&(d.poleAxis.value=s);const{_lodMax:v}=this;d.dTheta.value=h,d.mipInt.value=v-n;const y=this._sizeLods[a];vw(t,3*y*(a>v-4?a-v+4:0),4*(this._cubeSize-y),3*y,2*y),o.setRenderTarget(t),o.render(c,ow)}}function gw(e,t,n){const a=new mx(e,t,n);return a.texture.mapping=zv,a.texture.name="PMREM.cubeUv",a.scissorTest=!0,a}function vw(e,t,n,a,r){e.viewport.set(t,n,a,r),e.scissor.set(t,n,a,r)}function yw(){return new E_({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:bw(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function xw(){return new E_({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:bw(),fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:0,depthTest:!1,depthWrite:!1})}function bw(){return"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t"}function _w(e){let t=new WeakMap,n=null;function a(e){const n=e.target;n.removeEventListener("dispose",a);const r=t.get(n);void 0!==r&&(t.delete(n),r.dispose())}return{get:function(r){if(r&&r.isTexture){const i=r.mapping,s=303===i||304===i,o=i===Ov||i===Fv;if(s||o){if(r.isRenderTargetTexture&&!0===r.needsPMREMUpdate){r.needsPMREMUpdate=!1;let a=t.get(r);return null===n&&(n=new fw(e)),a=s?n.fromEquirectangular(r,a):n.fromCubemap(r,a),t.set(r,a),a.texture}if(t.has(r))return t.get(r).texture;{const i=r.image;if(s&&i&&i.height>0||o&&i&&function(e){let t=0;const n=6;for(let a=0;a<n;a++)void 0!==e[a]&&t++;return t===n}(i)){null===n&&(n=new fw(e));const i=s?n.fromEquirectangular(r):n.fromCubemap(r);return t.set(r,i),r.addEventListener("dispose",a),i.texture}return null}}}return r},dispose:function(){t=new WeakMap,null!==n&&(n.dispose(),n=null)}}}function ww(e){const t={};function n(n){if(void 0!==t[n])return t[n];let a;switch(n){case"WEBGL_depth_texture":a=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":a=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":a=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":a=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:a=e.getExtension(n)}return t[n]=a,a}return{has:function(e){return null!==n(e)},init:function(e){e.isWebGL2?(n("EXT_color_buffer_float"),n("WEBGL_clip_cull_distance")):(n("WEBGL_depth_texture"),n("OES_texture_float"),n("OES_texture_half_float"),n("OES_texture_half_float_linear"),n("OES_standard_derivatives"),n("OES_element_index_uint"),n("OES_vertex_array_object"),n("ANGLE_instanced_arrays")),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture")},get:function(e){const t=n(e);return null===t&&console.warn("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function Sw(e,t,n,a){const r={},i=new WeakMap;function s(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const n in o.attributes)t.remove(o.attributes[n]);for(const n in o.morphAttributes){const e=o.morphAttributes[n];for(let n=0,a=e.length;n<a;n++)t.remove(e[n])}o.removeEventListener("dispose",s),delete r[o.id];const l=i.get(o);l&&(t.remove(l),i.delete(o)),a.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,n.memory.geometries--}function o(e){const n=[],a=e.index,r=e.attributes.position;let s=0;if(null!==a){const e=a.array;s=a.version;for(let t=0,a=e.length;t<a;t+=3){const a=e[t+0],r=e[t+1],i=e[t+2];n.push(a,r,r,i,i,a)}}else{if(void 0===r)return;{const e=r.array;s=r.version;for(let t=0,a=e.length/3-1;t<a;t+=3){const e=t+0,a=t+1,r=t+2;n.push(e,a,a,r,r,e)}}}const o=new(qy(n)?Gb:Wb)(n,1);o.version=s;const l=i.get(e);l&&t.remove(l),i.set(e,o)}return{get:function(e,t){return!0===r[t.id]||(t.addEventListener("dispose",s),r[t.id]=!0,n.memory.geometries++),t},update:function(n){const a=n.attributes;for(const i in a)t.update(a[i],e.ARRAY_BUFFER);const r=n.morphAttributes;for(const i in r){const n=r[i];for(let a=0,r=n.length;a<r;a++)t.update(n[a],e.ARRAY_BUFFER)}},getWireframeAttribute:function(e){const t=i.get(e);if(t){const n=e.index;null!==n&&t.version<n.version&&o(e)}else o(e);return i.get(e)}}}function Mw(e,t,n,a){const r=a.isWebGL2;let i,s,o;this.setMode=function(e){i=e},this.setIndex=function(e){s=e.type,o=e.bytesPerElement},this.render=function(t,a){e.drawElements(i,a,s,t*o),n.update(a,i,1)},this.renderInstances=function(a,l,c){if(0===c)return;let d,u;if(r)d=e,u="drawElementsInstanced";else if(d=t.get("ANGLE_instanced_arrays"),u="drawElementsInstancedANGLE",null===d)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");d[u](i,l,s,a*o,c),n.update(l,i,c)},this.renderMultiDraw=function(e,a,r){if(0===r)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<r;t++)this.render(e[t]/o,a[t]);else{l.multiDrawElementsWEBGL(i,a,0,s,e,0,r);let t=0;for(let e=0;e<r;e++)t+=a[e];n.update(t,i,1)}}}function Cw(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(n,a,r){switch(t.calls++,a){case e.TRIANGLES:t.triangles+=r*(n/3);break;case e.LINES:t.lines+=r*(n/2);break;case e.LINE_STRIP:t.lines+=r*(n-1);break;case e.LINE_LOOP:t.lines+=r*n;break;case e.POINTS:t.points+=r*n;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",a)}}}}function Ew(e,t){return e[0]-t[0]}function kw(e,t){return Math.abs(t[1])-Math.abs(e[1])}function Tw(e,t,n){const a={},r=new Float32Array(8),i=new WeakMap,s=new hx,o=[];for(let l=0;l<8;l++)o[l]=[l,0];return{update:function(l,c,d){const u=l.morphTargetInfluences;if(!0===t.isWebGL2){const a=c.morphAttributes.position||c.morphAttributes.normal||c.morphAttributes.color,r=void 0!==a?a.length:0;let o=i.get(c);if(void 0===o||o.count!==r){let e=function(){v.dispose(),i.delete(c),c.removeEventListener("dispose",e)};void 0!==o&&o.texture.dispose();const n=void 0!==c.morphAttributes.position,a=void 0!==c.morphAttributes.normal,l=void 0!==c.morphAttributes.color,d=c.morphAttributes.position||[],u=c.morphAttributes.normal||[],h=c.morphAttributes.color||[];let p=0;!0===n&&(p=1),!0===a&&(p=2),!0===l&&(p=3);let m=c.attributes.position.count*p,f=1;m>t.maxTextureSize&&(f=Math.ceil(m/t.maxTextureSize),m=t.maxTextureSize);const g=new Float32Array(m*f*4*r),v=new fx(g,m,f,r);v.type=ey,v.needsUpdate=!0;const y=4*p;for(let t=0;t<r;t++){const e=d[t],r=u[t],i=h[t],o=m*f*4*t;for(let t=0;t<e.count;t++){const c=t*y;!0===n&&(s.fromBufferAttribute(e,t),g[o+c+0]=s.x,g[o+c+1]=s.y,g[o+c+2]=s.z,g[o+c+3]=0),!0===a&&(s.fromBufferAttribute(r,t),g[o+c+4]=s.x,g[o+c+5]=s.y,g[o+c+6]=s.z,g[o+c+7]=0),!0===l&&(s.fromBufferAttribute(i,t),g[o+c+8]=s.x,g[o+c+9]=s.y,g[o+c+10]=s.z,g[o+c+11]=4===i.itemSize?s.w:1)}}o={count:r,texture:v,size:new Wy(m,f)},i.set(c,o),c.addEventListener("dispose",e)}if(!0===l.isInstancedMesh&&null!==l.morphTexture)d.getUniforms().setValue(e,"morphTexture",l.morphTexture,n);else{let t=0;for(let e=0;e<u.length;e++)t+=u[e];const n=c.morphTargetsRelative?1:1-t;d.getUniforms().setValue(e,"morphTargetBaseInfluence",n),d.getUniforms().setValue(e,"morphTargetInfluences",u)}d.getUniforms().setValue(e,"morphTargetsTexture",o.texture,n),d.getUniforms().setValue(e,"morphTargetsTextureSize",o.size)}else{const t=void 0===u?0:u.length;let n=a[c.id];if(void 0===n||n.length!==t){n=[];for(let e=0;e<t;e++)n[e]=[e,0];a[c.id]=n}for(let e=0;e<t;e++){const t=n[e];t[0]=e,t[1]=u[e]}n.sort(kw);for(let e=0;e<8;e++)e<t&&n[e][1]?(o[e][0]=n[e][0],o[e][1]=n[e][1]):(o[e][0]=Number.MAX_SAFE_INTEGER,o[e][1]=0);o.sort(Ew);const i=c.morphAttributes.position,s=c.morphAttributes.normal;let l=0;for(let e=0;e<8;e++){const t=o[e],n=t[0],a=t[1];n!==Number.MAX_SAFE_INTEGER&&a?(i&&c.getAttribute("morphTarget"+e)!==i[n]&&c.setAttribute("morphTarget"+e,i[n]),s&&c.getAttribute("morphNormal"+e)!==s[n]&&c.setAttribute("morphNormal"+e,s[n]),r[e]=a,l+=a):(i&&!0===c.hasAttribute("morphTarget"+e)&&c.deleteAttribute("morphTarget"+e),s&&!0===c.hasAttribute("morphNormal"+e)&&c.deleteAttribute("morphNormal"+e),r[e]=0)}const h=c.morphTargetsRelative?1:1-l;d.getUniforms().setValue(e,"morphTargetBaseInfluence",h),d.getUniforms().setValue(e,"morphTargetInfluences",r)}}}}function Nw(e,t,n,a){let r=new WeakMap;function i(e){const t=e.target;t.removeEventListener("dispose",i),n.remove(t.instanceMatrix),null!==t.instanceColor&&n.remove(t.instanceColor)}return{update:function(s){const o=a.render.frame,l=s.geometry,c=t.get(s,l);if(r.get(c)!==o&&(t.update(c),r.set(c,o)),s.isInstancedMesh&&(!1===s.hasEventListener("dispose",i)&&s.addEventListener("dispose",i),r.get(s)!==o&&(n.update(s.instanceMatrix,e.ARRAY_BUFFER),null!==s.instanceColor&&n.update(s.instanceColor,e.ARRAY_BUFFER),r.set(s,o))),s.isSkinnedMesh){const e=s.skeleton;r.get(e)!==o&&(e.update(),r.set(e,o))}return c},dispose:function(){r=new WeakMap}}}class Pw extends ux{constructor(e,t,n,a,r,i,s,o,l,c){if((c=void 0!==c?c:ry)!==ry&&c!==iy)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===n&&c===ry&&(n=Qv),void 0===n&&c===iy&&(n=ny),super(null,a,r,i,s,o,c,n,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==s?s:Vv,this.minFilter=void 0!==o?o:Vv,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}const jw=new ux,Aw=new Pw(1,1);Aw.compareFunction=515;const Rw=new fx,Iw=new gx,Lw=new I_,Dw=[],Uw=[],Ow=new Float32Array(16),Fw=new Float32Array(9),zw=new Float32Array(4);function Bw(e,t,n){const a=e[0];if(a<=0||a>0)return e;const r=t*n;let i=Dw[r];if(void 0===i&&(i=new Float32Array(r),Dw[r]=i),0!==t){a.toArray(i,0);for(let a=1,r=0;a!==t;++a)r+=n,e[a].toArray(i,r)}return i}function Hw(e,t){if(e.length!==t.length)return!1;for(let n=0,a=e.length;n<a;n++)if(e[n]!==t[n])return!1;return!0}function $w(e,t){for(let n=0,a=t.length;n<a;n++)e[n]=t[n]}function Vw(e,t){let n=Uw[t];void 0===n&&(n=new Int32Array(t),Uw[t]=n);for(let a=0;a!==t;++a)n[a]=e.allocateTextureUnit();return n}function Ww(e,t){const n=this.cache;n[0]!==t&&(e.uniform1f(this.addr,t),n[0]=t)}function Gw(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Hw(n,t))return;e.uniform2fv(this.addr,t),$w(n,t)}}function Xw(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else if(void 0!==t.r)n[0]===t.r&&n[1]===t.g&&n[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),n[0]=t.r,n[1]=t.g,n[2]=t.b);else{if(Hw(n,t))return;e.uniform3fv(this.addr,t),$w(n,t)}}function qw(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Hw(n,t))return;e.uniform4fv(this.addr,t),$w(n,t)}}function Kw(e,t){const n=this.cache,a=t.elements;if(void 0===a){if(Hw(n,t))return;e.uniformMatrix2fv(this.addr,!1,t),$w(n,t)}else{if(Hw(n,a))return;zw.set(a),e.uniformMatrix2fv(this.addr,!1,zw),$w(n,a)}}function Yw(e,t){const n=this.cache,a=t.elements;if(void 0===a){if(Hw(n,t))return;e.uniformMatrix3fv(this.addr,!1,t),$w(n,t)}else{if(Hw(n,a))return;Fw.set(a),e.uniformMatrix3fv(this.addr,!1,Fw),$w(n,a)}}function Jw(e,t){const n=this.cache,a=t.elements;if(void 0===a){if(Hw(n,t))return;e.uniformMatrix4fv(this.addr,!1,t),$w(n,t)}else{if(Hw(n,a))return;Ow.set(a),e.uniformMatrix4fv(this.addr,!1,Ow),$w(n,a)}}function Zw(e,t){const n=this.cache;n[0]!==t&&(e.uniform1i(this.addr,t),n[0]=t)}function Qw(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Hw(n,t))return;e.uniform2iv(this.addr,t),$w(n,t)}}function eS(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(Hw(n,t))return;e.uniform3iv(this.addr,t),$w(n,t)}}function tS(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Hw(n,t))return;e.uniform4iv(this.addr,t),$w(n,t)}}function nS(e,t){const n=this.cache;n[0]!==t&&(e.uniform1ui(this.addr,t),n[0]=t)}function aS(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(Hw(n,t))return;e.uniform2uiv(this.addr,t),$w(n,t)}}function rS(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(Hw(n,t))return;e.uniform3uiv(this.addr,t),$w(n,t)}}function iS(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(Hw(n,t))return;e.uniform4uiv(this.addr,t),$w(n,t)}}function sS(e,t,n){const a=this.cache,r=n.allocateTextureUnit();a[0]!==r&&(e.uniform1i(this.addr,r),a[0]=r);const i=this.type===e.SAMPLER_2D_SHADOW?Aw:jw;n.setTexture2D(t||i,r)}function oS(e,t,n){const a=this.cache,r=n.allocateTextureUnit();a[0]!==r&&(e.uniform1i(this.addr,r),a[0]=r),n.setTexture3D(t||Iw,r)}function lS(e,t,n){const a=this.cache,r=n.allocateTextureUnit();a[0]!==r&&(e.uniform1i(this.addr,r),a[0]=r),n.setTextureCube(t||Lw,r)}function cS(e,t,n){const a=this.cache,r=n.allocateTextureUnit();a[0]!==r&&(e.uniform1i(this.addr,r),a[0]=r),n.setTexture2DArray(t||Rw,r)}function dS(e,t){e.uniform1fv(this.addr,t)}function uS(e,t){const n=Bw(t,this.size,2);e.uniform2fv(this.addr,n)}function hS(e,t){const n=Bw(t,this.size,3);e.uniform3fv(this.addr,n)}function pS(e,t){const n=Bw(t,this.size,4);e.uniform4fv(this.addr,n)}function mS(e,t){const n=Bw(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,n)}function fS(e,t){const n=Bw(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,n)}function gS(e,t){const n=Bw(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,n)}function vS(e,t){e.uniform1iv(this.addr,t)}function yS(e,t){e.uniform2iv(this.addr,t)}function xS(e,t){e.uniform3iv(this.addr,t)}function bS(e,t){e.uniform4iv(this.addr,t)}function _S(e,t){e.uniform1uiv(this.addr,t)}function wS(e,t){e.uniform2uiv(this.addr,t)}function SS(e,t){e.uniform3uiv(this.addr,t)}function MS(e,t){e.uniform4uiv(this.addr,t)}function CS(e,t,n){const a=this.cache,r=t.length,i=Vw(n,r);Hw(a,i)||(e.uniform1iv(this.addr,i),$w(a,i));for(let s=0;s!==r;++s)n.setTexture2D(t[s]||jw,i[s])}function ES(e,t,n){const a=this.cache,r=t.length,i=Vw(n,r);Hw(a,i)||(e.uniform1iv(this.addr,i),$w(a,i));for(let s=0;s!==r;++s)n.setTexture3D(t[s]||Iw,i[s])}function kS(e,t,n){const a=this.cache,r=t.length,i=Vw(n,r);Hw(a,i)||(e.uniform1iv(this.addr,i),$w(a,i));for(let s=0;s!==r;++s)n.setTextureCube(t[s]||Lw,i[s])}function TS(e,t,n){const a=this.cache,r=t.length,i=Vw(n,r);Hw(a,i)||(e.uniform1iv(this.addr,i),$w(a,i));for(let s=0;s!==r;++s)n.setTexture2DArray(t[s]||Rw,i[s])}class NS{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return Ww;case 35664:return Gw;case 35665:return Xw;case 35666:return qw;case 35674:return Kw;case 35675:return Yw;case 35676:return Jw;case 5124:case 35670:return Zw;case 35667:case 35671:return Qw;case 35668:case 35672:return eS;case 35669:case 35673:return tS;case 5125:return nS;case 36294:return aS;case 36295:return rS;case 36296:return iS;case 35678:case 36198:case 36298:case 36306:case 35682:return sS;case 35679:case 36299:case 36307:return oS;case 35680:case 36300:case 36308:case 36293:return lS;case 36289:case 36303:case 36311:case 36292:return cS}}(t.type)}}class PS{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return dS;case 35664:return uS;case 35665:return hS;case 35666:return pS;case 35674:return mS;case 35675:return fS;case 35676:return gS;case 5124:case 35670:return vS;case 35667:case 35671:return yS;case 35668:case 35672:return xS;case 35669:case 35673:return bS;case 5125:return _S;case 36294:return wS;case 36295:return SS;case 36296:return MS;case 35678:case 36198:case 36298:case 36306:case 35682:return CS;case 35679:case 36299:case 36307:return ES;case 35680:case 36300:case 36308:case 36293:return kS;case 36289:case 36303:case 36311:case 36292:return TS}}(t.type)}}class jS{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,n){const a=this.seq;for(let r=0,i=a.length;r!==i;++r){const i=a[r];i.setValue(e,t[i.id],n)}}}const AS=/(\w+)(\])?(\[|\.)?/g;function RS(e,t){e.seq.push(t),e.map[t.id]=t}function IS(e,t,n){const a=e.name,r=a.length;for(AS.lastIndex=0;;){const i=AS.exec(a),s=AS.lastIndex;let o=i[1];const l="]"===i[2],c=i[3];if(l&&(o|=0),void 0===c||"["===c&&s+2===r){RS(n,void 0===c?new NS(o,e,t):new PS(o,e,t));break}{let e=n.map[o];void 0===e&&(e=new jS(o),RS(n,e)),n=e}}}class LS{constructor(e,t){this.seq=[],this.map={};const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let a=0;a<n;++a){const n=e.getActiveUniform(t,a);IS(n,e.getUniformLocation(t,n.name),this)}}setValue(e,t,n,a){const r=this.map[t];void 0!==r&&r.setValue(e,n,a)}setOptional(e,t,n){const a=t[n];void 0!==a&&this.setValue(e,n,a)}static upload(e,t,n,a){for(let r=0,i=t.length;r!==i;++r){const i=t[r],s=n[i.id];!1!==s.needsUpdate&&i.setValue(e,s.value,a)}}static seqWithValue(e,t){const n=[];for(let a=0,r=e.length;a!==r;++a){const r=e[a];r.id in t&&n.push(r)}return n}}function DS(e,t,n){const a=e.createShader(t);return e.shaderSource(a,n),e.compileShader(a),a}let US=0;function OS(e,t,n){const a=e.getShaderParameter(t,e.COMPILE_STATUS),r=e.getShaderInfoLog(t).trim();if(a&&""===r)return"";const i=/ERROR: 0:(\d+)/.exec(r);if(i){const a=parseInt(i[1]);return n.toUpperCase()+"\n\n"+r+"\n\n"+function(e,t){const n=e.split("\n"),a=[],r=Math.max(t-6,0),i=Math.min(t+6,n.length);for(let s=r;s<i;s++){const e=s+1;a.push(`${e===t?">":" "} ${e}: ${n[s]}`)}return a.join("\n")}(e.getShaderSource(t),a)}return r}function FS(e,t){const n=function(e){const t=nx.getPrimaries(nx.workingColorSpace),n=nx.getPrimaries(e);let a;switch(t===n?a="":t===xy&&n===yy?a="LinearDisplayP3ToLinearSRGB":t===yy&&n===xy&&(a="LinearSRGBToLinearDisplayP3"),e){case py:case fy:return[a,"LinearTransferOETF"];case hy:case my:return[a,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space:",e),[a,"LinearTransferOETF"]}}(t);return`vec4 ${e}( vec4 value ) { return ${n[0]}( ${n[1]}( value ) ); }`}function zS(e,t){let n;switch(t){case 1:n="Linear";break;case 2:n="Reinhard";break;case 3:n="OptimizedCineon";break;case 4:n="ACESFilmic";break;case 6:n="AgX";break;case 7:n="Neutral";break;case 5:n="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),n="Linear"}return"vec3 "+e+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}function BS(e){return""!==e}function HS(e,t){const n=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,n).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function $S(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const VS=/^[ \t]*#include +<([\w\d./]+)>/gm;function WS(e){return e.replace(VS,XS)}const GS=new Map([["encodings_fragment","colorspace_fragment"],["encodings_pars_fragment","colorspace_pars_fragment"],["output_fragment","opaque_fragment"]]);function XS(e,t){let n=G_[t];if(void 0===n){const e=GS.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");n=G_[e],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,e)}return WS(n)}const qS=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function KS(e){return e.replace(qS,YS)}function YS(e,t,n,a){let r="";for(let i=parseInt(t);i<parseInt(n);i++)r+=a.replace(/\[\s*i\s*\]/g,"[ "+i+" ]").replace(/UNROLLED_LOOP_INDEX/g,i);return r}function JS(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\t`;return e.isWebGL2&&(t+=`precision ${e.precision} sampler3D;\n\t\tprecision ${e.precision} sampler2DArray;\n\t\tprecision ${e.precision} sampler2DShadow;\n\t\tprecision ${e.precision} samplerCubeShadow;\n\t\tprecision ${e.precision} sampler2DArrayShadow;\n\t\tprecision ${e.precision} isampler2D;\n\t\tprecision ${e.precision} isampler3D;\n\t\tprecision ${e.precision} isamplerCube;\n\t\tprecision ${e.precision} isampler2DArray;\n\t\tprecision ${e.precision} usampler2D;\n\t\tprecision ${e.precision} usampler3D;\n\t\tprecision ${e.precision} usamplerCube;\n\t\tprecision ${e.precision} usampler2DArray;\n\t\t`),"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function ZS(e,t,n,a){const r=e.getContext(),i=n.defines;let s=n.vertexShader,o=n.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(n),c=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case Ov:case Fv:t="ENVMAP_TYPE_CUBE";break;case zv:t="ENVMAP_TYPE_CUBE_UV"}return t}(n),d=function(e){let t="ENVMAP_MODE_REFLECTION";e.envMap&&e.envMapMode===Fv&&(t="ENVMAP_MODE_REFRACTION");return t}(n),u=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(n),h=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const n=Math.log2(t)-2,a=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,n),112)),texelHeight:a,maxMip:n}}(n),p=n.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUVHeight||e.bumpMap||e.normalMapTangentSpace||e.clearcoatNormalMap||e.flatShading||e.alphaToCoverage||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap||e.transmission)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(BS).join("\n")}(n),m=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(BS).join("\n")}(n),f=function(e){const t=[];for(const n in e){const a=e[n];!1!==a&&t.push("#define "+n+" "+a)}return t.join("\n")}(i),g=r.createProgram();let v,y,x=n.glslVersion?"#version "+n.glslVersion+"\n":"";n.isRawShaderMaterial?(v=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f].filter(BS).join("\n"),v.length>0&&(v+="\n"),y=[p,"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f].filter(BS).join("\n"),y.length>0&&(y+="\n")):(v=[JS(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f,n.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",n.batching?"#define USE_BATCHING":"",n.instancing?"#define USE_INSTANCING":"",n.instancingColor?"#define USE_INSTANCING_COLOR":"",n.instancingMorph?"#define USE_INSTANCING_MORPH":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+d:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.displacementMap?"#define USE_DISPLACEMENTMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.mapUv?"#define MAP_UV "+n.mapUv:"",n.alphaMapUv?"#define ALPHAMAP_UV "+n.alphaMapUv:"",n.lightMapUv?"#define LIGHTMAP_UV "+n.lightMapUv:"",n.aoMapUv?"#define AOMAP_UV "+n.aoMapUv:"",n.emissiveMapUv?"#define EMISSIVEMAP_UV "+n.emissiveMapUv:"",n.bumpMapUv?"#define BUMPMAP_UV "+n.bumpMapUv:"",n.normalMapUv?"#define NORMALMAP_UV "+n.normalMapUv:"",n.displacementMapUv?"#define DISPLACEMENTMAP_UV "+n.displacementMapUv:"",n.metalnessMapUv?"#define METALNESSMAP_UV "+n.metalnessMapUv:"",n.roughnessMapUv?"#define ROUGHNESSMAP_UV "+n.roughnessMapUv:"",n.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+n.anisotropyMapUv:"",n.clearcoatMapUv?"#define CLEARCOATMAP_UV "+n.clearcoatMapUv:"",n.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+n.clearcoatNormalMapUv:"",n.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+n.clearcoatRoughnessMapUv:"",n.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+n.iridescenceMapUv:"",n.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+n.iridescenceThicknessMapUv:"",n.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+n.sheenColorMapUv:"",n.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+n.sheenRoughnessMapUv:"",n.specularMapUv?"#define SPECULARMAP_UV "+n.specularMapUv:"",n.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+n.specularColorMapUv:"",n.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+n.specularIntensityMapUv:"",n.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+n.transmissionMapUv:"",n.thicknessMapUv?"#define THICKNESSMAP_UV "+n.thicknessMapUv:"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.morphColors&&n.isWebGL2?"#define USE_MORPHCOLORS":"",n.morphTargetsCount>0&&n.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",n.morphTargetsCount>0&&n.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+n.morphTextureStride:"",n.morphTargetsCount>0&&n.isWebGL2?"#define MORPHTARGETS_COUNT "+n.morphTargetsCount:"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.useLegacyLights?"#define LEGACY_LIGHTS":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(BS).join("\n"),y=[p,JS(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+c:"",n.envMap?"#define "+d:"",n.envMap?"#define "+u:"",h?"#define CUBEUV_TEXEL_WIDTH "+h.texelWidth:"",h?"#define CUBEUV_TEXEL_HEIGHT "+h.texelHeight:"",h?"#define CUBEUV_MAX_MIP "+h.maxMip+".0":"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoat?"#define USE_CLEARCOAT":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.iridescence?"#define USE_IRIDESCENCE":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaTest?"#define USE_ALPHATEST":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.sheen?"#define USE_SHEEN":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors||n.instancingColor?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.useLegacyLights?"#define LEGACY_LIGHTS":"",n.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==n.toneMapping?"#define TONE_MAPPING":"",0!==n.toneMapping?G_.tonemapping_pars_fragment:"",0!==n.toneMapping?zS("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.opaque?"#define OPAQUE":"",G_.colorspace_pars_fragment,FS("linearToOutputTexel",n.outputColorSpace),n.useDepthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(BS).join("\n")),s=WS(s),s=HS(s,n),s=$S(s,n),o=WS(o),o=HS(o,n),o=$S(o,n),s=KS(s),o=KS(o),n.isWebGL2&&!0!==n.isRawShaderMaterial&&(x="#version 300 es\n",v=[m,"precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+v,y=["precision mediump sampler2DArray;","#define varying in",n.glslVersion===Ny?"":"layout(location = 0) out highp vec4 pc_fragColor;",n.glslVersion===Ny?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+y);const b=x+v+s,_=x+y+o,w=DS(r,r.VERTEX_SHADER,b),S=DS(r,r.FRAGMENT_SHADER,_);function M(t){if(e.debug.checkShaderErrors){const n=r.getProgramInfoLog(g).trim(),a=r.getShaderInfoLog(w).trim(),i=r.getShaderInfoLog(S).trim();let s=!0,o=!0;if(!1===r.getProgramParameter(g,r.LINK_STATUS))if(s=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(r,g,w,S);else{const e=OS(r,w,"vertex"),a=OS(r,S,"fragment");console.error("THREE.WebGLProgram: Shader Error "+r.getError()+" - VALIDATE_STATUS "+r.getProgramParameter(g,r.VALIDATE_STATUS)+"\n\nMaterial Name: "+t.name+"\nMaterial Type: "+t.type+"\n\nProgram Info Log: "+n+"\n"+e+"\n"+a)}else""!==n?console.warn("THREE.WebGLProgram: Program Info Log:",n):""!==a&&""!==i||(o=!1);o&&(t.diagnostics={runnable:s,programLog:n,vertexShader:{log:a,prefix:v},fragmentShader:{log:i,prefix:y}})}r.deleteShader(w),r.deleteShader(S),C=new LS(r,g),E=function(e,t){const n={},a=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let r=0;r<a;r++){const a=e.getActiveAttrib(t,r),i=a.name;let s=1;a.type===e.FLOAT_MAT2&&(s=2),a.type===e.FLOAT_MAT3&&(s=3),a.type===e.FLOAT_MAT4&&(s=4),n[i]={type:a.type,location:e.getAttribLocation(t,i),locationSize:s}}return n}(r,g)}let C,E;r.attachShader(g,w),r.attachShader(g,S),void 0!==n.index0AttributeName?r.bindAttribLocation(g,0,n.index0AttributeName):!0===n.morphTargets&&r.bindAttribLocation(g,0,"position"),r.linkProgram(g),this.getUniforms=function(){return void 0===C&&M(this),C},this.getAttributes=function(){return void 0===E&&M(this),E};let k=!1===n.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===k&&(k=r.getProgramParameter(g,37297)),k},this.destroy=function(){a.releaseStatesOfProgram(this),r.deleteProgram(g),this.program=void 0},this.type=n.shaderType,this.name=n.shaderName,this.id=US++,this.cacheKey=t,this.usedTimes=1,this.program=g,this.vertexShader=w,this.fragmentShader=S,this}let QS=0;class eM{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,n=e.fragmentShader,a=this._getShaderStage(t),r=this._getShaderStage(n),i=this._getShaderCacheForMaterial(e);return!1===i.has(a)&&(i.add(a),a.usedTimes++),!1===i.has(r)&&(i.add(r),r.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const n of t)n.usedTimes--,0===n.usedTimes&&this.shaderCache.delete(n.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let n=t.get(e);return void 0===n&&(n=new Set,t.set(e,n)),n}_getShaderStage(e){const t=this.shaderCache;let n=t.get(e);return void 0===n&&(n=new tM(e),t.set(e,n)),n}}class tM{constructor(e){this.id=QS++,this.code=e,this.usedTimes=0}}function nM(e,t,n,a,r,i,s){const o=new ib,l=new eM,c=new Set,d=[],u=r.isWebGL2,h=r.logarithmicDepthBuffer,p=r.vertexTextures;let m=r.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function g(e){return c.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(i,o,d,v,y){const x=v.fog,b=y.geometry,_=i.isMeshStandardMaterial?v.environment:null,w=(i.isMeshStandardMaterial?n:t).get(i.envMap||_),S=w&&w.mapping===zv?w.image.height:null,M=f[i.type];null!==i.precision&&(m=r.getMaxPrecision(i.precision),m!==i.precision&&console.warn("THREE.WebGLProgram.getParameters:",i.precision,"not supported, using",m,"instead."));const C=b.morphAttributes.position||b.morphAttributes.normal||b.morphAttributes.color,E=void 0!==C?C.length:0;let k,T,N,P,j=0;if(void 0!==b.morphAttributes.position&&(j=1),void 0!==b.morphAttributes.normal&&(j=2),void 0!==b.morphAttributes.color&&(j=3),M){const e=q_[M];k=e.vertexShader,T=e.fragmentShader}else k=i.vertexShader,T=i.fragmentShader,l.update(i),N=l.getVertexShaderID(i),P=l.getFragmentShaderID(i);const A=e.getRenderTarget(),R=!0===y.isInstancedMesh,I=!0===y.isBatchedMesh,L=!!i.map,D=!!i.matcap,U=!!w,O=!!i.aoMap,F=!!i.lightMap,z=!!i.bumpMap,B=!!i.normalMap,H=!!i.displacementMap,$=!!i.emissiveMap,V=!!i.metalnessMap,W=!!i.roughnessMap,G=i.anisotropy>0,X=i.clearcoat>0,q=i.iridescence>0,K=i.sheen>0,Y=i.transmission>0,J=G&&!!i.anisotropyMap,Z=X&&!!i.clearcoatMap,Q=X&&!!i.clearcoatNormalMap,ee=X&&!!i.clearcoatRoughnessMap,te=q&&!!i.iridescenceMap,ne=q&&!!i.iridescenceThicknessMap,ae=K&&!!i.sheenColorMap,re=K&&!!i.sheenRoughnessMap,ie=!!i.specularMap,se=!!i.specularColorMap,oe=!!i.specularIntensityMap,le=Y&&!!i.transmissionMap,ce=Y&&!!i.thicknessMap,de=!!i.gradientMap,ue=!!i.alphaMap,he=i.alphaTest>0,pe=!!i.alphaHash,me=!!i.extensions;let fe=0;i.toneMapped&&(null!==A&&!0!==A.isXRRenderTarget||(fe=e.toneMapping));const ge={isWebGL2:u,shaderID:M,shaderType:i.type,shaderName:i.name,vertexShader:k,fragmentShader:T,defines:i.defines,customVertexShaderID:N,customFragmentShaderID:P,isRawShaderMaterial:!0===i.isRawShaderMaterial,glslVersion:i.glslVersion,precision:m,batching:I,instancing:R,instancingColor:R&&null!==y.instanceColor,instancingMorph:R&&null!==y.morphTexture,supportsVertexTextures:p,outputColorSpace:null===A?e.outputColorSpace:!0===A.isXRRenderTarget?A.texture.colorSpace:py,alphaToCoverage:!!i.alphaToCoverage,map:L,matcap:D,envMap:U,envMapMode:U&&w.mapping,envMapCubeUVHeight:S,aoMap:O,lightMap:F,bumpMap:z,normalMap:B,displacementMap:p&&H,emissiveMap:$,normalMapObjectSpace:B&&1===i.normalMapType,normalMapTangentSpace:B&&0===i.normalMapType,metalnessMap:V,roughnessMap:W,anisotropy:G,anisotropyMap:J,clearcoat:X,clearcoatMap:Z,clearcoatNormalMap:Q,clearcoatRoughnessMap:ee,iridescence:q,iridescenceMap:te,iridescenceThicknessMap:ne,sheen:K,sheenColorMap:ae,sheenRoughnessMap:re,specularMap:ie,specularColorMap:se,specularIntensityMap:oe,transmission:Y,transmissionMap:le,thicknessMap:ce,gradientMap:de,opaque:!1===i.transparent&&1===i.blending&&!1===i.alphaToCoverage,alphaMap:ue,alphaTest:he,alphaHash:pe,combine:i.combine,mapUv:L&&g(i.map.channel),aoMapUv:O&&g(i.aoMap.channel),lightMapUv:F&&g(i.lightMap.channel),bumpMapUv:z&&g(i.bumpMap.channel),normalMapUv:B&&g(i.normalMap.channel),displacementMapUv:H&&g(i.displacementMap.channel),emissiveMapUv:$&&g(i.emissiveMap.channel),metalnessMapUv:V&&g(i.metalnessMap.channel),roughnessMapUv:W&&g(i.roughnessMap.channel),anisotropyMapUv:J&&g(i.anisotropyMap.channel),clearcoatMapUv:Z&&g(i.clearcoatMap.channel),clearcoatNormalMapUv:Q&&g(i.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:ee&&g(i.clearcoatRoughnessMap.channel),iridescenceMapUv:te&&g(i.iridescenceMap.channel),iridescenceThicknessMapUv:ne&&g(i.iridescenceThicknessMap.channel),sheenColorMapUv:ae&&g(i.sheenColorMap.channel),sheenRoughnessMapUv:re&&g(i.sheenRoughnessMap.channel),specularMapUv:ie&&g(i.specularMap.channel),specularColorMapUv:se&&g(i.specularColorMap.channel),specularIntensityMapUv:oe&&g(i.specularIntensityMap.channel),transmissionMapUv:le&&g(i.transmissionMap.channel),thicknessMapUv:ce&&g(i.thicknessMap.channel),alphaMapUv:ue&&g(i.alphaMap.channel),vertexTangents:!!b.attributes.tangent&&(B||G),vertexColors:i.vertexColors,vertexAlphas:!0===i.vertexColors&&!!b.attributes.color&&4===b.attributes.color.itemSize,pointsUvs:!0===y.isPoints&&!!b.attributes.uv&&(L||ue),fog:!!x,useFog:!0===i.fog,fogExp2:!!x&&x.isFogExp2,flatShading:!0===i.flatShading,sizeAttenuation:!0===i.sizeAttenuation,logarithmicDepthBuffer:h,skinning:!0===y.isSkinnedMesh,morphTargets:void 0!==b.morphAttributes.position,morphNormals:void 0!==b.morphAttributes.normal,morphColors:void 0!==b.morphAttributes.color,morphTargetsCount:E,morphTextureStride:j,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numSpotLightMaps:o.spotLightMap.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numSpotLightShadowsWithMaps:o.numSpotLightShadowsWithMaps,numLightProbes:o.numLightProbes,numClippingPlanes:s.numPlanes,numClipIntersection:s.numIntersection,dithering:i.dithering,shadowMapEnabled:e.shadowMap.enabled&&d.length>0,shadowMapType:e.shadowMap.type,toneMapping:fe,useLegacyLights:e._useLegacyLights,decodeVideoTexture:L&&!0===i.map.isVideoTexture&&nx.getTransfer(i.map.colorSpace)===vy,premultipliedAlpha:i.premultipliedAlpha,doubleSided:2===i.side,flipSided:1===i.side,useDepthPacking:i.depthPacking>=0,depthPacking:i.depthPacking||0,index0AttributeName:i.index0AttributeName,extensionDerivatives:me&&!0===i.extensions.derivatives,extensionFragDepth:me&&!0===i.extensions.fragDepth,extensionDrawBuffers:me&&!0===i.extensions.drawBuffers,extensionShaderTextureLOD:me&&!0===i.extensions.shaderTextureLOD,extensionClipCullDistance:me&&!0===i.extensions.clipCullDistance&&a.has("WEBGL_clip_cull_distance"),extensionMultiDraw:me&&!0===i.extensions.multiDraw&&a.has("WEBGL_multi_draw"),rendererExtensionFragDepth:u||a.has("EXT_frag_depth"),rendererExtensionDrawBuffers:u||a.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:u||a.has("EXT_shader_texture_lod"),rendererExtensionParallelShaderCompile:a.has("KHR_parallel_shader_compile"),customProgramCacheKey:i.customProgramCacheKey()};return ge.vertexUv1s=c.has(1),ge.vertexUv2s=c.has(2),ge.vertexUv3s=c.has(3),c.clear(),ge},getProgramCacheKey:function(t){const n=[];if(t.shaderID?n.push(t.shaderID):(n.push(t.customVertexShaderID),n.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)n.push(e),n.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(!function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(n,t),function(e,t){o.disableAll(),t.isWebGL2&&o.enable(0);t.supportsVertexTextures&&o.enable(1);t.instancing&&o.enable(2);t.instancingColor&&o.enable(3);t.instancingMorph&&o.enable(4);t.matcap&&o.enable(5);t.envMap&&o.enable(6);t.normalMapObjectSpace&&o.enable(7);t.normalMapTangentSpace&&o.enable(8);t.clearcoat&&o.enable(9);t.iridescence&&o.enable(10);t.alphaTest&&o.enable(11);t.vertexColors&&o.enable(12);t.vertexAlphas&&o.enable(13);t.vertexUv1s&&o.enable(14);t.vertexUv2s&&o.enable(15);t.vertexUv3s&&o.enable(16);t.vertexTangents&&o.enable(17);t.anisotropy&&o.enable(18);t.alphaHash&&o.enable(19);t.batching&&o.enable(20);e.push(o.mask),o.disableAll(),t.fog&&o.enable(0);t.useFog&&o.enable(1);t.flatShading&&o.enable(2);t.logarithmicDepthBuffer&&o.enable(3);t.skinning&&o.enable(4);t.morphTargets&&o.enable(5);t.morphNormals&&o.enable(6);t.morphColors&&o.enable(7);t.premultipliedAlpha&&o.enable(8);t.shadowMapEnabled&&o.enable(9);t.useLegacyLights&&o.enable(10);t.doubleSided&&o.enable(11);t.flipSided&&o.enable(12);t.useDepthPacking&&o.enable(13);t.dithering&&o.enable(14);t.transmission&&o.enable(15);t.sheen&&o.enable(16);t.opaque&&o.enable(17);t.pointsUvs&&o.enable(18);t.decodeVideoTexture&&o.enable(19);t.alphaToCoverage&&o.enable(20);e.push(o.mask)}(n,t),n.push(e.outputColorSpace)),n.push(t.customProgramCacheKey),n.join()},getUniforms:function(e){const t=f[e.type];let n;if(t){const e=q_[t];n=C_.clone(e.uniforms)}else n=e.uniforms;return n},acquireProgram:function(t,n){let a;for(let e=0,r=d.length;e<r;e++){const t=d[e];if(t.cacheKey===n){a=t,++a.usedTimes;break}}return void 0===a&&(a=new ZS(e,n,t,i),d.push(a)),a},releaseProgram:function(e){if(0===--e.usedTimes){const t=d.indexOf(e);d[t]=d[d.length-1],d.pop(),e.destroy()}},releaseShaderCache:function(e){l.remove(e)},programs:d,dispose:function(){l.dispose()}}}function aM(){let e=new WeakMap;return{get:function(t){let n=e.get(t);return void 0===n&&(n={},e.set(t,n)),n},remove:function(t){e.delete(t)},update:function(t,n,a){e.get(t)[n]=a},dispose:function(){e=new WeakMap}}}function rM(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function iM(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function sM(){const e=[];let t=0;const n=[],a=[],r=[];function i(n,a,r,i,s,o){let l=e[t];return void 0===l?(l={id:n.id,object:n,geometry:a,material:r,groupOrder:i,renderOrder:n.renderOrder,z:s,group:o},e[t]=l):(l.id=n.id,l.object=n,l.geometry=a,l.material=r,l.groupOrder=i,l.renderOrder=n.renderOrder,l.z=s,l.group=o),t++,l}return{opaque:n,transmissive:a,transparent:r,init:function(){t=0,n.length=0,a.length=0,r.length=0},push:function(e,t,s,o,l,c){const d=i(e,t,s,o,l,c);s.transmission>0?a.push(d):!0===s.transparent?r.push(d):n.push(d)},unshift:function(e,t,s,o,l,c){const d=i(e,t,s,o,l,c);s.transmission>0?a.unshift(d):!0===s.transparent?r.unshift(d):n.unshift(d)},finish:function(){for(let n=t,a=e.length;n<a;n++){const t=e[n];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){n.length>1&&n.sort(e||rM),a.length>1&&a.sort(t||iM),r.length>1&&r.sort(t||iM)}}}function oM(){let e=new WeakMap;return{get:function(t,n){const a=e.get(t);let r;return void 0===a?(r=new sM,e.set(t,[r])):n>=a.length?(r=new sM,a.push(r)):r=a[n],r},dispose:function(){e=new WeakMap}}}function lM(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":n={direction:new yx,color:new Ub};break;case"SpotLight":n={position:new yx,direction:new yx,color:new Ub,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new yx,color:new Ub,distance:0,decay:0};break;case"HemisphereLight":n={direction:new yx,skyColor:new Ub,groundColor:new Ub};break;case"RectAreaLight":n={color:new Ub,position:new yx,halfWidth:new yx,halfHeight:new yx}}return e[t.id]=n,n}}}let cM=0;function dM(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function uM(e,t){const n=new lM,a=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":case"SpotLight":n={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Wy};break;case"PointLight":n={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new Wy,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=n,n}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let l=0;l<9;l++)r.probe.push(new yx);const i=new yx,s=new qx,o=new qx;return{setup:function(i,s){let o=0,l=0,c=0;for(let e=0;e<9;e++)r.probe[e].set(0,0,0);let d=0,u=0,h=0,p=0,m=0,f=0,g=0,v=0,y=0,x=0,b=0;i.sort(dM);const _=!0===s?Math.PI:1;for(let e=0,t=i.length;e<t;e++){const t=i[e],s=t.color,w=t.intensity,S=t.distance,M=t.shadow&&t.shadow.map?t.shadow.map.texture:null;if(t.isAmbientLight)o+=s.r*w*_,l+=s.g*w*_,c+=s.b*w*_;else if(t.isLightProbe){for(let e=0;e<9;e++)r.probe[e].addScaledVector(t.sh.coefficients[e],w);b++}else if(t.isDirectionalLight){const e=n.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity*_),t.castShadow){const e=t.shadow,n=a.get(t);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,r.directionalShadow[d]=n,r.directionalShadowMap[d]=M,r.directionalShadowMatrix[d]=t.shadow.matrix,f++}r.directional[d]=e,d++}else if(t.isSpotLight){const e=n.get(t);e.position.setFromMatrixPosition(t.matrixWorld),e.color.copy(s).multiplyScalar(w*_),e.distance=S,e.coneCos=Math.cos(t.angle),e.penumbraCos=Math.cos(t.angle*(1-t.penumbra)),e.decay=t.decay,r.spot[h]=e;const i=t.shadow;if(t.map&&(r.spotLightMap[y]=t.map,y++,i.updateMatrices(t),t.castShadow&&x++),r.spotLightMatrix[h]=i.matrix,t.castShadow){const e=a.get(t);e.shadowBias=i.bias,e.shadowNormalBias=i.normalBias,e.shadowRadius=i.radius,e.shadowMapSize=i.mapSize,r.spotShadow[h]=e,r.spotShadowMap[h]=M,v++}h++}else if(t.isRectAreaLight){const e=n.get(t);e.color.copy(s).multiplyScalar(w),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),r.rectArea[p]=e,p++}else if(t.isPointLight){const e=n.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity*_),e.distance=t.distance,e.decay=t.decay,t.castShadow){const e=t.shadow,n=a.get(t);n.shadowBias=e.bias,n.shadowNormalBias=e.normalBias,n.shadowRadius=e.radius,n.shadowMapSize=e.mapSize,n.shadowCameraNear=e.camera.near,n.shadowCameraFar=e.camera.far,r.pointShadow[u]=n,r.pointShadowMap[u]=M,r.pointShadowMatrix[u]=t.shadow.matrix,g++}r.point[u]=e,u++}else if(t.isHemisphereLight){const e=n.get(t);e.skyColor.copy(t.color).multiplyScalar(w*_),e.groundColor.copy(t.groundColor).multiplyScalar(w*_),r.hemi[m]=e,m++}}p>0&&(t.isWebGL2?!0===e.has("OES_texture_float_linear")?(r.rectAreaLTC1=X_.LTC_FLOAT_1,r.rectAreaLTC2=X_.LTC_FLOAT_2):(r.rectAreaLTC1=X_.LTC_HALF_1,r.rectAreaLTC2=X_.LTC_HALF_2):!0===e.has("OES_texture_float_linear")?(r.rectAreaLTC1=X_.LTC_FLOAT_1,r.rectAreaLTC2=X_.LTC_FLOAT_2):!0===e.has("OES_texture_half_float_linear")?(r.rectAreaLTC1=X_.LTC_HALF_1,r.rectAreaLTC2=X_.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),r.ambient[0]=o,r.ambient[1]=l,r.ambient[2]=c;const w=r.hash;w.directionalLength===d&&w.pointLength===u&&w.spotLength===h&&w.rectAreaLength===p&&w.hemiLength===m&&w.numDirectionalShadows===f&&w.numPointShadows===g&&w.numSpotShadows===v&&w.numSpotMaps===y&&w.numLightProbes===b||(r.directional.length=d,r.spot.length=h,r.rectArea.length=p,r.point.length=u,r.hemi.length=m,r.directionalShadow.length=f,r.directionalShadowMap.length=f,r.pointShadow.length=g,r.pointShadowMap.length=g,r.spotShadow.length=v,r.spotShadowMap.length=v,r.directionalShadowMatrix.length=f,r.pointShadowMatrix.length=g,r.spotLightMatrix.length=v+y-x,r.spotLightMap.length=y,r.numSpotLightShadowsWithMaps=x,r.numLightProbes=b,w.directionalLength=d,w.pointLength=u,w.spotLength=h,w.rectAreaLength=p,w.hemiLength=m,w.numDirectionalShadows=f,w.numPointShadows=g,w.numSpotShadows=v,w.numSpotMaps=y,w.numLightProbes=b,r.version=cM++)},setupView:function(e,t){let n=0,a=0,l=0,c=0,d=0;const u=t.matrixWorldInverse;for(let h=0,p=e.length;h<p;h++){const t=e[h];if(t.isDirectionalLight){const e=r.directional[n];e.direction.setFromMatrixPosition(t.matrixWorld),i.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(i),e.direction.transformDirection(u),n++}else if(t.isSpotLight){const e=r.spot[l];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),e.direction.setFromMatrixPosition(t.matrixWorld),i.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(i),e.direction.transformDirection(u),l++}else if(t.isRectAreaLight){const e=r.rectArea[c];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),o.identity(),s.copy(t.matrixWorld),s.premultiply(u),o.extractRotation(s),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),e.halfWidth.applyMatrix4(o),e.halfHeight.applyMatrix4(o),c++}else if(t.isPointLight){const e=r.point[a];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(u),a++}else if(t.isHemisphereLight){const e=r.hemi[d];e.direction.setFromMatrixPosition(t.matrixWorld),e.direction.transformDirection(u),d++}}},state:r}}function hM(e,t){const n=new uM(e,t),a=[],r=[];return{init:function(){a.length=0,r.length=0},state:{lightsArray:a,shadowsArray:r,lights:n},setupLights:function(e){n.setup(a,e)},setupLightsView:function(e){n.setupView(a,e)},pushLight:function(e){a.push(e)},pushShadow:function(e){r.push(e)}}}function pM(e,t){let n=new WeakMap;return{get:function(a,r=0){const i=n.get(a);let s;return void 0===i?(s=new hM(e,t),n.set(a,[s])):r>=i.length?(s=new hM(e,t),i.push(s)):s=i[r],s},dispose:function(){n=new WeakMap}}}class mM extends zb{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class fM extends zb{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function gM(e,t,n){let a=new H_;const r=new Wy,i=new Wy,s=new hx,o=new mM({depthPacking:3201}),l=new fM,c={},d=n.maxTextureSize,u={[vv]:1,[yv]:0,[xv]:2},h=new E_({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new Wy},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),p=h.clone();p.defines.HORIZONTAL_PASS=1;const m=new t_;m.setAttribute("position",new Vb(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new x_(m,h),g=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let v=this.type;function y(n,a){const i=t.update(f);h.defines.VSM_SAMPLES!==n.blurSamples&&(h.defines.VSM_SAMPLES=n.blurSamples,p.defines.VSM_SAMPLES=n.blurSamples,h.needsUpdate=!0,p.needsUpdate=!0),null===n.mapPass&&(n.mapPass=new mx(r.x,r.y)),h.uniforms.shadow_pass.value=n.map.texture,h.uniforms.resolution.value=n.mapSize,h.uniforms.radius.value=n.radius,e.setRenderTarget(n.mapPass),e.clear(),e.renderBufferDirect(a,null,i,h,f,null),p.uniforms.shadow_pass.value=n.mapPass.texture,p.uniforms.resolution.value=n.mapSize,p.uniforms.radius.value=n.radius,e.setRenderTarget(n.map),e.clear(),e.renderBufferDirect(a,null,i,p,f,null)}function x(t,n,a,r){let i=null;const s=!0===a.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==s)i=s;else if(i=!0===a.isPointLight?l:o,e.localClippingEnabled&&!0===n.clipShadows&&Array.isArray(n.clippingPlanes)&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0||n.map&&n.alphaTest>0){const e=i.uuid,t=n.uuid;let a=c[e];void 0===a&&(a={},c[e]=a);let r=a[t];void 0===r&&(r=i.clone(),a[t]=r,n.addEventListener("dispose",_)),i=r}if(i.visible=n.visible,i.wireframe=n.wireframe,i.side=3===r?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:u[n.side],i.alphaMap=n.alphaMap,i.alphaTest=n.alphaTest,i.map=n.map,i.clipShadows=n.clipShadows,i.clippingPlanes=n.clippingPlanes,i.clipIntersection=n.clipIntersection,i.displacementMap=n.displacementMap,i.displacementScale=n.displacementScale,i.displacementBias=n.displacementBias,i.wireframeLinewidth=n.wireframeLinewidth,i.linewidth=n.linewidth,!0===a.isPointLight&&!0===i.isMeshDistanceMaterial){e.properties.get(i).light=a}return i}function b(n,r,i,s,o){if(!1===n.visible)return;if(n.layers.test(r.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.castShadow||n.receiveShadow&&3===o)&&(!n.frustumCulled||a.intersectsObject(n))){n.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,n.matrixWorld);const a=t.update(n),l=n.material;if(Array.isArray(l)){const t=a.groups;for(let c=0,d=t.length;c<d;c++){const d=t[c],u=l[d.materialIndex];if(u&&u.visible){const t=x(n,u,s,o);n.onBeforeShadow(e,n,r,i,a,t,d),e.renderBufferDirect(i,null,a,t,n,d),n.onAfterShadow(e,n,r,i,a,t,d)}}}else if(l.visible){const t=x(n,l,s,o);n.onBeforeShadow(e,n,r,i,a,t,null),e.renderBufferDirect(i,null,a,t,n,null),n.onAfterShadow(e,n,r,i,a,t,null)}}const l=n.children;for(let e=0,t=l.length;e<t;e++)b(l[e],r,i,s,o)}function _(e){e.target.removeEventListener("dispose",_);for(const t in c){const n=c[t],a=e.target.uuid;if(a in n){n[a].dispose(),delete n[a]}}}this.render=function(t,n,o){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===t.length)return;const l=e.getRenderTarget(),c=e.getActiveCubeFace(),u=e.getActiveMipmapLevel(),h=e.state;h.setBlending(0),h.buffers.color.setClear(1,1,1,1),h.buffers.depth.setTest(!0),h.setScissorTest(!1);const p=3!==v&&3===this.type,m=3===v&&3!==this.type;for(let f=0,g=t.length;f<g;f++){const l=t[f],c=l.shadow;if(void 0===c){console.warn("THREE.WebGLShadowMap:",l,"has no shadow.");continue}if(!1===c.autoUpdate&&!1===c.needsUpdate)continue;r.copy(c.mapSize);const u=c.getFrameExtents();if(r.multiply(u),i.copy(c.mapSize),(r.x>d||r.y>d)&&(r.x>d&&(i.x=Math.floor(d/u.x),r.x=i.x*u.x,c.mapSize.x=i.x),r.y>d&&(i.y=Math.floor(d/u.y),r.y=i.y*u.y,c.mapSize.y=i.y)),null===c.map||!0===p||!0===m){const e=3!==this.type?{minFilter:Vv,magFilter:Vv}:{};null!==c.map&&c.map.dispose(),c.map=new mx(r.x,r.y,e),c.map.texture.name=l.name+".shadowMap",c.camera.updateProjectionMatrix()}e.setRenderTarget(c.map),e.clear();const g=c.getViewportCount();for(let e=0;e<g;e++){const t=c.getViewport(e);s.set(i.x*t.x,i.y*t.y,i.x*t.z,i.y*t.w),h.viewport(s),c.updateMatrices(l,e),a=c.getFrustum(),b(n,o,c.camera,l,this.type)}!0!==c.isPointLightShadow&&3===this.type&&y(c,o),c.needsUpdate=!1}v=this.type,g.needsUpdate=!1,e.setRenderTarget(l,c,u)}}function vM(e,t,n){const a=n.isWebGL2;const r=new function(){let t=!1;const n=new hx;let a=null;const r=new hx(0,0,0,0);return{setMask:function(n){a===n||t||(e.colorMask(n,n,n,n),a=n)},setLocked:function(e){t=e},setClear:function(t,a,i,s,o){!0===o&&(t*=s,a*=s,i*=s),n.set(t,a,i,s),!1===r.equals(n)&&(e.clearColor(t,a,i,s),r.copy(n))},reset:function(){t=!1,a=null,r.set(-1,0,0,0)}}},i=new function(){let t=!1,n=null,a=null,r=null;return{setTest:function(t){t?H(e.DEPTH_TEST):$(e.DEPTH_TEST)},setMask:function(a){n===a||t||(e.depthMask(a),n=a)},setFunc:function(t){if(a!==t){switch(t){case 0:e.depthFunc(e.NEVER);break;case 1:e.depthFunc(e.ALWAYS);break;case 2:e.depthFunc(e.LESS);break;case 3:default:e.depthFunc(e.LEQUAL);break;case 4:e.depthFunc(e.EQUAL);break;case 5:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case 7:e.depthFunc(e.NOTEQUAL)}a=t}},setLocked:function(e){t=e},setClear:function(t){r!==t&&(e.clearDepth(t),r=t)},reset:function(){t=!1,n=null,a=null,r=null}}},s=new function(){let t=!1,n=null,a=null,r=null,i=null,s=null,o=null,l=null,c=null;return{setTest:function(n){t||(n?H(e.STENCIL_TEST):$(e.STENCIL_TEST))},setMask:function(a){n===a||t||(e.stencilMask(a),n=a)},setFunc:function(t,n,s){a===t&&r===n&&i===s||(e.stencilFunc(t,n,s),a=t,r=n,i=s)},setOp:function(t,n,a){s===t&&o===n&&l===a||(e.stencilOp(t,n,a),s=t,o=n,l=a)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,n=null,a=null,r=null,i=null,s=null,o=null,l=null,c=null}}},o=new WeakMap,l=new WeakMap;let c={},d={},u=new WeakMap,h=[],p=null,m=!1,f=null,g=null,v=null,y=null,x=null,b=null,_=null,w=new Ub(0,0,0),S=0,M=!1,C=null,E=null,k=null,T=null,N=null;const P=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let j=!1,A=0;const R=e.getParameter(e.VERSION);-1!==R.indexOf("WebGL")?(A=parseFloat(/^WebGL (\d)/.exec(R)[1]),j=A>=1):-1!==R.indexOf("OpenGL ES")&&(A=parseFloat(/^OpenGL ES (\d)/.exec(R)[1]),j=A>=2);let I=null,L={};const D=e.getParameter(e.SCISSOR_BOX),U=e.getParameter(e.VIEWPORT),O=(new hx).fromArray(D),F=(new hx).fromArray(U);function z(t,n,r,i){const s=new Uint8Array(4),o=e.createTexture();e.bindTexture(t,o),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let l=0;l<r;l++)!a||t!==e.TEXTURE_3D&&t!==e.TEXTURE_2D_ARRAY?e.texImage2D(n+l,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,s):e.texImage3D(n,0,e.RGBA,1,1,i,0,e.RGBA,e.UNSIGNED_BYTE,s);return o}const B={};function H(t){!0!==c[t]&&(e.enable(t),c[t]=!0)}function $(t){!1!==c[t]&&(e.disable(t),c[t]=!1)}B[e.TEXTURE_2D]=z(e.TEXTURE_2D,e.TEXTURE_2D,1),B[e.TEXTURE_CUBE_MAP]=z(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),a&&(B[e.TEXTURE_2D_ARRAY]=z(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),B[e.TEXTURE_3D]=z(e.TEXTURE_3D,e.TEXTURE_3D,1,1)),r.setClear(0,0,0,1),i.setClear(1),s.setClear(0),H(e.DEPTH_TEST),i.setFunc(3),X(!1),q(1),H(e.CULL_FACE),G(0);const V={[bv]:e.FUNC_ADD,[_v]:e.FUNC_SUBTRACT,[wv]:e.FUNC_REVERSE_SUBTRACT};if(a)V[103]=e.MIN,V[104]=e.MAX;else{const e=t.get("EXT_blend_minmax");null!==e&&(V[103]=e.MIN_EXT,V[104]=e.MAX_EXT)}const W={[Sv]:e.ZERO,[Mv]:e.ONE,[Cv]:e.SRC_COLOR,[kv]:e.SRC_ALPHA,[Rv]:e.SRC_ALPHA_SATURATE,[jv]:e.DST_COLOR,[Nv]:e.DST_ALPHA,[Ev]:e.ONE_MINUS_SRC_COLOR,[Tv]:e.ONE_MINUS_SRC_ALPHA,[Av]:e.ONE_MINUS_DST_COLOR,[Pv]:e.ONE_MINUS_DST_ALPHA,[Iv]:e.CONSTANT_COLOR,[Lv]:e.ONE_MINUS_CONSTANT_COLOR,[Dv]:e.CONSTANT_ALPHA,[Uv]:e.ONE_MINUS_CONSTANT_ALPHA};function G(t,n,a,r,i,s,o,l,c,d){if(0!==t){if(!1===m&&(H(e.BLEND),m=!0),5===t)i=i||n,s=s||a,o=o||r,n===g&&i===x||(e.blendEquationSeparate(V[n],V[i]),g=n,x=i),a===v&&r===y&&s===b&&o===_||(e.blendFuncSeparate(W[a],W[r],W[s],W[o]),v=a,y=r,b=s,_=o),!1!==l.equals(w)&&c===S||(e.blendColor(l.r,l.g,l.b,c),w.copy(l),S=c),f=t,M=!1;else if(t!==f||d!==M){if(g===bv&&x===bv||(e.blendEquation(e.FUNC_ADD),g=bv,x=bv),d)switch(t){case 1:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case 1:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case 2:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFunc(e.ZERO,e.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}v=null,y=null,b=null,_=null,w.set(0,0,0),S=0,f=t,M=d}}else!0===m&&($(e.BLEND),m=!1)}function X(t){C!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),C=t)}function q(t){0!==t?(H(e.CULL_FACE),t!==E&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):$(e.CULL_FACE),E=t}function K(t,n,a){t?(H(e.POLYGON_OFFSET_FILL),T===n&&N===a||(e.polygonOffset(n,a),T=n,N=a)):$(e.POLYGON_OFFSET_FILL)}return{buffers:{color:r,depth:i,stencil:s},enable:H,disable:$,bindFramebuffer:function(t,n){return d[t]!==n&&(e.bindFramebuffer(t,n),d[t]=n,a&&(t===e.DRAW_FRAMEBUFFER&&(d[e.FRAMEBUFFER]=n),t===e.FRAMEBUFFER&&(d[e.DRAW_FRAMEBUFFER]=n)),!0)},drawBuffers:function(a,r){let i=h,s=!1;if(a){i=u.get(r),void 0===i&&(i=[],u.set(r,i));const t=a.textures;if(i.length!==t.length||i[0]!==e.COLOR_ATTACHMENT0){for(let n=0,a=t.length;n<a;n++)i[n]=e.COLOR_ATTACHMENT0+n;i.length=t.length,s=!0}}else i[0]!==e.BACK&&(i[0]=e.BACK,s=!0);if(s)if(n.isWebGL2)e.drawBuffers(i);else{if(!0!==t.has("WEBGL_draw_buffers"))throw new Error("THREE.WebGLState: Usage of gl.drawBuffers() require WebGL2 or WEBGL_draw_buffers extension");t.get("WEBGL_draw_buffers").drawBuffersWEBGL(i)}},useProgram:function(t){return p!==t&&(e.useProgram(t),p=t,!0)},setBlending:G,setMaterial:function(t,n){2===t.side?$(e.CULL_FACE):H(e.CULL_FACE);let a=1===t.side;n&&(a=!a),X(a),1===t.blending&&!1===t.transparent?G(0):G(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),i.setFunc(t.depthFunc),i.setTest(t.depthTest),i.setMask(t.depthWrite),r.setMask(t.colorWrite);const o=t.stencilWrite;s.setTest(o),o&&(s.setMask(t.stencilWriteMask),s.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),s.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),K(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?H(e.SAMPLE_ALPHA_TO_COVERAGE):$(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:X,setCullFace:q,setLineWidth:function(t){t!==k&&(j&&e.lineWidth(t),k=t)},setPolygonOffset:K,setScissorTest:function(t){t?H(e.SCISSOR_TEST):$(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+P-1),I!==t&&(e.activeTexture(t),I=t)},bindTexture:function(t,n,a){void 0===a&&(a=null===I?e.TEXTURE0+P-1:I);let r=L[a];void 0===r&&(r={type:void 0,texture:void 0},L[a]=r),r.type===t&&r.texture===n||(I!==a&&(e.activeTexture(a),I=a),e.bindTexture(t,n||B[t]),r.type=t,r.texture=n)},unbindTexture:function(){const t=L[I];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexImage3D:function(){try{e.compressedTexImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},updateUBOMapping:function(t,n){let a=l.get(n);void 0===a&&(a=new WeakMap,l.set(n,a));let r=a.get(t);void 0===r&&(r=e.getUniformBlockIndex(n,t.name),a.set(t,r))},uniformBlockBinding:function(t,n){const a=l.get(n).get(t);o.get(n)!==a&&(e.uniformBlockBinding(n,a,t.__bindingPointIndex),o.set(n,a))},texStorage2D:function(){try{e.texStorage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texStorage3D:function(){try{e.texStorage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage2D:function(){try{e.texSubImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage3D:function(){try{e.texSubImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D.apply(e,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(t){!1===O.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),O.copy(t))},viewport:function(t){!1===F.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),F.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),!0===a&&(e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null)),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),c={},I=null,L={},d={},u=new WeakMap,h=[],p=null,m=!1,f=null,g=null,v=null,y=null,x=null,b=null,_=null,w=new Ub(0,0,0),S=0,M=!1,C=null,E=null,k=null,T=null,N=null,O.set(0,0,e.canvas.width,e.canvas.height),F.set(0,0,e.canvas.width,e.canvas.height),r.reset(),i.reset(),s.reset()}}}function yM(e,t,n,a,r,i,s){const o=r.isWebGL2,l=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,c="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),d=new Wy,u=new WeakMap;let h;const p=new WeakMap;let m=!1;try{m="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(B){}function f(e,t){return m?new OffscreenCanvas(e,t):Ky("canvas")}function g(e,t,n,a){let r=1;const i=z(e);if((i.width>a||i.height>a)&&(r=a/Math.max(i.width,i.height)),r<1||!0===t){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const a=t?By:Math.floor,s=a(r*i.width),o=a(r*i.height);void 0===h&&(h=f(s,o));const l=n?f(s,o):h;l.width=s,l.height=o;return l.getContext("2d").drawImage(e,0,0,s,o),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+i.width+"x"+i.height+") to ("+s+"x"+o+")."),l}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+i.width+"x"+i.height+")."),e}return e}function v(e){const t=z(e);return zy(t.width)&&zy(t.height)}function y(e,t){return e.generateMipmaps&&t&&e.minFilter!==Vv&&e.minFilter!==Xv}function x(t){e.generateMipmap(t)}function b(n,a,r,i,s=!1){if(!1===o)return a;if(null!==n){if(void 0!==e[n])return e[n];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+n+"'")}let l=a;if(a===e.RED&&(r===e.FLOAT&&(l=e.R32F),r===e.HALF_FLOAT&&(l=e.R16F),r===e.UNSIGNED_BYTE&&(l=e.R8)),a===e.RED_INTEGER&&(r===e.UNSIGNED_BYTE&&(l=e.R8UI),r===e.UNSIGNED_SHORT&&(l=e.R16UI),r===e.UNSIGNED_INT&&(l=e.R32UI),r===e.BYTE&&(l=e.R8I),r===e.SHORT&&(l=e.R16I),r===e.INT&&(l=e.R32I)),a===e.RG&&(r===e.FLOAT&&(l=e.RG32F),r===e.HALF_FLOAT&&(l=e.RG16F),r===e.UNSIGNED_BYTE&&(l=e.RG8)),a===e.RG_INTEGER&&(r===e.UNSIGNED_BYTE&&(l=e.RG8UI),r===e.UNSIGNED_SHORT&&(l=e.RG16UI),r===e.UNSIGNED_INT&&(l=e.RG32UI),r===e.BYTE&&(l=e.RG8I),r===e.SHORT&&(l=e.RG16I),r===e.INT&&(l=e.RG32I)),a===e.RGBA){const t=s?gy:nx.getTransfer(i);r===e.FLOAT&&(l=e.RGBA32F),r===e.HALF_FLOAT&&(l=e.RGBA16F),r===e.UNSIGNED_BYTE&&(l=t===vy?e.SRGB8_ALPHA8:e.RGBA8),r===e.UNSIGNED_SHORT_4_4_4_4&&(l=e.RGBA4),r===e.UNSIGNED_SHORT_5_5_5_1&&(l=e.RGB5_A1)}return l!==e.R16F&&l!==e.R32F&&l!==e.RG16F&&l!==e.RG32F&&l!==e.RGBA16F&&l!==e.RGBA32F||t.get("EXT_color_buffer_float"),l}function _(e,t,n){return!0===y(e,n)||e.isFramebufferTexture&&e.minFilter!==Vv&&e.minFilter!==Xv?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function w(t){return t===Vv||1004===t||t===Gv?e.NEAREST:e.LINEAR}function S(e){const t=e.target;t.removeEventListener("dispose",S),function(e){const t=a.get(e);if(void 0===t.__webglInit)return;const n=e.source,r=p.get(n);if(r){const a=r[t.__cacheKey];a.usedTimes--,0===a.usedTimes&&C(e),0===Object.keys(r).length&&p.delete(n)}a.remove(e)}(t),t.isVideoTexture&&u.delete(t)}function M(t){const n=t.target;n.removeEventListener("dispose",M),function(t){const n=a.get(t);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLCubeRenderTarget)for(let a=0;a<6;a++){if(Array.isArray(n.__webglFramebuffer[a]))for(let t=0;t<n.__webglFramebuffer[a].length;t++)e.deleteFramebuffer(n.__webglFramebuffer[a][t]);else e.deleteFramebuffer(n.__webglFramebuffer[a]);n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[a])}else{if(Array.isArray(n.__webglFramebuffer))for(let t=0;t<n.__webglFramebuffer.length;t++)e.deleteFramebuffer(n.__webglFramebuffer[t]);else e.deleteFramebuffer(n.__webglFramebuffer);if(n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer),n.__webglMultisampledFramebuffer&&e.deleteFramebuffer(n.__webglMultisampledFramebuffer),n.__webglColorRenderbuffer)for(let t=0;t<n.__webglColorRenderbuffer.length;t++)n.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(n.__webglColorRenderbuffer[t]);n.__webglDepthRenderbuffer&&e.deleteRenderbuffer(n.__webglDepthRenderbuffer)}const r=t.textures;for(let i=0,o=r.length;i<o;i++){const t=a.get(r[i]);t.__webglTexture&&(e.deleteTexture(t.__webglTexture),s.memory.textures--),a.remove(r[i])}a.remove(t)}(n)}function C(t){const n=a.get(t);e.deleteTexture(n.__webglTexture);const r=t.source;delete p.get(r)[n.__cacheKey],s.memory.textures--}let E=0;function k(t,r){const i=a.get(t);if(t.isVideoTexture&&function(e){const t=s.render.frame;u.get(e)!==t&&(u.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&i.__version!==t.version){const e=t.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void R(i,t,r);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}n.bindTexture(e.TEXTURE_2D,i.__webglTexture,e.TEXTURE0+r)}const T={[Bv]:e.REPEAT,[Hv]:e.CLAMP_TO_EDGE,[$v]:e.MIRRORED_REPEAT},N={[Vv]:e.NEAREST,[Wv]:e.NEAREST_MIPMAP_NEAREST,[Gv]:e.NEAREST_MIPMAP_LINEAR,[Xv]:e.LINEAR,[qv]:e.LINEAR_MIPMAP_NEAREST,[Kv]:e.LINEAR_MIPMAP_LINEAR},P={[_y]:e.NEVER,[Ty]:e.ALWAYS,[wy]:e.LESS,[My]:e.LEQUAL,[Sy]:e.EQUAL,[ky]:e.GEQUAL,[Cy]:e.GREATER,[Ey]:e.NOTEQUAL};function j(n,i,s){if(i.type!==ey||!1!==t.has("OES_texture_float_linear")||i.magFilter!==Xv&&i.magFilter!==qv&&i.magFilter!==Gv&&i.magFilter!==Kv&&i.minFilter!==Xv&&i.minFilter!==qv&&i.minFilter!==Gv&&i.minFilter!==Kv||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),s?(e.texParameteri(n,e.TEXTURE_WRAP_S,T[i.wrapS]),e.texParameteri(n,e.TEXTURE_WRAP_T,T[i.wrapT]),n!==e.TEXTURE_3D&&n!==e.TEXTURE_2D_ARRAY||e.texParameteri(n,e.TEXTURE_WRAP_R,T[i.wrapR]),e.texParameteri(n,e.TEXTURE_MAG_FILTER,N[i.magFilter]),e.texParameteri(n,e.TEXTURE_MIN_FILTER,N[i.minFilter])):(e.texParameteri(n,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(n,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),n!==e.TEXTURE_3D&&n!==e.TEXTURE_2D_ARRAY||e.texParameteri(n,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE),i.wrapS===Hv&&i.wrapT===Hv||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),e.texParameteri(n,e.TEXTURE_MAG_FILTER,w(i.magFilter)),e.texParameteri(n,e.TEXTURE_MIN_FILTER,w(i.minFilter)),i.minFilter!==Vv&&i.minFilter!==Xv&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),i.compareFunction&&(e.texParameteri(n,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(n,e.TEXTURE_COMPARE_FUNC,P[i.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(i.magFilter===Vv)return;if(i.minFilter!==Gv&&i.minFilter!==Kv)return;if(i.type===ey&&!1===t.has("OES_texture_float_linear"))return;if(!1===o&&i.type===ty&&!1===t.has("OES_texture_half_float_linear"))return;if(i.anisotropy>1||a.get(i).__currentAnisotropy){const s=t.get("EXT_texture_filter_anisotropic");e.texParameterf(n,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i.anisotropy,r.getMaxAnisotropy())),a.get(i).__currentAnisotropy=i.anisotropy}}}function A(t,n){let a=!1;void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",S));const r=n.source;let i=p.get(r);void 0===i&&(i={},p.set(r,i));const o=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(n);if(o!==t.__cacheKey){void 0===i[o]&&(i[o]={texture:e.createTexture(),usedTimes:0},s.memory.textures++,a=!0),i[o].usedTimes++;const r=i[t.__cacheKey];void 0!==r&&(i[t.__cacheKey].usedTimes--,0===r.usedTimes&&C(n)),t.__cacheKey=o,t.__webglTexture=i[o].texture}return a}function R(t,s,l){let c=e.TEXTURE_2D;(s.isDataArrayTexture||s.isCompressedArrayTexture)&&(c=e.TEXTURE_2D_ARRAY),s.isData3DTexture&&(c=e.TEXTURE_3D);const d=A(t,s),u=s.source;n.bindTexture(c,t.__webglTexture,e.TEXTURE0+l);const h=a.get(u);if(u.version!==h.__version||!0===d){n.activeTexture(e.TEXTURE0+l);const t=nx.getPrimaries(nx.workingColorSpace),a=s.colorSpace===uy?null:nx.getPrimaries(s.colorSpace),p=s.colorSpace===uy||t===a?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,s.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,p);const m=function(e){return!o&&(e.wrapS!==Hv||e.wrapT!==Hv||e.minFilter!==Vv&&e.minFilter!==Xv)}(s)&&!1===v(s.image);let f=g(s.image,m,!1,r.maxTextureSize);f=F(s,f);const w=v(f)||o,S=i.convert(s.format,s.colorSpace);let M,C=i.convert(s.type),E=b(s.internalFormat,S,C,s.colorSpace,s.isVideoTexture);j(c,s,w);const k=s.mipmaps,T=o&&!0!==s.isVideoTexture&&36196!==E,N=void 0===h.__version||!0===d,P=u.dataReady,A=_(s,f,w);if(s.isDepthTexture)E=e.DEPTH_COMPONENT,o?E=s.type===ey?e.DEPTH_COMPONENT32F:s.type===Qv?e.DEPTH_COMPONENT24:s.type===ny?e.DEPTH24_STENCIL8:e.DEPTH_COMPONENT16:s.type===ey&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),s.format===ry&&E===e.DEPTH_COMPONENT&&s.type!==Jv&&s.type!==Qv&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),s.type=Qv,C=i.convert(s.type)),s.format===iy&&E===e.DEPTH_COMPONENT&&(E=e.DEPTH_STENCIL,s.type!==ny&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),s.type=ny,C=i.convert(s.type))),N&&(T?n.texStorage2D(e.TEXTURE_2D,1,E,f.width,f.height):n.texImage2D(e.TEXTURE_2D,0,E,f.width,f.height,0,S,C,null));else if(s.isDataTexture)if(k.length>0&&w){T&&N&&n.texStorage2D(e.TEXTURE_2D,A,E,k[0].width,k[0].height);for(let t=0,a=k.length;t<a;t++)M=k[t],T?P&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,M.width,M.height,S,C,M.data):n.texImage2D(e.TEXTURE_2D,t,E,M.width,M.height,0,S,C,M.data);s.generateMipmaps=!1}else T?(N&&n.texStorage2D(e.TEXTURE_2D,A,E,f.width,f.height),P&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,f.width,f.height,S,C,f.data)):n.texImage2D(e.TEXTURE_2D,0,E,f.width,f.height,0,S,C,f.data);else if(s.isCompressedTexture)if(s.isCompressedArrayTexture){T&&N&&n.texStorage3D(e.TEXTURE_2D_ARRAY,A,E,k[0].width,k[0].height,f.depth);for(let t=0,a=k.length;t<a;t++)M=k[t],s.format!==ay?null!==S?T?P&&n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,M.width,M.height,f.depth,S,M.data,0,0):n.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,E,M.width,M.height,f.depth,0,M.data,0,0):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):T?P&&n.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,M.width,M.height,f.depth,S,C,M.data):n.texImage3D(e.TEXTURE_2D_ARRAY,t,E,M.width,M.height,f.depth,0,S,C,M.data)}else{T&&N&&n.texStorage2D(e.TEXTURE_2D,A,E,k[0].width,k[0].height);for(let t=0,a=k.length;t<a;t++)M=k[t],s.format!==ay?null!==S?T?P&&n.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,M.width,M.height,S,M.data):n.compressedTexImage2D(e.TEXTURE_2D,t,E,M.width,M.height,0,M.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):T?P&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,M.width,M.height,S,C,M.data):n.texImage2D(e.TEXTURE_2D,t,E,M.width,M.height,0,S,C,M.data)}else if(s.isDataArrayTexture)T?(N&&n.texStorage3D(e.TEXTURE_2D_ARRAY,A,E,f.width,f.height,f.depth),P&&n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,f.width,f.height,f.depth,S,C,f.data)):n.texImage3D(e.TEXTURE_2D_ARRAY,0,E,f.width,f.height,f.depth,0,S,C,f.data);else if(s.isData3DTexture)T?(N&&n.texStorage3D(e.TEXTURE_3D,A,E,f.width,f.height,f.depth),P&&n.texSubImage3D(e.TEXTURE_3D,0,0,0,0,f.width,f.height,f.depth,S,C,f.data)):n.texImage3D(e.TEXTURE_3D,0,E,f.width,f.height,f.depth,0,S,C,f.data);else if(s.isFramebufferTexture){if(N)if(T)n.texStorage2D(e.TEXTURE_2D,A,E,f.width,f.height);else{let t=f.width,a=f.height;for(let r=0;r<A;r++)n.texImage2D(e.TEXTURE_2D,r,E,t,a,0,S,C,null),t>>=1,a>>=1}}else if(k.length>0&&w){if(T&&N){const t=z(k[0]);n.texStorage2D(e.TEXTURE_2D,A,E,t.width,t.height)}for(let t=0,a=k.length;t<a;t++)M=k[t],T?P&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,S,C,M):n.texImage2D(e.TEXTURE_2D,t,E,S,C,M);s.generateMipmaps=!1}else if(T){if(N){const t=z(f);n.texStorage2D(e.TEXTURE_2D,A,E,t.width,t.height)}P&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,S,C,f)}else n.texImage2D(e.TEXTURE_2D,0,E,S,C,f);y(s,w)&&x(c),h.__version=u.version,s.onUpdate&&s.onUpdate(s)}t.__version=s.version}function I(t,r,s,o,c,d){const u=i.convert(s.format,s.colorSpace),h=i.convert(s.type),p=b(s.internalFormat,u,h,s.colorSpace);if(!a.get(r).__hasExternalTextures){const t=Math.max(1,r.width>>d),a=Math.max(1,r.height>>d);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?n.texImage3D(c,d,p,t,a,r.depth,0,u,h,null):n.texImage2D(c,d,p,t,a,0,u,h,null)}n.bindFramebuffer(e.FRAMEBUFFER,t),O(r)?l.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,o,c,a.get(s).__webglTexture,0,U(r)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,o,c,a.get(s).__webglTexture,d),n.bindFramebuffer(e.FRAMEBUFFER,null)}function L(t,n,a){if(e.bindRenderbuffer(e.RENDERBUFFER,t),n.depthBuffer&&!n.stencilBuffer){let r=!0===o?e.DEPTH_COMPONENT24:e.DEPTH_COMPONENT16;if(a||O(n)){const t=n.depthTexture;t&&t.isDepthTexture&&(t.type===ey?r=e.DEPTH_COMPONENT32F:t.type===Qv&&(r=e.DEPTH_COMPONENT24));const a=U(n);O(n)?l.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,a,r,n.width,n.height):e.renderbufferStorageMultisample(e.RENDERBUFFER,a,r,n.width,n.height)}else e.renderbufferStorage(e.RENDERBUFFER,r,n.width,n.height);e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)}else if(n.depthBuffer&&n.stencilBuffer){const r=U(n);a&&!1===O(n)?e.renderbufferStorageMultisample(e.RENDERBUFFER,r,e.DEPTH24_STENCIL8,n.width,n.height):O(n)?l.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,r,e.DEPTH24_STENCIL8,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)}else{const t=n.textures;for(let r=0;r<t.length;r++){const s=t[r],o=i.convert(s.format,s.colorSpace),c=i.convert(s.type),d=b(s.internalFormat,o,c,s.colorSpace),u=U(n);a&&!1===O(n)?e.renderbufferStorageMultisample(e.RENDERBUFFER,u,d,n.width,n.height):O(n)?l.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,u,d,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,d,n.width,n.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function D(t){const r=a.get(t),i=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture&&!r.__autoAllocateDepthBuffer){if(i)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(n.bindFramebuffer(e.FRAMEBUFFER,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");a.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),k(r.depthTexture,0);const i=a.get(r.depthTexture).__webglTexture,s=U(r);if(r.depthTexture.format===ry)O(r)?l.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,i,0,s):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,i,0);else{if(r.depthTexture.format!==iy)throw new Error("Unknown depthTexture format");O(r)?l.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,i,0,s):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,i,0)}}(r.__webglFramebuffer,t)}else if(i){r.__webglDepthbuffer=[];for(let a=0;a<6;a++)n.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[a]),r.__webglDepthbuffer[a]=e.createRenderbuffer(),L(r.__webglDepthbuffer[a],t,!1)}else n.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=e.createRenderbuffer(),L(r.__webglDepthbuffer,t,!1);n.bindFramebuffer(e.FRAMEBUFFER,null)}function U(e){return Math.min(r.maxSamples,e.samples)}function O(e){const n=a.get(e);return o&&e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==n.__useRenderToTexture}function F(e,n){const a=e.colorSpace,r=e.format,i=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||e.format===Py||a!==py&&a!==uy&&(nx.getTransfer(a)===vy?!1===o?!0===t.has("EXT_sRGB")&&r===ay?(e.format=Py,e.minFilter=Xv,e.generateMipmaps=!1):n=sx.sRGBToLinear(n):r===ay&&i===Yv||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",a)),n}function z(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(d.width=e.naturalWidth||e.width,d.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(d.width=e.displayWidth,d.height=e.displayHeight):(d.width=e.width,d.height=e.height),d}this.allocateTextureUnit=function(){const e=E;return e>=r.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+r.maxTextures),E+=1,e},this.resetTextureUnits=function(){E=0},this.setTexture2D=k,this.setTexture2DArray=function(t,r){const i=a.get(t);t.version>0&&i.__version!==t.version?R(i,t,r):n.bindTexture(e.TEXTURE_2D_ARRAY,i.__webglTexture,e.TEXTURE0+r)},this.setTexture3D=function(t,r){const i=a.get(t);t.version>0&&i.__version!==t.version?R(i,t,r):n.bindTexture(e.TEXTURE_3D,i.__webglTexture,e.TEXTURE0+r)},this.setTextureCube=function(t,s){const l=a.get(t);t.version>0&&l.__version!==t.version?function(t,s,l){if(6!==s.image.length)return;const c=A(t,s),d=s.source;n.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+l);const u=a.get(d);if(d.version!==u.__version||!0===c){n.activeTexture(e.TEXTURE0+l);const t=nx.getPrimaries(nx.workingColorSpace),a=s.colorSpace===uy?null:nx.getPrimaries(s.colorSpace),h=s.colorSpace===uy||t===a?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,s.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,h);const p=s.isCompressedTexture||s.image[0].isCompressedTexture,m=s.image[0]&&s.image[0].isDataTexture,f=[];for(let e=0;e<6;e++)f[e]=p||m?m?s.image[e].image:s.image[e]:g(s.image[e],!1,!0,r.maxCubemapSize),f[e]=F(s,f[e]);const w=f[0],S=v(w)||o,M=i.convert(s.format,s.colorSpace),C=i.convert(s.type),E=b(s.internalFormat,M,C,s.colorSpace),k=o&&!0!==s.isVideoTexture,T=void 0===u.__version||!0===c,N=d.dataReady;let P,A=_(s,w,S);if(j(e.TEXTURE_CUBE_MAP,s,S),p){k&&T&&n.texStorage2D(e.TEXTURE_CUBE_MAP,A,E,w.width,w.height);for(let t=0;t<6;t++){P=f[t].mipmaps;for(let a=0;a<P.length;a++){const r=P[a];s.format!==ay?null!==M?k?N&&n.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,0,0,r.width,r.height,M,r.data):n.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,E,r.width,r.height,0,r.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):k?N&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,0,0,r.width,r.height,M,C,r.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,E,r.width,r.height,0,M,C,r.data)}}}else{if(P=s.mipmaps,k&&T){P.length>0&&A++;const t=z(f[0]);n.texStorage2D(e.TEXTURE_CUBE_MAP,A,E,t.width,t.height)}for(let t=0;t<6;t++)if(m){k?N&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,f[t].width,f[t].height,M,C,f[t].data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,E,f[t].width,f[t].height,0,M,C,f[t].data);for(let a=0;a<P.length;a++){const r=P[a].image[t].image;k?N&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,0,0,r.width,r.height,M,C,r.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,E,r.width,r.height,0,M,C,r.data)}}else{k?N&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,M,C,f[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,E,M,C,f[t]);for(let a=0;a<P.length;a++){const r=P[a];k?N&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,0,0,M,C,r.image[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,E,M,C,r.image[t])}}}y(s,S)&&x(e.TEXTURE_CUBE_MAP),u.__version=d.version,s.onUpdate&&s.onUpdate(s)}t.__version=s.version}(l,t,s):n.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture,e.TEXTURE0+s)},this.rebindTextures=function(t,n,r){const i=a.get(t);void 0!==n&&I(i.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==r&&D(t)},this.setupRenderTarget=function(t){const l=t.texture,c=a.get(t),d=a.get(l);t.addEventListener("dispose",M);const u=t.textures,h=!0===t.isWebGLCubeRenderTarget,p=u.length>1,m=v(t)||o;if(p||(void 0===d.__webglTexture&&(d.__webglTexture=e.createTexture()),d.__version=l.version,s.memory.textures++),h){c.__webglFramebuffer=[];for(let t=0;t<6;t++)if(o&&l.mipmaps&&l.mipmaps.length>0){c.__webglFramebuffer[t]=[];for(let n=0;n<l.mipmaps.length;n++)c.__webglFramebuffer[t][n]=e.createFramebuffer()}else c.__webglFramebuffer[t]=e.createFramebuffer()}else{if(o&&l.mipmaps&&l.mipmaps.length>0){c.__webglFramebuffer=[];for(let t=0;t<l.mipmaps.length;t++)c.__webglFramebuffer[t]=e.createFramebuffer()}else c.__webglFramebuffer=e.createFramebuffer();if(p)if(r.drawBuffers)for(let t=0,n=u.length;t<n;t++){const n=a.get(u[t]);void 0===n.__webglTexture&&(n.__webglTexture=e.createTexture(),s.memory.textures++)}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");if(o&&t.samples>0&&!1===O(t)){c.__webglMultisampledFramebuffer=e.createFramebuffer(),c.__webglColorRenderbuffer=[],n.bindFramebuffer(e.FRAMEBUFFER,c.__webglMultisampledFramebuffer);for(let n=0;n<u.length;n++){const a=u[n];c.__webglColorRenderbuffer[n]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,c.__webglColorRenderbuffer[n]);const r=i.convert(a.format,a.colorSpace),s=i.convert(a.type),o=b(a.internalFormat,r,s,a.colorSpace,!0===t.isXRRenderTarget),l=U(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,l,o,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.RENDERBUFFER,c.__webglColorRenderbuffer[n])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(c.__webglDepthRenderbuffer=e.createRenderbuffer(),L(c.__webglDepthRenderbuffer,t,!0)),n.bindFramebuffer(e.FRAMEBUFFER,null)}}if(h){n.bindTexture(e.TEXTURE_CUBE_MAP,d.__webglTexture),j(e.TEXTURE_CUBE_MAP,l,m);for(let n=0;n<6;n++)if(o&&l.mipmaps&&l.mipmaps.length>0)for(let a=0;a<l.mipmaps.length;a++)I(c.__webglFramebuffer[n][a],t,l,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,a);else I(c.__webglFramebuffer[n],t,l,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0);y(l,m)&&x(e.TEXTURE_CUBE_MAP),n.unbindTexture()}else if(p){for(let r=0,i=u.length;r<i;r++){const i=u[r],s=a.get(i);n.bindTexture(e.TEXTURE_2D,s.__webglTexture),j(e.TEXTURE_2D,i,m),I(c.__webglFramebuffer,t,i,e.COLOR_ATTACHMENT0+r,e.TEXTURE_2D,0),y(i,m)&&x(e.TEXTURE_2D)}n.unbindTexture()}else{let a=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(o?a=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY:console.error("THREE.WebGLTextures: THREE.Data3DTexture and THREE.DataArrayTexture only supported with WebGL2.")),n.bindTexture(a,d.__webglTexture),j(a,l,m),o&&l.mipmaps&&l.mipmaps.length>0)for(let n=0;n<l.mipmaps.length;n++)I(c.__webglFramebuffer[n],t,l,e.COLOR_ATTACHMENT0,a,n);else I(c.__webglFramebuffer,t,l,e.COLOR_ATTACHMENT0,a,0);y(l,m)&&x(a),n.unbindTexture()}t.depthBuffer&&D(t)},this.updateRenderTargetMipmap=function(t){const r=v(t)||o,i=t.textures;for(let s=0,o=i.length;s<o;s++){const o=i[s];if(y(o,r)){const r=t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,i=a.get(o).__webglTexture;n.bindTexture(r,i),x(r),n.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(o&&t.samples>0&&!1===O(t)){const r=t.textures,i=t.width,s=t.height;let o=e.COLOR_BUFFER_BIT;const l=[],d=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,u=a.get(t),h=r.length>1;if(h)for(let t=0;t<r.length;t++)n.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),n.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);n.bindFramebuffer(e.READ_FRAMEBUFFER,u.__webglMultisampledFramebuffer),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglFramebuffer);for(let n=0;n<r.length;n++){l.push(e.COLOR_ATTACHMENT0+n),t.depthBuffer&&l.push(d);const p=void 0!==u.__ignoreDepthValues&&u.__ignoreDepthValues;if(!1===p&&(t.depthBuffer&&(o|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&(o|=e.STENCIL_BUFFER_BIT)),h&&e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,u.__webglColorRenderbuffer[n]),!0===p&&(e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[d]),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[d])),h){const t=a.get(r[n]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,i,s,0,0,i,s,o,e.NEAREST),c&&e.invalidateFramebuffer(e.READ_FRAMEBUFFER,l)}if(n.bindFramebuffer(e.READ_FRAMEBUFFER,null),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),h)for(let t=0;t<r.length;t++){n.bindFramebuffer(e.FRAMEBUFFER,u.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,u.__webglColorRenderbuffer[t]);const i=a.get(r[t]).__webglTexture;n.bindFramebuffer(e.FRAMEBUFFER,u.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,i,0)}n.bindFramebuffer(e.DRAW_FRAMEBUFFER,u.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=D,this.setupFrameBufferTexture=I,this.useMultisampledRTT=O}function xM(e,t,n){const a=n.isWebGL2;return{convert:function(n,r=""){let i;const s=nx.getTransfer(r);if(n===Yv)return e.UNSIGNED_BYTE;if(1017===n)return e.UNSIGNED_SHORT_4_4_4_4;if(1018===n)return e.UNSIGNED_SHORT_5_5_5_1;if(1010===n)return e.BYTE;if(1011===n)return e.SHORT;if(n===Jv)return e.UNSIGNED_SHORT;if(n===Zv)return e.INT;if(n===Qv)return e.UNSIGNED_INT;if(n===ey)return e.FLOAT;if(n===ty)return a?e.HALF_FLOAT:(i=t.get("OES_texture_half_float"),null!==i?i.HALF_FLOAT_OES:null);if(1021===n)return e.ALPHA;if(n===ay)return e.RGBA;if(1024===n)return e.LUMINANCE;if(1025===n)return e.LUMINANCE_ALPHA;if(n===ry)return e.DEPTH_COMPONENT;if(n===iy)return e.DEPTH_STENCIL;if(n===Py)return i=t.get("EXT_sRGB"),null!==i?i.SRGB_ALPHA_EXT:null;if(1028===n)return e.RED;if(1029===n)return e.RED_INTEGER;if(1030===n)return e.RG;if(1031===n)return e.RG_INTEGER;if(1033===n)return e.RGBA_INTEGER;if(n===sy||n===oy||n===ly||n===cy)if(s===vy){if(i=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===i)return null;if(n===sy)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===oy)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===ly)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===cy)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(i=t.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(n===sy)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===oy)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===ly)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===cy)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===n||35841===n||35842===n||35843===n){if(i=t.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(35840===n)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===n)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===n)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===n)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===n)return i=t.get("WEBGL_compressed_texture_etc1"),null!==i?i.COMPRESSED_RGB_ETC1_WEBGL:null;if(37492===n||37496===n){if(i=t.get("WEBGL_compressed_texture_etc"),null===i)return null;if(37492===n)return s===vy?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(37496===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}if(37808===n||37809===n||37810===n||37811===n||37812===n||37813===n||37814===n||37815===n||37816===n||37817===n||37818===n||37819===n||37820===n||37821===n){if(i=t.get("WEBGL_compressed_texture_astc"),null===i)return null;if(37808===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===n)return s===vy?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}if(n===dy||36494===n||36495===n){if(i=t.get("EXT_texture_compression_bptc"),null===i)return null;if(n===dy)return s===vy?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(36494===n)return i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(36495===n)return i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===n||36284===n||36285===n||36286===n){if(i=t.get("EXT_texture_compression_rgtc"),null===i)return null;if(n===dy)return i.COMPRESSED_RED_RGTC1_EXT;if(36284===n)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(36285===n)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(36286===n)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return n===ny?a?e.UNSIGNED_INT_24_8:(i=t.get("WEBGL_depth_texture"),null!==i?i.UNSIGNED_INT_24_8_WEBGL:null):void 0!==e[n]?e[n]:null}}}class bM extends j_{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e}}class _M extends _b{constructor(){super(),this.isGroup=!0,this.type="Group"}}const wM={type:"move"};class SM{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new _M,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new _M,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new yx,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new yx),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new _M,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new yx,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new yx),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const n of e.hand.values())this._getHandJoint(t,n)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,n){let a=null,r=null,i=null;const s=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){i=!0;for(const i of e.hand.values()){const e=t.getJointPose(i,n),a=this._getHandJoint(l,i);null!==e&&(a.matrix.fromArray(e.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,a.jointRadius=e.radius),a.visible=null!==e}const a=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],s=a.position.distanceTo(r.position),o=.02,c=.005;l.inputState.pinching&&s>o+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&s<=o-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(r=t.getPose(e.gripSpace,n),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1));null!==s&&(a=t.getPose(e.targetRaySpace,n),null===a&&null!==r&&(a=r),null!==a&&(s.matrix.fromArray(a.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale),s.matrixWorldNeedsUpdate=!0,a.linearVelocity?(s.hasLinearVelocity=!0,s.linearVelocity.copy(a.linearVelocity)):s.hasLinearVelocity=!1,a.angularVelocity?(s.hasAngularVelocity=!0,s.angularVelocity.copy(a.angularVelocity)):s.hasAngularVelocity=!1,this.dispatchEvent(wM)))}return null!==s&&(s.visible=null!==a),null!==o&&(o.visible=null!==r),null!==l&&(l.visible=null!==i),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const n=new _M;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[t.jointName]=n,e.add(n)}return e.joints[t.jointName]}}class MM{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,n){if(null===this.texture){const a=new ux;e.properties.get(a).__webglTexture=t.texture,t.depthNear==n.depthNear&&t.depthFar==n.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=a}}render(e,t){if(null!==this.texture){if(null===this.mesh){const e=t.cameras[0].viewport,n=new E_({extensions:{fragDepth:!0},vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepthEXT = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepthEXT = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:e.z},depthHeight:{value:e.w}}});this.mesh=new x_(new W_(20,20),n)}e.render(this.mesh,t)}}reset(){this.texture=null,this.mesh=null}}class CM extends Ry{constructor(e,t){super();const n=this;let a=null,r=1,i=null,s="local-floor",o=1,l=null,c=null,d=null,u=null,h=null,p=null;const m=new MM,f=t.getContextAttributes();let g=null,v=null;const y=[],x=[],b=new Wy;let _=null;const w=new j_;w.layers.enable(1),w.viewport=new hx;const S=new j_;S.layers.enable(2),S.viewport=new hx;const M=[w,S],C=new bM;C.layers.enable(1),C.layers.enable(2);let E=null,k=null;function T(e){const t=x.indexOf(e.inputSource);if(-1===t)return;const n=y[t];void 0!==n&&(n.update(e.inputSource,e.frame,l||i),n.dispatchEvent({type:e.type,data:e.inputSource}))}function N(){a.removeEventListener("select",T),a.removeEventListener("selectstart",T),a.removeEventListener("selectend",T),a.removeEventListener("squeeze",T),a.removeEventListener("squeezestart",T),a.removeEventListener("squeezeend",T),a.removeEventListener("end",N),a.removeEventListener("inputsourceschange",P);for(let e=0;e<y.length;e++){const t=x[e];null!==t&&(x[e]=null,y[e].disconnect(t))}E=null,k=null,m.reset(),e.setRenderTarget(g),h=null,u=null,d=null,a=null,v=null,L.stop(),n.isPresenting=!1,e.setPixelRatio(_),e.setSize(b.width,b.height,!1),n.dispatchEvent({type:"sessionend"})}function P(e){for(let t=0;t<e.removed.length;t++){const n=e.removed[t],a=x.indexOf(n);a>=0&&(x[a]=null,y[a].disconnect(n))}for(let t=0;t<e.added.length;t++){const n=e.added[t];let a=x.indexOf(n);if(-1===a){for(let e=0;e<y.length;e++){if(e>=x.length){x.push(n),a=e;break}if(null===x[e]){x[e]=n,a=e;break}}if(-1===a)break}const r=y[a];r&&r.connect(n)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=y[e];return void 0===t&&(t=new SM,y[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=y[e];return void 0===t&&(t=new SM,y[e]=t),t.getGripSpace()},this.getHand=function(e){let t=y[e];return void 0===t&&(t=new SM,y[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){r=e,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){s=e,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||i},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==u?u:h},this.getBinding=function(){return d},this.getFrame=function(){return p},this.getSession=function(){return a},this.setSession=async function(c){if(a=c,null!==a){if(g=e.getRenderTarget(),a.addEventListener("select",T),a.addEventListener("selectstart",T),a.addEventListener("selectend",T),a.addEventListener("squeeze",T),a.addEventListener("squeezestart",T),a.addEventListener("squeezeend",T),a.addEventListener("end",N),a.addEventListener("inputsourceschange",P),!0!==f.xrCompatible&&await t.makeXRCompatible(),_=e.getPixelRatio(),e.getSize(b),void 0===a.renderState.layers||!1===e.capabilities.isWebGL2){const n={antialias:void 0!==a.renderState.layers||f.antialias,alpha:!0,depth:f.depth,stencil:f.stencil,framebufferScaleFactor:r};h=new XRWebGLLayer(a,t,n),a.updateRenderState({baseLayer:h}),e.setPixelRatio(1),e.setSize(h.framebufferWidth,h.framebufferHeight,!1),v=new mx(h.framebufferWidth,h.framebufferHeight,{format:ay,type:Yv,colorSpace:e.outputColorSpace,stencilBuffer:f.stencil})}else{let n=null,i=null,s=null;f.depth&&(s=f.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,n=f.stencil?iy:ry,i=f.stencil?ny:Qv);const o={colorFormat:t.RGBA8,depthFormat:s,scaleFactor:r};d=new XRWebGLBinding(a,t),u=d.createProjectionLayer(o),a.updateRenderState({layers:[u]}),e.setPixelRatio(1),e.setSize(u.textureWidth,u.textureHeight,!1),v=new mx(u.textureWidth,u.textureHeight,{format:ay,type:Yv,depthTexture:new Pw(u.textureWidth,u.textureHeight,i,void 0,void 0,void 0,void 0,void 0,void 0,n),stencilBuffer:f.stencil,colorSpace:e.outputColorSpace,samples:f.antialias?4:0});e.properties.get(v).__ignoreDepthValues=u.ignoreDepthValues}v.isXRRenderTarget=!0,this.setFoveation(o),l=null,i=await a.requestReferenceSpace(s),L.setContext(a),L.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==a)return a.environmentBlendMode};const j=new yx,A=new yx;function R(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===a)return;null!==m.texture&&(e.near=m.depthNear,e.far=m.depthFar),C.near=S.near=w.near=e.near,C.far=S.far=w.far=e.far,E===C.near&&k===C.far||(a.updateRenderState({depthNear:C.near,depthFar:C.far}),E=C.near,k=C.far,w.near=E,w.far=k,S.near=E,S.far=k,w.updateProjectionMatrix(),S.updateProjectionMatrix(),e.updateProjectionMatrix());const t=e.parent,n=C.cameras;R(C,t);for(let a=0;a<n.length;a++)R(n[a],t);2===n.length?function(e,t,n){j.setFromMatrixPosition(t.matrixWorld),A.setFromMatrixPosition(n.matrixWorld);const a=j.distanceTo(A),r=t.projectionMatrix.elements,i=n.projectionMatrix.elements,s=r[14]/(r[10]-1),o=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],d=(r[8]-1)/r[0],u=(i[8]+1)/i[0],h=s*d,p=s*u,m=a/(-d+u),f=m*-d;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert();const g=s+m,v=o+m,y=h-f,x=p+(a-f),b=l*o/v*g,_=c*o/v*g;e.projectionMatrix.makePerspective(y,x,b,_,g,v),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}(C,w,S):C.projectionMatrix.copy(w.projectionMatrix),function(e,t,n){null===n?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*Dy*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,C,t)},this.getCamera=function(){return C},this.getFoveation=function(){if(null!==u||null!==h)return o},this.setFoveation=function(e){o=e,null!==u&&(u.fixedFoveation=e),null!==h&&void 0!==h.fixedFoveation&&(h.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==m.texture};let I=null;const L=new $_;L.setAnimationLoop(function(t,r){if(c=r.getViewerPose(l||i),p=r,null!==c){const t=c.views;null!==h&&(e.setRenderTargetFramebuffer(v,h.framebuffer),e.setRenderTarget(v));let n=!1;t.length!==C.cameras.length&&(C.cameras.length=0,n=!0);for(let a=0;a<t.length;a++){const r=t[a];let i=null;if(null!==h)i=h.getViewport(r);else{const t=d.getViewSubImage(u,r);i=t.viewport,0===a&&(e.setRenderTargetTextures(v,t.colorTexture,u.ignoreDepthValues?void 0:t.depthStencilTexture),e.setRenderTarget(v))}let s=M[a];void 0===s&&(s=new j_,s.layers.enable(a),s.viewport=new hx,M[a]=s),s.matrix.fromArray(r.transform.matrix),s.matrix.decompose(s.position,s.quaternion,s.scale),s.projectionMatrix.fromArray(r.projectionMatrix),s.projectionMatrixInverse.copy(s.projectionMatrix).invert(),s.viewport.set(i.x,i.y,i.width,i.height),0===a&&(C.matrix.copy(s.matrix),C.matrix.decompose(C.position,C.quaternion,C.scale)),!0===n&&C.cameras.push(s)}const r=a.enabledFeatures;if(r&&r.includes("depth-sensing")){const n=d.getDepthInformation(t[0]);n&&n.isValid&&n.texture&&m.init(e,n,a.renderState)}}for(let e=0;e<y.length;e++){const t=x[e],n=y[e];null!==t&&void 0!==n&&n.update(t,r,l||i)}m.render(e,C),I&&I(t,r),r.detectedPlanes&&n.dispatchEvent({type:"planesdetected",data:r}),p=null}),this.setAnimationLoop=function(e){I=e},this.dispose=function(){}}}const EM=new rb,kM=new qx;function TM(e,t){function n(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function a(a,r){a.opacity.value=r.opacity,r.color&&a.diffuse.value.copy(r.color),r.emissive&&a.emissive.value.copy(r.emissive).multiplyScalar(r.emissiveIntensity),r.map&&(a.map.value=r.map,n(r.map,a.mapTransform)),r.alphaMap&&(a.alphaMap.value=r.alphaMap,n(r.alphaMap,a.alphaMapTransform)),r.bumpMap&&(a.bumpMap.value=r.bumpMap,n(r.bumpMap,a.bumpMapTransform),a.bumpScale.value=r.bumpScale,1===r.side&&(a.bumpScale.value*=-1)),r.normalMap&&(a.normalMap.value=r.normalMap,n(r.normalMap,a.normalMapTransform),a.normalScale.value.copy(r.normalScale),1===r.side&&a.normalScale.value.negate()),r.displacementMap&&(a.displacementMap.value=r.displacementMap,n(r.displacementMap,a.displacementMapTransform),a.displacementScale.value=r.displacementScale,a.displacementBias.value=r.displacementBias),r.emissiveMap&&(a.emissiveMap.value=r.emissiveMap,n(r.emissiveMap,a.emissiveMapTransform)),r.specularMap&&(a.specularMap.value=r.specularMap,n(r.specularMap,a.specularMapTransform)),r.alphaTest>0&&(a.alphaTest.value=r.alphaTest);const i=t.get(r),s=i.envMap,o=i.envMapRotation;if(s&&(a.envMap.value=s,EM.copy(o),EM.x*=-1,EM.y*=-1,EM.z*=-1,s.isCubeTexture&&!1===s.isRenderTargetTexture&&(EM.y*=-1,EM.z*=-1),a.envMapRotation.value.setFromMatrix4(kM.makeRotationFromEuler(EM)),a.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,a.reflectivity.value=r.reflectivity,a.ior.value=r.ior,a.refractionRatio.value=r.refractionRatio),r.lightMap){a.lightMap.value=r.lightMap;const t=!0===e._useLegacyLights?Math.PI:1;a.lightMapIntensity.value=r.lightMapIntensity*t,n(r.lightMap,a.lightMapTransform)}r.aoMap&&(a.aoMap.value=r.aoMap,a.aoMapIntensity.value=r.aoMapIntensity,n(r.aoMap,a.aoMapTransform))}return{refreshFogUniforms:function(t,n){n.color.getRGB(t.fogColor.value,M_(e)),n.isFog?(t.fogNear.value=n.near,t.fogFar.value=n.far):n.isFogExp2&&(t.fogDensity.value=n.density)},refreshMaterialUniforms:function(e,r,i,s,o){r.isMeshBasicMaterial||r.isMeshLambertMaterial?a(e,r):r.isMeshToonMaterial?(a(e,r),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,r)):r.isMeshPhongMaterial?(a(e,r),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,r)):r.isMeshStandardMaterial?(a(e,r),function(e,a){e.metalness.value=a.metalness,a.metalnessMap&&(e.metalnessMap.value=a.metalnessMap,n(a.metalnessMap,e.metalnessMapTransform));e.roughness.value=a.roughness,a.roughnessMap&&(e.roughnessMap.value=a.roughnessMap,n(a.roughnessMap,e.roughnessMapTransform));const r=t.get(a).envMap;r&&(e.envMapIntensity.value=a.envMapIntensity)}(e,r),r.isMeshPhysicalMaterial&&function(e,t,a){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,n(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,n(t.sheenRoughnessMap,e.sheenRoughnessMapTransform)));t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,n(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,n(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,n(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),1===t.side&&e.clearcoatNormalScale.value.negate()));t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,n(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,n(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform)));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=a.texture,e.transmissionSamplerSize.value.set(a.width,a.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,n(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,n(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor));t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,n(t.anisotropyMap,e.anisotropyMapTransform)));e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,n(t.specularColorMap,e.specularColorMapTransform));t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,n(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,r,o)):r.isMeshMatcapMaterial?(a(e,r),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,r)):r.isMeshDepthMaterial?a(e,r):r.isMeshDistanceMaterial?(a(e,r),function(e,n){const a=t.get(n).light;e.referencePosition.value.setFromMatrixPosition(a.matrixWorld),e.nearDistance.value=a.shadow.camera.near,e.farDistance.value=a.shadow.camera.far}(e,r)):r.isMeshNormalMaterial?a(e,r):r.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform))}(e,r),r.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,r)):r.isPointsMaterial?function(e,t,a,r){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*a,e.scale.value=.5*r,t.map&&(e.map.value=t.map,n(t.map,e.uvTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r,i,s):r.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform));t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform));t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r):r.isShadowMaterial?(e.color.value.copy(r.color),e.opacity.value=r.opacity):r.isShaderMaterial&&(r.uniformsNeedUpdate=!1)}}}function NM(e,t,n,a){let r={},i={},s=[];const o=n.isWebGL2?e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS):0;function l(e,t,n,a){const r=e.value,i=t+"_"+n;if(void 0===a[i])return a[i]="number"==typeof r||"boolean"==typeof r?r:r.clone(),!0;{const e=a[i];if("number"==typeof r||"boolean"==typeof r){if(e!==r)return a[i]=r,!0}else if(!1===e.equals(r))return e.copy(r),!0}return!1}function c(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function d(t){const n=t.target;n.removeEventListener("dispose",d);const a=s.indexOf(n.__bindingPointIndex);s.splice(a,1),e.deleteBuffer(r[n.id]),delete r[n.id],delete i[n.id]}return{bind:function(e,t){const n=t.program;a.uniformBlockBinding(e,n)},update:function(n,u){let h=r[n.id];void 0===h&&(!function(e){const t=e.uniforms;let n=0;const a=16;for(let i=0,s=t.length;i<s;i++){const e=Array.isArray(t[i])?t[i]:[t[i]];for(let t=0,r=e.length;t<r;t++){const r=e[t],i=Array.isArray(r.value)?r.value:[r.value];for(let e=0,t=i.length;e<t;e++){const t=c(i[e]),s=n%a;0!==s&&a-s<t.boundary&&(n+=a-s),r.__data=new Float32Array(t.storage/Float32Array.BYTES_PER_ELEMENT),r.__offset=n,n+=t.storage}}}const r=n%a;r>0&&(n+=a-r);e.__size=n,e.__cache={}}(n),h=function(t){const n=function(){for(let e=0;e<o;e++)if(-1===s.indexOf(e))return s.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=n;const a=e.createBuffer(),r=t.__size,i=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,a),e.bufferData(e.UNIFORM_BUFFER,r,i),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,n,a),a}(n),r[n.id]=h,n.addEventListener("dispose",d));const p=u.program;a.updateUBOMapping(n,p);const m=t.render.frame;i[n.id]!==m&&(!function(t){const n=r[t.id],a=t.uniforms,i=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,n);for(let r=0,s=a.length;r<s;r++){const t=Array.isArray(a[r])?a[r]:[a[r]];for(let n=0,a=t.length;n<a;n++){const a=t[n];if(!0===l(a,r,n,i)){const t=a.__offset,n=Array.isArray(a.value)?a.value:[a.value];let r=0;for(let i=0;i<n.length;i++){const s=n[i],o=c(s);"number"==typeof s||"boolean"==typeof s?(a.__data[0]=s,e.bufferSubData(e.UNIFORM_BUFFER,t+r,a.__data)):s.isMatrix3?(a.__data[0]=s.elements[0],a.__data[1]=s.elements[1],a.__data[2]=s.elements[2],a.__data[3]=0,a.__data[4]=s.elements[3],a.__data[5]=s.elements[4],a.__data[6]=s.elements[5],a.__data[7]=0,a.__data[8]=s.elements[6],a.__data[9]=s.elements[7],a.__data[10]=s.elements[8],a.__data[11]=0):(s.toArray(a.__data,r),r+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,a.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(n),i[n.id]=m)},dispose:function(){for(const t in r)e.deleteBuffer(r[t]);s=[],r={},i={}}}}class PM{constructor(e={}){const{canvas:t=Yy(),context:n=null,depth:a=!0,stencil:r=!0,alpha:i=!1,antialias:s=!1,premultipliedAlpha:o=!0,preserveDrawingBuffer:l=!1,powerPreference:c="default",failIfMajorPerformanceCaveat:d=!1}=e;let u;this.isWebGLRenderer=!0,u=null!==n?n.getContextAttributes().alpha:i;const h=new Uint32Array(4),p=new Int32Array(4);let m=null,f=null;const g=[],v=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=hy,this._useLegacyLights=!1,this.toneMapping=0,this.toneMappingExposure=1;const y=this;let x=!1,b=0,_=0,w=null,S=-1,M=null;const C=new hx,E=new hx;let k=null;const T=new Ub(0);let N=0,P=t.width,j=t.height,A=1,R=null,I=null;const L=new hx(0,0,P,j),D=new hx(0,0,P,j);let U=!1;const O=new H_;let F=!1,z=!1,B=null;const H=new qx,$=new Wy,V=new yx,W={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function G(){return null===w?A:1}let X,q,K,Y,J,Z,Q,ee,te,ne,ae,re,ie,se,oe,le,ce,de,ue,he,pe,me,fe,ge,ve=n;function ye(e,n){for(let a=0;a<e.length;a++){const r=e[a],i=t.getContext(r,n);if(null!==i)return i}return null}try{const e={alpha:!0,depth:a,stencil:r,antialias:s,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:d};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${cv}`),t.addEventListener("webglcontextlost",_e,!1),t.addEventListener("webglcontextrestored",we,!1),t.addEventListener("webglcontextcreationerror",Se,!1),null===ve){const t=["webgl2","webgl","experimental-webgl"];if(!0===y.isWebGL1Renderer&&t.shift(),ve=ye(t,e),null===ve)throw ye(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}"undefined"!=typeof WebGLRenderingContext&&ve instanceof WebGLRenderingContext&&console.warn("THREE.WebGLRenderer: WebGL 1 support was deprecated in r153 and will be removed in r163."),void 0===ve.getShaderPrecisionFormat&&(ve.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(Ue){throw console.error("THREE.WebGLRenderer: "+Ue.message),Ue}function xe(){X=new ww(ve),q=new tw(ve,X,e),X.init(q),me=new xM(ve,X,q),K=new vM(ve,X,q),Y=new Cw(ve),J=new aM,Z=new yM(ve,X,K,J,q,me,Y),Q=new aw(y),ee=new _w(y),te=new V_(ve,q),fe=new Q_(ve,X,te,q),ne=new Sw(ve,te,Y,fe),ae=new Nw(ve,ne,te,Y),ue=new Tw(ve,q,Z),le=new nw(J),re=new nM(y,Q,ee,X,q,fe,le),ie=new TM(y,J),se=new oM,oe=new pM(X,q),de=new Z_(y,Q,ee,K,ae,u,o),ce=new gM(y,ae,q),ge=new NM(ve,Y,q,K),he=new ew(ve,X,Y,q),pe=new Mw(ve,X,Y,q),Y.programs=re.programs,y.capabilities=q,y.extensions=X,y.properties=J,y.renderLists=se,y.shadowMap=ce,y.state=K,y.info=Y}xe();const be=new CM(y,ve);function _e(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),x=!0}function we(){console.log("THREE.WebGLRenderer: Context Restored."),x=!1;const e=Y.autoReset,t=ce.enabled,n=ce.autoUpdate,a=ce.needsUpdate,r=ce.type;xe(),Y.autoReset=e,ce.enabled=t,ce.autoUpdate=n,ce.needsUpdate=a,ce.type=r}function Se(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Me(e){const t=e.target;t.removeEventListener("dispose",Me),function(e){(function(e){const t=J.get(e).programs;void 0!==t&&(t.forEach(function(e){re.releaseProgram(e)}),e.isShaderMaterial&&re.releaseShaderCache(e))})(e),J.remove(e)}(t)}function Ce(e,t,n){!0===e.transparent&&2===e.side&&!1===e.forceSinglePass?(e.side=1,e.needsUpdate=!0,Ie(e,t,n),e.side=0,e.needsUpdate=!0,Ie(e,t,n),e.side=2):Ie(e,t,n)}this.xr=be,this.getContext=function(){return ve},this.getContextAttributes=function(){return ve.getContextAttributes()},this.forceContextLoss=function(){const e=X.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=X.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return A},this.setPixelRatio=function(e){void 0!==e&&(A=e,this.setSize(P,j,!1))},this.getSize=function(e){return e.set(P,j)},this.setSize=function(e,n,a=!0){be.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(P=e,j=n,t.width=Math.floor(e*A),t.height=Math.floor(n*A),!0===a&&(t.style.width=e+"px",t.style.height=n+"px"),this.setViewport(0,0,e,n))},this.getDrawingBufferSize=function(e){return e.set(P*A,j*A).floor()},this.setDrawingBufferSize=function(e,n,a){P=e,j=n,A=a,t.width=Math.floor(e*a),t.height=Math.floor(n*a),this.setViewport(0,0,e,n)},this.getCurrentViewport=function(e){return e.copy(C)},this.getViewport=function(e){return e.copy(L)},this.setViewport=function(e,t,n,a){e.isVector4?L.set(e.x,e.y,e.z,e.w):L.set(e,t,n,a),K.viewport(C.copy(L).multiplyScalar(A).round())},this.getScissor=function(e){return e.copy(D)},this.setScissor=function(e,t,n,a){e.isVector4?D.set(e.x,e.y,e.z,e.w):D.set(e,t,n,a),K.scissor(E.copy(D).multiplyScalar(A).round())},this.getScissorTest=function(){return U},this.setScissorTest=function(e){K.setScissorTest(U=e)},this.setOpaqueSort=function(e){R=e},this.setTransparentSort=function(e){I=e},this.getClearColor=function(e){return e.copy(de.getClearColor())},this.setClearColor=function(){de.setClearColor.apply(de,arguments)},this.getClearAlpha=function(){return de.getClearAlpha()},this.setClearAlpha=function(){de.setClearAlpha.apply(de,arguments)},this.clear=function(e=!0,t=!0,n=!0){let a=0;if(e){let e=!1;if(null!==w){const t=w.texture.format;e=1033===t||1031===t||1029===t}if(e){const e=w.texture.type,t=e===Yv||e===Qv||e===Jv||e===ny||1017===e||1018===e,n=de.getClearColor(),a=de.getClearAlpha(),r=n.r,i=n.g,s=n.b;t?(h[0]=r,h[1]=i,h[2]=s,h[3]=a,ve.clearBufferuiv(ve.COLOR,0,h)):(p[0]=r,p[1]=i,p[2]=s,p[3]=a,ve.clearBufferiv(ve.COLOR,0,p))}else a|=ve.COLOR_BUFFER_BIT}t&&(a|=ve.DEPTH_BUFFER_BIT),n&&(a|=ve.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),ve.clear(a)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",_e,!1),t.removeEventListener("webglcontextrestored",we,!1),t.removeEventListener("webglcontextcreationerror",Se,!1),se.dispose(),oe.dispose(),J.dispose(),Q.dispose(),ee.dispose(),ae.dispose(),fe.dispose(),ge.dispose(),re.dispose(),be.dispose(),be.removeEventListener("sessionstart",ke),be.removeEventListener("sessionend",Te),B&&(B.dispose(),B=null),Ne.stop()},this.renderBufferDirect=function(e,t,n,a,r,i){null===t&&(t=W);const s=r.isMesh&&r.matrixWorld.determinant()<0,o=function(e,t,n,a,r){!0!==t.isScene&&(t=W);Z.resetTextureUnits();const i=t.fog,s=a.isMeshStandardMaterial?t.environment:null,o=null===w?y.outputColorSpace:!0===w.isXRRenderTarget?w.texture.colorSpace:py,l=(a.isMeshStandardMaterial?ee:Q).get(a.envMap||s),c=!0===a.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,d=!!n.attributes.tangent&&(!!a.normalMap||a.anisotropy>0),u=!!n.morphAttributes.position,h=!!n.morphAttributes.normal,p=!!n.morphAttributes.color;let m=0;a.toneMapped&&(null!==w&&!0!==w.isXRRenderTarget||(m=y.toneMapping));const g=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,v=void 0!==g?g.length:0,x=J.get(a),b=f.state.lights;if(!0===F&&(!0===z||e!==M)){const t=e===M&&a.id===S;le.setState(a,e,t)}let _=!1;a.version===x.__version?x.needsLights&&x.lightsStateVersion!==b.state.version||x.outputColorSpace!==o||r.isBatchedMesh&&!1===x.batching?_=!0:r.isBatchedMesh||!0!==x.batching?r.isInstancedMesh&&!1===x.instancing?_=!0:r.isInstancedMesh||!0!==x.instancing?r.isSkinnedMesh&&!1===x.skinning?_=!0:r.isSkinnedMesh||!0!==x.skinning?r.isInstancedMesh&&!0===x.instancingColor&&null===r.instanceColor||r.isInstancedMesh&&!1===x.instancingColor&&null!==r.instanceColor||r.isInstancedMesh&&!0===x.instancingMorph&&null===r.morphTexture||r.isInstancedMesh&&!1===x.instancingMorph&&null!==r.morphTexture||x.envMap!==l||!0===a.fog&&x.fog!==i?_=!0:void 0===x.numClippingPlanes||x.numClippingPlanes===le.numPlanes&&x.numIntersection===le.numIntersection?(x.vertexAlphas!==c||x.vertexTangents!==d||x.morphTargets!==u||x.morphNormals!==h||x.morphColors!==p||x.toneMapping!==m||!0===q.isWebGL2&&x.morphTargetsCount!==v)&&(_=!0):_=!0:_=!0:_=!0:_=!0:(_=!0,x.__version=a.version);let C=x.currentProgram;!0===_&&(C=Ie(a,t,r));let E=!1,k=!1,T=!1;const N=C.getUniforms(),P=x.uniforms;K.useProgram(C.program)&&(E=!0,k=!0,T=!0);a.id!==S&&(S=a.id,k=!0);if(E||M!==e){N.setValue(ve,"projectionMatrix",e.projectionMatrix),N.setValue(ve,"viewMatrix",e.matrixWorldInverse);const t=N.map.cameraPosition;void 0!==t&&t.setValue(ve,V.setFromMatrixPosition(e.matrixWorld)),q.logarithmicDepthBuffer&&N.setValue(ve,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(a.isMeshPhongMaterial||a.isMeshToonMaterial||a.isMeshLambertMaterial||a.isMeshBasicMaterial||a.isMeshStandardMaterial||a.isShaderMaterial)&&N.setValue(ve,"isOrthographic",!0===e.isOrthographicCamera),M!==e&&(M=e,k=!0,T=!0)}if(r.isSkinnedMesh){N.setOptional(ve,r,"bindMatrix"),N.setOptional(ve,r,"bindMatrixInverse");const e=r.skeleton;e&&(q.floatVertexTextures?(null===e.boneTexture&&e.computeBoneTexture(),N.setValue(ve,"boneTexture",e.boneTexture,Z)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required."))}r.isBatchedMesh&&(N.setOptional(ve,r,"batchingTexture"),N.setValue(ve,"batchingTexture",r._matricesTexture,Z));const R=n.morphAttributes;(void 0!==R.position||void 0!==R.normal||void 0!==R.color&&!0===q.isWebGL2)&&ue.update(r,n,C);(k||x.receiveShadow!==r.receiveShadow)&&(x.receiveShadow=r.receiveShadow,N.setValue(ve,"receiveShadow",r.receiveShadow));a.isMeshGouraudMaterial&&null!==a.envMap&&(P.envMap.value=l,P.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);k&&(N.setValue(ve,"toneMappingExposure",y.toneMappingExposure),x.needsLights&&(L=T,(I=P).ambientLightColor.needsUpdate=L,I.lightProbe.needsUpdate=L,I.directionalLights.needsUpdate=L,I.directionalLightShadows.needsUpdate=L,I.pointLights.needsUpdate=L,I.pointLightShadows.needsUpdate=L,I.spotLights.needsUpdate=L,I.spotLightShadows.needsUpdate=L,I.rectAreaLights.needsUpdate=L,I.hemisphereLights.needsUpdate=L),i&&!0===a.fog&&ie.refreshFogUniforms(P,i),ie.refreshMaterialUniforms(P,a,A,j,B),LS.upload(ve,Le(x),P,Z));var I,L;a.isShaderMaterial&&!0===a.uniformsNeedUpdate&&(LS.upload(ve,Le(x),P,Z),a.uniformsNeedUpdate=!1);a.isSpriteMaterial&&N.setValue(ve,"center",r.center);if(N.setValue(ve,"modelViewMatrix",r.modelViewMatrix),N.setValue(ve,"normalMatrix",r.normalMatrix),N.setValue(ve,"modelMatrix",r.matrixWorld),a.isShaderMaterial||a.isRawShaderMaterial){const e=a.uniformsGroups;for(let t=0,n=e.length;t<n;t++)if(q.isWebGL2){const n=e[t];ge.update(n,C),ge.bind(n,C)}else console.warn("THREE.WebGLRenderer: Uniform Buffer Objects can only be used with WebGL 2.")}return C}(e,t,n,a,r);K.setMaterial(a,s);let l=n.index,c=1;if(!0===a.wireframe){if(l=ne.getWireframeAttribute(n),void 0===l)return;c=2}const d=n.drawRange,u=n.attributes.position;let h=d.start*c,p=(d.start+d.count)*c;null!==i&&(h=Math.max(h,i.start*c),p=Math.min(p,(i.start+i.count)*c)),null!==l?(h=Math.max(h,0),p=Math.min(p,l.count)):null!=u&&(h=Math.max(h,0),p=Math.min(p,u.count));const m=p-h;if(m<0||m===1/0)return;let g;fe.setup(r,a,o,n,l);let v=he;if(null!==l&&(g=te.get(l),v=pe,v.setIndex(g)),r.isMesh)!0===a.wireframe?(K.setLineWidth(a.wireframeLinewidth*G()),v.setMode(ve.LINES)):v.setMode(ve.TRIANGLES);else if(r.isLine){let e=a.linewidth;void 0===e&&(e=1),K.setLineWidth(e*G()),r.isLineSegments?v.setMode(ve.LINES):r.isLineLoop?v.setMode(ve.LINE_LOOP):v.setMode(ve.LINE_STRIP)}else r.isPoints?v.setMode(ve.POINTS):r.isSprite&&v.setMode(ve.TRIANGLES);if(r.isBatchedMesh)v.renderMultiDraw(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount);else if(r.isInstancedMesh)v.renderInstances(h,m,r.count);else if(n.isInstancedBufferGeometry){const e=void 0!==n._maxInstanceCount?n._maxInstanceCount:1/0,t=Math.min(n.instanceCount,e);v.renderInstances(h,m,t)}else v.render(h,m)},this.compile=function(e,t,n=null){null===n&&(n=e),f=oe.get(n),f.init(),v.push(f),n.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(f.pushLight(e),e.castShadow&&f.pushShadow(e))}),e!==n&&e.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&(f.pushLight(e),e.castShadow&&f.pushShadow(e))}),f.setupLights(y._useLegacyLights);const a=new Set;return e.traverse(function(e){const t=e.material;if(t)if(Array.isArray(t))for(let r=0;r<t.length;r++){const i=t[r];Ce(i,n,e),a.add(i)}else Ce(t,n,e),a.add(t)}),v.pop(),f=null,a},this.compileAsync=function(e,t,n=null){const a=this.compile(e,t,n);return new Promise(t=>{function n(){a.forEach(function(e){J.get(e).currentProgram.isReady()&&a.delete(e)}),0!==a.size?setTimeout(n,10):t(e)}null!==X.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)})};let Ee=null;function ke(){Ne.stop()}function Te(){Ne.start()}const Ne=new $_;function Pe(e,t,n,a){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)f.pushLight(e),e.castShadow&&f.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||O.intersectsSprite(e)){a&&V.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H);const t=ae.update(e),r=e.material;r.visible&&m.push(e,t,r,n,V.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||O.intersectsObject(e))){const t=ae.update(e),r=e.material;if(a&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),V.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),V.copy(t.boundingSphere.center)),V.applyMatrix4(e.matrixWorld).applyMatrix4(H)),Array.isArray(r)){const a=t.groups;for(let i=0,s=a.length;i<s;i++){const s=a[i],o=r[s.materialIndex];o&&o.visible&&m.push(e,t,o,n,V.z,s)}}else r.visible&&m.push(e,t,r,n,V.z,null)}const r=e.children;for(let i=0,s=r.length;i<s;i++)Pe(r[i],t,n,a)}function je(e,t,n,a){const r=e.opaque,i=e.transmissive,s=e.transparent;f.setupLightsView(n),!0===F&&le.setGlobalState(y.clippingPlanes,n),i.length>0&&function(e,t,n,a){const r=!0===n.isScene?n.overrideMaterial:null;if(null!==r)return;const i=q.isWebGL2;null===B&&(B=new mx(1,1,{generateMipmaps:!0,type:X.has("EXT_color_buffer_half_float")?ty:Yv,minFilter:Kv,samples:i?4:0}));y.getDrawingBufferSize($),i?B.setSize($.x,$.y):B.setSize(By($.x),By($.y));const s=y.getRenderTarget();y.setRenderTarget(B),y.getClearColor(T),N=y.getClearAlpha(),N<1&&y.setClearColor(16777215,.5);y.clear();const o=y.toneMapping;y.toneMapping=0,Ae(e,n,a),Z.updateMultisampleRenderTarget(B),Z.updateRenderTargetMipmap(B);let l=!1;for(let c=0,d=t.length;c<d;c++){const e=t[c],r=e.object,i=e.geometry,s=e.material,o=e.group;if(2===s.side&&r.layers.test(a.layers)){const e=s.side;s.side=1,s.needsUpdate=!0,Re(r,n,a,i,s,o),s.side=e,s.needsUpdate=!0,l=!0}}!0===l&&(Z.updateMultisampleRenderTarget(B),Z.updateRenderTargetMipmap(B));y.setRenderTarget(s),y.setClearColor(T,N),y.toneMapping=o}(r,i,t,n),a&&K.viewport(C.copy(a)),r.length>0&&Ae(r,t,n),i.length>0&&Ae(i,t,n),s.length>0&&Ae(s,t,n),K.buffers.depth.setTest(!0),K.buffers.depth.setMask(!0),K.buffers.color.setMask(!0),K.setPolygonOffset(!1)}function Ae(e,t,n){const a=!0===t.isScene?t.overrideMaterial:null;for(let r=0,i=e.length;r<i;r++){const i=e[r],s=i.object,o=i.geometry,l=null===a?i.material:a,c=i.group;s.layers.test(n.layers)&&Re(s,t,n,o,l,c)}}function Re(e,t,n,a,r,i){e.onBeforeRender(y,t,n,a,r,i),e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),r.onBeforeRender(y,t,n,a,e,i),!0===r.transparent&&2===r.side&&!1===r.forceSinglePass?(r.side=1,r.needsUpdate=!0,y.renderBufferDirect(n,t,a,r,e,i),r.side=0,r.needsUpdate=!0,y.renderBufferDirect(n,t,a,r,e,i),r.side=2):y.renderBufferDirect(n,t,a,r,e,i),e.onAfterRender(y,t,n,a,r,i)}function Ie(e,t,n){!0!==t.isScene&&(t=W);const a=J.get(e),r=f.state.lights,i=f.state.shadowsArray,s=r.state.version,o=re.getParameters(e,r.state,i,t,n),l=re.getProgramCacheKey(o);let c=a.programs;a.environment=e.isMeshStandardMaterial?t.environment:null,a.fog=t.fog,a.envMap=(e.isMeshStandardMaterial?ee:Q).get(e.envMap||a.environment),a.envMapRotation=null!==a.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===c&&(e.addEventListener("dispose",Me),c=new Map,a.programs=c);let d=c.get(l);if(void 0!==d){if(a.currentProgram===d&&a.lightsStateVersion===s)return De(e,o),d}else o.uniforms=re.getUniforms(e),e.onBuild(n,o,y),e.onBeforeCompile(o,y),d=re.acquireProgram(o,l),c.set(l,d),a.uniforms=o.uniforms;const u=a.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(u.clippingPlanes=le.uniform),De(e,o),a.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),a.lightsStateVersion=s,a.needsLights&&(u.ambientLightColor.value=r.state.ambient,u.lightProbe.value=r.state.probe,u.directionalLights.value=r.state.directional,u.directionalLightShadows.value=r.state.directionalShadow,u.spotLights.value=r.state.spot,u.spotLightShadows.value=r.state.spotShadow,u.rectAreaLights.value=r.state.rectArea,u.ltc_1.value=r.state.rectAreaLTC1,u.ltc_2.value=r.state.rectAreaLTC2,u.pointLights.value=r.state.point,u.pointLightShadows.value=r.state.pointShadow,u.hemisphereLights.value=r.state.hemi,u.directionalShadowMap.value=r.state.directionalShadowMap,u.directionalShadowMatrix.value=r.state.directionalShadowMatrix,u.spotShadowMap.value=r.state.spotShadowMap,u.spotLightMatrix.value=r.state.spotLightMatrix,u.spotLightMap.value=r.state.spotLightMap,u.pointShadowMap.value=r.state.pointShadowMap,u.pointShadowMatrix.value=r.state.pointShadowMatrix),a.currentProgram=d,a.uniformsList=null,d}function Le(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=LS.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function De(e,t){const n=J.get(e);n.outputColorSpace=t.outputColorSpace,n.batching=t.batching,n.instancing=t.instancing,n.instancingColor=t.instancingColor,n.instancingMorph=t.instancingMorph,n.skinning=t.skinning,n.morphTargets=t.morphTargets,n.morphNormals=t.morphNormals,n.morphColors=t.morphColors,n.morphTargetsCount=t.morphTargetsCount,n.numClippingPlanes=t.numClippingPlanes,n.numIntersection=t.numClipIntersection,n.vertexAlphas=t.vertexAlphas,n.vertexTangents=t.vertexTangents,n.toneMapping=t.toneMapping}Ne.setAnimationLoop(function(e){Ee&&Ee(e)}),"undefined"!=typeof self&&Ne.setContext(self),this.setAnimationLoop=function(e){Ee=e,be.setAnimationLoop(e),null===e?Ne.stop():Ne.start()},be.addEventListener("sessionstart",ke),be.addEventListener("sessionend",Te),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===x)return;!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===be.enabled&&!0===be.isPresenting&&(!0===be.cameraAutoUpdate&&be.updateCamera(t),t=be.getCamera()),!0===e.isScene&&e.onBeforeRender(y,e,t,w),f=oe.get(e,v.length),f.init(),v.push(f),H.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),O.setFromProjectionMatrix(H),z=this.localClippingEnabled,F=le.init(this.clippingPlanes,z),m=se.get(e,g.length),m.init(),g.push(m),Pe(e,t,0,y.sortObjects),m.finish(),!0===y.sortObjects&&m.sort(R,I),this.info.render.frame++,!0===F&&le.beginShadows();const n=f.state.shadowsArray;if(ce.render(n,e,t),!0===F&&le.endShadows(),!0===this.info.autoReset&&this.info.reset(),!1!==be.enabled&&!1!==be.isPresenting&&!1!==be.hasDepthSensing()||de.render(m,e),f.setupLights(y._useLegacyLights),t.isArrayCamera){const n=t.cameras;for(let t=0,a=n.length;t<a;t++){const a=n[t];je(m,e,a,a.viewport)}}else je(m,e,t);null!==w&&(Z.updateMultisampleRenderTarget(w),Z.updateRenderTargetMipmap(w)),!0===e.isScene&&e.onAfterRender(y,e,t),fe.resetDefaultState(),S=-1,M=null,v.pop(),f=v.length>0?v[v.length-1]:null,g.pop(),m=g.length>0?g[g.length-1]:null},this.getActiveCubeFace=function(){return b},this.getActiveMipmapLevel=function(){return _},this.getRenderTarget=function(){return w},this.setRenderTargetTextures=function(e,t,n){J.get(e.texture).__webglTexture=t,J.get(e.depthTexture).__webglTexture=n;const a=J.get(e);a.__hasExternalTextures=!0,a.__autoAllocateDepthBuffer=void 0===n,a.__autoAllocateDepthBuffer||!0===X.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),a.__useRenderToTexture=!1)},this.setRenderTargetFramebuffer=function(e,t){const n=J.get(e);n.__webglFramebuffer=t,n.__useDefaultFramebuffer=void 0===t},this.setRenderTarget=function(e,t=0,n=0){w=e,b=t,_=n;let a=!0,r=null,i=!1,s=!1;if(e){const o=J.get(e);void 0!==o.__useDefaultFramebuffer?(K.bindFramebuffer(ve.FRAMEBUFFER,null),a=!1):void 0===o.__webglFramebuffer?Z.setupRenderTarget(e):o.__hasExternalTextures&&Z.rebindTextures(e,J.get(e.texture).__webglTexture,J.get(e.depthTexture).__webglTexture);const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(s=!0);const c=J.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(r=Array.isArray(c[t])?c[t][n]:c[t],i=!0):r=q.isWebGL2&&e.samples>0&&!1===Z.useMultisampledRTT(e)?J.get(e).__webglMultisampledFramebuffer:Array.isArray(c)?c[n]:c,C.copy(e.viewport),E.copy(e.scissor),k=e.scissorTest}else C.copy(L).multiplyScalar(A).floor(),E.copy(D).multiplyScalar(A).floor(),k=U;if(K.bindFramebuffer(ve.FRAMEBUFFER,r)&&q.drawBuffers&&a&&K.drawBuffers(e,r),K.viewport(C),K.scissor(E),K.setScissorTest(k),i){const a=J.get(e.texture);ve.framebufferTexture2D(ve.FRAMEBUFFER,ve.COLOR_ATTACHMENT0,ve.TEXTURE_CUBE_MAP_POSITIVE_X+t,a.__webglTexture,n)}else if(s){const a=J.get(e.texture),r=t||0;ve.framebufferTextureLayer(ve.FRAMEBUFFER,ve.COLOR_ATTACHMENT0,a.__webglTexture,n||0,r)}S=-1},this.readRenderTargetPixels=function(e,t,n,a,r,i,s){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=J.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==s&&(o=o[s]),o){K.bindFramebuffer(ve.FRAMEBUFFER,o);try{const s=e.texture,o=s.format,l=s.type;if(o!==ay&&me.convert(o)!==ve.getParameter(ve.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const c=l===ty&&(X.has("EXT_color_buffer_half_float")||q.isWebGL2&&X.has("EXT_color_buffer_float"));if(!(l===Yv||me.convert(l)===ve.getParameter(ve.IMPLEMENTATION_COLOR_READ_TYPE)||l===ey&&(q.isWebGL2||X.has("OES_texture_float")||X.has("WEBGL_color_buffer_float"))||c))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-a&&n>=0&&n<=e.height-r&&ve.readPixels(t,n,a,r,me.convert(o),me.convert(l),i)}finally{const e=null!==w?J.get(w).__webglFramebuffer:null;K.bindFramebuffer(ve.FRAMEBUFFER,e)}}},this.copyFramebufferToTexture=function(e,t,n=0){const a=Math.pow(2,-n),r=Math.floor(t.image.width*a),i=Math.floor(t.image.height*a);Z.setTexture2D(t,0),ve.copyTexSubImage2D(ve.TEXTURE_2D,n,0,0,e.x,e.y,r,i),K.unbindTexture()},this.copyTextureToTexture=function(e,t,n,a=0){const r=t.image.width,i=t.image.height,s=me.convert(n.format),o=me.convert(n.type);Z.setTexture2D(n,0),ve.pixelStorei(ve.UNPACK_FLIP_Y_WEBGL,n.flipY),ve.pixelStorei(ve.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),ve.pixelStorei(ve.UNPACK_ALIGNMENT,n.unpackAlignment),t.isDataTexture?ve.texSubImage2D(ve.TEXTURE_2D,a,e.x,e.y,r,i,s,o,t.image.data):t.isCompressedTexture?ve.compressedTexSubImage2D(ve.TEXTURE_2D,a,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,s,t.mipmaps[0].data):ve.texSubImage2D(ve.TEXTURE_2D,a,e.x,e.y,s,o,t.image),0===a&&n.generateMipmaps&&ve.generateMipmap(ve.TEXTURE_2D),K.unbindTexture()},this.copyTextureToTexture3D=function(e,t,n,a,r=0){if(y.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const i=Math.round(e.max.x-e.min.x),s=Math.round(e.max.y-e.min.y),o=e.max.z-e.min.z+1,l=me.convert(a.format),c=me.convert(a.type);let d;if(a.isData3DTexture)Z.setTexture3D(a,0),d=ve.TEXTURE_3D;else{if(!a.isDataArrayTexture&&!a.isCompressedArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");Z.setTexture2DArray(a,0),d=ve.TEXTURE_2D_ARRAY}ve.pixelStorei(ve.UNPACK_FLIP_Y_WEBGL,a.flipY),ve.pixelStorei(ve.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),ve.pixelStorei(ve.UNPACK_ALIGNMENT,a.unpackAlignment);const u=ve.getParameter(ve.UNPACK_ROW_LENGTH),h=ve.getParameter(ve.UNPACK_IMAGE_HEIGHT),p=ve.getParameter(ve.UNPACK_SKIP_PIXELS),m=ve.getParameter(ve.UNPACK_SKIP_ROWS),f=ve.getParameter(ve.UNPACK_SKIP_IMAGES),g=n.isCompressedTexture?n.mipmaps[r]:n.image;ve.pixelStorei(ve.UNPACK_ROW_LENGTH,g.width),ve.pixelStorei(ve.UNPACK_IMAGE_HEIGHT,g.height),ve.pixelStorei(ve.UNPACK_SKIP_PIXELS,e.min.x),ve.pixelStorei(ve.UNPACK_SKIP_ROWS,e.min.y),ve.pixelStorei(ve.UNPACK_SKIP_IMAGES,e.min.z),n.isDataTexture||n.isData3DTexture?ve.texSubImage3D(d,r,t.x,t.y,t.z,i,s,o,l,c,g.data):a.isCompressedArrayTexture?ve.compressedTexSubImage3D(d,r,t.x,t.y,t.z,i,s,o,l,g.data):ve.texSubImage3D(d,r,t.x,t.y,t.z,i,s,o,l,c,g),ve.pixelStorei(ve.UNPACK_ROW_LENGTH,u),ve.pixelStorei(ve.UNPACK_IMAGE_HEIGHT,h),ve.pixelStorei(ve.UNPACK_SKIP_PIXELS,p),ve.pixelStorei(ve.UNPACK_SKIP_ROWS,m),ve.pixelStorei(ve.UNPACK_SKIP_IMAGES,f),0===r&&a.generateMipmaps&&ve.generateMipmap(d),K.unbindTexture()},this.initTexture=function(e){e.isCubeTexture?Z.setTextureCube(e,0):e.isData3DTexture?Z.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?Z.setTexture2DArray(e,0):Z.setTexture2D(e,0),K.unbindTexture()},this.resetState=function(){b=0,_=0,w=null,K.reset(),fe.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return jy}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=e===my?"display-p3":"srgb",t.unpackColorSpace=nx.workingColorSpace===fy?"display-p3":"srgb"}get useLegacyLights(){return console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights}set useLegacyLights(e){console.warn("THREE.WebGLRenderer: The property .useLegacyLights has been deprecated. Migrate your lighting according to the following guide: https://discourse.threejs.org/t/updates-to-lighting-in-three-js-r155/53733."),this._useLegacyLights=e}}(class extends PM{}).prototype.isWebGL1Renderer=!0;class jM extends _b{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new rb,this.environmentRotation=new rb,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class AM extends zb{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Ub(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const RM=new yx,IM=new yx,LM=new qx,DM=new Xx,UM=new Fx;class OM extends _b{constructor(e=new t_,t=new AM){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[0];for(let e=1,a=t.count;e<a;e++)RM.fromBufferAttribute(t,e-1),IM.fromBufferAttribute(t,e),n[e]=n[e-1],n[e]+=RM.distanceTo(IM);e.setAttribute("lineDistance",new Xb(n,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const n=this.geometry,a=this.matrixWorld,r=e.params.Line.threshold,i=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),UM.copy(n.boundingSphere),UM.applyMatrix4(a),UM.radius+=r,!1===e.ray.intersectsSphere(UM))return;LM.copy(a).invert(),DM.copy(e.ray).applyMatrix4(LM);const s=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=s*s,l=new yx,c=new yx,d=new yx,u=new yx,h=this.isLineSegments?2:1,p=n.index,m=n.attributes.position;if(null!==p){for(let n=Math.max(0,i.start),a=Math.min(p.count,i.start+i.count)-1;n<a;n+=h){const a=p.getX(n),r=p.getX(n+1);l.fromBufferAttribute(m,a),c.fromBufferAttribute(m,r);if(DM.distanceSqToSegment(l,c,u,d)>o)continue;u.applyMatrix4(this.matrixWorld);const i=e.ray.origin.distanceTo(u);i<e.near||i>e.far||t.push({distance:i,point:d.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}else{for(let n=Math.max(0,i.start),a=Math.min(m.count,i.start+i.count)-1;n<a;n+=h){l.fromBufferAttribute(m,n),c.fromBufferAttribute(m,n+1);if(DM.distanceSqToSegment(l,c,u,d)>o)continue;u.applyMatrix4(this.matrixWorld);const a=e.ray.origin.distanceTo(u);a<e.near||a>e.far||t.push({distance:a,point:d.clone().applyMatrix4(this.matrixWorld),index:n,face:null,faceIndex:null,object:this})}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}const FM=new yx,zM=new yx;class BM extends OM{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[];for(let e=0,a=t.count;e<a;e+=2)FM.fromBufferAttribute(t,e),zM.fromBufferAttribute(t,e+1),n[e]=0===e?0:n[e-1],n[e+1]=n[e]+FM.distanceTo(zM);e.setAttribute("lineDistance",new Xb(n,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class HM extends t_{constructor(e=.5,t=1,n=32,a=1,r=0,i=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:n,phiSegments:a,thetaStart:r,thetaLength:i},n=Math.max(3,n);const s=[],o=[],l=[],c=[];let d=e;const u=(t-e)/(a=Math.max(1,a)),h=new yx,p=new Wy;for(let m=0;m<=a;m++){for(let e=0;e<=n;e++){const a=r+e/n*i;h.x=d*Math.cos(a),h.y=d*Math.sin(a),o.push(h.x,h.y,h.z),l.push(0,0,1),p.x=(h.x/t+1)/2,p.y=(h.y/t+1)/2,c.push(p.x,p.y)}d+=u}for(let m=0;m<a;m++){const e=m*(n+1);for(let t=0;t<n;t++){const a=t+e,r=a,i=a+n+1,o=a+n+2,l=a+1;s.push(r,i,l),s.push(i,o,l)}}this.setIndex(s),this.setAttribute("position",new Xb(o,3)),this.setAttribute("normal",new Xb(l,3)),this.setAttribute("uv",new Xb(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new HM(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength)}}class $M extends t_{constructor(e=1,t=32,n=16,a=0,r=2*Math.PI,i=0,s=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:a,phiLength:r,thetaStart:i,thetaLength:s},t=Math.max(3,Math.floor(t)),n=Math.max(2,Math.floor(n));const o=Math.min(i+s,Math.PI);let l=0;const c=[],d=new yx,u=new yx,h=[],p=[],m=[],f=[];for(let g=0;g<=n;g++){const h=[],v=g/n;let y=0;0===g&&0===i?y=.5/t:g===n&&o===Math.PI&&(y=-.5/t);for(let n=0;n<=t;n++){const o=n/t;d.x=-e*Math.cos(a+o*r)*Math.sin(i+v*s),d.y=e*Math.cos(i+v*s),d.z=e*Math.sin(a+o*r)*Math.sin(i+v*s),p.push(d.x,d.y,d.z),u.copy(d).normalize(),m.push(u.x,u.y,u.z),f.push(o+y,1-v),h.push(l++)}c.push(h)}for(let g=0;g<n;g++)for(let e=0;e<t;e++){const t=c[g][e+1],a=c[g][e],r=c[g+1][e],s=c[g+1][e+1];(0!==g||i>0)&&h.push(t,a,s),(g!==n-1||o<Math.PI)&&h.push(a,r,s)}this.setIndex(h),this.setAttribute("position",new Xb(p,3)),this.setAttribute("normal",new Xb(m,3)),this.setAttribute("uv",new Xb(f,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new $M(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class VM extends zb{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new Ub(16777215),this.specular=new Ub(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ub(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Wy(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new rb,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class WM extends _b{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new Ub(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}const GM=new qx,XM=new yx,qM=new yx;class KM{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Wy(512,512),this.map=null,this.mapPass=null,this.matrix=new qx,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new H_,this._frameExtents=new Wy(1,1),this._viewportCount=1,this._viewports=[new hx(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;XM.setFromMatrixPosition(e.matrixWorld),t.position.copy(XM),qM.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(qM),t.updateMatrixWorld(),GM.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(GM),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(GM)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class YM extends KM{constructor(){super(new rw(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class JM extends WM{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(_b.DEFAULT_UP),this.updateMatrix(),this.target=new _b,this.shadow=new YM}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class ZM extends WM{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}const QM=new qx;class eC{constructor(e,t,n=0,a=1/0){this.ray=new Xx(e,t),this.near=n,this.far=a,this.camera=null,this.layers=new ib,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}setFromXRController(e){return QM.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(QM),this}intersectObject(e,t=!0,n=[]){return nC(e,this,n,t),n.sort(tC),n}intersectObjects(e,t=!0,n=[]){for(let a=0,r=e.length;a<r;a++)nC(e[a],this,n,t);return n.sort(tC),n}}function tC(e,t){return e.distance-t.distance}function nC(e,t,n,a){if(e.layers.test(t.layers)&&e.raycast(t,n),!0===a){const a=e.children;for(let e=0,r=a.length;e<r;e++)nC(a[e],t,n,!0)}}class aC{constructor(e=1,t=0,n=0){return this.radius=e,this.phi=t,this.theta=n,this}set(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Math.max(e,Math.min(Math.PI-e,this.phi)),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,n){return this.radius=Math.sqrt(e*e+t*t+n*n),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,n),this.phi=Math.acos(Oy(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class rC extends BM{constructor(e=10,t=10,n=4473924,a=8947848){n=new Ub(n),a=new Ub(a);const r=t/2,i=e/t,s=e/2,o=[],l=[];for(let d=0,u=0,h=-s;d<=t;d++,h+=i){o.push(-s,0,h,s,0,h),o.push(h,0,-s,h,0,s);const e=d===r?n:a;e.toArray(l,u),u+=3,e.toArray(l,u),u+=3,e.toArray(l,u),u+=3,e.toArray(l,u),u+=3}const c=new t_;c.setAttribute("position",new Xb(o,3)),c.setAttribute("color",new Xb(l,3));super(c,new AM({vertexColors:!0,toneMapped:!1})),this.type="GridHelper"}dispose(){this.geometry.dispose(),this.material.dispose()}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:cv}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=cv);const iC={type:"change"},sC={type:"start"},oC={type:"end"},lC=new Xx,cC=new F_,dC=Math.cos(70*Vy);class uC extends Ry{constructor(e,t){super(),this.object=e,this.domElement=t,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new yx,this.cursor=new yx,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:dv,MIDDLE:uv,RIGHT:hv},this.touches={ONE:pv,TWO:fv},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return s.phi},this.getAzimuthalAngle=function(){return s.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(e){e.addEventListener("keydown",K),this._domElementKeyEvents=e},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",K),this._domElementKeyEvents=null},this.saveState=function(){n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=function(){n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(iC),n.update(),r=a.NONE},this.update=function(){const t=new yx,d=(new vx).setFromUnitVectors(e.up,new yx(0,1,0)),u=d.clone().invert(),h=new yx,p=new vx,m=new yx,f=2*Math.PI;return function(g=null){const v=n.object.position;t.copy(v).sub(n.target),t.applyQuaternion(d),s.setFromVector3(t),n.autoRotate&&r===a.NONE&&E(function(e){return null!==e?2*Math.PI/60*n.autoRotateSpeed*e:2*Math.PI/60/60*n.autoRotateSpeed}(g)),n.enableDamping?(s.theta+=o.theta*n.dampingFactor,s.phi+=o.phi*n.dampingFactor):(s.theta+=o.theta,s.phi+=o.phi);let y=n.minAzimuthAngle,w=n.maxAzimuthAngle;isFinite(y)&&isFinite(w)&&(y<-Math.PI?y+=f:y>Math.PI&&(y-=f),w<-Math.PI?w+=f:w>Math.PI&&(w-=f),s.theta=y<=w?Math.max(y,Math.min(w,s.theta)):s.theta>(y+w)/2?Math.max(y,s.theta):Math.min(w,s.theta)),s.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,s.phi)),s.makeSafe(),!0===n.enableDamping?n.target.addScaledVector(c,n.dampingFactor):n.target.add(c),n.target.sub(n.cursor),n.target.clampLength(n.minTargetRadius,n.maxTargetRadius),n.target.add(n.cursor);let S=!1;if(n.zoomToCursor&&_||n.object.isOrthographicCamera)s.radius=I(s.radius);else{const e=s.radius;s.radius=I(s.radius*l),S=e!=s.radius}if(t.setFromSpherical(s),t.applyQuaternion(u),v.copy(n.target).add(t),n.object.lookAt(n.target),!0===n.enableDamping?(o.theta*=1-n.dampingFactor,o.phi*=1-n.dampingFactor,c.multiplyScalar(1-n.dampingFactor)):(o.set(0,0,0),c.set(0,0,0)),n.zoomToCursor&&_){let a=null;if(n.object.isPerspectiveCamera){const e=t.length();a=I(e*l);const r=e-a;n.object.position.addScaledVector(x,r),n.object.updateMatrixWorld(),S=!!r}else if(n.object.isOrthographicCamera){const e=new yx(b.x,b.y,0);e.unproject(n.object);const r=n.object.zoom;n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/l)),n.object.updateProjectionMatrix(),S=r!==n.object.zoom;const i=new yx(b.x,b.y,0);i.unproject(n.object),n.object.position.sub(i).add(e),n.object.updateMatrixWorld(),a=t.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),n.zoomToCursor=!1;null!==a&&(this.screenSpacePanning?n.target.set(0,0,-1).transformDirection(n.object.matrix).multiplyScalar(a).add(n.object.position):(lC.origin.copy(n.object.position),lC.direction.set(0,0,-1).transformDirection(n.object.matrix),Math.abs(n.object.up.dot(lC.direction))<dC?e.lookAt(n.target):(cC.setFromNormalAndCoplanarPoint(n.object.up,n.target),lC.intersectPlane(cC,n.target))))}else if(n.object.isOrthographicCamera){const e=n.object.zoom;n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/l)),e!==n.object.zoom&&(n.object.updateProjectionMatrix(),S=!0)}return l=1,_=!1,!!(S||h.distanceToSquared(n.object.position)>i||8*(1-p.dot(n.object.quaternion))>i||m.distanceToSquared(n.target)>i)&&(n.dispatchEvent(iC),h.copy(n.object.position),p.copy(n.object.quaternion),m.copy(n.target),!0)}}(),this.dispose=function(){n.domElement.removeEventListener("contextmenu",J),n.domElement.removeEventListener("pointerdown",$),n.domElement.removeEventListener("pointercancel",W),n.domElement.removeEventListener("wheel",G),n.domElement.removeEventListener("pointermove",V),n.domElement.removeEventListener("pointerup",W);n.domElement.getRootNode().removeEventListener("keydown",X,{capture:!0}),null!==n._domElementKeyEvents&&(n._domElementKeyEvents.removeEventListener("keydown",K),n._domElementKeyEvents=null)};const n=this,a={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let r=a.NONE;const i=1e-6,s=new aC,o=new aC;let l=1;const c=new yx,d=new Wy,u=new Wy,h=new Wy,p=new Wy,m=new Wy,f=new Wy,g=new Wy,v=new Wy,y=new Wy,x=new yx,b=new Wy;let _=!1;const w=[],S={};let M=!1;function C(e){const t=Math.abs(.01*e);return Math.pow(.95,n.zoomSpeed*t)}function E(e){o.theta-=e}function k(e){o.phi-=e}const T=function(){const e=new yx;return function(t,n){e.setFromMatrixColumn(n,0),e.multiplyScalar(-t),c.add(e)}}(),N=function(){const e=new yx;return function(t,a){!0===n.screenSpacePanning?e.setFromMatrixColumn(a,1):(e.setFromMatrixColumn(a,0),e.crossVectors(n.object.up,e)),e.multiplyScalar(t),c.add(e)}}(),P=function(){const e=new yx;return function(t,a){const r=n.domElement;if(n.object.isPerspectiveCamera){const i=n.object.position;e.copy(i).sub(n.target);let s=e.length();s*=Math.tan(n.object.fov/2*Math.PI/180),T(2*t*s/r.clientHeight,n.object.matrix),N(2*a*s/r.clientHeight,n.object.matrix)}else n.object.isOrthographicCamera?(T(t*(n.object.right-n.object.left)/n.object.zoom/r.clientWidth,n.object.matrix),N(a*(n.object.top-n.object.bottom)/n.object.zoom/r.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}}();function j(e){n.object.isPerspectiveCamera||n.object.isOrthographicCamera?l/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function A(e){n.object.isPerspectiveCamera||n.object.isOrthographicCamera?l*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function R(e,t){if(!n.zoomToCursor)return;_=!0;const a=n.domElement.getBoundingClientRect(),r=e-a.left,i=t-a.top,s=a.width,o=a.height;b.x=r/s*2-1,b.y=-i/o*2+1,x.set(b.x,b.y,1).unproject(n.object).sub(n.object.position).normalize()}function I(e){return Math.max(n.minDistance,Math.min(n.maxDistance,e))}function L(e){d.set(e.clientX,e.clientY)}function D(e){p.set(e.clientX,e.clientY)}function U(e){if(1===w.length)d.set(e.pageX,e.pageY);else{const t=Q(e),n=.5*(e.pageX+t.x),a=.5*(e.pageY+t.y);d.set(n,a)}}function O(e){if(1===w.length)p.set(e.pageX,e.pageY);else{const t=Q(e),n=.5*(e.pageX+t.x),a=.5*(e.pageY+t.y);p.set(n,a)}}function F(e){const t=Q(e),n=e.pageX-t.x,a=e.pageY-t.y,r=Math.sqrt(n*n+a*a);g.set(0,r)}function z(e){if(1==w.length)u.set(e.pageX,e.pageY);else{const t=Q(e),n=.5*(e.pageX+t.x),a=.5*(e.pageY+t.y);u.set(n,a)}h.subVectors(u,d).multiplyScalar(n.rotateSpeed);const t=n.domElement;E(2*Math.PI*h.x/t.clientHeight),k(2*Math.PI*h.y/t.clientHeight),d.copy(u)}function B(e){if(1===w.length)m.set(e.pageX,e.pageY);else{const t=Q(e),n=.5*(e.pageX+t.x),a=.5*(e.pageY+t.y);m.set(n,a)}f.subVectors(m,p).multiplyScalar(n.panSpeed),P(f.x,f.y),p.copy(m)}function H(e){const t=Q(e),a=e.pageX-t.x,r=e.pageY-t.y,i=Math.sqrt(a*a+r*r);v.set(0,i),y.set(0,Math.pow(v.y/g.y,n.zoomSpeed)),j(y.y),g.copy(v);R(.5*(e.pageX+t.x),.5*(e.pageY+t.y))}function $(e){!1!==n.enabled&&(0===w.length&&(n.domElement.setPointerCapture(e.pointerId),n.domElement.addEventListener("pointermove",V),n.domElement.addEventListener("pointerup",W)),function(e){for(let t=0;t<w.length;t++)if(w[t]==e.pointerId)return!0;return!1}(e)||(function(e){w.push(e.pointerId)}(e),"touch"===e.pointerType?Y(e):function(e){let t;switch(e.button){case 0:t=n.mouseButtons.LEFT;break;case 1:t=n.mouseButtons.MIDDLE;break;case 2:t=n.mouseButtons.RIGHT;break;default:t=-1}switch(t){case uv:if(!1===n.enableZoom)return;!function(e){R(e.clientX,e.clientX),g.set(e.clientX,e.clientY)}(e),r=a.DOLLY;break;case dv:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enablePan)return;D(e),r=a.PAN}else{if(!1===n.enableRotate)return;L(e),r=a.ROTATE}break;case hv:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enableRotate)return;L(e),r=a.ROTATE}else{if(!1===n.enablePan)return;D(e),r=a.PAN}break;default:r=a.NONE}r!==a.NONE&&n.dispatchEvent(sC)}(e)))}function V(e){!1!==n.enabled&&("touch"===e.pointerType?function(e){switch(Z(e),r){case a.TOUCH_ROTATE:if(!1===n.enableRotate)return;z(e),n.update();break;case a.TOUCH_PAN:if(!1===n.enablePan)return;B(e),n.update();break;case a.TOUCH_DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&H(e),n.enablePan&&B(e)}(e),n.update();break;case a.TOUCH_DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&H(e),n.enableRotate&&z(e)}(e),n.update();break;default:r=a.NONE}}(e):function(e){switch(r){case a.ROTATE:if(!1===n.enableRotate)return;!function(e){u.set(e.clientX,e.clientY),h.subVectors(u,d).multiplyScalar(n.rotateSpeed);const t=n.domElement;E(2*Math.PI*h.x/t.clientHeight),k(2*Math.PI*h.y/t.clientHeight),d.copy(u),n.update()}(e);break;case a.DOLLY:if(!1===n.enableZoom)return;!function(e){v.set(e.clientX,e.clientY),y.subVectors(v,g),y.y>0?j(C(y.y)):y.y<0&&A(C(y.y)),g.copy(v),n.update()}(e);break;case a.PAN:if(!1===n.enablePan)return;!function(e){m.set(e.clientX,e.clientY),f.subVectors(m,p).multiplyScalar(n.panSpeed),P(f.x,f.y),p.copy(m),n.update()}(e)}}(e))}function W(e){switch(function(e){delete S[e.pointerId];for(let t=0;t<w.length;t++)if(w[t]==e.pointerId)return void w.splice(t,1)}(e),w.length){case 0:n.domElement.releasePointerCapture(e.pointerId),n.domElement.removeEventListener("pointermove",V),n.domElement.removeEventListener("pointerup",W),n.dispatchEvent(oC),r=a.NONE;break;case 1:const t=w[0],i=S[t];Y({pointerId:t,pageX:i.x,pageY:i.y})}}function G(e){!1!==n.enabled&&!1!==n.enableZoom&&r===a.NONE&&(e.preventDefault(),n.dispatchEvent(sC),function(e){R(e.clientX,e.clientY),e.deltaY<0?A(C(e.deltaY)):e.deltaY>0&&j(C(e.deltaY)),n.update()}(function(e){const t=e.deltaMode,n={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:n.deltaY*=16;break;case 2:n.deltaY*=100}e.ctrlKey&&!M&&(n.deltaY*=10);return n}(e)),n.dispatchEvent(oC))}function X(e){if("Control"===e.key){M=!0;n.domElement.getRootNode().addEventListener("keyup",q,{passive:!0,capture:!0})}}function q(e){if("Control"===e.key){M=!1;n.domElement.getRootNode().removeEventListener("keyup",q,{passive:!0,capture:!0})}}function K(e){!1!==n.enabled&&!1!==n.enablePan&&function(e){let t=!1;switch(e.code){case n.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?k(2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(0,n.keyPanSpeed),t=!0;break;case n.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?k(-2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(0,-n.keyPanSpeed),t=!0;break;case n.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?E(2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(n.keyPanSpeed,0),t=!0;break;case n.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?E(-2*Math.PI*n.rotateSpeed/n.domElement.clientHeight):P(-n.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),n.update())}(e)}function Y(e){switch(Z(e),w.length){case 1:switch(n.touches.ONE){case pv:if(!1===n.enableRotate)return;U(e),r=a.TOUCH_ROTATE;break;case mv:if(!1===n.enablePan)return;O(e),r=a.TOUCH_PAN;break;default:r=a.NONE}break;case 2:switch(n.touches.TWO){case fv:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&F(e),n.enablePan&&O(e)}(e),r=a.TOUCH_DOLLY_PAN;break;case gv:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&F(e),n.enableRotate&&U(e)}(e),r=a.TOUCH_DOLLY_ROTATE;break;default:r=a.NONE}break;default:r=a.NONE}r!==a.NONE&&n.dispatchEvent(sC)}function J(e){!1!==n.enabled&&e.preventDefault()}function Z(e){let t=S[e.pointerId];void 0===t&&(t=new Wy,S[e.pointerId]=t),t.set(e.pageX,e.pageY)}function Q(e){const t=e.pointerId===w[0]?w[1]:w[0];return S[t]}n.domElement.addEventListener("contextmenu",J),n.domElement.addEventListener("pointerdown",$),n.domElement.addEventListener("pointercancel",W),n.domElement.addEventListener("wheel",G,{passive:!1});n.domElement.getRootNode().addEventListener("keydown",X,{passive:!0,capture:!0}),this.update()}}function hC({isOpen:e,onClose:t,onSelect:n,currentAngle:a}){const r=Tt.useRef(null),i=Tt.useRef(null),s=Tt.useRef(null),o=Tt.useRef(null),l=Tt.useRef(null),c=Tt.useRef(null),d=Tt.useRef(new Map),u=Tt.useRef(new eC),h=Tt.useRef(new Wy),p=Tt.useRef(0),m=Tt.useRef(!1),[f,g]=Tt.useState(a),[v,y]=Tt.useState(null),[x,b]=Tt.useState({directions:tv.map(()=>!0),heights:nv.map(()=>!0),sizes:av.map(()=>!0)});Tt.useEffect(()=>{if(!e||!r.current||m.current)return;const t=r.current,n=i.current;if(!n)return;console.log("Initializing Three.js scene...");const a=new jM;a.background=new Ub(1710618),s.current=a;const u=new j_(45,n.clientWidth/n.clientHeight,.1,1e3);u.position.set(0,3,6),o.current=u;const h=new PM({canvas:t,antialias:!0,alpha:!0});h.setSize(n.clientWidth,n.clientHeight),h.setPixelRatio(Math.min(window.devicePixelRatio,2)),l.current=h;const f=new uC(u,h.domElement);f.enableDamping=!0,f.dampingFactor=.05,f.minDistance=3,f.maxDistance=10,f.target.set(0,1.5,0),f.enablePan=!1,c.current=f;const g=new ZM(16777215,.6);a.add(g);const v=new JM(16777215,.8);v.position.set(5,10,7),a.add(v);const y=new rC(10,10,4473924,2236962);y.position.y=0,a.add(y);const x=new $M(.15,16,16),b=new Bb({color:16777215}),_=new x_(x,b);_.position.set(0,1,0),a.add(_);[.3,1,1.7,2.4].forEach(e=>{const t=new HM(3.5,3.6,64),n=new Bb({color:4473924,side:2,transparent:!0,opacity:.3}),r=new x_(t,n);r.rotation.x=-Math.PI/2,r.position.y=e,a.add(r)}),console.log("Creating markers for",sv.length,"angles"),sv.forEach(e=>{const[t,n,r]=function(e){const t=tv.indexOf(e.direction),n=nv.indexOf(e.height),a=av.indexOf(e.size),r=t/tv.length*Math.PI*2,i=[2,2.5,3][a],s=[.3,1,1.7,2.4][n];return[Math.sin(r)*i,s,Math.cos(r)*i]}(e),i=function(e){const t=tv.indexOf(e);if(0===t)return 65280;if(4===t)return 16711680;const n=t/tv.length;return Math.floor(255*n)<<16|Math.floor(255*(1-n))<<8}(e.direction),s=new $M(.1,16,16),o=new VM({color:i,emissive:i,emissiveIntensity:.3}),l=new x_(s,o);l.position.set(t,n,r),l.userData={angle:e},a.add(l),d.current.set(e.id,l)}),console.log("Created",d.current.size,"markers");const w=()=>{n&&u&&h&&(u.aspect=n.clientWidth/n.clientHeight,u.updateProjectionMatrix(),h.setSize(n.clientWidth,n.clientHeight))};window.addEventListener("resize",w),m.current=!0;const S=()=>{p.current=requestAnimationFrame(S),f.update(),h.render(a,u)};return S(),console.log("Three.js scene initialized successfully"),()=>{console.log("Cleaning up Three.js scene..."),window.removeEventListener("resize",w),cancelAnimationFrame(p.current),f.dispose(),h.dispose(),d.current.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),d.current.clear(),m.current=!1,s.current=null,o.current=null,l.current=null,c.current=null}},[e]),Tt.useEffect(()=>{m.current&&sv.forEach(e=>{const t=d.current.get(e.id);if(t){const n=x.directions[tv.indexOf(e.direction)],a=x.heights[nv.indexOf(e.height)],r=x.sizes[av.indexOf(e.size)];t.visible=n&&a&&r}})},[x]),Tt.useEffect(()=>{if(m.current&&(d.current.forEach(e=>{e.material.emissiveIntensity=.3,e.scale.set(1,1,1)}),f)){const e=d.current.get(f.id);if(e){e.material.emissiveIntensity=1,e.scale.set(1.5,1.5,1.5)}}},[f]);const _=Tt.useCallback(e=>{if(!(r.current&&o.current&&s.current&&m.current))return void console.log("Canvas click ignored - not initialized");const t=r.current.getBoundingClientRect();h.current.x=(e.clientX-t.left)/t.width*2-1,h.current.y=-(e.clientY-t.top)/t.height*2+1,console.log("Click at:",h.current.x,h.current.y),u.current.setFromCamera(h.current,o.current);const n=[];d.current.forEach(e=>{e.visible&&n.push(e)}),console.log("Checking",n.length,"visible markers");const a=u.current.intersectObjects(n);if(console.log("Intersections:",a.length),a.length>0){const e=a[0].object.userData.angle;console.log("Selected angle:",e.displayName),g(e)}},[]),w=Tt.useCallback(e=>{if(!(r.current&&o.current&&s.current&&m.current))return;const t=r.current.getBoundingClientRect();h.current.x=(e.clientX-t.left)/t.width*2-1,h.current.y=-(e.clientY-t.top)/t.height*2+1,u.current.setFromCamera(h.current,o.current);const n=[];d.current.forEach(e=>{e.visible&&n.push(e)});const a=u.current.intersectObjects(n);if(a.length>0){const e=a[0].object.userData.angle;y(e),r.current.style.cursor="pointer"}else y(null),r.current.style.cursor="default"},[]),S=Tt.useCallback((e,t,n)=>{b(a=>({...a,[e]:a[e].map((e,a)=>a===t?n:e)}))},[]),M=Tt.useCallback((e,t)=>{b(n=>({...n,[e]:n[e].map(()=>t)}))},[]),C=Tt.useCallback(()=>{f&&n(f),t()},[f,n,t]);return Tt.useEffect(()=>{e&&g(a)},[e,a]),e?Ut.jsx("div",{className:"camera-angle-overlay",onClick:t,children:Ut.jsxs("div",{className:"camera-angle-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("header",{className:"camera-angle-header",children:[Ut.jsx("h2",{children:"Select Camera Angle"}),Ut.jsx("button",{className:"camera-angle-close",onClick:t,children:""})]}),Ut.jsxs("div",{className:"camera-angle-content",children:[Ut.jsxs("aside",{className:"camera-angle-filters",children:[Ut.jsxs("div",{className:"filter-group",children:[Ut.jsxs("div",{className:"filter-group-header",children:[Ut.jsx("label",{children:"View Direction"}),Ut.jsx("button",{className:"filter-toggle-all",onClick:()=>M("directions",!x.directions.every(Boolean)),children:x.directions.every(Boolean)?"None":"All"})]}),Ut.jsx("div",{className:"filter-checkboxes",children:tv.map((e,t)=>Ut.jsxs("label",{className:"filter-checkbox",children:[Ut.jsx("input",{type:"checkbox",checked:x.directions[t],onChange:e=>S("directions",t,e.target.checked)}),Ut.jsx("span",{className:"checkbox-label",children:e.charAt(0).toUpperCase()+e.slice(1)})]},e))})]}),Ut.jsxs("div",{className:"filter-group",children:[Ut.jsxs("div",{className:"filter-group-header",children:[Ut.jsx("label",{children:"Height"}),Ut.jsx("button",{className:"filter-toggle-all",onClick:()=>M("heights",!x.heights.every(Boolean)),children:x.heights.every(Boolean)?"None":"All"})]}),Ut.jsx("div",{className:"filter-checkboxes",children:nv.map((e,t)=>Ut.jsxs("label",{className:"filter-checkbox",children:[Ut.jsx("input",{type:"checkbox",checked:x.heights[t],onChange:e=>S("heights",t,e.target.checked)}),Ut.jsx("span",{className:"checkbox-label",children:e.charAt(0).toUpperCase()+e.slice(1)})]},e))})]}),Ut.jsxs("div",{className:"filter-group",children:[Ut.jsxs("div",{className:"filter-group-header",children:[Ut.jsx("label",{children:"Shot Size"}),Ut.jsx("button",{className:"filter-toggle-all",onClick:()=>M("sizes",!x.sizes.every(Boolean)),children:x.sizes.every(Boolean)?"None":"All"})]}),Ut.jsx("div",{className:"filter-checkboxes",children:av.map((e,t)=>Ut.jsxs("label",{className:"filter-checkbox",children:[Ut.jsx("input",{type:"checkbox",checked:x.sizes[t],onChange:e=>S("sizes",t,e.target.checked)}),Ut.jsx("span",{className:"checkbox-label",children:e.charAt(0).toUpperCase()+e.slice(1)})]},e))})]})]}),Ut.jsxs("div",{className:"camera-angle-canvas-container",ref:i,children:[Ut.jsx("canvas",{ref:r,onClick:_,onMouseMove:w}),v&&Ut.jsx("div",{className:"camera-angle-tooltip",children:v.displayName})]})]}),Ut.jsxs("footer",{className:"camera-angle-footer",children:[Ut.jsx("div",{className:"camera-angle-selected",children:f?Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("span",{className:"selected-label",children:"Selected:"}),Ut.jsx("span",{className:"selected-value",children:f.displayName}),Ut.jsx("code",{className:"selected-prompt",children:f.prompt})]}):Ut.jsx("span",{className:"selected-empty",children:"No angle selected"})}),Ut.jsxs("div",{className:"camera-angle-actions",children:[Ut.jsx("button",{className:"camera-angle-btn secondary",onClick:t,children:"Cancel"}),Ut.jsx("button",{className:"camera-angle-btn primary",onClick:C,disabled:!f,children:"Apply Angle"})]})]})]})}):null}function pC({parameter:e,value:t,onChange:n,disabled:a}){const[r,i]=Tt.useState(t??e.default);Tt.useEffect(()=>{i(t??e.default)},[t,e.default]);const s=Tt.useCallback(t=>{const a=parseInt(t.target.value);i(a),n(e.name,a)},[e.name,n]),o=Tt.useCallback(t=>{const a=parseInt(t.target.value)||0;i(a),n(e.name,a)},[e.name,n]),l=e.constraints||{};return Ut.jsxs("div",{className:"parameter-widget integer-widget",children:[Ut.jsx("label",{className:"parameter-label",children:e.display_name}),Ut.jsxs("div",{className:"parameter-control",children:[Ut.jsx("input",{type:"range",className:"parameter-slider",min:l.min??0,max:l.max??100,step:l.step??1,value:r,onChange:s,disabled:a}),Ut.jsx("input",{type:"number",className:"parameter-input",min:l.min??0,max:l.max??100,step:l.step??1,value:r,onChange:o,disabled:a})]}),e.description&&Ut.jsx("span",{className:"parameter-description",children:e.description})]})}function mC({parameter:e,value:t,onChange:n,disabled:a}){const[r,i]=Tt.useState(t??e.default);Tt.useEffect(()=>{i(t??e.default)},[t,e.default]);const s=Tt.useCallback(t=>{const a=parseFloat(t.target.value);i(a),n(e.name,a)},[e.name,n]),o=Tt.useCallback(t=>{const a=parseFloat(t.target.value)||0;i(a),n(e.name,a)},[e.name,n]),l=e.constraints||{};return Ut.jsxs("div",{className:"parameter-widget float-widget",children:[Ut.jsx("label",{className:"parameter-label",children:e.display_name}),Ut.jsxs("div",{className:"parameter-control",children:[Ut.jsx("input",{type:"range",className:"parameter-slider",min:l.min??0,max:l.max??1,step:l.step??.01,value:r,onChange:s,disabled:a}),Ut.jsx("input",{type:"number",className:"parameter-input",min:l.min??0,max:l.max??1,step:l.step??.01,value:r,onChange:o,disabled:a})]}),e.description&&Ut.jsx("span",{className:"parameter-description",children:e.description})]})}function fC({parameter:e,value:t,onChange:n,disabled:a}){const[r,i]=Tt.useState(t??e.default);Tt.useEffect(()=>{i(t??e.default)},[t,e.default]);const s=Tt.useCallback(t=>{const a=parseInt(t.target.value)||-1;i(a),n(e.name,a)},[e.name,n]),o=Tt.useCallback(()=>{const t=Math.floor(2147483647*Math.random());i(t),n(e.name,t)},[e.name,n]);return Ut.jsxs("div",{className:"parameter-widget seed-widget",children:[Ut.jsx("label",{className:"parameter-label",children:e.display_name}),Ut.jsxs("div",{className:"parameter-control seed-control",children:[Ut.jsx("input",{type:"number",className:"parameter-input seed-input",value:r,onChange:s,disabled:a}),Ut.jsx("button",{className:"seed-randomize-btn",onClick:o,disabled:a,title:"Randomize seed",children:""})]}),e.description&&Ut.jsx("span",{className:"parameter-description",children:e.description})]})}const gC=[".safetensors",".pt",".pth",".bin",".ckpt",".gguf",".sft"],vC=e=>gC.some(t=>e.toLowerCase().endsWith(t));function yC(e){const t=e.replace(/\\/g,"/"),n=t.lastIndexOf("/"),a=n>0?t.substring(n+1):t,r=a.lastIndexOf(".");return r>0?a.substring(0,r):a}function xC(e,t){if(!e)return t[0]||"";const n=e.replace(/\\/g,"/");return t.find(e=>e.replace(/\\/g,"/")===n)||n}function bC({parameter:e,value:t,onChange:n,disabled:a}){var r;const i=(null==(r=e.constraints)?void 0:r.options)||[],s=i.length>0&&i.every(vC),[o,l]=Tt.useState(()=>s?xC(t??e.default,i):t??e.default);Tt.useEffect(()=>{l(s?xC(t??e.default,i):t??e.default)},[t,e.default,i,s]);const c=Tt.useCallback(t=>{const a=t.target.value;l(a),n(e.name,a)},[e.name,n]),d=Tt.useMemo(()=>s?function(e){const t=new Map;for(const n of e){const e=n.replace(/\\/g,"/"),a=e.lastIndexOf("/"),r=a>0?e.substring(0,a):"(root)";t.has(r)||t.set(r,[]),t.get(r).push(n)}return t}(i):null,[i,s]);return Ut.jsxs("div",{className:"parameter-widget enum-widget",children:[Ut.jsx("label",{className:"parameter-label",children:e.display_name}),Ut.jsx("select",{className:"parameter-select",value:o,onChange:c,disabled:a,children:s&&d?Array.from(d.entries()).map(([e,t])=>Ut.jsx("optgroup",{label:e,children:t.map(e=>Ut.jsx("option",{value:e,children:yC(e)},e))},e)):i.map(e=>Ut.jsx("option",{value:e,children:e},e))}),e.description&&Ut.jsx("span",{className:"parameter-description",children:e.description})]})}function _C({parameter:e,value:t,onChange:n,disabled:a}){const[r,i]=Tt.useState(t??e.default);Tt.useEffect(()=>{i(t??e.default)},[t,e.default]);const s=Tt.useCallback(t=>{const a=t.target.checked;i(a),n(e.name,a)},[e.name,n]);return Ut.jsxs("div",{className:"parameter-widget boolean-widget",children:[Ut.jsxs("label",{className:"parameter-label boolean-label",children:[Ut.jsx("input",{type:"checkbox",className:"parameter-checkbox",checked:r,onChange:s,disabled:a}),Ut.jsx("span",{children:e.display_name})]}),e.description&&Ut.jsx("span",{className:"parameter-description",children:e.description})]})}function wC({parameter:e,value:t,onChange:n,disabled:a,onEnhance:r,cameraAngle:i,onCameraAngleChange:s}){const{cpePromptForStoryboard:o,setCpePromptForStoryboard:l}=Lm(),c="string"==typeof t?t:t?String(t):"",[d,u]=Tt.useState(c??e.default??""),[h,p]=Tt.useState(!1),[m,f]=Tt.useState(!1);Tt.useEffect(()=>{const n="string"==typeof t?t:t?String(t):"";u(n??e.default??"")},[t,e.default]);const g=Tt.useCallback(t=>{const a=t.target.value;u(a),n(e.name,a)},[e.name,n]),v=Tt.useCallback(()=>{o&&(u(o),n(e.name,o),l(null))},[o,e.name,n,l]),y=Tt.useCallback(async()=>{if(r&&d.trim()&&!h){p(!0);try{const t=await r(d);u(t),n(e.name,t)}catch(t){console.error("Failed to enhance prompt:",t)}finally{p(!1)}}},[d,r,h,e.name,n]),x=Tt.useCallback(t=>{const a=lv(d),r=`${t.prompt} ${a}`.trim();u(r),n(e.name,r),null==s||s(t)},[d,e.name,n,s]),b=Tt.useCallback(()=>{const t=lv(d);u(t),n(e.name,t),null==s||s(null)},[d,e.name,n,s]);Tt.useEffect(()=>{const e=ov(d);(null==e?void 0:e.id)!==(null==i?void 0:i.id)&&(null==s||s(e))},[d,null==i?void 0:i.id,s]);const _=e.name.includes("negative"),w=_?"prompt-textarea negative":"prompt-textarea positive",S=r&&!_;return Ut.jsxs("div",{className:"parameter-widget prompt-widget",children:[i&&!_&&Ut.jsxs("div",{className:"camera-angle-badge",children:[Ut.jsx("span",{className:"badge-icon",children:""}),Ut.jsx("span",{className:"badge-text",children:i.displayName}),Ut.jsx("button",{className:"badge-clear",onClick:b,title:"Clear angle",disabled:a,children:""})]}),Ut.jsxs("div",{className:"prompt-header",children:[Ut.jsx("label",{className:"parameter-label",children:e.display_name}),Ut.jsxs("div",{className:"prompt-toolbar",children:[!_&&o&&Ut.jsx("button",{className:"cpe-paste-btn",onClick:v,disabled:a,title:"Paste prompt from Cinema Prompt Engineering",children:""}),!_&&Ut.jsx("button",{className:"angle-selector-btn "+(i?"has-angle":""),onClick:()=>f(!0),disabled:a,title:"Select camera angle",children:""}),S&&Ut.jsx("button",{className:"ai-enhance-btn "+(h?"enhancing":""),onClick:y,disabled:a||h||!d.trim(),title:h?"Enhancing prompt...":"Enhance with AI",children:h?"...":""})]})]}),Ut.jsx("textarea",{className:w,value:d,onChange:g,disabled:a,rows:4,placeholder:`Enter ${_?"negative":"positive"} prompt...`}),e.description&&Ut.jsx("span",{className:"parameter-description",children:e.description}),!_&&Ut.jsx(hC,{isOpen:m,onClose:()=>f(!1),onSelect:x,currentAngle:i??null})]})}function SC({parameter:e,value:t,onChange:n,disabled:a,comfyUrl:r}){const i=Tt.useCallback((t,a)=>{n(e.name,a)},[e.name,n]),s="__BYPASSED__"===t,o=Tt.useCallback(t=>{n(e.name,t?"__BYPASSED__":null)},[e.name,n]);return Ut.jsx(ev,{name:e.name,displayName:e.display_name,value:s?null:t,onChange:i,disabled:a,acceptType:"image",isBypassed:s,onBypassChange:o,comfyUrl:r})}function MC({parameter:e,value:t,onChange:n,disabled:a,comfyUrl:r}){const i=Tt.useCallback((t,a)=>{n(e.name,a)},[e.name,n]),s="__BYPASSED__"===t,o=Tt.useCallback(t=>{n(e.name,t?"__BYPASSED__":null)},[e.name,n]);return Ut.jsx(ev,{name:e.name,displayName:e.display_name,value:s?null:t,onChange:i,disabled:a,acceptType:"video",isBypassed:s,onBypassChange:o,comfyUrl:r})}function CC({parameter:e,value:t,onChange:n,disabled:a,comfyUrl:r}){const i=Tt.useCallback((t,a)=>{n(e.name,a)},[e.name,n]),s="__BYPASSED__"===t,o=Tt.useCallback(t=>{n(e.name,t?"__BYPASSED__":null)},[e.name,n]);return Ut.jsx(ev,{name:e.name,displayName:e.display_name,value:s?null:t,onChange:i,disabled:a,acceptType:"any",isBypassed:s,onBypassChange:o,comfyUrl:r})}function EC({parameter:e,value:t,onChange:n,disabled:a,availableLoras:r=[],onBypassChange:i,isBypassed:s=!1}){var o;const l="object"==typeof t&&null!==t,c=e=>e.replace(/\\/g,"/"),d=e=>{if(!e||0===r.length)return"";const t=c(e);return r.find(e=>c(e)===t)||""},[u,h]=Tt.useState(d(l?t.lora_name:(null==(o=e.constraints)?void 0:o.lora_name)||"")),[p,m]=Tt.useState(l?t.strength:"number"==typeof t?t:e.default??1),[f,g]=Tt.useState(l?t.bypassed??s:s);Tt.useEffect(()=>{"object"==typeof t&&null!==t?(h(d(t.lora_name||"")),m(t.strength??1),g(t.bypassed??!1)):"number"==typeof t&&m(t)},[t,r]),Tt.useEffect(()=>{g(s)},[s]);const v=Tt.useCallback(a=>{const r=a.target.value;h(r),l?n(e.name,{...t,lora_name:r}):n(e.name+"_lora_name",r)},[e.name,n,t,l]),y=Tt.useCallback(a=>{const r=parseFloat(a.target.value);m(r),n(e.name,l?{...t,strength:r}:r)},[e.name,n,t,l]),x=Tt.useCallback(()=>{const a=!f;g(a),i&&i(e.name,a),l&&n(e.name,{...t,bypassed:a})},[f,e.name,n,i,t,l]),b=e.constraints||{},_=e=>{if(!e)return"";return(e.split(/[/\\]/).pop()||e).replace(/\.safetensors$|\.ckpt$/i,"")};return Ut.jsxs("div",{className:"parameter-widget lora-widget "+(f?"bypassed":""),children:[Ut.jsxs("div",{className:"lora-header",children:[Ut.jsx("label",{className:"parameter-label",children:e.display_name}),Ut.jsx("button",{className:"bypass-toggle "+(f?"bypassed":"active"),onClick:x,disabled:a,title:f?"Enable this LoRA":"Bypass this LoRA",children:f?" Bypassed":" Active"})]}),!f&&Ut.jsxs("div",{className:"lora-controls",children:[r.length>0&&Ut.jsx("div",{className:"lora-dropdown-container",children:Ut.jsxs("select",{className:"parameter-select lora-select",value:u,onChange:v,disabled:a,children:[Ut.jsx("option",{value:"",children:"-- Select LoRA --"}),(()=>{const e={},t=[];return r.forEach(n=>{const a=c(n).split("/");if(a.length>1){const t=a.slice(0,-1).join("/");e[t]||(e[t]=[]),e[t].push(n)}else t.push(n)}),Ut.jsxs(Ut.Fragment,{children:[t.map(e=>Ut.jsx("option",{value:e,children:_(e)},e)),Object.keys(e).sort().map(t=>Ut.jsx("optgroup",{label:t,children:e[t].map(e=>Ut.jsx("option",{value:e,children:_(e)},e))},t))]})})()]})}),Ut.jsxs("div",{className:"lora-strength-container",children:[Ut.jsx("label",{className:"strength-label",children:"Strength"}),Ut.jsxs("div",{className:"parameter-control",children:[Ut.jsx("input",{type:"range",className:"parameter-slider",min:b.min??-2,max:b.max??2,step:b.step??.01,value:p,onChange:y,disabled:a}),Ut.jsx("input",{type:"number",className:"parameter-input",min:b.min??-2,max:b.max??2,step:b.step??.01,value:p,onChange:y,disabled:a})]})]})]}),f&&Ut.jsxs("div",{className:"lora-bypassed-placeholder",children:[Ut.jsx("span",{className:"bypassed-icon",children:""}),Ut.jsx("span",{className:"bypassed-text",children:"LoRA bypassed - will not be applied"})]}),e.description&&Ut.jsx("span",{className:"parameter-description",children:e.description})]})}function kC({parameter:e,value:t,onChange:n,disabled:a,onEnhancePrompt:r,cameraAngle:i,onCameraAngleChange:s,comfyUrl:o}){var l,c;switch(e.type){case"integer":return Ut.jsx(pC,{parameter:e,value:t,onChange:n,disabled:a});case"float":return Ut.jsx(mC,{parameter:e,value:t,onChange:n,disabled:a});case"seed":return Ut.jsx(fC,{parameter:e,value:t,onChange:n,disabled:a});case"enum":return Ut.jsx(bC,{parameter:e,value:t,onChange:n,disabled:a});case"boolean":return Ut.jsx(_C,{parameter:e,value:t,onChange:n,disabled:a});case"prompt":return Ut.jsx(wC,{parameter:e,value:t,onChange:n,disabled:a,onEnhance:r,cameraAngle:i,onCameraAngleChange:t=>null==s?void 0:s(e.name,t)});case"image":case"image_list":return Ut.jsx(SC,{parameter:e,value:t,onChange:n,disabled:a,comfyUrl:o});case"video":case"video_list":return Ut.jsx(MC,{parameter:e,value:t,onChange:n,disabled:a,comfyUrl:o});case"media":return Ut.jsx(CC,{parameter:e,value:t,onChange:n,disabled:a,comfyUrl:o});case"lora":return Ut.jsx(EC,{parameter:e,value:t,onChange:n,disabled:a,availableLoras:(null==(l=e.constraints)?void 0:l.availableLoras)||[],isBypassed:(null==(c=e.constraints)?void 0:c.bypassed)||!1});default:return Ut.jsx(wC,{parameter:e,value:t,onChange:n,disabled:a,onEnhance:r})}}function TC({parameters:e,values:t,onChange:n,disabled:a,onEnhancePrompt:r,cameraAngles:i,onCameraAngleChange:s,comfyUrl:o}){return 0===e.length?Ut.jsx("div",{className:"parameter-panel empty",children:Ut.jsx("p",{children:"No parameters available for this template."})}):Ut.jsxs("div",{className:"parameter-panel",children:[Ut.jsx("div",{className:"parameter-panel-title",children:"Parameters"}),Ut.jsx("div",{className:"parameter-list",children:e.map(e=>Ut.jsx(kC,{parameter:e,value:t[e.name],onChange:n,disabled:a,onEnhancePrompt:r,cameraAngle:(null==i?void 0:i[e.name])??null,onCameraAngleChange:s,comfyUrl:o},e.name))})]})}const NC=new class{constructor(){Le(this,"cache",null),Le(this,"cacheTimestamp",0),Le(this,"cacheTTL",3e5),Le(this,"fetchPromise",null)}async fetchDefinitions(e){const t=Date.now();if(this.cache&&t-this.cacheTimestamp<this.cacheTTL)return this.cache;if(this.fetchPromise)return this.fetchPromise;this.fetchPromise=this._doFetch(e);try{return this.cache=await this.fetchPromise,this.cacheTimestamp=t,this.cache}finally{this.fetchPromise=null}}async _doFetch(e){const t=e.replace(/\/ws$/,"").replace(/\/$/,""),n=await fetch(`${t}/object_info`);if(!n.ok)throw new Error(`Failed to fetch object_info: ${n.statusText}`);const a=await n.json();return console.log(`[NodeDefinitions] Loaded ${Object.keys(a).length} node definitions`),a}getNodeDefinition(e){return this.cache&&this.cache[e]||null}getEnumOptions(e,t){var n,a;const r=this.getNodeDefinition(e);if(!r)return null;if(null==(n=r.input.required)?void 0:n[t]){const e=r.input.required[t];return this._extractEnumOptions(e)}if(null==(a=r.input.optional)?void 0:a[t]){const e=r.input.optional[t];return this._extractEnumOptions(e)}return null}_extractEnumOptions(e){if(Array.isArray(e)){const[t]=e;if(Array.isArray(t))return t}return null}getInputDefinition(e,t){const n=this.getNodeDefinition(e);if(!n)return null;const a=e=>{if(!(null==e?void 0:e[t]))return null;const n=e[t];if(Array.isArray(n)){const[e,t]=n;return Array.isArray(e)?{type:"enum",isEnum:!0,options:e,default:(null==t?void 0:t.default)??e[0]}:{type:e,isEnum:!1,min:null==t?void 0:t.min,max:null==t?void 0:t.max,step:null==t?void 0:t.step,default:null==t?void 0:t.default}}return{type:String(n),isEnum:!1}};return a(n.input.required)||a(n.input.optional)}isLoaded(){return null!==this.cache}async getLoras(e){return await this.fetchDefinitions(e),this.getEnumOptions("LoraLoader","lora_name")||[]}clearCache(){this.cache=null,this.cacheTimestamp=0}},PC={seed:"seed",steps:"integer",cfg:"float",denoise:"float",strength:"float",noise_seed:"seed",text:"prompt",prompt:"prompt",positive:"prompt",negative:"prompt",width:"integer",height:"integer",batch_size:"integer",sampler_name:"enum",scheduler:"enum"},jC={sampler_name:["euler","euler_cfg_pp","euler_ancestral","euler_ancestral_cfg_pp","heun","heunpp2","dpm_2","dpm_2_ancestral","lms","dpm_fast","dpm_adaptive","dpmpp_2s_ancestral","dpmpp_sde","dpmpp_2m","ddpm","lcm","ipndm","ddim","uni_pc"],scheduler:["normal","karras","exponential","sgm_uniform","simple"]};function AC({workflow:e,parsedWorkflow:t,initialConfig:n,comfyUrl:a,onSave:r,onCancel:i}){const[s,o]=Tt.useState([]),[l,c]=Tt.useState(null),[d,u]=Tt.useState("exposed"),[h,p]=Tt.useState(""),[m,f]=Tt.useState(!1),[g,v]=Tt.useState(null),y=Tt.useRef(null),[x,b]=Tt.useState(!1),[_,w]=Tt.useState([]);Tt.useEffect(()=>{a&&!x&&(NC.fetchDefinitions(a).then(()=>{b(!0),console.log("[WorkflowEditor] Node definitions loaded")}).catch(e=>{console.error("[WorkflowEditor] Failed to load node definitions:",e)}),NC.getLoras(a).then(e=>{w(e),console.log(`[WorkflowEditor] Loaded ${e.length} available LoRAs`)}).catch(e=>{console.error("[WorkflowEditor] Failed to load LoRAs:",e)}))},[a,x]),Tt.useEffect(()=>{if(n&&n.length>0){const e=[...n].sort((e,t)=>e.order-t.order);o(e)}else if(t){const e=[];t.parameters.forEach((t,n)=>{e.push({name:t.name,display_name:t.display_name,node_id:t.node_id,input_name:t.input_name,type:t.type,default:t.default,description:t.description,constraints:t.constraints,order:n,exposed:!0,category:"parameter",auto_detected:!0,user_modified:!1})}),t.image_inputs.forEach((n,a)=>{const r="video"===n.type?"video":"image";e.push({name:n.name,display_name:n.display_name,node_id:n.node_id,input_name:n.input_name,type:r,default:"",description:n.description,order:t.parameters.length+a,exposed:!0,category:"image_input",auto_detected:!0,user_modified:!1})}),t.loras.forEach((n,a)=>{e.push({name:n.name,display_name:n.display_name,node_id:n.node_id,input_name:"strength_model",type:"lora",default:n.default_strength,description:`LoRA: ${n.display_name}`,constraints:{min:-10,max:10,step:.01,availableLoras:_,lora_name:n.lora_name||"",bypassed:!1},order:t.parameters.length+t.image_inputs.length+a,exposed:!0,category:"lora",auto_detected:!0,user_modified:!1})}),o(e)}},[t,n,_]),Tt.useEffect(()=>{_.length>0&&s.length>0&&o(e=>e.map(e=>"lora"===e.category?{...e,constraints:{...e.constraints,availableLoras:_}}:e))},[_]),Tt.useEffect(()=>{if(m&&s.length>0){const t=setTimeout(()=>{const t=e?JSON.stringify(e).slice(0,50):"unknown";localStorage.setItem(`workflow_config_${t}`,JSON.stringify(s)),console.log("Auto-saved workflow configuration")},1e3);return()=>clearTimeout(t)}},[s,m,e]);const S=Tt.useCallback(()=>{var t;if(!e)return[];const n=[];for(const[a,r]of Object.entries(e)){if("meta"===a||"object"!=typeof r||null===r)continue;const e=r,i=[];if(e.inputs)for(const[t,n]of Object.entries(e.inputs)){if(Array.isArray(n))continue;const e=s.some(e=>e.node_id===a&&e.input_name===t&&e.exposed);i.push({name:t,value:n,type:typeof n,exposed:e})}i.length>0&&n.push({id:a,class_type:e.class_type||"Unknown",title:(null==(t=e._meta)?void 0:t.title)||e.class_type||`Node ${a}`,inputs:i})}return n},[e,s]),M=Tt.useCallback((t,n,a)=>{let r=function(e,t){const n=e.toLowerCase();return PC[n]?PC[n]:"boolean"==typeof t?"boolean":"number"==typeof t?Number.isInteger(t)?"integer":"float":"string"==typeof t&&(n.includes("prompt")||n.includes("text"))?"prompt":"string"}(n,a),i=function(e){switch(e){case"integer":return{min:0,max:100,step:1};case"float":return{min:0,max:1,step:.01};case"seed":return{min:-1,max:2147483647,step:1};case"enum":return{options:[]};default:return}}(r)||{};const l=null==e?void 0:e[t];if(null==l?void 0:l.class_type){const e=NC.getInputDefinition(l.class_type,n);(null==e?void 0:e.isEnum)&&e.options&&(r="enum",i={options:e.options},console.log(`[WorkflowEditor] Detected enum from node definitions: ${l.class_type}.${n}`,e.options))}"enum"===r&&!i.options&&jC[n.toLowerCase()]&&(i.options=jC[n.toLowerCase()]);const c={name:`${n}_${t}`,display_name:n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),node_id:t,input_name:n,type:r,default:a,description:`Parameter ${n} from node ${t}`,constraints:i,order:s.length,exposed:!0,category:"parameter",auto_detected:!1,user_modified:!0};o(e=>[...e,c]),f(!0)},[s.length]),C=Tt.useCallback((e,t)=>{o(n=>{const a=[...n];return a[e]={...a[e],...t,user_modified:!0},a}),f(!0)},[]),E=Tt.useCallback(e=>{o(t=>t.filter((t,n)=>n!==e)),f(!0),l&&s[e]===l&&c(null)},[s,l]),k=Tt.useCallback((e,t)=>{v(t),y.current=t,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",String(t))},[]),T=Tt.useCallback(()=>{y.current=null,v(null)},[]),N=Tt.useCallback((e,t)=>{e.preventDefault(),e.stopPropagation();const n=y.current;null!==n&&n!==t&&(o(e=>{const a=[...e],r=a[n];return a.splice(n,1),a.splice(t,0,r),a.forEach((e,t)=>{e.order=t}),a}),y.current=t,v(t),f(!0))},[]),P=Tt.useCallback((e,t)=>{e.preventDefault(),e.dataTransfer.dropEffect="move"},[]),j=Tt.useCallback(e=>{e.preventDefault(),y.current=null,v(null)},[]),A=s.filter(e=>{const t=e.name.toLowerCase().includes(h.toLowerCase())||e.display_name.toLowerCase().includes(h.toLowerCase())||e.node_id.toLowerCase().includes(h.toLowerCase());return"exposed"===d?e.exposed&&t:t}),R=Tt.useCallback(()=>{const e=[...s].sort((e,t)=>e.order-t.order);r(e)},[s,r]),I=S();return e?Ut.jsxs("div",{className:"workflow-editor",children:[Ut.jsxs("div",{className:"editor-header",children:[Ut.jsx("h2",{children:"Workflow Editor"}),Ut.jsxs("div",{className:"editor-actions",children:[Ut.jsx("button",{className:"editor-btn secondary",onClick:i,children:"Cancel"}),Ut.jsx("button",{className:"editor-btn primary",onClick:R,children:"Save Configuration"})]})]}),Ut.jsxs("div",{className:"editor-tabs",children:[Ut.jsxs("button",{className:"editor-tab "+("exposed"===d?"active":""),onClick:()=>u("exposed"),children:["Exposed Parameters (",s.filter(e=>e.exposed).length,")"]}),Ut.jsx("button",{className:"editor-tab "+("all"===d?"active":""),onClick:()=>u("all"),children:"All Nodes"})]}),Ut.jsx("div",{className:"editor-search",children:Ut.jsx("input",{type:"text",placeholder:"Search parameters...",value:h,onChange:e=>p(e.target.value)})}),Ut.jsxs("div",{className:"editor-content",children:["exposed"===d&&Ut.jsx("div",{className:"parameters-list",children:0===A.length?Ut.jsx("p",{className:"empty-message",children:'No exposed parameters. Add parameters from the "All Nodes" tab.'}):A.map((t,n)=>Ut.jsx(RC,{config:t,workflow:e,isSelected:l===t,onSelect:()=>c(t),onUpdate:e=>C(n,e),onRemove:()=>E(n),onDragStart:e=>k(e,n),onDragOver:e=>P(e,n),onDragEnter:e=>N(e,n),onDrop:j,onDragEnd:T,isDragging:g===n},`${t.node_id}-${t.input_name}`))}),"all"===d&&Ut.jsx("div",{className:"nodes-list",children:I.map(e=>Ut.jsx(IC,{node:e,onAddParameter:(t,n)=>M(e.id,t,n)},e.id))})]}),m&&Ut.jsx("div",{className:"editor-status",children:"Unsaved changes will be auto-saved"})]}):Ut.jsx("div",{className:"workflow-editor",children:Ut.jsxs("div",{className:"editor-empty",children:[Ut.jsx("p",{children:"No workflow loaded. Please import a workflow first."}),Ut.jsx("button",{className:"editor-btn",onClick:i,children:"Close"})]})})}function RC({config:e,workflow:t,isSelected:n,onSelect:a,onUpdate:r,onRemove:i,onDragStart:s,onDragOver:o,onDragEnter:l,onDrop:c,onDragEnd:d,isDragging:u}){var h,p,m,f,g;const[v,y]=Tt.useState(!1);return Ut.jsxs("div",{className:`parameter-config-card ${n?"selected":""} ${e.auto_detected?"auto":"manual"} ${u?"dragging":""}`,onClick:a,onDragOver:o,onDragEnter:l,onDrop:c,children:[Ut.jsxs("div",{className:"config-header",children:[Ut.jsx("div",{className:"config-order",children:Ut.jsx("div",{className:"drag-handle",title:"Drag to reorder",draggable:"true",onDragStart:e=>{e.stopPropagation(),s(e)},onDragEnd:e=>{e.stopPropagation(),d()},onClick:e=>e.stopPropagation(),children:""})}),Ut.jsxs("div",{className:"config-info",children:[Ut.jsx("input",{type:"text",className:"config-name",value:e.display_name,onChange:e=>r({display_name:e.target.value}),onClick:e=>e.stopPropagation(),placeholder:"Display Name"}),Ut.jsxs("span",{className:"config-meta",children:[e.node_id,"  ",e.input_name," (",e.type,")"]})]}),Ut.jsxs("div",{className:"config-actions",children:[Ut.jsx("button",{className:"config-toggle",onClick:e=>{e.stopPropagation(),y(!v)},children:v?"":""}),Ut.jsx("button",{className:"config-remove",onClick:e=>{e.stopPropagation(),i()},title:"Remove parameter",children:""})]})]}),v&&Ut.jsxs("div",{className:"config-details",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Name (internal):"}),Ut.jsx("input",{type:"text",value:e.name,onChange:e=>r({name:e.target.value}),placeholder:"snake_case_name"})]}),Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Type:"}),Ut.jsxs("select",{value:e.type,onChange:e=>r({type:e.target.value}),children:[Ut.jsx("option",{value:"integer",children:"Integer"}),Ut.jsx("option",{value:"float",children:"Float"}),Ut.jsx("option",{value:"seed",children:"Seed"}),Ut.jsx("option",{value:"boolean",children:"Boolean"}),Ut.jsx("option",{value:"enum",children:"Enum"}),Ut.jsx("option",{value:"prompt",children:"Prompt"}),Ut.jsx("option",{value:"string",children:"String"}),Ut.jsx("option",{value:"image",children:"Image"}),Ut.jsx("option",{value:"video",children:"Video"}),Ut.jsx("option",{value:"media",children:"Media (Image/Video)"})]})]}),Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Default Value:"}),Ut.jsx("input",{type:"text",value:String(e.default),onChange:t=>{let n=t.target.value;"integer"===e.type||"seed"===e.type?n=parseInt(n)||0:"float"===e.type?n=parseFloat(n)||0:"boolean"===e.type&&(n="true"===n),r({default:n})}})]}),Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Description:"}),Ut.jsx("input",{type:"text",value:e.description,onChange:e=>r({description:e.target.value}),placeholder:"Parameter description"})]}),("integer"===e.type||"float"===e.type||"seed"===e.type)&&Ut.jsxs("div",{className:"config-constraints",children:[Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Min:"}),Ut.jsx("input",{type:"number",value:(null==(h=e.constraints)?void 0:h.min)??0,onChange:t=>r({constraints:{...e.constraints,min:parseFloat(t.target.value)}})})]}),Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Max:"}),Ut.jsx("input",{type:"number",value:(null==(p=e.constraints)?void 0:p.max)??100,onChange:t=>r({constraints:{...e.constraints,max:parseFloat(t.target.value)}})})]}),Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Step:"}),Ut.jsx("input",{type:"number",value:(null==(m=e.constraints)?void 0:m.step)??1,onChange:t=>r({constraints:{...e.constraints,step:parseFloat(t.target.value)}})})]})]}),"enum"===e.type&&Ut.jsxs("div",{className:"config-row",children:[Ut.jsx("label",{children:"Options (comma-separated):"}),Ut.jsxs("div",{className:"enum-options-row",children:[Ut.jsx("input",{type:"text",value:(null==(g=null==(f=e.constraints)?void 0:f.options)?void 0:g.join(", "))||"",onChange:t=>r({constraints:{...e.constraints,options:t.target.value.split(",").map(e=>e.trim()).filter(Boolean)}}),placeholder:"option1, option2, option3"}),Ut.jsx("button",{type:"button",className:"fetch-options-btn",onClick:()=>{if(!t)return;const n=t[e.node_id];if(null==n?void 0:n.class_type){const t=NC.getEnumOptions(n.class_type,e.input_name);t&&t.length>0?r({constraints:{...e.constraints,options:t}}):alert(`No enum options found for ${n.class_type}.${e.input_name}.\nMake sure ComfyUI is connected.`)}},title:"Fetch options from ComfyUI",children:" Fetch"})]})]}),Ut.jsxs("div",{className:"config-flags",children:[Ut.jsxs("label",{className:"flag",children:[Ut.jsx("input",{type:"checkbox",checked:e.exposed,onChange:e=>r({exposed:e.target.checked})}),"Exposed in UI"]}),Ut.jsx("span",{className:"config-source",children:e.auto_detected?" Auto-detected":" User-defined"})]})]})]})}function IC({node:e,onAddParameter:t}){const[n,a]=Tt.useState(!1);return Ut.jsxs("div",{className:"node-card",children:[Ut.jsxs("div",{className:"node-header",onClick:()=>a(!n),children:[Ut.jsx("span",{className:"node-toggle",children:n?"":""}),Ut.jsxs("div",{className:"node-info",children:[Ut.jsx("span",{className:"node-title",children:e.title}),Ut.jsx("span",{className:"node-type",children:e.class_type})]}),Ut.jsxs("span",{className:"node-id",children:["ID: ",e.id]})]}),n&&Ut.jsx("div",{className:"node-inputs",children:e.inputs.map(e=>Ut.jsxs("div",{className:"node-input "+(e.exposed?"exposed":""),children:[Ut.jsxs("div",{className:"input-info",children:[Ut.jsx("span",{className:"input-name",children:e.name}),Ut.jsx("span",{className:"input-type",children:e.type}),Ut.jsx("span",{className:"input-value",children:String(e.value).slice(0,50)})]}),e.exposed?Ut.jsx("span",{className:"input-added",children:" Exposed"}):Ut.jsx("button",{className:"input-add-btn",onClick:()=>t(e.name,e.value),children:"+ Expose"})]},e.name))})]})}const LC=new Set(["ckpt_name","unet_name","lora_name","vae_name","clip_name","control_net_name","style_model_name","model_name","filename_prefix","output_path","save_prefix","file_path","directory","save_path","image"]);function DC(e,t){const n="windows"===t;for(const a of Object.values(e)){const e=null==a?void 0:a.inputs;if(e&&"object"==typeof e)for(const[t,a]of Object.entries(e))LC.has(t)&&"string"==typeof a&&(n?!a.includes("://")&&a.includes("/")&&(e[t]=a.replace(/\//g,"\\")):a.includes("\\")&&(e[t]=a.replace(/\\/g,"/")))}}class UC{normalizeWorkflowFormat(e){var t;if("nodes"in e&&Array.isArray(e.nodes)&&e.nodes.length>0){const n=e,a={},r=new Map;if(n.links)for(const e of n.links){const t=e[0],n=e[1],a=e[2];r.set(t,[n,a])}for(const e of n.nodes){const n=String(e.id),i=e,s=i.type||e.class_type||"",o={};if(i.inputs&&Array.isArray(i.inputs))for(const e of i.inputs)if(null!==e.link&&void 0!==e.link){const t=r.get(e.link);t&&(o[e.name]=[String(t[0]),t[1]])}a[n]={class_type:s,inputs:o,widgets_values:i.widgets_values,_meta:{title:i.title||(null==(t=i.properties)?void 0:t["Node name for S&R"])||""},mode:i.mode}}return a}return e}parseWorkflow(e){const t=this.normalizeWorkflowFormat(e),n=this._extractParameters(t),a=this._extractImageInputs(t),r=this._extractLoRAs(t),i=this._extractOutputs(t),s=this._detectCategories(t),o=this._detectNextSceneSupport(t),l=r.some(e=>"qwen-image-edit-2511-multiple-angles-lora.safetensors"===e.lora_name);return{parameters:n,image_inputs:a,loras:r,outputs:i,categories:s,has_next_scene_support:o,hasMultiAngleLora:l}}_normalizeNode(e){const t=e.class_type||e.type||"";let n=e.inputs||{};if(e.widgets_values&&Array.isArray(e.widgets_values)){const a=this._getWidgetNames(t);e.widgets_values.forEach((e,t)=>{a[t]&&(n[a[t]]=e)})}return{class_type:t,inputs:n}}_getWidgetNames(e){return{KSampler:["seed","control_after_generate","steps","cfg","sampler_name","scheduler","denoise"],KSamplerAdvanced:["add_noise","noise_seed","steps","cfg","sampler_name","scheduler","start_at_step","end_at_step","return_with_leftover_noise"],CLIPTextEncode:["text"],EmptyLatentImage:["width","height","batch_size"],EmptySD3LatentImage:["width","height","batch_size"],LoadImage:["image","upload"],LoraLoader:["lora_name","strength_model","strength_clip"],LoraLoaderModelOnly:["lora_name","strength_model"],VAELoader:["vae_name"],CLIPLoader:["clip_name","type","device"],UNETLoader:["unet_name","weight_dtype"],VAEEncode:[],VAEDecode:[],SaveImage:["filename_prefix"],PreviewImage:[],ModelSamplingAuraFlow:["shift"],ConditioningZeroOut:[],QwenImageIntegratedKSampler:["prompt","negative_prompt","mode","batch_size","image1_weight","image2_weight","seed","control_after_generate","steps","denoise","sampler_name","scheduler","scale_method","cfg","image_count","tile_vae","use_teacache","use_fp8_linear","custom_prompt","save_prefix","system_prompt"],FluxResolutionNode:["megapixels","aspect_ratio","divisor","preview","last_ratio"],ImageResizeKJv2:["width","height","upscale_method","crop","pad_color","pad_position","divisor","device"],ImageScaleToTotalPixels:["upscale_method","megapixels"],VHS_LoadVideo:["video","force_rate","custom_width","custom_height","frame_load_cap","skip_first_frames","select_every_nth","format"],OlmDragCrop:["seed","crop_left","crop_right","crop_top","crop_bottom","crop_width","crop_height","img_width","img_height","snap","aspect_ratio","lock_aspect","action","refresh","mask","color","reset"],OpenposePreprocessor:["detect_hand","detect_body","detect_face","resolution","bbox_detector"],DepthAnything_V2:[],DownloadAndLoadDepthAnythingV2Model:["model"],UnetLoaderGGUF:["unet_name"],PathchSageAttentionKJ:["attention_mode","force_fp16"],"Power Lora Loader (rgthree)":[],"LayerUtility: SaveImagePlus":["output_path","filename_prefix","timestamp","format","quality","save_metadata","custom_metadata","overwrite","preview"],"Image Comparer (rgthree)":[],InpaintCropImproved:["downscale_algorithm","upscale_algorithm","preresize","preresize_mode","preresize_min_width","preresize_min_height","preresize_max_width","preresize_max_height","mask_fill_holes","mask_expand_pixels","mask_invert","mask_blend_pixels","mask_hipass_filter","extend_for_outpainting","extend_up_factor","extend_down_factor","extend_left_factor","extend_right_factor","context_from_mask_extend_factor","output_resize_to_target_size","output_target_width","output_target_height","output_padding","device_mode"],InpaintStitchImproved:[]}[e]||[]}_extractParameters(e){let t=[];for(const[n,a]of Object.entries(e)){if("meta"===n||"object"!=typeof a||null===a)continue;const e=a,{class_type:r,inputs:i}=this._normalizeNode(e);if("KSampler"===r&&("steps"in i&&t.push({name:"steps",display_name:"Sampling Steps",type:"integer",node_id:n,input_name:"steps",default:i.steps??20,constraints:{min:1,max:150,step:1},description:"Number of sampling steps"}),"cfg"in i&&t.push({name:"cfg",display_name:"CFG Scale",type:"float",node_id:n,input_name:"cfg",default:i.cfg??7,constraints:{min:0,max:30,step:.1},description:"Classifier-free guidance scale"}),"seed"in i&&t.push({name:"seed",display_name:"Seed",type:"seed",node_id:n,input_name:"seed",default:i.seed??-1,description:"Random seed for reproducibility"}),"denoise"in i&&t.push({name:"denoise",display_name:"Denoise Strength",type:"float",node_id:n,input_name:"denoise",default:i.denoise??1,constraints:{min:.1,max:1,step:.05},description:"Denoising strength (img2img)"})),"QwenImageIntegratedKSampler"===r){const a=e.widgets_values||[];t.push({name:"positive_prompt",display_name:"Prompt",type:"prompt",node_id:n,input_name:"positive_prompt",default:a[0]||i.positive_prompt||"",description:"Main prompt for image generation/editing"}),t.push({name:"negative_prompt",display_name:"Negative Prompt",type:"prompt",node_id:n,input_name:"negative_prompt",default:a[1]||i.negative_prompt||"",description:"What to avoid in generation"}),t.push({name:"generation_mode",display_name:"Mode",type:"enum",node_id:n,input_name:"generation_mode",default:a[2]||i.generation_mode||" image-to-image",constraints:{options:[" text-to-image"," image-to-image"," image-edit"]},description:"Generation mode"}),t.push({name:"seed",display_name:"Seed",type:"seed",node_id:n,input_name:"seed",default:a[6]||i.seed||-1,description:"Random seed"}),t.push({name:"steps",display_name:"Steps",type:"integer",node_id:n,input_name:"steps",default:a[8]||i.steps||4,constraints:{min:1,max:50,step:1},description:"Sampling steps"}),t.push({name:"denoise",display_name:"Denoise",type:"float",node_id:n,input_name:"denoise",default:a[9]||i.denoise||1,constraints:{min:0,max:1,step:.05},description:"Denoising strength"}),t.push({name:"cfg",display_name:"CFG Scale",type:"float",node_id:n,input_name:"cfg",default:a[13]||i.cfg||3,constraints:{min:1,max:20,step:.5},description:"Classifier-free guidance"})}"EmptyLatentImage"===r&&("width"in i&&t.push({name:"width",display_name:"Width",type:"integer",node_id:n,input_name:"width",default:i.width??512,constraints:{min:256,max:2048,step:64},description:"Output image width"}),"height"in i&&t.push({name:"height",display_name:"Height",type:"integer",node_id:n,input_name:"height",default:i.height??512,constraints:{min:256,max:2048,step:64},description:"Output image height"}))}return t=this._extractPromptParameters(e,t),t}_extractPromptParameters(e,t){var n;const a=[...t],r=[],i={CLIPTextEncode:"text",TextEncodeQwenImageEditPlus:"prompt",TextEncodeQwenImageEdit:"prompt",TextEncodeQwen:"prompt",CLIPTextEncodeSDXL:"text_g",PromptStyler:"text_positive",ShowText:"text",StringFunction:"text"};for(const[h,p]of Object.entries(e)){if("meta"===h||"object"!=typeof p||null===p)continue;const e=p,t=e.class_type||"",a=e.inputs||{};if(t in i){const s=i[t];if(s in a){const i=String(a[s]??""),o=(null==(n=e._meta)?void 0:n.title)||"";r.push({node_id:h,class_type:t,input_name:s,text:i,title:o,title_lower:o.toLowerCase()})}}}if(0===r.length)return a;const s=[],o=[],l=[],c=["positive","pos ","(pos)","prompt","main prompt","subject"],d=["negative","neg ","(neg)","bad","ugly","worst","low quality","avoid"],u=["ugly","blurry","bad anatomy","worst quality","low quality","normal quality","lowres","watermark","deformed","disfigured","mutation","extra limbs"];for(const h of r){const e=h.title_lower,t=h.text.toLowerCase().slice(0,200),n=c.some(t=>e.includes(t)),a=d.some(t=>e.includes(t));let r=a;n||a||(r=u.some(e=>t.includes(e))),r&&!n?o.push(h):n&&!r?s.push(h):l.push(h)}for(const h of l)if(0===s.length)s.push(h);else if(0===o.length)o.push(h);else{const e=`prompt_${h.node_id}`,t=h.title||`Prompt (Node ${h.node_id})`;a.push({name:e,display_name:t,type:"prompt",node_id:h.node_id,input_name:h.input_name,default:h.text,description:`Text prompt for ${h.class_type} node ${h.node_id}`})}for(let h=0;h<s.length;h++){const e=s[h],t=a.find(e=>"positive_prompt"===e.name);if(0!==h||t){const t=h>0?`positive_prompt_${h+1}`:`positive_prompt_${e.node_id}`,n=e.title||`Positive Prompt ${h+2}`;a.push({name:t,display_name:n,type:"prompt",node_id:e.node_id,input_name:e.input_name,default:e.text,description:"Additional positive prompt"})}else a.push({name:"positive_prompt",display_name:"Positive Prompt",type:"prompt",node_id:e.node_id,input_name:e.input_name,default:e.text,description:"Positive prompt (what to generate)"})}for(let h=0;h<o.length;h++){const e=o[h],t=a.find(e=>"negative_prompt"===e.name);if(0!==h||t){const t=h>0?`negative_prompt_${h+1}`:`negative_prompt_${e.node_id}`,n=e.title||`Negative Prompt ${h+2}`;a.push({name:t,display_name:n,type:"prompt",node_id:e.node_id,input_name:e.input_name,default:e.text,description:"Additional negative prompt"})}else a.push({name:"negative_prompt",display_name:"Negative Prompt",type:"prompt",node_id:e.node_id,input_name:e.input_name,default:e.text,description:"Negative prompt (things to avoid)"})}return a}_extractLoRAs(e){const t=[];let n=0;for(const[a,r]of Object.entries(e)){if("meta"===a||"object"!=typeof r||null===r)continue;const e=r,i=e.class_type||"";if(i.includes("LoraLoader")||"LoraLoaderModelOnly"===i){n++;const r=e.inputs||{},i=r.lora_name||"";let s;if(i){const e=i.split(/[\\/]/);s=e[e.length-1].replace(/\.[^/.]+$/,"")}else s=`LoRA ${n}`;t.push({name:`lora_${n}`,display_name:s,node_id:a,strength_inputs:{model:"strength_model",clip:"strength_clip"},default_enabled:!0,default_strength:r.strength_model??.75,required:!0,lora_name:i})}}return t}_extractImageInputs(e){const t=[];let n=0;for(const[a,r]of Object.entries(e)){if("meta"===a||"object"!=typeof r||null===r)continue;const e=r.class_type||"";"LoadImage"===e&&(n++,t.push({name:`reference_image_${n}`,display_name:`Reference Image ${n}`,node_id:a,input_name:"image",type:"image",required:!1,batch_min:1,batch_max:1,description:`Reference image for node ${a}`})),"LoadImageMask"===e&&(n++,t.push({name:`mask_image_${n}`,display_name:`Mask Image ${n}`,node_id:a,input_name:"image",type:"mask",required:!1,batch_min:1,batch_max:1,description:`Mask image for node ${a}`}));if("VHS_LoadVideo"===e||"VHS_LoadVideoPath"===e||"LoadVideo"===e||"LoadVideoUpload"===e||"VideoLoader"===e||e.includes("LoadVideo")){n++;const r="VHS_LoadVideoPath"===e?"video_path":"video";t.push({name:`video_input_${n}`,display_name:`Video Input ${n}`,node_id:a,input_name:r,type:"video",required:!1,batch_min:1,batch_max:1,description:`Video input for node ${a}`})}}return t}imageInputsToParameters(e){return e.map(e=>{let t="image";return"video"===e.type||e.name.includes("video")?t="video":"mask"===e.type&&(t="image"),{name:e.name,display_name:e.display_name,type:t,node_id:e.node_id,input_name:e.input_name,default:"",description:e.description,constraints:{min:e.batch_min,max:e.batch_max}}})}_extractOutputs(e){const t=[];let n=0;for(const[a,r]of Object.entries(e)){if("meta"===a||"object"!=typeof r||null===r)continue;const e=r.class_type||"";"SaveImage"!==e&&"PreviewImage"!==e||(n++,t.push({node_id:a,name:`Output ${n} (${e})`,type:"image",selected:1===n})),"SaveAnimatedWEBP"!==e&&"SaveAnimatedPNG"!==e||(n++,t.push({node_id:a,name:`Output ${n} (${e})`,type:"video",selected:1===n})),("VHS_VideoCombine"===e||"VHS_SaveVideo"===e||"ADE_AnimateDiffCombine"===e||e.includes("SaveVideo")||e.includes("VideoSave")||e.includes("VideoCombine")||e.includes("WanVideo")||e.includes("VideoOutput"))&&(t.some(e=>e.node_id===a)||(n++,t.push({node_id:a,name:`Output ${n} (Video: ${e})`,type:"video",selected:1===n})))}return t}_detectCategories(e){let t=!1,n=!1,a=!1,r=!1;for(const[s,o]of Object.entries(e)){if("meta"===s||"object"!=typeof o||null===o)continue;const e=o.class_type||"";"LoadImage"===e&&(t=!0),e.includes("EmptyLatent")&&(n=!0),"KSampler"===e&&(a=!0),["VAEEncodeForInpaint","InpaintModelConditioning","Inpaint","InpaintCropImproved","InpaintStitchImproved"].includes(e)&&(r=!0)}const i=[];return t&&!n&&i.push("editing"),t&&n&&i.push("img2img"),n&&a&&i.push("generation"),r&&(i.includes("img2img")||i.push("img2img")),0===i.length&&i.push("generation"),i}_detectNextSceneSupport(e){for(const[t,n]of Object.entries(e)){if("meta"===t||"object"!=typeof n||null===n)continue;const e=n.class_type||"";if(e.includes("VAEEncode")||"LoadImage"===e)return!0}return!1}buildWorkflow(e,t,n,a,r){const i=this.normalizeWorkflowFormat(e),s=JSON.parse(JSON.stringify(i));this.normalizeWorkflowPaths(s);const o=this.parseWorkflow(e),l=[...o.parameters];if(r)for(const u of r){if(!u.exposed)continue;l.some(e=>e.node_id===u.node_id&&e.input_name===u.input_name)||l.push({name:u.name,display_name:u.name,description:"",type:"enum",node_id:u.node_id,input_name:u.input_name,default:null})}console.log("[buildWorkflow] Applying parameters:",t),console.log("[buildWorkflow] Available params:",l.map(e=>({name:e.name,node_id:e.node_id,input_name:e.input_name})));for(const[u,h]of Object.entries(t)){let e=l.find(e=>e.name===u);if(e||(e=l.find(e=>u===`${e.name}_${e.node_id}`)),e||(e=l.find(e=>u===`${e.input_name}_${e.node_id}`)),e){console.log(`[buildWorkflow] Matched param "${u}" to node ${e.node_id}.${e.input_name}`);const t=s[e.node_id];if(t){if(t.widgets_values&&Array.isArray(t.widgets_values)){const n=this._getWidgetIndex(t.class_type||"",e.input_name);n>=0&&(t.widgets_values[n]=h)}t.inputs||(t.inputs={});let n=h;"unet_name"!==e.input_name&&"ckpt_name"!==e.input_name&&"model_name"!==e.input_name&&"lora_name"!==e.input_name||"string"==typeof h&&h.includes("\\")&&(n=h.replace(/\\/g,"/"),console.log(`[buildWorkflow] Normalized path for ${e.input_name}: ${h} -> ${n}`)),t.inputs[e.input_name]=n}}else console.log(`[buildWorkflow] No match for param "${u}"`)}console.log("[buildWorkflow] === APPLYING IMAGE INPUTS ==="),console.log("[buildWorkflow] imageInputs received:",Object.entries(n).map(([e,t])=>`${e}=${t}`)),console.log("[buildWorkflow] parsed.image_inputs:",o.image_inputs.map(e=>({name:e.name,node_id:e.node_id,input_name:e.input_name})));for(const[u,h]of Object.entries(n)){const e=o.image_inputs.find(e=>e.name===u);if(e){const t=s[e.node_id];if(console.log(`[buildWorkflow] Processing image input "${u}" -> node ${e.node_id}.${e.input_name}, path=${h}, node exists=${!!t}`),t){if("__BYPASSED__"===h){console.log(`[buildWorkflow] !!! BYPASSING image input node ${e.node_id} (${u}, class_type=${t.class_type}) !!!`),t.mode=4;continue}t.inputs||(t.inputs={}),t.inputs[e.input_name]=h,t.widgets_values&&Array.isArray(t.widgets_values)&&(t.widgets_values[0]=h)}}}console.log(`[buildWorkflow] Processing ${o.loras.length} LoRAs, loraValues has ${Object.keys(a).length} entries`);for(const u of o.loras){const e=s[u.node_id];if(!e){console.warn(`[buildWorkflow] LoRA node ${u.node_id} not found in workflow`);continue}const t=a[u.name];if(t){!0===t.bypassed||!1===t.enabled?(console.log(`[buildWorkflow] Bypassing LoRA node ${u.node_id} (${u.name})`),e.mode=4):e.inputs&&(e.inputs[u.strength_inputs.model]=t.strength,e.inputs[u.strength_inputs.clip]=t.strength,t.lora_name&&(e.inputs.lora_name=t.lora_name),console.log(`[buildWorkflow] Applied LoRA ${u.name} (node ${u.node_id}): strength=${t.strength}`))}else console.log(`[buildWorkflow] Using defaults for LoRA ${u.name} (node ${u.node_id}) - not in UI params`),4===e.mode&&delete e.mode,e.inputs&&u.strength_inputs.model in e.inputs&&console.log(`[buildWorkflow] Keeping original strength: ${e.inputs[u.strength_inputs.model]}`)}const c={},d=new Set;console.log("[buildWorkflow] === BYPASS ANALYSIS START ==="),console.log("[buildWorkflow] All nodes in workflow:",Object.keys(s).filter(e=>"meta"!==e&&"version"!==e));for(const[u,h]of Object.entries(s)){if("meta"===u||"version"===u)continue;const e=h;4===e.mode&&(d.add(u),console.log(`[buildWorkflow] Node ${u} (${e.class_type}) is BYPASSED (mode=4)`))}if(console.log(`[buildWorkflow] Total bypassed nodes: ${d.size}`,Array.from(d)),d.size>0){console.log("[buildWorkflow] === CASCADE BYPASS TO DOWNSTREAM ===");const e=this.cascadeBypassToDownstream(s,d);for(const t of e)d.add(t);console.log(`[buildWorkflow] After cascade: ${d.size} bypassed nodes`,Array.from(d))}for(const[u,h]of Object.entries(s)){if("meta"===u||"version"===u)continue;const e=h;if(e.class_type){if(this._isUiOnlyNode(e.class_type)){console.log(`[buildWorkflow] Skipping UI-only node ${u} (${e.class_type})`);continue}if(4===e.mode){console.log(`[buildWorkflow] Skipping bypassed node ${u} (${e.class_type})`);continue}const t={...e.inputs||{}};if(e.widgets_values&&Array.isArray(e.widgets_values)){const n=this._getWidgetNames(e.class_type);e.widgets_values.forEach((e,a)=>{n[a]&&void 0!==e&&(n[a]in t||(t[n[a]]=e))})}c[u]={class_type:e.class_type,inputs:t},e._meta&&(c[u]._meta=e._meta)}}if(d.size>0){const e=new Map;for(const[o,l]of Object.entries(s))if(d.has(o)){const t=l;t.inputs&&e.set(o,{...t.inputs})}console.log("[buildWorkflow] Bypassed node inputs map:",Object.fromEntries(e));const t=(n,a)=>{var r;if(console.log(`[findUpstreamSource] Checking node ${n} (output ${a}), bypassed=${d.has(n)}`),!d.has(n))return console.log(`[findUpstreamSource] Node ${n} is NOT bypassed, returning as source`),[n,a];const i=e.get(n);if(console.log(`[findUpstreamSource] Node ${n} is bypassed, inputs:`,i),!i)return null;const o={LoraLoader:{0:"model",1:"clip"},LoraLoaderModelOnly:{0:"model"},LoraLoaderStack:{0:"model",1:"clip"},PathchSageAttentionKJ:{0:"model"},TorchCompileModelAdvanced:{0:"model"},CLIPSetLastLayer:{0:"clip"}},l=(null==(r=s[n])?void 0:r.class_type)||"";let c;for(const[e,t]of Object.entries(o))if(l.includes(e)){c=t[a];break}if(!c)return console.log(`[findUpstreamSource] No pass-through mapping for ${l} output ${a}`),null;const u=i[c];if(console.log(`[findUpstreamSource] Looking for upstream via input "${c}":`,u),Array.isArray(u)&&u.length>=2){const e=String(u[0]),n=Number(u[1]);return console.log(`[findUpstreamSource] Following to upstream ${e}:${n}`),t(e,n)}return console.log(`[findUpstreamSource] No upstream found for node ${n}`),null};console.log("[buildWorkflow] === PROCESSING INPUT REFERENCES ==="),console.log("[buildWorkflow] API Workflow nodes:",Object.keys(c));const n=new Set,a=(e,t)=>{if(!e)return!1;return!("image"!==t||!["LoadImage","ImageScale","ImageScaleToTotalPixels","ImageResize","ImageResizeKJv2","ImageCrop","VAEEncode","DWPose","OpenposePreprocessor","CannyEdgePreprocessor","LineartPreprocessor","DepthAnything","InstantIDFaceAnalysis","ReActorFaceSwap","IPAdapter","ControlNetLoader","InpaintCropImproved"].some(t=>null==e?void 0:e.includes(t)))||(!("pixels"!==t||!(null==e?void 0:e.includes("VAEEncode")))||(!("mask"!==t||!(null==e?void 0:e.includes("InpaintCropImproved")))||!("stitcher"!==t&&"inpainted_image"!==t||!(null==e?void 0:e.includes("InpaintStitchImproved")))))};for(const[s,o]of Object.entries(c)){const e=o;if(e.inputs){const r=[],i=[];for(const[o,l]of Object.entries(e.inputs))if(Array.isArray(l)&&l.length>=2){const c=String(l[0]),u=Number(l[1]);if(console.log(`[buildWorkflow] Node ${s} input "${o}" references [${c}, ${u}], bypassed=${d.has(c)}`),d.has(c)){console.log(`[buildWorkflow] Attempting to rewire through bypassed node ${c}`);const l=t(c,u);l?(console.log(`[buildWorkflow]  Rewiring input "${o}" from bypassed node ${c} to upstream ${l[0]}:${l[1]}`),r.push({name:o,value:l})):a(e.class_type,o)?(console.log(`[buildWorkflow]  Node ${s} (${e.class_type}) loses required input "${o}" - will remove entire node`),n.add(s)):(console.log(`[buildWorkflow]  Removing optional input "${o}" from node ${s}`),i.push(o))}}if(!n.has(s)){for(const t of r)e.inputs[t.name]=t.value;for(const t of i)delete e.inputs[t]}}}let r=0;const i=10;for(;n.size>0&&r<i;){r++,console.log(`[buildWorkflow] Removal iteration ${r}: removing ${Array.from(n)}`);for(const t of n)c[t]&&(delete c[t],console.log(`[buildWorkflow] Removed node ${t}`));const e=new Set;for(const[t,r]of Object.entries(c)){const i=r;if(i.inputs)for(const[r,s]of Object.entries(i.inputs))if(Array.isArray(s)&&s.length>=2){const o=String(s[0]);!n.has(o)&&c[o]||(console.log(`[buildWorkflow] Node ${t} loses input "${r}" (referenced ${o} was removed)`),delete i.inputs[r],a(i.class_type,r)&&(console.log(`[buildWorkflow] Node ${t} (${i.class_type}) lost required input "${r}" - will remove`),e.add(t)))}}n.clear();for(const t of e)n.add(t)}r>=i&&console.warn("[buildWorkflow] Warning: Hit max iterations for cascading removal"),console.log(`[buildWorkflow] Cascading removal completed after ${r} iterations`),console.log("[buildWorkflow] === BYPASS ANALYSIS END ===")}return c[76]&&console.log("[buildWorkflow] FINAL STATE: Node 76:",c[76].inputs),c[81]&&console.log("[buildWorkflow] FINAL STATE: Node 81:",c[81].inputs),c[120]&&console.log("[buildWorkflow] FINAL STATE: Node 120:",c[120].inputs),c[122]&&console.log("[buildWorkflow] FINAL STATE: Node 122:",c[122].inputs),c}_isUiOnlyNode(e){if(["Note","MarkdownNote","PrimitiveNode","Reroute","GroupNode","ttN pipeLoader","ShowText|pysssss","ShowAnything"].includes(e))return!0;return[/^Note$/i,/Note$/,/^Comment/i,/^Sticky/i].some(t=>t.test(e))}_getWidgetIndex(e,t){if("QwenImageIntegratedKSampler"===e){return{prompt:0,negative_prompt:1,mode:2,batch_size:3,image1_weight:4,image2_weight:5,seed:6,control_after_generate:7,steps:8,denoise:9,sampler_name:10,scheduler:11,scale_method:12,cfg:13}[t]??-1}return-1}normalizeWorkflowPaths(e){const t=["unet_name","ckpt_name","model_name","lora_name","clip_name","vae_name","control_net_name","style_model_name","positive","negative"];for(const[n,a]of Object.entries(e))if("meta"!==n&&"version"!==n&&"inputs"in a&&a.inputs)for(const[e,r]of Object.entries(a.inputs))if(t.includes(e)&&"string"==typeof r&&r.includes("\\")){const t=r.replace(/\\/g,"/");a.inputs[e]=t,console.log(`[normalizeWorkflowPaths] Node ${n} ${e}: ${r} -> ${t}`)}}findDownstreamNodes(e,t){const n=new Map,a=new Set,r=[t];for(;r.length>0;){const t=r.shift();if(!a.has(t)){a.add(t);for(const[a,i]of Object.entries(e)){if("meta"===a||"version"===a)continue;if(!("inputs"in i)||!i.inputs)continue;const e=i,s=[];for(const[n,a]of Object.entries(e.inputs||{}))if(Array.isArray(a)&&a.length>=2){String(a[0])===t&&s.push(n)}s.length>0&&(n.set(a,s),r.push(a))}}}return n}_isRequiredInputForNode(e,t){if(!e)return!1;const n=["KSampler","KSamplerAdvanced","SamplerCustom","SamplerEuler","QwenImageIntegratedKSampler","ImageOnlyKSampler"],a=["CLIPTextEncode","CLIPTextEncodeSDXL","CLIPTextEncodeThree","CLIPSetLastLayer","CLIPLoader","DualCLIPLoader"];if("image"===t||"pixels"===t||"background"===t){if(["LoadImage","ImageScale","ImageScaleToTotalPixels","ImageResize","ImageResizeKJv2","ImageCrop","VAEEncode","DWPose","OpenposePreprocessor","CannyEdgePreprocessor","LineartPreprocessor","DepthAnything","InstantIDFaceAnalysis","ReActorFaceSwap","IPAdapter","ControlNetLoader","ControlNetApply","ControlNetApplyAdvanced","ControlNetStack","DWPreprocessor","AIO_Preprocessor","MiDaS","BAE","LineaArt","ScribblePreprocessor","SemanticSegmentationPreprocessor","MediaPipe","FaceDetect","FaceRestore","FaceRestoreModel","GFPGAN","CodeFormer","IPAdapterApply","IPAdapterApplyLoader","IPAdapterIdentity","Inspire","FreeU","FreeUChen","ImagePass","ImageBatch","LoraLoader","LoraLoaderModelOnly","LoraLoaderStack","StyleModelLoader","CLIPVisionLoader","Sigmas","QwenImageControlNetIntegratedLoader","QwenImageEdit","InpaintCropImproved"].some(t=>e.includes(t)))return!0;if(("pixels"===t||"image"===t)&&e.includes("VAEEncode"))return!0}if("mask"===t){if(["VAEEncode","ImageBatchWithMask","ImageCropByMask","InpaintModelConditioning","InpaintCropImproved"].some(t=>e.includes(t)))return!0}return!("model"!==t||!n.some(t=>e.includes(t)))||(!("clip"!==t||!a.some(t=>e.includes(t)))||(!("control_net"!==t&&"controlnet"!==t||!e.includes("ControlNetApply")&&!e.includes("ControlNet"))||(!("lora_name"!==t&&!t.startsWith("lora_name_")||!e.includes("LoraLoader"))||!("stitcher"!==t&&"inpainted_image"!==t||!e.includes("InpaintStitchImproved")))))}cascadeBypassToDownstream(e,t){const n=new Set(t);let a=!0,r=0;for(console.log("[cascadeBypass] Starting with bypassed nodes:",Array.from(t));a&&r<20;){a=!1,r++;for(const t of n){const r=this.findDownstreamNodes(e,t);for(const[i,s]of r){if(n.has(i))continue;const r=e[i];if(!r||!r.inputs)continue;if(s.some(e=>this._isRequiredInputForNode(r.class_type,e))){(Object.entries(r.inputs||{}).every(([e,t])=>{if(Array.isArray(t)&&t.length>=2){const e=String(t[0]);return n.has(e)}return!0})||4===r.mode)&&(r.mode=4,n.add(i),a=!0,console.log(`[cascadeBypass] Cascaded bypass to node ${i} (${r.class_type}) - depends on ${t} via inputs: ${s.join(", ")}`))}}}}return r>=20&&console.warn("[cascadeBypass] Warning: Hit max iterations"),console.log("[cascadeBypass] Final bypassed nodes:",Array.from(n)),n}}let OC=null;function FC(){return OC||(OC=new UC),OC}function zC({message:e,type:t="error",onClose:n,duration:a=5e3}){const[r,i]=Tt.useState(!0),[s,o]=Tt.useState(100);Tt.useEffect(()=>{if(a>0){const e=Date.now(),t=setInterval(()=>{const r=Date.now()-e,s=Math.max(0,100-r/a*100);o(s),r>=a&&(clearInterval(t),i(!1),null==n||n())},50);return()=>clearInterval(t)}},[a]);return r?Ut.jsxs("div",{className:`error-notification ${t}`,children:[Ut.jsxs("div",{className:"error-content",children:[Ut.jsxs("span",{className:"error-icon",children:["error"===t&&"","warning"===t&&"","info"===t&&""]}),Ut.jsx("span",{className:"error-message",children:e}),Ut.jsx("button",{className:"error-close",onClick:()=>{i(!1),null==n||n()},children:""})]}),Ut.jsx("div",{className:"error-progress",children:Ut.jsx("div",{className:"error-progress-bar",style:{width:`${s}%`}})})]}):null}let BC=0;const HC=new Map;function $C(e,t){const n=`${e}:${t}`,a=Date.now(),r=HC.get(n);for(const[i,s]of HC.entries())a-s>1e4&&HC.delete(i);return!(r&&a-r<1e3)&&(HC.set(n,a),!0)}function VC({notifications:e,onRemove:t}){return Ut.jsx("div",{className:"error-notification-container",children:e.map(e=>Ut.jsx(zC,{message:e.message,type:e.type,onClose:()=>t(e.id)},e.id))})}class WC{constructor(e,t="storyboard-ui"){Le(this,"ws",null),Le(this,"url"),Le(this,"baseUrl"),Le(this,"clientId"),Le(this,"pendingPrompts",new Map),Le(this,"reconnectTimeout",null),Le(this,"statusCallback",null),Le(this,"kayToolMetricsCallback",null),Le(this,"isConnected",!1),Le(this,"kayToolMonitorStarted",!1),Le(this,"reconnectAttempts",0),Le(this,"maxReconnectAttempts",20),Le(this,"minReconnectDelay",1e3),Le(this,"maxReconnectDelay",3e4),Le(this,"isIntentionallyClosed",!1),this.baseUrl=e,this.url=e.replace(/^http/,"ws")+"/ws?clientId="+t,this.clientId=t}connect(){return new Promise((e,t)=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN)e();else{this.cancelReconnect(),this.isIntentionallyClosed=!1;try{this.ws=new WebSocket(this.url),this.ws.onopen=()=>{console.log("[ComfyUI WS] Connected"),this.isConnected=!0,this.reconnectAttempts=0,e()},this.ws.onclose=e=>{console.log(`[ComfyUI WS] Disconnected (code: ${e.code}, reason: ${e.reason||"none"})`),this.isConnected=!1,this.isIntentionallyClosed||this.scheduleReconnect()},this.ws.onerror=e=>{console.error("[ComfyUI WS] Error:",e),this.isConnected=!1,t(e)},this.ws.onmessage=e=>{if(!(e.data instanceof Blob))try{const t=JSON.parse(e.data);this.handleMessage(t)}catch(t){console.error("[ComfyUI WS] Failed to parse message:",t)}}}catch(n){t(n)}}})}disconnect(){this.isIntentionallyClosed=!0,this.cancelReconnect(),this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1,this.reconnectAttempts=0}cancelReconnect(){this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null)}calculateReconnectDelay(){const e=Math.min(this.maxReconnectDelay,this.minReconnectDelay*Math.pow(2,this.reconnectAttempts)),t=.25*Math.random()*e;return Math.floor(e+t)}scheduleReconnect(){if(this.reconnectTimeout)return;if(this.reconnectAttempts>=this.maxReconnectAttempts)return void console.warn(`[ComfyUI WS] Max reconnect attempts (${this.maxReconnectAttempts}) reached. Giving up.`);const e=this.calculateReconnectDelay();this.reconnectAttempts++,console.log(`[ComfyUI WS] Reconnecting in ${e}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),this.reconnectTimeout=window.setTimeout(()=>{this.reconnectTimeout=null,this.connect().catch(e=>{console.error("[ComfyUI WS] Reconnection failed:",e)})},e)}resetReconnectAttempts(){this.reconnectAttempts=0,this.isIntentionallyClosed=!1}handleMessage(e){const{type:t,data:n}=e;switch(this.statusCallback&&!this.isMonitoringEvent(t)&&this.statusCallback({type:t,data:n}),t){case"progress":this.handleProgress(n);break;case"executing":this.handleExecuting(n);break;case"executed":this.handleExecuted(n);break;case"execution_error":this.handleError(n);break;case"execution_start":case"execution_cached":case"status":case"crystools.monitor":case"kikostats.monitor":break;case"kaytool.resources":this.kayToolMetricsCallback&&n&&this.kayToolMetricsCallback(n);break;default:this.isMonitoringEvent(t)||console.log("[ComfyUI WS] Unknown message type:",t)}}isMonitoringEvent(e){return e.includes(".monitor")||e.includes("crystools")||e.includes("kikostats")||"kaytool.resources"===e}handleProgress(e){const{value:t,max:n,prompt_id:a,node:r}=e;console.log("[ComfyUI WS] Progress:",a,t,"/",n,"node:",r);const i=this.pendingPrompts.get(a);if(!i)return void console.warn("[ComfyUI WS] No pending prompt found for:",a);const s=i.executionState,o=i.workflowInfo;let l;r&&r!==s.currentSamplerNodeId?(s.currentSamplerNodeId&&(s.completedSteps+=s.currentPhaseMax,s.completedSamplerPhases.includes(s.currentSamplerNodeId)||s.completedSamplerPhases.push(s.currentSamplerNodeId)),s.currentSamplerNodeId=r,s.currentPhaseMax=n):r&&n>s.currentPhaseMax&&(s.currentPhaseMax=n);let c=1,d=1;if(o&&o.samplerNodeIds.length>1){d=o.samplerNodeIds.length,c=s.completedSamplerPhases.length+1;const e=n*d,a=s.completedSteps+t;l=Math.round(a/e*100)}else l=Math.round(t/n*100);const u=(null==o?void 0:o.nodeTypes[r])||void 0;i.onProgress({value:t,max:n,promptId:a,nodeId:r,overallPercent:l,currentPhase:c,totalPhases:d,currentNodeName:u,nodesExecuted:s.executedNodes.length,totalNodes:null==o?void 0:o.totalNodes})}handleExecuting(e){const{prompt_id:t,node:n}=e;if(console.log("[ComfyUI WS] Executing:",t,"node:",n),null===n){console.log("[ComfyUI WS] Execution complete for:",t);const e=this.pendingPrompts.get(t);e?(console.log("[ComfyUI WS] Calling onCompleted callback"),e.onCompleted(t,null),this.pendingPrompts.delete(t)):console.warn("[ComfyUI WS] No pending prompt found for completion:",t)}else{const e=this.pendingPrompts.get(t);if(e){e.executionState.executedNodes.includes(n)||e.executionState.executedNodes.push(n);const a=e.workflowInfo,r=(null==a?void 0:a.nodeTypes[n])||void 0;a&&e.onProgress({value:0,max:1,promptId:t,nodeId:n,overallPercent:e.executionState.completedSamplerPhases.length>0?Math.round(e.executionState.completedSamplerPhases.length/a.samplerNodeIds.length*100):void 0,currentPhase:e.executionState.completedSamplerPhases.length+1,totalPhases:a.samplerNodeIds.length,currentNodeName:r,nodesExecuted:e.executionState.executedNodes.length,totalNodes:a.totalNodes})}console.log("[ComfyUI WS] Executing node:",n,"for prompt:",t)}}handleExecuted(e){const{prompt_id:t,output:n,node:a}=e;console.log("[ComfyUI WS] Executed node:",a,"for prompt:",t,"output:",n)}handleError(e){const{prompt_id:t,exception_message:n,exception_type:a}=e,r=this.pendingPrompts.get(t);r&&(r.onError(t,`${a}: ${n}`),this.pendingPrompts.delete(t))}trackPrompt(e,t,n,a,r,i){console.log("[ComfyUI WS] Tracking prompt:",e,"for panel:",t,"clientId:",this.clientId),i&&console.log("[ComfyUI WS] Workflow info:",i.totalNodes,"nodes,",i.samplerNodeIds.length,"sampler phases:",i.samplerNodeIds),this.pendingPrompts.set(e,{promptId:e,panelId:t,onProgress:n,onCompleted:a,onError:r,workflowInfo:i,executionState:{executedNodes:[],completedSamplerPhases:[],currentSamplerNodeId:null,completedSteps:0,totalStepsEstimate:0,currentPhaseMax:0}}),console.log("[ComfyUI WS] Pending prompts after add:",Array.from(this.pendingPrompts.keys()))}untrackPrompt(e){this.pendingPrompts.delete(e)}async cancelGeneration(){try{const e=await fetch(`${this.baseUrl}/interrupt`,{method:"POST"});return e.ok?(console.log("[ComfyUI WS] Generation interrupted"),!0):(console.error("[ComfyUI WS] Failed to interrupt:",e.statusText),!1)}catch(e){return console.error("[ComfyUI WS] Error interrupting generation:",e),!1}}onStatus(e){this.statusCallback=e}onKayToolMetrics(e){this.kayToolMetricsCallback=e,e&&!this.kayToolMonitorStarted&&this.startKayToolMonitor()}async startKayToolMonitor(){if(!this.kayToolMonitorStarted)try{const e=await fetch(`${this.baseUrl}/kaytool/start_monitor`,{method:"POST",headers:{"Content-Type":"application/json"}});e.ok?(this.kayToolMonitorStarted=!0,console.log("[KayTool] Monitor started")):console.warn("[KayTool] Failed to start monitor:",e.status)}catch(e){console.warn("[KayTool] Monitor not available:",e)}}async stopKayToolMonitor(){if(this.kayToolMonitorStarted)try{await fetch(`${this.baseUrl}/kaytool/stop_monitor`,{method:"POST",headers:{"Content-Type":"application/json"}}),this.kayToolMonitorStarted=!1,console.log("[KayTool] Monitor stopped")}catch(e){}}get connected(){var e;return this.isConnected&&(null==(e=this.ws)?void 0:e.readyState)===WebSocket.OPEN}getClientId(){return this.clientId}}const GC=new Map;function XC(e,t){const n=`${e}:${t||"storyboard-ui"}`;return GC.has(n)||GC.set(n,new WC(e,t)),GC.get(n)}function qC(e,t){const n=`${e}:${t||"storyboard-ui"}`,a=GC.get(n);a&&(a.disconnect(),GC.delete(n))}function KC(){GC.forEach(e=>e.disconnect()),GC.clear()}const YC=new class{constructor(){Le(this,"nodes",new Map),Le(this,"listeners",new Set),Le(this,"pollingInterval",null),Le(this,"nodeWebSockets",new Map),Le(this,"removedNodeIds",new Set)}async fetchBackendsFromAPI(e){try{const t=await fetch(`${e}/api/backends`);if(!t.ok)return void console.error("[Orchestrator] Failed to fetch backends:",t.status);const n=await t.json();for(const e of n.backends||[]){if(this.removedNodeIds.has(e.id)){console.log(`[Orchestrator] Skipping removed node: ${e.id}`);continue}const t=e.online?"busy"===e.status?"busy":"online":"offline",n={id:e.id,name:e.name,url:`http://${e.host}:${e.port}`,status:t,os:"unknown",gpuName:e.gpu_name||"Unknown",vramTotal:e.gpu_memory_total||0,vramUsed:e.gpu_memory_used||0,gpuUsage:e.gpu_utilization||0,gpuTemp:e.gpu_temperature||0,cpuUsage:e.cpu_utilization||0,ramUsed:e.ram_used||0,ramTotal:e.ram_total||0,lastSeen:e.last_seen?new Date(e.last_seen):new Date,priority:this.nodes.size};this.nodes.set(n.id,n),e.online&&this.connectNodeWebSocket(n)}this.notifyListeners(),this.saveToStorage(),console.log(`[Orchestrator] Loaded ${this.nodes.size} backends from API`)}catch(t){console.error("[Orchestrator] Error fetching backends:",t)}}addNode(e,t,n){const a=n||`node_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;this.removedNodeIds.has(a)&&(this.removedNodeIds.delete(a),console.log(`[Orchestrator] Re-adding previously removed node: ${a}`));const r={id:a,name:t,url:e,status:"offline",os:"unknown",gpuName:"Unknown",vramTotal:0,vramUsed:0,gpuUsage:0,gpuTemp:0,cpuUsage:0,ramUsed:0,ramTotal:0,lastSeen:new Date,priority:this.nodes.size};return this.nodes.set(a,r),this.notifyListeners(),this.pollNode(r),r}removeNode(e){const t=this.nodes.delete(e);return t&&(this.removedNodeIds.add(e),this.saveToStorage(),this.notifyListeners()),t}getNodes(){return Array.from(this.nodes.values())}getAvailableNodes(){return this.getNodes().filter(e=>"online"===e.status||"busy"===e.status).sort((e,t)=>e.priority-t.priority)}getBestNode(){const e=this.getAvailableNodes();return 0===e.length?null:e.filter(e=>"online"===e.status).sort((e,t)=>t.vramTotal-t.vramUsed-(e.vramTotal-e.vramUsed))[0]||e[0]}setNodePriority(e,t){const n=this.nodes.get(e);n&&(n.priority=t,this.notifyListeners())}parseGpuName(e){if(!e)return"Unknown GPU";let t=e.replace(/^cuda:\d+\s+/,"");return t=t.replace(/:\w+Alloc\w*$/,""),t.trim()||"Unknown GPU"}async pollNode(e){var t,n;try{const a=await fetch(`${e.url}/system_stats`,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)});if(a.ok){const r=await a.json(),i=((null==(t=r.system)?void 0:t.os)||"").toLowerCase();i.includes("win")?e.os="windows":i.includes("darwin")||i.includes("mac")?e.os="darwin":i.includes("linux")&&(e.os="linux");const s=null==(n=r.devices)?void 0:n[0];s&&(e.gpuName=this.parseGpuName(s.name||"Unknown GPU"),e.vramTotal=Math.round((s.vram_total||0)/1024/1024),e.vramUsed=Math.round(s.vram_total-s.vram_free||0)/1024/1024,void 0!==s.vram_free&&(e.vramUsed=Math.round((s.vram_total-s.vram_free)/1024/1024))),e.status="online",e.lastSeen=new Date,this.connectNodeWebSocket(e)}else e.status="error"}catch(a){e.status="offline",this.disconnectNodeWebSocket(e.id)}this.nodes.set(e.id,e),this.notifyListeners()}async connectNodeWebSocket(e){if(!this.nodeWebSockets.has(e.id))try{const t=XC(e.url,`orchestrator-${e.id}`);await t.connect(),t.onKayToolMetrics(t=>{this.updateNodeFromKayTool(e.id,t)}),this.nodeWebSockets.set(e.id,t),console.log(`[Orchestrator] WebSocket connected to ${e.name} for KayTool metrics`)}catch(t){console.warn(`[Orchestrator] Failed to connect WebSocket to ${e.name}:`,t)}}disconnectNodeWebSocket(e){const t=this.nodeWebSockets.get(e);t&&(t.stopKayToolMonitor(),t.disconnect(),this.nodeWebSockets.delete(e))}updateNodeFromKayTool(e,t){const n=this.nodes.get(e);if(n){if(n.cpuUsage=t.cpu_percent||0,n.ramTotal=t.ram_total||0,n.ramUsed=t.ram_used||0,t.gpu&&t.gpu.length>0){const e=t.gpu[0];n.gpuName=e.name||n.gpuName,n.gpuUsage=e.load||0,n.gpuTemp=e.temperature||0,n.vramUsed=1024*(e.memory_used||0),n.vramTotal=1024*(e.memory_total||0)}n.lastSeen=new Date,this.nodes.set(e,n),this.notifyListeners()}}startPolling(e=5e3){this.pollingInterval&&clearInterval(this.pollingInterval),this.pollingInterval=window.setInterval(()=>{this.nodes.forEach(e=>{this.pollNode(e)})},e)}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}subscribe(e){return this.listeners.add(e),e(this.getNodes()),()=>{this.listeners.delete(e)}}notifyListeners(){const e=this.getNodes();this.listeners.forEach(t=>t(e))}saveToStorage(){const e=Array.from(this.nodes.values()).map(e=>({id:e.id,name:e.name,url:e.url,priority:e.priority,os:e.os}));localStorage.setItem("orchestrator_nodes",JSON.stringify(e)),localStorage.setItem("orchestrator_removed_nodes",JSON.stringify(Array.from(this.removedNodeIds)))}loadFromStorage(){const e=localStorage.getItem("orchestrator_removed_nodes");if(e)try{const t=JSON.parse(e);this.removedNodeIds=new Set(t),console.log(`[Orchestrator] Loaded ${this.removedNodeIds.size} removed node IDs from storage`)}catch(n){console.error("Failed to load removed node IDs from storage:",n)}const t=localStorage.getItem("orchestrator_nodes");if(t)try{JSON.parse(t).forEach(e=>{if(this.removedNodeIds.has(e.id))return void console.log(`[Orchestrator] Skipping removed node during load: ${e.id}`);const t=this.nodes.get(e.id);if(t)return void(void 0!==e.priority&&(t.priority=e.priority));const n={id:e.id,name:e.name,url:e.url,status:"offline",os:e.os||"unknown",gpuName:"Unknown",vramTotal:0,vramUsed:0,gpuUsage:0,gpuTemp:0,cpuUsage:0,ramUsed:0,ramTotal:0,lastSeen:new Date,priority:e.priority??this.nodes.size};this.nodes.set(e.id,n),this.pollNode(n)}),this.notifyListeners()}catch(n){console.error("Failed to load nodes from storage:",n)}}clearAllNodes(){this.nodes.clear(),this.notifyListeners(),localStorage.removeItem("orchestrator_nodes")}async restartBackend(e,t={}){const n=this.nodes.get(e);if(!n)return{success:!1,message:`Backend ${e} not found`};try{if(console.log(`[Orchestrator] Restarting ComfyUI backend ${e} at ${n.url}`),!1!==t.interrupt_jobs)try{const t=await fetch(`${n.url}/interrupt`,{method:"POST"});t.ok?console.log(`[Orchestrator] Interrupted jobs on ${e}`):console.warn(`[Orchestrator] Interrupt failed for ${e}: ${t.status}`)}catch(a){console.warn(`[Orchestrator] Failed to interrupt ${e}:`,a)}if(!1!==t.free_memory)try{const t=await fetch(`${n.url}/free`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({unload_models:!0,free_memory:!0})});t.ok?console.log(`[Orchestrator] Freed memory on ${e}`):console.warn(`[Orchestrator] Free memory failed for ${e}: ${t.status}`)}catch(a){console.warn(`[Orchestrator] Failed to free memory on ${e}:`,a)}try{const t=await fetch(`${n.url}/system_stats`,{method:"GET"});return t.ok?(console.log(`[Orchestrator] Backend ${e} health check passed`),{success:!0,message:"ComfyUI backend restarted successfully. Jobs interrupted, memory freed."}):{success:!1,message:`Health check failed with status ${t.status}`}}catch(a){return{success:!1,message:`Health check failed: ${a instanceof Error?a.message:"Unknown error"}`}}}catch(r){return console.error(`[Orchestrator] Error restarting backend ${e}:`,r),{success:!1,message:r instanceof Error?r.message:"Unknown error occurred"}}}async restartAllBackends(){const e=this.getNodes(),t=[];for(const n of e)if("online"===n.status||"busy"===n.status){const e=await this.restartBackend(n.id);t.push({backendId:n.id,success:e.success,message:e.message})}return t}async cancelAllGenerations(){const e=this.getNodes(),t=[];for(const a of e)if("busy"===a.status)try{console.log(`[Orchestrator] Cancelling generation on ${a.id} at ${a.url}`);const e=await fetch(`${a.url}/interrupt`,{method:"POST"});e.ok?t.push({backendId:a.id,success:!0,message:"Generation cancelled"}):t.push({backendId:a.id,success:!1,message:`Failed to cancel: HTTP ${e.status}`})}catch(n){t.push({backendId:a.id,success:!1,message:n instanceof Error?n.message:"Unknown error"})}return t}};function JC(){const[e,t]=Tt.useState([]);return Tt.useEffect(()=>YC.subscribe(t),[]),e}
/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ZC=(...e)=>e.filter((e,t,n)=>Boolean(e)&&""!==e.trim()&&n.indexOf(e)===t).join(" ").trim(),QC=e=>{const t=(e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,n)=>n?n.toUpperCase():t.toLowerCase()))(e);return t.charAt(0).toUpperCase()+t.slice(1)};
/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */
/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */
var eE={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};
/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tE=e=>{for(const t in e)if(t.startsWith("aria-")||"role"===t||"title"===t)return!0;return!1},nE=Tt.forwardRef(({color:e="currentColor",size:t=24,strokeWidth:n=2,absoluteStrokeWidth:a,className:r="",children:i,iconNode:s,...o},l)=>Tt.createElement("svg",{ref:l,...eE,width:t,height:t,stroke:e,strokeWidth:a?24*Number(n)/Number(t):n,className:ZC("lucide",r),...!i&&!tE(o)&&{"aria-hidden":"true"},...o},[...s.map(([e,t])=>Tt.createElement(e,t)),...Array.isArray(i)?i:[i]])),aE=(e,t)=>{const n=Tt.forwardRef(({className:n,...a},r)=>{return Tt.createElement(nE,{ref:r,iconNode:t,className:ZC(`lucide-${i=QC(e),i.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`,`lucide-${e}`,n),...a});var i});return n.displayName=QC(e),n},rE=aE("arrow-down-wide-narrow",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M11 4h10",key:"1w87gc"}],["path",{d:"M11 8h7",key:"djye34"}],["path",{d:"M11 12h4",key:"q8tih4"}]]),iE=aE("arrow-right-left",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]),sE=aE("arrow-right",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]]),oE=aE("arrow-up-narrow-wide",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M11 12h4",key:"q8tih4"}],["path",{d:"M11 16h7",key:"uosisv"}],["path",{d:"M11 20h10",key:"jvxblo"}]]),lE=aE("blend",[["circle",{cx:"9",cy:"9",r:"7",key:"p2h5vp"}],["circle",{cx:"15",cy:"15",r:"7",key:"19ennj"}]]),cE=aE("calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]),dE=aE("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]),uE=aE("chevron-down",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]]),hE=aE("chevron-left",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]),pE=aE("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]),mE=aE("chevron-up",[["path",{d:"m18 15-6-6-6 6",key:"153udz"}]]),fE=aE("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]),gE=aE("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),vE=aE("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),yE=aE("clipboard-copy",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2",key:"4jdomd"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v4",key:"3hqy98"}],["path",{d:"M21 14H11",key:"1bme5i"}],["path",{d:"m15 10-4 4 4 4",key:"5dvupr"}]]),xE=aE("clock",[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),bE=aE("columns-2",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M12 3v18",key:"108xh3"}]]),_E=aE("copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),wE=aE("cpu",[["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M17 20v2",key:"1rnc9c"}],["path",{d:"M17 2v2",key:"11trls"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M2 17h2",key:"7oei6x"}],["path",{d:"M2 7h2",key:"asdhe0"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"M20 17h2",key:"1fpfkl"}],["path",{d:"M20 7h2",key:"1o8tra"}],["path",{d:"M7 20v2",key:"4gnj0m"}],["path",{d:"M7 2v2",key:"1i4yhu"}],["rect",{x:"4",y:"4",width:"16",height:"16",rx:"2",key:"1vbyd7"}],["rect",{x:"8",y:"8",width:"8",height:"8",rx:"1",key:"z9xiuo"}]]),SE=aE("crosshair",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"22",x2:"18",y1:"12",y2:"12",key:"l9bcsi"}],["line",{x1:"6",x2:"2",y1:"12",y2:"12",key:"13hhkx"}],["line",{x1:"12",x2:"12",y1:"6",y2:"2",key:"10w3f3"}],["line",{x1:"12",x2:"12",y1:"22",y2:"18",key:"15g9kq"}]]),ME=aE("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]]),CE=aE("external-link",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]),EE=aE("eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),kE=aE("file-image",[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["circle",{cx:"10",cy:"12",r:"2",key:"737tya"}],["path",{d:"m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22",key:"wt3hpn"}]]),TE=aE("file-plus",[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M9 15h6",key:"cctwl0"}],["path",{d:"M12 18v-6",key:"17g6i2"}]]),NE=aE("file-text",[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]),PE=aE("files",[["path",{d:"M15 2h-4a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8",key:"14sh0y"}],["path",{d:"M16.706 2.706A2.4 2.4 0 0 0 15 2v5a1 1 0 0 0 1 1h5a2.4 2.4 0 0 0-.706-1.706z",key:"1970lx"}],["path",{d:"M5 7a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h8a2 2 0 0 0 1.732-1",key:"l4dndm"}]]),jE=aE("film",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M7 3v18",key:"bbkbws"}],["path",{d:"M3 7.5h4",key:"zfgn84"}],["path",{d:"M3 12h18",key:"1i2n21"}],["path",{d:"M3 16.5h4",key:"1230mu"}],["path",{d:"M17 3v18",key:"in4fa5"}],["path",{d:"M17 7.5h4",key:"myr1c1"}],["path",{d:"M17 16.5h4",key:"go4c1d"}]]),AE=aE("folder-input",[["path",{d:"M2 9V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-1",key:"fm4g5t"}],["path",{d:"M2 13h10",key:"pgb2dq"}],["path",{d:"m9 16 3-3-3-3",key:"6m91ic"}]]),RE=aE("folder-open",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]),IE=aE("folder-plus",[["path",{d:"M12 10v6",key:"1bos4e"}],["path",{d:"M9 13h6",key:"1uhe8q"}],["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]]),LE=aE("folder",[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]]),DE=aE("funnel",[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]]),UE=aE("grid-3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]),OE=aE("grip-vertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]),FE=aE("hard-drive",[["line",{x1:"22",x2:"2",y1:"12",y2:"12",key:"1y58io"}],["path",{d:"M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z",key:"oot6mr"}],["line",{x1:"6",x2:"6.01",y1:"16",y2:"16",key:"sgf278"}],["line",{x1:"10",x2:"10.01",y1:"16",y2:"16",key:"1l4acy"}]]),zE=aE("house",[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"r6nss1"}]]),BE=aE("image-plus",[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]]),HE=aE("image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]),$E=aE("info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]),VE=aE("layers",[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]]),WE=aE("layout-grid",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"14",y:"3",rx:"1",key:"6d4xhi"}],["rect",{width:"7",height:"7",x:"14",y:"14",rx:"1",key:"nxv5o0"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}]]),GE=aE("list",[["path",{d:"M3 5h.01",key:"18ugdj"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 19h.01",key:"noohij"}],["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 19h13",key:"m83p4d"}]]),XE=aE("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]),qE=aE("lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]),KE=aE("maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]),YE=aE("menu",[["path",{d:"M4 5h16",key:"1tepv9"}],["path",{d:"M4 12h16",key:"1lakjw"}],["path",{d:"M4 19h16",key:"1djgab"}]]),JE=aE("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]]),ZE=aE("minimize",[["path",{d:"M8 3v3a2 2 0 0 1-2 2H3",key:"hohbtr"}],["path",{d:"M21 8h-3a2 2 0 0 1-2-2V3",key:"5jw1f3"}],["path",{d:"M3 16h3a2 2 0 0 1 2 2v3",key:"198tvr"}],["path",{d:"M16 21v-3a2 2 0 0 1 2-2h3",key:"ph8mxp"}]]),QE=aE("monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]),ek=aE("octagon-x",[["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"M2.586 16.726A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2h6.624a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586z",key:"2d38gg"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),tk=aE("palette",[["path",{d:"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z",key:"e79jfc"}],["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}]]),nk=aE("panel-right-close",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M15 3v18",key:"14nvp0"}],["path",{d:"m8 9 3 3-3 3",key:"12hl5m"}]]),ak=aE("panel-right",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M15 3v18",key:"14nvp0"}]]),rk=aE("pen-line",[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]),ik=aE("pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),sk=aE("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),ok=aE("power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]),lk=aE("printer",[["path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2",key:"143wyd"}],["path",{d:"M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6",key:"1itne7"}],["rect",{x:"6",y:"14",width:"12",height:"8",rx:"1",key:"1ue0tg"}]]),ck=aE("refresh-cw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),dk=aE("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]),uk=aE("save-all",[["path",{d:"M10 2v3a1 1 0 0 0 1 1h5",key:"1xspal"}],["path",{d:"M18 18v-6a1 1 0 0 0-1-1h-6a1 1 0 0 0-1 1v6",key:"1ra60u"}],["path",{d:"M18 22H4a2 2 0 0 1-2-2V6",key:"pblm9e"}],["path",{d:"M8 18a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9.172a2 2 0 0 1 1.414.586l2.828 2.828A2 2 0 0 1 22 6.828V16a2 2 0 0 1-2.01 2z",key:"1yve0x"}]]),hk=aE("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),pk=aE("scan-search",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"m16 16-1.9-1.9",key:"1dq9hf"}]]),mk=aE("search",[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]]),fk=aE("server",[["rect",{width:"20",height:"8",x:"2",y:"2",rx:"2",ry:"2",key:"ngkwjq"}],["rect",{width:"20",height:"8",x:"2",y:"14",rx:"2",ry:"2",key:"iecqi9"}],["line",{x1:"6",x2:"6.01",y1:"6",y2:"6",key:"16zg32"}],["line",{x1:"6",x2:"6.01",y1:"18",y2:"18",key:"nzw8ys"}]]),gk=aE("settings",[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),vk=aE("square-check-big",[["path",{d:"M21 10.656V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h12.344",key:"2acyp4"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),yk=aE("square-x",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),xk=aE("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),bk=aE("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]),_k=aE("tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),wk=aE("tags",[["path",{d:"M13.172 2a2 2 0 0 1 1.414.586l6.71 6.71a2.4 2.4 0 0 1 0 3.408l-4.592 4.592a2.4 2.4 0 0 1-3.408 0l-6.71-6.71A2 2 0 0 1 6 9.172V3a1 1 0 0 1 1-1z",key:"16rjxf"}],["path",{d:"M2 7v6.172a2 2 0 0 0 .586 1.414l6.71 6.71a2.4 2.4 0 0 0 3.191.193",key:"178nd4"}],["circle",{cx:"10.5",cy:"6.5",r:".5",fill:"currentColor",key:"12ikhr"}]]),Sk=aE("toggle-left",[["circle",{cx:"9",cy:"12",r:"3",key:"u3jwor"}],["rect",{width:"20",height:"14",x:"2",y:"5",rx:"7",key:"g7kal2"}]]),Mk=aE("toggle-right",[["circle",{cx:"15",cy:"12",r:"3",key:"1afu0r"}],["rect",{width:"20",height:"14",x:"2",y:"5",rx:"7",key:"g7kal2"}]]),Ck=aE("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]]),Ek=aE("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),kk=aE("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]),Tk=aE("workflow",[["rect",{width:"8",height:"8",x:"3",y:"3",rx:"2",key:"by2w9f"}],["path",{d:"M7 11v4a2 2 0 0 0 2 2h4",key:"xkn7yn"}],["rect",{width:"8",height:"8",x:"13",y:"13",rx:"2",key:"1cgmvn"}]]),Nk=aE("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),Pk=aE("zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]),jk=aE("zoom-in",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]),Ak=aE("zoom-out",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]]);
/**
 * @license lucide-react v0.563.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function Rk({onClose:e,onRestartNodes:t}){const n=JC(),[a,r]=Tt.useState(""),[i,s]=Tt.useState(""),[o,l]=Tt.useState(!1),[c,d]=Tt.useState(new Set),[u,h]=Tt.useState(!1),p=e=>e>=1024?`${(e/1024).toFixed(1)} GB`:`${e} MB`,m=e=>{switch(e){case"online":return"#4dff6d";case"busy":return"#ffcc00";case"error":return"#ff4444";default:return"#666"}};return Ut.jsx("div",{className:"node-manager-overlay",children:Ut.jsxs("div",{className:"node-manager-modal",children:[Ut.jsxs("div",{className:"node-manager-header",children:[Ut.jsx("h2",{children:"Render Nodes"}),Ut.jsxs("div",{className:"header-actions",children:[c.size>0&&Ut.jsxs("button",{className:"restart-selected-btn",onClick:async()=>{if(0!==c.size){h(!0);try{if(t)await t(Array.from(c));else for(const e of c)await YC.restartBackend(e);d(new Set)}catch(e){console.error("Failed to restart nodes:",e)}finally{h(!1)}}else alert("Please select at least one node to restart")},disabled:u,title:`Restart ${c.size} selected node(s)`,children:[Ut.jsx(ck,{size:16,className:u?"spinning":""}),Ut.jsx("span",{children:u?"Restarting...":`Restart ${c.size}`})]}),Ut.jsx("button",{className:"close-btn",onClick:e,children:""})]})]}),Ut.jsxs("div",{className:"node-manager-content",children:[Ut.jsxs("div",{className:"add-node-form",children:[Ut.jsx("input",{type:"text",placeholder:"Node Name (e.g., 5090-Node-1)",value:i,onChange:e=>s(e.target.value)}),Ut.jsx("input",{type:"text",placeholder:"ComfyUI URL (e.g., http://192.168.1.100:8188)",value:a,onChange:e=>r(e.target.value)}),Ut.jsx("button",{onClick:()=>{a&&i&&(YC.addNode(a,i),YC.saveToStorage(),r(""),s(""))},disabled:!a||!i,children:"Add Node"})]}),Ut.jsx("div",{className:"polling-control",children:Ut.jsx("button",{className:"polling-btn "+(o?"active":""),onClick:()=>{o?YC.stopPolling():(YC.startPolling(5e3),n.forEach(e=>YC.pollNode(e))),l(!o)},children:o?" Stop Monitoring":" Start Monitoring"})}),Ut.jsxs("div",{className:"node-list",children:[n.length>0&&Ut.jsx("div",{className:"select-all-row",children:Ut.jsxs("label",{className:"checkbox-label",children:[Ut.jsx("input",{type:"checkbox",checked:c.size===n.length&&n.length>0,onChange:()=>{c.size===n.length?d(new Set):d(new Set(n.map(e=>e.id)))}}),Ut.jsxs("span",{children:["Select All (",c.size,"/",n.length,")"]})]})}),0===n.length?Ut.jsx("p",{className:"no-nodes",children:"No render nodes configured. Add nodes to distribute rendering."}):n.map(e=>Ut.jsxs("div",{className:"node-card "+(c.has(e.id)?"selected":""),children:[Ut.jsxs("div",{className:"node-header",children:[Ut.jsxs("div",{className:"node-info",children:[Ut.jsx("label",{className:"checkbox-label node-checkbox",children:Ut.jsx("input",{type:"checkbox",checked:c.has(e.id),onChange:()=>(e=>{const t=new Set(c);t.has(e)?t.delete(e):t.add(e),d(t)})(e.id)})}),Ut.jsx("span",{className:"node-name",children:e.name}),Ut.jsxs("span",{className:"node-status",style:{color:m(e.status)},children:[" ",e.status.toUpperCase()]})]}),Ut.jsx("button",{className:"remove-btn",onClick:()=>{return t=e.id,YC.removeNode(t),void YC.saveToStorage();var t},children:"Remove"})]}),Ut.jsx("div",{className:"node-url",children:e.url}),"offline"!==e.status&&"Unknown"!==e.gpuName&&Ut.jsxs("div",{className:"node-stats",children:[Ut.jsxs("div",{className:"stat-row",children:[Ut.jsx("span",{className:"stat-label",children:"GPU:"}),Ut.jsx("span",{className:"stat-value",children:e.gpuName})]}),Ut.jsxs("div",{className:"stat-row",children:[Ut.jsx("span",{className:"stat-label",children:"VRAM:"}),Ut.jsxs("span",{className:"stat-value",children:[p(e.vramUsed)," / ",p(e.vramTotal)," ",Ut.jsxs("span",{className:"vram-percent",children:["(",e.vramTotal>0?Math.round(e.vramUsed/e.vramTotal*100):0,"%)"]})]})]}),Ut.jsxs("div",{className:"stat-row",children:[Ut.jsx("span",{className:"stat-label",children:"GPU Usage:"}),Ut.jsxs("span",{className:"stat-value",children:[e.gpuUsage,"%"]})]}),Ut.jsx("div",{className:"vram-bar",children:Ut.jsx("div",{className:"vram-fill",style:{width:(e.vramTotal>0?e.vramUsed/e.vramTotal*100:0)+"%"}})})]})]},e.id))]})]})]})})}const Ik="storyboard_recent_projects";function Lk(){try{const e=localStorage.getItem(Ik);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function Dk(e,t){const n=Lk(),a=Math.max(t.lastIndexOf("/"),t.lastIndexOf("\\")),r=a>0?t.substring(0,a):t,i=n.filter(e=>e.path.toLowerCase()!==t.toLowerCase());i.unshift({name:e||r.split("/").pop()||"Untitled",path:t,projectDir:r,lastOpened:(new Date).toISOString()}),localStorage.setItem(Ik,JSON.stringify(i.slice(0,10)))}function Uk({onProjectSettings:e,onPathMappings:t,onSaveProject:n,onSaveProjectAs:a,onLoadProject:r,onLoadRecentProject:i,onManageNodes:s,onNewProject:o,onRestartNodes:l,onCancelGenerations:c,onPrintStoryboard:d,nodeCount:u,projectName:h,isSaving:p,isLoading:m,isRestarting:f,isGenerating:g}){const[v,y]=Tt.useState(!1),[x,b]=Tt.useState(!1),[_,w]=Tt.useState([]),S=Tt.useRef(null),M=Tt.useRef(null);Tt.useEffect(()=>{v?w(Lk()):b(!1)},[v]),Tt.useEffect(()=>{const e=e=>{S.current&&!S.current.contains(e.target)&&y(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),Tt.useEffect(()=>{const e=e=>{"Escape"===e.key&&y(!1)};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[]);const C=navigator.platform.toUpperCase().indexOf("MAC")>=0?"":"Ctrl",E=Tt.useCallback(()=>{M.current&&clearTimeout(M.current),b(!0)},[]),k=Tt.useCallback(()=>{M.current=setTimeout(()=>b(!1),200)},[]),T=Tt.useCallback((e,t)=>{e.stopPropagation(),function(e){const t=Lk().filter(t=>t.path.toLowerCase()!==e.toLowerCase());localStorage.setItem(Ik,JSON.stringify(t))}(t),w(Lk())},[]),N=Tt.useCallback(e=>{try{const t=new Date(e),n=(new Date).getTime()-t.getTime(),a=Math.floor(n/6e4);if(a<1)return"Just now";if(a<60)return`${a}m ago`;const r=Math.floor(a/60);if(r<24)return`${r}h ago`;const i=Math.floor(r/24);return i<7?`${i}d ago`:t.toLocaleDateString()}catch{return""}},[]);return Ut.jsxs("div",{className:"main-menu",ref:S,children:[Ut.jsxs("button",{className:"main-menu-trigger "+(v?"active":""),onClick:()=>y(!v),children:[Ut.jsx(YE,{size:18}),Ut.jsx("span",{className:"project-name",children:h||"Untitled Project"}),Ut.jsx(uE,{size:14,className:"chevron "+(v?"rotated":"")})]}),v&&Ut.jsxs("div",{className:"main-menu-dropdown",children:[Ut.jsxs("div",{className:"menu-section",children:[Ut.jsx("div",{className:"menu-section-title",children:"Project"}),Ut.jsxs("button",{className:"menu-item",onClick:()=>{o(),y(!1)},children:[Ut.jsx(TE,{size:16}),Ut.jsx("span",{children:"New Project"}),Ut.jsxs("span",{className:"menu-shortcut",children:[C,"+N"]})]}),Ut.jsxs("button",{className:"menu-item",onClick:()=>{r(),y(!1)},disabled:m,children:[Ut.jsx(AE,{size:16}),Ut.jsx("span",{children:m?"Loading...":"Load Project"}),Ut.jsxs("span",{className:"menu-shortcut",children:[C,"+O"]})]}),i&&Ut.jsxs("div",{className:"menu-item-with-submenu",onMouseEnter:E,onMouseLeave:k,children:[Ut.jsxs("button",{className:"menu-item "+(x?"menu-item--active":""),disabled:m||0===_.length,children:[Ut.jsx(xE,{size:16}),Ut.jsx("span",{children:"Recent Projects"}),Ut.jsx(pE,{size:14,className:"menu-submenu-arrow"})]}),x&&_.length>0&&Ut.jsxs("div",{className:"menu-submenu",children:[_.map(e=>Ut.jsxs("button",{className:"menu-submenu-item",title:e.projectDir,onClick:()=>{i(e.path),y(!1)},children:[Ut.jsxs("div",{className:"menu-recent-info",children:[Ut.jsx("span",{className:"menu-recent-name",children:e.name}),Ut.jsx("span",{className:"menu-recent-path",children:e.projectDir})]}),Ut.jsx("span",{className:"menu-recent-date",children:N(e.lastOpened)}),Ut.jsx("button",{className:"menu-recent-remove",title:"Remove from recents",onClick:t=>T(t,e.path),children:Ut.jsx(Nk,{size:12})})]},e.path)),Ut.jsx("div",{className:"menu-submenu-divider"}),Ut.jsx("button",{className:"menu-submenu-item menu-submenu-item--clear",onClick:()=>{localStorage.removeItem(Ik),w([])},children:"Clear Recent Projects"})]})]}),Ut.jsxs("button",{className:"menu-item",onClick:()=>{n(),y(!1)},disabled:p,children:[Ut.jsx(hk,{size:16}),Ut.jsx("span",{children:p?"Saving...":"Save Project"}),Ut.jsxs("span",{className:"menu-shortcut",children:[C,"+S"]})]}),a&&Ut.jsxs("button",{className:"menu-item",onClick:()=>{a(),y(!1)},disabled:p,children:[Ut.jsx(uk,{size:16}),Ut.jsx("span",{children:"Save As..."}),Ut.jsxs("span",{className:"menu-shortcut",children:[C,"++S"]})]}),Ut.jsxs("button",{className:"menu-item",onClick:()=>{e(),y(!1)},children:[Ut.jsx(gk,{size:16}),Ut.jsx("span",{children:"Project Settings"}),Ut.jsxs("span",{className:"menu-shortcut",children:[C,"+,"]})]}),t&&Ut.jsxs("button",{className:"menu-item",onClick:()=>{t(),y(!1)},children:[Ut.jsx(iE,{size:16}),Ut.jsx("span",{children:"Path Mappings"})]}),d&&Ut.jsxs("button",{className:"menu-item",onClick:()=>{d(),y(!1)},children:[Ut.jsx(lk,{size:16}),Ut.jsx("span",{children:"Print Storyboard"}),Ut.jsxs("span",{className:"menu-shortcut",children:[C,"+P"]})]})]}),Ut.jsx("div",{className:"menu-divider"}),Ut.jsxs("div",{className:"menu-section",children:[Ut.jsx("div",{className:"menu-section-title",children:"System"}),Ut.jsxs("button",{className:"menu-item",onClick:()=>{s(),y(!1)},children:[Ut.jsx(fk,{size:16}),Ut.jsx("span",{children:"Manage Nodes"}),Ut.jsx("span",{className:"menu-badge",children:u})]}),l&&Ut.jsxs("button",{className:"menu-item",onClick:()=>{l(),y(!1)},disabled:f||0===u,title:0===u?"No nodes available to restart":"Restart all ComfyUI backends",children:[Ut.jsx(ck,{size:16,className:f?"spinning":""}),Ut.jsx("span",{children:f?"Restarting...":"Restart Nodes"})]}),c&&Ut.jsxs("button",{className:"menu-item cancel-btn",onClick:()=>{c(),y(!1)},disabled:!g,title:g?"Cancel all running generations":"No generations running",children:[Ut.jsx(ek,{size:16}),Ut.jsx("span",{children:"Cancel All Generations"})]})]})]})]})}function Ok({options:e,onChange:t,placeholder:n="Select options...",title:a}){const[r,i]=Tt.useState(!1),s=Tt.useRef(null),o=e.filter(e=>e.selected).length,l=o===e.length,c=0===o;Tt.useEffect(()=>{const e=e=>{s.current&&!s.current.contains(e.target)&&i(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);return Ut.jsxs("div",{className:"multiselect-dropdown",ref:s,children:[a&&Ut.jsx("div",{className:"multiselect-title",children:a}),Ut.jsxs("button",{className:"multiselect-trigger "+(r?"open":""),onClick:()=>i(!r),type:"button",children:[Ut.jsx("span",{className:"multiselect-label",children:(()=>{if(c)return n;if(l)return`All (${e.length})`;if(1===o){const t=e.find(e=>e.selected);return(null==t?void 0:t.label)||"1 selected"}return`${o} selected`})()}),Ut.jsx(uE,{size:14,className:"chevron "+(r?"rotated":"")})]}),r&&Ut.jsxs("div",{className:"multiselect-menu",children:[Ut.jsxs("div",{className:"multiselect-actions",children:[Ut.jsx("button",{className:"action-btn",onClick:()=>{t(e.map(e=>e.id))},disabled:l,children:"Select All"}),Ut.jsx("button",{className:"action-btn",onClick:()=>{t([])},disabled:c,children:"Clear"})]}),Ut.jsx("div",{className:"multiselect-divider"}),Ut.jsx("div",{className:"multiselect-options",children:e.map(n=>Ut.jsxs("button",{className:"multiselect-option "+(n.selected?"selected":""),onClick:()=>(n=>{const a=e.map(e=>e.id===n?{...e,selected:!e.selected}:e).filter(e=>e.selected).map(e=>e.id);t(a)})(n.id),children:[Ut.jsx("span",{className:"option-check",children:n.selected&&Ut.jsx(dE,{size:14})}),Ut.jsx("span",{className:"option-label",children:n.label})]},n.id))})]})]})}function Fk({selectedBackendIds:e,onSelectionChange:t,maxSelections:n=10,disabled:a=!1,className:r=""}){const i=JC(),[s,o]=Tt.useState(()=>"true"===localStorage.getItem("multiNodeSelector_collapsed"));Tt.useEffect(()=>{localStorage.setItem("multiNodeSelector_collapsed",s.toString())},[s]);const l=[...i.filter(e=>"online"===e.status||"busy"===e.status)].sort((e,t)=>e.priority!==t.priority?e.priority-t.priority:e.name.localeCompare(t.name)),c=e=>{switch(e.status){case"online":return Ut.jsx(ok,{className:"status-icon online",size:10});case"busy":return Ut.jsx(XE,{className:"status-icon busy",size:10});case"error":return Ut.jsx(fE,{className:"status-icon error",size:10});default:return Ut.jsx(ok,{className:"status-icon offline",size:10})}},d=e=>e>=1024?`${(e/1024).toFixed(1)} GB`:`${e} MB`,u=e.length>1,h=e.length>=n,p=l.length>0&&e.length===l.length;return Ut.jsxs("div",{className:`multi-node-selector ${r} ${s?"collapsed":""}`,children:[Ut.jsxs("div",{className:"selector-header",children:[Ut.jsxs("div",{className:"selector-label",children:[Ut.jsx(wE,{size:14}),Ut.jsx("span",{children:"Target Nodes"}),Ut.jsxs("span",{className:"selection-count",children:["(",e.length,"/",l.length,")"]})]}),Ut.jsxs("div",{className:"selector-actions",children:[!s&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("button",{type:"button",className:"action-btn select-all",onClick:()=>{a||t(l.slice(0,n).map(e=>e.id))},disabled:a||p||0===l.length,title:"Select all available nodes",children:[Ut.jsx(dE,{size:12}),"All"]}),Ut.jsxs("button",{type:"button",className:"action-btn clear-all",onClick:()=>{a||t([])},disabled:a||0===e.length,title:"Clear all selections",children:[Ut.jsx(Nk,{size:12}),"Clear"]})]}),Ut.jsx("button",{type:"button",className:"action-btn collapse-toggle",onClick:()=>o(!s),title:s?"Expand node selector":"Collapse node selector",children:s?Ut.jsx(uE,{size:12}):Ut.jsx(mE,{size:12})})]})]}),!s&&Ut.jsx("div",{className:"node-chips-container",children:0===l.length?Ut.jsxs("div",{className:"no-nodes-message",children:[Ut.jsx(fE,{size:16}),Ut.jsx("span",{children:"No render nodes available"}),Ut.jsx("span",{className:"hint",children:"Add nodes in the Node Manager to enable parallel generation"})]}):Ut.jsx("div",{className:"node-chips",children:l.map(r=>{const i=e.includes(r.id),s=(e=>{switch(e.status){case"online":return"online";case"busy":return"busy";case"error":return"error";default:return"offline"}})(r);return Ut.jsxs("button",{type:"button",className:`node-chip ${i?"selected":""} ${s} ${a?"disabled":""}`,onClick:()=>{return i=r.id,void(a||(e.includes(i)?t(e.filter(e=>e!==i)):e.length<n&&t([...e,i])));var i},disabled:a||!i&&h,title:`${r.name} - ${r.gpuName} - ${d(r.vramTotal)} VRAM`,children:[c(r),Ut.jsx("span",{className:"node-name",children:r.name}),i&&Ut.jsx("span",{className:"selection-indicator",children:Ut.jsx(dE,{size:10})}),r.vramTotal>0&&Ut.jsx("span",{className:"vram-badge",children:d(r.vramTotal)})]},r.id)})})}),!s&&u&&Ut.jsxs("div",{className:"parallel-hint",children:[Ut.jsx(Pk,{size:12}),Ut.jsxs("span",{children:[Ut.jsx("strong",{children:e.length})," parallel generations with unique seeds"]})]}),!s&&h&&Ut.jsxs("div",{className:"max-selection-warning",children:[Ut.jsx(fE,{size:10}),Ut.jsxs("span",{children:["Maximum ",n," nodes can be selected"]})]})]})}const zk=({isOpen:e,onClose:t,workflows:n,onUpdateWorkflow:a})=>{const[r,i]=Tt.useState(null),[s,o]=Tt.useState([]),[l,c]=Tt.useState(""),d=Tt.useCallback(e=>{i(e),o(e.categories||[])},[]),u=Tt.useCallback(e=>{o(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},[]),h=Tt.useCallback(()=>{r&&a({...r,categories:s})},[r,s,a]),p=n.filter(e=>e.name.toLowerCase().includes(l.toLowerCase())||e.description.toLowerCase().includes(l.toLowerCase())),m=e=>({"Image Generation":"#3d8b6e","Text to Image":"#4a7aa8","Image to Image":"#8b5a7a",InPainting:"#9b7a4a","Image Editing":"#7a6a9a",Upscaling:"#8a8a4a","Video Generation":"#9a5a5a"}[e]||"#6a7a8a");return e?Ut.jsx("div",{className:"workflow-categories-modal-overlay",onClick:t,children:Ut.jsxs("div",{className:"workflow-categories-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"modal-header",children:[Ut.jsxs("h2",{children:[Ut.jsx(wk,{size:20})," Manage Workflow Categories"]}),Ut.jsx("button",{className:"close-btn",onClick:t,children:Ut.jsx(Nk,{size:20})})]}),Ut.jsxs("div",{className:"modal-content",children:[Ut.jsxs("div",{className:"workflows-list-section",children:[Ut.jsx("div",{className:"search-box",children:Ut.jsx("input",{type:"text",placeholder:"Search workflows...",value:l,onChange:e=>c(e.target.value)})}),Ut.jsx("div",{className:"workflows-list",children:p.map(e=>{var t,n;return Ut.jsxs("div",{className:"workflow-item "+((null==r?void 0:r.id)===e.id?"selected":""),onClick:()=>d(e),children:[Ut.jsxs("div",{className:"workflow-info",children:[Ut.jsx("div",{className:"workflow-name",children:e.name}),Ut.jsx("div",{className:"workflow-description",children:e.description})]}),Ut.jsxs("div",{className:"workflow-categories-preview",children:[null==(t=e.categories)?void 0:t.map(e=>Ut.jsx("span",{className:"category-tag",style:{backgroundColor:m(e)},children:e},e)),!(null==(n=e.categories)?void 0:n.length)&&Ut.jsx("span",{className:"no-categories",children:"No categories"})]})]},e.id)})})]}),Ut.jsx("div",{className:"categories-section",children:r?Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("h3",{children:["Assign Categories to: ",r.name]}),Ut.jsx("p",{className:"help-text",children:"Select all categories that apply to this workflow. A workflow can have multiple categories."}),Ut.jsx("div",{className:"categories-grid",children:bR.map(e=>Ut.jsxs("button",{className:"category-btn "+(s.includes(e)?"selected":""),onClick:()=>u(e),style:{borderColor:m(e),backgroundColor:s.includes(e)?`${m(e)}20`:"transparent"},children:[Ut.jsx("span",{className:"category-indicator",style:{backgroundColor:m(e)}}),Ut.jsx("span",{className:"category-name",children:e}),s.includes(e)&&Ut.jsx(dE,{size:16,className:"check-icon"})]},e))}),Ut.jsxs("div",{className:"selected-categories-summary",children:[Ut.jsx("h4",{children:"Selected Categories:"}),Ut.jsxs("div",{className:"selected-tags",children:[s.map(e=>Ut.jsx("span",{className:"selected-tag",style:{backgroundColor:m(e)},children:e},e)),!s.length&&Ut.jsx("span",{className:"no-selection",children:"No categories selected"})]})]}),Ut.jsxs("div",{className:"modal-actions",children:[Ut.jsx("button",{className:"save-btn",onClick:h,children:"Save Categories"}),Ut.jsx("button",{className:"cancel-btn",onClick:()=>i(null),children:"Cancel"})]})]}):Ut.jsxs("div",{className:"no-selection-message",children:[Ut.jsx(wk,{size:48}),Ut.jsx("p",{children:"Select a workflow from the list to assign categories"})]})})]})]})}):null},Bk=[".mp4",".mov",".avi",".webm",".mkv",".flv",".wmv"],Hk=[".gif",".webp",".apng"];function $k(e){const t=e.toLowerCase().substring(e.lastIndexOf("."));return Bk.includes(t)?"video":Hk.includes(t)?"animated":"image"}function Vk(e){try{const t=new URL(e,"http://localhost");return"video"===$k(t.searchParams.get("filename")||t.searchParams.get("path")||e)}catch{const t=e.toLowerCase().substring(e.lastIndexOf("."));return Bk.includes(t)}}function Wk(e,t){const n=[],a=["images","gifs","videos"];for(const r of a){const a=e[r];if(a&&Array.isArray(a)&&0!==a.length)for(const e of a){if(!e.filename)continue;const a=$k(e.filename);n.push({filename:e.filename,subfolder:e.subfolder||"",type:e.type||"output",url:`${t}/view?filename=${encodeURIComponent(e.filename)}&subfolder=${encodeURIComponent(e.subfolder||"")}&type=${e.type||"output"}`,mediaType:a})}}return n}function Gk(){return"undefined"!=typeof window?`${window.location.protocol}//${window.location.hostname}:9820`:"http://localhost:9820"}function Xk(e){if(!e)return e;try{const t=new URL(e);if("8020"===t.port)return t.port="9820",t.toString().replace(/\/$/,"")}catch{}return e.replace(/:8020(\b|\/)/,":9820$1")}const qk={name:"Untitled Project",path:"",namingTemplate:"{project}_Panel{panel}_{version}",autoSave:!1,orchestratorUrl:Gk(),created:new Date,lastModified:new Date};const Kk=new class{constructor(){Le(this,"currentProject",{...qk}),Le(this,"storageKey","storyboard_project_settings"),this.loadFromStorage(),this.saveToStorage()}normalizePath(e){return e.replace(/\\/g,"/")}getProject(){return{...this.currentProject}}setProject(e){this.currentProject={...this.currentProject,...e,lastModified:new Date},this.saveToStorage(),this.syncProjectWithBackend()}async syncProjectWithBackend(){const e=this.currentProject.orchestratorUrl;if(e)try{const t=await fetch(`${e}/api/project`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project:{name:this.currentProject.name,path:this.normalizePath(this.currentProject.path),naming_template:this.currentProject.namingTemplate,orchestrator_url:this.currentProject.orchestratorUrl,auto_save:this.currentProject.autoSave}})});t.ok?console.log("[ProjectManager] Project synced with backend"):console.warn("[ProjectManager] Failed to sync project with backend:",t.status)}catch(t){console.warn("[ProjectManager] Error syncing project:",t)}}resetProject(){this.currentProject={...qk,created:new Date,lastModified:new Date},this.saveToStorage()}getExtensionFromUrl(e){try{const t=new URL(e,"http://localhost").searchParams.get("filename");if(t){const e=t.lastIndexOf(".");if(e>=0)return t.substring(e).toLowerCase()}}catch{const t=e.lastIndexOf(".");if(t>=0){const n=e.substring(t).split(/[?#]/)[0].toLowerCase();if(n.length<=6)return n}}return".png"}generateFilename(e,t,n){const a=new Date,r=(e,t=2)=>e.toString().padStart(t,"0"),i={"{project}":this.sanitizeFilename(this.currentProject.name),"{panel}":r(e),"{version}":`v${r(t,3)}`,"{timestamp}":`${a.getFullYear()}${r(a.getMonth()+1)}${r(a.getDate())}_${r(a.getHours())}${r(a.getMinutes())}${r(a.getSeconds())}`,"{date}":`${a.getFullYear()}${r(a.getMonth()+1)}${r(a.getDate())}`,"{time}":`${r(a.getHours())}${r(a.getMinutes())}${r(a.getSeconds())}`,"{seed}":(n.seed??0).toString(),"{workflow}":this.sanitizeFilename(n.workflowName??"unknown")};let s=this.currentProject.namingTemplate;for(const[o,l]of Object.entries(i))s=s.split(o).join(l);return s=(null==n?void 0:n.nodeName)?s.replace("{node}",n.nodeName.replace(/[^a-zA-Z0-9-_]/g,"_")):s.replace("_{node}","").replace("{node}_","").replace("{node}",""),s}async validateProjectPath(e,t){if(!e||""===e.trim())return{valid:!1,exists:!1,message:"Path is required"};try{const n=await fetch(`${t}/api/browse-folders?path=${encodeURIComponent(e)}`);if(!n.ok)return{valid:!1,exists:!1,message:"Path does not exist"};const a=await n.json();return!1===a.success?{valid:!1,exists:!1,message:a.error||"Path does not exist"}:{valid:!0,exists:!0,message:"Path is valid"}}catch(n){return{valid:!1,exists:!1,message:`Cannot validate path: ${n}`}}}sanitizeFilename(e){return e.replace(/[<>:"/\\|?*]/g,"_").replace(/\s+/g,"_").substring(0,50)}splitTemplateParts(){const e=this.currentProject.namingTemplate,t=e.replace(/\\/g,"/");if(t.includes("/")){const e=t.lastIndexOf("/");return{folder:t.substring(0,e),filename:t.substring(e+1)}}return{folder:null,filename:e}}resolvePanelFolder(e,t){const n=this.sanitizeFilename(e),a=this.normalizePath(this.currentProject.path),{folder:r}=this.splitTemplateParts();if(r){const e={"{project}":this.sanitizeFilename(this.currentProject.name),"{panel}":n,"{workflow}":this.sanitizeFilename((null==t?void 0:t.workflowName)??"unknown")};let i=r;for(const[t,n]of Object.entries(e))i=i.split(t).join(n);return`${a}/${i}`}return`${a}/${n}`}generateFilenameForPanel(e,t,n){const a=new Date,r=(e,t=2)=>e.toString().padStart(t,"0"),i=this.sanitizeFilename(e),s={"{project}":this.sanitizeFilename(this.currentProject.name),"{panel}":i,"{version}":`v${r(t,3)}`,"{timestamp}":`${a.getFullYear()}${r(a.getMonth()+1)}${r(a.getDate())}_${r(a.getHours())}${r(a.getMinutes())}${r(a.getSeconds())}`,"{date}":`${a.getFullYear()}${r(a.getMonth()+1)}${r(a.getDate())}`,"{time}":`${r(a.getHours())}${r(a.getMinutes())}${r(a.getSeconds())}`,"{seed}":(n.seed??0).toString(),"{workflow}":this.sanitizeFilename(n.workflowName??"unknown")},{filename:o}=this.splitTemplateParts();let l=o;for(const[c,d]of Object.entries(s))l=l.split(c).join(d);return l=(null==n?void 0:n.nodeName)?l.replace("{node}",n.nodeName.replace(/[^a-zA-Z0-9-_]/g,"_")):l.replace("_{node}","").replace("{node}_","").replace("{node}",""),l}createHistoryEntry(e,t,n,a,r,i,s,o){const l=this.extractSeed(s),c=this.extractPromptSummary(s),d={timestamp:new Date,workflowId:a,workflowName:r,seed:l,promptSummary:c,parameters:{...s},workflow:{...i},sourceUrl:e,version:n,generationTime:o};return{id:`${t}_${n}_${Date.now()}`,url:e,metadata:d}}extractSeed(e){const t=["seed","noise_seed","Seed","random_seed"];for(const n of t){if("number"==typeof e[n])return e[n];for(const[t,a]of Object.entries(e))if(t.startsWith(n)&&"number"==typeof a)return a}return-1}extractPromptSummary(e){const t=["positive_prompt","prompt","text","positive"];for(const n of t){if("string"==typeof e[n])return e[n];for(const[t,a]of Object.entries(e))if(t.startsWith(n)&&"string"==typeof a)return a}return""}async saveToProjectFolder(e,t,n,a,r){const i=this.currentProject.orchestratorUrl;if(!this.currentProject.path)return{success:!1,error:"No project folder configured. Set a folder path in Project Settings."};if(!i)return{success:!1,error:"No Orchestrator URL configured. Set it in Project Settings."};const s=r?this.resolvePanelFolder(r):this.currentProject.path,o=this.getExtensionFromUrl(e),l=(r?this.generateFilenameForPanel(r,n,a):this.generateFilename(t,n,a))+o;try{const t=await fetch(`${i}/api/save-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_url:e,folder_path:this.normalizePath(s),filename:l})});if(!t.ok){const e=await t.text();return console.error(`[ProjectManager] Orchestrator error: ${t.status} - ${e}`),{success:!1,error:`Orchestrator error: ${t.status}`}}const n=await t.json();return n.success?(console.log(`[ProjectManager] Saved to: ${n.saved_path}`),{success:!0,savedPath:n.saved_path}):(console.error(`[ProjectManager] Save failed: ${n.message}`),{success:!1,error:n.message})}catch(c){return console.error("[ProjectManager] Error saving to project folder:",c),{success:!1,error:`Network error: ${String(c)}`}}}async checkOrchestratorHealth(){const e=this.currentProject.orchestratorUrl;if(!e)return{online:!1,error:"No Orchestrator URL configured"};try{const t=await fetch(`${e}/api/health`,{method:"GET",signal:AbortSignal.timeout(5e3)});if(t.ok){const e=await t.json();return{online:"healthy"===e.status||"degraded"===e.status}}return{online:!1,error:`HTTP ${t.status}`}}catch(t){return{online:!1,error:String(t)}}}async downloadImage(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to download image: ${t.statusText}`);return t.blob()}async saveImageToProject(e,t,n,a){const r=this.getExtensionFromUrl(e);return{filename:this.generateFilename(t,n,a)+r,blob:await this.downloadImage(e)}}triggerDownload(e,t){const n=URL.createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n)}generateMetadataJson(e){return JSON.stringify({...e.metadata,timestamp:e.metadata.timestamp instanceof Date?e.metadata.timestamp.toISOString():e.metadata.timestamp},null,2)}saveToStorage(){try{localStorage.setItem(this.storageKey,JSON.stringify({...this.currentProject,created:this.currentProject.created instanceof Date?this.currentProject.created.toISOString():this.currentProject.created,lastModified:this.currentProject.lastModified instanceof Date?this.currentProject.lastModified.toISOString():this.currentProject.lastModified}))}catch(e){console.error("[ProjectManager] Failed to save to storage:",e)}}loadFromStorage(){try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);this.currentProject={...qk,orchestratorUrl:Xk(t.orchestratorUrl||""),namingTemplate:t.namingTemplate||qk.namingTemplate,autoSave:t.autoSave??qk.autoSave}}}catch(e){console.error("[ProjectManager] Failed to load from storage:",e)}}async scanExistingVersions(){const e=this.currentProject.orchestratorUrl,t=this.currentProject.path;if(console.log(`[ProjectManager] scanExistingVersions - orchestrator: ${e}, folder: ${t}, pattern: ${this.currentProject.namingTemplate}`),!e||!t)return console.log("[ProjectManager] scanExistingVersions - skipping (no orchestrator or folder)"),{success:!0,panelVersions:{}};try{const n={folder_path:t,pattern:this.currentProject.namingTemplate};console.log("[ProjectManager] scanExistingVersions - request:",JSON.stringify(n));const a=await fetch(`${e}/api/scan-versions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)return console.error(`[ProjectManager] scanExistingVersions - HTTP error: ${a.status}`),{success:!1,panelVersions:{},error:`HTTP ${a.status}`};const r=await a.json();console.log("[ProjectManager] scanExistingVersions - response:",JSON.stringify(r)),r.message&&r.message.includes(" DEBUG_CODE_RUNNING ")&&(console.log("%c DEBUG CODE IS RUNNING! ","background: #ff0000; color: #ffffff; font-size: 20px; font-weight: bold; padding: 10px;"),console.log("%cThis means server.py dummy code executed successfully!","background: #00aa00; color: #ffffff; font-size: 16px; padding: 5px;"),console.log("Message from server:",r.message));const i={};if(r.panel_versions)for(const[e,t]of Object.entries(r.panel_versions))i[e]="string"==typeof t?parseInt(t,10):t;return{success:r.success,panelVersions:i,error:r.message}}catch(n){return console.error("[ProjectManager] Failed to scan versions:",n),{success:!1,panelVersions:{},error:String(n)}}}async getNextVersion(e,t=[]){var n;const a=await this.scanExistingVersions(),r=this.sanitizeFilename(e),i=a.panelVersions[r]||0;let s=0;for(const l of t)(null==(n=l.metadata)?void 0:n.version)&&l.metadata.version>s&&(s=l.metadata.version);const o=Math.max(i,s)+1;return console.log(`[ProjectManager] getNextVersion for "${e}": filesystem=${i}, history=${s}, next=${o}`),o}async saveProjectState(e,t,n,a){const r=this.currentProject.orchestratorUrl,i=this.currentProject.path;if(!r)return{success:!1,error:"No Orchestrator URL configured"};if(!i)return{success:!1,error:"No project folder configured"};try{const t=e.map(e=>{var t,n;const a=e;console.log("[ProjectManager] Saving panel:",{id:a.id,name:a.name,notes:a.notes,hasImageHistory:Array.isArray(a.imageHistory)?a.imageHistory.length:0});const r=a.imageHistory,i={};if(r&&Array.isArray(r))for(const s of r)void 0!==(null==(t=s.metadata)?void 0:t.rating)&&(null==(n=s.metadata)?void 0:n.savedPath)&&(i[s.metadata.savedPath]=s.metadata.rating,console.log("[ProjectManager] Saving rating:",s.metadata.savedPath,s.metadata.rating));return{id:a.id,x:a.x,y:a.y,width:a.width,height:a.height,name:a.name,notes:a.notes,workflowId:a.workflowId,parameterValues:a.parameterValues,nodeId:a.nodeId,imageRatings:i}}),s=[];for(const e of t){const t=e.parameterValues;if(!t)continue;const n=e.name||`Panel_${String(e.id).padStart(2,"0")}`,a=`${i}/${this.sanitizeFilename(n)}/.ref_images`;for(const[e,i]of Object.entries(t))if("string"==typeof i&&(i.startsWith("data:image")||i.startsWith("data:video"))){const o=i.match(/^data:(image|video)\/(\w+)/),l=o?o[2].replace("jpeg","jpg"):"png",c=`${e}.${l}`,d=i;s.push(fetch(`${r}/api/save-base64-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data_url:d,folder_path:a,filename:c})}).then(async a=>{if(a.ok){const r=await a.json();r.success&&r.saved_path?(t[e]=`__fileref::${r.saved_path}`,console.log(`[ProjectManager] Externalized ${e} for panel "${n}" -> ${r.saved_path}`)):console.warn(`[ProjectManager] Failed to save ${e} for panel "${n}": ${r.message}`)}else console.warn(`[ProjectManager] HTTP ${a.status} saving ${e} for panel "${n}"`)}).catch(t=>{console.warn(`[ProjectManager] Error saving ${e} for panel "${n}":`,t)}))}}const o=n?{...n}:null;if(o){const e=`${i}/.ref_images`;for(const[t,n]of Object.entries(o))if("string"==typeof n&&(n.startsWith("data:image")||n.startsWith("data:video"))){const a=n.match(/^data:(image|video)\/(\w+)/),i=a?a[2].replace("jpeg","jpg"):"png",l=`${t}.${i}`;s.push(fetch(`${r}/api/save-base64-image`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data_url:n,folder_path:e,filename:l})}).then(async e=>{if(e.ok){const n=await e.json();n.success&&n.saved_path&&(o[t]=`__fileref::${n.saved_path}`,console.log(`[ProjectManager] Externalized global ${t} -> ${n.saved_path}`))}}).catch(e=>{console.warn(`[ProjectManager] Error saving global ${t}:`,e)}))}}s.length>0&&(console.log(`[ProjectManager] Saving ${s.length} reference images to disk...`),await Promise.all(s),console.log("[ProjectManager] Reference images saved")),console.log("[ProjectManager] Sanitized panels (base64 stripped)");const l=await fetch(`${r}/api/save-project`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder_path:i,filename:`${this.sanitizeFilename(this.currentProject.name)}_project.json`,state:{project_settings:{...this.currentProject,created:this.currentProject.created instanceof Date?this.currentProject.created.toISOString():this.currentProject.created,lastModified:(new Date).toISOString()},panels:t,parameter_values:o,selected_workflow_id:(null==a?void 0:a.selectedWorkflowId)||null,render_nodes:(null==a?void 0:a.renderNodes)||null,comfy_url:(null==a?void 0:a.comfyUrl)||null,deleted_images:(null==a?void 0:a.deletedImages)||[],saved_at:(new Date).toISOString()}})});if(!l.ok)return{success:!1,error:`HTTP ${l.status}`};const c=await l.json();return{success:c.success,savedPath:c.saved_path,error:c.message}}catch(s){return console.error("[ProjectManager] Failed to save project:",s),{success:!1,error:String(s)}}}async loadProjectState(e){const t=this.currentProject.orchestratorUrl;if(!t)return{success:!1,error:"No Orchestrator URL configured"};try{const n=await fetch(`${t}/api/load-project`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_path:e})});if(!n.ok)return{success:!1,error:`HTTP ${n.status}`};const a=await n.json();if(a.success&&a.state){const e=a.state.project_settings;return this.currentProject={...qk,...e,orchestratorUrl:Xk(e.orchestratorUrl||""),created:new Date(e.created),lastModified:new Date(e.lastModified)},this.saveToStorage(),{success:!0,state:a.state}}return{success:!1,error:a.message}}catch(n){return console.error("[ProjectManager] Failed to load project:",n),{success:!1,error:String(n)}}}async listProjects(e){const t=this.currentProject.orchestratorUrl,n=e||this.currentProject.path;if(!t||!n)return{success:!0,projects:[]};try{const e=await fetch(`${t}/api/list-projects?folder_path=${encodeURIComponent(n)}`,{method:"GET"});if(!e.ok)return{success:!1,projects:[],error:`HTTP ${e.status}`};const a=await e.json();return{success:a.success,projects:a.projects||[],error:a.message}}catch(a){return console.error("[ProjectManager] Failed to list projects:",a),{success:!1,projects:[],error:String(a)}}}async scanProjectImages(e){const t=this.currentProject.orchestratorUrl;if(!t)return{success:!1,imagesByPanel:new Map,maxPanelNumber:0,skippedFiles:[],error:"No Orchestrator URL configured"};try{const e=this.currentProject.path.replace(/\\/g,"/"),n=this.currentProject.namingTemplate.replace(/\\/g,"/");console.log("[ProjectManager] scanProjectImages - original path:",this.currentProject.path),console.log("[ProjectManager] scanProjectImages - normalized path:",e),console.log("[ProjectManager] scanProjectImages - normalized pattern:",n);const a={folder_path:e,naming_pattern:n,project_name:this.currentProject.name};console.log("[ProjectManager] scanProjectImages - request:",JSON.stringify(a));const r=await fetch(`${t}/api/scan-project-images`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!r.ok)return{success:!1,imagesByPanel:new Map,maxPanelNumber:0,skippedFiles:[],error:`HTTP ${r.status}`};const i=await r.json();if(!i.success)return{success:!1,imagesByPanel:new Map,maxPanelNumber:0,skippedFiles:i.skipped_files||[],error:i.message};const s=new Map;let o=0;for(const t of i.images)s.has(t.panel_number)||s.set(t.panel_number,[]),s.get(t.panel_number).push(t),o=Math.max(o,t.panel_number);return s.forEach(e=>{e.sort((e,t)=>e.version-t.version)}),{success:!0,imagesByPanel:s,maxPanelNumber:o,skippedFiles:i.skipped_files||[]}}catch(n){return console.error("[ProjectManager] Failed to scan project images:",n),{success:!1,imagesByPanel:new Map,maxPanelNumber:0,skippedFiles:[],error:String(n)}}}async scanProjectPanels(){const e=this.currentProject.orchestratorUrl;if(!e)return{success:!1,panels:[],error:"No Orchestrator URL configured"};if(!this.currentProject.path)return{success:!1,panels:[],error:"No project path configured"};try{const t=this.normalizePath(this.currentProject.path);console.log("[ProjectManager] scanProjectPanels - path:",t);const n=await fetch(`${e}/api/scan-project-panels`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({project_path:t})});if(!n.ok)return{success:!1,panels:[],error:`HTTP ${n.status}`};const a=await n.json();return console.log("[ProjectManager] scanProjectPanels - result:",a),a.success?{success:!0,panels:a.panels}:{success:!1,panels:[],error:a.message}}catch(t){return console.error("[ProjectManager] Failed to scan project panels:",t),{success:!1,panels:[],error:String(t)}}}async deleteImage(e){const t=this.currentProject.orchestratorUrl||Gk(),n=this.currentProject.path||"";console.log("[ProjectManager] deleteImage (trash) called with path:",e);try{const a=await fetch(`${t}/api/gallery/trash`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_paths:[e],project_path:n,use_os_trash:!1})}),r=await a.json();if(r.success)return console.log("[ProjectManager] Trashed successfully:",r),{success:!0,deletedFiles:[e]};console.warn("[ProjectManager] Trash failed, falling back to permanent delete:",r.message);const i=await fetch(`${t}/api/delete-image`,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_path:e})}),s=await i.json();return{success:s.success,deletedFiles:s.deleted_files||[],error:s.message}}catch(a){return console.error("[ProjectManager] Failed to trash image:",a),{success:!1,deletedFiles:[],error:String(a)}}}};function Yk({node:e,level:t,selectedPath:n,expandedPaths:a,onSelectFolder:r,onExpandFolder:i,onCollapseFolder:s}){const o=e.path===n,l=a.has(e.path);return Ut.jsxs("div",{className:"tree-node-wrapper",children:[Ut.jsxs("div",{className:"tree-node "+(o?"selected":""),style:{paddingLeft:12*t+8+"px"},onClick:()=>{r(e.path)},children:["folder"===e.type&&Ut.jsx("button",{className:"tree-expand-btn",onClick:t=>{t.stopPropagation(),l?s(e.path):i(e.path)},disabled:e.isLoading,children:e.isLoading?Ut.jsx(XE,{size:14,className:"tree-loading-icon"}):l?Ut.jsx(uE,{size:14}):Ut.jsx(pE,{size:14})}),"drive"===e.type&&Ut.jsx("span",{className:"tree-spacer"}),"drive"===e.type?Ut.jsx(FE,{size:16,className:"tree-icon drive"}):l?Ut.jsx(RE,{size:16,className:"tree-icon folder-open"}):Ut.jsx(LE,{size:16,className:"tree-icon folder"}),Ut.jsx("span",{className:"tree-label",children:e.name})]}),l&&e.children&&e.children.length>0&&Ut.jsx("div",{className:"tree-children",children:e.children.map(e=>Ut.jsx(Yk,{node:e,level:t+1,selectedPath:n,expandedPaths:a,onSelectFolder:r,onExpandFolder:i,onCollapseFolder:s},e.path))}),l&&e.children&&0===e.children.length&&!e.isLoading&&Ut.jsx("div",{className:"tree-empty-children",style:{paddingLeft:12*(t+1)+32+"px"},children:"(empty)"})]})}function Jk({nodes:e,selectedPath:t,expandedPaths:n,onSelectFolder:a,onExpandFolder:r,onCollapseFolder:i}){return Ut.jsxs("div",{className:"drive-tree-view",children:[Ut.jsx("div",{className:"tree-header",children:Ut.jsx("span",{children:"Quick Access"})}),Ut.jsx("div",{className:"tree-content",children:0===e.length?Ut.jsx("div",{className:"tree-empty",children:"No drives found"}):e.map(e=>Ut.jsx(Yk,{node:e,level:0,selectedPath:t,expandedPaths:n,onSelectFolder:a,onExpandFolder:r,onCollapseFolder:i},e.path))})]})}function Zk(e){const t=new Date(e),n=(new Date).getTime()-t.getTime(),a=Math.floor(n/864e5);if(0===a){const e=Math.floor(n/36e5);if(0===e){const e=Math.floor(n/6e4);return e<=1?"Just now":`${e} minutes ago`}return`${e} hours ago`}return 1===a?"Yesterday":a<7?`${a} days ago`:a<30?`${Math.floor(a/7)} weeks ago`:t.toLocaleDateString()}function Qk({items:e,selectedItem:t,onSelectItem:n,onOpenItem:a,isLoading:r}){const i=e=>{n(e)},s=e=>{a(e)},o=e=>{switch(e.type){case"drive":return Ut.jsx(FE,{size:24,className:"item-icon drive"});case"folder":return Ut.jsx(LE,{size:24,className:"item-icon folder"});case"file":return Ut.jsx(NE,{size:24,className:"item-icon file"});case"project":return Ut.jsx(NE,{size:24,className:"item-icon project"});default:return Ut.jsx(LE,{size:24,className:"item-icon"})}},l=[...e].sort((e,t)=>{const n={drive:0,folder:1,file:2,project:2},a=(n[e.type]??3)-(n[t.type]??3);return 0!==a?a:e.name.localeCompare(t.name)}),c=l.filter(e=>"drive"===e.type||"folder"===e.type),d=l.filter(e=>"file"===e.type||"project"===e.type);return r?Ut.jsx("div",{className:"folder-contents-view loading",children:Ut.jsxs("div",{className:"contents-loading",children:[Ut.jsx("div",{className:"loading-spinner"}),Ut.jsx("span",{children:"Loading..."})]})}):0===l.length?Ut.jsx("div",{className:"folder-contents-view empty",children:Ut.jsxs("div",{className:"contents-empty",children:[Ut.jsx(LE,{size:48,className:"empty-icon"}),Ut.jsx("span",{children:"This folder is empty"})]})}):Ut.jsxs("div",{className:"folder-contents-view",children:[c.length>0&&Ut.jsxs("div",{className:"contents-section",children:[Ut.jsxs("div",{className:"section-header",children:[Ut.jsx(LE,{size:14}),Ut.jsxs("span",{children:["Folders (",c.length,")"]})]}),Ut.jsx("div",{className:"items-grid",children:c.map(e=>Ut.jsxs("div",{className:`content-item ${(null==t?void 0:t.path)===e.path?"selected":""} ${e.type}`,onClick:()=>i(e),onDoubleClick:()=>s(e),title:e.name,children:[o(e),Ut.jsx("span",{className:"item-name",children:e.name})]},e.path))})]}),d.length>0&&Ut.jsxs("div",{className:"contents-section",children:[Ut.jsxs("div",{className:"section-header",children:[Ut.jsx(NE,{size:14}),Ut.jsxs("span",{children:["Files (",d.length,")"]})]}),Ut.jsx("div",{className:"items-grid",children:d.map(e=>Ut.jsxs("div",{className:`content-item ${(null==t?void 0:t.path)===e.path?"selected":""} ${e.type}`,onClick:()=>i(e),onDoubleClick:()=>s(e),title:e.path,children:[o(e),Ut.jsxs("div",{className:"item-details",children:[Ut.jsx("span",{className:"item-name",children:e.name}),e.metadata&&Ut.jsxs("div",{className:"item-meta",children:[Ut.jsxs("span",{className:"meta-item",children:[Ut.jsx(xE,{size:12}),Zk(e.metadata.savedAt)]}),Ut.jsxs("span",{className:"meta-item",children:[Ut.jsx(WE,{size:12}),e.metadata.panelCount," panels"]})]})]})]},e.path))})]})]})}function eT({path:e,onNavigate:t,onRefresh:n,isLoading:a}){const[r,i]=Tt.useState(!1),[s,o]=Tt.useState(e),l=Tt.useRef(null);Tt.useEffect(()=>{r||o(e)},[e,r]),Tt.useEffect(()=>{r&&l.current&&(l.current.focus(),l.current.select())},[r]);const c=Tt.useCallback(e=>{if(!e)return[{name:"Computer",path:""}];const t=e.replace(/\\/g,"/").split("/").filter(Boolean),n=[];let a="";if(t.length>0&&t[0].includes(":")){n.push({name:t[0],path:t[0]+(t[0].endsWith(":")?"\\":"")}),a=t[0]+(t[0].endsWith(":")?"\\":"");for(let e=1;e<t.length;e++)a+=(a.endsWith("\\")?"":"\\")+t[e],n.push({name:t[e],path:a})}else{n.push({name:"Computer",path:""});for(const e of t)a+="/"+e,n.push({name:e,path:a})}return n},[])(e),d=()=>{const e=s.trim();t(e||""),i(!1)};return Ut.jsxs("div",{className:"breadcrumb-bar",children:[Ut.jsx("button",{className:"breadcrumb-home-btn",onClick:()=>{t("")},title:"Go to Computer",children:Ut.jsx(zE,{size:14})}),r?Ut.jsx("div",{className:"breadcrumb-edit-container",children:Ut.jsx("input",{ref:l,type:"text",className:"breadcrumb-input",value:s,onChange:e=>o(e.target.value),onKeyDown:t=>{"Enter"===t.key?d():"Escape"===t.key&&(o(e),i(!1))},onBlur:d,placeholder:"Enter path..."})}):Ut.jsx("div",{className:"breadcrumb-segments",onClick:()=>{i(!0)},title:"Click to edit path",children:c.map((e,n)=>Ut.jsxs("div",{className:"breadcrumb-segment-wrapper",children:[n>0&&Ut.jsx(pE,{size:14,className:"breadcrumb-separator"}),Ut.jsx("button",{className:"breadcrumb-segment "+(n===c.length-1?"current":""),onClick:n=>{var a;n.stopPropagation(),a=e.path,t(a)},disabled:n===c.length-1,children:e.name})]},e.path))}),Ut.jsx("button",{className:"breadcrumb-refresh-btn",onClick:n,disabled:a,title:"Refresh",children:Ut.jsx(ck,{size:14,className:a?"spinning":""})})]})}function tT({isOpen:e,onClose:t,mode:n,orchestratorUrl:a,initialPath:r="",projectName:i="",title:s,onOpenProject:o,onSaveProject:l,onSelectFolder:c}){var d,u,h,p;const{state:m,navigateTo:f,selectItem:g,expandTreeNode:v,collapseTreeNode:y,refresh:x,goToParent:b}=function(e,t="",n=!0,a="open"){const[r,i]=Tt.useState({currentPath:t,selectedItem:null,treeNodes:[],folderContents:[],isLoading:!1,error:null,expandedPaths:new Set}),s=Tt.useRef(new Map),o=Tt.useCallback(async(t,n=!0)=>{if(n&&s.current.has(t))return{items:s.current.get(t),parent:null};try{const n="open"===a?"&show_files=.json":"",r=await fetch(`${e}/api/browse-folders?path=${encodeURIComponent(t)}${n}`,{method:"GET"});if(!r.ok)throw new Error(`HTTP ${r.status}`);const i=await r.json();if(!i.success)throw new Error(i.error||"Failed to browse folder");const o=[...(i.items??i.folders??[]).map(e=>({...e,type:e.type}))];return s.current.set(t,o),{items:o,parent:i.parent}}catch(k){throw console.error("[useFileBrowser] Failed to fetch folder contents:",k),k}},[e,a]),l=Tt.useCallback(async t=>{try{const n=await fetch(`${e}/api/browse-folders?path=${encodeURIComponent(t)}`,{method:"GET"});if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json();if(!a.success)throw new Error(a.error||"Failed to browse folder");return(a.items??a.folders??[]).filter(e=>"folder"===e.type).map(e=>({id:e.path,name:e.name,path:e.path,type:"folder",children:void 0,isLoading:!1,isExpanded:!1}))}catch(k){return console.error("[useFileBrowser] Failed to fetch tree children:",k),[]}},[e]),c=Tt.useCallback(async e=>{i(e=>({...e,isLoading:!0,error:null}));try{const{items:t}=await o(e);i(n=>({...n,currentPath:e,folderContents:t,isLoading:!1,selectedItem:null}))}catch(t){i(e=>({...e,isLoading:!1,error:t instanceof Error?t.message:"Failed to navigate"}))}},[o]),d=Tt.useCallback(e=>{i(t=>({...t,selectedItem:e}))},[]),u=Tt.useCallback(async e=>{i(t=>{const n=new Set(t.expandedPaths);return n.add(e),{...t,expandedPaths:n}});const t=(e,n)=>{for(const a of e){if(a.path===n)return a;if(a.children){const e=t(a.children,n);if(e)return e}}return null},n=t(r.treeNodes,e);if(n&&n.children&&n.children.length>0)i(t=>{const n=t=>t.map(t=>t.path===e?{...t,isExpanded:!0}:t.children?{...t,children:n(t.children)}:t);return{...t,treeNodes:n(t.treeNodes)}});else{i(t=>{const n=t=>t.map(t=>t.path===e?{...t,isLoading:!0}:t.children?{...t,children:n(t.children)}:t);return{...t,treeNodes:n(t.treeNodes)}});try{const t=await l(e);i(n=>{const a=n=>n.map(n=>n.path===e?{...n,children:t,isLoading:!1,isExpanded:!0}:n.children?{...n,children:a(n.children)}:n);return{...n,treeNodes:a(n.treeNodes)}})}catch(a){i(t=>{const n=t=>t.map(t=>t.path===e?{...t,isLoading:!1}:t.children?{...t,children:n(t.children)}:t);return{...t,treeNodes:n(t.treeNodes)}})}}},[r.treeNodes,l]),h=Tt.useCallback(e=>{i(t=>{const n=new Set(t.expandedPaths);n.delete(e);const a=t=>t.map(t=>t.path===e?{...t,isExpanded:!1}:t.children?{...t,children:a(t.children)}:t);return{...t,expandedPaths:n,treeNodes:a(t.treeNodes)}})},[]),p=Tt.useCallback(async()=>{s.current.delete(r.currentPath),await c(r.currentPath)},[r.currentPath,c]),m=Tt.useCallback(async()=>{try{const t=new AbortController,n=setTimeout(()=>t.abort(),1e4),a=await fetch(`${e}/api/browse-folders?path=${encodeURIComponent(r.currentPath)}`,{method:"GET",signal:t.signal});if(clearTimeout(n),!a.ok)throw new Error(`HTTP ${a.status}`);const i=await a.json();i.success&&i.parent&&await c(i.parent)}catch(t){console.error("[useFileBrowser] Failed to go to parent:",t)}},[r.currentPath,e,c]),f=Tt.useCallback(async()=>{await c("")},[c]);return Tt.useEffect(()=>{n&&(s.current.clear(),i({currentPath:t,selectedItem:null,treeNodes:[],folderContents:[],isLoading:!0,error:null,expandedPaths:new Set}),(async()=>{try{if(t)try{await c(t);const n=await fetch(`${e}/api/browse-folders?path=`,{method:"GET"});if(n.ok){const e=await n.json();if(e.success){const t=(e.items??e.folders??[]).filter(e=>"drive"===e.type).map(e=>({id:e.path,name:e.name,path:e.path,type:"drive",children:void 0,isLoading:!1,isExpanded:!1}));i(e=>({...e,treeNodes:t}))}}return}catch{console.warn("[useFileBrowser] Failed to navigate to initial path, falling back to root drives")}const n=await fetch(`${e}/api/browse-folders?path=`,{method:"GET"});if(!n.ok)throw new Error(`HTTP ${n.status}`);const a=await n.json();if(a.success){const e=a.items??a.folders??[],t=e.filter(e=>"drive"===e.type).map(e=>({id:e.path,name:e.name,path:e.path,type:"drive",children:void 0,isLoading:!1,isExpanded:!1}));i(n=>({...n,isLoading:!1,treeNodes:t,folderContents:e.map(e=>({...e,type:e.type}))}))}else i(e=>({...e,isLoading:!1,error:a.error||"Failed to load drives"}))}catch(n){i(e=>({...e,isLoading:!1,error:n instanceof Error?n.message:"Failed to load drives"}))}})())},[e,n,t]),{state:r,navigateTo:c,selectItem:d,expandTreeNode:u,collapseTreeNode:h,refresh:p,goToParent:m,goToRoot:f}}(a,r,e,n),[_,w]=Tt.useState(i),[S,M]=Tt.useState(!1),[C,E]=Tt.useState(""),[k,T]=Tt.useState(null);Tt.useEffect(()=>{i&&w(i)},[i]),Tt.useEffect(()=>{T(null)},[m.currentPath]),Tt.useEffect(()=>{if(!e)return;const a=e=>{var a;if("Escape"===e.key)return e.preventDefault(),void t();if("Enter"===e.key)return e.preventDefault(),void(("select-folder"===n&&m.currentPath||"open"===n&&"project"===(null==(a=m.selectedItem)?void 0:a.type)||"save"===n&&_.trim())&&A());if("Backspace"===e.key&&!e.shiftKey){"INPUT"!==e.target.tagName&&(e.preventDefault(),b())}};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[e,n,m.selectedItem,_,t,b]);const N=Tt.useCallback(async e=>{await f(e)},[f]),P=Tt.useCallback(e=>{if(g(e),"save"===n&&("project"===e.type||"file"===e.type)){const t=e.name.replace(/_project\.json$/i,"").replace(/\.json$/i,"");w(t)}},[g,n]),j=Tt.useCallback(e=>{"folder"===e.type||"drive"===e.type?f(e.path):"project"!==e.type&&"file"!==e.type||"open"!==n||o(e.path)},[f,o,n]),A=()=>{var e,a,r,i,s;if("select-folder"===n){const n="folder"===(null==(e=m.selectedItem)?void 0:e.type)||"drive"===(null==(a=m.selectedItem)?void 0:a.type)?m.selectedItem.path:m.currentPath;if(!n)return void T("Please select a folder");c&&c(n),t()}else if("open"===n)"project"===(null==(r=m.selectedItem)?void 0:r.type)||"file"===(null==(i=m.selectedItem)?void 0:i.type)?o(m.selectedItem.path):"folder"===(null==(s=m.selectedItem)?void 0:s.type)?f(m.selectedItem.path):T("Please select a project file (.json) to open");else if("save"===n){if(!_.trim())return void T("Please enter a project name");if(!m.currentPath)return void T("Please select a folder to save in");l&&l(m.currentPath,_.trim())}},R=async()=>{if(C.trim())try{const e=await fetch(`${a}/api/create-folder`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({parent_path:m.currentPath,folder_name:C.trim()})});if(e.ok){const t=await e.json();t.success?(M(!1),E(""),await x(),t.folder_path&&await f(t.folder_path)):T(t.message||"Failed to create folder")}else T("Failed to create folder")}catch(e){T(`Error creating folder: ${e}`)}};return e?Ut.jsx("div",{className:"file-browser-overlay",onClick:t,children:Ut.jsxs("div",{className:"file-browser-dialog",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"file-browser-header",children:[Ut.jsx("div",{className:"file-browser-title",children:"select-folder"===n?Ut.jsxs(Ut.Fragment,{children:[Ut.jsx(RE,{size:18}),Ut.jsx("span",{children:s||"Select Folder"})]}):"open"===n?Ut.jsxs(Ut.Fragment,{children:[Ut.jsx(RE,{size:18}),Ut.jsx("span",{children:s||"Load Project"})]}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsx(hk,{size:18}),Ut.jsx("span",{children:s||"Save Project As"})]})}),Ut.jsx("button",{className:"close-btn",onClick:t,children:Ut.jsx(Nk,{size:18})})]}),Ut.jsxs("div",{className:"file-browser-body",children:[Ut.jsx("div",{className:"file-browser-left-pane",children:Ut.jsx(Jk,{nodes:m.treeNodes,selectedPath:m.currentPath,expandedPaths:m.expandedPaths,onSelectFolder:N,onExpandFolder:v,onCollapseFolder:y})}),Ut.jsxs("div",{className:"file-browser-right-pane",children:[Ut.jsx(eT,{path:m.currentPath,onNavigate:f,onRefresh:x,isLoading:m.isLoading}),Ut.jsx(Qk,{items:m.folderContents,selectedItem:m.selectedItem,onSelectItem:P,onOpenItem:j,isLoading:m.isLoading}),k&&Ut.jsxs("div",{className:"file-browser-error",children:[Ut.jsx(fE,{size:16}),Ut.jsx("span",{children:k})]}),"save"===n&&Ut.jsxs("div",{className:"file-browser-save-input",children:[Ut.jsx("label",{children:"Project Name:"}),Ut.jsx("input",{type:"text",value:_,onChange:e=>w(e.target.value),placeholder:"Enter project name...",onKeyDown:e=>{"Enter"===e.key&&A()},autoFocus:!0})]}),S&&Ut.jsxs("div",{className:"file-browser-new-folder",children:[Ut.jsx("input",{type:"text",value:C,onChange:e=>E(e.target.value),placeholder:"New folder name...",onKeyDown:e=>{"Enter"===e.key?R():"Escape"===e.key&&(M(!1),E(""))},autoFocus:!0}),Ut.jsx("button",{onClick:R,children:"Create"}),Ut.jsx("button",{onClick:()=>{M(!1),E("")},children:"Cancel"})]})]})]}),Ut.jsxs("div",{className:"file-browser-footer",children:[Ut.jsxs("button",{className:"new-folder-btn",onClick:()=>M(!0),disabled:S||!m.currentPath,children:[Ut.jsx(IE,{size:16}),Ut.jsx("span",{children:"New Folder"})]}),"select-folder"===n&&m.currentPath&&Ut.jsxs("div",{className:"file-browser-selected-path",title:"folder"===(null==(d=m.selectedItem)?void 0:d.type)||"drive"===(null==(u=m.selectedItem)?void 0:u.type)?m.selectedItem.path:m.currentPath,children:[Ut.jsx("span",{className:"selected-path-label",children:"Selected:"}),Ut.jsx("span",{className:"selected-path-value",children:"folder"===(null==(h=m.selectedItem)?void 0:h.type)||"drive"===(null==(p=m.selectedItem)?void 0:p.type)?m.selectedItem.path:m.currentPath})]}),Ut.jsxs("div",{className:"file-browser-actions",children:[Ut.jsx("button",{className:"cancel-btn",onClick:t,children:"Cancel"}),Ut.jsx("button",{className:"primary-btn",onClick:A,disabled:(()=>{var e,t;if("select-folder"===n){return!("folder"===(null==(e=m.selectedItem)?void 0:e.type)||"drive"===(null==(t=m.selectedItem)?void 0:t.type)||!!m.currentPath)}return"open"===n?!m.selectedItem||"project"!==m.selectedItem.type&&"file"!==m.selectedItem.type&&"folder"!==m.selectedItem.type:!_.trim()||!m.currentPath})(),children:"select-folder"===n?"Select Folder":"open"===n?"project"===(null==(I=m.selectedItem)?void 0:I.type)||"file"===(null==(L=m.selectedItem)?void 0:L.type)?"Open Project":"folder"===(null==(D=m.selectedItem)?void 0:D.type)?"Open Folder":"Open Project":"Save"})]})]})]})}):null;var I,L,D}function nT({isOpen:e,onClose:t,settings:n,onSave:a}){const[r,i]=Tt.useState(n.name),[s,o]=Tt.useState(n.path),[l,c]=Tt.useState(n.namingTemplate),[d,u]=Tt.useState(n.autoSave),[h,p]=Tt.useState(n.orchestratorUrl||Gk()),[m,f]=Tt.useState("checking"),[g,v]=Tt.useState(!1),[y,x]=Tt.useState(null),[b,_]=Tt.useState(!1);if(Tt.useEffect(()=>{e&&(i(n.name),o(n.path),c(n.namingTemplate),u(n.autoSave),p(n.orchestratorUrl||Gk()))},[e,n]),Tt.useEffect(()=>{if(!e||!h)return;f("checking");const t=new AbortController;return fetch(`${h}/api/health`,{signal:t.signal}).then(e=>e.ok?f("online"):f("offline")).catch(e=>{"AbortError"!==e.name&&f("offline")}),()=>t.abort()},[e,h]),!e)return null;const w=async()=>{if(!s||!h)return;_(!0);const e=await Kk.validateProjectPath(s,h);x(e),_(!1)};return Ut.jsxs("div",{className:"modal-overlay",onClick:t,children:[Ut.jsxs("div",{className:"project-settings-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"modal-header",children:[Ut.jsx("h2",{children:"Project Settings"}),Ut.jsx("button",{className:"close-btn",onClick:t,children:""})]}),Ut.jsxs("div",{className:"modal-body",children:[Ut.jsxs("div",{className:"form-group",children:[Ut.jsx("label",{htmlFor:"project-name",children:"Project Name"}),Ut.jsx("input",{id:"project-name",type:"text",value:r,onChange:e=>i(e.target.value),placeholder:"My VFX Project"})]}),Ut.jsxs("div",{className:"form-group",children:[Ut.jsx("label",{htmlFor:"project-path",children:"Output Folder Path"}),Ut.jsxs("div",{className:"input-with-button",children:[Ut.jsx("input",{id:"project-path",type:"text",value:s,onChange:e=>{o(e.target.value),x(null)},onBlur:w,placeholder:"e.g., Z:\\Projects\\MyProject\\renders"}),Ut.jsx("button",{type:"button",className:"browse-btn",onClick:()=>v(!0),disabled:"online"!==m,title:"online"!==m?"Orchestrator must be online to browse folders":"Browse folders",children:Ut.jsx(RE,{size:16})}),Ut.jsx("button",{type:"button",className:"validate-btn",onClick:w,disabled:!s||!h||b,title:"Validate path",children:b?"...":"Validate"})]}),y&&Ut.jsxs("div",{className:"path-validation-indicator "+(y.valid?"valid":"invalid"),children:[y.valid?Ut.jsx(gE,{size:14}):Ut.jsx(vE,{size:14}),Ut.jsx("span",{children:y.message})]}),Ut.jsx("small",{className:"help-text",children:"Full path where images will be saved. Leave empty for browser downloads."})]}),Ut.jsxs("div",{className:"form-group",children:[Ut.jsxs("label",{htmlFor:"orchestrator-url",children:["Orchestrator URL",Ut.jsx("span",{className:`status-indicator ${m}`,children:"checking"===m?"...":"online"===m?" (Online)":" (Offline)"})]}),Ut.jsx("input",{id:"orchestrator-url",type:"text",value:h,onChange:e=>p(e.target.value),placeholder:"http://localhost:9820"}),Ut.jsx("small",{className:"help-text",children:"URL of the Director's Console Orchestrator API (for auto-save to filesystem)."})]}),Ut.jsxs("div",{className:"form-group",children:[Ut.jsx("label",{htmlFor:"naming-template",children:"Naming Template"}),Ut.jsx("input",{id:"naming-template",type:"text",value:l,onChange:e=>c(e.target.value),placeholder:"{project}_Panel{panel}_{version}"}),Ut.jsxs("small",{className:"help-text",children:["Available tokens: ","{project}",", ","{panel}",", ","{version}",", ","{timestamp}",", ","{date}",", ","{time}",", ","{seed}",", ","{workflow}",Ut.jsx("br",{}),Ut.jsx("strong",{children:"{panel}"}),' = Full panel name (e.g., "Panel_01", "Hero_Shot", "Opening_Scene")']}),Ut.jsxs("div",{className:"preview",children:[Ut.jsx("strong",{children:"Preview:"})," ",(()=>{const e=new Date,t=(e,t=2)=>e.toString().padStart(t,"0"),n={"{project}":r.replace(/[<>:"/\\|?*\s]/g,"_").substring(0,50),"{panel}":"Panel_01","{version}":"v001","{timestamp}":`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}_${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`,"{date}":`${e.getFullYear()}${t(e.getMonth()+1)}${t(e.getDate())}`,"{time}":`${t(e.getHours())}${t(e.getMinutes())}${t(e.getSeconds())}`,"{seed}":"12345678","{workflow}":"MyWorkflow"};let a=l;for(const[r,i]of Object.entries(n))a=a.split(r).join(i);return a+".png"})()]})]}),Ut.jsxs("div",{className:"form-group checkbox-group",children:[Ut.jsxs("label",{children:[Ut.jsx("input",{type:"checkbox",checked:d,onChange:e=>u(e.target.checked)}),"Auto-save on generation completion"]}),Ut.jsx("small",{className:"help-text",children:"Automatically save images when generation completes (requires output folder)."})]}),Ut.jsxs("div",{className:"template-examples",children:[Ut.jsx("h4",{children:"Common Templates:"}),Ut.jsxs("div",{className:"template-list",children:[Ut.jsxs("button",{type:"button",className:"template-btn",onClick:()=>c("{project}_{panel}_{version}"),children:["Panel-based: ","{project}_{panel}_{version}",Ut.jsx("small",{children:"Result: Eliot_Panel_01_v001.png"})]}),Ut.jsxs("button",{type:"button",className:"template-btn",onClick:()=>c("{panel}\\{project}_{panel}_{version}"),children:["Per-panel folders: ","{panel}\\{project}_{panel}_{version}",Ut.jsx("small",{children:"Creates Panel_01\\Eliot_Panel_01_v001.png"})]}),Ut.jsxs("button",{type:"button",className:"template-btn",onClick:()=>c("{project}_SHOT{panel}_{version}"),children:["Shot-based: ","{project}_SHOT{panel}_{version}",Ut.jsx("small",{children:"Result: Eliot_SHOTPanel_01_v001.png"})]}),Ut.jsxs("button",{type:"button",className:"template-btn",onClick:()=>c("{project}_{panel}_{timestamp}"),children:["Timestamped: ","{project}_{panel}_{timestamp}",Ut.jsx("small",{children:"Result: Eliot_Panel_01_20250206_143022.png"})]}),Ut.jsxs("button",{type:"button",className:"template-btn",onClick:()=>c("{workflow}_{seed}_{version}"),children:["Seed-based: ","{workflow}_{seed}_{version}",Ut.jsx("small",{children:"Result: MyWorkflow_12345678_v001.png"})]})]})]})]}),Ut.jsxs("div",{className:"modal-footer",children:[Ut.jsx("button",{className:"btn-secondary",onClick:t,children:"Cancel"}),Ut.jsx("button",{className:"btn-primary",onClick:()=>{a({name:r,path:s,namingTemplate:l,autoSave:d,orchestratorUrl:h}),t()},children:"Save Settings"})]})]}),Ut.jsx(tT,{isOpen:g,onClose:()=>v(!1),mode:"select-folder",orchestratorUrl:h,initialPath:s,title:"Select Output Folder",onOpenProject:()=>{},onSelectFolder:e=>{o(e),v(!1)}})]})}function aT({isOpen:e,onClose:t,onSelect:n,orchestratorUrl:a,initialPath:r="",title:i="Select Folder"}){const[s,o]=Tt.useState(r),[l,c]=Tt.useState([]),[d,u]=Tt.useState(null),[h,p]=Tt.useState(!1),[m,f]=Tt.useState(null),[g,v]=Tt.useState(""),[y,x]=Tt.useState(!1),b=Tt.useCallback(async e=>{if(a){p(!0),f(null);try{const t=await fetch(`${a}/api/browse-folders?path=${encodeURIComponent(e)}`,{method:"GET"});if(!t.ok)throw new Error(`HTTP ${t.status}`);const n=await t.json();n.success?(o(n.current||""),c(n.items||[]),u(n.parent)):f(n.error||"Failed to load folder")}catch(t){f(`Failed to connect: ${t}`)}finally{p(!1)}}else f("Orchestrator URL not configured")},[a]);Tt.useEffect(()=>{e&&b(r)},[e,r,b]);const _=async()=>{if(g.trim())try{const e=await fetch(`${a}/api/create-folder`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({parent_path:s||"C:/",folder_name:g.trim()})}),t=await e.json();if(!t.success)return void f(t.message);x(!1),v("");const n=t.created_path.replace(/\//g,"\\");o(n),await b(n)}catch(e){f(`Failed to create folder: ${e}`)}};return e?Ut.jsx("div",{className:"folder-browser-overlay",onClick:t,children:Ut.jsxs("div",{className:"folder-browser-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"folder-browser-header",children:[Ut.jsx("h3",{children:i}),Ut.jsx("button",{className:"close-btn",onClick:t,children:Ut.jsx(Nk,{size:18})})]}),Ut.jsxs("div",{className:"folder-browser-toolbar",children:[Ut.jsx("button",{onClick:()=>d&&b(d),disabled:!d||h,title:"Go to parent folder",children:Ut.jsx(hE,{size:18})}),Ut.jsx("input",{type:"text",value:s,onChange:e=>o(e.target.value),onKeyDown:e=>"Enter"===e.key&&b(s),placeholder:"Enter path..."}),Ut.jsx("button",{onClick:()=>b(s),disabled:h,title:"Refresh",children:Ut.jsx(ck,{size:18,className:h?"spinning":""})})]}),Ut.jsxs("div",{className:"folder-browser-content",children:[m&&Ut.jsx("div",{className:"folder-error",children:m}),h?Ut.jsx("div",{className:"folder-loading",children:"Loading..."}):Ut.jsxs("div",{className:"folder-list",children:[0===l.length&&!m&&Ut.jsx("div",{className:"folder-empty",children:"No folders found"}),l.map(e=>Ut.jsxs("div",{className:"folder-item",onDoubleClick:()=>b(e.path),children:["drive"===e.type?Ut.jsx(FE,{size:18}):Ut.jsx(LE,{size:18}),Ut.jsx("span",{children:e.name})]},e.path))]})]}),y&&Ut.jsxs("div",{className:"new-folder-input",children:[Ut.jsx("input",{type:"text",value:g,onChange:e=>v(e.target.value),placeholder:"New folder name...",onKeyDown:e=>"Enter"===e.key&&_(),autoFocus:!0}),Ut.jsx("button",{onClick:_,children:"Create"}),Ut.jsx("button",{onClick:()=>x(!1),children:"Cancel"})]}),Ut.jsxs("div",{className:"folder-browser-footer",children:[Ut.jsxs("div",{className:"folder-path-display",children:[Ut.jsx(RE,{size:16}),Ut.jsx("span",{children:s||"No folder selected"})]}),Ut.jsxs("div",{className:"folder-actions",children:[Ut.jsx("button",{className:"new-folder-btn",onClick:()=>x(!0),disabled:!s,children:"New Folder"}),Ut.jsx("button",{className:"cancel-btn",onClick:t,children:"Cancel"}),Ut.jsxs("button",{className:"select-btn",onClick:()=>{s&&(n(s),t())},disabled:!s,children:[Ut.jsx(dE,{size:16}),"Select"]})]})]})]})}):null}function rT({isOpen:e,filename:t,onConfirm:n,onCancel:a,onSuppressForSession:r}){const[i,s]=Tt.useState(!1);return e?Ut.jsx("div",{className:"modal-overlay delete-confirm-overlay",children:Ut.jsxs("div",{className:"delete-confirm-dialog",children:[Ut.jsx("h3",{children:"Move to Trash?"}),Ut.jsx("p",{children:"Are you sure you want to move to trash:"}),Ut.jsx("p",{className:"delete-filename",children:t}),Ut.jsx("p",{className:"delete-warning",children:"The file will be moved to the project trash folder. You can restore it from the Gallery."}),Ut.jsxs("label",{className:"dont-ask-checkbox",children:[Ut.jsx("input",{type:"checkbox",checked:i,onChange:e=>s(e.target.checked)}),Ut.jsx("span",{children:"Don't ask again this session"})]}),Ut.jsxs("div",{className:"dialog-actions",children:[Ut.jsx("button",{className:"cancel-btn",onClick:a,children:"Cancel"}),Ut.jsx("button",{className:"delete-btn",onClick:()=>{i&&r(),n()},children:"Move to Trash"})]})]})}):null}function iT(){}function sT(){}const oT=/^[$_\p{ID_Start}][$_\u{200C}\u{200D}\p{ID_Continue}]*$/u,lT=/^[$_\p{ID_Start}][-$_\u{200C}\u{200D}\p{ID_Continue}]*$/u,cT={};function dT(e,t){return(cT.jsx?lT:oT).test(e)}const uT=/[ \t\n\f\r]/g;function hT(e){return""===e.replace(uT,"")}class pT{constructor(e,t,n){this.normal=t,this.property=e,n&&(this.space=n)}}function mT(e,t){const n={},a={};for(const r of e)Object.assign(n,r.property),Object.assign(a,r.normal);return new pT(n,a,t)}function fT(e){return e.toLowerCase()}pT.prototype.normal={},pT.prototype.property={},pT.prototype.space=void 0;class gT{constructor(e,t){this.attribute=t,this.property=e}}gT.prototype.attribute="",gT.prototype.booleanish=!1,gT.prototype.boolean=!1,gT.prototype.commaOrSpaceSeparated=!1,gT.prototype.commaSeparated=!1,gT.prototype.defined=!1,gT.prototype.mustUseProperty=!1,gT.prototype.number=!1,gT.prototype.overloadedBoolean=!1,gT.prototype.property="",gT.prototype.spaceSeparated=!1,gT.prototype.space=void 0;let vT=0;const yT=CT(),xT=CT(),bT=CT(),_T=CT(),wT=CT(),ST=CT(),MT=CT();function CT(){return 2**++vT}const ET=Object.freeze(Object.defineProperty({__proto__:null,boolean:yT,booleanish:xT,commaOrSpaceSeparated:MT,commaSeparated:ST,number:_T,overloadedBoolean:bT,spaceSeparated:wT},Symbol.toStringTag,{value:"Module"})),kT=Object.keys(ET);class TT extends gT{constructor(e,t,n,a){let r=-1;if(super(e,t),NT(this,"space",a),"number"==typeof n)for(;++r<kT.length;){const e=kT[r];NT(this,kT[r],(n&ET[e])===ET[e])}}}function NT(e,t,n){n&&(e[t]=n)}function PT(e){const t={},n={};for(const[a,r]of Object.entries(e.properties)){const i=new TT(a,e.transform(e.attributes||{},a),r,e.space);e.mustUseProperty&&e.mustUseProperty.includes(a)&&(i.mustUseProperty=!0),t[a]=i,n[fT(a)]=a,n[fT(i.attribute)]=a}return new pT(t,n,e.space)}TT.prototype.defined=!0;const jT=PT({properties:{ariaActiveDescendant:null,ariaAtomic:xT,ariaAutoComplete:null,ariaBusy:xT,ariaChecked:xT,ariaColCount:_T,ariaColIndex:_T,ariaColSpan:_T,ariaControls:wT,ariaCurrent:null,ariaDescribedBy:wT,ariaDetails:null,ariaDisabled:xT,ariaDropEffect:wT,ariaErrorMessage:null,ariaExpanded:xT,ariaFlowTo:wT,ariaGrabbed:xT,ariaHasPopup:null,ariaHidden:xT,ariaInvalid:null,ariaKeyShortcuts:null,ariaLabel:null,ariaLabelledBy:wT,ariaLevel:_T,ariaLive:null,ariaModal:xT,ariaMultiLine:xT,ariaMultiSelectable:xT,ariaOrientation:null,ariaOwns:wT,ariaPlaceholder:null,ariaPosInSet:_T,ariaPressed:xT,ariaReadOnly:xT,ariaRelevant:null,ariaRequired:xT,ariaRoleDescription:wT,ariaRowCount:_T,ariaRowIndex:_T,ariaRowSpan:_T,ariaSelected:xT,ariaSetSize:_T,ariaSort:null,ariaValueMax:_T,ariaValueMin:_T,ariaValueNow:_T,ariaValueText:null,role:null},transform:(e,t)=>"role"===t?t:"aria-"+t.slice(4).toLowerCase()});function AT(e,t){return t in e?e[t]:t}function RT(e,t){return AT(e,t.toLowerCase())}const IT=PT({attributes:{acceptcharset:"accept-charset",classname:"class",htmlfor:"for",httpequiv:"http-equiv"},mustUseProperty:["checked","multiple","muted","selected"],properties:{abbr:null,accept:ST,acceptCharset:wT,accessKey:wT,action:null,allow:null,allowFullScreen:yT,allowPaymentRequest:yT,allowUserMedia:yT,alt:null,as:null,async:yT,autoCapitalize:null,autoComplete:wT,autoFocus:yT,autoPlay:yT,blocking:wT,capture:null,charSet:null,checked:yT,cite:null,className:wT,cols:_T,colSpan:null,content:null,contentEditable:xT,controls:yT,controlsList:wT,coords:_T|ST,crossOrigin:null,data:null,dateTime:null,decoding:null,default:yT,defer:yT,dir:null,dirName:null,disabled:yT,download:bT,draggable:xT,encType:null,enterKeyHint:null,fetchPriority:null,form:null,formAction:null,formEncType:null,formMethod:null,formNoValidate:yT,formTarget:null,headers:wT,height:_T,hidden:bT,high:_T,href:null,hrefLang:null,htmlFor:wT,httpEquiv:wT,id:null,imageSizes:null,imageSrcSet:null,inert:yT,inputMode:null,integrity:null,is:null,isMap:yT,itemId:null,itemProp:wT,itemRef:wT,itemScope:yT,itemType:wT,kind:null,label:null,lang:null,language:null,list:null,loading:null,loop:yT,low:_T,manifest:null,max:null,maxLength:_T,media:null,method:null,min:null,minLength:_T,multiple:yT,muted:yT,name:null,nonce:null,noModule:yT,noValidate:yT,onAbort:null,onAfterPrint:null,onAuxClick:null,onBeforeMatch:null,onBeforePrint:null,onBeforeToggle:null,onBeforeUnload:null,onBlur:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onContextLost:null,onContextMenu:null,onContextRestored:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnded:null,onError:null,onFocus:null,onFormData:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLanguageChange:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadEnd:null,onLoadStart:null,onMessage:null,onMessageError:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRejectionHandled:null,onReset:null,onResize:null,onScroll:null,onScrollEnd:null,onSecurityPolicyViolation:null,onSeeked:null,onSeeking:null,onSelect:null,onSlotChange:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnhandledRejection:null,onUnload:null,onVolumeChange:null,onWaiting:null,onWheel:null,open:yT,optimum:_T,pattern:null,ping:wT,placeholder:null,playsInline:yT,popover:null,popoverTarget:null,popoverTargetAction:null,poster:null,preload:null,readOnly:yT,referrerPolicy:null,rel:wT,required:yT,reversed:yT,rows:_T,rowSpan:_T,sandbox:wT,scope:null,scoped:yT,seamless:yT,selected:yT,shadowRootClonable:yT,shadowRootDelegatesFocus:yT,shadowRootMode:null,shape:null,size:_T,sizes:null,slot:null,span:_T,spellCheck:xT,src:null,srcDoc:null,srcLang:null,srcSet:null,start:_T,step:null,style:null,tabIndex:_T,target:null,title:null,translate:null,type:null,typeMustMatch:yT,useMap:null,value:xT,width:_T,wrap:null,writingSuggestions:null,align:null,aLink:null,archive:wT,axis:null,background:null,bgColor:null,border:_T,borderColor:null,bottomMargin:_T,cellPadding:null,cellSpacing:null,char:null,charOff:null,classId:null,clear:null,code:null,codeBase:null,codeType:null,color:null,compact:yT,declare:yT,event:null,face:null,frame:null,frameBorder:null,hSpace:_T,leftMargin:_T,link:null,longDesc:null,lowSrc:null,marginHeight:_T,marginWidth:_T,noResize:yT,noHref:yT,noShade:yT,noWrap:yT,object:null,profile:null,prompt:null,rev:null,rightMargin:_T,rules:null,scheme:null,scrolling:xT,standby:null,summary:null,text:null,topMargin:_T,valueType:null,version:null,vAlign:null,vLink:null,vSpace:_T,allowTransparency:null,autoCorrect:null,autoSave:null,disablePictureInPicture:yT,disableRemotePlayback:yT,prefix:null,property:null,results:_T,security:null,unselectable:null},space:"html",transform:RT}),LT=PT({attributes:{accentHeight:"accent-height",alignmentBaseline:"alignment-baseline",arabicForm:"arabic-form",baselineShift:"baseline-shift",capHeight:"cap-height",className:"class",clipPath:"clip-path",clipRule:"clip-rule",colorInterpolation:"color-interpolation",colorInterpolationFilters:"color-interpolation-filters",colorProfile:"color-profile",colorRendering:"color-rendering",crossOrigin:"crossorigin",dataType:"datatype",dominantBaseline:"dominant-baseline",enableBackground:"enable-background",fillOpacity:"fill-opacity",fillRule:"fill-rule",floodColor:"flood-color",floodOpacity:"flood-opacity",fontFamily:"font-family",fontSize:"font-size",fontSizeAdjust:"font-size-adjust",fontStretch:"font-stretch",fontStyle:"font-style",fontVariant:"font-variant",fontWeight:"font-weight",glyphName:"glyph-name",glyphOrientationHorizontal:"glyph-orientation-horizontal",glyphOrientationVertical:"glyph-orientation-vertical",hrefLang:"hreflang",horizAdvX:"horiz-adv-x",horizOriginX:"horiz-origin-x",horizOriginY:"horiz-origin-y",imageRendering:"image-rendering",letterSpacing:"letter-spacing",lightingColor:"lighting-color",markerEnd:"marker-end",markerMid:"marker-mid",markerStart:"marker-start",navDown:"nav-down",navDownLeft:"nav-down-left",navDownRight:"nav-down-right",navLeft:"nav-left",navNext:"nav-next",navPrev:"nav-prev",navRight:"nav-right",navUp:"nav-up",navUpLeft:"nav-up-left",navUpRight:"nav-up-right",onAbort:"onabort",onActivate:"onactivate",onAfterPrint:"onafterprint",onBeforePrint:"onbeforeprint",onBegin:"onbegin",onCancel:"oncancel",onCanPlay:"oncanplay",onCanPlayThrough:"oncanplaythrough",onChange:"onchange",onClick:"onclick",onClose:"onclose",onCopy:"oncopy",onCueChange:"oncuechange",onCut:"oncut",onDblClick:"ondblclick",onDrag:"ondrag",onDragEnd:"ondragend",onDragEnter:"ondragenter",onDragExit:"ondragexit",onDragLeave:"ondragleave",onDragOver:"ondragover",onDragStart:"ondragstart",onDrop:"ondrop",onDurationChange:"ondurationchange",onEmptied:"onemptied",onEnd:"onend",onEnded:"onended",onError:"onerror",onFocus:"onfocus",onFocusIn:"onfocusin",onFocusOut:"onfocusout",onHashChange:"onhashchange",onInput:"oninput",onInvalid:"oninvalid",onKeyDown:"onkeydown",onKeyPress:"onkeypress",onKeyUp:"onkeyup",onLoad:"onload",onLoadedData:"onloadeddata",onLoadedMetadata:"onloadedmetadata",onLoadStart:"onloadstart",onMessage:"onmessage",onMouseDown:"onmousedown",onMouseEnter:"onmouseenter",onMouseLeave:"onmouseleave",onMouseMove:"onmousemove",onMouseOut:"onmouseout",onMouseOver:"onmouseover",onMouseUp:"onmouseup",onMouseWheel:"onmousewheel",onOffline:"onoffline",onOnline:"ononline",onPageHide:"onpagehide",onPageShow:"onpageshow",onPaste:"onpaste",onPause:"onpause",onPlay:"onplay",onPlaying:"onplaying",onPopState:"onpopstate",onProgress:"onprogress",onRateChange:"onratechange",onRepeat:"onrepeat",onReset:"onreset",onResize:"onresize",onScroll:"onscroll",onSeeked:"onseeked",onSeeking:"onseeking",onSelect:"onselect",onShow:"onshow",onStalled:"onstalled",onStorage:"onstorage",onSubmit:"onsubmit",onSuspend:"onsuspend",onTimeUpdate:"ontimeupdate",onToggle:"ontoggle",onUnload:"onunload",onVolumeChange:"onvolumechange",onWaiting:"onwaiting",onZoom:"onzoom",overlinePosition:"overline-position",overlineThickness:"overline-thickness",paintOrder:"paint-order",panose1:"panose-1",pointerEvents:"pointer-events",referrerPolicy:"referrerpolicy",renderingIntent:"rendering-intent",shapeRendering:"shape-rendering",stopColor:"stop-color",stopOpacity:"stop-opacity",strikethroughPosition:"strikethrough-position",strikethroughThickness:"strikethrough-thickness",strokeDashArray:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",strokeLineCap:"stroke-linecap",strokeLineJoin:"stroke-linejoin",strokeMiterLimit:"stroke-miterlimit",strokeOpacity:"stroke-opacity",strokeWidth:"stroke-width",tabIndex:"tabindex",textAnchor:"text-anchor",textDecoration:"text-decoration",textRendering:"text-rendering",transformOrigin:"transform-origin",typeOf:"typeof",underlinePosition:"underline-position",underlineThickness:"underline-thickness",unicodeBidi:"unicode-bidi",unicodeRange:"unicode-range",unitsPerEm:"units-per-em",vAlphabetic:"v-alphabetic",vHanging:"v-hanging",vIdeographic:"v-ideographic",vMathematical:"v-mathematical",vectorEffect:"vector-effect",vertAdvY:"vert-adv-y",vertOriginX:"vert-origin-x",vertOriginY:"vert-origin-y",wordSpacing:"word-spacing",writingMode:"writing-mode",xHeight:"x-height",playbackOrder:"playbackorder",timelineBegin:"timelinebegin"},properties:{about:MT,accentHeight:_T,accumulate:null,additive:null,alignmentBaseline:null,alphabetic:_T,amplitude:_T,arabicForm:null,ascent:_T,attributeName:null,attributeType:null,azimuth:_T,bandwidth:null,baselineShift:null,baseFrequency:null,baseProfile:null,bbox:null,begin:null,bias:_T,by:null,calcMode:null,capHeight:_T,className:wT,clip:null,clipPath:null,clipPathUnits:null,clipRule:null,color:null,colorInterpolation:null,colorInterpolationFilters:null,colorProfile:null,colorRendering:null,content:null,contentScriptType:null,contentStyleType:null,crossOrigin:null,cursor:null,cx:null,cy:null,d:null,dataType:null,defaultAction:null,descent:_T,diffuseConstant:_T,direction:null,display:null,dur:null,divisor:_T,dominantBaseline:null,download:yT,dx:null,dy:null,edgeMode:null,editable:null,elevation:_T,enableBackground:null,end:null,event:null,exponent:_T,externalResourcesRequired:null,fill:null,fillOpacity:_T,fillRule:null,filter:null,filterRes:null,filterUnits:null,floodColor:null,floodOpacity:null,focusable:null,focusHighlight:null,fontFamily:null,fontSize:null,fontSizeAdjust:null,fontStretch:null,fontStyle:null,fontVariant:null,fontWeight:null,format:null,fr:null,from:null,fx:null,fy:null,g1:ST,g2:ST,glyphName:ST,glyphOrientationHorizontal:null,glyphOrientationVertical:null,glyphRef:null,gradientTransform:null,gradientUnits:null,handler:null,hanging:_T,hatchContentUnits:null,hatchUnits:null,height:null,href:null,hrefLang:null,horizAdvX:_T,horizOriginX:_T,horizOriginY:_T,id:null,ideographic:_T,imageRendering:null,initialVisibility:null,in:null,in2:null,intercept:_T,k:_T,k1:_T,k2:_T,k3:_T,k4:_T,kernelMatrix:MT,kernelUnitLength:null,keyPoints:null,keySplines:null,keyTimes:null,kerning:null,lang:null,lengthAdjust:null,letterSpacing:null,lightingColor:null,limitingConeAngle:_T,local:null,markerEnd:null,markerMid:null,markerStart:null,markerHeight:null,markerUnits:null,markerWidth:null,mask:null,maskContentUnits:null,maskUnits:null,mathematical:null,max:null,media:null,mediaCharacterEncoding:null,mediaContentEncodings:null,mediaSize:_T,mediaTime:null,method:null,min:null,mode:null,name:null,navDown:null,navDownLeft:null,navDownRight:null,navLeft:null,navNext:null,navPrev:null,navRight:null,navUp:null,navUpLeft:null,navUpRight:null,numOctaves:null,observer:null,offset:null,onAbort:null,onActivate:null,onAfterPrint:null,onBeforePrint:null,onBegin:null,onCancel:null,onCanPlay:null,onCanPlayThrough:null,onChange:null,onClick:null,onClose:null,onCopy:null,onCueChange:null,onCut:null,onDblClick:null,onDrag:null,onDragEnd:null,onDragEnter:null,onDragExit:null,onDragLeave:null,onDragOver:null,onDragStart:null,onDrop:null,onDurationChange:null,onEmptied:null,onEnd:null,onEnded:null,onError:null,onFocus:null,onFocusIn:null,onFocusOut:null,onHashChange:null,onInput:null,onInvalid:null,onKeyDown:null,onKeyPress:null,onKeyUp:null,onLoad:null,onLoadedData:null,onLoadedMetadata:null,onLoadStart:null,onMessage:null,onMouseDown:null,onMouseEnter:null,onMouseLeave:null,onMouseMove:null,onMouseOut:null,onMouseOver:null,onMouseUp:null,onMouseWheel:null,onOffline:null,onOnline:null,onPageHide:null,onPageShow:null,onPaste:null,onPause:null,onPlay:null,onPlaying:null,onPopState:null,onProgress:null,onRateChange:null,onRepeat:null,onReset:null,onResize:null,onScroll:null,onSeeked:null,onSeeking:null,onSelect:null,onShow:null,onStalled:null,onStorage:null,onSubmit:null,onSuspend:null,onTimeUpdate:null,onToggle:null,onUnload:null,onVolumeChange:null,onWaiting:null,onZoom:null,opacity:null,operator:null,order:null,orient:null,orientation:null,origin:null,overflow:null,overlay:null,overlinePosition:_T,overlineThickness:_T,paintOrder:null,panose1:null,path:null,pathLength:_T,patternContentUnits:null,patternTransform:null,patternUnits:null,phase:null,ping:wT,pitch:null,playbackOrder:null,pointerEvents:null,points:null,pointsAtX:_T,pointsAtY:_T,pointsAtZ:_T,preserveAlpha:null,preserveAspectRatio:null,primitiveUnits:null,propagate:null,property:MT,r:null,radius:null,referrerPolicy:null,refX:null,refY:null,rel:MT,rev:MT,renderingIntent:null,repeatCount:null,repeatDur:null,requiredExtensions:MT,requiredFeatures:MT,requiredFonts:MT,requiredFormats:MT,resource:null,restart:null,result:null,rotate:null,rx:null,ry:null,scale:null,seed:null,shapeRendering:null,side:null,slope:null,snapshotTime:null,specularConstant:_T,specularExponent:_T,spreadMethod:null,spacing:null,startOffset:null,stdDeviation:null,stemh:null,stemv:null,stitchTiles:null,stopColor:null,stopOpacity:null,strikethroughPosition:_T,strikethroughThickness:_T,string:null,stroke:null,strokeDashArray:MT,strokeDashOffset:null,strokeLineCap:null,strokeLineJoin:null,strokeMiterLimit:_T,strokeOpacity:_T,strokeWidth:null,style:null,surfaceScale:_T,syncBehavior:null,syncBehaviorDefault:null,syncMaster:null,syncTolerance:null,syncToleranceDefault:null,systemLanguage:MT,tabIndex:_T,tableValues:null,target:null,targetX:_T,targetY:_T,textAnchor:null,textDecoration:null,textRendering:null,textLength:null,timelineBegin:null,title:null,transformBehavior:null,type:null,typeOf:MT,to:null,transform:null,transformOrigin:null,u1:null,u2:null,underlinePosition:_T,underlineThickness:_T,unicode:null,unicodeBidi:null,unicodeRange:null,unitsPerEm:_T,values:null,vAlphabetic:_T,vMathematical:_T,vectorEffect:null,vHanging:_T,vIdeographic:_T,version:null,vertAdvY:_T,vertOriginX:_T,vertOriginY:_T,viewBox:null,viewTarget:null,visibility:null,width:null,widths:null,wordSpacing:null,writingMode:null,x:null,x1:null,x2:null,xChannelSelector:null,xHeight:_T,y:null,y1:null,y2:null,yChannelSelector:null,z:null,zoomAndPan:null},space:"svg",transform:AT}),DT=PT({properties:{xLinkActuate:null,xLinkArcRole:null,xLinkHref:null,xLinkRole:null,xLinkShow:null,xLinkTitle:null,xLinkType:null},space:"xlink",transform:(e,t)=>"xlink:"+t.slice(5).toLowerCase()}),UT=PT({attributes:{xmlnsxlink:"xmlns:xlink"},properties:{xmlnsXLink:null,xmlns:null},space:"xmlns",transform:RT}),OT=PT({properties:{xmlBase:null,xmlLang:null,xmlSpace:null},space:"xml",transform:(e,t)=>"xml:"+t.slice(3).toLowerCase()}),FT={classId:"classID",dataType:"datatype",itemId:"itemID",strokeDashArray:"strokeDasharray",strokeDashOffset:"strokeDashoffset",strokeLineCap:"strokeLinecap",strokeLineJoin:"strokeLinejoin",strokeMiterLimit:"strokeMiterlimit",typeOf:"typeof",xLinkActuate:"xlinkActuate",xLinkArcRole:"xlinkArcrole",xLinkHref:"xlinkHref",xLinkRole:"xlinkRole",xLinkShow:"xlinkShow",xLinkTitle:"xlinkTitle",xLinkType:"xlinkType",xmlnsXLink:"xmlnsXlink"},zT=/[A-Z]/g,BT=/-[a-z]/g,HT=/^data[-\w.:]+$/i;function $T(e){return"-"+e.toLowerCase()}function VT(e){return e.charAt(1).toUpperCase()}const WT=mT([jT,IT,DT,UT,OT],"html"),GT=mT([jT,LT,DT,UT,OT],"svg");var XT={},qT=/\/\*[^*]*\*+([^/*][^*]*\*+)*\//g,KT=/\n/g,YT=/^\s*/,JT=/^(\*?[-#/*\\\w]+(\[[0-9a-z_-]+\])?)\s*/,ZT=/^:\s*/,QT=/^((?:'(?:\\'|.)*?'|"(?:\\"|.)*?"|\([^)]*?\)|[^};])+)/,eN=/^[;\s]*/,tN=/^\s+|\s+$/g,nN="";function aN(e){return e?e.replace(tN,nN):nN}var rN=function(e,t){if("string"!=typeof e)throw new TypeError("First argument must be a string");if(!e)return[];t=t||{};var n=1,a=1;function r(e){var t=e.match(KT);t&&(n+=t.length);var r=e.lastIndexOf("\n");a=~r?e.length-r:a+e.length}function i(){var e={line:n,column:a};return function(t){return t.position=new s(e),c(),t}}function s(e){this.start=e,this.end={line:n,column:a},this.source=t.source}function o(r){var i=new Error(t.source+":"+n+":"+a+": "+r);if(i.reason=r,i.filename=t.source,i.line=n,i.column=a,i.source=e,!t.silent)throw i}function l(t){var n=t.exec(e);if(n){var a=n[0];return r(a),e=e.slice(a.length),n}}function c(){l(YT)}function d(e){var t;for(e=e||[];t=u();)!1!==t&&e.push(t);return e}function u(){var t=i();if("/"==e.charAt(0)&&"*"==e.charAt(1)){for(var n=2;nN!=e.charAt(n)&&("*"!=e.charAt(n)||"/"!=e.charAt(n+1));)++n;if(n+=2,nN===e.charAt(n-1))return o("End of comment missing");var s=e.slice(2,n-2);return a+=2,r(s),e=e.slice(n),a+=2,t({type:"comment",comment:s})}}function h(){var e=i(),t=l(JT);if(t){if(u(),!l(ZT))return o("property missing ':'");var n=l(QT),a=e({type:"declaration",property:aN(t[0].replace(qT,nN)),value:n?aN(n[0].replace(qT,nN)):nN});return l(eN),a}}return s.prototype.content=e,c(),function(){var e,t=[];for(d(t);e=h();)!1!==e&&(t.push(e),d(t));return t}()},iN=He&&He.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(XT,"__esModule",{value:!0}),XT.default=function(e,t){let n=null;if(!e||"string"!=typeof e)return n;const a=(0,sN.default)(e),r="function"==typeof t;return a.forEach(e=>{if("declaration"!==e.type)return;const{property:a,value:i}=e;r?t(a,i,e):i&&(n=n||{},n[a]=i)}),n};const sN=iN(rN);var oN={};Object.defineProperty(oN,"__esModule",{value:!0}),oN.camelCase=void 0;var lN=/^--[a-zA-Z0-9_-]+$/,cN=/-([a-z])/g,dN=/^[^-]+$/,uN=/^-(webkit|moz|ms|o|khtml)-/,hN=/^-(ms)-/,pN=function(e,t){return t.toUpperCase()},mN=function(e,t){return"".concat(t,"-")};oN.camelCase=function(e,t){return void 0===t&&(t={}),function(e){return!e||dN.test(e)||lN.test(e)}(e)?e:(e=e.toLowerCase(),(e=t.reactCompat?e.replace(hN,mN):e.replace(uN,mN)).replace(cN,pN))};var fN=(He&&He.__importDefault||function(e){return e&&e.__esModule?e:{default:e}})(XT),gN=oN;function vN(e,t){var n={};return e&&"string"==typeof e?((0,fN.default)(e,function(e,a){e&&a&&(n[(0,gN.camelCase)(e,t)]=a)}),n):n}vN.default=vN;const yN=$e(vN),xN=_N("end"),bN=_N("start");function _N(e){return function(t){const n=t&&t.position&&t.position[e]||{};if("number"==typeof n.line&&n.line>0&&"number"==typeof n.column&&n.column>0)return{line:n.line,column:n.column,offset:"number"==typeof n.offset&&n.offset>-1?n.offset:void 0}}}function wN(e){return e&&"object"==typeof e?"position"in e||"type"in e?MN(e.position):"start"in e||"end"in e?MN(e):"line"in e||"column"in e?SN(e):"":""}function SN(e){return CN(e&&e.line)+":"+CN(e&&e.column)}function MN(e){return SN(e&&e.start)+"-"+SN(e&&e.end)}function CN(e){return e&&"number"==typeof e?e:1}class EN extends Error{constructor(e,t,n){super(),"string"==typeof t&&(n=t,t=void 0);let a="",r={},i=!1;if(t&&(r="line"in t&&"column"in t||"start"in t&&"end"in t?{place:t}:"type"in t?{ancestors:[t],place:t.position}:{...t}),"string"==typeof e?a=e:!r.cause&&e&&(i=!0,a=e.message,r.cause=e),!r.ruleId&&!r.source&&"string"==typeof n){const e=n.indexOf(":");-1===e?r.ruleId=n:(r.source=n.slice(0,e),r.ruleId=n.slice(e+1))}if(!r.place&&r.ancestors&&r.ancestors){const e=r.ancestors[r.ancestors.length-1];e&&(r.place=e.position)}const s=r.place&&"start"in r.place?r.place.start:r.place;this.ancestors=r.ancestors||void 0,this.cause=r.cause||void 0,this.column=s?s.column:void 0,this.fatal=void 0,this.file="",this.message=a,this.line=s?s.line:void 0,this.name=wN(r.place)||"1:1",this.place=r.place||void 0,this.reason=this.message,this.ruleId=r.ruleId||void 0,this.source=r.source||void 0,this.stack=i&&r.cause&&"string"==typeof r.cause.stack?r.cause.stack:"",this.actual=void 0,this.expected=void 0,this.note=void 0,this.url=void 0}}EN.prototype.file="",EN.prototype.name="",EN.prototype.reason="",EN.prototype.message="",EN.prototype.stack="",EN.prototype.column=void 0,EN.prototype.line=void 0,EN.prototype.ancestors=void 0,EN.prototype.cause=void 0,EN.prototype.fatal=void 0,EN.prototype.place=void 0,EN.prototype.ruleId=void 0,EN.prototype.source=void 0;const kN={}.hasOwnProperty,TN=new Map,NN=/[A-Z]/g,PN=new Set(["table","tbody","thead","tfoot","tr"]),jN=new Set(["td","th"]),AN="https://github.com/syntax-tree/hast-util-to-jsx-runtime";function RN(e,t){if(!t||void 0===t.Fragment)throw new TypeError("Expected `Fragment` in options");const n=t.filePath||void 0;let a;if(t.development){if("function"!=typeof t.jsxDEV)throw new TypeError("Expected `jsxDEV` in options when `development: true`");a=function(e,t){return n;function n(n,a,r,i){const s=Array.isArray(r.children),o=bN(n);return t(a,r,i,s,{columnNumber:o?o.column-1:void 0,fileName:e,lineNumber:o?o.line:void 0},void 0)}}(n,t.jsxDEV)}else{if("function"!=typeof t.jsx)throw new TypeError("Expected `jsx` in production options");if("function"!=typeof t.jsxs)throw new TypeError("Expected `jsxs` in production options");a=function(e,t,n){return a;function a(e,a,r,i){const s=Array.isArray(r.children)?n:t;return i?s(a,r,i):s(a,r)}}(0,t.jsx,t.jsxs)}const r={Fragment:t.Fragment,ancestors:[],components:t.components||{},create:a,elementAttributeNameCase:t.elementAttributeNameCase||"react",evaluater:t.createEvaluater?t.createEvaluater():void 0,filePath:n,ignoreInvalidStyle:t.ignoreInvalidStyle||!1,passKeys:!1!==t.passKeys,passNode:t.passNode||!1,schema:"svg"===t.space?GT:WT,stylePropertyNameCase:t.stylePropertyNameCase||"dom",tableCellAlignToStyle:!1!==t.tableCellAlignToStyle},i=IN(r,e,void 0);return i&&"string"!=typeof i?i:r.create(e,r.Fragment,{children:i||void 0},void 0)}function IN(e,t,n){return"element"===t.type?function(e,t,n){const a=e.schema;let r=a;"svg"===t.tagName.toLowerCase()&&"html"===a.space&&(r=GT,e.schema=r);e.ancestors.push(t);const i=FN(e,t.tagName,!1),s=function(e,t){const n={};let a,r;for(r in t.properties)if("children"!==r&&kN.call(t.properties,r)){const i=ON(e,r,t.properties[r]);if(i){const[r,s]=i;e.tableCellAlignToStyle&&"align"===r&&"string"==typeof s&&jN.has(t.tagName)?a=s:n[r]=s}}if(a){(n.style||(n.style={}))["css"===e.stylePropertyNameCase?"text-align":"textAlign"]=a}return n}(e,t);let o=UN(e,t);PN.has(t.tagName)&&(o=o.filter(function(e){return"string"!=typeof e||!("object"==typeof(t=e)?"text"===t.type&&hT(t.value):hT(t));var t}));return LN(e,s,i,t),DN(s,o),e.ancestors.pop(),e.schema=a,e.create(t,i,s,n)}(e,t,n):"mdxFlowExpression"===t.type||"mdxTextExpression"===t.type?function(e,t){if(t.data&&t.data.estree&&e.evaluater){const n=t.data.estree.body[0];return n.type,e.evaluater.evaluateExpression(n.expression)}zN(e,t.position)}(e,t):"mdxJsxFlowElement"===t.type||"mdxJsxTextElement"===t.type?function(e,t,n){const a=e.schema;let r=a;"svg"===t.name&&"html"===a.space&&(r=GT,e.schema=r);e.ancestors.push(t);const i=null===t.name?e.Fragment:FN(e,t.name,!0),s=function(e,t){const n={};for(const a of t.attributes)if("mdxJsxExpressionAttribute"===a.type)if(a.data&&a.data.estree&&e.evaluater){const t=a.data.estree.body[0];iT(t.type);const r=t.expression;iT(r.type);const i=r.properties[0];iT(i.type),Object.assign(n,e.evaluater.evaluateExpression(i.argument))}else zN(e,t.position);else{const r=a.name;let i;if(a.value&&"object"==typeof a.value)if(a.value.data&&a.value.data.estree&&e.evaluater){const t=a.value.data.estree.body[0];iT(t.type),i=e.evaluater.evaluateExpression(t.expression)}else zN(e,t.position);else i=null===a.value||a.value;n[r]=i}return n}(e,t),o=UN(e,t);return LN(e,s,i,t),DN(s,o),e.ancestors.pop(),e.schema=a,e.create(t,i,s,n)}(e,t,n):"mdxjsEsm"===t.type?function(e,t){if(t.data&&t.data.estree&&e.evaluater)return e.evaluater.evaluateProgram(t.data.estree);zN(e,t.position)}(e,t):"root"===t.type?function(e,t,n){const a={};return DN(a,UN(e,t)),e.create(t,e.Fragment,a,n)}(e,t,n):"text"===t.type?function(e,t){return t.value}(0,t):void 0}function LN(e,t,n,a){"string"!=typeof n&&n!==e.Fragment&&e.passNode&&(t.node=a)}function DN(e,t){if(t.length>0){const n=t.length>1?t:t[0];n&&(e.children=n)}}function UN(e,t){const n=[];let a=-1;const r=e.passKeys?new Map:TN;for(;++a<t.children.length;){const i=t.children[a];let s;if(e.passKeys){const e="element"===i.type?i.tagName:"mdxJsxFlowElement"===i.type||"mdxJsxTextElement"===i.type?i.name:void 0;if(e){const t=r.get(e)||0;s=e+"-"+t,r.set(e,t+1)}}const o=IN(e,i,s);void 0!==o&&n.push(o)}return n}function ON(e,t,n){const a=function(e,t){const n=fT(t);let a=t,r=gT;if(n in e.normal)return e.property[e.normal[n]];if(n.length>4&&"data"===n.slice(0,4)&&HT.test(t)){if("-"===t.charAt(4)){const e=t.slice(5).replace(BT,VT);a="data"+e.charAt(0).toUpperCase()+e.slice(1)}else{const e=t.slice(4);if(!BT.test(e)){let n=e.replace(zT,$T);"-"!==n.charAt(0)&&(n="-"+n),t="data"+n}}r=TT}return new r(a,t)}(e.schema,t);if(!(null==n||"number"==typeof n&&Number.isNaN(n))){if(Array.isArray(n)&&(n=a.commaSeparated?function(e){const t={};return(""===e[e.length-1]?[...e,""]:e).join((t.padRight?" ":"")+","+(!1===t.padLeft?"":" ")).trim()}(n):n.join(" ").trim()),"style"===a.property){let t="object"==typeof n?n:function(e,t){try{return yN(t,{reactCompat:!0})}catch(n){if(e.ignoreInvalidStyle)return{};const t=n,a=new EN("Cannot parse `style` attribute",{ancestors:e.ancestors,cause:t,ruleId:"style",source:"hast-util-to-jsx-runtime"});throw a.file=e.filePath||void 0,a.url=AN+"#cannot-parse-style-attribute",a}}(e,String(n));return"css"===e.stylePropertyNameCase&&(t=function(e){const t={};let n;for(n in e)kN.call(e,n)&&(t[BN(n)]=e[n]);return t}(t)),["style",t]}return["react"===e.elementAttributeNameCase&&a.space?FT[a.property]||a.property:a.attribute,n]}}function FN(e,t,n){let a;if(n)if(t.includes(".")){const e=t.split(".");let n,r=-1;for(;++r<e.length;){const t=dT(e[r])?{type:"Identifier",name:e[r]}:{type:"Literal",value:e[r]};n=n?{type:"MemberExpression",object:n,property:t,computed:Boolean(r&&"Literal"===t.type),optional:!1}:t}a=n}else a=dT(t)&&!/^[a-z]/.test(t)?{type:"Identifier",name:t}:{type:"Literal",value:t};else a={type:"Literal",value:t};if("Literal"===a.type){const t=a.value;return kN.call(e.components,t)?e.components[t]:t}if(e.evaluater)return e.evaluater.evaluateExpression(a);zN(e)}function zN(e,t){const n=new EN("Cannot handle MDX estrees without `createEvaluater`",{ancestors:e.ancestors,place:t,ruleId:"mdx-estree",source:"hast-util-to-jsx-runtime"});throw n.file=e.filePath||void 0,n.url=AN+"#cannot-handle-mdx-estrees-without-createevaluater",n}function BN(e){let t=e.replace(NN,HN);return"ms-"===t.slice(0,3)&&(t="-"+t),t}function HN(e){return"-"+e.toLowerCase()}const $N={action:["form"],cite:["blockquote","del","ins","q"],data:["object"],formAction:["button","input"],href:["a","area","base","link"],icon:["menuitem"],itemId:null,manifest:["html"],ping:["a","area"],poster:["video"],src:["audio","embed","iframe","img","input","script","source","track","video"]},VN={};function WN(e,t,n){if(function(e){return Boolean(e&&"object"==typeof e)}(e)){if("value"in e)return"html"!==e.type||n?e.value:"";if(t&&"alt"in e&&e.alt)return e.alt;if("children"in e)return GN(e.children,t,n)}return Array.isArray(e)?GN(e,t,n):""}function GN(e,t,n){const a=[];let r=-1;for(;++r<e.length;)a[r]=WN(e[r],t,n);return a.join("")}const XN=document.createElement("i");function qN(e){const t="&"+e+";";XN.innerHTML=t;const n=XN.textContent;return(59!==n.charCodeAt(n.length-1)||"semi"===e)&&(n!==t&&n)}function KN(e,t,n,a){const r=e.length;let i,s=0;if(t=t<0?-t>r?0:r+t:t>r?r:t,n=n>0?n:0,a.length<1e4)i=Array.from(a),i.unshift(t,n),e.splice(...i);else for(n&&e.splice(t,n);s<a.length;)i=a.slice(s,s+1e4),i.unshift(t,0),e.splice(...i),s+=1e4,t+=1e4}function YN(e,t){return e.length>0?(KN(e,e.length,0,t),e):t}const JN={}.hasOwnProperty;function ZN(e,t){let n;for(n in t){const a=(JN.call(e,n)?e[n]:void 0)||(e[n]={}),r=t[n];let i;if(r)for(i in r){JN.call(a,i)||(a[i]=[]);const e=r[i];QN(a[i],Array.isArray(e)?e:e?[e]:[])}}}function QN(e,t){let n=-1;const a=[];for(;++n<t.length;)("after"===t[n].add?e:a).push(t[n]);KN(e,0,0,a)}function eP(e,t){const n=Number.parseInt(e,t);return n<9||11===n||n>13&&n<32||n>126&&n<160||n>55295&&n<57344||n>64975&&n<65008||!(65535&~n)||65534==(65535&n)||n>1114111?"":String.fromCodePoint(n)}function tP(e){return e.replace(/[\t\n\r ]+/g," ").replace(/^ | $/g,"").toLowerCase().toUpperCase()}const nP=mP(/[A-Za-z]/),aP=mP(/[\dA-Za-z]/),rP=mP(/[#-'*+\--9=?A-Z^-~]/);function iP(e){return null!==e&&(e<32||127===e)}const sP=mP(/\d/),oP=mP(/[\dA-Fa-f]/),lP=mP(/[!-/:-@[-`{-~]/);function cP(e){return null!==e&&e<-2}function dP(e){return null!==e&&(e<0||32===e)}function uP(e){return-2===e||-1===e||32===e}const hP=mP(new RegExp("\\p{P}|\\p{S}","u")),pP=mP(/\s/);function mP(e){return function(t){return null!==t&&t>-1&&e.test(String.fromCharCode(t))}}function fP(e){const t=[];let n=-1,a=0,r=0;for(;++n<e.length;){const i=e.charCodeAt(n);let s="";if(37===i&&aP(e.charCodeAt(n+1))&&aP(e.charCodeAt(n+2)))r=2;else if(i<128)/[!#$&-;=?-Z_a-z~]/.test(String.fromCharCode(i))||(s=String.fromCharCode(i));else if(i>55295&&i<57344){const t=e.charCodeAt(n+1);i<56320&&t>56319&&t<57344?(s=String.fromCharCode(i,t),r=1):s=""}else s=String.fromCharCode(i);s&&(t.push(e.slice(a,n),encodeURIComponent(s)),a=n+r+1,s=""),r&&(n+=r,r=0)}return t.join("")+e.slice(a)}function gP(e,t,n,a){const r=a?a-1:Number.POSITIVE_INFINITY;let i=0;return function(a){if(uP(a))return e.enter(n),s(a);return t(a)};function s(a){return uP(a)&&i++<r?(e.consume(a),s):(e.exit(n),t(a))}}const vP={tokenize:function(e){const t=e.attempt(this.parser.constructs.contentInitial,function(n){if(null===n)return void e.consume(n);return e.enter("lineEnding"),e.consume(n),e.exit("lineEnding"),gP(e,t,"linePrefix")},function(t){return e.enter("paragraph"),a(t)});let n;return t;function a(t){const a=e.enter("chunkText",{contentType:"text",previous:n});return n&&(n.next=a),n=a,r(t)}function r(t){return null===t?(e.exit("chunkText"),e.exit("paragraph"),void e.consume(t)):cP(t)?(e.consume(t),e.exit("chunkText"),a):(e.consume(t),r)}}};const yP={tokenize:function(e){const t=this,n=[];let a,r,i,s=0;return o;function o(a){if(s<n.length){const r=n[s];return t.containerState=r[1],e.attempt(r[0].continuation,l,c)(a)}return c(a)}function l(e){if(s++,t.containerState._closeFlow){t.containerState._closeFlow=void 0,a&&y();const n=t.events.length;let r,i=n;for(;i--;)if("exit"===t.events[i][0]&&"chunkFlow"===t.events[i][1].type){r=t.events[i][1].end;break}v(s);let o=n;for(;o<t.events.length;)t.events[o][1].end={...r},o++;return KN(t.events,i+1,0,t.events.slice(n)),t.events.length=o,c(e)}return o(e)}function c(r){if(s===n.length){if(!a)return h(r);if(a.currentConstruct&&a.currentConstruct.concrete)return m(r);t.interrupt=Boolean(a.currentConstruct&&!a._gfmTableDynamicInterruptHack)}return t.containerState={},e.check(xP,d,u)(r)}function d(e){return a&&y(),v(s),h(e)}function u(e){return t.parser.lazy[t.now().line]=s!==n.length,i=t.now().offset,m(e)}function h(n){return t.containerState={},e.attempt(xP,p,m)(n)}function p(e){return s++,n.push([t.currentConstruct,t.containerState]),h(e)}function m(n){return null===n?(a&&y(),v(0),void e.consume(n)):(a=a||t.parser.flow(t.now()),e.enter("chunkFlow",{_tokenizer:a,contentType:"flow",previous:r}),f(n))}function f(n){return null===n?(g(e.exit("chunkFlow"),!0),v(0),void e.consume(n)):cP(n)?(e.consume(n),g(e.exit("chunkFlow")),s=0,t.interrupt=void 0,o):(e.consume(n),f)}function g(e,n){const o=t.sliceStream(e);if(n&&o.push(null),e.previous=r,r&&(r.next=e),r=e,a.defineSkip(e.start),a.write(o),t.parser.lazy[e.start.line]){let e=a.events.length;for(;e--;)if(a.events[e][1].start.offset<i&&(!a.events[e][1].end||a.events[e][1].end.offset>i))return;const n=t.events.length;let r,o,l=n;for(;l--;)if("exit"===t.events[l][0]&&"chunkFlow"===t.events[l][1].type){if(r){o=t.events[l][1].end;break}r=!0}for(v(s),e=n;e<t.events.length;)t.events[e][1].end={...o},e++;KN(t.events,l+1,0,t.events.slice(n)),t.events.length=e}}function v(a){let r=n.length;for(;r-- >a;){const a=n[r];t.containerState=a[1],a[0].exit.call(t,e)}n.length=a}function y(){a.write([null]),r=void 0,a=void 0,t.containerState._closeFlow=void 0}}},xP={tokenize:function(e,t,n){return gP(e,e.attempt(this.parser.constructs.document,t,n),"linePrefix",this.parser.constructs.disable.null.includes("codeIndented")?void 0:4)}};function bP(e){return null===e||dP(e)||pP(e)?1:hP(e)?2:void 0}function _P(e,t,n){const a=[];let r=-1;for(;++r<e.length;){const i=e[r].resolveAll;i&&!a.includes(i)&&(t=i(t,n),a.push(i))}return t}const wP={name:"attention",resolveAll:function(e,t){let n,a,r,i,s,o,l,c,d=-1;for(;++d<e.length;)if("enter"===e[d][0]&&"attentionSequence"===e[d][1].type&&e[d][1]._close)for(n=d;n--;)if("exit"===e[n][0]&&"attentionSequence"===e[n][1].type&&e[n][1]._open&&t.sliceSerialize(e[n][1]).charCodeAt(0)===t.sliceSerialize(e[d][1]).charCodeAt(0)){if((e[n][1]._close||e[d][1]._open)&&(e[d][1].end.offset-e[d][1].start.offset)%3&&!((e[n][1].end.offset-e[n][1].start.offset+e[d][1].end.offset-e[d][1].start.offset)%3))continue;o=e[n][1].end.offset-e[n][1].start.offset>1&&e[d][1].end.offset-e[d][1].start.offset>1?2:1;const u={...e[n][1].end},h={...e[d][1].start};SP(u,-o),SP(h,o),i={type:o>1?"strongSequence":"emphasisSequence",start:u,end:{...e[n][1].end}},s={type:o>1?"strongSequence":"emphasisSequence",start:{...e[d][1].start},end:h},r={type:o>1?"strongText":"emphasisText",start:{...e[n][1].end},end:{...e[d][1].start}},a={type:o>1?"strong":"emphasis",start:{...i.start},end:{...s.end}},e[n][1].end={...i.start},e[d][1].start={...s.end},l=[],e[n][1].end.offset-e[n][1].start.offset&&(l=YN(l,[["enter",e[n][1],t],["exit",e[n][1],t]])),l=YN(l,[["enter",a,t],["enter",i,t],["exit",i,t],["enter",r,t]]),l=YN(l,_P(t.parser.constructs.insideSpan.null,e.slice(n+1,d),t)),l=YN(l,[["exit",r,t],["enter",s,t],["exit",s,t],["exit",a,t]]),e[d][1].end.offset-e[d][1].start.offset?(c=2,l=YN(l,[["enter",e[d][1],t],["exit",e[d][1],t]])):c=0,KN(e,n-1,d-n+3,l),d=n+l.length-c-2;break}d=-1;for(;++d<e.length;)"attentionSequence"===e[d][1].type&&(e[d][1].type="data");return e},tokenize:function(e,t){const n=this.parser.constructs.attentionMarkers.null,a=this.previous,r=bP(a);let i;return function(t){return i=t,e.enter("attentionSequence"),s(t)};function s(o){if(o===i)return e.consume(o),s;const l=e.exit("attentionSequence"),c=bP(o),d=!c||2===c&&r||n.includes(o),u=!r||2===r&&c||n.includes(a);return l._open=Boolean(42===i?d:d&&(r||!u)),l._close=Boolean(42===i?u:u&&(c||!d)),t(o)}}};function SP(e,t){e.column+=t,e.offset+=t,e._bufferIndex+=t}const MP={name:"autolink",tokenize:function(e,t,n){let a=0;return function(t){return e.enter("autolink"),e.enter("autolinkMarker"),e.consume(t),e.exit("autolinkMarker"),e.enter("autolinkProtocol"),r};function r(t){return nP(t)?(e.consume(t),i):64===t?n(t):l(t)}function i(e){return 43===e||45===e||46===e||aP(e)?(a=1,s(e)):l(e)}function s(t){return 58===t?(e.consume(t),a=0,o):(43===t||45===t||46===t||aP(t))&&a++<32?(e.consume(t),s):(a=0,l(t))}function o(a){return 62===a?(e.exit("autolinkProtocol"),e.enter("autolinkMarker"),e.consume(a),e.exit("autolinkMarker"),e.exit("autolink"),t):null===a||32===a||60===a||iP(a)?n(a):(e.consume(a),o)}function l(t){return 64===t?(e.consume(t),c):rP(t)?(e.consume(t),l):n(t)}function c(e){return aP(e)?d(e):n(e)}function d(n){return 46===n?(e.consume(n),a=0,c):62===n?(e.exit("autolinkProtocol").type="autolinkEmail",e.enter("autolinkMarker"),e.consume(n),e.exit("autolinkMarker"),e.exit("autolink"),t):u(n)}function u(t){if((45===t||aP(t))&&a++<63){const n=45===t?u:d;return e.consume(t),n}return n(t)}}};const CP={partial:!0,tokenize:function(e,t,n){return function(t){return uP(t)?gP(e,a,"linePrefix")(t):a(t)};function a(e){return null===e||cP(e)?t(e):n(e)}}};const EP={continuation:{tokenize:function(e,t,n){const a=this;return function(t){if(uP(t))return gP(e,r,"linePrefix",a.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(t);return r(t)};function r(a){return e.attempt(EP,t,n)(a)}}},exit:function(e){e.exit("blockQuote")},name:"blockQuote",tokenize:function(e,t,n){const a=this;return function(t){if(62===t){const n=a.containerState;return n.open||(e.enter("blockQuote",{_container:!0}),n.open=!0),e.enter("blockQuotePrefix"),e.enter("blockQuoteMarker"),e.consume(t),e.exit("blockQuoteMarker"),r}return n(t)};function r(n){return uP(n)?(e.enter("blockQuotePrefixWhitespace"),e.consume(n),e.exit("blockQuotePrefixWhitespace"),e.exit("blockQuotePrefix"),t):(e.exit("blockQuotePrefix"),t(n))}}};const kP={name:"characterEscape",tokenize:function(e,t,n){return function(t){return e.enter("characterEscape"),e.enter("escapeMarker"),e.consume(t),e.exit("escapeMarker"),a};function a(a){return lP(a)?(e.enter("characterEscapeValue"),e.consume(a),e.exit("characterEscapeValue"),e.exit("characterEscape"),t):n(a)}}};const TP={name:"characterReference",tokenize:function(e,t,n){const a=this;let r,i,s=0;return function(t){return e.enter("characterReference"),e.enter("characterReferenceMarker"),e.consume(t),e.exit("characterReferenceMarker"),o};function o(t){return 35===t?(e.enter("characterReferenceMarkerNumeric"),e.consume(t),e.exit("characterReferenceMarkerNumeric"),l):(e.enter("characterReferenceValue"),r=31,i=aP,c(t))}function l(t){return 88===t||120===t?(e.enter("characterReferenceMarkerHexadecimal"),e.consume(t),e.exit("characterReferenceMarkerHexadecimal"),e.enter("characterReferenceValue"),r=6,i=oP,c):(e.enter("characterReferenceValue"),r=7,i=sP,c(t))}function c(o){if(59===o&&s){const r=e.exit("characterReferenceValue");return i!==aP||qN(a.sliceSerialize(r))?(e.enter("characterReferenceMarker"),e.consume(o),e.exit("characterReferenceMarker"),e.exit("characterReference"),t):n(o)}return i(o)&&s++<r?(e.consume(o),c):n(o)}}};const NP={partial:!0,tokenize:function(e,t,n){const a=this;return function(t){if(null===t)return n(t);return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),r};function r(e){return a.parser.lazy[a.now().line]?n(e):t(e)}}},PP={concrete:!0,name:"codeFenced",tokenize:function(e,t,n){const a=this,r={partial:!0,tokenize:function(e,t,n){let r=0;return s;function s(t){return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),l}function l(t){return e.enter("codeFencedFence"),uP(t)?gP(e,c,"linePrefix",a.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(t):c(t)}function c(t){return t===i?(e.enter("codeFencedFenceSequence"),d(t)):n(t)}function d(t){return t===i?(r++,e.consume(t),d):r>=o?(e.exit("codeFencedFenceSequence"),uP(t)?gP(e,u,"whitespace")(t):u(t)):n(t)}function u(a){return null===a||cP(a)?(e.exit("codeFencedFence"),t(a)):n(a)}}};let i,s=0,o=0;return function(t){return function(t){const n=a.events[a.events.length-1];return s=n&&"linePrefix"===n[1].type?n[2].sliceSerialize(n[1],!0).length:0,i=t,e.enter("codeFenced"),e.enter("codeFencedFence"),e.enter("codeFencedFenceSequence"),l(t)}(t)};function l(t){return t===i?(o++,e.consume(t),l):o<3?n(t):(e.exit("codeFencedFenceSequence"),uP(t)?gP(e,c,"whitespace")(t):c(t))}function c(n){return null===n||cP(n)?(e.exit("codeFencedFence"),a.interrupt?t(n):e.check(NP,p,y)(n)):(e.enter("codeFencedFenceInfo"),e.enter("chunkString",{contentType:"string"}),d(n))}function d(t){return null===t||cP(t)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),c(t)):uP(t)?(e.exit("chunkString"),e.exit("codeFencedFenceInfo"),gP(e,u,"whitespace")(t)):96===t&&t===i?n(t):(e.consume(t),d)}function u(t){return null===t||cP(t)?c(t):(e.enter("codeFencedFenceMeta"),e.enter("chunkString",{contentType:"string"}),h(t))}function h(t){return null===t||cP(t)?(e.exit("chunkString"),e.exit("codeFencedFenceMeta"),c(t)):96===t&&t===i?n(t):(e.consume(t),h)}function p(t){return e.attempt(r,y,m)(t)}function m(t){return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),f}function f(t){return s>0&&uP(t)?gP(e,g,"linePrefix",s+1)(t):g(t)}function g(t){return null===t||cP(t)?e.check(NP,p,y)(t):(e.enter("codeFlowValue"),v(t))}function v(t){return null===t||cP(t)?(e.exit("codeFlowValue"),g(t)):(e.consume(t),v)}function y(n){return e.exit("codeFenced"),t(n)}}};const jP={name:"codeIndented",tokenize:function(e,t,n){const a=this;return function(t){return e.enter("codeIndented"),gP(e,r,"linePrefix",5)(t)};function r(e){const t=a.events[a.events.length-1];return t&&"linePrefix"===t[1].type&&t[2].sliceSerialize(t[1],!0).length>=4?i(e):n(e)}function i(t){return null===t?o(t):cP(t)?e.attempt(AP,i,o)(t):(e.enter("codeFlowValue"),s(t))}function s(t){return null===t||cP(t)?(e.exit("codeFlowValue"),i(t)):(e.consume(t),s)}function o(n){return e.exit("codeIndented"),t(n)}}},AP={partial:!0,tokenize:function(e,t,n){const a=this;return r;function r(t){return a.parser.lazy[a.now().line]?n(t):cP(t)?(e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),r):gP(e,i,"linePrefix",5)(t)}function i(e){const i=a.events[a.events.length-1];return i&&"linePrefix"===i[1].type&&i[2].sliceSerialize(i[1],!0).length>=4?t(e):cP(e)?r(e):n(e)}}};const RP={name:"codeText",previous:function(e){return 96!==e||"characterEscape"===this.events[this.events.length-1][1].type},resolve:function(e){let t,n,a=e.length-4,r=3;if(!("lineEnding"!==e[r][1].type&&"space"!==e[r][1].type||"lineEnding"!==e[a][1].type&&"space"!==e[a][1].type))for(t=r;++t<a;)if("codeTextData"===e[t][1].type){e[r][1].type="codeTextPadding",e[a][1].type="codeTextPadding",r+=2,a-=2;break}t=r-1,a++;for(;++t<=a;)void 0===n?t!==a&&"lineEnding"!==e[t][1].type&&(n=t):t!==a&&"lineEnding"!==e[t][1].type||(e[n][1].type="codeTextData",t!==n+2&&(e[n][1].end=e[t-1][1].end,e.splice(n+2,t-n-2),a-=t-n-2,t=n+2),n=void 0);return e},tokenize:function(e,t,n){let a,r,i=0;return function(t){return e.enter("codeText"),e.enter("codeTextSequence"),s(t)};function s(t){return 96===t?(e.consume(t),i++,s):(e.exit("codeTextSequence"),o(t))}function o(t){return null===t?n(t):32===t?(e.enter("space"),e.consume(t),e.exit("space"),o):96===t?(r=e.enter("codeTextSequence"),a=0,c(t)):cP(t)?(e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),o):(e.enter("codeTextData"),l(t))}function l(t){return null===t||32===t||96===t||cP(t)?(e.exit("codeTextData"),o(t)):(e.consume(t),l)}function c(n){return 96===n?(e.consume(n),a++,c):a===i?(e.exit("codeTextSequence"),e.exit("codeText"),t(n)):(r.type="codeTextData",l(n))}}};class IP{constructor(e){this.left=e?[...e]:[],this.right=[]}get(e){if(e<0||e>=this.left.length+this.right.length)throw new RangeError("Cannot access index `"+e+"` in a splice buffer of size `"+(this.left.length+this.right.length)+"`");return e<this.left.length?this.left[e]:this.right[this.right.length-e+this.left.length-1]}get length(){return this.left.length+this.right.length}shift(){return this.setCursor(0),this.right.pop()}slice(e,t){const n=null==t?Number.POSITIVE_INFINITY:t;return n<this.left.length?this.left.slice(e,n):e>this.left.length?this.right.slice(this.right.length-n+this.left.length,this.right.length-e+this.left.length).reverse():this.left.slice(e).concat(this.right.slice(this.right.length-n+this.left.length).reverse())}splice(e,t,n){const a=t||0;this.setCursor(Math.trunc(e));const r=this.right.splice(this.right.length-a,Number.POSITIVE_INFINITY);return n&&LP(this.left,n),r.reverse()}pop(){return this.setCursor(Number.POSITIVE_INFINITY),this.left.pop()}push(e){this.setCursor(Number.POSITIVE_INFINITY),this.left.push(e)}pushMany(e){this.setCursor(Number.POSITIVE_INFINITY),LP(this.left,e)}unshift(e){this.setCursor(0),this.right.push(e)}unshiftMany(e){this.setCursor(0),LP(this.right,e.reverse())}setCursor(e){if(!(e===this.left.length||e>this.left.length&&0===this.right.length||e<0&&0===this.left.length))if(e<this.left.length){const t=this.left.splice(e,Number.POSITIVE_INFINITY);LP(this.right,t.reverse())}else{const t=this.right.splice(this.left.length+this.right.length-e,Number.POSITIVE_INFINITY);LP(this.left,t.reverse())}}}function LP(e,t){let n=0;if(t.length<1e4)e.push(...t);else for(;n<t.length;)e.push(...t.slice(n,n+1e4)),n+=1e4}function DP(e){const t={};let n,a,r,i,s,o,l,c=-1;const d=new IP(e);for(;++c<d.length;){for(;c in t;)c=t[c];if(n=d.get(c),c&&"chunkFlow"===n[1].type&&"listItemPrefix"===d.get(c-1)[1].type&&(o=n[1]._tokenizer.events,r=0,r<o.length&&"lineEndingBlank"===o[r][1].type&&(r+=2),r<o.length&&"content"===o[r][1].type))for(;++r<o.length&&"content"!==o[r][1].type;)"chunkText"===o[r][1].type&&(o[r][1]._isInFirstContentOfListItem=!0,r++);if("enter"===n[0])n[1].contentType&&(Object.assign(t,UP(d,c)),c=t[c],l=!0);else if(n[1]._container){for(r=c,a=void 0;r--;)if(i=d.get(r),"lineEnding"===i[1].type||"lineEndingBlank"===i[1].type)"enter"===i[0]&&(a&&(d.get(a)[1].type="lineEndingBlank"),i[1].type="lineEnding",a=r);else if("linePrefix"!==i[1].type&&"listItemIndent"!==i[1].type)break;a&&(n[1].end={...d.get(a)[1].start},s=d.slice(a,c),s.unshift(n),d.splice(a,c-a+1,s))}}return KN(e,0,Number.POSITIVE_INFINITY,d.slice(0)),!l}function UP(e,t){const n=e.get(t)[1],a=e.get(t)[2];let r=t-1;const i=[];let s=n._tokenizer;s||(s=a.parser[n.contentType](n.start),n._contentTypeTextTrailing&&(s._contentTypeTextTrailing=!0));const o=s.events,l=[],c={};let d,u,h=-1,p=n,m=0,f=0;const g=[f];for(;p;){for(;e.get(++r)[1]!==p;);i.push(r),p._tokenizer||(d=a.sliceStream(p),p.next||d.push(null),u&&s.defineSkip(p.start),p._isInFirstContentOfListItem&&(s._gfmTasklistFirstContentOfListItem=!0),s.write(d),p._isInFirstContentOfListItem&&(s._gfmTasklistFirstContentOfListItem=void 0)),u=p,p=p.next}for(p=n;++h<o.length;)"exit"===o[h][0]&&"enter"===o[h-1][0]&&o[h][1].type===o[h-1][1].type&&o[h][1].start.line!==o[h][1].end.line&&(f=h+1,g.push(f),p._tokenizer=void 0,p.previous=void 0,p=p.next);for(s.events=[],p?(p._tokenizer=void 0,p.previous=void 0):g.pop(),h=g.length;h--;){const t=o.slice(g[h],g[h+1]),n=i.pop();l.push([n,n+t.length-1]),e.splice(n,2,t)}for(l.reverse(),h=-1;++h<l.length;)c[m+l[h][0]]=m+l[h][1],m+=l[h][1]-l[h][0]-1;return c}const OP={resolve:function(e){return DP(e),e},tokenize:function(e,t){let n;return function(t){return e.enter("content"),n=e.enter("chunkContent",{contentType:"content"}),a(t)};function a(t){return null===t?r(t):cP(t)?e.check(FP,i,r)(t):(e.consume(t),a)}function r(n){return e.exit("chunkContent"),e.exit("content"),t(n)}function i(t){return e.consume(t),e.exit("chunkContent"),n.next=e.enter("chunkContent",{contentType:"content",previous:n}),n=n.next,a}}},FP={partial:!0,tokenize:function(e,t,n){const a=this;return function(t){return e.exit("chunkContent"),e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),gP(e,r,"linePrefix")};function r(r){if(null===r||cP(r))return n(r);const i=a.events[a.events.length-1];return!a.parser.constructs.disable.null.includes("codeIndented")&&i&&"linePrefix"===i[1].type&&i[2].sliceSerialize(i[1],!0).length>=4?t(r):e.interrupt(a.parser.constructs.flow,n,t)(r)}}};function zP(e,t,n,a,r,i,s,o,l){const c=l||Number.POSITIVE_INFINITY;let d=0;return function(t){if(60===t)return e.enter(a),e.enter(r),e.enter(i),e.consume(t),e.exit(i),u;if(null===t||32===t||41===t||iP(t))return n(t);return e.enter(a),e.enter(s),e.enter(o),e.enter("chunkString",{contentType:"string"}),m(t)};function u(n){return 62===n?(e.enter(i),e.consume(n),e.exit(i),e.exit(r),e.exit(a),t):(e.enter(o),e.enter("chunkString",{contentType:"string"}),h(n))}function h(t){return 62===t?(e.exit("chunkString"),e.exit(o),u(t)):null===t||60===t||cP(t)?n(t):(e.consume(t),92===t?p:h)}function p(t){return 60===t||62===t||92===t?(e.consume(t),h):h(t)}function m(r){return d||null!==r&&41!==r&&!dP(r)?d<c&&40===r?(e.consume(r),d++,m):41===r?(e.consume(r),d--,m):null===r||32===r||40===r||iP(r)?n(r):(e.consume(r),92===r?f:m):(e.exit("chunkString"),e.exit(o),e.exit(s),e.exit(a),t(r))}function f(t){return 40===t||41===t||92===t?(e.consume(t),m):m(t)}}function BP(e,t,n,a,r,i){const s=this;let o,l=0;return function(t){return e.enter(a),e.enter(r),e.consume(t),e.exit(r),e.enter(i),c};function c(u){return l>999||null===u||91===u||93===u&&!o||94===u&&!l&&"_hiddenFootnoteSupport"in s.parser.constructs?n(u):93===u?(e.exit(i),e.enter(r),e.consume(u),e.exit(r),e.exit(a),t):cP(u)?(e.enter("lineEnding"),e.consume(u),e.exit("lineEnding"),c):(e.enter("chunkString",{contentType:"string"}),d(u))}function d(t){return null===t||91===t||93===t||cP(t)||l++>999?(e.exit("chunkString"),c(t)):(e.consume(t),o||(o=!uP(t)),92===t?u:d)}function u(t){return 91===t||92===t||93===t?(e.consume(t),l++,d):d(t)}}function HP(e,t,n,a,r,i){let s;return function(t){if(34===t||39===t||40===t)return e.enter(a),e.enter(r),e.consume(t),e.exit(r),s=40===t?41:t,o;return n(t)};function o(n){return n===s?(e.enter(r),e.consume(n),e.exit(r),e.exit(a),t):(e.enter(i),l(n))}function l(t){return t===s?(e.exit(i),o(s)):null===t?n(t):cP(t)?(e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),gP(e,l,"linePrefix")):(e.enter("chunkString",{contentType:"string"}),c(t))}function c(t){return t===s||null===t||cP(t)?(e.exit("chunkString"),l(t)):(e.consume(t),92===t?d:c)}function d(t){return t===s||92===t?(e.consume(t),c):c(t)}}function $P(e,t){let n;return function a(r){if(cP(r))return e.enter("lineEnding"),e.consume(r),e.exit("lineEnding"),n=!0,a;if(uP(r))return gP(e,a,n?"linePrefix":"lineSuffix")(r);return t(r)}}const VP={name:"definition",tokenize:function(e,t,n){const a=this;let r;return function(t){return e.enter("definition"),function(t){return BP.call(a,e,i,n,"definitionLabel","definitionLabelMarker","definitionLabelString")(t)}(t)};function i(t){return r=tP(a.sliceSerialize(a.events[a.events.length-1][1]).slice(1,-1)),58===t?(e.enter("definitionMarker"),e.consume(t),e.exit("definitionMarker"),s):n(t)}function s(t){return dP(t)?$P(e,o)(t):o(t)}function o(t){return zP(e,l,n,"definitionDestination","definitionDestinationLiteral","definitionDestinationLiteralMarker","definitionDestinationRaw","definitionDestinationString")(t)}function l(t){return e.attempt(WP,c,c)(t)}function c(t){return uP(t)?gP(e,d,"whitespace")(t):d(t)}function d(i){return null===i||cP(i)?(e.exit("definition"),a.parser.defined.push(r),t(i)):n(i)}}},WP={partial:!0,tokenize:function(e,t,n){return function(t){return dP(t)?$P(e,a)(t):n(t)};function a(t){return HP(e,r,n,"definitionTitle","definitionTitleMarker","definitionTitleString")(t)}function r(t){return uP(t)?gP(e,i,"whitespace")(t):i(t)}function i(e){return null===e||cP(e)?t(e):n(e)}}};const GP={name:"hardBreakEscape",tokenize:function(e,t,n){return function(t){return e.enter("hardBreakEscape"),e.consume(t),a};function a(a){return cP(a)?(e.exit("hardBreakEscape"),t(a)):n(a)}}};const XP={name:"headingAtx",resolve:function(e,t){let n,a,r=e.length-2,i=3;"whitespace"===e[i][1].type&&(i+=2);r-2>i&&"whitespace"===e[r][1].type&&(r-=2);"atxHeadingSequence"===e[r][1].type&&(i===r-1||r-4>i&&"whitespace"===e[r-2][1].type)&&(r-=i+1===r?2:4);r>i&&(n={type:"atxHeadingText",start:e[i][1].start,end:e[r][1].end},a={type:"chunkText",start:e[i][1].start,end:e[r][1].end,contentType:"text"},KN(e,i,r-i+1,[["enter",n,t],["enter",a,t],["exit",a,t],["exit",n,t]]));return e},tokenize:function(e,t,n){let a=0;return function(t){return e.enter("atxHeading"),function(t){return e.enter("atxHeadingSequence"),r(t)}(t)};function r(t){return 35===t&&a++<6?(e.consume(t),r):null===t||dP(t)?(e.exit("atxHeadingSequence"),i(t)):n(t)}function i(n){return 35===n?(e.enter("atxHeadingSequence"),s(n)):null===n||cP(n)?(e.exit("atxHeading"),t(n)):uP(n)?gP(e,i,"whitespace")(n):(e.enter("atxHeadingText"),o(n))}function s(t){return 35===t?(e.consume(t),s):(e.exit("atxHeadingSequence"),i(t))}function o(t){return null===t||35===t||dP(t)?(e.exit("atxHeadingText"),i(t)):(e.consume(t),o)}}};const qP=["address","article","aside","base","basefont","blockquote","body","caption","center","col","colgroup","dd","details","dialog","dir","div","dl","dt","fieldset","figcaption","figure","footer","form","frame","frameset","h1","h2","h3","h4","h5","h6","head","header","hr","html","iframe","legend","li","link","main","menu","menuitem","nav","noframes","ol","optgroup","option","p","param","search","section","summary","table","tbody","td","tfoot","th","thead","title","tr","track","ul"],KP=["pre","script","style","textarea"],YP={concrete:!0,name:"htmlFlow",resolveTo:function(e){let t=e.length;for(;t--&&("enter"!==e[t][0]||"htmlFlow"!==e[t][1].type););t>1&&"linePrefix"===e[t-2][1].type&&(e[t][1].start=e[t-2][1].start,e[t+1][1].start=e[t-2][1].start,e.splice(t-2,2));return e},tokenize:function(e,t,n){const a=this;let r,i,s,o,l;return function(t){return function(t){return e.enter("htmlFlow"),e.enter("htmlFlowData"),e.consume(t),c}(t)};function c(o){return 33===o?(e.consume(o),d):47===o?(e.consume(o),i=!0,p):63===o?(e.consume(o),r=3,a.interrupt?t:I):nP(o)?(e.consume(o),s=String.fromCharCode(o),m):n(o)}function d(i){return 45===i?(e.consume(i),r=2,u):91===i?(e.consume(i),r=5,o=0,h):nP(i)?(e.consume(i),r=4,a.interrupt?t:I):n(i)}function u(r){return 45===r?(e.consume(r),a.interrupt?t:I):n(r)}function h(r){const i="CDATA[";return r===i.charCodeAt(o++)?(e.consume(r),6===o?a.interrupt?t:E:h):n(r)}function p(t){return nP(t)?(e.consume(t),s=String.fromCharCode(t),m):n(t)}function m(o){if(null===o||47===o||62===o||dP(o)){const l=47===o,c=s.toLowerCase();return l||i||!KP.includes(c)?qP.includes(s.toLowerCase())?(r=6,l?(e.consume(o),f):a.interrupt?t(o):E(o)):(r=7,a.interrupt&&!a.parser.lazy[a.now().line]?n(o):i?g(o):v(o)):(r=1,a.interrupt?t(o):E(o))}return 45===o||aP(o)?(e.consume(o),s+=String.fromCharCode(o),m):n(o)}function f(r){return 62===r?(e.consume(r),a.interrupt?t:E):n(r)}function g(t){return uP(t)?(e.consume(t),g):M(t)}function v(t){return 47===t?(e.consume(t),M):58===t||95===t||nP(t)?(e.consume(t),y):uP(t)?(e.consume(t),v):M(t)}function y(t){return 45===t||46===t||58===t||95===t||aP(t)?(e.consume(t),y):x(t)}function x(t){return 61===t?(e.consume(t),b):uP(t)?(e.consume(t),x):v(t)}function b(t){return null===t||60===t||61===t||62===t||96===t?n(t):34===t||39===t?(e.consume(t),l=t,_):uP(t)?(e.consume(t),b):w(t)}function _(t){return t===l?(e.consume(t),l=null,S):null===t||cP(t)?n(t):(e.consume(t),_)}function w(t){return null===t||34===t||39===t||47===t||60===t||61===t||62===t||96===t||dP(t)?x(t):(e.consume(t),w)}function S(e){return 47===e||62===e||uP(e)?v(e):n(e)}function M(t){return 62===t?(e.consume(t),C):n(t)}function C(t){return null===t||cP(t)?E(t):uP(t)?(e.consume(t),C):n(t)}function E(t){return 45===t&&2===r?(e.consume(t),P):60===t&&1===r?(e.consume(t),j):62===t&&4===r?(e.consume(t),L):63===t&&3===r?(e.consume(t),I):93===t&&5===r?(e.consume(t),R):!cP(t)||6!==r&&7!==r?null===t||cP(t)?(e.exit("htmlFlowData"),k(t)):(e.consume(t),E):(e.exit("htmlFlowData"),e.check(JP,D,k)(t))}function k(t){return e.check(ZP,T,D)(t)}function T(t){return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),N}function N(t){return null===t||cP(t)?k(t):(e.enter("htmlFlowData"),E(t))}function P(t){return 45===t?(e.consume(t),I):E(t)}function j(t){return 47===t?(e.consume(t),s="",A):E(t)}function A(t){if(62===t){const n=s.toLowerCase();return KP.includes(n)?(e.consume(t),L):E(t)}return nP(t)&&s.length<8?(e.consume(t),s+=String.fromCharCode(t),A):E(t)}function R(t){return 93===t?(e.consume(t),I):E(t)}function I(t){return 62===t?(e.consume(t),L):45===t&&2===r?(e.consume(t),I):E(t)}function L(t){return null===t||cP(t)?(e.exit("htmlFlowData"),D(t)):(e.consume(t),L)}function D(n){return e.exit("htmlFlow"),t(n)}}},JP={partial:!0,tokenize:function(e,t,n){return function(a){return e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),e.attempt(CP,t,n)}}},ZP={partial:!0,tokenize:function(e,t,n){const a=this;return function(t){if(cP(t))return e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),r;return n(t)};function r(e){return a.parser.lazy[a.now().line]?n(e):t(e)}}};const QP={name:"htmlText",tokenize:function(e,t,n){const a=this;let r,i,s;return function(t){return e.enter("htmlText"),e.enter("htmlTextData"),e.consume(t),o};function o(t){return 33===t?(e.consume(t),l):47===t?(e.consume(t),b):63===t?(e.consume(t),y):nP(t)?(e.consume(t),S):n(t)}function l(t){return 45===t?(e.consume(t),c):91===t?(e.consume(t),i=0,p):nP(t)?(e.consume(t),v):n(t)}function c(t){return 45===t?(e.consume(t),h):n(t)}function d(t){return null===t?n(t):45===t?(e.consume(t),u):cP(t)?(s=d,A(t)):(e.consume(t),d)}function u(t){return 45===t?(e.consume(t),h):d(t)}function h(e){return 62===e?j(e):45===e?u(e):d(e)}function p(t){const a="CDATA[";return t===a.charCodeAt(i++)?(e.consume(t),6===i?m:p):n(t)}function m(t){return null===t?n(t):93===t?(e.consume(t),f):cP(t)?(s=m,A(t)):(e.consume(t),m)}function f(t){return 93===t?(e.consume(t),g):m(t)}function g(t){return 62===t?j(t):93===t?(e.consume(t),g):m(t)}function v(t){return null===t||62===t?j(t):cP(t)?(s=v,A(t)):(e.consume(t),v)}function y(t){return null===t?n(t):63===t?(e.consume(t),x):cP(t)?(s=y,A(t)):(e.consume(t),y)}function x(e){return 62===e?j(e):y(e)}function b(t){return nP(t)?(e.consume(t),_):n(t)}function _(t){return 45===t||aP(t)?(e.consume(t),_):w(t)}function w(t){return cP(t)?(s=w,A(t)):uP(t)?(e.consume(t),w):j(t)}function S(t){return 45===t||aP(t)?(e.consume(t),S):47===t||62===t||dP(t)?M(t):n(t)}function M(t){return 47===t?(e.consume(t),j):58===t||95===t||nP(t)?(e.consume(t),C):cP(t)?(s=M,A(t)):uP(t)?(e.consume(t),M):j(t)}function C(t){return 45===t||46===t||58===t||95===t||aP(t)?(e.consume(t),C):E(t)}function E(t){return 61===t?(e.consume(t),k):cP(t)?(s=E,A(t)):uP(t)?(e.consume(t),E):M(t)}function k(t){return null===t||60===t||61===t||62===t||96===t?n(t):34===t||39===t?(e.consume(t),r=t,T):cP(t)?(s=k,A(t)):uP(t)?(e.consume(t),k):(e.consume(t),N)}function T(t){return t===r?(e.consume(t),r=void 0,P):null===t?n(t):cP(t)?(s=T,A(t)):(e.consume(t),T)}function N(t){return null===t||34===t||39===t||60===t||61===t||96===t?n(t):47===t||62===t||dP(t)?M(t):(e.consume(t),N)}function P(e){return 47===e||62===e||dP(e)?M(e):n(e)}function j(a){return 62===a?(e.consume(a),e.exit("htmlTextData"),e.exit("htmlText"),t):n(a)}function A(t){return e.exit("htmlTextData"),e.enter("lineEnding"),e.consume(t),e.exit("lineEnding"),R}function R(t){return uP(t)?gP(e,I,"linePrefix",a.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(t):I(t)}function I(t){return e.enter("htmlTextData"),s(t)}}};const ej={name:"labelEnd",resolveAll:function(e){let t=-1;const n=[];for(;++t<e.length;){const a=e[t][1];if(n.push(e[t]),"labelImage"===a.type||"labelLink"===a.type||"labelEnd"===a.type){const e="labelImage"===a.type?4:2;a.type="data",t+=e}}e.length!==n.length&&KN(e,0,e.length,n);return e},resolveTo:function(e,t){let n,a,r,i,s=e.length,o=0;for(;s--;)if(n=e[s][1],a){if("link"===n.type||"labelLink"===n.type&&n._inactive)break;"enter"===e[s][0]&&"labelLink"===n.type&&(n._inactive=!0)}else if(r){if("enter"===e[s][0]&&("labelImage"===n.type||"labelLink"===n.type)&&!n._balanced&&(a=s,"labelLink"!==n.type)){o=2;break}}else"labelEnd"===n.type&&(r=s);const l={type:"labelLink"===e[a][1].type?"link":"image",start:{...e[a][1].start},end:{...e[e.length-1][1].end}},c={type:"label",start:{...e[a][1].start},end:{...e[r][1].end}},d={type:"labelText",start:{...e[a+o+2][1].end},end:{...e[r-2][1].start}};return i=[["enter",l,t],["enter",c,t]],i=YN(i,e.slice(a+1,a+o+3)),i=YN(i,[["enter",d,t]]),i=YN(i,_P(t.parser.constructs.insideSpan.null,e.slice(a+o+4,r-3),t)),i=YN(i,[["exit",d,t],e[r-2],e[r-1],["exit",c,t]]),i=YN(i,e.slice(r+1)),i=YN(i,[["exit",l,t]]),KN(e,a,e.length,i),e},tokenize:function(e,t,n){const a=this;let r,i,s=a.events.length;for(;s--;)if(("labelImage"===a.events[s][1].type||"labelLink"===a.events[s][1].type)&&!a.events[s][1]._balanced){r=a.events[s][1];break}return function(t){if(!r)return n(t);if(r._inactive)return d(t);return i=a.parser.defined.includes(tP(a.sliceSerialize({start:r.end,end:a.now()}))),e.enter("labelEnd"),e.enter("labelMarker"),e.consume(t),e.exit("labelMarker"),e.exit("labelEnd"),o};function o(t){return 40===t?e.attempt(tj,c,i?c:d)(t):91===t?e.attempt(nj,c,i?l:d)(t):i?c(t):d(t)}function l(t){return e.attempt(aj,c,d)(t)}function c(e){return t(e)}function d(e){return r._balanced=!0,n(e)}}},tj={tokenize:function(e,t,n){return function(t){return e.enter("resource"),e.enter("resourceMarker"),e.consume(t),e.exit("resourceMarker"),a};function a(t){return dP(t)?$P(e,r)(t):r(t)}function r(t){return 41===t?c(t):zP(e,i,s,"resourceDestination","resourceDestinationLiteral","resourceDestinationLiteralMarker","resourceDestinationRaw","resourceDestinationString",32)(t)}function i(t){return dP(t)?$P(e,o)(t):c(t)}function s(e){return n(e)}function o(t){return 34===t||39===t||40===t?HP(e,l,n,"resourceTitle","resourceTitleMarker","resourceTitleString")(t):c(t)}function l(t){return dP(t)?$P(e,c)(t):c(t)}function c(a){return 41===a?(e.enter("resourceMarker"),e.consume(a),e.exit("resourceMarker"),e.exit("resource"),t):n(a)}}},nj={tokenize:function(e,t,n){const a=this;return function(t){return BP.call(a,e,r,i,"reference","referenceMarker","referenceString")(t)};function r(e){return a.parser.defined.includes(tP(a.sliceSerialize(a.events[a.events.length-1][1]).slice(1,-1)))?t(e):n(e)}function i(e){return n(e)}}},aj={tokenize:function(e,t,n){return function(t){return e.enter("reference"),e.enter("referenceMarker"),e.consume(t),e.exit("referenceMarker"),a};function a(a){return 93===a?(e.enter("referenceMarker"),e.consume(a),e.exit("referenceMarker"),e.exit("reference"),t):n(a)}}};const rj={name:"labelStartImage",resolveAll:ej.resolveAll,tokenize:function(e,t,n){const a=this;return function(t){return e.enter("labelImage"),e.enter("labelImageMarker"),e.consume(t),e.exit("labelImageMarker"),r};function r(t){return 91===t?(e.enter("labelMarker"),e.consume(t),e.exit("labelMarker"),e.exit("labelImage"),i):n(t)}function i(e){return 94===e&&"_hiddenFootnoteSupport"in a.parser.constructs?n(e):t(e)}}};const ij={name:"labelStartLink",resolveAll:ej.resolveAll,tokenize:function(e,t,n){const a=this;return function(t){return e.enter("labelLink"),e.enter("labelMarker"),e.consume(t),e.exit("labelMarker"),e.exit("labelLink"),r};function r(e){return 94===e&&"_hiddenFootnoteSupport"in a.parser.constructs?n(e):t(e)}}};const sj={name:"lineEnding",tokenize:function(e,t){return function(n){return e.enter("lineEnding"),e.consume(n),e.exit("lineEnding"),gP(e,t,"linePrefix")}}};const oj={name:"thematicBreak",tokenize:function(e,t,n){let a,r=0;return function(t){return e.enter("thematicBreak"),function(e){return a=e,i(e)}(t)};function i(i){return i===a?(e.enter("thematicBreakSequence"),s(i)):r>=3&&(null===i||cP(i))?(e.exit("thematicBreak"),t(i)):n(i)}function s(t){return t===a?(e.consume(t),r++,s):(e.exit("thematicBreakSequence"),uP(t)?gP(e,i,"whitespace")(t):i(t))}}};const lj={continuation:{tokenize:function(e,t,n){const a=this;return a.containerState._closeFlow=void 0,e.check(CP,function(n){return a.containerState.furtherBlankLines=a.containerState.furtherBlankLines||a.containerState.initialBlankLine,gP(e,t,"listItemIndent",a.containerState.size+1)(n)},function(n){if(a.containerState.furtherBlankLines||!uP(n))return a.containerState.furtherBlankLines=void 0,a.containerState.initialBlankLine=void 0,r(n);return a.containerState.furtherBlankLines=void 0,a.containerState.initialBlankLine=void 0,e.attempt(dj,t,r)(n)});function r(r){return a.containerState._closeFlow=!0,a.interrupt=void 0,gP(e,e.attempt(lj,t,n),"linePrefix",a.parser.constructs.disable.null.includes("codeIndented")?void 0:4)(r)}}},exit:function(e){e.exit(this.containerState.type)},name:"list",tokenize:function(e,t,n){const a=this,r=a.events[a.events.length-1];let i=r&&"linePrefix"===r[1].type?r[2].sliceSerialize(r[1],!0).length:0,s=0;return function(t){const r=a.containerState.type||(42===t||43===t||45===t?"listUnordered":"listOrdered");if("listUnordered"===r?!a.containerState.marker||t===a.containerState.marker:sP(t)){if(a.containerState.type||(a.containerState.type=r,e.enter(r,{_container:!0})),"listUnordered"===r)return e.enter("listItemPrefix"),42===t||45===t?e.check(oj,n,l)(t):l(t);if(!a.interrupt||49===t)return e.enter("listItemPrefix"),e.enter("listItemValue"),o(t)}return n(t)};function o(t){return sP(t)&&++s<10?(e.consume(t),o):(!a.interrupt||s<2)&&(a.containerState.marker?t===a.containerState.marker:41===t||46===t)?(e.exit("listItemValue"),l(t)):n(t)}function l(t){return e.enter("listItemMarker"),e.consume(t),e.exit("listItemMarker"),a.containerState.marker=a.containerState.marker||t,e.check(CP,a.interrupt?n:c,e.attempt(cj,u,d))}function c(e){return a.containerState.initialBlankLine=!0,i++,u(e)}function d(t){return uP(t)?(e.enter("listItemPrefixWhitespace"),e.consume(t),e.exit("listItemPrefixWhitespace"),u):n(t)}function u(n){return a.containerState.size=i+a.sliceSerialize(e.exit("listItemPrefix"),!0).length,t(n)}}},cj={partial:!0,tokenize:function(e,t,n){const a=this;return gP(e,function(e){const r=a.events[a.events.length-1];return!uP(e)&&r&&"listItemPrefixWhitespace"===r[1].type?t(e):n(e)},"listItemPrefixWhitespace",a.parser.constructs.disable.null.includes("codeIndented")?void 0:5)}},dj={partial:!0,tokenize:function(e,t,n){const a=this;return gP(e,function(e){const r=a.events[a.events.length-1];return r&&"listItemIndent"===r[1].type&&r[2].sliceSerialize(r[1],!0).length===a.containerState.size?t(e):n(e)},"listItemIndent",a.containerState.size+1)}};const uj={name:"setextUnderline",resolveTo:function(e,t){let n,a,r,i=e.length;for(;i--;)if("enter"===e[i][0]){if("content"===e[i][1].type){n=i;break}"paragraph"===e[i][1].type&&(a=i)}else"content"===e[i][1].type&&e.splice(i,1),r||"definition"!==e[i][1].type||(r=i);const s={type:"setextHeading",start:{...e[n][1].start},end:{...e[e.length-1][1].end}};e[a][1].type="setextHeadingText",r?(e.splice(a,0,["enter",s,t]),e.splice(r+1,0,["exit",e[n][1],t]),e[n][1].end={...e[r][1].end}):e[n][1]=s;return e.push(["exit",s,t]),e},tokenize:function(e,t,n){const a=this;let r;return function(t){let s,o=a.events.length;for(;o--;)if("lineEnding"!==a.events[o][1].type&&"linePrefix"!==a.events[o][1].type&&"content"!==a.events[o][1].type){s="paragraph"===a.events[o][1].type;break}if(!a.parser.lazy[a.now().line]&&(a.interrupt||s))return e.enter("setextHeadingLine"),r=t,function(t){return e.enter("setextHeadingLineSequence"),i(t)}(t);return n(t)};function i(t){return t===r?(e.consume(t),i):(e.exit("setextHeadingLineSequence"),uP(t)?gP(e,s,"lineSuffix")(t):s(t))}function s(a){return null===a||cP(a)?(e.exit("setextHeadingLine"),t(a)):n(a)}}};const hj={tokenize:function(e){const t=this,n=e.attempt(CP,function(a){if(null===a)return void e.consume(a);return e.enter("lineEndingBlank"),e.consume(a),e.exit("lineEndingBlank"),t.currentConstruct=void 0,n},e.attempt(this.parser.constructs.flowInitial,a,gP(e,e.attempt(this.parser.constructs.flow,a,e.attempt(OP,a)),"linePrefix")));return n;function a(a){if(null!==a)return e.enter("lineEnding"),e.consume(a),e.exit("lineEnding"),t.currentConstruct=void 0,n;e.consume(a)}}};const pj={resolveAll:vj()},mj=gj("string"),fj=gj("text");function gj(e){return{resolveAll:vj("text"===e?yj:void 0),tokenize:function(t){const n=this,a=this.parser.constructs[e],r=t.attempt(a,i,s);return i;function i(e){return l(e)?r(e):s(e)}function s(e){if(null!==e)return t.enter("data"),t.consume(e),o;t.consume(e)}function o(e){return l(e)?(t.exit("data"),r(e)):(t.consume(e),o)}function l(e){if(null===e)return!0;const t=a[e];let r=-1;if(t)for(;++r<t.length;){const e=t[r];if(!e.previous||e.previous.call(n,n.previous))return!0}return!1}}}}function vj(e){return function(t,n){let a,r=-1;for(;++r<=t.length;)void 0===a?t[r]&&"data"===t[r][1].type&&(a=r,r++):t[r]&&"data"===t[r][1].type||(r!==a+2&&(t[a][1].end=t[r-1][1].end,t.splice(a+2,r-a-2),r=a+2),a=void 0);return e?e(t,n):t}}function yj(e,t){let n=0;for(;++n<=e.length;)if((n===e.length||"lineEnding"===e[n][1].type)&&"data"===e[n-1][1].type){const a=e[n-1][1],r=t.sliceStream(a);let i,s=r.length,o=-1,l=0;for(;s--;){const e=r[s];if("string"==typeof e){for(o=e.length;32===e.charCodeAt(o-1);)l++,o--;if(o)break;o=-1}else if(-2===e)i=!0,l++;else if(-1!==e){s++;break}}if(t._contentTypeTextTrailing&&n===e.length&&(l=0),l){const r={type:n===e.length||i||l<2?"lineSuffix":"hardBreakTrailing",start:{_bufferIndex:s?o:a.start._bufferIndex+o,_index:a.start._index+s,line:a.end.line,column:a.end.column-l,offset:a.end.offset-l},end:{...a.end}};a.end={...r.start},a.start.offset===a.end.offset?Object.assign(a,r):(e.splice(n,0,["enter",r,t],["exit",r,t]),n+=2)}n++}return e}const xj={42:lj,43:lj,45:lj,48:lj,49:lj,50:lj,51:lj,52:lj,53:lj,54:lj,55:lj,56:lj,57:lj,62:EP},bj={91:VP},_j={[-2]:jP,[-1]:jP,32:jP},wj={35:XP,42:oj,45:[uj,oj],60:YP,61:uj,95:oj,96:PP,126:PP},Sj={38:TP,92:kP},Mj={[-5]:sj,[-4]:sj,[-3]:sj,33:rj,38:TP,42:wP,60:[MP,QP],91:ij,92:[GP,kP],93:ej,95:wP,96:RP},Cj={null:[wP,pj]},Ej=Object.freeze(Object.defineProperty({__proto__:null,attentionMarkers:{null:[42,95]},contentInitial:bj,disable:{null:[]},document:xj,flow:wj,flowInitial:_j,insideSpan:Cj,string:Sj,text:Mj},Symbol.toStringTag,{value:"Module"}));function kj(e,t,n){let a={_bufferIndex:-1,_index:0,line:n&&n.line||1,column:n&&n.column||1,offset:n&&n.offset||0};const r={},i=[];let s=[],o=[];const l={attempt:g(function(e,t){v(e,t.from)}),check:g(f),consume:function(e){cP(e)?(a.line++,a.column=1,a.offset+=-3===e?2:1,y()):-1!==e&&(a.column++,a.offset++);a._bufferIndex<0?a._index++:(a._bufferIndex++,a._bufferIndex===s[a._index].length&&(a._bufferIndex=-1,a._index++));c.previous=e},enter:function(e,t){const n=t||{};return n.type=e,n.start=h(),c.events.push(["enter",n,c]),o.push(n),n},exit:function(e){const t=o.pop();return t.end=h(),c.events.push(["exit",t,c]),t},interrupt:g(f,{interrupt:!0})},c={code:null,containerState:{},defineSkip:function(e){r[e.line]=e.column,y()},events:[],now:h,parser:e,previous:null,sliceSerialize:function(e,t){return function(e,t){let n=-1;const a=[];let r;for(;++n<e.length;){const i=e[n];let s;if("string"==typeof i)s=i;else switch(i){case-5:s="\r";break;case-4:s="\n";break;case-3:s="\r\n";break;case-2:s=t?" ":"\t";break;case-1:if(!t&&r)continue;s=" ";break;default:s=String.fromCharCode(i)}r=-2===i,a.push(s)}return a.join("")}(u(e),t)},sliceStream:u,write:function(e){if(s=YN(s,e),p(),null!==s[s.length-1])return[];return v(t,0),c.events=_P(i,c.events,c),c.events}};let d=t.tokenize.call(c,l);return t.resolveAll&&i.push(t),c;function u(e){return function(e,t){const n=t.start._index,a=t.start._bufferIndex,r=t.end._index,i=t.end._bufferIndex;let s;if(n===r)s=[e[n].slice(a,i)];else{if(s=e.slice(n,r),a>-1){const e=s[0];"string"==typeof e?s[0]=e.slice(a):s.shift()}i>0&&s.push(e[r].slice(0,i))}return s}(s,e)}function h(){const{_bufferIndex:e,_index:t,line:n,column:r,offset:i}=a;return{_bufferIndex:e,_index:t,line:n,column:r,offset:i}}function p(){let e;for(;a._index<s.length;){const t=s[a._index];if("string"==typeof t)for(e=a._index,a._bufferIndex<0&&(a._bufferIndex=0);a._index===e&&a._bufferIndex<t.length;)m(t.charCodeAt(a._bufferIndex));else m(t)}}function m(e){d=d(e)}function f(e,t){t.restore()}function g(e,t){return function(n,r,i){let s,d,u,p;return Array.isArray(n)?m(n):"tokenize"in n?m([n]):function(e){return t;function t(t){const n=null!==t&&e[t],a=null!==t&&e.null;return m([...Array.isArray(n)?n:n?[n]:[],...Array.isArray(a)?a:a?[a]:[]])(t)}}(n);function m(e){return s=e,d=0,0===e.length?i:f(e[d])}function f(e){return function(n){p=function(){const e=h(),t=c.previous,n=c.currentConstruct,r=c.events.length,i=Array.from(o);return{from:r,restore:s};function s(){a=e,c.previous=t,c.currentConstruct=n,c.events.length=r,o=i,y()}}(),u=e,e.partial||(c.currentConstruct=e);if(e.name&&c.parser.constructs.disable.null.includes(e.name))return v();return e.tokenize.call(t?Object.assign(Object.create(c),t):c,l,g,v)(n)}}function g(t){return e(u,p),r}function v(e){return p.restore(),++d<s.length?f(s[d]):i}}}function v(e,t){e.resolveAll&&!i.includes(e)&&i.push(e),e.resolve&&KN(c.events,t,c.events.length-t,e.resolve(c.events.slice(t),c)),e.resolveTo&&(c.events=e.resolveTo(c.events,c))}function y(){a.line in r&&a.column<2&&(a.column=r[a.line],a.offset+=r[a.line]-1)}}function Tj(e){const t={constructs:function(e){const t={};let n=-1;for(;++n<e.length;)ZN(t,e[n]);return t}([Ej,...(e||{}).extensions||[]]),content:n(vP),defined:[],document:n(yP),flow:n(hj),lazy:{},string:n(mj),text:n(fj)};return t;function n(e){return function(n){return kj(t,e,n)}}}const Nj=/[\0\t\n\r]/g;const Pj=/\\([!-/:-@[-`{-~])|&(#(?:\d{1,7}|x[\da-f]{1,6})|[\da-z]{1,31});/gi;function jj(e,t,n){if(t)return t;if(35===n.charCodeAt(0)){const e=n.charCodeAt(1),t=120===e||88===e;return eP(n.slice(t?2:1),t?16:10)}return qN(n)||e}const Aj={}.hasOwnProperty;function Rj(e,t,n){return"string"!=typeof t&&(n=t,t=void 0),function(e){const t={transforms:[],canContainEols:["emphasis","fragment","heading","paragraph","strong"],enter:{autolink:i(te),autolinkProtocol:C,autolinkEmail:C,atxHeading:i(J),blockQuote:i(G),characterEscape:C,characterReference:C,codeFenced:i(X),codeFencedFenceInfo:s,codeFencedFenceMeta:s,codeIndented:i(X,s),codeText:i(q,s),codeTextData:C,data:C,codeFlowValue:C,definition:i(K),definitionDestinationString:s,definitionLabelString:s,definitionTitleString:s,emphasis:i(Y),hardBreakEscape:i(Z),hardBreakTrailing:i(Z),htmlFlow:i(Q,s),htmlFlowData:C,htmlText:i(Q,s),htmlTextData:C,image:i(ee),label:s,link:i(te),listItem:i(ae),listItemValue:h,listOrdered:i(ne,u),listUnordered:i(ne),paragraph:i(re),reference:F,referenceString:s,resourceDestinationString:s,resourceTitleString:s,setextHeading:i(J),strong:i(ie),thematicBreak:i(oe)},exit:{atxHeading:l(),atxHeadingSequence:_,autolink:l(),autolinkEmail:W,autolinkProtocol:V,blockQuote:l(),characterEscapeValue:E,characterReferenceMarkerHexadecimal:B,characterReferenceMarkerNumeric:B,characterReferenceValue:H,characterReference:$,codeFenced:l(g),codeFencedFence:f,codeFencedFenceInfo:p,codeFencedFenceMeta:m,codeFlowValue:E,codeIndented:l(v),codeText:l(j),codeTextData:E,data:E,definition:l(),definitionDestinationString:b,definitionLabelString:y,definitionTitleString:x,emphasis:l(),hardBreakEscape:l(T),hardBreakTrailing:l(T),htmlFlow:l(N),htmlFlowData:E,htmlText:l(P),htmlTextData:E,image:l(R),label:L,labelText:I,lineEnding:k,link:l(A),listItem:l(),listOrdered:l(),listUnordered:l(),paragraph:l(),referenceString:z,resourceDestinationString:D,resourceTitleString:U,resource:O,setextHeading:l(M),setextHeadingLineSequence:S,setextHeadingText:w,strong:l(),thematicBreak:l()}};Lj(t,(e||{}).mdastExtensions||[]);const n={};return a;function a(e){let a={type:"root",children:[]};const i={stack:[a],tokenStack:[],config:t,enter:o,exit:c,buffer:s,resume:d,data:n},l=[];let u=-1;for(;++u<e.length;)if("listOrdered"===e[u][1].type||"listUnordered"===e[u][1].type)if("enter"===e[u][0])l.push(u);else{u=r(e,l.pop(),u)}for(u=-1;++u<e.length;){const n=t[e[u][0]];Aj.call(n,e[u][1].type)&&n[e[u][1].type].call(Object.assign({sliceSerialize:e[u][2].sliceSerialize},i),e[u][1])}if(i.tokenStack.length>0){const e=i.tokenStack[i.tokenStack.length-1];(e[1]||Uj).call(i,void 0,e[0])}for(a.position={start:Ij(e.length>0?e[0][1].start:{line:1,column:1,offset:0}),end:Ij(e.length>0?e[e.length-2][1].end:{line:1,column:1,offset:0})},u=-1;++u<t.transforms.length;)a=t.transforms[u](a)||a;return a}function r(e,t,n){let a,r,i,s,o=t-1,l=-1,c=!1;for(;++o<=n;){const t=e[o];switch(t[1].type){case"listUnordered":case"listOrdered":case"blockQuote":"enter"===t[0]?l++:l--,s=void 0;break;case"lineEndingBlank":"enter"===t[0]&&(!a||s||l||i||(i=o),s=void 0);break;case"linePrefix":case"listItemValue":case"listItemMarker":case"listItemPrefix":case"listItemPrefixWhitespace":break;default:s=void 0}if(!l&&"enter"===t[0]&&"listItemPrefix"===t[1].type||-1===l&&"exit"===t[0]&&("listUnordered"===t[1].type||"listOrdered"===t[1].type)){if(a){let s=o;for(r=void 0;s--;){const t=e[s];if("lineEnding"===t[1].type||"lineEndingBlank"===t[1].type){if("exit"===t[0])continue;r&&(e[r][1].type="lineEndingBlank",c=!0),t[1].type="lineEnding",r=s}else if("linePrefix"!==t[1].type&&"blockQuotePrefix"!==t[1].type&&"blockQuotePrefixWhitespace"!==t[1].type&&"blockQuoteMarker"!==t[1].type&&"listItemIndent"!==t[1].type)break}i&&(!r||i<r)&&(a._spread=!0),a.end=Object.assign({},r?e[r][1].start:t[1].end),e.splice(r||o,0,["exit",a,t[2]]),o++,n++}if("listItemPrefix"===t[1].type){const r={type:"listItem",_spread:!1,start:Object.assign({},t[1].start),end:void 0};a=r,e.splice(o,0,["enter",r,t[2]]),o++,n++,i=void 0,s=!0}}}return e[t][1]._spread=c,n}function i(e,t){return n;function n(n){o.call(this,e(n),n),t&&t.call(this,n)}}function s(){this.stack.push({type:"fragment",children:[]})}function o(e,t,n){this.stack[this.stack.length-1].children.push(e),this.stack.push(e),this.tokenStack.push([t,n||void 0]),e.position={start:Ij(t.start),end:void 0}}function l(e){return t;function t(t){e&&e.call(this,t),c.call(this,t)}}function c(e,t){const n=this.stack.pop(),a=this.tokenStack.pop();if(!a)throw new Error("Cannot close `"+e.type+"` ("+wN({start:e.start,end:e.end})+"): its not open");if(a[0].type!==e.type)if(t)t.call(this,e,a[0]);else{(a[1]||Uj).call(this,e,a[0])}n.position.end=Ij(e.end)}function d(){return function(e){return WN(e,"boolean"!=typeof VN.includeImageAlt||VN.includeImageAlt,"boolean"!=typeof VN.includeHtml||VN.includeHtml)}(this.stack.pop())}function u(){this.data.expectingFirstListItemValue=!0}function h(e){if(this.data.expectingFirstListItemValue){this.stack[this.stack.length-2].start=Number.parseInt(this.sliceSerialize(e),10),this.data.expectingFirstListItemValue=void 0}}function p(){const e=this.resume();this.stack[this.stack.length-1].lang=e}function m(){const e=this.resume();this.stack[this.stack.length-1].meta=e}function f(){this.data.flowCodeInside||(this.buffer(),this.data.flowCodeInside=!0)}function g(){const e=this.resume();this.stack[this.stack.length-1].value=e.replace(/^(\r?\n|\r)|(\r?\n|\r)$/g,""),this.data.flowCodeInside=void 0}function v(){const e=this.resume();this.stack[this.stack.length-1].value=e.replace(/(\r?\n|\r)$/g,"")}function y(e){const t=this.resume(),n=this.stack[this.stack.length-1];n.label=t,n.identifier=tP(this.sliceSerialize(e)).toLowerCase()}function x(){const e=this.resume();this.stack[this.stack.length-1].title=e}function b(){const e=this.resume();this.stack[this.stack.length-1].url=e}function _(e){const t=this.stack[this.stack.length-1];if(!t.depth){const n=this.sliceSerialize(e).length;t.depth=n}}function w(){this.data.setextHeadingSlurpLineEnding=!0}function S(e){this.stack[this.stack.length-1].depth=61===this.sliceSerialize(e).codePointAt(0)?1:2}function M(){this.data.setextHeadingSlurpLineEnding=void 0}function C(e){const t=this.stack[this.stack.length-1].children;let n=t[t.length-1];n&&"text"===n.type||(n=se(),n.position={start:Ij(e.start),end:void 0},t.push(n)),this.stack.push(n)}function E(e){const t=this.stack.pop();t.value+=this.sliceSerialize(e),t.position.end=Ij(e.end)}function k(e){const n=this.stack[this.stack.length-1];if(this.data.atHardBreak){return n.children[n.children.length-1].position.end=Ij(e.end),void(this.data.atHardBreak=void 0)}!this.data.setextHeadingSlurpLineEnding&&t.canContainEols.includes(n.type)&&(C.call(this,e),E.call(this,e))}function T(){this.data.atHardBreak=!0}function N(){const e=this.resume();this.stack[this.stack.length-1].value=e}function P(){const e=this.resume();this.stack[this.stack.length-1].value=e}function j(){const e=this.resume();this.stack[this.stack.length-1].value=e}function A(){const e=this.stack[this.stack.length-1];if(this.data.inReference){const t=this.data.referenceType||"shortcut";e.type+="Reference",e.referenceType=t,delete e.url,delete e.title}else delete e.identifier,delete e.label;this.data.referenceType=void 0}function R(){const e=this.stack[this.stack.length-1];if(this.data.inReference){const t=this.data.referenceType||"shortcut";e.type+="Reference",e.referenceType=t,delete e.url,delete e.title}else delete e.identifier,delete e.label;this.data.referenceType=void 0}function I(e){const t=this.sliceSerialize(e),n=this.stack[this.stack.length-2];n.label=function(e){return e.replace(Pj,jj)}(t),n.identifier=tP(t).toLowerCase()}function L(){const e=this.stack[this.stack.length-1],t=this.resume(),n=this.stack[this.stack.length-1];if(this.data.inReference=!0,"link"===n.type){const t=e.children;n.children=t}else n.alt=t}function D(){const e=this.resume();this.stack[this.stack.length-1].url=e}function U(){const e=this.resume();this.stack[this.stack.length-1].title=e}function O(){this.data.inReference=void 0}function F(){this.data.referenceType="collapsed"}function z(e){const t=this.resume(),n=this.stack[this.stack.length-1];n.label=t,n.identifier=tP(this.sliceSerialize(e)).toLowerCase(),this.data.referenceType="full"}function B(e){this.data.characterReferenceType=e.type}function H(e){const t=this.sliceSerialize(e),n=this.data.characterReferenceType;let a;if(n)a=eP(t,"characterReferenceMarkerNumeric"===n?10:16),this.data.characterReferenceType=void 0;else{a=qN(t)}this.stack[this.stack.length-1].value+=a}function $(e){this.stack.pop().position.end=Ij(e.end)}function V(e){E.call(this,e);this.stack[this.stack.length-1].url=this.sliceSerialize(e)}function W(e){E.call(this,e);this.stack[this.stack.length-1].url="mailto:"+this.sliceSerialize(e)}function G(){return{type:"blockquote",children:[]}}function X(){return{type:"code",lang:null,meta:null,value:""}}function q(){return{type:"inlineCode",value:""}}function K(){return{type:"definition",identifier:"",label:null,title:null,url:""}}function Y(){return{type:"emphasis",children:[]}}function J(){return{type:"heading",depth:0,children:[]}}function Z(){return{type:"break"}}function Q(){return{type:"html",value:""}}function ee(){return{type:"image",title:null,url:"",alt:null}}function te(){return{type:"link",title:null,url:"",children:[]}}function ne(e){return{type:"list",ordered:"listOrdered"===e.type,start:null,spread:e._spread,children:[]}}function ae(e){return{type:"listItem",spread:e._spread,checked:null,children:[]}}function re(){return{type:"paragraph",children:[]}}function ie(){return{type:"strong",children:[]}}function se(){return{type:"text",value:""}}function oe(){return{type:"thematicBreak"}}}(n)(function(e){for(;!DP(e););return e}(Tj(n).document().write(function(){let e,t=1,n="",a=!0;return function(r,i,s){const o=[];let l,c,d,u,h;for(r=n+("string"==typeof r?r.toString():new TextDecoder(i||void 0).decode(r)),d=0,n="",a&&(65279===r.charCodeAt(0)&&d++,a=void 0);d<r.length;){if(Nj.lastIndex=d,l=Nj.exec(r),u=l&&void 0!==l.index?l.index:r.length,h=r.charCodeAt(u),!l){n=r.slice(d);break}if(10===h&&d===u&&e)o.push(-3),e=void 0;else switch(e&&(o.push(-5),e=void 0),d<u&&(o.push(r.slice(d,u)),t+=u-d),h){case 0:o.push(65533),t++;break;case 9:for(c=4*Math.ceil(t/4),o.push(-2);t++<c;)o.push(-1);break;case 10:o.push(-4),t=1;break;default:e=!0,t=1}d=u+1}return s&&(e&&o.push(-5),n&&o.push(n),o.push(null)),o}}()(e,t,!0))))}function Ij(e){return{line:e.line,column:e.column,offset:e.offset}}function Lj(e,t){let n=-1;for(;++n<t.length;){const a=t[n];Array.isArray(a)?Lj(e,a):Dj(e,a)}}function Dj(e,t){let n;for(n in t)if(Aj.call(t,n))switch(n){case"canContainEols":{const a=t[n];a&&e[n].push(...a);break}case"transforms":{const a=t[n];a&&e[n].push(...a);break}case"enter":case"exit":{const a=t[n];a&&Object.assign(e[n],a);break}}}function Uj(e,t){throw e?new Error("Cannot close `"+e.type+"` ("+wN({start:e.start,end:e.end})+"): a different token (`"+t.type+"`, "+wN({start:t.start,end:t.end})+") is open"):new Error("Cannot close document, a token (`"+t.type+"`, "+wN({start:t.start,end:t.end})+") is still open")}function Oj(e){const t=this;t.parser=function(n){return Rj(n,{...t.data("settings"),...e,extensions:t.data("micromarkExtensions")||[],mdastExtensions:t.data("fromMarkdownExtensions")||[]})}}function Fj(e,t){const n=t.referenceType;let a="]";if("collapsed"===n?a+="[]":"full"===n&&(a+="["+(t.label||t.identifier)+"]"),"imageReference"===t.type)return[{type:"text",value:"!["+t.alt+a}];const r=e.all(t),i=r[0];i&&"text"===i.type?i.value="["+i.value:r.unshift({type:"text",value:"["});const s=r[r.length-1];return s&&"text"===s.type?s.value+=a:r.push({type:"text",value:a}),r}function zj(e){const t=e.spread;return null==t?e.children.length>1:t}function Bj(e){const t=String(e),n=/\r?\n|\r/g;let a=n.exec(t),r=0;const i=[];for(;a;)i.push(Hj(t.slice(r,a.index),r>0,!0),a[0]),r=a.index+a[0].length,a=n.exec(t);return i.push(Hj(t.slice(r),r>0,!1)),i.join("")}function Hj(e,t,n){let a=0,r=e.length;if(t){let t=e.codePointAt(a);for(;9===t||32===t;)a++,t=e.codePointAt(a)}if(n){let t=e.codePointAt(r-1);for(;9===t||32===t;)r--,t=e.codePointAt(r-1)}return r>a?e.slice(a,r):""}const $j={blockquote:function(e,t){const n={type:"element",tagName:"blockquote",properties:{},children:e.wrap(e.all(t),!0)};return e.patch(t,n),e.applyData(t,n)},break:function(e,t){const n={type:"element",tagName:"br",properties:{},children:[]};return e.patch(t,n),[e.applyData(t,n),{type:"text",value:"\n"}]},code:function(e,t){const n=t.value?t.value+"\n":"",a={},r=t.lang?t.lang.split(/\s+/):[];r.length>0&&(a.className=["language-"+r[0]]);let i={type:"element",tagName:"code",properties:a,children:[{type:"text",value:n}]};return t.meta&&(i.data={meta:t.meta}),e.patch(t,i),i=e.applyData(t,i),i={type:"element",tagName:"pre",properties:{},children:[i]},e.patch(t,i),i},delete:function(e,t){const n={type:"element",tagName:"del",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},emphasis:function(e,t){const n={type:"element",tagName:"em",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},footnoteReference:function(e,t){const n="string"==typeof e.options.clobberPrefix?e.options.clobberPrefix:"user-content-",a=String(t.identifier).toUpperCase(),r=fP(a.toLowerCase()),i=e.footnoteOrder.indexOf(a);let s,o=e.footnoteCounts.get(a);void 0===o?(o=0,e.footnoteOrder.push(a),s=e.footnoteOrder.length):s=i+1,o+=1,e.footnoteCounts.set(a,o);const l={type:"element",tagName:"a",properties:{href:"#"+n+"fn-"+r,id:n+"fnref-"+r+(o>1?"-"+o:""),dataFootnoteRef:!0,ariaDescribedBy:["footnote-label"]},children:[{type:"text",value:String(s)}]};e.patch(t,l);const c={type:"element",tagName:"sup",properties:{},children:[l]};return e.patch(t,c),e.applyData(t,c)},heading:function(e,t){const n={type:"element",tagName:"h"+t.depth,properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},html:function(e,t){if(e.options.allowDangerousHtml){const n={type:"raw",value:t.value};return e.patch(t,n),e.applyData(t,n)}},imageReference:function(e,t){const n=String(t.identifier).toUpperCase(),a=e.definitionById.get(n);if(!a)return Fj(e,t);const r={src:fP(a.url||""),alt:t.alt};null!==a.title&&void 0!==a.title&&(r.title=a.title);const i={type:"element",tagName:"img",properties:r,children:[]};return e.patch(t,i),e.applyData(t,i)},image:function(e,t){const n={src:fP(t.url)};null!==t.alt&&void 0!==t.alt&&(n.alt=t.alt),null!==t.title&&void 0!==t.title&&(n.title=t.title);const a={type:"element",tagName:"img",properties:n,children:[]};return e.patch(t,a),e.applyData(t,a)},inlineCode:function(e,t){const n={type:"text",value:t.value.replace(/\r?\n|\r/g," ")};e.patch(t,n);const a={type:"element",tagName:"code",properties:{},children:[n]};return e.patch(t,a),e.applyData(t,a)},linkReference:function(e,t){const n=String(t.identifier).toUpperCase(),a=e.definitionById.get(n);if(!a)return Fj(e,t);const r={href:fP(a.url||"")};null!==a.title&&void 0!==a.title&&(r.title=a.title);const i={type:"element",tagName:"a",properties:r,children:e.all(t)};return e.patch(t,i),e.applyData(t,i)},link:function(e,t){const n={href:fP(t.url)};null!==t.title&&void 0!==t.title&&(n.title=t.title);const a={type:"element",tagName:"a",properties:n,children:e.all(t)};return e.patch(t,a),e.applyData(t,a)},listItem:function(e,t,n){const a=e.all(t),r=n?function(e){let t=!1;if("list"===e.type){t=e.spread||!1;const n=e.children;let a=-1;for(;!t&&++a<n.length;)t=zj(n[a])}return t}(n):zj(t),i={},s=[];if("boolean"==typeof t.checked){const e=a[0];let n;e&&"element"===e.type&&"p"===e.tagName?n=e:(n={type:"element",tagName:"p",properties:{},children:[]},a.unshift(n)),n.children.length>0&&n.children.unshift({type:"text",value:" "}),n.children.unshift({type:"element",tagName:"input",properties:{type:"checkbox",checked:t.checked,disabled:!0},children:[]}),i.className=["task-list-item"]}let o=-1;for(;++o<a.length;){const e=a[o];(r||0!==o||"element"!==e.type||"p"!==e.tagName)&&s.push({type:"text",value:"\n"}),"element"!==e.type||"p"!==e.tagName||r?s.push(e):s.push(...e.children)}const l=a[a.length-1];l&&(r||"element"!==l.type||"p"!==l.tagName)&&s.push({type:"text",value:"\n"});const c={type:"element",tagName:"li",properties:i,children:s};return e.patch(t,c),e.applyData(t,c)},list:function(e,t){const n={},a=e.all(t);let r=-1;for("number"==typeof t.start&&1!==t.start&&(n.start=t.start);++r<a.length;){const e=a[r];if("element"===e.type&&"li"===e.tagName&&e.properties&&Array.isArray(e.properties.className)&&e.properties.className.includes("task-list-item")){n.className=["contains-task-list"];break}}const i={type:"element",tagName:t.ordered?"ol":"ul",properties:n,children:e.wrap(a,!0)};return e.patch(t,i),e.applyData(t,i)},paragraph:function(e,t){const n={type:"element",tagName:"p",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},root:function(e,t){const n={type:"root",children:e.wrap(e.all(t))};return e.patch(t,n),e.applyData(t,n)},strong:function(e,t){const n={type:"element",tagName:"strong",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},table:function(e,t){const n=e.all(t),a=n.shift(),r=[];if(a){const n={type:"element",tagName:"thead",properties:{},children:e.wrap([a],!0)};e.patch(t.children[0],n),r.push(n)}if(n.length>0){const a={type:"element",tagName:"tbody",properties:{},children:e.wrap(n,!0)},i=bN(t.children[1]),s=xN(t.children[t.children.length-1]);i&&s&&(a.position={start:i,end:s}),r.push(a)}const i={type:"element",tagName:"table",properties:{},children:e.wrap(r,!0)};return e.patch(t,i),e.applyData(t,i)},tableCell:function(e,t){const n={type:"element",tagName:"td",properties:{},children:e.all(t)};return e.patch(t,n),e.applyData(t,n)},tableRow:function(e,t,n){const a=n?n.children:void 0,r=0===(a?a.indexOf(t):1)?"th":"td",i=n&&"table"===n.type?n.align:void 0,s=i?i.length:t.children.length;let o=-1;const l=[];for(;++o<s;){const n=t.children[o],a={},s=i?i[o]:void 0;s&&(a.align=s);let c={type:"element",tagName:r,properties:a,children:[]};n&&(c.children=e.all(n),e.patch(n,c),c=e.applyData(n,c)),l.push(c)}const c={type:"element",tagName:"tr",properties:{},children:e.wrap(l,!0)};return e.patch(t,c),e.applyData(t,c)},text:function(e,t){const n={type:"text",value:Bj(String(t.value))};return e.patch(t,n),e.applyData(t,n)},thematicBreak:function(e,t){const n={type:"element",tagName:"hr",properties:{},children:[]};return e.patch(t,n),e.applyData(t,n)},toml:Vj,yaml:Vj,definition:Vj,footnoteDefinition:Vj};function Vj(){}const Wj="object"==typeof self?self:globalThis,Gj=e=>((e,t)=>{const n=(t,n)=>(e.set(n,t),t),a=r=>{if(e.has(r))return e.get(r);const[i,s]=t[r];switch(i){case 0:case-1:return n(s,r);case 1:{const e=n([],r);for(const t of s)e.push(a(t));return e}case 2:{const e=n({},r);for(const[t,n]of s)e[a(t)]=a(n);return e}case 3:return n(new Date(s),r);case 4:{const{source:e,flags:t}=s;return n(new RegExp(e,t),r)}case 5:{const e=n(new Map,r);for(const[t,n]of s)e.set(a(t),a(n));return e}case 6:{const e=n(new Set,r);for(const t of s)e.add(a(t));return e}case 7:{const{name:e,message:t}=s;return n(new Wj[e](t),r)}case 8:return n(BigInt(s),r);case"BigInt":return n(Object(BigInt(s)),r);case"ArrayBuffer":return n(new Uint8Array(s).buffer,s);case"DataView":{const{buffer:e}=new Uint8Array(s);return n(new DataView(e),s)}}return n(new Wj[i](s),r)};return a})(new Map,e)(0),Xj="",{toString:qj}={},{keys:Kj}=Object,Yj=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const n=qj.call(e).slice(8,-1);switch(n){case"Array":return[1,Xj];case"Object":return[2,Xj];case"Date":return[3,Xj];case"RegExp":return[4,Xj];case"Map":return[5,Xj];case"Set":return[6,Xj];case"DataView":return[1,n]}return n.includes("Array")?[1,n]:n.includes("Error")?[7,n]:[2,n]},Jj=([e,t])=>0===e&&("function"===t||"symbol"===t),Zj=(e,{json:t,lossy:n}={})=>{const a=[];return((e,t,n,a)=>{const r=(e,t)=>{const r=a.push(e)-1;return n.set(t,r),r},i=a=>{if(n.has(a))return n.get(a);let[s,o]=Yj(a);switch(s){case 0:{let t=a;switch(o){case"bigint":s=8,t=a.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+o);t=null;break;case"undefined":return r([-1],a)}return r([s,t],a)}case 1:{if(o){let e=a;return"DataView"===o?e=new Uint8Array(a.buffer):"ArrayBuffer"===o&&(e=new Uint8Array(a)),r([o,[...e]],a)}const e=[],t=r([s,e],a);for(const n of a)e.push(i(n));return t}case 2:{if(o)switch(o){case"BigInt":return r([o,a.toString()],a);case"Boolean":case"Number":case"String":return r([o,a.valueOf()],a)}if(t&&"toJSON"in a)return i(a.toJSON());const n=[],l=r([s,n],a);for(const t of Kj(a))!e&&Jj(Yj(a[t]))||n.push([i(t),i(a[t])]);return l}case 3:return r([s,a.toISOString()],a);case 4:{const{source:e,flags:t}=a;return r([s,{source:e,flags:t}],a)}case 5:{const t=[],n=r([s,t],a);for(const[r,s]of a)(e||!Jj(Yj(r))&&!Jj(Yj(s)))&&t.push([i(r),i(s)]);return n}case 6:{const t=[],n=r([s,t],a);for(const r of a)!e&&Jj(Yj(r))||t.push(i(r));return n}}const{message:l}=a;return r([s,{name:o,message:l}],a)};return i})(!(t||n),!!t,new Map,a)(e),a},Qj="function"==typeof structuredClone?(e,t)=>t&&("json"in t||"lossy"in t)?Gj(Zj(e,t)):structuredClone(e):(e,t)=>Gj(Zj(e,t));function eA(e,t){const n=[{type:"text",value:""}];return t>1&&n.push({type:"element",tagName:"sup",properties:{},children:[{type:"text",value:String(t)}]}),n}function tA(e,t){return"Back to reference "+(e+1)+(t>1?"-"+t:"")}const nA=function(e){if(null==e)return rA;if("function"==typeof e)return aA(e);if("object"==typeof e)return Array.isArray(e)?function(e){const t=[];let n=-1;for(;++n<e.length;)t[n]=nA(e[n]);return aA(a);function a(...e){let n=-1;for(;++n<t.length;)if(t[n].apply(this,e))return!0;return!1}}(e):function(e){const t=e;return aA(n);function n(n){const a=n;let r;for(r in e)if(a[r]!==t[r])return!1;return!0}}(e);if("string"==typeof e)return function(e){return aA(t);function t(t){return t&&t.type===e}}(e);throw new Error("Expected function, string, or object as test")};function aA(e){return function(t,n,a){return Boolean(function(e){return null!==e&&"object"==typeof e&&"type"in e}(t)&&e.call(this,t,"number"==typeof n?n:void 0,a||void 0))}}function rA(){return!0}const iA=[],sA=!0,oA=!1;function lA(e,t,n,a){let r;"function"==typeof t&&"function"!=typeof n?(a=n,n=t):r=t;const i=nA(r),s=a?-1:1;!function e(r,o,l){const c=r&&"object"==typeof r?r:{};if("string"==typeof c.type){const e="string"==typeof c.tagName?c.tagName:"string"==typeof c.name?c.name:void 0;Object.defineProperty(d,"name",{value:"node ("+r.type+(e?"<"+e+">":"")+")"})}return d;function d(){let c,d,u,h=iA;if((!t||i(r,o,l[l.length-1]||void 0))&&(h=function(e){if(Array.isArray(e))return e;if("number"==typeof e)return[sA,e];return null==e?iA:[e]}(n(r,l)),h[0]===oA))return h;if("children"in r&&r.children){const t=r;if(t.children&&"skip"!==h[0])for(d=(a?t.children.length:-1)+s,u=l.concat(t);d>-1&&d<t.children.length;){const n=t.children[d];if(c=e(n,d,u)(),c[0]===oA)return c;d="number"==typeof c[1]?c[1]:d+s}}return h}}(e,void 0,[])()}function cA(e,t,n,a){let r,i,s;"function"==typeof t&&"function"!=typeof n?(i=void 0,s=t,r=n):(i=t,s=n,r=a),lA(e,i,function(e,t){const n=t[t.length-1],a=n?n.children.indexOf(e):void 0;return s(e,a,n)},r)}const dA={}.hasOwnProperty,uA={};function hA(e,t){e.position&&(t.position=function(e){const t=bN(e),n=xN(e);if(t&&n)return{start:t,end:n}}(e))}function pA(e,t){let n=t;if(e&&e.data){const t=e.data.hName,a=e.data.hChildren,r=e.data.hProperties;if("string"==typeof t)if("element"===n.type)n.tagName=t;else{n={type:"element",tagName:t,properties:{},children:"children"in n?n.children:[n]}}"element"===n.type&&r&&Object.assign(n.properties,Qj(r)),"children"in n&&n.children&&null!=a&&(n.children=a)}return n}function mA(e,t){const n=t.data||{},a=!("value"in t)||dA.call(n,"hProperties")||dA.call(n,"hChildren")?{type:"element",tagName:"div",properties:{},children:e.all(t)}:{type:"text",value:t.value};return e.patch(t,a),e.applyData(t,a)}function fA(e,t){const n=[];let a=-1;for(t&&n.push({type:"text",value:"\n"});++a<e.length;)a&&n.push({type:"text",value:"\n"}),n.push(e[a]);return t&&e.length>0&&n.push({type:"text",value:"\n"}),n}function gA(e){let t=0,n=e.charCodeAt(t);for(;9===n||32===n;)t++,n=e.charCodeAt(t);return e.slice(t)}function vA(e,t){const n=function(e,t){const n=t||uA,a=new Map,r=new Map,i=new Map,s={...$j,...n.handlers},o={all:function(e){const t=[];if("children"in e){const n=e.children;let a=-1;for(;++a<n.length;){const r=o.one(n[a],e);if(r){if(a&&"break"===n[a-1].type&&(Array.isArray(r)||"text"!==r.type||(r.value=gA(r.value)),!Array.isArray(r)&&"element"===r.type)){const e=r.children[0];e&&"text"===e.type&&(e.value=gA(e.value))}Array.isArray(r)?t.push(...r):t.push(r)}}}return t},applyData:pA,definitionById:a,footnoteById:r,footnoteCounts:i,footnoteOrder:[],handlers:s,one:function(e,t){const n=e.type,a=o.handlers[n];if(dA.call(o.handlers,n)&&a)return a(o,e,t);if(o.options.passThrough&&o.options.passThrough.includes(n)){if("children"in e){const{children:t,...n}=e,a=Qj(n);return a.children=o.all(e),a}return Qj(e)}return(o.options.unknownHandler||mA)(o,e,t)},options:n,patch:hA,wrap:fA};return cA(e,function(e){if("definition"===e.type||"footnoteDefinition"===e.type){const t="definition"===e.type?a:r,n=String(e.identifier).toUpperCase();t.has(n)||t.set(n,e)}}),o}(e,t),a=n.one(e,void 0),r=function(e){const t="string"==typeof e.options.clobberPrefix?e.options.clobberPrefix:"user-content-",n=e.options.footnoteBackContent||eA,a=e.options.footnoteBackLabel||tA,r=e.options.footnoteLabel||"Footnotes",i=e.options.footnoteLabelTagName||"h2",s=e.options.footnoteLabelProperties||{className:["sr-only"]},o=[];let l=-1;for(;++l<e.footnoteOrder.length;){const r=e.footnoteById.get(e.footnoteOrder[l]);if(!r)continue;const i=e.all(r),s=String(r.identifier).toUpperCase(),c=fP(s.toLowerCase());let d=0;const u=[],h=e.footnoteCounts.get(s);for(;void 0!==h&&++d<=h;){u.length>0&&u.push({type:"text",value:" "});let e="string"==typeof n?n:n(l,d);"string"==typeof e&&(e={type:"text",value:e}),u.push({type:"element",tagName:"a",properties:{href:"#"+t+"fnref-"+c+(d>1?"-"+d:""),dataFootnoteBackref:"",ariaLabel:"string"==typeof a?a:a(l,d),className:["data-footnote-backref"]},children:Array.isArray(e)?e:[e]})}const p=i[i.length-1];if(p&&"element"===p.type&&"p"===p.tagName){const e=p.children[p.children.length-1];e&&"text"===e.type?e.value+=" ":p.children.push({type:"text",value:" "}),p.children.push(...u)}else i.push(...u);const m={type:"element",tagName:"li",properties:{id:t+"fn-"+c},children:e.wrap(i,!0)};e.patch(r,m),o.push(m)}if(0!==o.length)return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:i,properties:{...Qj(s),id:"footnote-label"},children:[{type:"text",value:r}]},{type:"text",value:"\n"},{type:"element",tagName:"ol",properties:{},children:e.wrap(o,!0)},{type:"text",value:"\n"}]}}(n),i=Array.isArray(a)?{type:"root",children:a}:a||{type:"root",children:[]};return r&&i.children.push({type:"text",value:"\n"},r),i}function yA(e,t){return e&&"run"in e?async function(n,a){const r=vA(n,{file:a,...t});await e.run(r,a)}:function(n,a){return vA(n,{file:a,...e||t})}}function xA(e){if(e)throw e}var bA=Object.prototype.hasOwnProperty,_A=Object.prototype.toString,wA=Object.defineProperty,SA=Object.getOwnPropertyDescriptor,MA=function(e){return"function"==typeof Array.isArray?Array.isArray(e):"[object Array]"===_A.call(e)},CA=function(e){if(!e||"[object Object]"!==_A.call(e))return!1;var t,n=bA.call(e,"constructor"),a=e.constructor&&e.constructor.prototype&&bA.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!n&&!a)return!1;for(t in e);return void 0===t||bA.call(e,t)},EA=function(e,t){wA&&"__proto__"===t.name?wA(e,t.name,{enumerable:!0,configurable:!0,value:t.newValue,writable:!0}):e[t.name]=t.newValue},kA=function(e,t){if("__proto__"===t){if(!bA.call(e,t))return;if(SA)return SA(e,t).value}return e[t]};const TA=$e(function e(){var t,n,a,r,i,s,o=arguments[0],l=1,c=arguments.length,d=!1;for("boolean"==typeof o&&(d=o,o=arguments[1]||{},l=2),(null==o||"object"!=typeof o&&"function"!=typeof o)&&(o={});l<c;++l)if(null!=(t=arguments[l]))for(n in t)a=kA(o,n),o!==(r=kA(t,n))&&(d&&r&&(CA(r)||(i=MA(r)))?(i?(i=!1,s=a&&MA(a)?a:[]):s=a&&CA(a)?a:{},EA(o,{name:n,newValue:e(d,s,r)})):void 0!==r&&EA(o,{name:n,newValue:r}));return o});function NA(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)}function PA(){const e=[],t={run:function(...t){let n=-1;const a=t.pop();if("function"!=typeof a)throw new TypeError("Expected function as last argument, not "+a);!function r(i,...s){const o=e[++n];let l=-1;if(i)a(i);else{for(;++l<t.length;)null!==s[l]&&void 0!==s[l]||(s[l]=t[l]);t=s,o?function(e,t){let n;return a;function a(...t){const a=e.length>t.length;let o;a&&t.push(r);try{o=e.apply(this,t)}catch(i){if(a&&n)throw i;return r(i)}a||(o&&o.then&&"function"==typeof o.then?o.then(s,r):o instanceof Error?r(o):s(o))}function r(e,...a){n||(n=!0,t(e,...a))}function s(e){r(null,e)}}(o,r)(...s):a(null,...s)}}(null,...t)},use:function(n){if("function"!=typeof n)throw new TypeError("Expected `middelware` to be a function, not "+n);return e.push(n),t}};return t}const jA={basename:function(e,t){if(void 0!==t&&"string"!=typeof t)throw new TypeError('"ext" argument must be a string');AA(e);let n,a=0,r=-1,i=e.length;if(void 0===t||0===t.length||t.length>e.length){for(;i--;)if(47===e.codePointAt(i)){if(n){a=i+1;break}}else r<0&&(n=!0,r=i+1);return r<0?"":e.slice(a,r)}if(t===e)return"";let s=-1,o=t.length-1;for(;i--;)if(47===e.codePointAt(i)){if(n){a=i+1;break}}else s<0&&(n=!0,s=i+1),o>-1&&(e.codePointAt(i)===t.codePointAt(o--)?o<0&&(r=i):(o=-1,r=s));a===r?r=s:r<0&&(r=e.length);return e.slice(a,r)},dirname:function(e){if(AA(e),0===e.length)return".";let t,n=-1,a=e.length;for(;--a;)if(47===e.codePointAt(a)){if(t){n=a;break}}else t||(t=!0);return n<0?47===e.codePointAt(0)?"/":".":1===n&&47===e.codePointAt(0)?"//":e.slice(0,n)},extname:function(e){AA(e);let t,n=e.length,a=-1,r=0,i=-1,s=0;for(;n--;){const o=e.codePointAt(n);if(47!==o)a<0&&(t=!0,a=n+1),46===o?i<0?i=n:1!==s&&(s=1):i>-1&&(s=-1);else if(t){r=n+1;break}}if(i<0||a<0||0===s||1===s&&i===a-1&&i===r+1)return"";return e.slice(i,a)},join:function(...e){let t,n=-1;for(;++n<e.length;)AA(e[n]),e[n]&&(t=void 0===t?e[n]:t+"/"+e[n]);return void 0===t?".":function(e){AA(e);const t=47===e.codePointAt(0);let n=function(e,t){let n,a,r="",i=0,s=-1,o=0,l=-1;for(;++l<=e.length;){if(l<e.length)n=e.codePointAt(l);else{if(47===n)break;n=47}if(47===n){if(s===l-1||1===o);else if(s!==l-1&&2===o){if(r.length<2||2!==i||46!==r.codePointAt(r.length-1)||46!==r.codePointAt(r.length-2))if(r.length>2){if(a=r.lastIndexOf("/"),a!==r.length-1){a<0?(r="",i=0):(r=r.slice(0,a),i=r.length-1-r.lastIndexOf("/")),s=l,o=0;continue}}else if(r.length>0){r="",i=0,s=l,o=0;continue}t&&(r=r.length>0?r+"/..":"..",i=2)}else r.length>0?r+="/"+e.slice(s+1,l):r=e.slice(s+1,l),i=l-s-1;s=l,o=0}else 46===n&&o>-1?o++:o=-1}return r}(e,!t);0!==n.length||t||(n=".");n.length>0&&47===e.codePointAt(e.length-1)&&(n+="/");return t?"/"+n:n}(t)},sep:"/"};function AA(e){if("string"!=typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}const RA={cwd:function(){return"/"}};function IA(e){return Boolean(null!==e&&"object"==typeof e&&"href"in e&&e.href&&"protocol"in e&&e.protocol&&void 0===e.auth)}function LA(e){if("string"==typeof e)e=new URL(e);else if(!IA(e)){const t=new TypeError('The "path" argument must be of type string or an instance of URL. Received `'+e+"`");throw t.code="ERR_INVALID_ARG_TYPE",t}if("file:"!==e.protocol){const e=new TypeError("The URL must be of scheme file");throw e.code="ERR_INVALID_URL_SCHEME",e}return function(e){if(""!==e.hostname){const e=new TypeError('File URL host must be "localhost" or empty on darwin');throw e.code="ERR_INVALID_FILE_URL_HOST",e}const t=e.pathname;let n=-1;for(;++n<t.length;)if(37===t.codePointAt(n)&&50===t.codePointAt(n+1)){const e=t.codePointAt(n+2);if(70===e||102===e){const e=new TypeError("File URL path must not include encoded / characters");throw e.code="ERR_INVALID_FILE_URL_PATH",e}}return decodeURIComponent(t)}(e)}const DA=["history","path","basename","stem","extname","dirname"];class UA{constructor(e){let t;t=e?IA(e)?{path:e}:"string"==typeof e||function(e){return Boolean(e&&"object"==typeof e&&"byteLength"in e&&"byteOffset"in e)}(e)?{value:e}:e:{},this.cwd="cwd"in t?"":RA.cwd(),this.data={},this.history=[],this.messages=[],this.value,this.map,this.result,this.stored;let n,a=-1;for(;++a<DA.length;){const e=DA[a];e in t&&void 0!==t[e]&&null!==t[e]&&(this[e]="history"===e?[...t[e]]:t[e])}for(n in t)DA.includes(n)||(this[n]=t[n])}get basename(){return"string"==typeof this.path?jA.basename(this.path):void 0}set basename(e){FA(e,"basename"),OA(e,"basename"),this.path=jA.join(this.dirname||"",e)}get dirname(){return"string"==typeof this.path?jA.dirname(this.path):void 0}set dirname(e){zA(this.basename,"dirname"),this.path=jA.join(e||"",this.basename)}get extname(){return"string"==typeof this.path?jA.extname(this.path):void 0}set extname(e){if(OA(e,"extname"),zA(this.dirname,"extname"),e){if(46!==e.codePointAt(0))throw new Error("`extname` must start with `.`");if(e.includes(".",1))throw new Error("`extname` cannot contain multiple dots")}this.path=jA.join(this.dirname,this.stem+(e||""))}get path(){return this.history[this.history.length-1]}set path(e){IA(e)&&(e=LA(e)),FA(e,"path"),this.path!==e&&this.history.push(e)}get stem(){return"string"==typeof this.path?jA.basename(this.path,this.extname):void 0}set stem(e){FA(e,"stem"),OA(e,"stem"),this.path=jA.join(this.dirname||"",e+(this.extname||""))}fail(e,t,n){const a=this.message(e,t,n);throw a.fatal=!0,a}info(e,t,n){const a=this.message(e,t,n);return a.fatal=void 0,a}message(e,t,n){const a=new EN(e,t,n);return this.path&&(a.name=this.path+":"+a.name,a.file=this.path),a.fatal=!1,this.messages.push(a),a}toString(e){if(void 0===this.value)return"";if("string"==typeof this.value)return this.value;return new TextDecoder(e||void 0).decode(this.value)}}function OA(e,t){if(e&&e.includes(jA.sep))throw new Error("`"+t+"` cannot be a path: did not expect `"+jA.sep+"`")}function FA(e,t){if(!e)throw new Error("`"+t+"` cannot be empty")}function zA(e,t){if(!e)throw new Error("Setting `"+t+"` requires `path` to be set too")}const BA=function(e){const t=this.constructor.prototype,n=t[e],a=function(){return n.apply(a,arguments)};return Object.setPrototypeOf(a,t),a},HA={}.hasOwnProperty;class $A extends BA{constructor(){super("copy"),this.Compiler=void 0,this.Parser=void 0,this.attachers=[],this.compiler=void 0,this.freezeIndex=-1,this.frozen=void 0,this.namespace={},this.parser=void 0,this.transformers=PA()}copy(){const e=new $A;let t=-1;for(;++t<this.attachers.length;){const n=this.attachers[t];e.use(...n)}return e.data(TA(!0,{},this.namespace)),e}data(e,t){return"string"==typeof e?2===arguments.length?(XA("data",this.frozen),this.namespace[e]=t,this):HA.call(this.namespace,e)&&this.namespace[e]||void 0:e?(XA("data",this.frozen),this.namespace=e,this):this.namespace}freeze(){if(this.frozen)return this;const e=this;for(;++this.freezeIndex<this.attachers.length;){const[t,...n]=this.attachers[this.freezeIndex];if(!1===n[0])continue;!0===n[0]&&(n[0]=void 0);const a=t.call(e,...n);"function"==typeof a&&this.transformers.use(a)}return this.frozen=!0,this.freezeIndex=Number.POSITIVE_INFINITY,this}parse(e){this.freeze();const t=YA(e),n=this.parser||this.Parser;return WA("parse",n),n(String(t),t)}process(e,t){const n=this;return this.freeze(),WA("process",this.parser||this.Parser),GA("process",this.compiler||this.Compiler),t?a(void 0,t):new Promise(a);function a(a,r){const i=YA(e),s=n.parse(i);function o(e,n){e||!n?r(e):a?a(n):t(void 0,n)}n.run(s,i,function(e,t,a){if(e||!t||!a)return o(e);const r=t,i=n.stringify(r,a);var s;"string"==typeof(s=i)||function(e){return Boolean(e&&"object"==typeof e&&"byteLength"in e&&"byteOffset"in e)}(s)?a.value=i:a.result=i,o(e,a)})}}processSync(e){let t,n=!1;return this.freeze(),WA("processSync",this.parser||this.Parser),GA("processSync",this.compiler||this.Compiler),this.process(e,function(e,a){n=!0,xA(e),t=a}),KA("processSync","process",n),t}run(e,t,n){qA(e),this.freeze();const a=this.transformers;return n||"function"!=typeof t||(n=t,t=void 0),n?r(void 0,n):new Promise(r);function r(r,i){const s=YA(t);a.run(e,s,function(t,a,s){const o=a||e;t?i(t):r?r(o):n(void 0,o,s)})}}runSync(e,t){let n,a=!1;return this.run(e,t,function(e,t){xA(e),n=t,a=!0}),KA("runSync","run",a),n}stringify(e,t){this.freeze();const n=YA(t),a=this.compiler||this.Compiler;return GA("stringify",a),qA(e),a(e,n)}use(e,...t){const n=this.attachers,a=this.namespace;if(XA("use",this.frozen),null==e);else if("function"==typeof e)o(e,t);else{if("object"!=typeof e)throw new TypeError("Expected usable value, not `"+e+"`");Array.isArray(e)?s(e):i(e)}return this;function r(e){if("function"==typeof e)o(e,[]);else{if("object"!=typeof e)throw new TypeError("Expected usable value, not `"+e+"`");if(Array.isArray(e)){const[t,...n]=e;o(t,n)}else i(e)}}function i(e){if(!("plugins"in e)&&!("settings"in e))throw new Error("Expected usable value but received an empty preset, which is probably a mistake: presets typically come with `plugins` and sometimes with `settings`, but this has neither");s(e.plugins),e.settings&&(a.settings=TA(!0,a.settings,e.settings))}function s(e){let t=-1;if(null==e);else{if(!Array.isArray(e))throw new TypeError("Expected a list of plugins, not `"+e+"`");for(;++t<e.length;){r(e[t])}}}function o(e,t){let a=-1,r=-1;for(;++a<n.length;)if(n[a][0]===e){r=a;break}if(-1===r)n.push([e,...t]);else if(t.length>0){let[a,...i]=t;const s=n[r][1];NA(s)&&NA(a)&&(a=TA(!0,s,a)),n[r]=[e,a,...i]}}}}const VA=(new $A).freeze();function WA(e,t){if("function"!=typeof t)throw new TypeError("Cannot `"+e+"` without `parser`")}function GA(e,t){if("function"!=typeof t)throw new TypeError("Cannot `"+e+"` without `compiler`")}function XA(e,t){if(t)throw new Error("Cannot call `"+e+"` on a frozen processor.\nCreate a new processor first, by calling it: use `processor()` instead of `processor`.")}function qA(e){if(!NA(e)||"string"!=typeof e.type)throw new TypeError("Expected node, got `"+e+"`")}function KA(e,t,n){if(!n)throw new Error("`"+e+"` finished async. Use `"+t+"` instead")}function YA(e){return function(e){return Boolean(e&&"object"==typeof e&&"message"in e&&"messages"in e)}(e)?e:new UA(e)}const JA=[],ZA={allowDangerousHtml:!0},QA=/^(https?|ircs?|mailto|xmpp)$/i,eR=[{from:"astPlugins",id:"remove-buggy-html-in-markdown-parser"},{from:"allowDangerousHtml",id:"remove-buggy-html-in-markdown-parser"},{from:"allowNode",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"allowElement"},{from:"allowedTypes",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"allowedElements"},{from:"className",id:"remove-classname"},{from:"disallowedTypes",id:"replace-allownode-allowedtypes-and-disallowedtypes",to:"disallowedElements"},{from:"escapeHtml",id:"remove-buggy-html-in-markdown-parser"},{from:"includeElementIndex",id:"#remove-includeelementindex"},{from:"includeNodeIndex",id:"change-includenodeindex-to-includeelementindex"},{from:"linkTarget",id:"remove-linktarget"},{from:"plugins",id:"change-plugins-to-remarkplugins",to:"remarkPlugins"},{from:"rawSourcePos",id:"#remove-rawsourcepos"},{from:"renderers",id:"change-renderers-to-components",to:"components"},{from:"source",id:"change-source-to-children",to:"children"},{from:"sourcePos",id:"#remove-sourcepos"},{from:"transformImageUri",id:"#add-urltransform",to:"urlTransform"},{from:"transformLinkUri",id:"#add-urltransform",to:"urlTransform"}];function tR(e){const t=function(e){const t=e.rehypePlugins||JA,n=e.remarkPlugins||JA,a=e.remarkRehypeOptions?{...e.remarkRehypeOptions,...ZA}:ZA,r=VA().use(Oj).use(n).use(yA,a).use(t);return r}(e),n=function(e){const t=e.children||"",n=new UA;"string"==typeof t&&(n.value=t);return n}(e);return function(e,t){const n=t.allowedElements,a=t.allowElement,r=t.components,i=t.disallowedElements,s=t.skipHtml,o=t.unwrapDisallowed,l=t.urlTransform||nR;for(const d of eR)Object.hasOwn(t,d.from)&&sT((d.from,d.to&&d.to,d.id));return cA(e,c),RN(e,{Fragment:Ut.Fragment,components:r,ignoreInvalidStyle:!0,jsx:Ut.jsx,jsxs:Ut.jsxs,passKeys:!0,passNode:!0});function c(e,t,r){if("raw"===e.type&&r&&"number"==typeof t)return s?r.children.splice(t,1):r.children[t]={type:"text",value:e.value},t;if("element"===e.type){let t;for(t in $N)if(Object.hasOwn($N,t)&&Object.hasOwn(e.properties,t)){const n=e.properties[t],a=$N[t];(null===a||a.includes(e.tagName))&&(e.properties[t]=l(String(n||""),t,e))}}if("element"===e.type){let s=n?!n.includes(e.tagName):!!i&&i.includes(e.tagName);if(!s&&a&&"number"==typeof t&&(s=!a(e,t,r)),s&&r&&"number"==typeof t)return o&&e.children?r.children.splice(t,1,...e.children):r.children.splice(t,1),t}}}(t.runSync(t.parse(n),n),e)}function nR(e){const t=e.indexOf(":"),n=e.indexOf("?"),a=e.indexOf("#"),r=e.indexOf("/");return-1===t||-1!==r&&t>r||-1!==n&&t>n||-1!==a&&t>a||QA.test(e.slice(0,t))?e:""}function aR({notes:e,onNotesChange:t}){const[n,a]=Tt.useState(!1),[r,i]=Tt.useState(e),s=Tt.useRef(null),o=Tt.useRef(null);Tt.useEffect(()=>{i(e)},[e]),Tt.useEffect(()=>{n&&s.current&&s.current.focus()},[n]);const l=Tt.useCallback(e=>{o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{t(e)},300)},[t]),c=e.trim().length>0;return Ut.jsxs("div",{className:"panel-notes-footer",children:[Ut.jsxs("div",{className:"panel-notes-header",children:[Ut.jsxs("div",{className:"panel-notes-title",children:[Ut.jsx(JE,{size:12}),Ut.jsx("span",{children:"Notes"}),c&&Ut.jsx("span",{className:"notes-indicator",children:""})]}),Ut.jsx("button",{className:"panel-notes-toggle",onClick:()=>{a(!n),n&&(o.current&&clearTimeout(o.current),t(r))},title:n?"View mode":"Edit mode",children:n?Ut.jsx(EE,{size:12}):Ut.jsx(rk,{size:12})})]}),n?Ut.jsx("textarea",{ref:s,className:"panel-notes-textarea",value:r,onChange:e=>{const t=e.target.value;i(t),l(t)},placeholder:"Add notes (supports Markdown)...",rows:3}):Ut.jsx("div",{className:"panel-notes-view",children:c?Ut.jsx(tR,{components:{p:({children:e})=>Ut.jsx("p",{className:"markdown-paragraph",children:e}),strong:({children:e})=>Ut.jsx("strong",{className:"markdown-bold",children:e}),em:({children:e})=>Ut.jsx("em",{className:"markdown-italic",children:e}),code:({children:e})=>Ut.jsx("code",{className:"markdown-code",children:e}),ul:({children:e})=>Ut.jsx("ul",{className:"markdown-list",children:e}),ol:({children:e})=>Ut.jsx("ol",{className:"markdown-list",children:e}),li:({children:e})=>Ut.jsx("li",{className:"markdown-list-item",children:e})},children:e}):Ut.jsx("span",{className:"panel-notes-placeholder",children:"Click edit to add notes..."})})]})}function rR({panelId:e,name:t,locked:n,selected:a=!1,onNameChange:r,onRemove:i,onMouseDown:s,dragHandleListeners:o={}}){const[l,c]=Tt.useState(!1),[d,u]=Tt.useState(t),h=Tt.useRef(null);Tt.useEffect(()=>{l&&h.current&&(h.current.focus(),h.current.select())},[l]),Tt.useEffect(()=>{u(t)},[t]);const p=()=>{const e=function(e){return e.replace(/[<>:"\/\\|?*]/g,"_").replace(/\.\./g,"_").replace(/^\s+|\s+$/g,"").substring(0,30)}(d);e&&e!==t&&r(e),c(!1),u(e||t)};return Ut.jsxs("div",{className:"panel-header "+(a?"selected":""),onMouseDown:s,children:[Ut.jsx("div",{className:"panel-drag-handle",title:"Drag to move panel",...o,children:Ut.jsx(OE,{size:16})}),Ut.jsxs("div",{className:"panel-name-container",children:[l?Ut.jsx("input",{ref:h,type:"text",className:"panel-name-input",value:d,onChange:e=>u(e.target.value),onKeyDown:e=>{"Enter"===e.key?p():"Escape"===e.key&&(u(t),c(!1))},onBlur:()=>{p()},placeholder:`Panel_${String(e).padStart(2,"0")}`,maxLength:30}):Ut.jsx("span",{className:"panel-name "+(n?"locked":"editable"),onDoubleClick:()=>{n||c(!0)},title:n?"Panel locked (has generated images)":"Double-click to rename",children:t}),n&&Ut.jsx(qE,{size:12,className:"panel-lock-icon"})]}),Ut.jsx("div",{className:"panel-header-actions",children:Ut.jsx("button",{className:"panel-remove-btn",onClick:e=>{e.stopPropagation(),i()},title:"Remove panel",children:Ut.jsx(Nk,{size:14})})})]})}function iR({rating:e,onRatingChange:t,maxStars:n=5,size:a=14}){const[r,i]=Tt.useState(0);return Ut.jsx("div",{className:"star-rating",children:Array.from({length:n},(n,s)=>{const o=s+1,l=o<=(r||e);return Ut.jsx("button",{className:"star-btn "+(l?"filled":"empty"),onClick:()=>{var n;t((n=o)===e?0:n)},onMouseEnter:()=>i(o),onMouseLeave:()=>i(0),title:`${o} star${1!==o?"s":""}`,type:"button",children:Ut.jsx(bk,{size:a,fill:l?"currentColor":"none",strokeWidth:2})},o)})})}function sR({isOpen:e,onClose:t,projectName:n="Untitled Project",selectedPanelIds:a=[],panels:r}){const[i,s]=Tt.useState(3),[o,l]=Tt.useState("all"),[c,d]=Tt.useState(new Set),[u,h]=Tt.useState("a4"),[p,m]=Tt.useState("landscape"),f=Tt.useRef(null),[g,v]=Tt.useState("");Tt.useEffect(()=>{e&&(a.length>0?(l("selected"),d(new Set(a))):(l("all"),d(new Set(r.filter(e=>e.image).map(e=>e.id)))))},[e,r,a]);const y="all"===o?r.filter(e=>e.image):r.filter(e=>e.image&&c.has(e.id)),x=r.filter(e=>e.image),b=Tt.useCallback(e=>{d(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},[]),_=Tt.useCallback(()=>{d(new Set(r.filter(e=>e.image).map(e=>e.id)))},[r]),w=Tt.useCallback(()=>{d(new Set)},[]),S=Tt.useCallback(()=>{const e=Math.floor(100/i),t=i<=2?11:9,a="a4"===u?"landscape"===p?"size: A4 landscape;":"size: A4 portrait;":"landscape"===p?"size: letter landscape;":"size: letter portrait;",r=y.map(t=>{const n=t.name||`Panel ${t.id}`,a=t.rating&&t.rating>0?`<span class="cell-rating">${"".repeat(t.rating)}${"".repeat(5-t.rating)}</span>`:"",r=t.notes&&t.notes.trim()?`<div class="cell-notes">${oR(t.notes)}</div>`:"",i=t.imageHistory&&t.imageHistory.length>0?t.imageHistory[0]:null;let s="";if(i){const e=[];null!=i.metadata.version&&e.push(`v${i.metadata.version}`),i.metadata.generationTime&&e.push(`${i.metadata.generationTime.toFixed(1)}s`),i.metadata.workflowName&&e.push(oR(i.metadata.workflowName)),e.length>0&&(s=`<div class="cell-meta">${e.join("  ")}</div>`)}return`\n        <div class="cell" style="width:${e}%">\n          <div class="cell-inner">\n            <div class="cell-header">\n              <span class="cell-label">${oR(n)}</span>\n              ${a}\n            </div>\n            <img src="${t.image}" />\n            ${s}\n            ${r}\n          </div>\n        </div>`}).join("\n");return`<!DOCTYPE html>\n<html>\n<head>\n<meta charset="utf-8"/>\n<title>${oR(n)}  Storyboard</title>\n<style>\n  @page { ${a} margin: 10mm; }\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n  body {\n    font-family: 'Segoe UI', 'Inter', Arial, sans-serif;\n    background: #fff;\n    color: #1a1a1a;\n    -webkit-print-color-adjust: exact;\n    print-color-adjust: exact;\n  }\n  .header {\n    text-align: center;\n    padding: 8px 0 6px;\n    border-bottom: 2px solid #222;\n    margin-bottom: 8px;\n  }\n  .header h1 { font-size: 18px; font-weight: 600; }\n  .header .subtitle { font-size: 10px; color: #888; margin-top: 2px; }\n  .grid {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0;\n  }\n  .cell {\n    padding: 4px;\n    break-inside: avoid;\n  }\n  .cell-inner {\n    border: 1px solid #d0d0d0;\n    border-radius: 4px;\n    overflow: hidden;\n    background: #fafafa;\n  }\n  .cell-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 3px 6px;\n    background: #222;\n    color: #fff;\n  }\n  .cell-label {\n    font-size: 9px;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n  .cell-rating {\n    font-size: 10px;\n    color: #e0b967;\n  }\n  .cell-inner img {\n    display: block;\n    width: 100%;\n    height: auto;\n    object-fit: contain;\n  }\n  .cell-meta {\n    padding: 2px 6px;\n    font-size: 8px;\n    color: #888;\n    background: #f0f0f0;\n    border-top: 1px solid #e0e0e0;\n  }\n  .cell-notes {\n    padding: 4px 6px;\n    font-size: ${t}px;\n    line-height: 1.35;\n    color: #333;\n    background: #f4f4f4;\n    border-top: 1px solid #e0e0e0;\n    white-space: pre-wrap;\n    word-break: break-word;\n  }\n  @media print {\n    body { background: #fff; }\n    .header { page-break-after: avoid; }\n    .cell { break-inside: avoid; }\n  }\n</style>\n</head>\n<body>\n  <div class="header">\n    <h1>${oR(n)}</h1>\n    <div class="subtitle">${y.length} panel${1!==y.length?"s":""}  ${(new Date).toLocaleDateString()}</div>\n  </div>\n  <div class="grid">\n    ${r}\n  </div>\n</body>\n</html>`},[y,i,n,u,p]);Tt.useEffect(()=>{e&&v(S())},[e,S]),Tt.useEffect(()=>{const e=f.current;if(!e||!g)return;const t=e.contentDocument;t&&(t.open(),t.write(g),t.close())},[g]);const M=Tt.useCallback(()=>{const e=f.current;(null==e?void 0:e.contentWindow)&&(e.contentWindow.focus(),e.contentWindow.print())},[]);return e?Ut.jsx("div",{className:"print-dialog-overlay",onClick:t,children:Ut.jsxs("div",{className:"print-dialog",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"print-dialog-header",children:[Ut.jsxs("h2",{children:[Ut.jsx(lk,{size:18}),"Print Storyboard"]}),Ut.jsx("button",{className:"close-btn",onClick:t,children:Ut.jsx(Nk,{size:18})})]}),Ut.jsxs("div",{className:"print-toolbar",children:[Ut.jsxs("div",{className:"print-toolbar-group",children:[Ut.jsx("span",{className:"toolbar-label",children:"Grid:"}),[1,2,3,4].map(e=>Ut.jsxs("button",{className:"grid-btn "+(i===e?"active":""),onClick:()=>s(e),children:[e," col"]},e))]}),Ut.jsxs("div",{className:"print-toolbar-group",children:[Ut.jsx("span",{className:"toolbar-label",children:"Page:"}),Ut.jsxs("select",{className:"page-select",value:u,onChange:e=>h(e.target.value),children:[Ut.jsx("option",{value:"a4",children:"A4"}),Ut.jsx("option",{value:"letter",children:"Letter"})]}),Ut.jsxs("select",{className:"page-select",value:p,onChange:e=>m(e.target.value),children:[Ut.jsx("option",{value:"landscape",children:"Landscape"}),Ut.jsx("option",{value:"portrait",children:"Portrait"})]})]}),Ut.jsxs("div",{className:"print-toolbar-group",children:[Ut.jsx("span",{className:"toolbar-label",children:"Panels:"}),Ut.jsxs("button",{className:"mode-btn "+("all"===o?"active":""),onClick:()=>l("all"),children:["All (",x.length,")"]}),Ut.jsxs("button",{className:"mode-btn "+("selected"===o?"active":""),onClick:()=>l("selected"),children:["Selected (",c.size,")"]})]}),Ut.jsxs("button",{className:"print-action-btn",onClick:M,disabled:0===y.length,children:[Ut.jsx(lk,{size:16})," Print"]})]}),"selected"===o&&Ut.jsxs("div",{className:"print-panel-selector",children:[Ut.jsxs("div",{className:"selector-actions",children:[Ut.jsx("button",{onClick:_,className:"selector-action-btn",children:"Select All"}),Ut.jsx("button",{onClick:w,className:"selector-action-btn",children:"Deselect All"})]}),Ut.jsx("div",{className:"panel-chips",children:x.map(e=>Ut.jsxs("button",{className:"panel-chip "+(c.has(e.id)?"selected":""),onClick:()=>b(e.id),children:[c.has(e.id)?Ut.jsx(vk,{size:14}):Ut.jsx(xk,{size:14}),Ut.jsx("span",{className:"chip-thumb",children:e.image&&Ut.jsx("img",{src:e.image,alt:""})}),Ut.jsx("span",{children:e.name||`Panel ${e.id}`})]},e.id))})]}),Ut.jsx("div",{className:"print-preview-container",children:0===y.length?Ut.jsxs("div",{className:"print-empty",children:[Ut.jsx("p",{children:"No panels selected for printing."}),Ut.jsx("p",{className:"hint",children:'Choose panels with images above, or switch to "All" mode.'})]}):Ut.jsx("iframe",{ref:f,className:"print-preview-iframe",title:"Print Preview"})})]})}):null}function oR(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function lR({isOpen:e,onClose:t,orchestratorUrl:n}){const[a,r]=Tt.useState([]),[i,s]=Tt.useState(""),[o,l]=Tt.useState(!0),[c,d]=Tt.useState(!1),[u,h]=Tt.useState(null),[p,m]=Tt.useState(""),[f,g]=Tt.useState(null),v=Tt.useCallback(async()=>{if(n){l(!0),h(null);try{const e=await fetch(`${n}/api/path-mappings`);if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();r(t.mappings||[]),s(t.current_os||"")}catch(e){h(`Failed to load path mappings: ${e}`)}finally{l(!1)}}},[n]);if(Tt.useEffect(()=>{e&&v()},[e,v]),!e)return null;const y=async(e,t)=>{const i=a.find(t=>t.id===e);if(!i)return;const s={...i,...t};r(a.map(t=>t.id===e?s:t));try{const t=await fetch(`${n}/api/path-mappings/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s.name,windows:s.windows,linux:s.linux,macos:s.macos,enabled:s.enabled})});if(!t.ok)throw new Error(`HTTP ${t.status}`)}catch(o){h(`Failed to update mapping: ${o}`),v()}};return Ut.jsx("div",{className:"modal-overlay",onClick:t,children:Ut.jsxs("div",{className:"path-mappings-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"modal-header",children:[Ut.jsxs("h2",{children:[Ut.jsx(iE,{size:14})," Path Mappings"]}),Ut.jsx("button",{className:"close-btn",onClick:t,children:""})]}),Ut.jsxs("div",{className:"modal-body",children:[Ut.jsxs("div",{className:"os-indicator",children:[Ut.jsx(QE,{size:12}),Ut.jsxs("span",{children:["Server OS: ",Ut.jsx("strong",{children:(e=>{switch(e){case"windows":return"Windows";case"linux":return"Linux";case"macos":return"macOS";default:return e}})(i)})]}),Ut.jsx("small",{children:"Paths will be translated to this OS format"})]}),Ut.jsx("div",{className:"mapping-description",children:"Define how shared storage paths map across operating systems. When the frontend sends a path (e.g., from a saved project), the backend automatically translates it to the correct local mount point."}),u&&Ut.jsx("div",{className:"mapping-error",children:u}),o?Ut.jsx("div",{className:"mapping-loading",children:"Loading path mappings..."}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{className:"mappings-list",children:0===a.length?Ut.jsx("div",{className:"no-mappings",children:"No path mappings configured. Add one to enable cross-platform path translation."}):a.map(e=>Ut.jsxs("div",{className:"mapping-card "+(e.enabled?"":"disabled"),children:[Ut.jsxs("div",{className:"mapping-card-header",children:[Ut.jsx("input",{type:"text",className:"mapping-name-input",value:e.name,onChange:t=>y(e.id,{name:t.target.value}),onBlur:t=>y(e.id,{name:t.target.value}),placeholder:"Mapping name"}),Ut.jsxs("div",{className:"mapping-actions",children:[Ut.jsx("button",{className:"toggle-btn",onClick:()=>y(e.id,{enabled:!e.enabled}),title:e.enabled?"Disable":"Enable",children:e.enabled?Ut.jsx(Mk,{size:16}):Ut.jsx(Sk,{size:16})}),Ut.jsx("button",{className:"delete-mapping-btn",onClick:()=>(async e=>{r(a.filter(t=>t.id!==e));try{const t=await fetch(`${n}/api/path-mappings/${e}`,{method:"DELETE"});if(!t.ok)throw new Error(`HTTP ${t.status}`)}catch(t){h(`Failed to delete mapping: ${t}`),v()}})(e.id),title:"Delete mapping",children:Ut.jsx(Ck,{size:14})})]})]}),Ut.jsxs("div",{className:"mapping-paths",children:[Ut.jsxs("div",{className:"path-row",children:[Ut.jsxs("label",{className:"windows"===i?"current-os":"",children:["Windows ","windows"===i&&"(current)"]}),Ut.jsx("input",{type:"text",value:e.windows,onChange:t=>y(e.id,{windows:t.target.value}),placeholder:"e.g., W:\\ or \\\\server\\share"})]}),Ut.jsxs("div",{className:"path-row",children:[Ut.jsxs("label",{className:"linux"===i?"current-os":"",children:["Linux ","linux"===i&&"(current)"]}),Ut.jsx("input",{type:"text",value:e.linux,onChange:t=>y(e.id,{linux:t.target.value}),placeholder:"e.g., /mnt/Mandalore"})]}),Ut.jsxs("div",{className:"path-row",children:[Ut.jsxs("label",{className:"macos"===i?"current-os":"",children:["macOS ","macos"===i&&"(current)"]}),Ut.jsx("input",{type:"text",value:e.macos,onChange:t=>y(e.id,{macos:t.target.value}),placeholder:"e.g., /Volumes/Mandalore"})]})]})]},e.id))}),Ut.jsxs("button",{className:"add-mapping-btn",onClick:async()=>{d(!0);try{const e=await fetch(`${n}/api/path-mappings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:`Mapping ${a.length+1}`,windows:"",linux:"",macos:"",enabled:!0})});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();r([...a,t.mapping])}catch(e){h(`Failed to add mapping: ${e}`)}finally{d(!1)}},disabled:c,children:[Ut.jsx(sk,{size:14}),c?"Adding...":"Add Path Mapping"]}),Ut.jsxs("div",{className:"test-section",children:[Ut.jsx("h4",{children:"Test Translation"}),Ut.jsxs("div",{className:"test-input-row",children:[Ut.jsx("input",{type:"text",value:p,onChange:e=>{m(e.target.value),g(null)},placeholder:"Enter a path to test (e.g., W:\\Projects\\MyFilm)"}),Ut.jsx("button",{onClick:async()=>{if(p)try{const e=await fetch(`${n}/api/translate-path`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:p})});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();g(t.translated)}catch(e){g(`Error: ${e}`)}},disabled:!p,className:"test-btn",children:"Test"})]}),null!==f&&Ut.jsxs("div",{className:"test-result",children:[Ut.jsx(iE,{size:12}),Ut.jsx("span",{children:f})]})]})]})]}),Ut.jsx("div",{className:"modal-footer",children:Ut.jsx("button",{className:"btn-secondary",onClick:t,children:"Close"})})]})})}function cR({nodeName:e,progress:t,status:n,phase:a,currentNode:r,nodesExecuted:i,totalNodes:s}){const o="running"===n?`${t}%`:"pending"===n?"Queued":"complete"===n?"Done":"error"===n?"Error":n,l=[];a&&l.push(a),r&&l.push(r);const c=l.length>0?l.join("  "):void 0,d=null!=i&&null!=s&&s>0?`Step ${i}/${s}`:void 0;return Ut.jsxs("div",{className:"gen-progress-job",children:[Ut.jsxs("div",{className:"gen-progress-job-header",children:[Ut.jsx("span",{className:"gen-progress-node-name",children:e}),Ut.jsx("span",{className:`gen-progress-status ${n}`,children:o})]}),(c||d)&&Ut.jsxs("div",{className:"gen-progress-stage",children:[c&&Ut.jsx("span",{children:c}),c&&d&&Ut.jsx("span",{className:"gen-progress-stage-sep",children:"  "}),d&&Ut.jsx("span",{className:"gen-progress-node-counter",children:d})]}),Ut.jsx("div",{className:"gen-progress-bar-track",children:Ut.jsx("div",{className:`gen-progress-bar-fill ${n}`,style:{width:`${Math.min(100,t)}%`}})})]})}function dR({panels:e,onCancelSingle:t,onCancelParallelJob:n}){const a=e.filter(e=>"generating"===e.status);return 0===a.length?null:Ut.jsxs("div",{className:"gen-progress-section",children:[Ut.jsxs("div",{className:"gen-progress-header",children:[Ut.jsx("span",{className:"gen-progress-title",children:"Generation Progress"}),Ut.jsxs("span",{className:"gen-progress-count",children:[a.length," active"]})]}),a.map(e=>{const a=e.name||`Panel ${e.id}`,r=e.parallelJobs&&e.parallelJobs.length>0;return Ut.jsxs("div",{className:"gen-progress-panel-card",children:[Ut.jsxs("div",{className:"gen-progress-panel-header",children:[Ut.jsx("span",{className:"gen-progress-panel-name",children:a}),!r&&t&&Ut.jsx("button",{className:"gen-progress-cancel-btn",onClick:()=>t(e.id),title:"Cancel generation",children:""})]}),r?e.parallelJobs.filter(e=>"complete"!==e.status).map(t=>Ut.jsxs("div",{className:"gen-progress-job-wrapper",children:[Ut.jsx(cR,{nodeName:t.nodeName,progress:t.progress,status:t.status,phase:t.progressPhase,currentNode:t.currentNodeName,nodesExecuted:t.nodesExecuted,totalNodes:t.totalNodes}),n&&"running"===t.status&&Ut.jsx("button",{className:"gen-progress-cancel-job-btn",onClick:()=>n(e.id,t.nodeId),title:`Cancel on ${t.nodeName}`,children:""})]},`${e.id}-${t.nodeId}`)):Ut.jsx(cR,{nodeName:"Render Node",progress:e.progress,status:"running",phase:e.progressPhase,currentNode:e.progressNodeName,nodesExecuted:e.progressNodesExecuted,totalNodes:e.progressTotalNodes})]},e.id)})]})}const uR=new class{constructor(){Le(this,"baseUrl","/api/workflows")}async loadAll(){const e=await fetch(this.baseUrl,{signal:AbortSignal.timeout(1e4)});if(!e.ok)throw new Error(`Failed to load workflows: HTTP ${e.status}`);return e.json()}async save(e){const t=await fetch(this.baseUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.detail||`Failed to save workflow: HTTP ${t.status}`)}return t.json()}async saveAll(e){const t=await fetch(`${this.baseUrl}/bulk`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({workflows:e}),signal:AbortSignal.timeout(15e3)});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.detail||`Failed to bulk save workflows: HTTP ${t.status}`)}return t.json()}async update(e,t){const n=await fetch(`${this.baseUrl}/${encodeURIComponent(e)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const e=await n.json().catch(()=>({}));throw new Error(e.detail||`Failed to update workflow: HTTP ${n.status}`)}return n.json()}async delete(e){const t=await fetch(`${this.baseUrl}/${encodeURIComponent(e)}`,{method:"DELETE"});if(!t.ok){const e=await t.json().catch(()=>({}));throw new Error(e.detail||`Failed to delete workflow: HTTP ${t.status}`)}return t.json()}async getStorageInfo(){const e=await fetch(`${this.baseUrl}/storage-info`);if(!e.ok)throw new Error(`Failed to get storage info: HTTP ${e.status}`);return e.json()}};function hR(e,t){if(e)return e.length<=t?e:e.substring(0,t-3)+"..."}function pR(e,t=.1,n=5){return Math.max(t,Math.min(n,e))}function mR(e){if(!e)return;const t="string"==typeof e?new Date(e):e;return isNaN(t.getTime())?void 0:t.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function fR(e){if(e.includes("\\")||e.includes("/"))return e.split(/[\\\/]/).pop()||"";const t=e.match(/path=([^&]+)/);return t?decodeURIComponent(t[1]).split(/[\\\/]/).pop()||"":e}function gR(e,t){return 320*((e-1)%3)}function vR(e,t){return 320*Math.floor((e-1)/3)}const yR=new Set(["KSampler","KSamplerAdvanced","KSampler (Efficient)","SamplerCustom","SamplerCustomAdvanced","KSamplerSelect","SamplerDPMPP_2M_SDE","ADE_AnimateDiffSampler","ADE_AnimateDiffSamplerAdvanced","FreeU_V2","SamplerDPMPP_3M_SDE","WanSampler","HunyuanSampler","Efficient Loader","ImpactKSamplerBasicPipe","ImpactKSamplerAdvancedBasicPipe"]);function xR(e){const t={},n=[];for(const[a,r]of Object.entries(e)){if("object"!=typeof r||null===r)continue;const e=r.class_type||"";t[a]=e,(yR.has(e)||e.toLowerCase().includes("ksampler")||e.toLowerCase().includes("sampler"))&&n.push(a)}return{totalNodes:Object.keys(e).length,samplerNodeIds:n,nodeTypes:t}}const bR=["Image Generation","Text to Image","Image to Image","InPainting","Image Editing","Upscaling","Video Generation"],_R={text2img:"Text to Image",img2img:"Image to Image",inpainting:"InPainting",editing:"Image Editing",upscale:"Upscaling",video:"Video Generation"};function wR(){var e,t,n,a,r,i,s,o,l,c,d;const{showError:u,showWarning:h,showInfo:p,notifications:m,removeNotification:f}=function(){const[e,t]=Tt.useState([]),n=Tt.useRef(new Set);return{showError:Tt.useCallback(e=>{if(!$C("error",e))return"";BC+=1;const n=`${Date.now()}-${BC}`;return t(t=>[...t,{id:n,message:e,type:"error"}]),n},[]),showWarning:Tt.useCallback(e=>{if(!$C("warning",e))return"";BC+=1;const n=`${Date.now()}-${BC}`;return t(t=>[...t,{id:n,message:e,type:"warning"}]),n},[]),showInfo:Tt.useCallback(e=>{if(!$C("info",e))return"";BC+=1;const n=`${Date.now()}-${BC}`;return t(t=>[...t,{id:n,message:e,type:"info"}]),n},[]),notifications:e,removeNotification:Tt.useCallback(e=>{n.current.delete(e),t(t=>t.filter(t=>t.id!==e))},[])}}(),[g,v]=Tt.useState(()=>{const e=localStorage.getItem("storyboard-ui-state");if(e)try{return JSON.parse(e).activeTab??"image-generation"}catch{}return"image-generation"}),[y,x]=Tt.useState(()=>{const e=localStorage.getItem("storyboard-ui-state");if(e)try{return JSON.parse(e).activeSubTab??"text2img"}catch{}return"text2img"}),[b,_]=Tt.useState(null),[w,S]=Tt.useState(()=>[{id:1,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,status:"empty",progress:0,notes:"",prompt:"",seed:-1,x:0,y:0,width:300,height:300},{id:2,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,status:"empty",progress:0,notes:"",prompt:"",seed:-1,x:320,y:0,width:300,height:300},{id:3,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,status:"empty",progress:0,notes:"",prompt:"",seed:-1,x:640,y:0,width:300,height:300},{id:4,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,status:"empty",progress:0,notes:"",prompt:"",seed:-1,x:0,y:320,width:300,height:300},{id:5,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,status:"empty",progress:0,notes:"",prompt:"",seed:-1,x:320,y:320,width:300,height:300},{id:6,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,status:"empty",progress:0,notes:"",prompt:"",seed:-1,x:640,y:320,width:300,height:300}]),[M,C]=Tt.useState(null),[E,k]=Tt.useState(()=>{const e=localStorage.getItem("storyboard-ui-state");if(e)try{return JSON.parse(e).canvasZoom??1}catch{}return 1}),[T,N]=Tt.useState({x:0,y:0}),[P,j]=Tt.useState(!1),[A,R]=Tt.useState({x:0,y:0}),[I,L]=Tt.useState(null),[D,U]=Tt.useState({x:0,y:0,width:0,height:0}),[O,F]=Tt.useState(null),[z,B]=Tt.useState({x:0,y:0,panelX:0,panelY:0,selectedPanelPositions:new Map}),[H,$]=Tt.useState(!1),[V,W]=Tt.useState({x:0,y:0}),[G,X]=Tt.useState({x:0,y:0}),[q,K]=Tt.useState([]),[,Y]=Tt.useState(null),[J,Z]=Tt.useState(!1),[Q,ee]=Tt.useState(!1),[te,ne]=Tt.useState(""),ae=Tt.useRef(null),re=Tt.useRef(!1),ie=Tt.useRef(new Map),[se,oe]=Tt.useState([]),le=Tt.useRef(!1),[ce,de]=Tt.useState(null),[ue,he]=Tt.useState(!1),[pe,me]=Tt.useState(null),[fe,ge]=Tt.useState(!1),[ve,ye]=Tt.useState(!1),[xe,be]=Tt.useState(!1),[_e,we]=Tt.useState(null),[Se,Me]=Tt.useState(""),[Ce,Ee]=Tt.useState({}),[ke,Te]=Tt.useState({}),[Ne,Pe]=Tt.useState(""),[je,Ae]=Tt.useState(!1),[Re,Ie]=Tt.useState(!1),[Le,De]=Tt.useState(null),[Ue,Oe]=Tt.useState(null),[Fe,ze]=Tt.useState(1),[Be,He]=Tt.useState({x:0,y:0}),[$e,Ve]=Tt.useState(!1),[We,Ge]=Tt.useState(null),[Xe,qe]=Tt.useState(50),Ke=Tt.useRef(null),[Ye,Je]=Tt.useState({visible:!1,x:0,y:0,panelId:null}),[Ze,Qe]=Tt.useState(()=>!function(e=768){return window.innerWidth<e}(768)),[et,tt]=Tt.useState(!1),[nt,at]=Tt.useState(),[rt,it]=Tt.useState(),[st,ot]=Tt.useState(null),[lt,ct]=Tt.useState(!1),[dt,ut]=Tt.useState("actual"),ht=Tt.useRef(null),[pt,mt]=Tt.useState(`${window.location.protocol}//${window.location.hostname}:8188`),[ft,gt]=Tt.useState("disconnected"),[vt,yt]=Tt.useState(null),[xt,bt]=Tt.useState([]),[_t,wt]=Tt.useState("ALL"),[St,Mt]=Tt.useState(!0),[Ct,Et]=Tt.useState(!1),kt=Tt.useRef(null),[Nt,Pt]=Tt.useState(!1),[jt,At]=Tt.useState(!1),Rt=JC(),It=Tt.useRef(null),Lt=Tt.useRef(new Set),Dt=Tt.useRef(new Set),Ot=Tt.useRef(new Map),Ft=Tt.useRef(new Set),zt=Tt.useRef(0),Bt=Tt.useRef(Ce),Ht=Tt.useRef(M),$t=Tt.useRef(w);Bt.current=Ce,Ht.current=M,$t.current=w;const Vt=Tt.useRef(()=>{}),Wt=Tt.useCallback((e,t)=>{t.preventDefault(),t.stopPropagation();const n=w.find(t=>t.id===e);n&&(L(e),U({x:t.clientX,y:t.clientY,width:n.width,height:n.height}))},[w]),Gt=Tt.useCallback(e=>{if(null===I)return;const t=e.clientX-D.x,n=e.clientY-D.y,a=Math.max(200,D.width+t),r=Math.max(200,D.height+n);S(e=>e.map(e=>e.id===I?{...e,width:a,height:r}:e))},[I,D]),Xt=Tt.useCallback(()=>{L(null),U({x:0,y:0,width:0,height:0})},[]);Tt.useEffect(()=>{if(null!==I)return window.addEventListener("mousemove",Gt),window.addEventListener("mouseup",Xt),()=>{window.removeEventListener("mousemove",Gt),window.removeEventListener("mouseup",Xt)}},[I,Gt,Xt]);const qt=Tt.useCallback(e=>{S(t=>t.map(t=>t.id===e?{...t,selected:!t.selected}:t))},[]),Kt=Tt.useCallback((e,t)=>{const n=t.target;if("BUTTON"===n.tagName||"INPUT"===n.tagName||n.closest("button"))return;if(t.ctrlKey||t.metaKey||t.shiftKey)return t.preventDefault(),t.stopPropagation(),void qt(e);t.preventDefault(),t.stopPropagation();const a=w.find(t=>t.id===e);if(!a)return;F(e);const r=new Map;a.selected&&w.filter(e=>e.selected).forEach(e=>{r.set(e.id,{x:e.x,y:e.y})}),B({x:t.clientX,y:t.clientY,panelX:a.x,panelY:a.y,selectedPanelPositions:r}),S(t=>t.map(t=>t.id===e?{...t,zIndex:100}:t))},[w,qt]),Yt=Tt.useCallback(e=>{if(null===O)return;const t=(e.clientX-z.x)/E,n=(e.clientY-z.y)/E,a=z.panelX+t,r=z.panelY+n,i=z.selectedPanelPositions.size>1;S(e=>e.map(e=>{if(e.id===O)return{...e,x:a,y:r};if(i&&e.selected&&e.id!==O){const a=z.selectedPanelPositions.get(e.id);if(a)return{...e,x:a.x+t,y:a.y+n}}return e}))},[O,z,E]),Jt=Tt.useCallback(()=>{null!==O&&S(e=>e.map(e=>e.id===O?{...e,zIndex:void 0}:e)),F(null),B({x:0,y:0,panelX:0,panelY:0,selectedPanelPositions:new Map})},[O]);Tt.useEffect(()=>{if(null!==O)return window.addEventListener("mousemove",Yt),window.addEventListener("mouseup",Jt),()=>{window.removeEventListener("mousemove",Yt),window.removeEventListener("mouseup",Jt)}},[O,Yt,Jt]);const Zt=Tt.useCallback(e=>{const t=w.find(t=>t.id===e);if(!t)return;if(t.imageHistory.length>0)Y({open:!0,title:"Remove Panel",message:`Remove "${t.name||`Panel_${String(e).padStart(2,"0")}`}"?\n\nThis panel has ${t.imageHistory.length} generated image(s). This action cannot be undone.`,onConfirm:()=>{if(S(t=>t.filter(t=>t.id!==e)),M===e){const t=w.filter(t=>t.id!==e);C(t.length>0?t[0].id:null)}Y(null)},onCancel:()=>Y(null)});else if(S(t=>t.filter(t=>t.id!==e)),M===e){const t=w.filter(t=>t.id!==e);C(t.length>0?t[0].id:null)}},[w,M]),Qt=Tt.useCallback(e=>{const t=w.filter(e=>e.selected);if(t.length<2)return;let n;switch(e){case"left":n=Math.min(...t.map(e=>e.x));break;case"right":n=Math.max(...t.map(e=>e.x+e.width));break;case"top":n=Math.min(...t.map(e=>e.y));break;case"bottom":n=Math.max(...t.map(e=>e.y+e.height))}S(t=>t.map(t=>{if(!t.selected)return t;switch(e){case"left":return{...t,x:n};case"right":return{...t,x:n-t.width};case"top":return{...t,y:n};case"bottom":return{...t,y:n-t.height};default:return t}}))},[w]),en=Tt.useCallback(e=>{const t=w.filter(e=>e.selected);if(t.length<3)return;const n=[...t].sort((t,n)=>"horizontal"===e?t.x-n.x:t.y-n.y),a=n[0],r=n[n.length-1];let i,s;"horizontal"===e?(i=r.x+r.width-a.x,s=n.reduce((e,t)=>e+t.width,0)):(i=r.y+r.height-a.y,s=n.reduce((e,t)=>e+t.height,0));const o=(i-s)/(n.length-1);S(t=>{let r="horizontal"===e?a.x:a.y;const i=new Map;return n.forEach((t,a)=>{if(0===a)r+="horizontal"===e?t.width:t.height;else if(a===n.length-1);else{const n=r+o;i.set(t.id,{x:"horizontal"===e?n:t.x,y:"vertical"===e?n:t.y}),r=n+("horizontal"===e?t.width:t.height)}}),t.map(e=>{if(!e.selected)return e;const t=i.get(e.id);return t?{...e,...t}:e})})},[w]),tn=Tt.useCallback(async e=>{var t;e.preventDefault(),e.stopPropagation();const n=e.dataTransfer.items;if(n)for(let a=0;a<n.length;a++){const e=n[a];if("file"===e.kind){const n=null==(t=e.webkitGetAsEntry)?void 0:t.call(e);if(null==n?void 0:n.isDirectory){const e=n.name;ne(e),ee(!0);break}}}},[]),nn=Tt.useCallback((e,t)=>{const n={id:String(++zt.current),timestamp:new Date,tag:e,message:t};bt(e=>[...e.slice(-499),n])},[]),[an,rn]=Tt.useState([]),[sn,on]=Tt.useState(!1),[ln,cn]=Tt.useState(!1),[dn,un]=function(){const[e,t]=Tt.useState(Kk.getProject());return[e,Tt.useCallback(e=>{Kk.setProject(e),t(Kk.getProject())},[])]}(),[hn,pn]=Tt.useState(new Set),[mn,fn]=Tt.useState(!1),[gn,vn]=Tt.useState({progress:0,currentFile:""}),[yn,xn]=Tt.useState(null),[bn,_n]=Tt.useState(!1),[wn,Sn]=Tt.useState(new Set),[Mn,Cn]=Tt.useState(!1);Tt.useEffect(()=>{const e=e=>{"Shift"===e.key&&Z(!0)},t=e=>{"Shift"===e.key&&(Z(!1),K([]))};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[]),Tt.useEffect(()=>{const e=()=>{KC(),YC.stopPolling()};return window.addEventListener("beforeunload",e),()=>{window.removeEventListener("beforeunload",e),KC(),YC.stopPolling()}},[]),Tt.useEffect(()=>(dn.orchestratorUrl&&(YC.fetchBackendsFromAPI(dn.orchestratorUrl),YC.startPolling(5e3),setTimeout(()=>{YC.getNodes().forEach(e=>YC.pollNode(e))},100)),()=>{YC.stopPolling()}),[dn.orchestratorUrl]),Tt.useEffect(()=>{(async()=>{if(!dn.orchestratorUrl)return Sn(new Set),void Cn(!1);const e=[{path:"/api/health",method:"GET"},{path:"/api/scan-project-images",method:"POST",body:JSON.stringify({folder_path:"",naming_pattern:"",project_name:""})},{path:"/api/serve-image",method:"GET"},{path:"/api/delete-image",method:"DELETE",body:JSON.stringify({file_path:""})}],t=new Set;for(const n of e)try{const e=await fetch(`${dn.orchestratorUrl}${n.path}`,{method:n.method,headers:n.body?{"Content-Type":"application/json"}:void 0,body:n.body,signal:AbortSignal.timeout(5e3)});404!==e.status&&405!==e.status&&t.add(n.path)}catch{}Sn(t),Cn(!0),t.has("/api/scan-project-images")||h("Orchestrator server is running but project scanning endpoints are not available. Please update the Orchestrator server to the latest version for full functionality.")})()},[dn.orchestratorUrl]);const[En,kn]=Tt.useState(null),[Tn,Nn]=Tt.useState(!1),[Pn,jn]=Tt.useState([]),[An,Rn]=Tt.useState(""),[In,Ln]=Tt.useState(!1),[Dn,Un]=Tt.useState(()=>{const e=localStorage.getItem("storyboard-ui-state");if(e)try{return JSON.parse(e).leftPanelWidth??250}catch{}return 250}),[On,Fn]=Tt.useState(()=>{const e=localStorage.getItem("storyboard-ui-state");if(e)try{return JSON.parse(e).rightPanelWidth??200}catch{}return 200}),[zn,Bn]=Tt.useState(!1),[Hn,$n]=Tt.useState(!1);Tt.useEffect(()=>{const e=e=>{if(zn){const t=Math.max(150,Math.min(500,e.clientX));Un(t)}if(Hn){const t=Math.max(150,Math.min(400,window.innerWidth-e.clientX));Fn(t)}},t=()=>{Bn(!1),$n(!1),document.body.style.cursor="",document.body.style.userSelect=""};return(zn||Hn)&&(document.body.style.cursor="col-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",e),document.addEventListener("mouseup",t)),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t)}},[zn,Hn]),Tt.useEffect(()=>{const e=()=>{b&&_(null)};return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[b]),Tt.useEffect(()=>{St&&kt.current&&kt.current.scrollIntoView({behavior:"smooth"})},[xt,St]),Tt.useEffect(()=>{(async()=>{try{const t=await uR.loadAll();if(t.workflows&&t.workflows.length>0){const{migrated:e,changed:n}=(e=>{let t=!1;return{migrated:e.map(e=>{var n,a;let r=!1;const i=(null==(n=e.config)?void 0:n.map(e=>{var t;return"image_input"===e.category&&(null==(t=e.name)?void 0:t.includes("video"))&&"image"===e.type?(r=!0,{...e,type:"video"}):e}))||[],s=e.parsed?{...e.parsed,image_inputs:(null==(a=e.parsed.image_inputs)?void 0:a.map(e=>{var t;return(null==(t=e.name)?void 0:t.includes("video"))&&"video"!==e.type?(r=!0,{...e,type:"video"}):e}))||[]}:e.parsed;return r?(t=!0,{...e,config:i,parsed:s}):e}),changed:t}})(t.workflows);oe(e),n&&(console.log('[Workflows] Migrated video input types from "image" to "video" in stored workflows'),await uR.saveAll(e).catch(e=>console.warn("[Workflows] Failed to persist video type migration:",e))),ce||de(t.workflows[0].id),console.log(`[Workflows] Loaded ${t.count} workflows from ${t.storage_path}`)}else{const t=localStorage.getItem("storyboard_workflows");if(t)try{const e=JSON.parse(t);Array.isArray(e)&&e.length>0&&(console.log(`[Workflows] Migrating ${e.length} workflows from localStorage to backend...`),oe(e),ce||de(e[0].id),await uR.saveAll(e),localStorage.removeItem("storyboard_workflows"),console.log("[Workflows] Migration complete  localStorage cleared"))}catch(e){console.error("[Workflows] Failed to migrate from localStorage:",e)}}}catch(t){console.error("[Workflows] Failed to load from backend, falling back to localStorage:",t);const n=localStorage.getItem("storyboard_workflows");if(n)try{const e=JSON.parse(n);oe(e),e.length>0&&!ce&&de(e[0].id)}catch(e){console.error("[Workflows] localStorage fallback also failed:",e)}}le.current=!0})(),YC.loadFromStorage()},[]),Tt.useEffect(()=>{if(!le.current)return;const e=setTimeout(()=>{uR.saveAll(se).catch(e=>{console.error("[Workflows] Failed to save to backend:",e)})},500);return()=>clearTimeout(e)},[se]),Tt.useEffect(()=>{Re&&Ke.current&&Ke.current.focus()},[Re]),Tt.useEffect(()=>{const e={leftPanelWidth:Dn,rightPanelWidth:On,canvasZoom:E,activeTab:g,activeSubTab:y};localStorage.setItem("storyboard-ui-state",JSON.stringify(e))},[Dn,On,E,g,y]),Tt.useEffect(()=>{if(re.current)return re.current=!1,void console.log("[Effect] Skipping parameter reset (skipParameterReset was true)");const e=se.find(e=>e.id===ce);if(e){console.log("[Effect] Workflow change detected, resetting parameters to defaults for workflow:",ce);const t={},n=Bt.current;e.config.forEach(e=>{if(e.exposed){("image_input"===e.category||"prompt"===e.name||"prompt"===e.input_name)&&void 0!==n[e.name]?t[e.name]=n[e.name]:t[e.name]=e.default}}),Bt.current=t,Ee(t)}},[ce]),Tt.useEffect(()=>{function e(e){const t=e.detail;if(!(null==t?void 0:t.filePath))return;const n=se.find(e=>e.id===ce);if(!n)return void h("No workflow selected. Select a workflow first, then send the image.");const a=n.config.filter(e=>e.exposed&&("image"===e.type||"image_list"===e.type||"media"===e.type));if(0===a.length)return void h("Current workflow has no image inputs.");let r;if(t.targetParam){const e=n.config.filter(e=>e.exposed&&("image"===e.type||"image_list"===e.type||"media"===e.type||"video"===e.type||"video_list"===e.type));r=e.find(e=>e.name===t.targetParam)}if(!r){const e=a.find(e=>!Bt.current[e.name]);r=e||a[0]}const i=`__fileref::${t.filePath}`;fetch(`/api/read-image?path=${encodeURIComponent(t.filePath)}`).then(e=>e.json()).then(e=>{e.success&&e.dataUrl?(Vt.current(r.name,e.dataUrl),p(`Set "${r.display_name||r.name}" from Gallery image`)):(Vt.current(r.name,i),h(`Set "${r.display_name||r.name}" but could not load preview`))}).catch(e=>{console.error("[handleGallerySendReference] Failed to fetch image:",e),Vt.current(r.name,i),h(`Set "${r.display_name||r.name}" but could not load preview`)})}function t(e){const t=e.detail;if(!(null==t?void 0:t.filePath))return;const n=Kk.getProject().orchestratorUrl||Gk();(async()=>{var e,a,r;try{const s=await fetch(`${n}/api/png-metadata?path=${encodeURIComponent(t.filePath)}`),o=await s.json();if(!o.success||!o.prompt)return void u("Could not read workflow metadata from this image.");const l=o.prompt;let c;const d=Object.keys(l).filter(e=>"meta"!==e&&"version"!==e);let m=0;for(const t of se){const n=Object.keys(t.workflow).filter(e=>"meta"!==e&&"version"!==e);let r=0;for(const s of d)if(t.workflow[s]){const n=null==(e=l[s])?void 0:e.class_type,i=null==(a=t.workflow[s])?void 0:a.class_type;n&&n===i&&r++}const i=d.length>0?r/Math.max(d.length,n.length):0;i>m&&i>.5&&(m=i,c=t)}if(!c){let e=null;for(const t of Object.values(l))if("SaveImage"===t.class_type&&(null==(r=t.inputs)?void 0:r.filename_prefix)){e=t.inputs.filename_prefix;break}if(e&&(c=se.find(t=>t.id===e),!c)){const t=e=>e.toLowerCase().replace(/[_\s-]/g,""),n=t(e);c=se.find(e=>t(e.id).includes(n)||n.includes(t(e.id))||t(e.name||"").includes(n)||n.includes(t(e.name||"")))}}if(!c)return void h("Could not find a matching workflow for this image.");const f={},g={};for(const e of c.parsed.parameters){const t=l[e.node_id];if((null==t?void 0:t.inputs)&&e.input_name in t.inputs){const n=t.inputs[e.input_name];Array.isArray(n)||(f[e.name]=n)}}for(const e of c.parsed.image_inputs){const t=l[e.node_id];if((null==t?void 0:t.inputs)&&e.input_name in t.inputs){const n=t.inputs[e.input_name];n&&"string"==typeof n&&(g[e.name]=n)}}if(0===Object.keys(f).length)for(const e of Object.values(l)){if(!e.inputs)continue;const t=e.class_type||"";if((t.includes("KSampler")||t.includes("Sampler"))&&(void 0!==e.inputs.seed&&(f.seed=e.inputs.seed),void 0!==e.inputs.steps&&(f.steps=e.inputs.steps),void 0!==e.inputs.cfg&&(f.cfg=e.inputs.cfg),e.inputs.sampler_name&&(f.sampler_name=e.inputs.sampler_name),e.inputs.scheduler&&(f.scheduler=e.inputs.scheduler),void 0!==e.inputs.denoise&&(f.denoise=e.inputs.denoise)),"CLIPTextEncode"===t&&e.inputs.text){const t=e.inputs.text;"string"==typeof t&&t.length>20&&!f.positive_prompt&&(f.positive_prompt=t)}}c.id!==ce&&(re.current=!0,de(c.id)),Object.keys(f).length>0&&Ee(e=>{const t={...e,...f};return Bt.current=t,t});const v=Object.keys(g).length;if(v>0){const e=Rt.filter(e=>"online"===e.status);if(e.length>0){const t=e[0].url.replace(/\/$/,"");for(const[e,n]of Object.entries(g))try{const a=`${t}/view?filename=${encodeURIComponent(n)}&type=input`,r=await fetch(a);if(r.ok){const t=await r.blob(),n=await new Promise(e=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.readAsDataURL(t)});f[e]=n}}catch(i){console.warn(`Could not fetch image ${n}:`,i)}Object.keys(g).some(e=>f[e])&&Ee(e=>{const t={...e,...f};return Bt.current=t,t})}}const y=`${Object.keys(f).length} parameters`,x=v>0?`, ${v} images`:"";p(`Restored workflow "${c.name||c.id}", ${y}${x}`)}catch(i){console.error("Failed to restore workflow from Gallery:",i),u("Failed to restore workflow from image metadata.")}})()}function n(){const e=se.find(e=>e.id===ce);if(!e)return void window.dispatchEvent(new CustomEvent("gallery:image-params-response",{detail:{params:[],error:"No workflow selected"}}));const t=e.config.filter(e=>e.exposed&&("image"===e.type||"image_list"===e.type||"media"===e.type||"video"===e.type||"video_list"===e.type)),n=Bt.current,a=t.map(e=>({name:e.name,display_name:e.display_name||e.name,type:e.type,filled:!(!n[e.name]||""===n[e.name])}));window.dispatchEvent(new CustomEvent("gallery:image-params-response",{detail:{params:a}}))}function a(e){const t=e.detail;if(!(null==t?void 0:t.renameMap)||0===Object.keys(t.renameMap).length)return;const n=t.renameMap,a=Kk.getProject().orchestratorUrl||Gk();S(e=>{let t=!1;const r=e.map(e=>{if(!e.imageHistory||0===e.imageHistory.length)return e;let r=!1;const i=e.imageHistory.map(e=>{var t;const i=null==(t=e.metadata)?void 0:t.savedPath;if(!i||!n[i])return e;r=!0;const s=n[i],o=`${a}/api/serve-image?path=${encodeURIComponent(s)}`;return{...e,url:o,metadata:{...e.metadata,savedPath:s}}});if(!r)return e;t=!0;let s=e.image;return e.historyIndex>=0&&e.historyIndex<i.length?s=i[e.historyIndex].url:i.length>0&&(s=i[i.length-1].url),{...e,imageHistory:i,image:s}});return t?r:e})}return window.addEventListener("gallery:send-reference-image",e),window.addEventListener("gallery:restore-workflow-from-metadata",t),window.addEventListener("gallery:files-renamed",a),window.addEventListener("gallery:request-image-params",n),()=>{window.removeEventListener("gallery:send-reference-image",e),window.removeEventListener("gallery:restore-workflow-from-metadata",t),window.removeEventListener("gallery:files-renamed",a),window.removeEventListener("gallery:request-image-params",n)}},[se,ce,p,h,u,Rt]),Tt.useEffect(()=>{var e;if(!Ue||!Re)return void ot(null);const t=w.find(e=>e.id===Ue),n=null==t?void 0:t.imageHistory[(null==t?void 0:t.historyIndex)??0];if(!n)return void ot(null);if((null==(e=n.metadata)?void 0:e.promptSummary)&&n.metadata.promptSummary.length>0)return void ot(null);if(!n.url.includes("/api/serve-image"))return void ot(null);const a=new URLSearchParams(n.url.split("?")[1]).get("path");if(!a)return void ot(null);(async()=>{ct(!0);try{const e=Kk.getProject().orchestratorUrl||Gk(),t=await fetch(`${e}/api/png-metadata?path=${encodeURIComponent(a)}`);if(t.ok){const e=await t.json();e.success?ot({prompt:e.prompt,workflow:e.workflow,parameters:e.parameters}):(console.warn("[PNG Metadata] Failed to extract:",e.error),ot(null))}else console.warn("[PNG Metadata] Request failed:",t.status),ot(null)}catch(e){console.error("[PNG Metadata] Error:",e),ot(null)}finally{ct(!1)}})()},[Ue,Re,w]),Tt.useEffect(()=>{if(!Le||!Re)return at(void 0),void it(void 0);(async()=>{try{const e=await fetch(Le);if(e.ok){const t=await e.blob();it(t.size);const n=URL.createObjectURL(t),a=new Image;a.onload=()=>{at({width:a.naturalWidth,height:a.naturalHeight}),URL.revokeObjectURL(n)},a.onerror=()=>{at(void 0),URL.revokeObjectURL(n)},a.src=n}else it(void 0),at(void 0)}catch{it(void 0),at(void 0)}})()},[Le,Re]);const Vn=Tt.useCallback(()=>{Ie(!1),ze(1),He({x:0,y:0}),Ve(!1),Ge(null),tt(!1),ut("actual")},[]),Wn=Tt.useCallback(e=>{if(!Ue)return;const t=w.find(e=>e.id===Ue);if(!t||t.imageHistory.length<=1)return;const n=Math.max(0,Math.min(t.imageHistory.length-1,t.historyIndex+e));if(n===t.historyIndex)return;const a=t.imageHistory[n];a&&(S(e=>e.map(e=>e.id===Ue?{...e,historyIndex:n,image:a.url}:e)),De(a.url),ut("actual"),He({x:0,y:0}))},[Ue,w]),Gn=Tt.useCallback(()=>{ut("custom"),ze(e=>pR(1.25*e))},[]),Xn=Tt.useCallback(()=>{ut("custom"),ze(e=>pR(e/1.25))},[]),qn=Tt.useCallback(()=>{if(ut("fit"),He({x:0,y:0}),nt&&ht.current){const e=ht.current,t=function(e,t,n,a,r=20){const i=(n-2*r)/e,s=(a-2*r)/t;return Math.min(i,s,1)}(nt.width,nt.height,e.clientWidth,e.clientHeight,Ze?40:20);ze(t)}else ze(.8)},[nt,Ze]),Kn=Tt.useCallback(()=>{ut("actual"),ze(1),He({x:0,y:0})},[]),Yn=Tt.useCallback(()=>{if(!Ue)return;const e=w.find(e=>e.id===Ue);!e||e.imageHistory.length<=1||Ve(t=>{var n;const a=!t;return a&&e.historyIndex>0&&Ge((null==(n=e.imageHistory[e.historyIndex-1])?void 0:n.url)||null),a})},[Ue,w]);Tt.useEffect(()=>{if(!Ye.visible)return;const e=()=>Je(e=>({...e,visible:!1})),t=e=>{"Escape"===e.key&&Je(e=>({...e,visible:!1}))};return document.addEventListener("click",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("click",e),document.removeEventListener("keydown",t)}},[Ye.visible]);const Jn=Tt.useCallback(async e=>{var t;const n=w.find(t=>t.id===e);if(!n)return;const a=n.imageHistory[n.historyIndex],r=null==(t=null==a?void 0:a.metadata)?void 0:t.savedPath;if(r)try{const e="",t=await fetch(`${e}/api/open-explorer`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:r})}),n=await t.json();n.success||u(n.message||"Failed to open explorer")}catch(i){u(`Failed to open explorer: ${i}`)}else u("Image has no saved path. Save the image first.")},[w,u]),Zn=Tt.useCallback(e=>{oe(t=>t.map(t=>t.id===e.id?e:t)),nn("info",`Updated categories for workflow: ${e.name}`)},[nn]),Qn=Tt.useCallback(()=>{const e={workflows:se,exportedAt:(new Date).toISOString(),version:"1.0"},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download=`workflows_export_${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(n),nn("info",`Exported ${se.length} workflows`)},[se,nn]),ea=Tt.useCallback(async e=>{var t;const n=null==(t=e.target.files)?void 0:t[0];if(n){try{const e=await n.text(),t=JSON.parse(e);if(t.workflows&&Array.isArray(t.workflows)){const e=t.workflows.map((e,t)=>({...e,id:`imported_${Date.now()}_${t}`,name:e.name||`Imported Workflow ${t+1}`}));oe(t=>[...t,...e]),nn("info",`Successfully imported ${e.length} workflows from export file`),p(`Imported ${e.length} workflows`)}else{if(!t.nodes&&!Object.values(t).some(e=>e&&e.class_type))throw new Error("Invalid file format: not a bulk export or ComfyUI workflow");{const e=t;"nodes"in e&&Array.isArray(e.nodes)&&(h('This workflow is in Graph format. For best results, export from ComfyUI using "Save (API Format)" or "Export API". Graph format may have widget mapping issues.'),nn("warning","Imported graph-format workflow - API format recommended"));const a=FC().parseWorkflow(e),r={id:`workflow_${Date.now()}`,name:n.name.replace(".json",""),description:"Imported from ComfyUI",category:g,subCategory:y,workflow:e,parsed:a,config:[]};r.config=a.parameters.map((e,t)=>({name:e.name,display_name:e.display_name,node_id:e.node_id,input_name:e.input_name,type:e.type,default:e.default,description:e.description,constraints:e.constraints,order:t,exposed:!0,category:"parameter",auto_detected:!0,user_modified:!1})),a.image_inputs.forEach((e,t)=>{const n="video"===e.type?"video":"image";r.config.push({name:e.name,display_name:e.display_name,node_id:e.node_id,input_name:e.input_name,type:n,default:"",description:e.description,order:a.parameters.length+t,exposed:!0,category:"image_input",auto_detected:!0,user_modified:!1})}),oe(e=>[...e,r]),de(r.id),me(r),he(!0),nn("info",`Imported single workflow: ${r.name}`),p(`Successfully imported workflow: ${r.name}`)}}}catch(a){console.error("Failed to import:",a),u("Failed to import: "+a.message)}e.target.value=""}},[se,oe,nn,p,u,g,y,de,me,he]),ta=Tt.useCallback(()=>{S(e=>{const t=Math.max(...e.map(e=>e.id),0)+1,n=e.length,a=Math.floor(n/3),r=n%3;return[...e,{id:t,name:`Panel_${String(t).padStart(2,"0")}`,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,status:"empty",progress:0,notes:"",prompt:"",seed:-1,x:320*r,y:320*a,width:300,height:300}]})},[]),na=Tt.useCallback(e=>{if(1===e.button||0===e.button&&e.altKey)j(!0),R({x:e.clientX-T.x,y:e.clientY-T.y}),e.preventDefault();else if(0===e.button&&!e.ctrlKey&&!e.metaKey){const t=e.target;if(t.classList.contains("storyboard-canvas")||t.classList.contains("canvas-transform-container")){$(!0);const t=e.currentTarget.getBoundingClientRect(),n=(e.clientX-t.left-T.x)/E,a=(e.clientY-t.top-T.y)/E;W({x:n,y:a}),X({x:n,y:a}),e.preventDefault()}}},[T,E]),aa=Tt.useCallback(e=>{if(H){const t=e.currentTarget.getBoundingClientRect(),n=(e.clientX-t.left-T.x)/E,a=(e.clientY-t.top-T.y)/E;X({x:n,y:a})}},[H,T,E]),ra=Tt.useCallback(()=>{if(H){const e=Math.min(V.x,G.x),t=Math.max(V.x,G.x),n=Math.min(V.y,G.y),a=Math.max(V.y,G.y);if(t-e<5&&a-n<5)return S(e=>e.map(e=>({...e,selected:!1}))),void $(!1);S(r=>r.map(r=>{const i=r.x+r.width,s=r.y+r.height,o=!(i<e||r.x>t||s<n||r.y>a);return{...r,selected:o}})),$(!1)}},[H,V,G]),ia=Tt.useCallback(e=>{P&&N({x:e.clientX-A.x,y:e.clientY-A.y})},[P,A]),sa=Tt.useCallback(()=>{j(!1)},[]),oa=Tt.useCallback(e=>{e.preventDefault();const t=ae.current;if(!t)return;const n=t.getBoundingClientRect(),a=e.clientX-n.left,r=e.clientY-n.top,i=(a-T.x)/E,s=(r-T.y)/E,o=e.deltaY>0?.9:1.1,l=Math.max(.1,Math.min(5,E*o)),c=a-i*l,d=r-s*l;k(l),N({x:c,y:d})},[E,T]);Tt.useEffect(()=>{const e=ae.current;if(e)return e.addEventListener("wheel",oa,{passive:!1}),()=>{e.removeEventListener("wheel",oa)}},[oa]);const la=Tt.useCallback(async(e,t)=>{const n=w.find(t=>t.id===e),a=Bt.current,r=ce||(null==n?void 0:n.workflowId),i=se.find(e=>e.id===r);if(n&&i)if(0!==t.length)try{nn("comfyui",`Starting parallel generation on ${t.length} nodes for panel ${e}...`);const d=a,h=FC(),m={...d},f={};console.log("[Parallel] Processing parameter values:",Object.keys(d));for(const[e,n]of Object.entries(d))if("__BYPASSED__"!==n){if("string"==typeof n&&n.includes("/view?"))try{const a=new URL(n),r=a.searchParams.get("filename"),i=a.searchParams.get("subfolder")||"",o=a.searchParams.get("type")||"output";if(r){if("output"===o){console.log(`[Parallel] Image from output folder: ${r}, re-uploading to ALL nodes' input folders`),nn("info",`Re-uploading ${r} from output to input folder on all ${t.length} nodes`);const a=Rt.filter(e=>t.includes(e.id)&&"online"===e.status);if(0===a.length){const e="Cannot re-upload image: no online render nodes";return nn("error",e),void u(e)}try{const t=await fetch(n);if(t.ok){const n=await t.blob(),i=`storyboard_${Date.now()}_${r}`,s=new File([n],i,{type:n.type||"image/png"}),o=a.map(async e=>{const t=new FormData;t.append("image",s),t.append("overwrite","true");const n=await fetch(`${e.url}/upload/image`,{method:"POST",body:t});if(!n.ok)throw new Error(`Upload to ${e.id} failed with status ${n.status}`);return await n.json()}),l=(await Promise.all(o))[0].name;console.log(`[Parallel] Re-uploaded to ${a.length} nodes as ${l}`),nn("info",`Re-uploaded to ${a.length} nodes as ${l}`),m[e]=l,f[e]=l;continue}nn("warning","Image download failed, using original path")}catch(s){console.warn("[Parallel] Re-upload failed:",s),nn("warning",`Re-upload failed: ${s}`)}const o=i?`${i}/${r}`:r;m[e]=o,f[e]=o;continue}{const t=i?`${i}/${r}`:r;nn("info",`Using image path: ${t}`),m[e]=t,f[e]=t;continue}}}catch(o){console.warn("[Parallel] Failed to process ComfyUI URL:",n,o)}if("string"==typeof n&&(n.startsWith("data:image")||n.startsWith("data:video"))){const a=n.startsWith("data:video");console.log(`[Parallel] ${a?"Video":"Image"} parameter ${e} has data URL, uploading to ALL nodes`),nn("info",`Uploading data URL ${a?"video":"image"} for ${e} to all ${t.length} nodes`);const r=Rt.filter(e=>t.includes(e.id)&&"online"===e.status);if(0===r.length){const e="Cannot upload data URL media: no online render nodes";return nn("error",e),void u(e)}try{const t=n.match(/^data:((?:image|video)\/[^;]+);base64,(.+)$/);if(!t)throw new Error("Invalid data URL format");const a=t[1],i=t[2],s=atob(i),o=new Array(s.length);for(let e=0;e<s.length;e++)o[e]=s.charCodeAt(e);const l=new Uint8Array(o),c=new Blob([l],{type:a}),d=a.split("/")[1]||"png",u=`parallel_data_${Date.now()}_${e}.${d}`,h=new File([c],u,{type:a}),p=r.map(async e=>{const t=new FormData;t.append("image",h),t.append("overwrite","true");const n=await fetch(`${e.url}/upload/image`,{method:"POST",body:t});if(!n.ok)throw new Error(`Upload to ${e.id} failed with status ${n.status}`);return await n.json()}),g=(await Promise.all(p))[0].name;console.log(`[Parallel] Uploaded data URL to ${r.length} nodes as ${g}`),nn("info",`Uploaded data URL to ${r.length} nodes as ${g}`),m[e]=g,f[e]=g;continue}catch(s){const t=`Failed to upload data URL for ${e}: ${s}`;return console.error("[Parallel] Upload error:",s),nn("error",t),void u(t)}}}else nn("info",`Image input ${e} is bypassed`),f[e]="__BYPASSED__",delete m[e];if(je&&Ne.trim())for(const e of Object.keys(m))(e.toLowerCase().includes("prompt")||"text"===e||"positive"===e)&&(m[e]=Ne);const g=h.parseWorkflow(i.workflow),v={},y={},x=new Set(g.loras.map(e=>e.name));for(const[e,t]of Object.entries(m))x.has(e)?"object"==typeof t&&null!==t?v[e]={strength:t.strength??1,bypassed:t.bypassed??!1,lora_name:t.lora_name,enabled:!t.bypassed}:"number"==typeof t&&(v[e]={strength:t,enabled:!0}):y[e]=t;const b=h.buildWorkflow(i.workflow,y,f,v,i.config);console.log("[Parallel] Base workflow built:",JSON.stringify(b,null,2)),nn("info",`Base workflow nodes: ${Object.keys(b).length}`);const _=xR(b);_.samplerNodeIds.length>1&&nn("info",`Multi-sampler workflow: ${_.samplerNodeIds.length} sampler phases detected`);const w=(e,t)=>{var n,a;for(const r of Object.keys(e)){const i=e[r];((null==(n=i.class_type)?void 0:n.includes("Sampler"))||(null==(a=i.class_type)?void 0:a.includes("KSampler")))&&(i.inputs&&"seed"in i.inputs&&(i.inputs.seed=t),i.inputs&&"noise_seed"in i.inputs&&(i.inputs.noise_seed=t)),"RandomNoise"===i.class_type&&i.inputs&&"noise_seed"in i.inputs&&(i.inputs.noise_seed=t)}},M=[],C=t.map(e=>{const t=Rt.find(t=>t.id===e);return{nodeId:e,nodeName:(null==t?void 0:t.name)||e,promptId:"",seed:0,progress:0,status:"pending"}}),E=(null==n?void 0:n.name)||`Panel_${String(e).padStart(2,"0")}`,k=(null==n?void 0:n.imageHistory)||[],T=await Kk.getNextVersion(E,k);Ot.current.set(e,T),S(t=>t.map(t=>t.id===e?{...t,status:"generating",progress:0,parameterValues:{...d},workflowId:r||void 0,parallelJobs:C}:t)),ie.current.set(e,Date.now()),Lt.current.delete(String(e)),Dt.current.clear();for(let n=0;n<t.length;n++){const a=t[n],r=Rt.find(e=>e.id===a);if(!r||"online"!==r.status){nn("warning",`Skipping offline node: ${(null==r?void 0:r.name)||a}`),S(t=>t.map(t=>t.id===e&&t.parallelJobs?{...t,parallelJobs:t.parallelJobs.map(e=>e.nodeId===a?{...e,status:"error"}:e)}:t));continue}const i=JSON.parse(JSON.stringify(b)),s=Math.floor(2147483647*Math.random());w(i,s),DC(i,r.os||"unknown"),console.log(`[Parallel] Submitting to node ${r.name} (OS: ${r.os}) with seed ${s}`),nn("comfyui",`Submitting variation ${n+1}/${t.length} to ${r.name} (seed: ${s})`);try{const t=`storyboard-parallel-${e}-${n}-${Date.now()}`,c=XC(r.url,t);try{await c.connect()}catch(l){nn("warning",`WebSocket to ${r.name} failed, will use polling`)}const d=await fetch(`${r.url}/prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:i,client_id:t})});if(!d.ok){let e=`HTTP ${d.status}`;try{const t=await d.json();console.error("ComfyUI error response:",t),t.error&&(e="string"==typeof t.error?t.error:JSON.stringify(t.error))}catch(o){}throw new Error(e)}const u=await d.json();nn("comfyui",`Queued on ${r.name}: ${u.prompt_id}`),S(t=>t.map(t=>t.id===e&&t.parallelJobs?{...t,parallelJobs:t.parallelJobs.map(e=>e.nodeId===a?{...e,promptId:u.prompt_id,seed:s,status:"running"}:e)}:t)),M.push({nodeId:a,nodeName:r.name,promptId:u.prompt_id,seed:s}),c.connected?pa(u.prompt_id,e,a,r.url,c,t,_):ma(u.prompt_id,e,a,r.url)}catch(c){const t=`Failed to submit to ${r.name}: ${c}`;nn("error",t),u(t),S(t=>t.map(t=>t.id===e&&t.parallelJobs?{...t,parallelJobs:t.parallelJobs.map(e=>e.nodeId===a?{...e,status:"error"}:e)}:t))}}if(0===M.length)return u("Failed to submit to any nodes"),void S(t=>t.map(t=>t.id===e?{...t,status:"error",progress:0}:t));p(`Started parallel generation on ${M.length} node(s)`)}catch(c){const t=`Parallel generation failed: ${c.message||String(c)}`;nn("error",t),u(t),S(t=>t.map(t=>t.id===e?{...t,status:"error",progress:0}:t))}else u("No render nodes selected for parallel generation");else u("Panel or workflow not found")},[w,se,ce,Ce,je,Ne,Rt,nn,u,p,M]),ca=Tt.useCallback(async e=>{var t,n;if(an.length>1)return void(await la(e,an));const a=w.find(t=>t.id===e);let r="",i="",s="unknown";if(1===an.length){const e=Rt.find(e=>e.id===an[0]);e&&"online"===e.status&&(r=e.url,i=e.name,s=e.os||"unknown")}if(!r&&(null==a?void 0:a.nodeId)){const e=Rt.find(e=>e.id===a.nodeId);e&&"online"===e.status&&(r=e.url,i=e.name,s=e.os||"unknown")}if(!r){const e=Rt.filter(e=>"online"===e.status);if(e.length>0){const t=e[0];r=t.url,i=t.name,s=t.os||"unknown"}}if(!r&&pt&&"connected"===ft&&(r=pt,i="Direct Connection"),!r){const e="No render nodes available. Add nodes in Manage Nodes or connect via URL.";return nn("error",e),void u(e)}try{const e=await fetch(`${r}/system_stats`,{method:"GET",signal:AbortSignal.timeout(5e3)});if(!e.ok)throw new Error(`Node ${i} is not responding`);if("unknown"===s)try{s=function(e){var t;const n=((null==(t=null==e?void 0:e.system)?void 0:t.os)||"").toLowerCase();return n.includes("win")?"windows":n.includes("darwin")||n.includes("mac")?"darwin":n.includes("linux")?"linux":"unknown"}(await e.json())}catch{}}catch(b){const e=`Cannot connect to ${i}: ${b}`;return nn("error",e),void u(e)}const o=Bt.current,l=ce||(null==a?void 0:a.workflowId),c=se.find(e=>e.id===l);if(!c)return void nn("warning","No workflow selected");const d=o;S(t=>t.map(t=>t.id===e?{...t,status:"generating",progress:0,parameterValues:{...d},workflowId:l||void 0,parallelJobs:void 0}:t)),ie.current.set(e,Date.now()),nn("comfyui",`Starting generation for panel ${e} on ${i}...`),console.log("[Generation] ==== GENERATION START ===="),console.log("[Generation] Panel ID:",e),console.log("[Generation] Using parameters from UI ref (always)"),console.log("[Generation] paramsToUse:",JSON.stringify(d,null,2)),console.log("[Generation] Seed:",d.seed),console.log("[Generation] Prompt preview:",(null==(t=d.positive_prompt)?void 0:t.substring(0,50))||(null==(n=d.prompt)?void 0:n.substring(0,50)));const h={...d},p={};console.log("[Generation] Processing parameter values for panel:",e,Object.keys(d));for(const[w,E]of Object.entries(d))if("__BYPASSED__"!==E){if("string"==typeof E&&E.includes("/view?"))try{const e=new URL(E),t=e.searchParams.get("filename"),n=e.searchParams.get("subfolder")||"",a=e.searchParams.get("type")||"output";if(t){if("output"===a){console.log(`[Generation] Downloading ${t} from output to re-upload to input`),nn("info",`Downloading ${t} from output folder for re-upload`);const e=await fetch(E);if(e.ok){const n=await e.blob(),a=`storyboard_${Date.now()}_${t}`,i=new File([n],a,{type:n.type||"image/png"}),s=new FormData;s.append("image",i),s.append("overwrite","true");const o=await fetch(`${r}/upload/image`,{method:"POST",body:s});if(o.ok){const e=await o.json();console.log(`[Generation] Re-uploaded ${t} as ${e.name}`),nn("info",`Re-uploaded ${t} as ${e.name}`),h[w]=e.name,p[w]=e.name;continue}console.error("[Generation] Failed to upload image:",await o.text()),nn("error",`Failed to upload image ${t}: HTTP ${o.status}`)}else console.error("[Generation] Failed to download image from view URL"),nn("error",`Failed to download image ${t} from output folder`);const a=n?`${n}/${t}`:t;console.log(`[Generation] Falling back to original path: ${a}`),nn("warning",`Re-upload failed, falling back to: ${a}`),h[w]=a,p[w]=a;continue}{const e=n?`${n}/${t}`:t;nn("info",`Using image path from ComfyUI URL: ${e}`),console.log(`[Generation] ${w} using image path: ${e}`),h[w]=e,p[w]=e;continue}}}catch(_){console.warn("[Generation] Failed to process ComfyUI URL:",E,_)}if("string"==typeof E&&(E.startsWith("data:image")||E.startsWith("data:video"))){const t=E.startsWith("data:video");console.log(`[Generation] ${w} is a data:${t?"video":"image"} URL, uploading...`);try{nn("info",`Uploading ${t?"video":"image"} for parameter: ${w}`);const e=await fetch(E),n=await e.blob(),a=n.type.split("/")[1]||(t?"mp4":"png"),i=`storyboard_${Date.now()}_${w}.${a}`,s=new File([n],i,{type:n.type}),o=new FormData;o.append("image",s),o.append("overwrite","true");const l=await fetch(`${r}/upload/image`,{method:"POST",body:o});if(!l.ok)throw new Error(`Upload failed: HTTP ${l.status}`);const c=(await l.json()).name;nn("info",`${t?"Video":"Image"} uploaded as: ${c}`),console.log(`[Generation] ${w} uploaded as: ${c}`),h[w]=c,p[w]=c}catch(M){const n=`Failed to upload ${t?"video":"image"} ${w}: ${M}`;return nn("error",n),u(n),void S(t=>t.map(t=>t.id===e?{...t,status:"error",progress:0}:t))}}else console.log(`[Generation] ${w} is not media (type: ${typeof E}, startsWith data: ${"string"==typeof E?E.startsWith("data:"):"N/A"})`)}else nn("info",`Image input ${w} is bypassed, will skip in workflow`),console.log(`[Generation] ${w} is BYPASSED`),p[w]="__BYPASSED__",delete h[w];if(console.log("[Generation] Final imageInputs:",p),console.log("[Generation] Final processedParams keys:",Object.keys(h)),je&&Ne.trim())for(const u of Object.keys(h))(u.toLowerCase().includes("prompt")||"text"===u||"positive"===u)&&(h[u]=Ne,nn("info",`Applied global prompt override to: ${u}`));const m=FC(),f=m.parseWorkflow(c.workflow),g={},v={},y=new Set(f.loras.map(e=>e.name));for(const[u,w]of Object.entries(h))y.has(u)?"object"==typeof w&&null!==w?g[u]={strength:w.strength??1,bypassed:w.bypassed??!1,lora_name:w.lora_name,enabled:!w.bypassed}:"number"==typeof w&&(g[u]={strength:w,enabled:!0}):v[u]=w;console.log("Parameters being applied:",v),console.log("LoRA values being applied:",g),console.log("Parsed workflow parameters:",f.parameters),console.log("Custom param configs:",c.config);const x=m.buildWorkflow(c.workflow,v,p,g,c.config);DC(x,s),console.log("Workflow being sent to ComfyUI:",JSON.stringify(x,null,2)),nn("info",`Workflow nodes: ${Object.keys(x).length}, target OS: ${s}`);try{const t=`storyboard-panel-${e}-${Date.now()}`,n=XC(r,t);try{await n.connect()}catch(C){nn("warning",`WebSocket to ${r} failed, will use polling`)}const a=await fetch(`${r}/prompt`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:x,client_id:t})});if(!a.ok){let e=`HTTP ${a.status}`;try{const t=await a.json();console.error("ComfyUI error response:",t),t.error&&(e="string"==typeof t.error?t.error:JSON.stringify(t.error)),t.node_errors&&(console.error("Node errors:",t.node_errors),e+=` | Node errors: ${JSON.stringify(t.node_errors)}`)}catch(_){}throw new Error(e)}const s=await a.json();nn("comfyui",`Queued prompt: ${s.prompt_id} on ${i}`);const o=xR(x);o.samplerNodeIds.length>1&&nn("info",`Multi-sampler workflow detected: ${o.samplerNodeIds.length} sampler phases`),n.connected?ua(s.prompt_id,e,r,n,t,o):(nn("warning","WebSocket not connected, falling back to polling"),da(s.prompt_id,e,r))}catch(b){const t=`Failed to queue generation: ${b}`;nn("error",t),u(t),S(t=>t.map(t=>t.id===e?{...t,status:"error",progress:0}:t))}},[ft,se,ce,Ce,pt,nn,u,w,Rt,M]),da=Tt.useCallback(async(e,t,n)=>{const a=`${t}-${e}`;Ft.current.forEach(e=>{e.startsWith(`${t}-`)&&Ft.current.delete(e)}),Ft.current.add(a);let r=0;const i=async()=>{var s;if(Ft.current.has(a)){if(r>=600)return nn("error",`Generation timeout for panel ${t}`),S(e=>e.map(e=>e.id===t?{...e,status:"error",progress:0}:e)),void Ft.current.delete(a);r++;try{const o=await fetch(`${n}/history/${e}`);if(o.ok){const r=await o.json();if(r[e]){const i=r[e].outputs,s=[];for(const e in i){const t=Wk(i[e],n);for(const e of t)s.push(e.url)}if(s.length>0){nn("comfyui",`Generation complete for panel ${t} (polling): ${s.length} output(s)`),Ft.current.delete(a);const e=Kk.getProject();if(e.autoSave&&e.path){nn("info",`Auto-saving ${s.length} image(s) to ${e.path}...`);const n=ie.current.get(t),a=n?(Date.now()-n)/1e3:void 0;(async()=>{try{const e=await new Promise(e=>{S(n=>{const a=n.find(e=>e.id===t);return e((null==a?void 0:a.name)||`Panel_${String(t).padStart(2,"0")}`),n})}),n=await Kk.getNextVersion(e,[]);nn("info",`Starting from version ${n}`);for(let r=0;r<s.length;r++){const i=s[r],o=n+r,l=await new Promise(e=>{S(n=>{const a=n.find(e=>e.id===t);return e((null==a?void 0:a.workflowId)||""),n})}),c=await new Promise(e=>{S(n=>{const a=n.find(e=>e.id===t);return e((null==a?void 0:a.parameterValues)||{}),n})}),d=Kk.createHistoryEntry(i,t,o,l,l||"Unknown",{},c,a);nn("info",`Saving v${o} from URL: ${i}`);const u=await Kk.saveToProjectFolder(i,t,o,d.metadata,e);u.success?(nn("info",`Saved: ${u.savedPath}`),S(e=>e.map(e=>{if(e.id!==t)return e;const n=e.imageHistory.map(e=>e.url!==i||e.metadata.savedPath?e:{...e,metadata:{...e.metadata,savedPath:u.savedPath}});return{...e,imageHistory:n}}))):nn("error",`Auto-save failed for v${o}: ${u.error}`)}}catch(e){nn("error",`Auto-save exception: ${e}`)}})()}else e.autoSave&&!e.path?nn("warning","Auto-save enabled but no project folder configured"):e.autoSave||nn("info","Auto-save is disabled. Enable it in Project Settings to save images automatically.");const n=ie.current.get(t),r=n?(Date.now()-n)/1e3:void 0;return ie.current.delete(t),void S(e=>{var n;const a=e.find(e=>e.id===t),i=(null==(n=null==a?void 0:a.imageHistory)?void 0:n.length)||0,o=s.map((e,n)=>Kk.createHistoryEntry(e,t,i+n+1,(null==a?void 0:a.workflowId)||"","Unknown",{},(null==a?void 0:a.parameterValues)||{},r));return e.map(e=>{if(e.id!==t)return e;const n=[...e.imageHistory,...o];return{...e,status:"complete",progress:100,image:s[s.length-1],images:s,currentImageIndex:0,imageHistory:n,historyIndex:n.length-1}})})}if(Object.keys(i).length>0){const e=Object.keys(i).map(e=>{const t=i[e];return`${e}: [${Object.keys(t).join(", ")}]`});nn("warning",`Generation completed but no media found in outputs. Node output keys: ${e.join("; ")}`)}}}const l=await fetch(`${n}/queue`);if(l.ok){const n=await l.json();(null==(s=n.queue_running)?void 0:s.find(t=>t[1]===e))&&S(e=>e.map(e=>e.id===t?{...e,progress:Math.min(r/100*100,90)}:e))}Ft.current.has(a)&&setTimeout(i,1e3)}catch(o){nn("error",`Error polling for result: ${o}`),Ft.current.has(a)&&setTimeout(i,1e3)}}};i()},[nn]),ua=Tt.useCallback((e,t,n,a,r,i)=>{const s=a||It.current;if(!s)return void da(e,t,n);const o=()=>{r&&qC(n,r)};s.trackPrompt(e,t,e=>{const n=e.overallPercent??Math.round(e.value/e.max*100);let a=`Progress: ${n}%`;e.totalPhases&&e.totalPhases>1?a+=` (phase ${e.currentPhase}/${e.totalPhases}: ${e.value}/${e.max})`:a+=` (${e.value}/${e.max})`,e.currentNodeName&&(a+=` [${e.currentNodeName}]`),nn("info",a);const r=e.totalPhases&&e.totalPhases>1?`Phase ${e.currentPhase}/${e.totalPhases}`:void 0;S(a=>a.map(a=>a.id===t?{...a,progress:n,progressPhase:r,progressNodeName:e.currentNodeName,progressNodesExecuted:e.nodesExecuted,progressTotalNodes:e.totalNodes}:a))},async(a,r)=>{var i;nn("comfyui",`Generation complete for panel ${t}`);const s=Kk.getProject(),l=$t.current.find(e=>e.id===t);if((null==l?void 0:l.parallelJobs)&&l.parallelJobs.length>0)nn("comfyui","Skipping single-node save - panel has parallel jobs, handled by parallel tracker");else{try{const a=await fetch(`${n}/history/${e}`);if(a.ok){const r=(await a.json())[e];if(null==r?void 0:r.outputs){const e=(null==(i=null==ya?void 0:ya.parsed.outputs)?void 0:i.filter(e=>e.selected).map(e=>e.node_id))||[],a=0===e.length,l=[],c={};for(const t of Object.keys(r.outputs)){if(!a&&!e.includes(t)){nn("comfyui",`Skipping node ${t} (not selected)`);continue}const i=Wk(r.outputs[t],n);if(i.length>0){const e=i.map(e=>e.url);l.push(...e),c[t]=e,nn("comfyui",`Node ${t} produced ${i.length} output(s)`)}}if(l.length>0){if(nn("comfyui",`Total: ${l.length} images from ${Object.keys(c).length} output node(s)`),s.autoSave&&s.path){nn("info",`Auto-saving ${l.length} image(s) to ${s.path}...`);const e=ie.current.get(t),n=e?(Date.now()-e)/1e3:void 0,a=[...$t.current];(async()=>{try{const e=a.find(e=>e.id===t),r=(null==e?void 0:e.imageHistory)||[],i=(null==e?void 0:e.name)||`Panel_${String(t).padStart(2,"0")}`,s=await Kk.getNextVersion(i,r);nn("info",`Starting from version ${s}`);for(let a=0;a<l.length;a++){const e=l[a],r=s+a,o=Kk.createHistoryEntry(e,t,r,ce||"",(null==ya?void 0:ya.name)||"Unknown",(null==ya?void 0:ya.workflow)||{},Ce,n);nn("info",`Saving v${r} from URL: ${e}`);const c=await Kk.saveToProjectFolder(e,t,r,o.metadata,i);c.success?(nn("info",`Saved: ${c.savedPath}`),S(n=>n.map(n=>{if(n.id!==t)return n;const a=n.imageHistory.map(t=>t.url!==e||t.metadata.savedPath?t:{...t,metadata:{...t.metadata,savedPath:c.savedPath}});return{...n,imageHistory:a}}))):nn("error",`Auto-save failed for v${r}: ${c.error}`)}}catch(e){nn("error",`Auto-save exception: ${e}`)}})()}else s.autoSave&&!s.path?nn("warning","Auto-save enabled but no project folder configured"):s.autoSave||nn("info","Auto-save is disabled. Enable it in Project Settings to save images automatically.");const e=ie.current.get(t),n=e?(Date.now()-e)/1e3:void 0;return ie.current.delete(t),console.log("[Generation] Panel",t,"took",null==n?void 0:n.toFixed(1),"seconds"),S(e=>{var a;const r=e.find(e=>e.id===t),i=(null==(a=null==r?void 0:r.imageHistory)?void 0:a.length)||0,s=l.map((e,a)=>Kk.createHistoryEntry(e,t,i+a+1,(null==r?void 0:r.workflowId)||ce||"",(null==ya?void 0:ya.name)||"Unknown",(null==ya?void 0:ya.workflow)||{},(null==r?void 0:r.parameterValues)||Ce,n));return e.map(e=>{if(e.id!==t)return e;const n=[...e.imageHistory,...s];return{...e,status:"complete",progress:100,image:l[l.length-1],images:l,currentImageIndex:0,imageHistory:n,historyIndex:n.length-1}})}),void o()}}}}catch(c){nn("error",`Error fetching result: ${c}`)}S(e=>e.map(e=>e.id===t?{...e,status:"error",progress:0}:e)),o()}},(e,n)=>{const a=`Generation failed: ${n}`;nn("error",a),u(a),S(e=>e.map(e=>e.id===t?{...e,status:"error",progress:0}:e)),o()},i)},[nn,u,da,w]),ha=Tt.useCallback(async(e,t)=>{const n=$t.current.find(t=>t.id===e);if(!n||!t.resultUrl)return;const a=`${e}-${t.nodeId}-${t.seed}`;if(Dt.current.has(a))console.log(`[Parallel] Job ${a} already saved, skipping duplicate`);else{Dt.current.add(a),console.log(`[Parallel] Saving individual result from ${t.nodeName}`),nn("info",`Saving result from ${t.nodeName}...`);try{const a=se.find(e=>e.id===(n.workflowId||ce)),r=ie.current.get(e),i=r?(Date.now()-r)/1e3:void 0,s={...n.parameterValues||Ce,seed:t.seed},o=(null==n?void 0:n.name)||`Panel_${String(e).padStart(2,"0")}`,l=Ot.current.get(e)||1;Ot.current.set(e,l+1);const c=Kk.createHistoryEntry(t.resultUrl,e,l,n.workflowId||ce||"",(null==a?void 0:a.name)||"Unknown",(null==a?void 0:a.workflow)||{},s,i);c.metadata.nodeName=t.nodeName,S(n=>n.map(n=>{var a;if(n.id!==e)return n;const r=[...n.imageHistory||[],c],i=(null==(a=n.parallelJobs)?void 0:a.map(e=>e.nodeId===t.nodeId?{...e,status:"complete",progress:100}:e))||[],s=i.every(e=>"complete"===e.status||"error"===e.status||"cancelled"===e.status),o=i.some(e=>"error"===e.status);return{...n,image:c.url,imageHistory:r,historyIndex:r.length-1,parallelJobs:i,status:s?o?"error":"complete":"generating"}})),nn("info",` Result from ${t.nodeName} saved to history (v${l})`);const d=Kk.getProject();if(d.autoSave&&d.path){nn("info",`Auto-saving ${t.nodeName} result to folder...`);const n=await Kk.saveToProjectFolder(t.resultUrl,e,l,c.metadata,o);n.success?(nn("info",` Saved: ${n.savedPath}`),S(t=>t.map(t=>{if(t.id!==e)return t;const a=t.imageHistory.map(e=>e.id===c.id?{...e,metadata:{...e.metadata,savedPath:n.savedPath}}:e);return{...t,imageHistory:a}}))):nn("error",` Save failed for ${t.nodeName}: ${n.error}`)}else d.autoSave&&!d.path&&nn("warning","Auto-save enabled but no project folder configured")}catch(r){console.error(`[Parallel] Failed to save result from ${t.nodeName}:`,r),nn("error",`Failed to save result from ${t.nodeName}: ${r}`)}}},[se,ce,Ce,nn,Kk]),pa=Tt.useCallback((e,t,n,a,r,i,s)=>{const o=()=>{i&&qC(a,i)};r.trackPrompt(e,t,e=>{const a=e.overallPercent??Math.round(e.value/e.max*100),r=e.totalPhases&&e.totalPhases>1?`Phase ${e.currentPhase}/${e.totalPhases}`:void 0;S(i=>i.map(i=>{if(i.id!==t||!i.parallelJobs)return i;const s=i.parallelJobs.map(t=>t.nodeId===n?{...t,progress:a,currentNodeName:e.currentNodeName||t.currentNodeName,progressPhase:r,nodesExecuted:e.nodesExecuted,totalNodes:e.totalNodes}:t),o=Math.round(s.reduce((e,t)=>e+t.progress,0)/s.length);return{...i,parallelJobs:s,progress:o}}))},async(r,i)=>{nn("comfyui",`Parallel job complete on node ${n} for panel ${t}`);try{const r=await fetch(`${a}/history/${e}`);if(!r.ok)throw new Error(`HTTP ${r.status}`);const i=(await r.json())[e];if(null==i?void 0:i.outputs){let e;for(const t of Object.keys(i.outputs)){const n=Wk(i.outputs[t],a);if(n.length>0){e=n[0].url;break}}e&&(S(a=>a.map(a=>{if(a.id!==t||!a.parallelJobs)return a;const r=a.parallelJobs.map(t=>t.nodeId===n?{...t,status:"complete",progress:100,resultUrl:e}:t),i=r.find(e=>e.nodeId===n);i&&i.resultUrl&&setTimeout(()=>{ha(t,{nodeId:i.nodeId,nodeName:i.nodeName,resultUrl:i.resultUrl,seed:i.seed})},0);if(r.every(e=>"complete"===e.status||"error"===e.status||"cancelled"===e.status)){const e=r.filter(e=>"complete"===e.status).length;return nn("info",`All parallel jobs finished! ${e} successful, ${r.length-e} failed`),{...a,parallelJobs:r,status:e>0?"complete":"error",batchSaveTriggered:!0}}return{...a,parallelJobs:r}})),o())}}catch(s){nn("error",`Error fetching parallel result: ${s}`),S(e=>e.map(e=>e.id===t&&e.parallelJobs?{...e,parallelJobs:e.parallelJobs.map(e=>e.nodeId===n?{...e,status:"error"}:e)}:e)),o()}},(e,a)=>{nn("error",`Parallel job failed on node ${n}: ${a}`),S(e=>e.map(e=>e.id===t&&e.parallelJobs?{...e,parallelJobs:e.parallelJobs.map(e=>e.nodeId===n?{...e,status:"error"}:e)}:e)),o()},s)},[nn,ha]),ma=Tt.useCallback(async(e,t,n,a)=>{let r=0;const i=async()=>{var s;if(r>=600)return nn("error",`Parallel job timeout on node ${n}`),void S(e=>e.map(e=>e.id===t&&e.parallelJobs?{...e,parallelJobs:e.parallelJobs.map(e=>e.nodeId===n?{...e,status:"error"}:e)}:e));r++;try{const o=await fetch(`${a}/history/${e}`);if(o.ok){const r=await o.json();if(null==(s=r[e])?void 0:s.outputs){let i;for(const t of Object.keys(r[e].outputs)){const n=Wk(r[e].outputs[t],a);if(n.length>0){i=n[0].url;break}}if(i)return void S(e=>e.map(e=>{if(e.id!==t||!e.parallelJobs)return e;const a=e.parallelJobs.map(e=>e.nodeId===n?{...e,status:"complete",progress:100,resultUrl:i}:e),r=a.find(e=>e.nodeId===n);r&&r.resultUrl&&setTimeout(()=>{ha(t,{nodeId:r.nodeId,nodeName:r.nodeName,resultUrl:r.resultUrl,seed:r.seed})},0);if(a.every(e=>"complete"===e.status||"error"===e.status||"cancelled"===e.status)){const t=a.filter(e=>"complete"===e.status).length;return nn("info",`All parallel jobs finished! ${t} successful, ${a.length-t} failed`),{...e,parallelJobs:a,status:t>0?"complete":"error",batchSaveTriggered:!0}}return{...e,parallelJobs:a}}))}}const l=Math.min(r/100*100,90);S(e=>e.map(e=>e.id===t&&e.parallelJobs?{...e,parallelJobs:e.parallelJobs.map(e=>e.nodeId===n?{...e,progress:l}:e)}:e)),setTimeout(i,1e3)}catch(o){nn("error",`Error polling parallel result: ${o}`),setTimeout(i,1e3)}};i()},[nn,ha]),fa=Tt.useCallback((e,t)=>{console.log("[handleParameterChange] Called with:",e,"=","string"==typeof t?t.substring(0,50):t);const n={...Bt.current,[e]:t};Bt.current=n,console.log("[handleParameterChange] Updated ref BEFORE setter, keys:",Object.keys(n)),Ee(n),M&&S(e=>e.map(e=>e.id===M?{...e,parameterValues:n}:e))},[M]);Vt.current=fa;const ga=Tt.useCallback((e,t)=>{Te(n=>({...n,[e]:t}))},[]),va=Tt.useCallback(async e=>{const t=ef();if(!t)throw new Error("No LLM provider configured. Please configure in Settings.");const{provider:n,model:a}=t,r=of().find(e=>e.providerId===n);if(!r)throw new Error("Selected provider not found. Please configure in Settings.");try{const t=await Dm.enhancePrompt({userPrompt:e.trim(),llmProvider:n,llmModel:a,targetModel:"flux",projectType:"live_action",config:{},credentials:{apiKey:r.credentials.apiKey,endpoint:r.credentials.endpoint,oauthToken:r.credentials.oauthToken}});if(t.success)return p("Prompt enhanced successfully"),t.enhanced_prompt;throw new Error(t.error||"Enhancement failed")}catch(i){const e=i instanceof Error?i.message:"Failed to enhance prompt";throw u(e),i}},[p,u]),ya=se.find(e=>e.id===ce),xa=(null==ya?void 0:ya.config.filter(e=>e.exposed))||[],ba=async()=>{const e=await Kk.saveProjectState(w,void 0,Ce,{selectedWorkflowId:ce||void 0,renderNodes:Rt,comfyUrl:pt,cameraAngles:ke});e.success?(p(`Project saved to ${e.savedPath}`),e.savedPath&&Dk(dn.name||"Untitled",e.savedPath)):u(`Failed to save project: ${e.error}`)},_a=()=>{kn("save")},wa=()=>{kn("open")},Sa=async e=>{var t,n;kn(null);const a=Kk.getProject().orchestratorUrl||Gk(),r=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\")),i=r>0?e.substring(0,r):e;fn(!0),vn({progress:0,currentFile:"Loading project data..."});try{const r=await Kk.loadProjectState(e);if(!r.success||!r.state)return u(`Failed to load project: ${r.error}`),void fn(!1);Kk.setProject({path:i,orchestratorUrl:a}),un(Kk.getProject()),Dk((null==(t=r.state.project_settings)?void 0:t.name)||i.split("/").pop()||"Untitled",e);const s=new Set(r.state.deleted_images||[]);pn(s),vn({progress:10,currentFile:"Scanning project panels..."});const o=await Kk.scanProjectPanels();if(!o.success){console.error("[Load] Failed to scan project panels:",o.error),u(`Failed to scan project: ${o.error}`);const e=r.state.panels;if(e.length>0){const t=e.map(e=>({...e,selected:!1,status:e.status||"empty",progress:e.progress||0,imageHistory:e.imageHistory||[],historyIndex:e.historyIndex??-1,image:e.image||null,images:e.images||[],currentImageIndex:e.currentImageIndex||0}));S(t),r.state.parameter_values&&(Ee(r.state.parameter_values),Bt.current=r.state.parameter_values)}return void fn(!1)}vn({progress:50,currentFile:"Building panels..."});const l=Kk.getProject().orchestratorUrl||Gk(),c=[],d=new Set,h=()=>{let e=1;for(;d.has(e);)e++;return d.add(e),e},m=r.state.panels,f=new Set,g=new Set;for(const e of o.panels){const t=m.find(t=>t.name===e.panel_name);t&&t.name&&(f.add(t.name),g.add(e.panel_name))}const v=o.panels.filter(e=>!g.has(e.panel_name)),y=m.filter(e=>!f.has(e.name??"")),x=new Map;for(let e=0;e<v.length&&e<y.length;e++)x.set(v[e].panel_name,y[e]),f.add(y[e].name??""),console.log(`[Load] Paired renamed folder "${v[e].panel_name}" with saved panel "${y[e].name}"`);for(const e of o.panels){const t=e.images.filter(e=>!s.has(e.image_path));if(0===t.length)continue;const a=m.find(t=>t.name===e.panel_name)||x.get(e.panel_name)||void 0;console.log("[Load] Panel folder:",e.panel_name,"Saved panel found:",a?{name:a.name,notes:a.notes,imageRatings:null==a?void 0:a.imageRatings}:"NOT FOUND");const r=(null==a?void 0:a.imageRatings)||{},i=t.map((t,n)=>({id:`${e.panel_name}_v${n+1}`,url:`${l}/api/serve-image?path=${encodeURIComponent(t.image_path)}`,metadata:{timestamp:new Date(1e3*t.modified_time),workflowId:"",workflowName:"Loaded",seed:0,promptSummary:"",parameters:{},workflow:{},sourceUrl:"",savedPath:t.image_path,version:n+1,rating:r[t.image_path]}}));let o;(null==a?void 0:a.id)&&!d.has(a.id)?(o=a.id,d.add(o)):o=h();const u=c.length;c.push({id:o,name:e.panel_name,x:(null==a?void 0:a.x)??gR(u+1),y:(null==a?void 0:a.y)??vR(u+1),width:(null==a?void 0:a.width)??300,height:(null==a?void 0:a.height)??300,notes:(null==a?void 0:a.notes)??"",workflowId:null==a?void 0:a.workflowId,parameterValues:null==a?void 0:a.parameterValues,nodeId:null==a?void 0:a.nodeId,imageHistory:i,historyIndex:i.length>0?i.length-1:-1,image:i.length>0?(null==(n=i[i.length-1])?void 0:n.url)??null:null,images:[],currentImageIndex:0,status:i.length>0?"complete":"empty",progress:i.length>0?100:0,locked:(null==a?void 0:a.locked)??!1,selected:!1})}for(const e of m){if(!e.name)continue;if(f.has(e.name))continue;let t;e.id&&!d.has(e.id)?(t=e.id,d.add(t)):t=h(),c.push({id:t,name:e.name,x:e.x,y:e.y,width:e.width??300,height:e.height??300,notes:e.notes??"",workflowId:e.workflowId,parameterValues:e.parameterValues,nodeId:e.nodeId,imageHistory:[],historyIndex:-1,image:null,images:[],currentImageIndex:0,status:"empty",progress:0,locked:!1,selected:!1})}c.sort((e,t)=>e.id-t.id),vn({progress:70,currentFile:"Finalizing panels..."}),S(c),r.state.parameter_values&&(Ee(r.state.parameter_values),Bt.current=r.state.parameter_values),r.state.camera_angles&&Te(r.state.camera_angles),r.state.selected_workflow_id&&de(r.state.selected_workflow_id),r.state.comfy_url&&mt(r.state.comfy_url),vn({progress:100,currentFile:"Complete!"});let b=0;c.forEach(e=>b+=e.imageHistory.length),p(`Loaded project with ${c.length} panels, ${b} images`),setTimeout(()=>{fn(!1)},500)}catch(s){console.error("[Load] Failed to load project:",s),u(`Failed to load project: ${String(s)}`),fn(!1)}},Ma=(e,t)=>{var n;const a=w.find(t=>t.id===e);if(!a)return;const r=a.imageHistory.find(e=>e.id===t);if(!r)return console.error("[Delete] Entry not found:",t),void u("Cannot delete: image entry not found");const i=(null==(n=null==r?void 0:r.metadata)?void 0:n.savedPath)?fR(r.metadata.savedPath):fR(r.url)||"image";bn?Ca(e,t):xn({isOpen:!0,panelId:e,entryId:t,filename:i})},Ca=async(e,t)=>{var n;const a=w.find(t=>t.id===e);if(!a)return;const r=a.imageHistory.findIndex(e=>e.id===t);if(-1===r)return console.error("[Delete] Entry not found:",t),void u("Cannot delete: image entry not found");const i=a.imageHistory[r],s=null==(n=null==i?void 0:i.metadata)?void 0:n.savedPath;let o=!0;if(s){console.log("[Delete] Attempting to delete:",s);const e=await Kk.deleteImage(s);console.log("[Delete] Result:",e),e.success?(pn(e=>new Set([...e,s])),p(`Moved to trash: ${fR(s)}`)):(console.error("[Delete] Failed:",e.error),u(`Move to trash failed: ${e.error||"Unknown error"}`),o=!1)}else console.warn("[Delete] No savedPath in entry metadata - removing from UI only:",null==i?void 0:i.metadata);o&&S(n=>n.map(n=>{var a;if(n.id!==e)return n;const r=n.imageHistory.findIndex(e=>e.id===t);if(-1===r)return n;const i=[...n.imageHistory];i.splice(r,1);let s=n.historyIndex;return r<=n.historyIndex&&(s=Math.max(0,n.historyIndex-1)),0===i.length&&(s=-1),{...n,imageHistory:i,historyIndex:s,image:i.length>0?null==(a=i[s])?void 0:a.url:null,status:i.length>0?"complete":"empty"}}))},Ea=async()=>{const e=Rt.some(e=>"busy"===e.status),t=w.some(e=>"generating"===e.status);if(e||t){p("Cancelling all running generations...");try{const e=(await YC.cancelAllGenerations()).filter(e=>e.success).length;e>0?p(`Cancelled ${e} generation(s)`):u("Failed to cancel generations"),S(e=>e.map(e=>"generating"===e.status?{...e,status:"error",error:"Cancelled by user"}:e))}catch(n){u(`Error cancelling generations: ${n instanceof Error?n.message:"Unknown error"}`),console.error("[Cancel] Error:",n)}}else p("No generations are currently running")},ka=Tt.useCallback(async()=>{if(w.some(e=>e.image||e.images.length>0||""!==e.notes.trim())){window.confirm("You have unsaved work. Would you like to save before creating a new project?\n\nClick OK to save first, or Cancel to discard changes.")&&await ba()}const e=Array.from({length:6},(e,t)=>({id:t+1,image:null,images:[],imageHistory:[],historyIndex:-1,currentImageIndex:0,x:t%3*320,y:320*Math.floor(t/3),width:300,height:300,status:"empty",progress:0,notes:"",nodeId:void 0,workflowId:void 0,parameterValues:void 0,prompt:"",seed:-1}));S(e),Ee({}),Bt.current={},de(null);const t={name:"Untitled Project",path:"",namingTemplate:"{project}_Panel{panel}_{version}",autoSave:!0,orchestratorUrl:dn.orchestratorUrl,created:new Date,lastModified:new Date};un(t),Kk.setProject(t),on(!0)},[w,ba,dn.orchestratorUrl]);return Tt.useEffect(()=>{const e=e=>{const t=e.target;if("INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName&&"SELECT"!==t.tagName)return!e.ctrlKey&&!e.metaKey||!e.shiftKey||"S"!==e.key&&"s"!==e.key?(e.ctrlKey||e.metaKey)&&"n"===e.key?(e.preventDefault(),void ka()):!e.ctrlKey&&!e.metaKey||e.shiftKey||"s"!==e.key?(e.ctrlKey||e.metaKey)&&"o"===e.key?(e.preventDefault(),void wa()):(e.ctrlKey||e.metaKey)&&","===e.key?(e.preventDefault(),void on(!0)):(e.ctrlKey||e.metaKey)&&"p"===e.key?(e.preventDefault(),void be(!0)):void 0:(e.preventDefault(),void ba()):(e.preventDefault(),void _a())};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}},[ka,ba,_a,wa]),Ut.jsxs("div",{className:"storyboard-ui",children:[mn&&Ut.jsx("div",{className:"loading-overlay",children:Ut.jsxs("div",{className:"loading-modal",children:[Ut.jsx("h3",{children:"Loading Project..."}),Ut.jsx("div",{className:"progress-bar",children:Ut.jsx("div",{className:"progress-fill",style:{width:`${gn.progress}%`}})}),Ut.jsxs("p",{className:"progress-text",children:[Math.round(gn.progress),"%"]}),Ut.jsx("p",{className:"current-file",children:gn.currentFile})]})}),Ut.jsxs("div",{className:"storyboard-top-bar",children:[Ut.jsx(Uk,{projectName:dn.name||"Untitled Project",nodeCount:Rt.length,onProjectSettings:()=>on(!0),onPathMappings:()=>cn(!0),onSaveProject:ba,onSaveProjectAs:_a,onLoadProject:wa,onLoadRecentProject:e=>{Sa(e)},onNewProject:ka,onManageNodes:()=>Pt(!0),onRestartNodes:async()=>{if(0!==Rt.length){At(!0),p("Restarting all ComfyUI backends...");try{const e=await YC.restartAllBackends(),t=e.filter(e=>e.success).length,n=e.length-t;0===n?p(`Successfully restarted ${t} backend(s)`):0===t?u(`Failed to restart all ${n} backend(s). Check the console for details.`):p(`Restarted ${t} backend(s), ${n} failed. Check the console for details.`),e.forEach(e=>{e.success?console.log(`[Restart] ${e.backendId}: ${e.message}`):console.error(`[Restart] ${e.backendId}: ${e.message}`)})}catch(e){u(`Error restarting nodes: ${e instanceof Error?e.message:"Unknown error"}`),console.error("[Restart] Error:",e)}finally{At(!1)}}else u("No render nodes available to restart.")},onCancelGenerations:Ea,onPrintStoryboard:()=>be(!0),isRestarting:jt,isGenerating:w.some(e=>"generating"===e.status)||Rt.some(e=>"busy"===e.status)}),Ut.jsx("div",{className:"workflow-dropdown-bar",children:Ut.jsxs("select",{value:ce||"",onChange:e=>de(e.target.value),className:"workflow-select",children:[Ut.jsx("option",{value:"",children:"Select workflow..."}),se.filter(e=>{var t;const n=e.category===g&&e.subCategory===y,a=_R[y],r=a&&(null==(t=e.categories)?void 0:t.includes(a));return n||r}).map(e=>Ut.jsx("option",{value:e.id,children:e.name},e.id))]})}),Ut.jsxs("div",{className:"storyboard-tabs",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"tab-with-dropdown",children:[Ut.jsxs("button",{className:"storyboard-tab "+("image-generation"===g?"active":""),onClick:()=>_("image-generation"===b?null:"image-generation"),children:["Image Generation ",Ut.jsx(uE,{size:14,style:{marginLeft:4,opacity:.7}})]}),"image-generation"===b&&Ut.jsxs("div",{className:"tab-dropdown",children:[Ut.jsx("button",{className:"text2img"===y?"active":"",onClick:()=>{v("image-generation"),x("text2img"),_(null)},children:"Text to Image"}),Ut.jsx("button",{className:"img2img"===y?"active":"",onClick:()=>{v("image-generation"),x("img2img"),_(null)},children:"Image to Image"}),Ut.jsx("button",{className:"inpainting"===y?"active":"",onClick:()=>{v("image-generation"),x("inpainting"),_(null)},children:"Inpainting"})]})]}),Ut.jsx("button",{className:"storyboard-tab "+("image-editing"===g?"active":""),onClick:()=>{v("image-editing"),x("editing"),_(null)},children:"Image Editing"}),Ut.jsx("button",{className:"storyboard-tab "+("upscaling"===g?"active":""),onClick:()=>{v("upscaling"),x("upscale"),_(null)},children:"Upscaling"}),Ut.jsxs("div",{className:"tab-with-dropdown",children:[Ut.jsxs("button",{className:"storyboard-tab "+("video-generation"===g?"active":""),onClick:()=>_("video-generation"===b?null:"video-generation"),children:["Video Generation ",Ut.jsx(uE,{size:14,style:{marginLeft:4,opacity:.7}})]}),"video-generation"===b&&Ut.jsxs("div",{className:"tab-dropdown",children:[Ut.jsx("button",{className:"img2vid"===y?"active":"",onClick:()=>{v("video-generation"),x("img2vid"),_(null)},children:"Image to Video"}),Ut.jsx("button",{className:"txt2vid"===y?"active":"",onClick:()=>{v("video-generation"),x("txt2vid"),_(null)},children:"Text to Video"}),Ut.jsx("button",{className:"fflf"===y?"active":"",onClick:()=>{v("video-generation"),x("fflf"),_(null)},children:"FFLF"})]})]})]})]}),Ut.jsxs("div",{className:"storyboard-main",children:[Ut.jsxs("aside",{className:"storyboard-sidebar",style:{width:Dn},children:[Ut.jsx("div",{className:"sidebar-section",children:Ut.jsxs("div",{className:"sidebar-section-header",children:[Ut.jsx("span",{className:"sidebar-section-title",children:"Workflow"}),Ut.jsxs("div",{className:"workflow-icon-buttons",children:[Ut.jsx("button",{className:"icon-btn",onClick:()=>{const e=se.find(e=>e.id===ce);e&&(me(e),he(!0))},disabled:!ya,title:"Edit workflow parameters",children:Ut.jsx(ik,{size:14})}),Ut.jsx("button",{className:"icon-btn rename",onClick:()=>{const e=se.find(e=>e.id===ce);e&&(we(e),Me(e.name),ye(!0))},disabled:!ya,title:"Rename workflow",children:Ut.jsx(rk,{size:14})}),Ut.jsx("button",{className:"icon-btn delete",onClick:()=>{if(ce&&confirm("Are you sure you want to delete this workflow?")){const e=se.find(e=>e.id===ce);oe(e=>e.filter(e=>e.id!==ce)),de(null),uR.delete(ce).catch(e=>{console.error("[Workflows] Failed to delete from backend:",e),nn("error",`Failed to delete workflow file from storage: ${e}`)}),e&&nn("info",`Deleted workflow: ${e.name}`)}},disabled:!ya,title:"Delete workflow",children:Ut.jsx(Ck,{size:14})}),Ut.jsx("button",{className:"icon-btn export",onClick:Qn,disabled:0===se.length,title:`Export all ${se.length} workflows`,children:Ut.jsx(ME,{size:14})}),Ut.jsxs("label",{className:"icon-btn import",title:"Import workflows from JSON",children:[Ut.jsx(kk,{size:14}),Ut.jsx("input",{type:"file",accept:".json",style:{display:"none"},onChange:ea})]}),Ut.jsx("button",{className:"icon-btn categories",onClick:()=>ge(!0),disabled:0===se.length,title:`Manage categories for ${se.length} workflows`,children:Ut.jsx(wk,{size:14})})]})]})}),ya&&ya.parsed.outputs&&ya.parsed.outputs.length>0&&Ut.jsxs("div",{className:"sidebar-section",children:[Ut.jsx("div",{className:"sidebar-section-title",children:"Output Nodes"}),Ut.jsx(Ok,{options:ya.parsed.outputs.map(e=>({id:e.node_id,label:e.name,selected:e.selected})),onChange:e=>{const t=ya.parsed.outputs.map(t=>({...t,selected:e.includes(t.node_id)}));oe(e=>e.map(e=>e.id===ya.id?{...e,parsed:{...e.parsed,outputs:t}}:e))},placeholder:"Select output nodes..."})]}),ya&&Ut.jsxs("div",{className:"sidebar-section parameters-section",children:[Ut.jsxs("div",{className:"global-prompt-section",children:[Ut.jsx("div",{className:"global-prompt-header",children:Ut.jsxs("label",{className:"checkbox-label",children:[Ut.jsx("input",{type:"checkbox",checked:je,onChange:e=>Ae(e.target.checked)}),"Global Prompt Override"]})}),je&&Ut.jsx("textarea",{className:"global-prompt-input",placeholder:"Enter prompt to use for all panels...",value:Ne,onChange:e=>Pe(e.target.value),rows:3})]}),Ut.jsx(TC,{parameters:xa.map(e=>({name:e.name,display_name:e.display_name,type:"string"===e.type?"prompt":e.type,node_id:e.node_id,input_name:e.input_name,default:e.default,constraints:e.constraints,description:e.description})),values:Ce,onChange:fa,disabled:!1,onEnhancePrompt:va,cameraAngles:ke,onCameraAngleChange:ga,comfyUrl:pt})]})]}),Ut.jsx("div",{className:"resize-handle resize-handle-left",onMouseDown:e=>{e.preventDefault(),Bn(!0)}}),Ut.jsxs("main",{className:"storyboard-canvas",ref:ae,onMouseDown:na,onMouseMove:e=>{ia(e),aa(e)},onMouseUp:()=>{sa(),ra()},onMouseLeave:()=>{sa(),ra()},onDragOver:e=>e.preventDefault(),onDrop:tn,children:[Ut.jsxs("div",{className:"canvas-toolbar",children:[Ut.jsx("button",{className:"icon-btn",onClick:()=>k(e=>Math.min(5,1.2*e)),title:"Zoom In",children:Ut.jsx(jk,{size:16})}),Ut.jsx("button",{className:"icon-btn",onClick:()=>k(e=>Math.max(.1,e/1.2)),title:"Zoom Out",children:Ut.jsx(Ak,{size:16})}),Ut.jsx("button",{className:"icon-btn",onClick:()=>{k(1),N({x:0,y:0})},title:"Reset View",children:Ut.jsx(dk,{size:16})}),Ut.jsxs("span",{className:"zoom-level",children:[Math.round(100*E),"%"]}),Ut.jsxs("button",{onClick:ta,className:"add-panel-btn",title:"Add Panel",children:[Ut.jsx(sk,{size:14})," Add Panel"]}),Ut.jsxs("button",{onClick:()=>be(!0),className:"add-panel-btn",title:"Print Storyboard",children:[Ut.jsx(lk,{size:14})," Print"]}),w.filter(e=>e.selected).length>=2&&Ut.jsxs("div",{className:"alignment-toolbar",children:[Ut.jsx("button",{className:"icon-btn",onClick:()=>Qt("left"),title:"Align Left",children:Ut.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[Ut.jsx("rect",{x:"2",y:"2",width:"2",height:"12"}),Ut.jsx("rect",{x:"6",y:"4",width:"8",height:"3"}),Ut.jsx("rect",{x:"6",y:"9",width:"6",height:"3"})]})}),Ut.jsx("button",{className:"icon-btn",onClick:()=>Qt("right"),title:"Align Right",children:Ut.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[Ut.jsx("rect",{x:"12",y:"2",width:"2",height:"12"}),Ut.jsx("rect",{x:"2",y:"4",width:"8",height:"3"}),Ut.jsx("rect",{x:"2",y:"9",width:"6",height:"3"})]})}),Ut.jsx("button",{className:"icon-btn",onClick:()=>Qt("top"),title:"Align Top",children:Ut.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[Ut.jsx("rect",{x:"2",y:"2",width:"12",height:"2"}),Ut.jsx("rect",{x:"4",y:"6",width:"3",height:"8"}),Ut.jsx("rect",{x:"9",y:"6",width:"3",height:"6"})]})}),Ut.jsx("button",{className:"icon-btn",onClick:()=>Qt("bottom"),title:"Align Bottom",children:Ut.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[Ut.jsx("rect",{x:"2",y:"12",width:"12",height:"2"}),Ut.jsx("rect",{x:"4",y:"2",width:"3",height:"8"}),Ut.jsx("rect",{x:"9",y:"2",width:"3",height:"6"})]})}),Ut.jsx("div",{className:"toolbar-separator"}),Ut.jsx("button",{className:"icon-btn",onClick:()=>en("horizontal"),title:"Distribute Horizontally",children:Ut.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[Ut.jsx("rect",{x:"1",y:"4",width:"2",height:"8"}),Ut.jsx("rect",{x:"6",y:"4",width:"4",height:"8"}),Ut.jsx("rect",{x:"13",y:"4",width:"2",height:"8"})]})}),Ut.jsx("button",{className:"icon-btn",onClick:()=>en("vertical"),title:"Distribute Vertically",children:Ut.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",children:[Ut.jsx("rect",{x:"4",y:"1",width:"8",height:"2"}),Ut.jsx("rect",{x:"4",y:"6",width:"8",height:"4"}),Ut.jsx("rect",{x:"4",y:"13",width:"8",height:"2"})]})})]})]}),Ut.jsxs("div",{className:"canvas-transform-container",style:{transform:`translate(${T.x}px, ${T.y}px) scale(${E})`},children:[H&&Ut.jsx("div",{className:"marquee-selection",style:{position:"absolute",left:Math.min(V.x,G.x),top:Math.min(V.y,G.y),width:Math.abs(G.x-V.x),height:Math.abs(G.y-V.y),backgroundColor:"rgba(59, 130, 246, 0.1)",border:"1px solid rgba(59, 130, 246, 0.5)",pointerEvents:"none",zIndex:1e3}}),q.map((e,t)=>Ut.jsx("div",{className:"snap-guide",style:{position:"absolute",left:"vertical"===e.type?e.position:0,top:"horizontal"===e.type?e.position:0,width:"vertical"===e.type?1:"100%",height:"horizontal"===e.type?1:"100%",backgroundColor:"rgba(239, 68, 68, 0.6)",pointerEvents:"none",zIndex:999}},t)),w.map(e=>{var t,n,a,r;return Ut.jsxs("div",{className:`panel-slot ${M===e.id?"selected":""} ${e.status} ${e.selected?"multi-selected":""}`,style:{left:e.x,top:e.y,width:e.width,height:e.height,zIndex:e.zIndex||(e.selected?10:1)},onMouseDown:t=>{(t.ctrlKey||t.metaKey||t.shiftKey)&&(t.stopPropagation(),qt(e.id))},onClick:t=>{t.stopPropagation(),t.ctrlKey||t.metaKey||t.shiftKey||(C(e.id),Ht.current=e.id)},onContextMenu:t=>{t.preventDefault(),t.stopPropagation(),Je({visible:!0,x:t.clientX,y:t.clientY,panelId:e.id})},children:[Ut.jsx(rR,{panelId:e.id,name:e.name||`Panel_${String(e.id).padStart(2,"0")}`,locked:e.locked||e.imageHistory.length>0,selected:e.selected,onNameChange:t=>{S(n=>n.map(n=>n.id===e.id?{...n,name:t}:n))},onRemove:()=>Zt(e.id),onMouseDown:t=>{"generating"!==e.status&&Kt(e.id,t)}}),Ut.jsxs("div",{className:"panel-content",children:[e.image&&Ut.jsx("div",{className:"panel-image-container",children:Vk(e.image)?Ut.jsx("video",{src:e.image,controls:!0,loop:!0,muted:!0,autoPlay:!0,playsInline:!0,draggable:!0,onDragStart:t=>{var n;const a=e.imageHistory[e.historyIndex],r=null==(n=null==a?void 0:a.metadata)?void 0:n.savedPath,i=JSON.stringify({url:e.image,filePath:r||null});t.dataTransfer.setData("application/x-storyboard-image",i),t.dataTransfer.setData("text/plain",i),t.dataTransfer.effectAllowed="copy"},onClick:t=>{t.preventDefault(),t.stopPropagation(),De(e.image),Oe(e.id),ut("actual"),ze(1),He({x:0,y:0}),Ie(!0)},style:{cursor:"pointer",width:"100%",height:"100%",objectFit:"contain"}}):Ut.jsx("img",{src:e.image,alt:`Panel ${e.id}`,draggable:!0,onDragStart:t=>{var n;const a=e.imageHistory[e.historyIndex],r=null==(n=null==a?void 0:a.metadata)?void 0:n.savedPath,i=JSON.stringify({url:e.image,filePath:r||null});t.dataTransfer.setData("application/x-storyboard-image",i),t.dataTransfer.setData("text/plain",i),t.dataTransfer.effectAllowed="copy"},onClick:t=>{t.preventDefault(),t.stopPropagation(),De(e.image),Oe(e.id),ut("actual"),ze(1),He({x:0,y:0}),Ie(!0)},style:{cursor:"pointer"}})}),e.imageHistory.length>0&&e.historyIndex>=0&&(null==(n=null==(t=e.imageHistory[e.historyIndex])?void 0:t.metadata)?void 0:n.generationTime)&&Ut.jsxs("div",{className:"generation-time",children:[e.imageHistory[e.historyIndex].metadata.generationTime.toFixed(1),"s"]}),e.imageHistory.length>0&&e.historyIndex>=0&&Ut.jsx("div",{className:"image-rating",onClick:e=>e.stopPropagation(),children:Ut.jsx(iR,{rating:(null==(r=null==(a=e.imageHistory[e.historyIndex])?void 0:a.metadata)?void 0:r.rating)||0,onRatingChange:t=>{S(n=>n.map(n=>{if(n.id!==e.id)return n;const a=[...n.imageHistory];return a[n.historyIndex]&&(a[n.historyIndex]={...a[n.historyIndex],metadata:{...a[n.historyIndex].metadata,rating:t}}),{...n,imageHistory:a}}))},size:14})}),e.imageHistory.length>1&&Ut.jsxs("div",{className:"image-nav history-nav",children:[Ut.jsx("button",{onClick:t=>{t.stopPropagation(),S(t=>t.map(t=>{if(t.id!==e.id)return t;const n=Math.max(0,t.historyIndex-1),a=t.imageHistory[n];return{...t,historyIndex:n,image:(null==a?void 0:a.url)||t.image}}))},disabled:e.historyIndex<=0,title:"Previous version",children:""}),Ut.jsxs("span",{className:"history-counter",title:`Version ${e.historyIndex+1} of ${e.imageHistory.length}`,children:["v",e.historyIndex+1,"/",e.imageHistory.length]}),Ut.jsx("button",{onClick:t=>{t.stopPropagation(),S(t=>t.map(t=>{if(t.id!==e.id)return t;const n=Math.min(t.imageHistory.length-1,t.historyIndex+1),a=t.imageHistory[n];return{...t,historyIndex:n,image:(null==a?void 0:a.url)||t.image}}))},disabled:e.historyIndex>=e.imageHistory.length-1,title:"Next version",children:""}),Ut.jsx("button",{className:"restore-btn",onClick:async t=>{var n,a,r,i,s,o;t.stopPropagation();const l=e.imageHistory[e.historyIndex];if((null==(n=null==l?void 0:l.metadata)?void 0:n.parameters)&&(null==(a=null==l?void 0:l.metadata)?void 0:a.workflowId)){l.metadata.workflowId!==ce&&(re.current=!0,de(l.metadata.workflowId));const t=l.metadata.parameters;return Ee(t),Bt.current=t,void p(`Restored parameters from v${e.historyIndex+1}`)}const c=null==(r=null==l?void 0:l.metadata)?void 0:r.savedPath;if(c)try{const e=Kk.getProject().orchestratorUrl||Gk(),t=await fetch(`${e}/api/png-metadata?path=${encodeURIComponent(c)}`),n=await t.json();if(!n.success||!n.prompt)return void u("Could not read PNG metadata");const a=n.prompt;let r;const l=Object.keys(a).filter(e=>"meta"!==e&&"version"!==e);let m=0;for(const o of se){const e=Object.keys(o.workflow).filter(e=>"meta"!==e&&"version"!==e);let t=0;for(const r of l)if(o.workflow[r]){const e=null==(i=a[r])?void 0:i.class_type,n=null==(s=o.workflow[r])?void 0:s.class_type;e&&e===n&&t++}const n=l.length>0?t/Math.max(l.length,e.length):0;n>m&&n>.5&&(m=n,r=o)}if(!r){let e=null;for(const t of Object.values(a))if("SaveImage"===t.class_type&&(null==(o=t.inputs)?void 0:o.filename_prefix)){e=t.inputs.filename_prefix;break}if(e&&(r=se.find(t=>t.id===e),!r)){const t=e=>e.toLowerCase().replace(/[_\s-]/g,""),n=t(e);r=se.find(e=>t(e.id).includes(n)||n.includes(t(e.id))||t(e.name||"").includes(n)||n.includes(t(e.name||"")))}}r||h("Could not find matching workflow. Extracting parameters only.");const f={},g={};if(r){for(const e of r.parsed.parameters){const t=e.node_id,n=e.input_name,r=a[t];if((null==r?void 0:r.inputs)&&n in r.inputs){const t=r.inputs[n];Array.isArray(t)||(f[e.name]=t)}}for(const e of r.parsed.image_inputs){const t=e.node_id,n=e.input_name,r=a[t];if((null==r?void 0:r.inputs)&&n in r.inputs){const t=r.inputs[n];t&&"string"==typeof t&&(g[e.name]=t)}}}if(0===Object.keys(f).length)for(const i of Object.values(a)){if(!i.inputs)continue;const e=i.class_type||"";if((e.includes("KSampler")||e.includes("Sampler"))&&(void 0!==i.inputs.seed&&(f.seed=i.inputs.seed),void 0!==i.inputs.steps&&(f.steps=i.inputs.steps),void 0!==i.inputs.cfg&&(f.cfg=i.inputs.cfg),i.inputs.sampler_name&&(f.sampler_name=i.inputs.sampler_name),i.inputs.scheduler&&(f.scheduler=i.inputs.scheduler),void 0!==i.inputs.denoise&&(f.denoise=i.inputs.denoise),i.inputs.positive_prompt&&(f.positive_prompt=i.inputs.positive_prompt),i.inputs.negative_prompt&&(f.negative_prompt=i.inputs.negative_prompt)),"CLIPTextEncode"===e&&i.inputs.text){const e=i.inputs.text;"string"==typeof e&&e.length>20&&!f.positive_prompt&&(f.positive_prompt=e)}if(e.includes("TextEncode")&&!f.positive_prompt){const e=i.inputs.prompt||i.inputs.text;"string"==typeof e&&e.length>20&&(f.positive_prompt=e)}if("LoadImage"===e&&i.inputs.image){const e=i.inputs.image;g.reference_image||(g.reference_image=e)}}let v=0;r&&r.id!==ce&&(re.current=!0,de(r.id),v++),Object.keys(f).length>0&&(Ee(e=>{const t={...e,...f};return Bt.current=t,t}),v+=Object.keys(f).length);const y=Object.keys(g).length;if(y>0){const e=Rt.filter(e=>"online"===e.status);if(e.length>0){const t=e[0].url.replace(/\/$/,"");for(const[e,n]of Object.entries(g))try{const a=`${t}/view?filename=${encodeURIComponent(n)}&type=input`,r=await fetch(a);if(r.ok){const t=await r.blob(),n=await new Promise(e=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.readAsDataURL(t)});f[e]=n,v++}}catch(d){console.warn(`Could not fetch image ${n}:`,d)}Object.keys(g).some(e=>f[e])&&Ee(e=>{const t={...e,...f};return Bt.current=t,t})}}if(v>0){const e=r?`workflow "${r.name||r.id}"`:"",t=`${Object.keys(f).length} parameters`;p(`Restored ${e?e+", ":""}${t}${y>0?`, ${y} images`:""}`)}else h("No parameters could be extracted from PNG")}catch(d){console.error("Failed to restore from PNG:",d),u("Failed to restore parameters")}else u("No image path available")},title:"Restore workflow and parameters from this version",children:""}),Ut.jsx("button",{className:"save-btn",onClick:async t=>{t.stopPropagation();const n=e.imageHistory[e.historyIndex];if(n)try{if(dn.path){const t=e.name||`Panel_${String(e.id).padStart(2,"0")}`,a=await Kk.saveToProjectFolder(n.url,e.id,n.metadata.version,n.metadata,t);a.success?p(`Saved: ${a.savedPath}`):u(`Failed to save: ${a.error}`)}else{const{filename:t,blob:a}=await Kk.saveImageToProject(n.url,e.id,n.metadata.version,n.metadata);Kk.triggerDownload(a,t);const r=Kk.generateMetadataJson(n),i=new Blob([r],{type:"application/json"});Kk.triggerDownload(i,t.replace(".png","_metadata.json")),p(`Downloaded: ${t}`)}}catch(a){u(`Failed to save: ${a}`)}},title:dn.path?`Save to ${dn.path}`:"Download image",children:""})]}),"generating"===e.status&&Ut.jsxs("div",{className:"panel-generating-mini",children:[Ut.jsx("div",{className:"panel-gen-mini-bar",children:Ut.jsx("div",{className:"panel-gen-mini-bar-fill",style:{width:`${e.progress}%`}})}),Ut.jsxs("span",{className:"panel-gen-mini-badge",children:[Ut.jsx("span",{className:"panel-gen-mini-spinner"}),e.progress,"%"]})]}),"empty"===e.status&&!e.image&&Ut.jsx("button",{className:"panel-generate-btn large",onClick:t=>{t.stopPropagation(),ca(e.id)},disabled:!ya||"connected"!==ft&&0===Rt.filter(e=>"online"===e.status).length,title:"Generate",children:""}),Ut.jsx("span",{className:"panel-index",children:e.id})]}),Ut.jsxs("div",{className:"panel-controls",children:[("empty"===e.status||"complete"===e.status||"error"===e.status)&&Ut.jsx("button",{className:"panel-generate-btn "+("empty"!==e.status?"regenerate":""),onClick:t=>{t.stopPropagation(),S(t=>t.map(t=>{if(t.id!==e.id)return t;const n=t.image&&!t.images.includes(t.image)?[...t.images,t.image]:t.images;return{...t,status:"empty",progress:0,images:n}})),ca(e.id)},disabled:!ya||"connected"!==ft&&0===Rt.filter(e=>"online"===e.status).length,title:"empty"===e.status?"Generate":"Regenerate",children:"error"===e.status?"":""}),Ut.jsxs("select",{className:"panel-node-selector",value:e.nodeId||"",onChange:t=>{const n=t.target.value||void 0;S(t=>t.map(t=>t.id===e.id?{...t,nodeId:n}:t))},onClick:e=>e.stopPropagation(),children:[Ut.jsx("option",{value:"",children:"Auto"}),Rt.map(e=>Ut.jsxs("option",{value:e.id,disabled:"offline"===e.status,children:[e.name," (",e.status,")"]},e.id))]}),e.imageHistory.length>0&&e.historyIndex>=0&&Ut.jsx("button",{className:"panel-delete-btn",onClick:t=>{t.stopPropagation();const n=e.imageHistory[e.historyIndex];n&&Ma(e.id,n.id)},title:"Delete image",children:Ut.jsx(Ck,{size:14})})]}),Ut.jsx(aR,{panelId:e.id,notes:e.notes||"",onNotesChange:t=>{S(n=>n.map(n=>n.id===e.id?{...n,notes:t}:n))}}),Ut.jsx("div",{className:"panel-resize-handle",title:"Drag to resize",onMouseDown:t=>Wt(e.id,t)})]},e.id)})]})]}),Ut.jsx("div",{className:"resize-handle resize-handle-right",onMouseDown:e=>{e.preventDefault(),$n(!0)}}),Ut.jsxs("aside",{className:"stats-panel",style:{width:On},children:[Ut.jsx("div",{className:"stats-header",children:"System Stats"}),Ut.jsx(dR,{panels:w,onCancelSingle:async e=>{if(It.current){await It.current.cancelGeneration()?(S(t=>t.map(t=>t.id===e?{...t,status:"empty",progress:0,parallelJobs:void 0}:t)),h("Generation cancelled")):u("Failed to cancel generation")}},onCancelParallelJob:async(e,t)=>{const n=Rt.find(e=>e.id===t);if(n)try{await fetch(`${n.url}/interrupt`,{method:"POST"}),h(`Cancelled generation on ${n.name}`)}catch(a){u(`Failed to cancel on ${n.name}: ${a}`)}}}),Rt.length>0&&Ut.jsx("div",{style:{padding:"8px",borderBottom:"1px solid #3d3d3d"},children:Ut.jsx(Fk,{selectedBackendIds:an,onSelectionChange:rn,disabled:!1})}),Ut.jsx("div",{className:"stats-content",children:0!==Rt.length||vt?Ut.jsxs("div",{className:"node-metrics-list",children:[Rt.map(e=>Ut.jsxs("div",{className:"node-metrics-card",children:[Ut.jsxs("div",{className:"node-metrics-header",children:[Ut.jsx("span",{className:"node-status-dot",style:{color:"online"===e.status?"#4dff6d":"busy"===e.status?"#ffcc00":"#ff4444"},children:""}),Ut.jsx("span",{className:"node-name",children:e.name})]}),(()=>{const t=w.filter(e=>"generating"===e.status&&e.parallelJobs).flatMap(e=>e.parallelJobs||[]).find(t=>t.nodeId===e.id&&("running"===t.status||"pending"===t.status));return t?Ut.jsxs("div",{className:"node-progress-container",children:[Ut.jsx("div",{className:"node-progress-bar",children:Ut.jsx("div",{className:"node-progress-fill",style:{width:`${t.progress}%`}})}),Ut.jsx("span",{className:"node-progress-text",children:"running"===t.status?`${t.progress}%`:"Queued"})]}):null})(),"online"===e.status&&Ut.jsxs("div",{className:"node-metrics-body",children:[Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"GPU"}),Ut.jsx("span",{className:"metric-value",children:e.gpuName})]}),Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"VRAM"}),Ut.jsxs("span",{className:"metric-value",children:[(e.vramUsed/1024).toFixed(1),"/",(e.vramTotal/1024).toFixed(1)," GB"]}),Ut.jsx("div",{className:"metric-bar",children:Ut.jsx("div",{className:"metric-bar-fill",style:{width:`${Math.min(100,e.vramUsed/e.vramTotal*100)}%`}})})]}),Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"GPU%"}),Ut.jsxs("span",{className:"metric-value",children:[(e.gpuUsage||0).toFixed(0),"%"]}),Ut.jsx("div",{className:"metric-bar",children:Ut.jsx("div",{className:"metric-bar-fill gpu",style:{width:`${e.gpuUsage||0}%`}})})]}),Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"Temp"}),Ut.jsxs("span",{className:"metric-value",children:[e.gpuTemp||0,"C"]})]}),Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"CPU"}),Ut.jsxs("span",{className:"metric-value",children:[(e.cpuUsage||0).toFixed(0),"%"]}),Ut.jsx("div",{className:"metric-bar",children:Ut.jsx("div",{className:"metric-bar-fill cpu",style:{width:`${e.cpuUsage||0}%`}})})]}),Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"RAM"}),Ut.jsxs("span",{className:"metric-value",children:[(e.ramUsed||0).toFixed(1),"/",(e.ramTotal||0).toFixed(1)," GB"]}),Ut.jsx("div",{className:"metric-bar",children:Ut.jsx("div",{className:"metric-bar-fill ram",style:{width:(e.ramTotal?e.ramUsed/e.ramTotal*100:0)+"%"}})})]})]}),"online"!==e.status&&Ut.jsx("div",{className:"node-metrics-offline",children:"offline"===e.status?"Offline":e.status})]},e.id)),0===Rt.length&&vt&&Ut.jsxs("div",{className:"node-metrics-card",children:[Ut.jsxs("div",{className:"node-metrics-header",children:[Ut.jsx("span",{className:"node-status-dot",style:{color:"#4dff6d"},children:""}),Ut.jsx("span",{className:"node-name",children:"Top Bar URL"})]}),Ut.jsxs("div",{className:"node-metrics-body",children:[Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"GPU"}),Ut.jsx("span",{className:"metric-value",children:(null==(n=null==(t=null==(e=vt.devices)?void 0:e[0])?void 0:t.name)?void 0:n.replace(/^cuda:\d+\s+/,"").replace(/:\w+Alloc\w*$/,""))||"Unknown"})]}),Ut.jsxs("div",{className:"metric-row",children:[Ut.jsx("span",{className:"metric-label",children:"VRAM"}),Ut.jsx("span",{className:"metric-value",children:(null==(r=null==(a=vt.devices)?void 0:a[0])?void 0:r.vram_total)?`${((vt.devices[0].vram_total-(vt.devices[0].vram_free||0))/1024/1024/1024).toFixed(1)}/${(vt.devices[0].vram_total/1024/1024/1024).toFixed(1)} GB`:"N/A"})]})]})]})]}):Ut.jsx("span",{className:"no-stats",children:"No nodes configured"})})]})]}),Ct&&Ut.jsxs("div",{className:"log-panel",children:[Ut.jsxs("div",{className:"log-header",children:[Ut.jsx("span",{children:"Application Log"}),Ut.jsxs("div",{className:"log-controls",children:[Ut.jsxs("select",{value:_t,onChange:e=>wt(e.target.value),children:[Ut.jsx("option",{value:"ALL",children:"All"}),Ut.jsx("option",{value:"COMFYUI",children:"COMFYUI"}),Ut.jsx("option",{value:"ERROR",children:"Error"})]}),Ut.jsxs("label",{children:[Ut.jsx("input",{type:"checkbox",checked:St,onChange:e=>Mt(e.target.checked)}),"Auto-scroll"]}),Ut.jsx("button",{onClick:()=>Et(!1),className:"toggle-log-btn",children:"Hide"})]})]}),Ut.jsxs("div",{className:"log-content",children:[xt.filter(e=>"ALL"===_t||e.tag.toUpperCase()===_t).map(e=>{return Ut.jsxs("div",{className:`log-entry ${e.tag}`,children:[Ut.jsxs("span",{className:"log-time",children:["[",(t=e.timestamp,t.toTimeString().split(" ")[0]),"]"]}),Ut.jsx("span",{className:"log-tag",children:e.tag}),Ut.jsx("span",{className:"log-message",children:e.message})]},e.id);var t}),Ut.jsx("div",{ref:kt})]})]}),!Ct&&Ut.jsx("button",{className:"show-log-btn",onClick:()=>Et(!0),children:"Show Log"}),ue&&pe&&Ut.jsx("div",{className:"modal-overlay",children:Ut.jsx("div",{className:"modal-content",children:Ut.jsx(AC,{workflow:pe.workflow,parsedWorkflow:pe.parsed,initialConfig:pe.config,comfyUrl:pt,onSave:e=>{re.current=!0,oe(t=>t.map(t=>t.id===pe.id?{...t,config:e}:t)),he(!1),nn("info",`Updated workflow: ${pe.name}`)},onCancel:()=>he(!1)},pe.id)})}),ve&&_e&&Ut.jsx("div",{className:"modal-overlay",children:Ut.jsxs("div",{className:"modal-content rename-dialog",children:[Ut.jsxs("div",{className:"modal-header",children:[Ut.jsx("h3",{children:"Rename Workflow"}),Ut.jsx("button",{className:"modal-close-btn",onClick:()=>ye(!1),children:Ut.jsx(Nk,{size:20})})]}),Ut.jsx("div",{className:"modal-body",children:Ut.jsxs("label",{className:"input-label",children:["Workflow Name",Ut.jsx("input",{type:"text",value:Se,onChange:e=>Me(e.target.value),placeholder:"Enter workflow name...",className:"text-input",autoFocus:!0})]})}),Ut.jsxs("div",{className:"modal-footer",children:[Ut.jsx("button",{className:"btn-secondary",onClick:()=>ye(!1),children:"Cancel"}),Ut.jsx("button",{className:"btn-primary",onClick:()=>{Se.trim()&&_e&&(oe(e=>e.map(e=>e.id===_e.id?{...e,name:Se.trim()}:e)),nn("info",`Renamed workflow from "${_e.name}" to "${Se.trim()}"`),ye(!1),we(null),Me(""))},disabled:!Se.trim(),children:"Rename"})]})]})}),Ut.jsx(zk,{isOpen:fe,onClose:()=>ge(!1),workflows:se,onUpdateWorkflow:Zn}),Ut.jsx(sR,{isOpen:xe,onClose:()=>be(!1),panels:w,projectName:dn.name||"Untitled Project",selectedPanelIds:w.filter(e=>e.selected).map(e=>e.id)}),Nt&&Ut.jsx(Rk,{onClose:()=>Pt(!1),onRestartNodes:async e=>{p(`Restarting ${e.length} selected node(s)...`);try{const t=[];for(const r of e){const e=await YC.restartBackend(r);t.push({nodeId:r,...e})}const n=t.filter(e=>e.success).length,a=t.length-n;0===a?p(`Successfully restarted ${n} node(s)`):0===n?u(`Failed to restart all ${a} node(s)`):p(`Restarted ${n} node(s), ${a} failed`)}catch(t){u(`Error restarting nodes: ${t instanceof Error?t.message:"Unknown error"}`)}}}),sn&&Ut.jsx(nT,{isOpen:sn,onClose:()=>on(!1),settings:dn,onSave:un}),ln&&Ut.jsx(lR,{isOpen:ln,onClose:()=>cn(!1),orchestratorUrl:dn.orchestratorUrl||Gk()}),Tn&&Ut.jsx("div",{className:"modal-overlay",onClick:()=>Nn(!1),children:Ut.jsxs("div",{className:"modal-content load-project-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"modal-header",children:[Ut.jsx("h2",{children:"Load Project"}),Ut.jsx("button",{className:"close-btn",onClick:()=>Nn(!1),children:Ut.jsx(Nk,{size:18})})]}),Ut.jsxs("div",{className:"load-project-content",children:[Ut.jsx("p",{className:"load-project-instruction",children:"Select a folder to browse for project files:"}),Ut.jsx(aT,{isOpen:!0,onClose:()=>{},onSelect:async e=>{Rn(e),Ln(!0);try{const t=await Kk.listProjects(e);t.success&&t.projects.length>0?jn(t.projects):t.success?(u("No project files found in the selected folder"),jn([])):(u(`Failed to list projects: ${t.error}`),jn([]))}catch(t){u(`Error loading projects: ${t}`),jn([])}finally{Ln(!1)}},orchestratorUrl:dn.orchestratorUrl,initialPath:dn.path,title:"Select Folder"}),In&&Ut.jsx("div",{className:"loading-projects",children:"Loading projects..."}),Pn.length>0&&Ut.jsxs("div",{className:"available-projects",children:[Ut.jsx("h3",{children:"Select a project to load:"}),Ut.jsx("div",{className:"project-list",children:Pn.map(e=>Ut.jsxs("div",{className:"project-item",onClick:()=>(async e=>{var t;const n=Kk.getProject().orchestratorUrl||Gk(),a=await Kk.loadProjectState(e);if(a.success&&a.state){const r=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\")),i=r>0?e.substring(0,r):e;Kk.setProject({path:i,orchestratorUrl:n}),un(Kk.getProject());const s=new Set(a.state.deleted_images||[]);pn(s);const o=await Kk.scanProjectPanels();if(o.success&&o.panels.length>0){const e=Kk.getProject().orchestratorUrl||Gk(),n=[],r=new Set,i=()=>{let e=1;for(;r.has(e);)e++;return r.add(e),e},l=a.state.panels,c=new Set,d=new Set;console.log("[Load-Selected] Saved panel names:",l.map(e=>e.name)),console.log("[Load-Selected] Scanned folder names:",o.panels.map(e=>e.panel_name));for(const t of o.panels){const e=l.find(e=>e.name===t.panel_name);e&&e.name&&(c.add(e.name),d.add(t.panel_name))}console.log("[Load-Selected] Matched names:",[...c]),console.log("[Load-Selected] Unmatched folders:",o.panels.filter(e=>!d.has(e.panel_name)).map(e=>e.panel_name)),console.log("[Load-Selected] Unmatched saved:",l.filter(e=>!c.has(e.name??"")).map(e=>e.name));const u=o.panels.filter(e=>!d.has(e.panel_name)),h=l.filter(e=>!c.has(e.name??"")),p=new Map;for(let t=0;t<u.length&&t<h.length;t++)p.set(u[t].panel_name,h[t]),c.add(h[t].name??"");for(const a of o.panels){const o=a.images.filter(e=>!s.has(e.image_path));if(0===o.length)continue;const c=l.find(e=>e.name===a.panel_name)||p.get(a.panel_name)||void 0,d=(null==c?void 0:c.imageRatings)||{},u=o.map((t,n)=>({id:`${a.panel_name}_v${n+1}`,url:`${e}/api/serve-image?path=${encodeURIComponent(t.image_path)}`,metadata:{timestamp:new Date(1e3*t.modified_time),workflowId:"",workflowName:"Loaded",seed:0,promptSummary:"",parameters:{},workflow:{},sourceUrl:"",savedPath:t.image_path,version:n+1,rating:d[t.image_path]}}));let h;(null==c?void 0:c.id)&&!r.has(c.id)?(h=c.id,r.add(h)):h=i();const m=n.length;n.push({id:h,name:a.panel_name,x:(null==c?void 0:c.x)??gR(m+1),y:(null==c?void 0:c.y)??vR(m+1),width:(null==c?void 0:c.width)??300,height:(null==c?void 0:c.height)??300,notes:(null==c?void 0:c.notes)??"",workflowId:null==c?void 0:c.workflowId,parameterValues:null==c?void 0:c.parameterValues,nodeId:null==c?void 0:c.nodeId,imageHistory:u,historyIndex:u.length>0?u.length-1:-1,image:u.length>0?(null==(t=u[u.length-1])?void 0:t.url)??null:null,images:[],currentImageIndex:0,status:u.length>0?"complete":"empty",progress:u.length>0?100:0,locked:(null==c?void 0:c.locked)??!1,selected:!1})}for(const t of l){if(!t.name)continue;if(c.has(t.name))continue;let e;t.id&&!r.has(t.id)?(e=t.id,r.add(e)):e=i(),n.push({id:e,name:t.name,x:t.x,y:t.y,width:t.width??300,height:t.height??300,notes:t.notes??"",workflowId:t.workflowId,parameterValues:t.parameterValues,nodeId:t.nodeId,imageHistory:[],historyIndex:-1,image:null,images:[],currentImageIndex:0,status:"empty",progress:0,locked:!1,selected:!1})}n.sort((e,t)=>e.id-t.id),S(n)}else{const e=new Set,t=a.state.panels.map(t=>{let n=t.id;if(e.has(n))for(n=1;e.has(n);)n++;e.add(n);const a=t.image?"complete":"empty";return{...t,id:n,status:a,progress:t.image?100:0,parallelJobs:void 0}});S(t)}a.state.parameter_values&&(Ee(a.state.parameter_values),Bt.current=a.state.parameter_values),a.state.camera_angles&&Te(a.state.camera_angles),a.state.selected_workflow_id&&de(a.state.selected_workflow_id),a.state.comfy_url&&mt(a.state.comfy_url),un(Kk.getProject()),p(`Loaded project with ${a.state.panels.length} panels`),Nn(!1),jn([])}else u(`Failed to load project: ${a.error}`)})(e.path),children:[Ut.jsx("span",{className:"project-name",children:e.name}),Ut.jsxs("span",{className:"project-meta",children:[e.panel_count," panels  ",new Date(e.saved_at).toLocaleString()]})]},e.path))})]}),An&&!In&&0===Pn.length&&Ut.jsx("div",{className:"no-projects-found",children:"No project files found in this folder."})]}),Ut.jsx("div",{className:"modal-footer",children:Ut.jsx("button",{className:"cancel-btn",onClick:()=>Nn(!1),children:"Cancel"})})]})}),En&&Ut.jsx(tT,{isOpen:!0,onClose:()=>kn(null),mode:En,orchestratorUrl:dn.orchestratorUrl,initialPath:dn.path,projectName:dn.name,onOpenProject:Sa,onSaveProject:async(e,t)=>{const n={...dn,name:t,path:e};un(n),Kk.setProject(n);const a=await Kk.saveProjectState(w,void 0,Ce,{selectedWorkflowId:ce||void 0,renderNodes:Rt,comfyUrl:pt,cameraAngles:ke});a.success?(p(`Project saved to ${a.savedPath}`),kn(null)):u(`Failed to save project: ${a.error}`)}}),Q&&Ut.jsx("div",{className:"modal-overlay",onClick:()=>ee(!1),children:Ut.jsxs("div",{className:"modal-content folder-import-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"modal-header",children:[Ut.jsx("h2",{children:"Import Folder"}),Ut.jsx("button",{className:"close-btn",onClick:()=>ee(!1),children:Ut.jsx(Nk,{size:18})})]}),Ut.jsxs("div",{className:"modal-body",children:[Ut.jsxs("p",{className:"folder-import-instruction",children:["Select a folder to import images from ",Ut.jsx("strong",{children:te}),":"]}),Ut.jsx(aT,{isOpen:!0,onClose:()=>{},onSelect:async e=>{const t=Math.max(...w.map(e=>e.id),0)+1,n=`Panel_${String(t).padStart(2,"0")}`,a=dn.orchestratorUrl||Gk();try{nn("info",`Scanning folder ${e} for images...`);const r=await fetch(`${a}/api/scan-folder-images`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder_path:e})});if(!r.ok)throw new Error(`Scan failed: ${r.status}`);const i=await r.json();if(!i.success||0===i.images.length)return nn("warning",`No images found in folder: ${e}`),h("No images found in the selected folder"),ee(!1),void ne("");const s=i.images.map((e,n)=>({id:`import_${t}_${n}`,url:`${a}/api/serve-image?path=${encodeURIComponent(e.image_path)}`,metadata:{timestamp:new Date(1e3*e.modified_time),workflowId:"",workflowName:"Imported",seed:0,promptSummary:`Imported from ${e.filename}`,parameters:{},workflow:{},sourceUrl:"",savedPath:e.image_path,version:n+1}})),o=e.replace(/[/\\]+$/,"").split(/[/\\]/).pop()||n,l=o.match(/^[a-zA-Z0-9_-]+$/)?o:n;console.log("[Import] Selected path:",e," panel name:",l),S(e=>{var n;const a=e.reduce((e,t)=>Math.max(e,t.x+(t.width||300)),0),r=e.length>0?a+20:0;return[...e,{id:t,name:l,x:r,y:0,width:300,height:300,image:(null==(n=s[s.length-1])?void 0:n.url)||"",images:[],status:s.length>0?"complete":"empty",progress:s.length>0?100:0,imageHistory:s,historyIndex:s.length>0?s.length-1:-1,currentImageIndex:0,workflowId:void 0,parameterValues:{},notes:"",locked:s.length>0,selected:!1}]}),nn("info",`Imported ${s.length} images into panel ${l}`),p(`Imported ${s.length} images`)}catch(r){const e=r instanceof Error?r.message:"Unknown error";nn("error",`Failed to import folder: ${e}`),u(`Failed to import folder: ${e}`)}ee(!1),ne("")},orchestratorUrl:dn.orchestratorUrl,initialPath:dn.path,title:"Select Import Folder"})]}),Ut.jsx("div",{className:"modal-footer",children:Ut.jsx("button",{className:"cancel-btn",onClick:()=>ee(!1),children:"Cancel"})})]})}),Ut.jsx(VC,{notifications:m,onRemove:f}),Ut.jsx(rT,{isOpen:(null==yn?void 0:yn.isOpen)||!1,filename:(null==yn?void 0:yn.filename)||"",onConfirm:()=>{yn&&(Ca(yn.panelId,yn.entryId),xn(null))},onCancel:()=>xn(null),onSuppressForSession:()=>_n(!0)}),Ut.jsxs("div",{className:"floating-action-container",children:[(w.some(e=>"generating"===e.status)||Rt.some(e=>"busy"===e.status))&&Ut.jsxs("button",{className:"floating-cancel-btn",onClick:Ea,title:"Cancel All Generations",children:[Ut.jsx(ek,{size:18}),"Cancel"]}),Ut.jsx("button",{className:"floating-generate-btn",onClick:()=>{M?ca(M):w.length>0&&ca(w[0].id)},disabled:!ya||"connected"!==ft&&0===Rt.filter(e=>"online"===e.status).length,title:"Generate (G)",children:" Generate"})]}),Ye.visible&&Ut.jsxs("div",{className:"panel-context-menu",style:{position:"fixed",top:Ye.y,left:Ye.x,zIndex:1e4},onClick:e=>e.stopPropagation(),children:[Ut.jsxs("button",{className:"context-menu-item",onClick:()=>{Ye.panelId&&Jn(Ye.panelId),Je(e=>({...e,visible:!1}))},disabled:!Ye.panelId||!(null==(l=null==(o=null==(s=w.find(e=>e.id===Ye.panelId))?void 0:s.imageHistory[(null==(i=w.find(e=>e.id===Ye.panelId))?void 0:i.historyIndex)??0])?void 0:o.metadata)?void 0:l.savedPath),children:[Ut.jsx(RE,{size:14})," Open in Explorer"]}),Ut.jsxs("button",{className:"context-menu-item",onClick:async()=>{var e,t,n,a,r,i;if(!Ye.panelId)return;const s=w.find(e=>e.id===Ye.panelId);if(!s||0===s.imageHistory.length)return h("No image in this panel"),void Je(e=>({...e,visible:!1}));const o=s.imageHistory[s.historyIndex];if((null==(e=null==o?void 0:o.metadata)?void 0:e.parameters)&&(null==(t=null==o?void 0:o.metadata)?void 0:t.workflowId)){o.metadata.workflowId!==ce&&(re.current=!0,de(o.metadata.workflowId));const e=o.metadata.parameters;return Ee(e),Bt.current=e,p(`Restored parameters from v${s.historyIndex+1}`),void Je(e=>({...e,visible:!1}))}const l=null==(n=null==o?void 0:o.metadata)?void 0:n.savedPath;if(!l)return u("No image path available for parameter extraction"),void Je(e=>({...e,visible:!1}));try{const e=Kk.getProject().orchestratorUrl||Gk(),t=await fetch(`${e}/api/png-metadata?path=${encodeURIComponent(l)}`),n=await t.json();if(!n.success||!n.prompt)return u("Could not read PNG metadata"),void Je(e=>({...e,visible:!1}));const s=n.prompt;let o;const d=Object.keys(s).filter(e=>"meta"!==e&&"version"!==e);let m=0;for(const i of se){const e=Object.keys(i.workflow).filter(e=>"meta"!==e&&"version"!==e);let t=0;for(const o of d)if(i.workflow[o]){const e=null==(a=s[o])?void 0:a.class_type,n=null==(r=i.workflow[o])?void 0:r.class_type;e&&e===n&&t++}const n=d.length>0?t/Math.max(d.length,e.length):0;n>m&&n>.5&&(m=n,o=i)}if(!o){let e=null;for(const t of Object.values(s))if("SaveImage"===t.class_type&&(null==(i=t.inputs)?void 0:i.filename_prefix)){e=t.inputs.filename_prefix;break}if(e&&(o=se.find(t=>t.id===e),!o)){const t=e=>e.toLowerCase().replace(/[_\s-]/g,""),n=t(e);o=se.find(e=>t(e.id).includes(n)||n.includes(t(e.id))||t(e.name||"").includes(n)||n.includes(t(e.name||"")))}}o||h("Could not find matching workflow. Extracting parameters only.");const f={},g={};if(o){for(const e of o.parsed.parameters){const t=e.node_id,n=e.input_name,a=s[t];if((null==a?void 0:a.inputs)&&n in a.inputs){const t=a.inputs[n];Array.isArray(t)||(f[e.name]=t)}}for(const e of o.parsed.image_inputs){const t=e.node_id,n=e.input_name,a=s[t];if((null==a?void 0:a.inputs)&&n in a.inputs){const t=a.inputs[n];t&&"string"==typeof t&&(g[e.name]=t)}}}if(0===Object.keys(f).length)for(const a of Object.values(s)){if(!a.inputs)continue;const e=a.class_type||"";if((e.includes("KSampler")||e.includes("Sampler"))&&(void 0!==a.inputs.seed&&(f.seed=a.inputs.seed),void 0!==a.inputs.steps&&(f.steps=a.inputs.steps),void 0!==a.inputs.cfg&&(f.cfg=a.inputs.cfg),a.inputs.sampler_name&&(f.sampler_name=a.inputs.sampler_name),a.inputs.scheduler&&(f.scheduler=a.inputs.scheduler),void 0!==a.inputs.denoise&&(f.denoise=a.inputs.denoise)),"CLIPTextEncode"===e&&a.inputs.text){const e=a.inputs.text;"string"==typeof e&&e.length>20&&!f.positive_prompt&&(f.positive_prompt=e)}if("LoadImage"===e&&a.inputs.image){const e=a.inputs.image;g.reference_image||(g.reference_image=e)}}let v=0;o&&o.id!==ce&&(re.current=!0,de(o.id),v++),Object.keys(f).length>0&&(Ee(e=>{const t={...e,...f};return Bt.current=t,t}),v+=Object.keys(f).length);const y=Object.keys(g).length;if(y>0){const e=Rt.filter(e=>"online"===e.status);if(e.length>0){const t=e[0].url.replace(/\/$/,"");for(const[e,n]of Object.entries(g))try{const a=`${t}/view?filename=${encodeURIComponent(n)}&type=input`,r=await fetch(a);if(r.ok){const t=await r.blob(),n=await new Promise(e=>{const n=new FileReader;n.onloadend=()=>e(n.result),n.readAsDataURL(t)});f[e]=n,v++}}catch(c){console.warn(`Could not fetch image ${n}:`,c)}Object.keys(g).some(e=>f[e])&&Ee(e=>{const t={...e,...f};return Bt.current=t,t})}}if(v>0){const e=o?`workflow "${o.name||o.id}"`:"",t=`${Object.keys(f).length} parameters`;p(`Restored ${e?e+", ":""}${t}${y>0?`, ${y} images`:""}`)}else h("No parameters could be extracted from PNG")}catch(c){console.error("Failed to restore from PNG:",c),u("Failed to restore parameters")}Je(e=>({...e,visible:!1}))},disabled:!Ye.panelId||0===(null==(c=w.find(e=>e.id===Ye.panelId))?void 0:c.imageHistory.length),children:[Ut.jsx(dk,{size:14})," Restore Parameters"]})]}),Re&&Le&&Ut.jsxs("div",{ref:Ke,className:"image-viewer-overlay",onClick:Vn,tabIndex:0,onKeyDown:e=>{if("Escape"===e.key)e.preventDefault(),Vn();else if("ArrowLeft"===e.key){if(e.preventDefault(),Ue){const e=w.find(e=>e.id===Ue);e&&e.historyIndex>0&&Wn(-1)}}else if("ArrowRight"===e.key){if(e.preventDefault(),Ue){const e=w.find(e=>e.id===Ue);e&&e.historyIndex<e.imageHistory.length-1&&Wn(1)}}else if("Delete"===e.key&&(e.preventDefault(),Ue)){const e=w.find(e=>e.id===Ue);if(e&&e.historyIndex>=0&&e.imageHistory.length>0){const t=e.imageHistory[e.historyIndex];t&&Ma(Ue,t.id)}}},children:[Ut.jsxs("div",{className:"image-viewer-toolbar",children:[Ut.jsx("div",{className:"toolbar-group",children:Ue&&(()=>{const e=w.find(e=>e.id===Ue);return e&&e.imageHistory.length>1?Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("button",{className:"toolbar-btn",onClick:e=>{e.stopPropagation(),Wn(-1)},disabled:e.historyIndex<=0,title:"Previous version ()","aria-label":"Previous version",children:Ut.jsx(hE,{size:20})}),Ut.jsxs("span",{className:"viewer-version-badge",children:["v",e.historyIndex+1,"/",e.imageHistory.length]}),Ut.jsx("button",{className:"toolbar-btn",onClick:e=>{e.stopPropagation(),Wn(1)},disabled:e.historyIndex>=e.imageHistory.length-1,title:"Next version ()","aria-label":"Next version",children:Ut.jsx(pE,{size:20})})]}):null})()}),Ut.jsxs("div",{className:"toolbar-group zoom-controls",children:[Ut.jsx("button",{className:"toolbar-btn",onClick:e=>{e.stopPropagation(),Xn()},title:"Zoom Out (-)","aria-label":"Zoom out",children:Ut.jsx(Ak,{size:20})}),Ut.jsxs("span",{className:"zoom-percentage",children:[Math.round(100*Fe),"%"]}),Ut.jsx("button",{className:"toolbar-btn",onClick:e=>{e.stopPropagation(),Gn()},title:"Zoom In (+)","aria-label":"Zoom in",children:Ut.jsx(jk,{size:20})}),Ut.jsx("div",{className:"toolbar-separator"}),Ut.jsx("button",{className:"toolbar-btn "+("fit"===dt?"active":""),onClick:e=>{e.stopPropagation(),qn()},title:"Fit to Screen (F)","aria-label":"Fit to screen",children:Ut.jsx(KE,{size:20})}),Ut.jsx("button",{className:"toolbar-btn "+("actual"===dt?"active":""),onClick:e=>{e.stopPropagation(),Kn()},title:"Actual Size (1)","aria-label":"Actual size",children:Ut.jsx(SE,{size:20})})]}),Ut.jsxs("div",{className:"toolbar-group",children:[Ue&&(()=>{const e=w.find(e=>e.id===Ue);return e&&e.imageHistory.length>1?Ut.jsx("button",{className:"toolbar-btn "+($e?"active":""),onClick:e=>{e.stopPropagation(),Yn()},title:"Compare Mode (C)","aria-label":"Toggle compare mode",children:Ut.jsx(EE,{size:20})}):null})(),Ut.jsx("button",{className:"toolbar-btn "+(Ze?"active":""),onClick:e=>{e.stopPropagation(),Qe(e=>!e)},title:"Toggle Metadata Panel (I)","aria-label":"Toggle metadata panel",children:Ze?Ut.jsx(nk,{size:20}):Ut.jsx(ak,{size:20})}),Ut.jsx("div",{className:"toolbar-separator"}),Ue&&(()=>{const e=w.find(e=>e.id===Ue);return e&&e.historyIndex>=0&&e.imageHistory.length>0?Ut.jsx("button",{className:"toolbar-btn delete-btn",onClick:t=>{t.stopPropagation();const n=e.imageHistory[e.historyIndex];n&&Ma(Ue,n.id)},title:"Delete Image (Del)","aria-label":"Delete image",children:Ut.jsx(Ck,{size:20})}):null})(),Ut.jsx("button",{className:"toolbar-btn close-btn",onClick:e=>{e.stopPropagation(),Vn()},title:"Close (Esc)","aria-label":"Close viewer",children:Ut.jsx(Nk,{size:20})})]})]}),$e&&Ue&&Ut.jsxs("div",{className:"image-viewer-compare-selector",onClick:e=>e.stopPropagation(),children:[Ut.jsx("span",{children:"Compare with:"}),null==(d=w.find(e=>e.id===Ue))?void 0:d.imageHistory.map((e,t)=>Ut.jsxs("button",{onClick:()=>Ge(e.url),className:We===e.url?"active":"",disabled:e.url===Le,children:["v",t+1]},e.id))]}),Ut.jsxs("div",{className:"image-viewer-main",children:[Ut.jsxs("div",{ref:ht,className:"image-viewer-container",style:{flex:1,display:"flex",flexDirection:"row"},onClick:e=>e.stopPropagation(),children:[Ue&&(()=>{const e=w.find(e=>e.id===Ue);return!e||e.imageHistory.length<=1?null:Ut.jsx("div",{className:"thumbnail-strip-vertical",onClick:e=>e.stopPropagation(),children:e.imageHistory.map((t,n)=>{var a;return Ut.jsxs("div",{className:"thumbnail-item "+(n===e.historyIndex?"active":""),onClick:()=>{De(t.url),S(e=>e.map(e=>{var t;return e.id===Ue?{...e,historyIndex:n,image:(null==(t=e.imageHistory[n])?void 0:t.url)||null}:e}))},children:[Vk(t.url)?Ut.jsx("video",{src:t.url,muted:!0,playsInline:!0,preload:"metadata",style:{maxHeight:256,maxWidth:256,objectFit:"contain"},draggable:!1}):Ut.jsx("img",{src:t.url,alt:`Version ${n+1}`,style:{maxHeight:256,maxWidth:256,objectFit:"contain"},draggable:!1}),Ut.jsx("span",{className:"thumbnail-filename",children:(null==(a=t.metadata)?void 0:a.savedPath)?t.metadata.savedPath.split(/[\\\/]/).pop():`v${String(n+1).padStart(3,"0")}`})]},t.id)})})})(),Ut.jsxs("div",{className:"image-viewer-main-area",onWheel:e=>{e.stopPropagation();const t=e.deltaY>0?-.1:.1;ut("custom"),ze(e=>pR(e+t))},onMouseDown:e=>{if(0!==e.button||$e)return;const t=e.clientX-Be.x,n=e.clientY-Be.y,a=e=>{He({x:e.clientX-t,y:e.clientY-n})},r=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",r)},children:[!$e&&Ut.jsxs(Ut.Fragment,{children:[Vk(Le)?Ut.jsx("video",{src:Le,controls:!0,loop:!0,autoPlay:!0,playsInline:!0,style:{transform:`translate(${Be.x}px, ${Be.y}px) scale(${Fe})`,cursor:"grab",maxWidth:"100%",maxHeight:"calc(100% - 30px)",objectFit:"contain"},draggable:!1,onError:e=>{console.error("[ImageViewer] Failed to load video:",Le),console.error("[ImageViewer] Error event:",e)},onLoadedData:()=>{console.log("[ImageViewer] Video loaded successfully")}}):Ut.jsx("img",{src:Le,alt:"Viewer",style:{transform:`translate(${Be.x}px, ${Be.y}px) scale(${Fe})`,cursor:"grab",maxWidth:"100%",maxHeight:"calc(100% - 30px)",objectFit:"contain"},draggable:!1,onError:e=>{console.error("[ImageViewer] Failed to load image:",Le),console.error("[ImageViewer] Error event:",e)},onLoad:()=>{console.log("[ImageViewer] Image loaded successfully")}}),Ue&&(()=>{var e;const t=w.find(e=>e.id===Ue),n=null==t?void 0:t.imageHistory[t.historyIndex],a=(null==(e=null==n?void 0:n.metadata)?void 0:e.savedPath)?n.metadata.savedPath.split(/[\\\/]/).pop():(null==Le?void 0:Le.split(/[\\\/]/).pop())||"Unknown";return Ut.jsx("div",{className:"image-viewer-filename",children:a})})()]}),$e&&We&&Ut.jsxs("div",{className:"image-compare-container",onMouseMove:e=>{const t=e.currentTarget.getBoundingClientRect(),n=(e.clientX-t.left)/t.width*100;qe(Math.max(0,Math.min(100,n)))},children:[Ut.jsx("img",{src:Le,alt:"Current",className:"compare-base",draggable:!1}),Ut.jsx("div",{className:"compare-overlay",style:{clipPath:`inset(0 ${100-Xe}% 0 0)`},children:Ut.jsx("img",{src:We,alt:"Compare",draggable:!1})}),Ut.jsx("div",{className:"compare-slider",style:{left:`${Xe}%`},children:Ut.jsx("div",{className:"compare-slider-handle",children:""})})]})]})," "]})," ",Ze&&Ue&&(()=>{const e=w.find(e=>e.id===Ue),t=null==e?void 0:e.imageHistory[e.historyIndex];if(!t)return null;const n=t.metadata,a=st&&(st.prompt||st.workflow)?(()=>{if(!(null==st?void 0:st.prompt))return{seed:null,prompt:null,model:null,workflowName:null,steps:null,cfg:null,sampler:null,scheduler:null,denoise:null};const e=st.prompt;let t=null,n=null,a=null,r=null,i=null,s=null,o=null,l=null,c=null;for(const[d,u]of Object.entries(e)){if(!u.inputs)continue;const e=u.class_type||"";if((e.includes("KSampler")||e.includes("Sampler"))&&(void 0!==u.inputs.seed&&null===t&&(t=u.inputs.seed),void 0!==u.inputs.steps&&null===i&&(i=u.inputs.steps),void 0!==u.inputs.cfg&&null===s&&(s=u.inputs.cfg),u.inputs.sampler_name&&!o&&(o=u.inputs.sampler_name),u.inputs.scheduler&&!l&&(l=u.inputs.scheduler),void 0!==u.inputs.denoise&&null===c&&(c=u.inputs.denoise),u.inputs.positive_prompt&&!n)){const e=u.inputs.positive_prompt;"string"==typeof e&&e.length>10&&(n=e)}if("CLIPTextEncode"===e&&u.inputs.text&&!n){const e=u.inputs.text;"string"==typeof e&&e.length>20&&(n=e)}if(e.includes("TextEncode")&&!n){const e=u.inputs.prompt||u.inputs.text;"string"==typeof e&&e.length>20&&(n=e)}"UnetLoaderGGUF"===e&&u.inputs.unet_name&&!a&&(a=u.inputs.unet_name),"UNETLoader"===e&&u.inputs.unet_name&&!a&&(a=u.inputs.unet_name),"CheckpointLoaderSimple"!==e&&"CheckpointLoader"!==e||!u.inputs.ckpt_name||a||(a=u.inputs.ckpt_name),"UpscaleModelLoader"===e&&u.inputs.model_name&&!a&&(a=u.inputs.model_name),e.includes("Loader")&&!a&&(u.inputs.unet_name?a=u.inputs.unet_name:u.inputs.ckpt_name?a=u.inputs.ckpt_name:u.inputs.model_name&&(a=u.inputs.model_name)),"SaveImage"===e&&u.inputs.filename_prefix&&!r&&(r=u.inputs.filename_prefix)}if(!r&&st.workflow){r=st.workflow.name||null}return{seed:t,prompt:n,model:a,workflowName:r,steps:i,cfg:s,sampler:o,scheduler:l,denoise:c}})():null,r=(e=>{if(!e)return{steps:null,cfg:null,sampler:null,scheduler:null,denoise:null,model:null};console.log("[Metadata] Entry parameters:",Object.keys(e),e);const t=t=>{for(const n of t){if(void 0!==e[n])return e[n];for(const[t,a]of Object.entries(e))if((t.startsWith(n+"_")||t===n)&&void 0!==a)return a}return null};return{steps:t(["steps"]),cfg:t(["cfg","cfg_scale","guidance_scale"]),sampler:t(["sampler_name","sampler"]),scheduler:t(["scheduler"]),denoise:t(["denoise","denoising_strength"]),model:t(["ckpt_name","unet_name","model_name","model"])}})(null==n?void 0:n.parameters),i=(null==n?void 0:n.seed)??(null==a?void 0:a.seed)??null,s=(null==n?void 0:n.promptSummary)||(null==a?void 0:a.prompt)||null,o=(null==r?void 0:r.model)||function(e){if(!e)return;const t=["model","ckpt_name","checkpoint","model_name","unet_name","clip_name","vae_name"];for(const n of t){const t=e[n];if("string"==typeof t&&t.trim()){const e=t.split(/[\\/]/);return e[e.length-1].replace(/\.(safetensors|ckpt|pt|pth|bin)$/i,"")}}for(const[n,a]of Object.entries(e))if("string"==typeof a&&a.trim())for(const e of t)if(n.toLowerCase().includes(e)){const e=a.split(/[\\/]/);return e[e.length-1].replace(/\.(safetensors|ckpt|pt|pth|bin)$/i,"")}}(null==n?void 0:n.parameters)||(null==a?void 0:a.model)||null,l=(null==n?void 0:n.workflowName)||(null==a?void 0:a.workflowName)||"Unknown",c=(null==n?void 0:n.nodeName)||null,d=(null==n?void 0:n.generationTime)||null,u=(null==n?void 0:n.timestamp)||null,h=(null==n?void 0:n.version)??(void 0!==(null==e?void 0:e.historyIndex)?e.historyIndex+1:1),p=(null==r?void 0:r.steps)??(null==a?void 0:a.steps)??null,m=(null==r?void 0:r.cfg)??(null==a?void 0:a.cfg)??null,f=(null==r?void 0:r.sampler)??(null==a?void 0:a.sampler)??null,g=(null==r?void 0:r.scheduler)??(null==a?void 0:a.scheduler)??null,v=(null==r?void 0:r.denoise)??(null==a?void 0:a.denoise)??null,y=function(e,t){if(t)return`${t.width}${t.height}`;if(!e)return;const n=e.width||e.image_width,a=e.height||e.image_height;return"number"==typeof n&&"number"==typeof a?`${n}${a}`:void 0}(null==n?void 0:n.parameters,nt),x=function(e){if(null==e||isNaN(e))return"Unknown";const t=["B","KB","MB","GB"];let n=e,a=0;for(;n>=1024&&a<t.length-1;)n/=1024,a++;return`${n.toFixed(0===a?0:1)} ${t[a]}`}(rt);return Ut.jsxs("div",{className:"image-viewer-metadata-panel",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"metadata-panel-header",children:[Ut.jsx($E,{size:16}),Ut.jsx("span",{children:"Image Info"}),lt&&Ut.jsx("span",{className:"metadata-loading",children:"Loading..."}),Ut.jsx("button",{className:"metadata-toggle-btn",onClick:()=>Qe(!1),title:"Hide metadata panel","aria-label":"Hide metadata panel",children:Ut.jsx(nk,{size:14})})]}),Ut.jsxs("div",{className:"metadata-panel-content",children:[Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Resolution"}),Ut.jsx("span",{className:"metadata-value",children:y||"Unknown"})]}),Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"File Size"}),Ut.jsx("span",{className:"metadata-value",children:x})]}),Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Workflow"}),Ut.jsx("span",{className:"metadata-value workflow-name",title:l,children:l})]}),o&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Model"}),Ut.jsx("span",{className:"metadata-value model-name",title:o,children:o})]}),Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Seed"}),Ut.jsx("span",{className:"metadata-value",children:null!==i&&-1!==i?i:"Unknown"})]}),null!==p&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Steps"}),Ut.jsx("span",{className:"metadata-value",children:p})]}),null!==m&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"CFG"}),Ut.jsx("span",{className:"metadata-value",children:m})]}),f&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Sampler"}),Ut.jsx("span",{className:"metadata-value",children:f})]}),g&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Scheduler"}),Ut.jsx("span",{className:"metadata-value",children:g})]}),null!==v&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Denoise"}),Ut.jsx("span",{className:"metadata-value",children:v})]}),c&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Render Node"}),Ut.jsx("span",{className:"metadata-value",children:c})]}),d&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Render Time"}),Ut.jsxs("span",{className:"metadata-value",children:[d.toFixed(1),"s"]})]}),u&&Ut.jsxs("div",{className:"metadata-row",children:[Ut.jsx("span",{className:"metadata-label",children:"Created"}),Ut.jsx("span",{className:"metadata-value",children:mR(u)||"Unknown"})]}),s&&Ut.jsxs("div",{className:"metadata-prompt-section",children:[Ut.jsx("div",{className:"metadata-label",children:"Prompt"}),Ut.jsx("div",{className:"metadata-prompt-text "+(et?"expanded":""),children:et?s:hR(s,150)}),s.length>150&&Ut.jsx("button",{className:"show-more-btn",onClick:()=>tt(e=>!e),children:et?"Show less":"Show more"})]}),Ut.jsxs("div",{className:"metadata-footer",children:["Version ",h,"  Panel ",Ue]})]})]})})()]})]})]})}const SR=Am(e=>({viewMode:"grid",sortField:"name",sortDirection:"asc",secondarySortField:"none",secondarySortDirection:"asc",thumbnailSize:200,groupByFolder:!1,currentPath:"",folderTree:[],currentFiles:[],expandedFolders:new Set,breadcrumbs:[],selectedFiles:new Set,lastSelectedFile:null,filterType:"all",filterRating:0,filterTags:[],searchQuery:"",allTags:[],ratings:{},isLoading:!1,isLoadingFiles:!1,error:null,detailFile:null,showDetailPanel:!1,showTrashBin:!1,showSearchPanel:!1,lightboxFile:null,compareFiles:null,showDuplicateFinder:!1,showTimeline:!1,setViewMode:t=>e({viewMode:t}),setSortField:t=>e({sortField:t}),setSortDirection:t=>e({sortDirection:t}),setSecondarySortField:t=>e({secondarySortField:t}),setSecondarySortDirection:t=>e({secondarySortDirection:t}),setThumbnailSize:t=>e({thumbnailSize:t}),setGroupByFolder:t=>e({groupByFolder:t}),setCurrentPath:t=>e({currentPath:t}),setFolderTree:t=>e({folderTree:t}),setCurrentFiles:t=>e({currentFiles:t}),toggleFolder:t=>e(e=>{const n=new Set(e.expandedFolders);return n.has(t)?n.delete(t):n.add(t),{expandedFolders:n}}),setBreadcrumbs:t=>e({breadcrumbs:t}),selectFile:t=>e(e=>{const n=new Set(e.selectedFiles);return n.add(t),{selectedFiles:n,lastSelectedFile:t}}),deselectFile:t=>e(e=>{const n=new Set(e.selectedFiles);return n.delete(t),{selectedFiles:n}}),toggleFileSelection:t=>e(e=>{const n=new Set(e.selectedFiles);return n.has(t)?n.delete(t):n.add(t),{selectedFiles:n,lastSelectedFile:t}}),selectAll:t=>e({selectedFiles:new Set(t)}),clearSelection:()=>e({selectedFiles:new Set,lastSelectedFile:null}),setFilterType:t=>e({filterType:t}),setFilterRating:t=>e({filterRating:t}),setFilterTags:t=>e({filterTags:t}),setSearchQuery:t=>e({searchQuery:t}),setAllTags:t=>e({allTags:t}),setRatings:t=>e({ratings:t}),updateRating:(t,n)=>e(e=>({ratings:{...e.ratings,[t]:n}})),setIsLoading:t=>e({isLoading:t}),setIsLoadingFiles:t=>e({isLoadingFiles:t}),setError:t=>e({error:t}),setDetailFile:t=>e({detailFile:t}),setShowDetailPanel:t=>e({showDetailPanel:t}),setShowTrashBin:t=>e({showTrashBin:t}),setShowSearchPanel:t=>e({showSearchPanel:t}),setLightboxFile:t=>e({lightboxFile:t}),setCompareFiles:t=>e({compareFiles:t}),setShowDuplicateFinder:t=>e({showDuplicateFinder:t}),setShowTimeline:t=>e({showTimeline:t}),resetGallery:()=>e({viewMode:"grid",sortField:"name",sortDirection:"asc",secondarySortField:"none",secondarySortDirection:"asc",thumbnailSize:200,groupByFolder:!1,currentPath:"",folderTree:[],currentFiles:[],expandedFolders:new Set,breadcrumbs:[],selectedFiles:new Set,lastSelectedFile:null,filterType:"all",filterRating:0,filterTags:[],searchQuery:"",allTags:[],ratings:{},isLoading:!1,isLoadingFiles:!1,error:null,detailFile:null,showDetailPanel:!1,showTrashBin:!1,showSearchPanel:!1,lightboxFile:null,compareFiles:null,showDuplicateFinder:!1,showTimeline:!1})}));function MR(e){const t=e.replace(/\\/g,"/").replace(/\/$/,""),n=t.lastIndexOf("/");return n<=0?"":t.substring(0,n)}function CR({node:e,depth:t,currentPath:n,expandedFolders:a,onToggle:r,onNavigate:i,onDropFiles:s,onCreateFolder:o}){const{folder:l,children:c}=e,d=a.has(l.path),u=l.path===n,h=c.length>0,[p,m]=Tt.useState(!1),f=Tt.useRef(0),[g,v]=Tt.useState(!1),[y,x]=Tt.useState({x:0,y:0}),[b,_]=Tt.useState(!1),[w,S]=Tt.useState(""),M=Tt.useRef(null);Tt.useEffect(()=>{b&&M.current&&(M.current.focus(),M.current.select())},[b]),Tt.useEffect(()=>{if(g)return document.addEventListener("click",e),()=>document.removeEventListener("click",e);function e(){v(!1)}},[g]);const C=Tt.useCallback(e=>{e.stopPropagation(),r(l.path)},[l.path,r]),E=Tt.useCallback(()=>{i(l.path)},[l.path,i]),k=Tt.useCallback(e=>{e.preventDefault(),e.stopPropagation(),v(!0),x({x:e.clientX,y:e.clientY})},[]),T=Tt.useCallback(()=>{v(!1),_(!0),S("New Folder")},[]),N=Tt.useCallback(()=>{var e;const t=(null==(e=M.current)?void 0:e.value.trim())||"";_(!1),S(""),t&&o&&o(l.path,t).catch(()=>{})},[o,l.path]),P=Tt.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),N()):"Escape"===e.key&&(_(!1),S(""))},[N]),j=Tt.useCallback(e=>e.dataTransfer.types.includes("application/x-storyboard-image")||e.dataTransfer.types.includes("text/plain"),[]),A=Tt.useCallback(e=>{e.preventDefault(),e.stopPropagation(),f.current+=1,j(e)&&(e.dataTransfer.dropEffect="move",m(!0))},[j]),R=Tt.useCallback(e=>{j(e)&&(e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="move")},[j]),I=Tt.useCallback(e=>{e.stopPropagation(),f.current-=1,f.current<=0&&(f.current=0,m(!1))},[]),L=Tt.useCallback(e=>{if(e.preventDefault(),e.stopPropagation(),f.current=0,m(!1),!s)return;const t=e.dataTransfer.getData("application/x-storyboard-image")||e.dataTransfer.getData("text/plain");if(t)try{const e=JSON.parse(t);e.filePath&&s([e.filePath],l.path)}catch{}},[l.path,s]),D=["folder-tree-item",u?"folder-tree-item--active":"",p?"folder-tree-item--drag-over":""].filter(Boolean).join(" ");return Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{className:D,style:{paddingLeft:16*t+8+"px"},onClick:E,onContextMenu:k,onDragEnter:A,onDragOver:R,onDragLeave:I,onDrop:L,children:[Ut.jsx("span",{className:"folder-tree-chevron"+(h?"":" folder-tree-chevron--empty"),onClick:h?C:void 0,children:h&&(d?Ut.jsx(uE,{size:14}):Ut.jsx(pE,{size:14}))}),Ut.jsx("span",{className:"folder-tree-icon",children:u&&d?Ut.jsx(RE,{size:15}):Ut.jsx(LE,{size:15})}),Ut.jsx("span",{className:"folder-tree-name",children:l.name}),l.file_count>0&&Ut.jsx("span",{className:"folder-tree-count",children:l.file_count})]}),d&&c.map(e=>Ut.jsx(CR,{node:e,depth:t+1,currentPath:n,expandedFolders:a,onToggle:r,onNavigate:i,onDropFiles:s,onCreateFolder:o},e.folder.path)),g&&Wh.createPortal(Ut.jsx("div",{className:"folder-tree-context-menu",style:{position:"fixed",top:y.y,left:y.x,zIndex:1e4,background:"var(--color-bg-secondary, #1e1e2e)",border:"1px solid var(--color-border, #333)",borderRadius:6,padding:"4px 0",boxShadow:"0 8px 24px rgba(0,0,0,0.4)",minWidth:160},onClick:e=>e.stopPropagation(),children:Ut.jsxs("div",{className:"folder-tree-context-menu-item",style:{padding:"6px 14px",cursor:"pointer",fontSize:13,color:"var(--color-text, #e0e0e0)",display:"flex",alignItems:"center",gap:8},onMouseEnter:e=>{e.currentTarget.style.background="var(--color-bg-hover, rgba(255,255,255,0.06))"},onMouseLeave:e=>{e.currentTarget.style.background="transparent"},onClick:T,children:[Ut.jsx(IE,{size:14}),"New Folder"]})}),document.body),b&&Ut.jsx("div",{className:"folder-tree-new-folder",style:{paddingLeft:16*(t+1)+8+"px",padding:"2px 8px 2px"},children:Ut.jsx("input",{ref:M,className:"folder-tree-new-folder-input",style:{width:"100%",padding:"3px 6px",fontSize:12,background:"var(--color-bg-primary, #141420)",color:"var(--color-text, #e0e0e0)",border:"1px solid var(--color-accent, #5b9aff)",borderRadius:3,outline:"none",boxSizing:"border-box"},value:w,onChange:e=>S(e.target.value),onKeyDown:P,onBlur:()=>{_(!1),S("")},placeholder:"Folder name"})})]})}function ER({folders:e,currentPath:t,projectPath:n,onNavigate:a,onDropFiles:r,onCreateFolder:i}){const{expandedFolders:s,toggleFolder:o}=SR(),l=Tt.useMemo(()=>function(e,t){const n=new Map;for(const i of e){const e=i.path.replace(/\\/g,"/").replace(/\/$/,"");n.set(e,{folder:i,children:[]})}const a=[],r=t.replace(/\\/g,"/").replace(/\/$/,"");for(const i of e){const e=i.path.replace(/\\/g,"/").replace(/\/$/,""),t=MR(e);if(e!==r&&""!==t&&n.has(t)){const a=n.get(t),r=n.get(e);a&&r&&a.children.push(r)}else{const t=n.get(e);t&&a.push(t)}}return function e(t){t.sort((e,t)=>e.folder.name.localeCompare(t.folder.name));for(const n of t)e(n.children)}(a),a}(e,n),[e,n]);return Ut.jsxs("div",{className:"folder-tree",children:[l.map(e=>Ut.jsx(CR,{node:e,depth:0,currentPath:t,expandedFolders:s,onToggle:o,onNavigate:a,onDropFiles:r,onCreateFolder:i},e.folder.path)),0===l.length&&Ut.jsx("div",{style:{padding:"12px 16px",color:"var(--color-text-muted, #666)",fontSize:12},children:"No folders found"})]})}function kR({crumbs:e,onNavigate:t}){if(0===e.length)return null;const n=e.length-1;return Ut.jsx("nav",{className:"gallery-breadcrumb","aria-label":"Folder breadcrumb",children:e.map((e,a)=>{const r=a===n,i=0===a;return Ut.jsxs("span",{style:{display:"flex",alignItems:"center",gap:"4px"},children:[a>0&&Ut.jsx("span",{className:"gallery-breadcrumb-separator","aria-hidden":"true",children:Ut.jsx(pE,{size:12})}),r?Ut.jsxs("span",{className:"gallery-breadcrumb-current",children:[i&&Ut.jsx(zE,{size:13}),e.name]}):Ut.jsxs("button",{className:"gallery-breadcrumb-segment",onClick:()=>t(e.path),type:"button",children:[i&&Ut.jsx(zE,{size:13}),e.name]})]},e.path)})})}const TR=[{value:"name",label:"Name"},{value:"modified",label:"Modified"},{value:"created",label:"Created"},{value:"size",label:"Size"},{value:"type",label:"Type"},{value:"rating",label:"Rating"}],NR=[{value:"none",label:" None "},{value:"name",label:"Name"},{value:"modified",label:"Modified"},{value:"created",label:"Created"},{value:"size",label:"Size"},{value:"type",label:"Type"},{value:"rating",label:"Rating"}];function PR({onRefresh:e}){const{viewMode:t,setViewMode:n,thumbnailSize:a,setThumbnailSize:r,sortField:i,setSortField:s,sortDirection:o,setSortDirection:l,secondarySortField:c,setSecondarySortField:d,secondarySortDirection:u,setSecondarySortDirection:h,filterType:p,setFilterType:m,filterRating:f,setFilterRating:g,showTrashBin:v,setShowTrashBin:y,showSearchPanel:x,setShowSearchPanel:b,showDetailPanel:_,setShowDetailPanel:w,setDetailFile:S,selectedFiles:M}=SR(),C=Tt.useCallback(e=>{s(e.target.value)},[s]),E=Tt.useCallback(()=>{l("asc"===o?"desc":"asc")},[o,l]),k=Tt.useCallback(e=>{d(e.target.value)},[d]),T=Tt.useCallback(()=>{h("asc"===u?"desc":"asc")},[u,h]),N=Tt.useCallback(e=>{r(Number(e.target.value))},[r]),P=Tt.useCallback(e=>{g(f===e?0:e)},[f,g]),j=Tt.useCallback(()=>{if(_)w(!1),S(null);else{if(1===M.size){const e=SR.getState().currentFiles,t=Array.from(M)[0],n=e.find(e=>e.path===t);n&&S(n)}w(!0)}},[_,w,S,M]);function A(e,a,r){return Ut.jsx("button",{className:"gallery-toolbar-btn"+(t===e?" gallery-toolbar-btn--active":""),onClick:()=>n(e),title:r,type:"button",children:a})}function R(e,t,n){return Ut.jsx("button",{className:"gallery-toolbar-btn"+(p===e?" gallery-toolbar-btn--active":""),onClick:()=>m(e),title:n,type:"button",children:t})}return Ut.jsxs("div",{className:"gallery-toolbar",children:[Ut.jsxs("div",{className:"gallery-toolbar-group",children:[A("grid",Ut.jsx(UE,{size:15}),"Grid view"),A("list",Ut.jsx(GE,{size:15}),"List view"),A("masonry",Ut.jsx(WE,{size:15}),"Masonry view")]}),Ut.jsx("div",{className:"gallery-toolbar-separator"}),Ut.jsxs("div",{className:"gallery-toolbar-group",style:{gap:"6px"},children:[Ut.jsx("span",{className:"gallery-toolbar-label",children:"Size"}),Ut.jsx("input",{className:"gallery-thumbnail-slider",type:"range",min:80,max:400,value:a,onChange:N,title:`Thumbnail size: ${a}px`})]}),Ut.jsx("div",{className:"gallery-toolbar-separator"}),Ut.jsxs("div",{className:"gallery-toolbar-group",style:{gap:"4px"},children:[Ut.jsx("select",{className:"gallery-toolbar-select",value:i,onChange:C,title:"Sort by",children:TR.map(e=>Ut.jsx("option",{value:e.value,children:e.label},e.value))}),Ut.jsx("button",{className:"gallery-toolbar-btn",onClick:E,title:"Sort "+("asc"===o?"ascending":"descending"),type:"button",children:"asc"===o?Ut.jsx(oE,{size:15}):Ut.jsx(rE,{size:15})}),Ut.jsx("span",{className:"gallery-toolbar-label",style:{marginLeft:"4px"},children:"then"}),Ut.jsx("select",{className:"gallery-toolbar-select",value:c,onChange:k,title:"Secondary sort",children:NR.map(e=>Ut.jsx("option",{value:e.value,children:e.label},e.value))}),"none"!==c&&Ut.jsx("button",{className:"gallery-toolbar-btn",onClick:T,title:"Secondary sort "+("asc"===u?"ascending":"descending"),type:"button",children:"asc"===u?Ut.jsx(oE,{size:15}):Ut.jsx(rE,{size:15})})]}),Ut.jsx("div",{className:"gallery-toolbar-separator"}),Ut.jsxs("div",{className:"gallery-toolbar-group",children:[R("all",Ut.jsx(DE,{size:15}),"Show all"),R("image",Ut.jsx(HE,{size:15}),"Images only"),R("video",Ut.jsx(jE,{size:15}),"Videos only")]}),Ut.jsx("div",{className:"gallery-toolbar-star-filter",title:"Minimum rating filter",children:[1,2,3,4,5].map(e=>Ut.jsx("span",{className:"gallery-toolbar-star"+(e<=f?" gallery-toolbar-star--filled":""),onClick:()=>P(e),children:Ut.jsx(bk,{size:14,fill:e<=f?"#f5c542":"none"})},e))}),Ut.jsx("div",{className:"gallery-toolbar-separator"}),Ut.jsxs("div",{className:"gallery-toolbar-group",children:[Ut.jsx("button",{className:"gallery-toolbar-btn",onClick:e,title:"Refresh",type:"button",children:Ut.jsx(ck,{size:15})}),Ut.jsx("button",{className:"gallery-toolbar-btn"+(x?" gallery-toolbar-btn--active":""),title:"Search",type:"button",onClick:()=>b(!x),children:Ut.jsx(mk,{size:15})}),Ut.jsx("button",{className:"gallery-toolbar-btn"+(v?" gallery-toolbar-btn--active":""),onClick:()=>y(!v),title:"Toggle trash bin",type:"button",children:Ut.jsx(Ck,{size:15})}),Ut.jsx("button",{className:"gallery-toolbar-btn"+(_?" gallery-toolbar-btn--active":""),onClick:j,title:"Toggle detail panel (Ctrl+I)",type:"button",children:Ut.jsx($E,{size:15})})]}),M.size>0&&Ut.jsxs("span",{className:"gallery-toolbar-selection-count",children:[M.size," selected"]})]})}function jR(e,t,n){let a,r=n.initialDeps??[],i=!0;function s(){var s,o,l;let c;n.key&&(null==(s=n.debug)?void 0:s.call(n))&&(c=Date.now());const d=e();if(!(d.length!==r.length||d.some((e,t)=>r[t]!==e)))return a;let u;if(r=d,n.key&&(null==(o=n.debug)?void 0:o.call(n))&&(u=Date.now()),a=t(...d),n.key&&(null==(l=n.debug)?void 0:l.call(n))){const e=Math.round(100*(Date.now()-c))/100,t=Math.round(100*(Date.now()-u))/100,a=t/16,r=(e,t)=>{for(e=String(e);e.length<t;)e=" "+e;return e};console.info(`%c ${r(t,5)} /${r(e,5)} ms`,`\n            font-size: .6rem;\n            font-weight: bold;\n            color: hsl(${Math.max(0,Math.min(120-120*a,120))}deg 100% 31%);`,null==n?void 0:n.key)}return!(null==n?void 0:n.onChange)||i&&n.skipInitialOnChange||n.onChange(a),i=!1,a}return s.updateDeps=e=>{r=e},s}function AR(e,t){if(void 0===e)throw new Error("Unexpected undefined");return e}const RR=(e,t,n)=>{let a;return function(...r){e.clearTimeout(a),a=e.setTimeout(()=>t.apply(this,r),n)}},IR=e=>{const{offsetWidth:t,offsetHeight:n}=e;return{width:t,height:n}},LR=e=>e,DR=e=>{const t=Math.max(e.startIndex-e.overscan,0),n=Math.min(e.endIndex+e.overscan,e.count-1),a=[];for(let r=t;r<=n;r++)a.push(r);return a},UR=(e,t)=>{const n=e.scrollElement;if(!n)return;const a=e.targetWindow;if(!a)return;const r=e=>{const{width:n,height:a}=e;t({width:Math.round(n),height:Math.round(a)})};if(r(IR(n)),!a.ResizeObserver)return()=>{};const i=new a.ResizeObserver(t=>{const a=()=>{const e=t[0];if(null==e?void 0:e.borderBoxSize){const t=e.borderBoxSize[0];if(t)return void r({width:t.inlineSize,height:t.blockSize})}r(IR(n))};e.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(a):a()});return i.observe(n,{box:"border-box"}),()=>{i.unobserve(n)}},OR={passive:!0},FR="undefined"==typeof window||"onscrollend"in window,zR=(e,t)=>{const n=e.scrollElement;if(!n)return;const a=e.targetWindow;if(!a)return;let r=0;const i=e.options.useScrollendEvent&&FR?()=>{}:RR(a,()=>{t(r,!1)},e.options.isScrollingResetDelay),s=a=>()=>{const{horizontal:s,isRtl:o}=e.options;r=s?n.scrollLeft*(o?-1:1):n.scrollTop,i(),t(r,a)},o=s(!0),l=s(!1);n.addEventListener("scroll",o,OR);const c=e.options.useScrollendEvent&&FR;return c&&n.addEventListener("scrollend",l,OR),()=>{n.removeEventListener("scroll",o),c&&n.removeEventListener("scrollend",l)}},BR=(e,t,n)=>{if(null==t?void 0:t.borderBoxSize){const e=t.borderBoxSize[0];if(e){return Math.round(e[n.options.horizontal?"inlineSize":"blockSize"])}}return e[n.options.horizontal?"offsetWidth":"offsetHeight"]},HR=(e,{adjustments:t=0,behavior:n},a)=>{var r,i;const s=e+t;null==(i=null==(r=a.scrollElement)?void 0:r.scrollTo)||i.call(r,{[a.options.horizontal?"left":"top"]:s,behavior:n})};class $R{constructor(e){this.unsubs=[],this.scrollElement=null,this.targetWindow=null,this.isScrolling=!1,this.currentScrollToIndex=null,this.measurementsCache=[],this.itemSizeCache=new Map,this.laneAssignments=new Map,this.pendingMeasuredCacheIndexes=[],this.prevLanes=void 0,this.lanesChangedFlag=!1,this.lanesSettling=!1,this.scrollRect=null,this.scrollOffset=null,this.scrollDirection=null,this.scrollAdjustments=0,this.elementsCache=new Map,this.observer=(()=>{let e=null;const t=()=>e||(this.targetWindow&&this.targetWindow.ResizeObserver?e=new this.targetWindow.ResizeObserver(e=>{e.forEach(e=>{const t=()=>{this._measureElement(e.target,e)};this.options.useAnimationFrameWithResizeObserver?requestAnimationFrame(t):t()})}):null);return{disconnect:()=>{var n;null==(n=t())||n.disconnect(),e=null},observe:e=>{var n;return null==(n=t())?void 0:n.observe(e,{box:"border-box"})},unobserve:e=>{var n;return null==(n=t())?void 0:n.unobserve(e)}}})(),this.range=null,this.setOptions=e=>{Object.entries(e).forEach(([t,n])=>{void 0===n&&delete e[t]}),this.options={debug:!1,initialOffset:0,overscan:1,paddingStart:0,paddingEnd:0,scrollPaddingStart:0,scrollPaddingEnd:0,horizontal:!1,getItemKey:LR,rangeExtractor:DR,onChange:()=>{},measureElement:BR,initialRect:{width:0,height:0},scrollMargin:0,gap:0,indexAttribute:"data-index",initialMeasurementsCache:[],lanes:1,isScrollingResetDelay:150,enabled:!0,isRtl:!1,useScrollendEvent:!1,useAnimationFrameWithResizeObserver:!1,...e}},this.notify=e=>{var t,n;null==(n=(t=this.options).onChange)||n.call(t,this,e)},this.maybeNotify=jR(()=>(this.calculateRange(),[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]),e=>{this.notify(e)},{key:!1,debug:()=>this.options.debug,initialDeps:[this.isScrolling,this.range?this.range.startIndex:null,this.range?this.range.endIndex:null]}),this.cleanup=()=>{this.unsubs.filter(Boolean).forEach(e=>e()),this.unsubs=[],this.observer.disconnect(),this.scrollElement=null,this.targetWindow=null},this._didMount=()=>()=>{this.cleanup()},this._willUpdate=()=>{var e;const t=this.options.enabled?this.options.getScrollElement():null;if(this.scrollElement!==t){if(this.cleanup(),!t)return void this.maybeNotify();this.scrollElement=t,this.scrollElement&&"ownerDocument"in this.scrollElement?this.targetWindow=this.scrollElement.ownerDocument.defaultView:this.targetWindow=(null==(e=this.scrollElement)?void 0:e.window)??null,this.elementsCache.forEach(e=>{this.observer.observe(e)}),this.unsubs.push(this.options.observeElementRect(this,e=>{this.scrollRect=e,this.maybeNotify()})),this.unsubs.push(this.options.observeElementOffset(this,(e,t)=>{this.scrollAdjustments=0,this.scrollDirection=t?this.getScrollOffset()<e?"forward":"backward":null,this.scrollOffset=e,this.isScrolling=t,this.maybeNotify()})),this._scrollToOffset(this.getScrollOffset(),{adjustments:void 0,behavior:void 0})}},this.getSize=()=>this.options.enabled?(this.scrollRect=this.scrollRect??this.options.initialRect,this.scrollRect[this.options.horizontal?"width":"height"]):(this.scrollRect=null,0),this.getScrollOffset=()=>this.options.enabled?(this.scrollOffset=this.scrollOffset??("function"==typeof this.options.initialOffset?this.options.initialOffset():this.options.initialOffset),this.scrollOffset):(this.scrollOffset=null,0),this.getFurthestMeasurement=(e,t)=>{const n=new Map,a=new Map;for(let r=t-1;r>=0;r--){const t=e[r];if(n.has(t.lane))continue;const i=a.get(t.lane);if(null==i||t.end>i.end?a.set(t.lane,t):t.end<i.end&&n.set(t.lane,!0),n.size===this.options.lanes)break}return a.size===this.options.lanes?Array.from(a.values()).sort((e,t)=>e.end===t.end?e.index-t.index:e.end-t.end)[0]:void 0},this.getMeasurementOptions=jR(()=>[this.options.count,this.options.paddingStart,this.options.scrollMargin,this.options.getItemKey,this.options.enabled,this.options.lanes],(e,t,n,a,r,i)=>(void 0!==this.prevLanes&&this.prevLanes!==i&&(this.lanesChangedFlag=!0),this.prevLanes=i,this.pendingMeasuredCacheIndexes=[],{count:e,paddingStart:t,scrollMargin:n,getItemKey:a,enabled:r,lanes:i}),{key:!1}),this.getMeasurements=jR(()=>[this.getMeasurementOptions(),this.itemSizeCache],({count:e,paddingStart:t,scrollMargin:n,getItemKey:a,enabled:r,lanes:i},s)=>{if(!r)return this.measurementsCache=[],this.itemSizeCache.clear(),this.laneAssignments.clear(),[];if(this.laneAssignments.size>e)for(const d of this.laneAssignments.keys())d>=e&&this.laneAssignments.delete(d);this.lanesChangedFlag&&(this.lanesChangedFlag=!1,this.lanesSettling=!0,this.measurementsCache=[],this.itemSizeCache.clear(),this.laneAssignments.clear(),this.pendingMeasuredCacheIndexes=[]),0!==this.measurementsCache.length||this.lanesSettling||(this.measurementsCache=this.options.initialMeasurementsCache,this.measurementsCache.forEach(e=>{this.itemSizeCache.set(e.key,e.size)}));const o=this.lanesSettling?0:this.pendingMeasuredCacheIndexes.length>0?Math.min(...this.pendingMeasuredCacheIndexes):0;this.pendingMeasuredCacheIndexes=[],this.lanesSettling&&this.measurementsCache.length===e&&(this.lanesSettling=!1);const l=this.measurementsCache.slice(0,o),c=new Array(i).fill(void 0);for(let d=0;d<o;d++){const e=l[d];e&&(c[e.lane]=d)}for(let d=o;d<e;d++){const e=a(d),r=this.laneAssignments.get(d);let i,o;if(void 0!==r&&this.options.lanes>1){i=r;const e=c[i],a=void 0!==e?l[e]:void 0;o=a?a.end+this.options.gap:t+n}else{const e=1===this.options.lanes?l[d-1]:this.getFurthestMeasurement(l,d);o=e?e.end+this.options.gap:t+n,i=e?e.lane:d%this.options.lanes,this.options.lanes>1&&this.laneAssignments.set(d,i)}const u=s.get(e),h="number"==typeof u?u:this.options.estimateSize(d),p=o+h;l[d]={index:d,start:o,size:h,end:p,key:e,lane:i},c[i]=d}return this.measurementsCache=l,l},{key:!1,debug:()=>this.options.debug}),this.calculateRange=jR(()=>[this.getMeasurements(),this.getSize(),this.getScrollOffset(),this.options.lanes],(e,t,n,a)=>this.range=e.length>0&&t>0?function({measurements:e,outerSize:t,scrollOffset:n,lanes:a}){const r=e.length-1,i=t=>e[t].start;if(e.length<=a)return{startIndex:0,endIndex:r};let s=VR(0,r,i,n),o=s;if(1===a)for(;o<r&&e[o].end<n+t;)o++;else if(a>1){const i=Array(a).fill(0);for(;o<r&&i.some(e=>e<n+t);){const t=e[o];i[t.lane]=t.end,o++}const l=Array(a).fill(n+t);for(;s>=0&&l.some(e=>e>=n);){const t=e[s];l[t.lane]=t.start,s--}s=Math.max(0,s-s%a),o=Math.min(r,o+(a-1-o%a))}return{startIndex:s,endIndex:o}}({measurements:e,outerSize:t,scrollOffset:n,lanes:a}):null,{key:!1,debug:()=>this.options.debug}),this.getVirtualIndexes=jR(()=>{let e=null,t=null;const n=this.calculateRange();return n&&(e=n.startIndex,t=n.endIndex),this.maybeNotify.updateDeps([this.isScrolling,e,t]),[this.options.rangeExtractor,this.options.overscan,this.options.count,e,t]},(e,t,n,a,r)=>null===a||null===r?[]:e({startIndex:a,endIndex:r,overscan:t,count:n}),{key:!1,debug:()=>this.options.debug}),this.indexFromElement=e=>{const t=this.options.indexAttribute,n=e.getAttribute(t);return n?parseInt(n,10):(console.warn(`Missing attribute name '${t}={index}' on measured element.`),-1)},this._measureElement=(e,t)=>{const n=this.indexFromElement(e),a=this.measurementsCache[n];if(!a)return;const r=a.key,i=this.elementsCache.get(r);i!==e&&(i&&this.observer.unobserve(i),this.observer.observe(e),this.elementsCache.set(r,e)),e.isConnected&&this.resizeItem(n,this.options.measureElement(e,t,this))},this.resizeItem=(e,t)=>{const n=this.measurementsCache[e];if(!n)return;const a=t-(this.itemSizeCache.get(n.key)??n.size);0!==a&&((void 0!==this.shouldAdjustScrollPositionOnItemSizeChange?this.shouldAdjustScrollPositionOnItemSizeChange(n,a,this):n.start<this.getScrollOffset()+this.scrollAdjustments)&&this._scrollToOffset(this.getScrollOffset(),{adjustments:this.scrollAdjustments+=a,behavior:void 0}),this.pendingMeasuredCacheIndexes.push(n.index),this.itemSizeCache=new Map(this.itemSizeCache.set(n.key,t)),this.notify(!1))},this.measureElement=e=>{e?this._measureElement(e,void 0):this.elementsCache.forEach((e,t)=>{e.isConnected||(this.observer.unobserve(e),this.elementsCache.delete(t))})},this.getVirtualItems=jR(()=>[this.getVirtualIndexes(),this.getMeasurements()],(e,t)=>{const n=[];for(let a=0,r=e.length;a<r;a++){const r=t[e[a]];n.push(r)}return n},{key:!1,debug:()=>this.options.debug}),this.getVirtualItemForOffset=e=>{const t=this.getMeasurements();if(0!==t.length)return AR(t[VR(0,t.length-1,e=>AR(t[e]).start,e)])},this.getMaxScrollOffset=()=>{if(!this.scrollElement)return 0;if("scrollHeight"in this.scrollElement)return this.options.horizontal?this.scrollElement.scrollWidth-this.scrollElement.clientWidth:this.scrollElement.scrollHeight-this.scrollElement.clientHeight;{const e=this.scrollElement.document.documentElement;return this.options.horizontal?e.scrollWidth-this.scrollElement.innerWidth:e.scrollHeight-this.scrollElement.innerHeight}},this.getOffsetForAlignment=(e,t,n=0)=>{if(!this.scrollElement)return 0;const a=this.getSize(),r=this.getScrollOffset();"auto"===t&&(t=e>=r+a?"end":"start"),"center"===t?e+=(n-a)/2:"end"===t&&(e-=a);const i=this.getMaxScrollOffset();return Math.max(Math.min(i,e),0)},this.getOffsetForIndex=(e,t="auto")=>{e=Math.max(0,Math.min(e,this.options.count-1));const n=this.measurementsCache[e];if(!n)return;const a=this.getSize(),r=this.getScrollOffset();if("auto"===t)if(n.end>=r+a-this.options.scrollPaddingEnd)t="end";else{if(!(n.start<=r+this.options.scrollPaddingStart))return[r,t];t="start"}if("end"===t&&e===this.options.count-1)return[this.getMaxScrollOffset(),t];const i="end"===t?n.end+this.options.scrollPaddingEnd:n.start-this.options.scrollPaddingStart;return[this.getOffsetForAlignment(i,t,n.size),t]},this.isDynamicMode=()=>this.elementsCache.size>0,this.scrollToOffset=(e,{align:t="start",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getOffsetForAlignment(e,t),{adjustments:void 0,behavior:n})},this.scrollToIndex=(e,{align:t="auto",behavior:n}={})=>{"smooth"===n&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),e=Math.max(0,Math.min(e,this.options.count-1)),this.currentScrollToIndex=e;let a=0;const r=t=>{if(!this.targetWindow)return;const a=this.getOffsetForIndex(e,t);if(!a)return void console.warn("Failed to get offset for index:",e);const[r,s]=a;this._scrollToOffset(r,{adjustments:void 0,behavior:n}),this.targetWindow.requestAnimationFrame(()=>{const t=()=>{if(this.currentScrollToIndex!==e)return;const t=this.getScrollOffset(),n=this.getOffsetForIndex(e,s);n?((e,t)=>Math.abs(e-t)<1.01)(n[0],t)||i(s):console.warn("Failed to get offset for index:",e)};this.isDynamicMode()?this.targetWindow.requestAnimationFrame(t):t()})},i=t=>{this.targetWindow&&this.currentScrollToIndex===e&&(a++,a<10?this.targetWindow.requestAnimationFrame(()=>r(t)):console.warn(`Failed to scroll to index ${e} after 10 attempts.`))};r(t)},this.scrollBy=(e,{behavior:t}={})=>{"smooth"===t&&this.isDynamicMode()&&console.warn("The `smooth` scroll behavior is not fully supported with dynamic size."),this._scrollToOffset(this.getScrollOffset()+e,{adjustments:void 0,behavior:t})},this.getTotalSize=()=>{var e;const t=this.getMeasurements();let n;if(0===t.length)n=this.options.paddingStart;else if(1===this.options.lanes)n=(null==(e=t[t.length-1])?void 0:e.end)??0;else{const e=Array(this.options.lanes).fill(null);let a=t.length-1;for(;a>=0&&e.some(e=>null===e);){const n=t[a];null===e[n.lane]&&(e[n.lane]=n.end),a--}n=Math.max(...e.filter(e=>null!==e))}return Math.max(n-this.options.scrollMargin+this.options.paddingEnd,0)},this._scrollToOffset=(e,{adjustments:t,behavior:n})=>{this.options.scrollToFn(e,{behavior:n,adjustments:t},this)},this.measure=()=>{this.itemSizeCache=new Map,this.laneAssignments=new Map,this.notify(!1)},this.setOptions(e)}}const VR=(e,t,n,a)=>{for(;e<=t;){const r=(e+t)/2|0,i=n(r);if(i<a)e=r+1;else{if(!(i>a))return r;t=r-1}}return e>0?e-1:0};const WR="undefined"!=typeof document?Tt.useLayoutEffect:Tt.useEffect;function GR(e){return function({useFlushSync:e=!0,...t}){const n=Tt.useReducer(()=>({}),{})[1],a={...t,onChange:(a,r)=>{var i;e&&r?Wh.flushSync(n):n(),null==(i=t.onChange)||i.call(t,a,r)}},[r]=Tt.useState(()=>new $R(a));return r.setOptions(a),WR(()=>r._didMount(),[]),WR(()=>r._willUpdate()),r}({observeElementRect:UR,observeElementOffset:zR,scrollToFn:HR,...e})}function XR({videoUrl:e,width:t,height:n,className:a}){const r=Tt.useRef(null),i=Tt.useRef(null),s=Tt.useRef(null),o=Tt.useRef(null),l=Tt.useRef(!1),c=Tt.useRef(!1),d=Tt.useRef(!1),[u,h]=Tt.useState(!1);Tt.useEffect(()=>{var t;if(i.current||c.current)return;const n=document.createElement("video");return n.src=e,n.muted=!0,n.playsInline=!0,n.preload="metadata",n.className="video-scrubber-video",n.style.width="100%",n.style.height="100%",n.style.objectFit="contain",n.style.display="none",n.addEventListener("loadedmetadata",()=>{l.current=!0,n.currentTime=0}),n.addEventListener("seeked",()=>{if(!d.current&&o.current&&n.videoWidth>0){const e=o.current,t=e.getContext("2d");t&&(e.width=n.videoWidth,e.height=n.videoHeight,t.drawImage(n,0,0),d.current=!0)}}),n.addEventListener("error",()=>{c.current=!0,i.current=null}),null==(t=r.current)||t.appendChild(n),i.current=n,()=>{n.pause(),n.removeAttribute("src"),n.load(),n.parentNode&&n.parentNode.removeChild(n),i.current=null,l.current=!1,d.current=!1}},[e]);const p=Tt.useCallback(()=>{const e=i.current;e&&!c.current&&(h(!0),e.style.display="block",e.play().catch(()=>{}))},[]),m=Tt.useCallback(e=>{var t;const n=i.current;if(!n||!l.current||!Number.isFinite(n.duration))return;const a=null==(t=r.current)?void 0:t.getBoundingClientRect();if(!a)return;const o=e.clientX-a.left,c=Math.max(0,Math.min(1,o/a.width));n.paused||n.pause(),n.currentTime=c*n.duration,s.current&&(s.current.style.width=100*c+"%")},[]),f=Tt.useCallback(()=>{const e=i.current;e&&(e.pause(),e.style.display="none"),s.current&&(s.current.style.width="0%"),h(!1)},[]),g=["video-scrubber-container",a].filter(Boolean).join(" "),v={position:"relative",overflow:"hidden",...null!=t?{width:t}:{width:"100%"},...null!=n?{height:n}:{height:"100%"}};return Ut.jsxs("div",{ref:r,className:g,style:v,onMouseEnter:p,onMouseMove:m,onMouseLeave:f,children:[Ut.jsx("canvas",{ref:o,className:"video-scrubber-poster",style:{width:"100%",height:"100%",objectFit:"contain",display:u?"none":"block"}}),Ut.jsx("div",{className:"video-scrubber-progress-track",children:Ut.jsx("div",{ref:s,className:"video-scrubber-progress-fill",style:{width:"0%"}})})]})}function qR({file:e,thumbnailSize:t,isSelected:n,orchestratorUrl:a,rating:r,onClick:i,onDoubleClick:s,onContextMenu:o}){const[l,c]=Tt.useState(!1),d=Tt.useCallback(()=>{c(!0)},[]),u="video"===e.type,h=`${a}/api/serve-image?path=${encodeURIComponent(e.path)}`,p=["gallery-thumbnail",n?"gallery-thumbnail--selected":""].filter(Boolean).join(" ");return Ut.jsxs("div",{className:p,style:n?{transform:"scale(1.02)"}:void 0,draggable:!0,onDragStart:t=>{const n=JSON.stringify({url:`${a}/api/serve-image?path=${encodeURIComponent(e.path)}`,filePath:e.path});t.dataTransfer.setData("application/x-storyboard-image",n),t.dataTransfer.setData("text/plain",n),t.dataTransfer.effectAllowed="copyMove"},onClick:i,onDoubleClick:s,onContextMenu:o,children:[Ut.jsxs("div",{className:"gallery-thumbnail-image-container",children:[l?Ut.jsx("div",{className:"gallery-thumbnail-placeholder",children:Ut.jsx(HE,{size:Math.max(24,.2*t)})}):u?Ut.jsx(XR,{videoUrl:h,className:"gallery-thumbnail-image"}):Ut.jsx("img",{className:"gallery-thumbnail-image",src:h,alt:e.name,loading:"lazy",onError:d,draggable:!1}),u&&!l&&Ut.jsx("div",{className:"gallery-thumbnail-video-overlay",children:Ut.jsx(jE,{size:18})}),Ut.jsx("span",{className:"gallery-thumbnail-type-badge gallery-thumbnail-type-badge--"+(u?"video":"image")}),r>0&&Ut.jsx("div",{className:"gallery-thumbnail-rating",children:Array.from({length:r},(e,t)=>Ut.jsx(bk,{className:"gallery-thumbnail-rating-star",size:10,fill:"#f5c542"},t))})]}),e.tags&&e.tags.length>0&&Ut.jsxs("div",{className:"gallery-thumbnail-tags",children:[e.tags.slice(0,5).map(e=>Ut.jsx("span",{className:"gallery-thumbnail-tag-dot",style:{backgroundColor:e.color||"#58a6ff"},title:e.name},e.id)),e.tags.length>5&&Ut.jsxs("span",{className:"gallery-thumbnail-tag-overflow",children:["+",e.tags.length-5]})]}),Ut.jsx("div",{className:"gallery-thumbnail-name",title:e.name,children:e.name})]})}function KR({orchestratorUrl:e,onContextMenu:t,onDoubleClick:n}){const{currentFiles:a,thumbnailSize:r,sortField:i,sortDirection:s,filterType:o,filterRating:l,ratings:c,selectedFiles:d,lastSelectedFile:u,selectFile:h,clearSelection:p,toggleFileSelection:m,selectAll:f}=SR(),g=Tt.useRef([]),v=Tt.useRef(null),[y,x]=Tt.useState(800);Tt.useEffect(()=>{const e=v.current;if(!e)return;const t=new ResizeObserver(e=>{const t=e[0];t&&x(t.contentRect.width)});return t.observe(e),()=>t.disconnect()},[]);const b=Tt.useMemo(()=>{let e=a;"image"===o?e=e.filter(e=>"image"===e.type):"video"===o&&(e=e.filter(e=>"video"===e.type)),l>0&&(e=e.filter(e=>(c[e.path]??e.rating??0)>=l));const t=[...e].sort((e,t)=>function(e,t,n,a,r){let i=0;switch(n){case"name":i=e.name.localeCompare(t.name,void 0,{numeric:!0});break;case"modified":i=e.modified-t.modified;break;case"created":i=e.created-t.created;break;case"size":i=e.size-t.size;break;case"type":i=e.type.localeCompare(t.type)||e.extension.localeCompare(t.extension);break;case"rating":i=(r[e.path]??e.rating??0)-(r[t.path]??t.rating??0);break;default:i=0}return"desc"===a?-i:i}(e,t,i,s,c));return g.current=t,t},[a,o,l,i,s,c]),_=Math.max(1,Math.floor(y/r)),w=GR({count:Math.ceil(b.length/_),getScrollElement:()=>v.current,estimateSize:()=>r+40,overscan:3}),S=Tt.useCallback((e,t)=>{if(t.shiftKey&&u){const t=g.current,n=t.findIndex(e=>e.path===u),a=t.findIndex(t=>t.path===e.path);if(-1!==n&&-1!==a){const e=Math.min(n,a),r=Math.max(n,a),i=t.slice(e,r+1).map(e=>e.path);f(i)}}else t.ctrlKey||t.metaKey?m(e.path):(p(),h(e.path))},[u,p,h,m,f]),M=Tt.useCallback(e=>{null==n||n(e)},[n]);return 0===b.length?Ut.jsx("div",{className:"gallery-grid-empty",children:0===a.length?"No files in this folder":"No files match the current filters"}):Ut.jsx("div",{ref:v,className:"gallery-grid-virtual-scroll",style:{overflow:"auto",flex:1},children:Ut.jsx("div",{style:{height:`${w.getTotalSize()}px`,width:"100%",position:"relative"},children:w.getVirtualItems().map(n=>{const a=n.index*_,i=b.slice(a,a+_);return Ut.jsx("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${n.size}px`,transform:`translateY(${n.start}px)`,display:"grid",gridTemplateColumns:`repeat(${_}, 1fr)`,gap:"8px",padding:"0 4px"},children:i.map(n=>Ut.jsx(qR,{file:n,thumbnailSize:r,isSelected:d.has(n.path),orchestratorUrl:e,rating:c[n.path]??n.rating??0,onClick:e=>S(n,e),onDoubleClick:()=>M(n),onContextMenu:t?e=>t(e,n):void 0},n.path))},n.key)})})})}function YR(e){const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}const JR=[{key:"thumbnail",label:"",sortable:!1},{key:"name",label:"Name",sortable:!0,sortKey:"name"},{key:"type",label:"Type",sortable:!0,sortKey:"type"},{key:"size",label:"Size",sortable:!0,sortKey:"size"},{key:"created",label:"Created",sortable:!0,sortKey:"created"},{key:"modified",label:"Modified",sortable:!0,sortKey:"modified"},{key:"rating",label:"Rating",sortable:!0,sortKey:"rating"}];function ZR({file:e,orchestratorUrl:t}){const[n,a]=Tt.useState(!1);if(n||"video"===e.type){const t="video"===e.type?jE:HE;return Ut.jsx("div",{className:"gallery-list-thumb-fallback",children:Ut.jsx(t,{size:20})})}return Ut.jsx("img",{className:"gallery-list-thumb-img",src:`${t}/api/serve-image?path=${encodeURIComponent(e.path)}`,alt:e.name,width:40,height:40,loading:"lazy",onError:()=>a(!0)})}function QR({orchestratorUrl:e,onContextMenu:t,onDoubleClick:n}){const{currentFiles:a,sortField:r,sortDirection:i,filterType:s,filterRating:o,ratings:l,selectedFiles:c,lastSelectedFile:d,selectFile:u,clearSelection:h,toggleFileSelection:p,selectAll:m}=SR(),f=SR(e=>e.setSortField),g=SR(e=>e.setSortDirection),v=Tt.useRef([]),y=Tt.useRef(null),x=Tt.useMemo(()=>{let e=a;"image"===s?e=e.filter(e=>"image"===e.type):"video"===s&&(e=e.filter(e=>"video"===e.type)),o>0&&(e=e.filter(e=>(l[e.path]??e.rating??0)>=o));const t=[...e].sort((e,t)=>function(e,t,n,a,r){let i=0;switch(n){case"name":i=e.name.localeCompare(t.name,void 0,{numeric:!0});break;case"modified":i=e.modified-t.modified;break;case"created":i=e.created-t.created;break;case"size":i=e.size-t.size;break;case"type":i=e.type.localeCompare(t.type)||e.extension.localeCompare(t.extension);break;case"rating":i=(r[e.path]??e.rating??0)-(r[t.path]??t.rating??0);break;default:i=0}return"desc"===a?-i:i}(e,t,r,i,l));return v.current=t,t},[a,s,o,r,i,l]),b=GR({count:x.length,getScrollElement:()=>y.current,estimateSize:()=>44,overscan:10}),_=Tt.useCallback(e=>{e.sortable&&e.sortKey&&(r===e.sortKey?g("asc"===i?"desc":"asc"):(f(e.sortKey),g("asc")))},[r,i,f,g]),w=Tt.useCallback((e,t)=>{if(t.shiftKey&&d){const t=v.current,n=t.findIndex(e=>e.path===d),a=t.findIndex(t=>t.path===e.path);if(-1!==n&&-1!==a){const e=Math.min(n,a),r=Math.max(n,a),i=t.slice(e,r+1).map(e=>e.path);m(i)}}else t.ctrlKey||t.metaKey?p(e.path):(h(),u(e.path))},[d,h,u,p,m]);function S(e){const t=l[e.path]??e.rating??0;if(t<=0)return null;const n=[];for(let a=0;a<t;a++)n.push(Ut.jsx(bk,{size:12,fill:"#f5c542",color:"#f5c542"},a));return Ut.jsx("span",{className:"gallery-list-stars",children:n})}function M(e){const t="video"===e.type;return Ut.jsxs("span",{className:"gallery-list-type-badge",children:[Ut.jsx("span",{className:"gallery-list-type-dot",style:{backgroundColor:t?"#a855f7":"#3b82f6"}}),t?"Video":"Image"]})}return 0===x.length?Ut.jsx("div",{className:"gallery-list-empty",children:0===a.length?"No files in this folder":"No files match the current filters"}):Ut.jsxs("div",{className:"gallery-list-container",ref:y,style:{overflow:"auto",flex:1},children:[Ut.jsx("div",{className:"gallery-list-header-row",style:{position:"sticky",top:0,zIndex:1,display:"flex",alignItems:"center"},children:JR.map(e=>{return Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--"+e.key+" gallery-list-header-cell"+(e.sortable?" gallery-list-header-cell--sortable":"")+(e.sortKey&&r===e.sortKey?" gallery-list-header-cell--active":""),onClick:()=>_(e),children:Ut.jsxs("span",{className:"gallery-list-header-label",children:[e.label,(t=e,t.sortable&&r===t.sortKey?Ut.jsx("span",{className:"gallery-list-sort-indicator",children:"asc"===i?"":""}):null)]})},e.key);var t})}),Ut.jsx("div",{style:{height:`${b.getTotalSize()}px`,position:"relative"},children:b.getVirtualItems().map(a=>{const r=x[a.index],i=c.has(r.path);return Ut.jsxs("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:`${a.size}px`,transform:`translateY(${a.start}px)`,display:"flex",alignItems:"center"},className:"gallery-list-row"+(i?" gallery-list-row--selected":""),draggable:!0,onDragStart:t=>{const n=JSON.stringify({url:`${e}/api/serve-image?path=${encodeURIComponent(r.path)}`,filePath:r.path});t.dataTransfer.setData("application/x-storyboard-image",n),t.dataTransfer.setData("text/plain",n),t.dataTransfer.effectAllowed="copy"},onClick:e=>w(r,e),onDoubleClick:()=>null==n?void 0:n(r),onContextMenu:t?e=>{e.preventDefault(),t(e,r)}:void 0,children:[Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--thumb",children:Ut.jsx(ZR,{file:r,orchestratorUrl:e})}),Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--name",title:r.name,children:r.name}),Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--type",children:M(r)}),Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--size",children:(s=r.size,s<1024?`${s} B`:s<1048576?`${(s/1024).toFixed(1)} KB`:s<1073741824?`${(s/1048576).toFixed(1)} MB`:`${(s/1073741824).toFixed(2)} GB`)}),Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--created",children:YR(r.created)}),Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--modified",children:YR(r.modified)}),Ut.jsx("div",{className:"gallery-list-vcell gallery-list-vcell--rating",children:S(r)})]},a.key);var s})})]})}function eI({file:e,isSelected:t,rating:n,orchestratorUrl:a,onClick:r,onDoubleClick:i,onContextMenu:s}){const[o,l]=Tt.useState(!1),c=Tt.useCallback(()=>{l(!0)},[]),d="video"===e.type,u=`${a}/api/serve-image?path=${encodeURIComponent(e.path)}`,h=["gallery-masonry-item",t?"gallery-masonry-item--selected":""].filter(Boolean).join(" ");return Ut.jsxs("div",{className:h,onClick:r,onDoubleClick:i,onContextMenu:s,children:[Ut.jsxs("div",{className:"gallery-masonry-image-container"+(d?" gallery-masonry-image-container--video":""),children:[o?Ut.jsx("div",{className:"gallery-masonry-placeholder",children:Ut.jsx(HE,{size:48})}):d?Ut.jsx(XR,{videoUrl:u,className:"gallery-masonry-image"}):Ut.jsx("img",{className:"gallery-masonry-image",src:u,alt:e.name,loading:"lazy",onError:c,draggable:!1}),d&&!o&&Ut.jsx("div",{className:"gallery-masonry-video-overlay",children:Ut.jsx(jE,{size:20})}),Ut.jsx("span",{className:"gallery-masonry-type-badge gallery-masonry-type-badge--"+(d?"video":"image")}),n>0&&Ut.jsx("div",{className:"gallery-masonry-rating",children:Array.from({length:n},(e,t)=>Ut.jsx(bk,{className:"gallery-masonry-rating-star",size:10,fill:"#f5c542"},t))})]}),Ut.jsx("div",{className:"gallery-masonry-name",title:e.name,children:e.name})]})}function tI({orchestratorUrl:e,onContextMenu:t,onDoubleClick:n}){const{currentFiles:a,thumbnailSize:r,sortField:i,sortDirection:s,filterType:o,filterRating:l,ratings:c,selectedFiles:d,lastSelectedFile:u,selectFile:h,clearSelection:p,toggleFileSelection:m,selectAll:f}=SR(),g=Tt.useRef([]),v=Tt.useRef(null),[y,x]=Tt.useState(3);Tt.useEffect(()=>{const e=v.current;if(!e)return;function t(){if(!e)return;const t=e.clientWidth,n=Math.floor(t/r);x(Math.max(2,Math.min(8,n)))}t();const n=new ResizeObserver(()=>{t()});return n.observe(e),()=>{n.disconnect()}},[r]);const b=Tt.useMemo(()=>{let e=a;"image"===o?e=e.filter(e=>"image"===e.type):"video"===o&&(e=e.filter(e=>"video"===e.type)),l>0&&(e=e.filter(e=>(c[e.path]??e.rating??0)>=l));const t=[...e].sort((e,t)=>function(e,t,n,a,r){let i=0;switch(n){case"name":i=e.name.localeCompare(t.name,void 0,{numeric:!0});break;case"modified":i=e.modified-t.modified;break;case"created":i=e.created-t.created;break;case"size":i=e.size-t.size;break;case"type":i=e.type.localeCompare(t.type)||e.extension.localeCompare(t.extension);break;case"rating":i=(r[e.path]??e.rating??0)-(r[t.path]??t.rating??0);break;default:i=0}return"desc"===a?-i:i}(e,t,i,s,c));return g.current=t,t},[a,o,l,i,s,c]),_=Tt.useCallback((e,t)=>{if(t.shiftKey&&u){const t=g.current,n=t.findIndex(e=>e.path===u),a=t.findIndex(t=>t.path===e.path);if(-1!==n&&-1!==a){const e=Math.min(n,a),r=Math.max(n,a),i=t.slice(e,r+1).map(e=>e.path);f(i)}}else t.ctrlKey||t.metaKey?m(e.path):(p(),h(e.path))},[u,p,h,m,f]),w=Tt.useCallback(e=>{null==n||n(e)},[n]);return 0===b.length?Ut.jsx("div",{className:"gallery-masonry-empty",children:0===a.length?"No files in this folder":"No files match the current filters"}):Ut.jsx("div",{ref:v,className:"gallery-masonry",style:{columnCount:y,columnGap:"4px"},children:b.map(n=>Ut.jsx(eI,{file:n,isSelected:d.has(n.path),rating:c[n.path]??n.rating??0,orchestratorUrl:e,onClick:e=>_(n,e),onDoubleClick:()=>w(n),onContextMenu:t?e=>{e.preventDefault(),t(e,n)}:void 0},n.path))})}function nI({orchestratorUrl:e,folderPath:t,className:n}){const[a,r]=Tt.useState(null),[i,s]=Tt.useState(!1),[o,l]=Tt.useState(null),c=Tt.useRef(0);if(Tt.useEffect(()=>{if(!t||!e)return r(null),void l(null);const n=++c.current;s(!0),l(null),fetch(`${e}/api/gallery/folder-stats`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder_path:t})}).then(e=>{if(!e.ok)throw new Error(`Server responded with ${e.status}`);return e.json()}).then(e=>{n===c.current&&(e.success?(r(e),l(null)):(l(e.message||"Failed to retrieve folder stats"),r(null)))}).catch(e=>{n===c.current&&(l(e instanceof Error?e.message:"Unknown error"),r(null))}).finally(()=>{n===c.current&&s(!1)})},[e,t]),i)return Ut.jsx("div",{className:"folder-stats-container"+(n?` ${n}`:""),children:Ut.jsx("span",{className:"folder-stats-loading",children:"Loading stats"})});if(o)return Ut.jsx("div",{className:"folder-stats-container"+(n?` ${n}`:""),children:Ut.jsx("span",{className:"folder-stats-error",children:o})});if(!a)return null;const d=Object.entries(a.by_extension).sort(([,e],[,t])=>t-e);return Ut.jsxs("div",{className:"folder-stats-container"+(n?` ${n}`:""),children:[Ut.jsxs("span",{className:"folder-stats-item",title:"Total files",children:[Ut.jsx(FE,{size:13,className:"folder-stats-icon"}),Ut.jsx("span",{className:"folder-stats-value",children:a.total_files}),Ut.jsx("span",{className:"folder-stats-label",children:"files"})]}),Ut.jsx("span",{className:"folder-stats-item",title:`${a.total_size} bytes`,children:Ut.jsx("span",{className:"folder-stats-value",children:(u=a.total_size,u<0?"0 B":u<1024?`${u} B`:u<1048576?`${(u/1024).toFixed(1)} KB`:u<1073741824?`${(u/1048576).toFixed(1)} MB`:`${(u/1073741824).toFixed(2)} GB`)})}),Ut.jsx("span",{className:"folder-stats-separator"}),Ut.jsxs("span",{className:"folder-stats-item",title:"Images",children:[Ut.jsx("span",{className:"folder-stats-dot folder-stats-dot--image"}),Ut.jsx(HE,{size:13,className:"folder-stats-icon"}),Ut.jsx("span",{className:"folder-stats-value",children:a.image_count})]}),Ut.jsxs("span",{className:"folder-stats-item",title:"Videos",children:[Ut.jsx("span",{className:"folder-stats-dot folder-stats-dot--video"}),Ut.jsx(jE,{size:13,className:"folder-stats-icon"}),Ut.jsx("span",{className:"folder-stats-value",children:a.video_count})]}),Ut.jsxs("span",{className:"folder-stats-item",title:"Subfolders",children:[Ut.jsx(LE,{size:13,className:"folder-stats-icon"}),Ut.jsx("span",{className:"folder-stats-value",children:a.subfolder_count})]}),d.length>0&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("span",{className:"folder-stats-separator"}),Ut.jsx("span",{className:"folder-stats-extensions",children:d.map(([e,t])=>Ut.jsxs("span",{className:"folder-stats-badge",title:`${e}: ${t} file${1!==t?"s":""}`,children:[Ut.jsx("span",{className:"folder-stats-badge-ext",children:e}),Ut.jsx("span",{className:"folder-stats-badge-count",children:t})]},e))})]})]});var u}async function aI(e,t){const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok){const e=await n.text();throw new Error(`Gallery API error ${n.status}: ${e}`)}return n.json()}async function rI(e){const t=await fetch(e);if(!t.ok){const e=await t.text();throw new Error(`Gallery API error ${t.status}: ${e}`)}return t.json()}async function iI(e,t){return aI(`${e}/api/gallery/scan-tree`,{folder_path:t})}async function sI(e,t,n,a,r){return aI(`${e}/api/gallery/move-files`,{file_paths:t,target_folder:n,project_path:a,conflict:r})}async function oI(e,t,n){return aI(`${e}/api/create-folder`,{parent_path:t,folder_name:n})}async function lI(e,t,n,a,r,i,s){return aI(`${e}/api/gallery/batch-rename`,{file_paths:t,pattern:n,start_index:a,pad_width:r,project_path:i,dry_run:s})}async function cI(e,t,n,a){return aI(`${e}/api/gallery/trash`,{file_paths:t,project_path:n,use_os_trash:a})}async function dI(e,t){return rI(`${e}/api/gallery/ratings?${new URLSearchParams({project_path:t}).toString()}`)}async function uI(e,t,n){return aI(`${e}/api/gallery/ratings`,{project_path:t,ratings:n})}async function hI(e,t){return rI(`${e}/api/gallery/tags?${new URLSearchParams({project_path:t}).toString()}`)}async function pI(e,t,n,a,r){return aI(`${e}/api/gallery/file-tags`,{project_path:t,file_path:n,tag_ids:a,action:r})}async function mI(e,t,n="default"){return rI(`${e}/api/gallery/views?${new URLSearchParams({project_path:t,name:n}).toString()}`)}function fI({x:e,y:t,file:n,selectedFiles:a,onClose:r,onOpen:i,onRename:s,onMove:o,onMoveToNewFolder:l,onBatchRename:c,onTrash:d,onCompare:u,onInfo:h}){const p=Tt.useRef(null),[m,f]=Tt.useState({left:e,top:t}),[g,v]=Tt.useState([]),[y,x]=Tt.useState(!1),[b,_]=Tt.useState(null),w=Tt.useRef(null),S=Tt.useRef(null),M=a.has(n.path),C=[n],E=M?a.size:1,k=E>1,T=1===E;Tt.useEffect(()=>{const n=p.current;if(!n)return;const a=n.getBoundingClientRect(),r=window.innerWidth,i=window.innerHeight;let s=e,o=t;e+a.width>r&&(s=r-a.width-4),t+a.height>i&&(o=i-a.height-4),s<0&&(s=4),o<0&&(o=4),s===m.left&&o===m.top||f({left:s,top:o})},[e,t]);const N=Tt.useCallback(e=>{p.current&&!p.current.contains(e.target)&&r()},[r]),P=Tt.useCallback(e=>{"Escape"===e.key&&r()},[r]),j=Tt.useCallback(()=>{r()},[r]);Tt.useEffect(()=>(document.addEventListener("mousedown",N,!0),document.addEventListener("keydown",P),window.addEventListener("scroll",j,!0),()=>{document.removeEventListener("mousedown",N,!0),document.removeEventListener("keydown",P),window.removeEventListener("scroll",j,!0)}),[N,P,j]);const A=Tt.useCallback(()=>{function e(t){const n=t.detail;window.removeEventListener("gallery:image-params-response",e),n.error?(_(n.error),v([])):0===n.params.length?(_("No image/video inputs in current workflow"),v([])):(_(null),v(n.params)),x(!0)}window.addEventListener("gallery:image-params-response",e),window.dispatchEvent(new CustomEvent("gallery:request-image-params")),setTimeout(()=>{window.removeEventListener("gallery:image-params-response",e),x(e=>e||(_("Storyboard not available"),v([]),!0))},500)},[]),R=Tt.useCallback(e=>{window.dispatchEvent(new CustomEvent("gallery:send-reference-image",{detail:{filePath:n.path,targetParam:e}})),r()},[n.path,r]),I=Tt.useCallback(()=>{w.current&&(clearTimeout(w.current),w.current=null)},[]),L=Tt.useCallback(()=>{w.current=setTimeout(()=>{x(!1)},300)},[]);const D=/\.(png|jpe?g|webp|bmp|tiff?|mp4|mov|avi|webm|mkv)$/i.test(n.name),U=n.name.toLowerCase().endsWith(".png"),O=Ut.jsxs("div",{ref:p,className:"gallery-context-menu",style:{position:"fixed",left:m.left,top:m.top},onContextMenu:e=>e.preventDefault(),children:[k&&Ut.jsxs("div",{className:"gallery-context-menu-header",children:[E," files selected"]}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){null==i||i(n),r()},disabled:k,children:[Ut.jsx(CE,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Open"})]}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){u(C),r()},disabled:2!==E,title:2!==E?"Select exactly 2 files to compare":void 0,children:[Ut.jsx(bE,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Compare"})]}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){h(n),r()},disabled:k,children:[Ut.jsx($E,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Info"})]}),(D||U)&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{className:"gallery-context-menu-separator"}),D&&Ut.jsxs("div",{className:"gallery-context-submenu-wrapper",onMouseEnter:()=>{I(),y||A()},onMouseLeave:L,children:[Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:()=>{y||A()},disabled:k,title:"Set as reference image/video in Storyboard",children:[Ut.jsx(BE,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Send to Storyboard"}),Ut.jsx(pE,{size:12,style:{marginLeft:"auto",opacity:.5}})]}),y&&!k&&Ut.jsx("div",{ref:S,className:"gallery-context-submenu",onMouseEnter:I,onMouseLeave:L,children:b?Ut.jsx("div",{className:"gallery-context-submenu-empty",children:b}):0===g.length?Ut.jsx("div",{className:"gallery-context-submenu-empty",children:"Loading..."}):g.map(e=>Ut.jsxs("button",{className:"gallery-context-menu-item gallery-context-submenu-item",onClick:()=>R(e.name),title:`Set "${e.display_name}" to this ${n.type}`,children:[Ut.jsx("span",{className:"gallery-context-submenu-type gallery-context-submenu-type--"+(e.type.includes("video")?"video":"image"),children:e.type.includes("video")?"VID":"IMG"}),Ut.jsx("span",{className:"gallery-context-submenu-name",children:e.display_name}),e.filled&&Ut.jsx("span",{className:"gallery-context-submenu-filled",title:"Currently has a value",children:""})]},e.name))})]}),U&&Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){window.dispatchEvent(new CustomEvent("gallery:restore-workflow-from-metadata",{detail:{filePath:n.path}})),r()},disabled:k,title:"Apply workflow and parameters from this image's metadata",children:[Ut.jsx(Tk,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Use Workflow from Metadata"})]})]}),Ut.jsx("div",{className:"gallery-context-menu-separator"}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){s(n),r()},disabled:!T,children:[Ut.jsx(ik,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Rename"})]}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){o(C),r()},children:[Ut.jsx(AE,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Move to..."})]}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){l(C),r()},children:[Ut.jsx(IE,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Move to New Folder..."})]}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){c(C),r()},disabled:!k,children:[Ut.jsx(PE,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Batch Rename..."})]}),Ut.jsx("div",{className:"gallery-context-menu-separator"}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){navigator.clipboard.writeText(n.path).catch(()=>{}),r()},children:[Ut.jsx(_E,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Copy Path"})]}),Ut.jsxs("button",{className:"gallery-context-menu-item",onClick:function(){navigator.clipboard.writeText(n.name).catch(()=>{}),r()},children:[Ut.jsx(yE,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Copy Filename"})]}),Ut.jsx("div",{className:"gallery-context-menu-separator"}),Ut.jsxs("button",{className:"gallery-context-menu-item gallery-context-menu-item--danger",onClick:function(){d(C),r()},children:[Ut.jsx(Ck,{size:14,className:"gallery-context-menu-icon"}),Ut.jsx("span",{children:"Move to Trash"})]})]});return Wh.createPortal(O,document.body)}const gI=/[/\\<>:"|?*]/;function vI({file:e,orchestratorUrl:t,projectPath:n,onClose:a,onRenamed:r}){const{baseName:i,extension:s}=function(e){const t=e.lastIndexOf(".");return t<=0?{baseName:e,extension:""}:{baseName:e.slice(0,t),extension:e.slice(t)}}(e.name),[o,l]=Tt.useState(i),[c,d]=Tt.useState(!1),[u,h]=Tt.useState(""),p=Tt.useRef(null);Tt.useEffect(()=>{var e;null==(e=p.current)||e.select()},[]),Tt.useEffect(()=>{function e(e){"Escape"===e.key&&a()}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[a]);const m=o.trim(),f=gI.test(m),g=m===i,v=0===m.length,y=v||g||f||c,x=Tt.useCallback(async()=>{if(!y){d(!0),h("");try{const i=m+s,o=await async function(e,t,n,a){return aI(`${e}/api/gallery/rename-file`,{file_path:t,new_name:n,project_path:a})}(t,e.path,i,n);if(!o.success)return h(o.message||"Rename failed."),void d(!1);r(),a()}catch(i){const e=i instanceof Error?i.message:"An unexpected error occurred.";h(e),d(!1)}}},[y,m,s,t,e.path,n,r,a]),b=Tt.useCallback(e=>{e.target===e.currentTarget&&a()},[a]),_=Tt.useCallback(e=>{"Enter"===e.key&&(e.preventDefault(),x())},[x]);let w="";return v?w="":f&&(w='Name contains invalid characters: / \\ < > : " | ? *'),Wh.createPortal(Ut.jsx("div",{className:"gallery-rename-backdrop",onClick:b,style:yI,children:Ut.jsxs("div",{className:"gallery-rename-dialog",style:xI,onClick:void 0,children:[Ut.jsx("h3",{style:bI,children:"Rename File"}),Ut.jsxs("div",{style:_I,children:[Ut.jsx("span",{style:wI,children:"Current name:"}),Ut.jsx("span",{style:SI,children:e.name})]}),Ut.jsxs("div",{style:MI,children:[Ut.jsx("input",{ref:p,className:"gallery-rename-input",type:"text",value:o,onChange:e=>{l(e.target.value),h("")},onKeyDown:_,autoFocus:!0,style:CI}),s&&Ut.jsx("span",{className:"gallery-rename-extension",style:EI,children:s})]}),(u||w)&&Ut.jsx("div",{className:"gallery-rename-error",style:kI,children:u||w}),Ut.jsxs("div",{className:"gallery-rename-buttons",style:TI,children:[Ut.jsx("button",{className:"gallery-rename-cancel-btn",type:"button",onClick:a,disabled:c,style:NI,children:"Cancel"}),Ut.jsx("button",{className:"gallery-rename-submit-btn",type:"button",onClick:x,disabled:y,style:{...PI,opacity:y?.5:1,cursor:y?"not-allowed":"pointer"},children:c?"Renaming...":"Rename"})]})]})}),document.body)}const yI={position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4},xI={background:"#1e1e2e",borderRadius:"8px",padding:"24px",minWidth:"380px",maxWidth:"480px",width:"90%",boxShadow:"0 8px 32px rgba(0, 0, 0, 0.5)",color:"#e0e0e0"},bI={margin:"0 0 16px 0",fontSize:"16px",fontWeight:600,color:"#ffffff"},_I={marginBottom:"12px",fontSize:"13px"},wI={color:"#888",marginRight:"6px"},SI={color:"#aaa",wordBreak:"break-all"},MI={display:"flex",alignItems:"center",gap:"4px",marginBottom:"8px"},CI={flex:1,padding:"8px 10px",fontSize:"14px",background:"#2a2a3e",border:"1px solid #444",borderRadius:"4px",color:"#e0e0e0",outline:"none"},EI={fontSize:"14px",color:"#888",flexShrink:0,userSelect:"none"},kI={fontSize:"12px",color:"#f87171",marginBottom:"8px",minHeight:"18px"},TI={display:"flex",justifyContent:"flex-end",gap:"8px",marginTop:"16px"},NI={padding:"6px 16px",fontSize:"13px",background:"transparent",border:"1px solid #555",borderRadius:"4px",color:"#ccc",cursor:"pointer"},PI={padding:"6px 16px",fontSize:"13px",background:"#3b82f6",border:"none",borderRadius:"4px",color:"#fff",fontWeight:600};const jI={overlay:{position:"fixed",inset:0,zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.6)"},dialog:{background:"var(--color-bg-secondary, #1e1e2e)",border:"1px solid var(--color-border, #333)",borderRadius:8,width:460,maxHeight:"80vh",display:"flex",flexDirection:"column",boxShadow:"0 12px 40px rgba(0,0,0,0.5)",color:"var(--color-text, #e0e0e0)",fontSize:13},header:{padding:"16px 20px 12px",borderBottom:"1px solid var(--color-border, #333)",fontWeight:600,fontSize:15},body:{flex:1,overflow:"hidden",display:"flex",flexDirection:"column",padding:"12px 20px",gap:12},label:{fontSize:12,color:"var(--color-text-muted, #888)",marginBottom:4},folderList:{flex:1,minHeight:0,maxHeight:280,overflowY:"auto",border:"1px solid var(--color-border, #333)",borderRadius:4,background:"var(--color-bg-primary, #141420)"},folderRow:{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",cursor:"pointer",borderRadius:3,margin:"1px 2px",transition:"background 0.1s"},folderRowSelected:{background:"var(--color-accent, #3b82f6)",color:"#fff"},folderRowDimmed:{opacity:.4,cursor:"default"},folderRowHover:{background:"var(--color-bg-hover, rgba(255,255,255,0.06))"},conflictRow:{display:"flex",alignItems:"center",gap:8},select:{flex:1,background:"var(--color-bg-primary, #141420)",color:"var(--color-text, #e0e0e0)",border:"1px solid var(--color-border, #333)",borderRadius:4,padding:"5px 8px",fontSize:13,outline:"none"},footer:{display:"flex",justifyContent:"flex-end",gap:8,padding:"12px 20px",borderTop:"1px solid var(--color-border, #333)"},btn:{padding:"6px 16px",borderRadius:4,border:"1px solid var(--color-border, #444)",background:"var(--color-bg-secondary, #1e1e2e)",color:"var(--color-text, #e0e0e0)",cursor:"pointer",fontSize:13,fontWeight:500},btnPrimary:{background:"var(--color-accent, #3b82f6)",color:"#fff",border:"1px solid var(--color-accent, #3b82f6)"},btnDisabled:{opacity:.4,cursor:"not-allowed"},resultBox:{padding:"10px 14px",borderRadius:4,background:"var(--color-bg-primary, #141420)",border:"1px solid var(--color-border, #333)",fontSize:12,lineHeight:1.6},errorList:{maxHeight:120,overflowY:"auto",marginTop:8,padding:"6px 10px",background:"rgba(239, 68, 68, 0.08)",borderRadius:4,fontSize:11,color:"#f87171"}};function AI({files:e,orchestratorUrl:t,projectPath:n,folderTree:a,onClose:r,onMoved:i}){const[s,o]=Tt.useState(null),[l,c]=Tt.useState("skip"),[d,u]=Tt.useState(!1),[h,p]=Tt.useState(null),[m,f]=Tt.useState(null),[g,v]=Tt.useState(null),y=Tt.useMemo(()=>a.slice().sort((e,t)=>e.rel_path.localeCompare(t.rel_path)).map(e=>{const t=e.rel_path.replace(/\\/g,"/").replace(/\/$/,"").split("/").filter(Boolean);return{folder:e,depth:Math.max(0,t.length-1),displayName:e.name}}),[a]),x=Tt.useMemo(()=>function(e){const t=new Set;for(const n of e){const e=n.path.replace(/\\/g,"/"),a=e.lastIndexOf("/");a>0&&t.add(e.substring(0,a))}return t}(e),[e]);Tt.useEffect(()=>{function e(e){"Escape"===e.key&&r()}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[r]),Tt.useEffect(()=>{if(h&&0===h.errors.length){const e=setTimeout(()=>{r()},1500);return()=>clearTimeout(e)}},[h,r]);const b=Tt.useCallback(e=>{e.target===e.currentTarget&&r()},[r]),_=Tt.useCallback(e=>{const t=e.replace(/\\/g,"/");x.has(t)||o(e)},[x]),w=Tt.useCallback(async()=>{if(!s||d)return;const a=e.map(e=>e.path);u(!0),f(null);try{const e=await sI(t,a,s,n,l);p(e),e.moved.length>0&&i()}catch(r){const e=r instanceof Error?r.message:"Move operation failed";f(e)}finally{u(!1)}},[s,d,e,t,n,l,i]),S=null!==s&&!d&&!h,M=Ut.jsx("div",{className:"gallery-move-overlay",style:jI.overlay,onClick:b,children:Ut.jsxs("div",{className:"gallery-move-dialog",style:jI.dialog,role:"dialog","aria-modal":"true","aria-label":`Move ${e.length} file(s)`,children:[Ut.jsxs("div",{className:"gallery-move-header",style:jI.header,children:["Move ",e.length," file",1!==e.length?"s":""]}),Ut.jsxs("div",{className:"gallery-move-body",style:jI.body,children:[h&&Ut.jsxs("div",{className:"gallery-move-result",style:jI.resultBox,children:[Ut.jsxs("div",{children:[Ut.jsx(dE,{size:13,style:{verticalAlign:"middle",marginRight:4,color:"#4ade80"}}),"Moved ",h.moved.length,h.skipped.length>0&&`, Skipped ${h.skipped.length}`,h.errors.length>0&&Ut.jsxs("span",{style:{color:"#f87171"},children:[", Errors ",h.errors.length]})]}),h.errors.length>0&&Ut.jsx("div",{className:"gallery-move-errors",style:jI.errorList,children:h.errors.map((e,t)=>Ut.jsx("div",{children:e},t))})]}),m&&!h&&Ut.jsx("div",{className:"gallery-move-error",style:{...jI.resultBox,borderColor:"#ef4444",color:"#f87171"},children:m}),!h&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{children:[Ut.jsx("div",{style:jI.label,children:"Destination folder"}),Ut.jsxs("div",{className:"gallery-move-folder-list",style:jI.folderList,children:[y.map(e=>{const t=e.folder.path.replace(/\\/g,"/"),n=x.has(t),a=s===e.folder.path,r=g===e.folder.path&&!n&&!a,i={...jI.folderRow,paddingLeft:18*e.depth+10+"px",...a?jI.folderRowSelected:{},...n?jI.folderRowDimmed:{},...r?jI.folderRowHover:{}};return Ut.jsxs("div",{className:"gallery-move-folder-row"+(a?" gallery-move-folder-row--selected":"")+(n?" gallery-move-folder-row--dimmed":""),style:i,onClick:()=>_(e.folder.path),onMouseEnter:()=>v(e.folder.path),onMouseLeave:()=>v(null),title:n?"Source folder (cannot move here)":e.folder.rel_path,children:[Ut.jsx(LE,{size:14}),Ut.jsx("span",{style:{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.displayName}),a&&Ut.jsx(dE,{size:14})]},e.folder.path)}),0===y.length&&Ut.jsx("div",{style:{padding:"12px 14px",color:"var(--color-text-muted, #666)"},children:"No folders available"})]})]}),Ut.jsxs("div",{children:[Ut.jsx("div",{style:jI.label,children:"If file already exists"}),Ut.jsx("div",{className:"gallery-move-conflict",style:jI.conflictRow,children:Ut.jsxs("select",{className:"gallery-move-select",style:jI.select,value:l,onChange:e=>c(e.target.value),children:[Ut.jsx("option",{value:"skip",children:"Skip existing"}),Ut.jsx("option",{value:"overwrite",children:"Overwrite"}),Ut.jsx("option",{value:"rename",children:"Auto-rename"})]})})]})]})]}),Ut.jsxs("div",{className:"gallery-move-footer",style:jI.footer,children:[Ut.jsx("button",{className:"gallery-move-btn gallery-move-btn--cancel",style:jI.btn,onClick:r,type:"button",children:h?"Close":"Cancel"}),!h&&Ut.jsx("button",{className:"gallery-move-btn gallery-move-btn--move",style:{...jI.btn,...jI.btnPrimary,...S?{}:jI.btnDisabled},onClick:w,disabled:!S,type:"button",children:d?"Moving...":"Move"})]})]})});return Wh.createPortal(M,document.body)}const RI=[{token:"{original}",description:"Original filename (no extension)"},{token:"{index}",description:"Sequential number (auto-padded)"},{token:"{date}",description:"File date (YYYY-MM-DD)"},{token:"{time}",description:"File time (HHMMSS)"},{token:"{year}",description:"Year (YYYY)"},{token:"{month}",description:"Month (MM)"},{token:"{day}",description:"Day (DD)"},{token:"{project}",description:"Project name"},{token:"{folder}",description:"Parent folder name"},{token:"{ext}",description:"Original extension without dot (e.g. png)"}],II={backdrop:{position:"fixed",inset:0,background:"rgba(0, 0, 0, 0.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4},dialog:{background:"var(--color-bg-secondary, #1e1e1e)",border:"1px solid var(--color-border, #333)",borderRadius:"10px",width:"660px",maxWidth:"90vw",maxHeight:"85vh",display:"flex",flexDirection:"column",boxShadow:"0 16px 48px rgba(0, 0, 0, 0.5)",overflow:"hidden"},header:{padding:"16px 20px 12px",borderBottom:"1px solid var(--color-border, #333)",fontSize:"15px",fontWeight:600,color:"var(--color-text-primary, #eee)"},body:{padding:"16px 20px",display:"flex",flexDirection:"column",gap:"14px",overflowY:"auto",flex:1},fieldGroup:{display:"flex",flexDirection:"column",gap:"5px"},label:{fontSize:"12px",fontWeight:500,color:"var(--color-text-secondary, #bbb)"},input:{height:"34px",lineHeight:"34px",padding:"0 10px",background:"var(--color-bg-tertiary, #2a2a2a)",border:"1px solid var(--color-border, #444)",borderRadius:"5px",color:"var(--color-text-primary, #eee)",fontSize:"13px",outline:"none",fontFamily:"'Segoe UI', system-ui, -apple-system, sans-serif",width:"100%",boxSizing:"border-box"},inputSmall:{width:"80px"},row:{display:"flex",gap:"12px",alignItems:"flex-end"},tokenGrid:{display:"flex",flexWrap:"wrap",gap:"4px 8px",padding:"8px 10px",background:"var(--color-bg-primary, #141414)",border:"1px solid var(--color-border, #333)",borderRadius:"5px"},tokenItem:{display:"inline-flex",alignItems:"center",gap:"4px",fontSize:"11px",lineHeight:"20px"},tokenCode:{fontFamily:"'SF Mono', 'Fira Code', 'Consolas', monospace",fontSize:"11px",color:"var(--color-accent, #5b9aff)",cursor:"pointer",padding:"1px 5px",borderRadius:"3px",background:"rgba(91, 154, 255, 0.1)",border:"1px solid rgba(91, 154, 255, 0.15)",transition:"background 0.1s"},tokenDesc:{color:"var(--color-text-muted, #777)",fontSize:"10px"},previewTable:{width:"100%",borderCollapse:"collapse",fontSize:"12px"},th:{padding:"6px 8px",textAlign:"left",fontWeight:500,fontSize:"11px",color:"var(--color-text-muted, #888)",borderBottom:"1px solid var(--color-border, #333)",whiteSpace:"nowrap"},td:{padding:"5px 8px",color:"var(--color-text-secondary, #bbb)",borderBottom:"1px solid var(--color-border, #222)",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"260px",fontFamily:"'Segoe UI', system-ui, -apple-system, sans-serif"},tdIndex:{width:"36px",textAlign:"right",color:"var(--color-text-muted, #666)",fontVariantNumeric:"tabular-nums"},tdArrow:{width:"28px",textAlign:"center",color:"var(--color-text-muted, #555)"},tdNew:{color:"var(--color-accent, #5b9aff)",fontWeight:500},previewScroll:{maxHeight:"240px",overflowY:"auto",border:"1px solid var(--color-border, #333)",borderRadius:"5px",background:"var(--color-bg-primary, #141414)"},footer:{display:"flex",justifyContent:"flex-end",gap:"8px",padding:"12px 20px",borderTop:"1px solid var(--color-border, #333)"},btn:{height:"32px",padding:"0 16px",borderRadius:"5px",fontSize:"13px",fontWeight:500,cursor:"pointer",border:"1px solid var(--color-border, #444)",background:"var(--color-bg-tertiary, #2a2a2a)",color:"var(--color-text-primary, #eee)",transition:"opacity 0.12s",fontFamily:"inherit"},btnPrimary:{background:"var(--color-accent, #5b9aff)",borderColor:"var(--color-accent, #5b9aff)",color:"#fff"},btnDisabled:{opacity:.4,cursor:"not-allowed"},error:{padding:"8px 10px",background:"rgba(218, 54, 51, 0.12)",border:"1px solid rgba(218, 54, 51, 0.3)",borderRadius:"5px",fontSize:"12px",color:"#da3633"},success:{padding:"8px 10px",background:"rgba(63, 185, 80, 0.12)",border:"1px solid rgba(63, 185, 80, 0.3)",borderRadius:"5px",fontSize:"13px",color:"#3fb950",fontWeight:500,textAlign:"center"}};function LI({files:e,orchestratorUrl:t,projectPath:n,onClose:a,onRenamed:r}){const[i,s]=Tt.useState("{original}"),[o,l]=Tt.useState(1),[c,d]=Tt.useState(3),[u,h]=Tt.useState("input"),[p,m]=Tt.useState([]),[f,g]=Tt.useState(null),[v,y]=Tt.useState(0),x=Tt.useRef(null),b=Tt.useRef(null),_=Tt.useRef(null),w=Tt.useMemo(()=>[...e].sort((e,t)=>e.created-t.created).map(e=>e.path),[e]),S=Tt.useMemo(()=>{return e=function(e,t){if(!e.includes("{project}"))return e;let n="";try{const e=localStorage.getItem("storyboard_project_settings");if(e){const t=JSON.parse(e);t.name&&"string"==typeof t.name&&(n=t.name)}}catch{}if(!n&&t){const e=t.replace(/[\\/]+$/,"").split(/[\\/]/);n=e[e.length-1]||""}return n||(n="project"),e.replace(/\{project\}/g,n)}(i,n),e.replace(/[/\\]/g,"");var e},[i,n]),M=Tt.useCallback(e=>{const t=b.current;if(!t)return void s(t=>t+e);const n=t.selectionStart??i.length,a=t.selectionEnd??i.length,r=i.slice(0,n),o=i.slice(a);s(r+e+o),requestAnimationFrame(()=>{const a=n+e.length;t.setSelectionRange(a,a),t.focus()})},[i]);Tt.useEffect(()=>{function e(e){"Escape"===e.key&&a()}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[a]),Tt.useEffect(()=>{if("done"!==u)return;const e=setTimeout(()=>{r(),a()},1500);return()=>clearTimeout(e)},[u,r,a]),Tt.useEffect(()=>{if("applying"===u||"done"===u)return;if(!S.trim()||0===w.length)return void m([]);_.current&&_.current.abort();const e=new AbortController;_.current=e;const a=setTimeout(async()=>{if(!e.signal.aborted){g(null);try{const a=await lI(t,w,S,o,c,n,!0);if(e.signal.aborted)return;if(!a.success)return g(a.message||"Preview failed."),void m([]);m(a.previews),h("previewed")}catch(a){if(e.signal.aborted)return;const t=a instanceof Error?a.message:String(a);g(t),m([])}}},500);return()=>{clearTimeout(a),e.abort()}},[S,o,c,t,w,n]);const C=Tt.useCallback(async()=>{h("applying"),g(null);try{const e=await lI(t,w,S,o,c,n,!1);if(!e.success)return g(e.message||"Rename failed."),void h("previewed");if(e.errors.length>0)return g(`Renamed ${e.renamed} files, but ${e.errors.length} error(s): ${e.errors[0]}`),void h("previewed");if(y(e.renamed),h("done"),e.previews&&e.previews.length>0){const t={};for(const n of e.previews)n.old_path!==n.new_path&&(t[n.old_path]=n.new_path);Object.keys(t).length>0&&window.dispatchEvent(new CustomEvent("gallery:files-renamed",{detail:{renameMap:t}}))}}catch(e){const t=e instanceof Error?e.message:String(e);g(t),h("previewed")}},[t,w,S,o,c,n]),E=Tt.useCallback(e=>{x.current&&!x.current.contains(e.target)&&a()},[a]),k="applying"===u,T=k||"done"===u,N="previewed"===u&&p.length>0&&!k,P=Ut.jsx("div",{className:"gallery-batch-rename-backdrop",style:II.backdrop,onClick:E,children:Ut.jsxs("div",{ref:x,className:"gallery-batch-rename-dialog",style:II.dialog,onKeyDown:e=>{"Escape"!==e.key&&e.stopPropagation()},children:[Ut.jsxs("div",{className:"gallery-batch-rename-header",style:II.header,children:["Batch Rename ",e.length," file",1!==e.length?"s":""]}),Ut.jsxs("div",{className:"gallery-batch-rename-body",style:II.body,children:[Ut.jsxs("div",{className:"gallery-batch-rename-field",style:II.fieldGroup,children:[Ut.jsx("label",{className:"gallery-batch-rename-label",style:II.label,children:"Naming Pattern"}),Ut.jsx("input",{ref:b,className:"gallery-batch-rename-input",style:II.input,type:"text",value:i,onChange:e=>s(e.target.value),placeholder:"Background_{index}",disabled:T,autoFocus:!0})]}),Ut.jsx("div",{style:II.tokenGrid,children:RI.map(({token:e,description:t})=>Ut.jsxs("span",{style:II.tokenItem,children:[Ut.jsx("code",{style:II.tokenCode,title:`Click to insert ${e}`,onClick:()=>M(e),onMouseOver:e=>{e.target.style.background="rgba(91, 154, 255, 0.25)"},onMouseOut:e=>{e.target.style.background="rgba(91, 154, 255, 0.1)"},children:e}),Ut.jsx("span",{style:II.tokenDesc,children:t})]},e))}),Ut.jsxs("div",{style:II.row,children:[Ut.jsxs("div",{className:"gallery-batch-rename-field",style:II.fieldGroup,children:[Ut.jsx("label",{className:"gallery-batch-rename-label",style:II.label,children:"Start At"}),Ut.jsx("input",{className:"gallery-batch-rename-input",style:{...II.input,...II.inputSmall},type:"number",min:0,value:o,onChange:e=>l(parseInt(e.target.value,10)||0),disabled:T})]}),Ut.jsxs("div",{className:"gallery-batch-rename-field",style:II.fieldGroup,children:[Ut.jsx("label",{className:"gallery-batch-rename-label",style:II.label,children:"Padding (digits)"}),Ut.jsx("input",{className:"gallery-batch-rename-input",style:{...II.input,...II.inputSmall},type:"number",min:1,max:6,value:c,onChange:e=>{const t=parseInt(e.target.value,10);t>=1&&t<=6&&d(t)},disabled:T})]}),Ut.jsxs("div",{style:{fontSize:"11px",color:"var(--color-text-muted, #888)",paddingBottom:"7px"},children:["e.g. ",String(o).padStart(c,"0")]})]}),f&&Ut.jsx("div",{className:"gallery-batch-rename-error",style:II.error,children:f}),"done"!==u&&Ut.jsx("div",{className:"gallery-batch-rename-preview",style:II.previewScroll,children:p.length>0?Ut.jsxs("table",{className:"gallery-batch-rename-table",style:II.previewTable,children:[Ut.jsx("thead",{children:Ut.jsxs("tr",{children:[Ut.jsx("th",{style:{...II.th,...II.tdIndex},children:"#"}),Ut.jsx("th",{style:II.th,children:"Old Name"}),Ut.jsx("th",{style:{...II.th,...II.tdArrow}}),Ut.jsx("th",{style:II.th,children:"New Name"})]})}),Ut.jsx("tbody",{children:p.map((e,t)=>Ut.jsxs("tr",{children:[Ut.jsx("td",{style:{...II.td,...II.tdIndex},children:t+1}),Ut.jsx("td",{style:II.td,title:e.old_name,children:e.old_name}),Ut.jsx("td",{style:{...II.td,...II.tdArrow},children:""}),Ut.jsx("td",{style:{...II.td,...e.old_name!==e.new_name?II.tdNew:{}},title:e.new_name,children:e.new_name})]},e.old_path))})]}):Ut.jsx("div",{style:{padding:"16px",textAlign:"center",color:"var(--color-text-muted, #666)",fontSize:"12px"},children:i.trim()?"Updating preview...":"Type a pattern or click a token to get started"})}),"done"===u&&Ut.jsxs("div",{className:"gallery-batch-rename-success",style:II.success,children:["Renamed ",v," file",1!==v?"s":""]})]}),"done"!==u&&Ut.jsxs("div",{className:"gallery-batch-rename-footer",style:II.footer,children:[Ut.jsx("button",{className:"gallery-batch-rename-btn",style:II.btn,onClick:a,disabled:k,children:"Cancel"}),Ut.jsx("button",{className:"gallery-batch-rename-btn gallery-batch-rename-btn--primary",style:{...II.btn,...II.btnPrimary,...N?{}:II.btnDisabled},disabled:!N,onClick:C,children:"applying"===u?"Renaming...":"Apply"})]})]})});return Wh.createPortal(P,document.body)}function DI(e){return e<0?"0 B":e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:e<1073741824?`${(e/1048576).toFixed(1)} MB`:`${(e/1073741824).toFixed(2)} GB`}function UI(e){const t=new Date(e);if(isNaN(t.getTime()))return e;const n=Date.now()-t.getTime(),a=Math.floor(n/1e3),r=Math.floor(a/60),i=Math.floor(r/60),s=Math.floor(i/24);if(a<60)return"just now";if(r<60)return`${r}m ago`;if(i<24)return`${i}h ago`;if(s<7)return`${s}d ago`;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}`}function OI(e){const t=e.replace(/\\/g,"/").split("/");return t[t.length-1]||e}function FI({orchestratorUrl:e,projectPath:t,onClose:n,onRestored:a}){const[r,i]=Tt.useState([]),[s,o]=Tt.useState(0),[l,c]=Tt.useState(!0),[d,u]=Tt.useState(null),[h,p]=Tt.useState(new Set),[m,f]=Tt.useState(!1),[g,v]=Tt.useState(null),[y,x]=Tt.useState(!1),b=Tt.useRef(0),_=Tt.useCallback(async()=>{const n=++b.current;c(!0),u(null),v(null);try{const a=await async function(e,t){return rI(`${e}/api/gallery/trash?${new URLSearchParams({project_path:t}).toString()}`)}(e,t);if(n!==b.current)return;a.success?(i(a.files),o(a.total_size),p(new Set)):(u(a.message||"Failed to load trash contents."),i([]),o(0))}catch(a){if(n!==b.current)return;u(a instanceof Error?a.message:"Failed to load trash contents."),i([]),o(0)}finally{n===b.current&&c(!1)}},[e,t]);Tt.useEffect(()=>{_()},[_]),Tt.useEffect(()=>{function e(e){"Escape"===e.key&&(y?x(!1):n())}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[n,y]);const w=Tt.useCallback(e=>{p(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},[]),S=Tt.useCallback(()=>{p(e=>e.size===r.length?new Set:new Set(r.map(e=>e.path)))},[r]),M=Tt.useCallback(async()=>{if(0!==h.size&&!m){f(!0),v(null);try{const n=await async function(e,t,n){return aI(`${e}/api/gallery/restore`,{file_paths:t,project_path:n})}(e,Array.from(h),t);v({type:"restore",restoredCount:n.restored.length,errorCount:n.errors.length,message:n.message}),await _(),a()}catch(n){const e=n instanceof Error?n.message:"Restore failed.";v({type:"restore",restoredCount:0,errorCount:h.size,message:e})}finally{f(!1)}}},[h,m,e,t,_,a]),C=Tt.useCallback(async()=>{if(!m){f(!0),v(null),x(!1);try{const n=await async function(e,t){return aI(`${e}/api/gallery/empty-trash`,{project_path:t})}(e,t);v({type:"empty",restoredCount:0,errorCount:n.success?0:1,message:n.message}),await _(),a()}catch(n){const e=n instanceof Error?n.message:"Empty trash failed.";v({type:"empty",restoredCount:0,errorCount:1,message:e})}finally{f(!1)}}},[m,e,t,_,a]),E=Tt.useCallback(e=>{e.target===e.currentTarget&&n()},[n]),k=r.length>0&&h.size===r.length,T=h.size>0&&h.size<r.length;return Wh.createPortal(Ut.jsx("div",{className:"gallery-trash-backdrop",onClick:E,style:zI,children:Ut.jsxs("div",{className:"gallery-trash-panel",style:BI,children:[Ut.jsxs("div",{className:"gallery-trash-header",style:HI,children:[Ut.jsxs("div",{style:$I,children:[Ut.jsx(Ck,{size:18,style:{color:"#f87171",flexShrink:0}}),Ut.jsx("h3",{style:VI,children:"Trash"}),!l&&Ut.jsxs("span",{className:"gallery-trash-badge",style:WI,children:[r.length," file",1!==r.length?"s":"",s>0&&Ut.jsxs("span",{style:GI,children:["  ",DI(s)]})]})]}),Ut.jsx("button",{className:"gallery-trash-close-btn",type:"button",onClick:n,style:XI,title:"Close",children:Ut.jsx(Nk,{size:18})})]}),g&&Ut.jsx("div",{className:"gallery-trash-result",style:{...qI,borderColor:g.errorCount>0?"#f87171":"#4ade80",background:g.errorCount>0?"rgba(248,113,113,0.1)":"rgba(74,222,128,0.1)"},children:Ut.jsxs("span",{style:{fontSize:"13px",color:"#e0e0e0"},children:["restore"===g.type&&g.restoredCount>0&&Ut.jsxs(Ut.Fragment,{children:["Restored ",g.restoredCount," file",1!==g.restoredCount?"s":"",". "]}),g.errorCount>0&&Ut.jsxs(Ut.Fragment,{children:[g.errorCount," error",1!==g.errorCount?"s":"",". "]}),"empty"===g.type&&0===g.errorCount&&Ut.jsx(Ut.Fragment,{children:"Trash emptied. "})]})}),l&&Ut.jsxs("div",{className:"gallery-trash-loading",style:KI,children:[Ut.jsx("span",{style:YI}),Ut.jsx("span",{style:{color:"#aaa",fontSize:"14px"},children:"Loading trash contents..."})]}),!l&&d&&Ut.jsxs("div",{className:"gallery-trash-error",style:KI,children:[Ut.jsx(Ek,{size:24,style:{color:"#f87171"}}),Ut.jsx("span",{style:{color:"#f87171",fontSize:"14px"},children:d})]}),!l&&!d&&0===r.length&&Ut.jsxs("div",{className:"gallery-trash-empty",style:KI,children:[Ut.jsx(Ck,{size:32,style:{color:"#555"}}),Ut.jsx("span",{style:{color:"#888",fontSize:"14px",marginTop:"8px"},children:"Trash is empty"})]}),!l&&!d&&r.length>0&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{className:"gallery-trash-toolbar",style:JI,children:[Ut.jsxs("label",{style:ZI,children:[Ut.jsx("input",{type:"checkbox",checked:k,ref:e=>{e&&(e.indeterminate=T)},onChange:S,style:QI}),Ut.jsx("span",{style:{fontSize:"13px",color:"#aaa"},children:k?"Deselect all":"Select all"})]}),Ut.jsxs("div",{style:eL,children:[Ut.jsxs("button",{className:"gallery-trash-restore-btn",type:"button",onClick:M,disabled:0===h.size||m,style:{...tL,opacity:0===h.size||m?.4:1,cursor:0===h.size||m?"not-allowed":"pointer"},title:"Restore selected files",children:[Ut.jsx(dk,{size:14}),Ut.jsx("span",{children:m?"Restoring...":"Restore"+(h.size>0?` (${h.size})`:"")})]}),Ut.jsxs("button",{className:"gallery-trash-empty-btn",type:"button",onClick:()=>x(!0),disabled:m,style:{...nL,opacity:m?.4:1,cursor:m?"not-allowed":"pointer"},title:"Permanently delete all files",children:[Ut.jsx(Ck,{size:14}),Ut.jsx("span",{children:"Empty Trash"})]})]})]}),Ut.jsx("div",{className:"gallery-trash-list",style:aL,children:r.map(e=>{const t=h.has(e.path);return Ut.jsxs("div",{className:"gallery-trash-row",style:{...rL,background:t?"rgba(59,130,246,0.1)":"transparent"},onClick:()=>w(e.path),children:[Ut.jsx("input",{type:"checkbox",checked:t,onChange:()=>w(e.path),onClick:e=>e.stopPropagation(),style:QI}),Ut.jsxs("div",{style:iL,children:[Ut.jsx("span",{className:"gallery-trash-filename",style:sL,children:OI(e.name)}),Ut.jsx("span",{className:"gallery-trash-original-path",style:oL,title:e.original_path,children:e.original_path})]}),Ut.jsx("span",{className:"gallery-trash-size",style:lL,children:DI(e.size)}),Ut.jsx("span",{className:"gallery-trash-date",style:cL,title:e.trashed_at,children:UI(e.trashed_at)})]},e.path)})})]}),y&&Ut.jsx("div",{className:"gallery-trash-confirm-backdrop",style:dL,children:Ut.jsxs("div",{className:"gallery-trash-confirm-dialog",style:uL,children:[Ut.jsx(Ek,{size:28,style:{color:"#f87171",flexShrink:0}}),Ut.jsxs("div",{style:hL,children:[Ut.jsxs("strong",{style:{color:"#fff",fontSize:"14px"},children:["Permanently delete all ",r.length," file",1!==r.length?"s":"","?"]}),Ut.jsx("span",{style:{color:"#aaa",fontSize:"13px",marginTop:"4px"},children:"This action cannot be undone."})]}),Ut.jsxs("div",{style:pL,children:[Ut.jsx("button",{type:"button",onClick:()=>x(!1),style:mL,children:"Cancel"}),Ut.jsx("button",{type:"button",onClick:C,style:fL,children:"Delete All"})]})]})})]})}),document.body)}const zI={position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.6)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e4},BI={position:"relative",background:"#1e1e2e",borderRadius:"10px",width:"680px",maxWidth:"95vw",maxHeight:"85vh",display:"flex",flexDirection:"column",boxShadow:"0 12px 40px rgba(0, 0, 0, 0.6)",color:"#e0e0e0",overflow:"hidden"},HI={display:"flex",alignItems:"center",justifyContent:"space-between",padding:"16px 20px",borderBottom:"1px solid #333",flexShrink:0},$I={display:"flex",alignItems:"center",gap:"10px"},VI={margin:0,fontSize:"16px",fontWeight:600,color:"#fff"},WI={fontSize:"12px",color:"#aaa",background:"#2a2a3e",padding:"2px 8px",borderRadius:"10px"},GI={color:"#888"},XI={background:"none",border:"none",color:"#888",cursor:"pointer",padding:"4px",borderRadius:"4px",display:"flex",alignItems:"center",justifyContent:"center"},qI={padding:"8px 20px",borderBottom:"1px solid #333",borderLeft:"3px solid",flexShrink:0},KI={display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"48px 20px",gap:"12px",flex:1},YI={display:"inline-block",width:"24px",height:"24px",border:"2px solid #444",borderTopColor:"#3b82f6",borderRadius:"50%",animation:"gallery-trash-spin 0.8s linear infinite"},JI={display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 20px",borderBottom:"1px solid #2a2a3e",flexShrink:0,gap:"12px"},ZI={display:"flex",alignItems:"center",gap:"8px",cursor:"pointer",userSelect:"none"},QI={width:"15px",height:"15px",accentColor:"#3b82f6",cursor:"pointer",flexShrink:0},eL={display:"flex",alignItems:"center",gap:"8px"},tL={display:"inline-flex",alignItems:"center",gap:"6px",padding:"5px 12px",fontSize:"13px",background:"#2563eb",border:"none",borderRadius:"4px",color:"#fff",fontWeight:500},nL={display:"inline-flex",alignItems:"center",gap:"6px",padding:"5px 12px",fontSize:"13px",background:"#991b1b",border:"none",borderRadius:"4px",color:"#fff",fontWeight:500},aL={overflowY:"auto",flex:1,minHeight:0},rL={display:"flex",alignItems:"center",gap:"12px",padding:"8px 20px",borderBottom:"1px solid #2a2a3e",cursor:"pointer",transition:"background 0.1s"},iL={flex:1,minWidth:0,display:"flex",flexDirection:"column",gap:"2px"},sL={fontSize:"13px",fontWeight:500,color:"#e0e0e0",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},oL={fontSize:"11px",color:"#666",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},lL={fontSize:"12px",color:"#888",whiteSpace:"nowrap",flexShrink:0,minWidth:"60px",textAlign:"right"},cL={fontSize:"12px",color:"#888",whiteSpace:"nowrap",flexShrink:0,minWidth:"80px",textAlign:"right"},dL={position:"absolute",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",borderRadius:"10px",zIndex:1},uL={background:"#252535",borderRadius:"8px",padding:"20px 24px",display:"flex",flexDirection:"column",alignItems:"center",gap:"12px",maxWidth:"360px",width:"90%",boxShadow:"0 8px 24px rgba(0,0,0,0.4)"},hL={display:"flex",flexDirection:"column",alignItems:"center",textAlign:"center",gap:"4px"},pL={display:"flex",gap:"10px",marginTop:"8px"},mL={padding:"6px 18px",fontSize:"13px",background:"transparent",border:"1px solid #555",borderRadius:"4px",color:"#ccc",cursor:"pointer"},fL={padding:"6px 18px",fontSize:"13px",background:"#dc2626",border:"none",borderRadius:"4px",color:"#fff",fontWeight:600,cursor:"pointer"},gL="gallery-trash-keyframes";if("undefined"!=typeof document&&!document.getElementById(gL)){const e=document.createElement("style");e.id=gL,e.textContent="@keyframes gallery-trash-spin { to { transform: rotate(360deg); } }",document.head.appendChild(e)}const vL=["#ef4444","#f97316","#eab308","#22c55e","#06b6d4","#3b82f6","#8b5cf6","#ec4899"];function yL({allTags:e,fileTags:t,orchestratorUrl:n,projectPath:a,onAddTag:r,onCreateTag:i}){const[s,o]=Tt.useState(!1),[l,c]=Tt.useState(!1),[d,u]=Tt.useState(""),[h,p]=Tt.useState("#3b82f6"),m=Tt.useRef(null);Tt.useEffect(()=>{if(s)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e);function e(e){m.current&&!m.current.contains(e.target)&&(o(!1),c(!1))}},[s]);const f=e.filter(e=>!t.some(t=>t.id===e.id)),g=Tt.useCallback(e=>{r(e),o(!1),c(!1)},[r]),v=Tt.useCallback(()=>{const e=d.trim();e&&(i(e,h),u(""),c(!1))},[d,h,i]),y=Tt.useCallback(()=>{o(e=>(e&&c(!1),!e))},[]),x=Tt.useCallback(e=>{"Enter"===e.key&&v()},[v]);return Ut.jsxs("div",{className:"tag-manager",ref:m,children:[Ut.jsxs("button",{className:"tag-manager-trigger",onClick:y,type:"button",children:[Ut.jsx(sk,{size:14}),"Add tag..."]}),s&&Ut.jsxs("div",{className:"tag-manager-dropdown",children:[0===f.length&&!l&&Ut.jsx("div",{className:"tag-manager-empty",children:"All tags assigned"}),f.map(e=>Ut.jsxs("button",{className:"tag-manager-tag-row",onClick:()=>g(e.id),type:"button",children:[Ut.jsx("span",{className:"tag-manager-tag-dot",style:{backgroundColor:e.color}}),Ut.jsx("span",{className:"tag-manager-tag-name",children:e.name})]},e.id)),l?Ut.jsxs("div",{className:"tag-manager-create-section",children:[Ut.jsx("input",{className:"tag-manager-input",type:"text",placeholder:"Tag name",value:d,onChange:e=>u(e.target.value),onKeyDown:x,autoFocus:!0}),Ut.jsx("div",{className:"tag-manager-color-swatches",children:vL.map(e=>Ut.jsx("button",{className:"tag-manager-color-swatch"+(h===e?" tag-manager-color-swatch--selected":""),style:{backgroundColor:e},onClick:()=>p(e),type:"button","aria-label":`Select color ${e}`},e))}),Ut.jsxs("button",{className:"tag-manager-submit-btn",onClick:v,disabled:0===d.trim().length,type:"button",children:[Ut.jsx(dE,{size:14}),"Create"]})]}):Ut.jsxs("button",{className:"tag-manager-create-btn",onClick:()=>c(!0),type:"button",children:[Ut.jsx(tk,{size:14}),"Create new tag"]})]})]})}function xL({tag:e,onRemove:t,size:n="normal"}){return Ut.jsxs("span",{className:"tag-badge "+("small"===n?"tag-badge--small":""),style:{backgroundColor:`${e.color}20`,borderColor:`${e.color}4D`,color:e.color},children:[Ut.jsx("span",{className:"tag-badge-name",children:e.name}),t&&Ut.jsx("button",{className:"tag-badge-remove",onClick:e=>{e.stopPropagation(),t()},"aria-label":`Remove tag ${e.name}`,children:Ut.jsx(Nk,{size:"small"===n?8:10})})]})}function bL(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,t)).toFixed(t>0?1:0)} ${["B","KB","MB","GB"][t]}`}function _L(e){return e?new Date(1e3*e).toLocaleString():""}function wL({file:e,orchestratorUrl:t,projectPath:n,rating:a,fileTags:r,allTags:i,onRatingChange:s,onTagsChange:o,onClose:l,onNotesChange:c,onCreateTag:d}){const[u,h]=Tt.useState(null),[p,m]=Tt.useState(null),[f,g]=Tt.useState(""),[v,y]=Tt.useState(!1),[x,b]=Tt.useState(!0),[_,w]=Tt.useState(!1),[S,M]=Tt.useState(!1),[C,E]=Tt.useState(!1),k=Tt.useRef(null),T=Tt.useRef(e.path),N="video"===e.type,P=".png"===e.extension.toLowerCase(),j=`${t}/api/serve-image?path=${encodeURIComponent(e.path)}`;Tt.useEffect(()=>{let a=!1;return T.current!==e.path&&(h(null),m(null),g(""),y(!1),w(!1),E(!1),T.current=e.path),async function(){var r,i;M(!0);try{const s=await async function(e,t,n){return aI(`${e}/api/gallery/file-info`,{file_path:t,project_path:n})}(t,e.path,n);if(a)return;s.success&&(s.png_metadata&&h(s.png_metadata),(null==(r=s.file)?void 0:r.width)&&(null==(i=s.file)?void 0:i.height)&&m({width:s.file.width,height:s.file.height}))}catch{}finally{a||M(!1)}}(),()=>{a=!0}},[e.path,t,n]);const A=Tt.useCallback(t=>{s(e.rel_path,t)},[e.rel_path,s]),R=Tt.useCallback(t=>{o(e.rel_path,[t],"remove")},[e.rel_path,o]),I=Tt.useCallback(t=>{o(e.rel_path,[t],"add")},[e.rel_path,o]),L=Tt.useCallback((e,t)=>{d&&d(e,t)},[d]),D=Tt.useCallback(()=>{N||window.open(j,"_blank")},[N,j]),U=Tt.useCallback(()=>{y(!1),c&&c(e.rel_path,f)},[e.rel_path,f,c]),O=Tt.useCallback(()=>{v?U():(y(!0),requestAnimationFrame(()=>{var e;null==(e=k.current)||e.focus()}))},[v,U]);function F(e,t){if(null==t)return null;if("prompt"===e){const n=function(e){if(!e||"object"!=typeof e)return null;const t=e,n={},a=[];for(const[r,i]of Object.entries(t)){if(!i||"object"!=typeof i||!i.class_type)continue;const e=i.class_type,t=i.inputs||{};"CheckpointLoaderSimple"!==e&&"CheckpointLoader"!==e||t.ckpt_name&&"string"==typeof t.ckpt_name&&(n.checkpoint=t.ckpt_name),"UNETLoader"!==e&&"UnetLoader"!==e||t.unet_name&&"string"==typeof t.unet_name&&!n.checkpoint&&(n.checkpoint=t.unet_name),(e.includes("KSampler")||"SamplerCustom"===e)&&(t.sampler_name&&"string"==typeof t.sampler_name&&(n.sampler=t.sampler_name),t.scheduler&&"string"==typeof t.scheduler&&(n.scheduler=t.scheduler),"number"==typeof t.steps&&(n.steps=t.steps),"number"==typeof t.cfg&&(n.cfg=t.cfg),"number"==typeof t.denoise&&(n.denoise=t.denoise),void 0!==t.seed&&(n.seed=Number(t.seed))),"CLIPTextEncode"===e&&t.text&&"string"==typeof t.text&&a.push({text:t.text,nodeId:r}),"EmptyLatentImage"===e&&("number"==typeof t.width&&(n.image_width=t.width),"number"==typeof t.height&&(n.image_height=t.height)),"LoraLoader"!==e&&"LoraLoaderModelOnly"!==e||t.lora_name&&"string"==typeof t.lora_name&&(n.loras||(n.loras=[]),n.loras.push({name:t.lora_name,strength:"number"==typeof t.strength_model?t.strength_model:1}))}return a.length>=2?(a.sort((e,t)=>t.text.length-e.text.length),n.positive_prompt=a[0].text,n.negative_prompt=a[1].text):1===a.length&&(n.positive_prompt=a[0].text),Object.keys(n).length>0?n:null}("string"==typeof t?(()=>{try{return JSON.parse(t)}catch{return t}})():t);if(n)return Ut.jsxs("div",{className:"detail-panel-comfy-params",children:[n.positive_prompt&&Ut.jsxs("div",{className:"detail-panel-comfy-row",children:[Ut.jsx("span",{className:"detail-panel-comfy-label",children:"Prompt"}),Ut.jsx("span",{className:"detail-panel-comfy-text",children:n.positive_prompt})]}),n.negative_prompt&&Ut.jsxs("div",{className:"detail-panel-comfy-row",children:[Ut.jsx("span",{className:"detail-panel-comfy-label",children:"Negative"}),Ut.jsx("span",{className:"detail-panel-comfy-text",children:n.negative_prompt})]}),n.checkpoint&&Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-key",children:"Model"}),Ut.jsx("span",{className:"detail-panel-meta-value",title:n.checkpoint,children:n.checkpoint.split(/[/\\]/).pop()})]}),n.loras&&n.loras.length>0&&n.loras.map((e,t)=>Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-key",children:0===t?"LoRA":""}),Ut.jsxs("span",{className:"detail-panel-meta-value",title:e.name,children:[e.name.split(/[/\\]/).pop()," (",e.strength.toFixed(2),")"]})]},`lora-${t}`)),(n.sampler||n.steps)&&Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-key",children:"Sampler"}),Ut.jsx("span",{className:"detail-panel-meta-value",children:[n.sampler,n.scheduler,null!=n.steps?`${n.steps} steps`:null,null!=n.cfg?`cfg ${n.cfg}`:null,null!=n.denoise?`denoise ${n.denoise}`:null].filter(Boolean).join(", ")})]}),null!=n.seed&&Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-key",children:"Seed"}),Ut.jsx("span",{className:"detail-panel-meta-value",children:n.seed})]}),n.image_width&&n.image_height&&Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-key",children:"Latent Size"}),Ut.jsxs("span",{className:"detail-panel-meta-value",children:[n.image_width," ",""," ",n.image_height]})]}),Ut.jsx(SL,{label:"Raw Prompt Data",content:"string"==typeof t?t:JSON.stringify(t,null,2)})]},e);const a="string"==typeof t?t:JSON.stringify(t,null,2);return Ut.jsx(SL,{label:e,content:a},e)}if("workflow"===e){const n="string"==typeof t?t:JSON.stringify(t,null,2);return Ut.jsx(SL,{label:e,content:n},e)}const n="object"==typeof t?JSON.stringify(t):String(t);return Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-key",children:e}),Ut.jsx("span",{className:"detail-panel-meta-value",children:n})]},e)}return Ut.jsxs("div",{className:"detail-panel",children:[Ut.jsxs("div",{className:"detail-panel-header",children:[Ut.jsx("span",{className:"detail-panel-title",title:e.name,children:e.name}),Ut.jsx("button",{className:"detail-panel-close-btn",onClick:l,title:"Close detail panel",type:"button",children:Ut.jsx(Nk,{size:16})})]}),Ut.jsxs("div",{className:"detail-panel-body",children:[Ut.jsx("div",{className:"detail-panel-preview",children:C?Ut.jsx("div",{className:"detail-panel-preview-placeholder",children:N?Ut.jsx(jE,{size:48}):Ut.jsx(kE,{size:48})}):N?Ut.jsx("video",{className:"detail-panel-preview-video",src:j,controls:!0,loop:!0,muted:!0,onError:()=>E(!0)}):Ut.jsx("img",{className:"detail-panel-preview-image",src:j,alt:e.name,onClick:D,onError:()=>E(!0),draggable:!1})}),Ut.jsx("div",{className:"detail-panel-section",children:Ut.jsxs("div",{className:"detail-panel-section-row",children:[Ut.jsx("span",{className:"detail-panel-label",children:"Rating"}),Ut.jsx(iR,{rating:a,onRatingChange:A,size:16})]})}),Ut.jsxs("div",{className:"detail-panel-section",children:[Ut.jsxs("div",{className:"detail-panel-section-row",children:[Ut.jsx("span",{className:"detail-panel-label",children:"Tags"}),r.length>0&&Ut.jsx("span",{className:"detail-panel-count-badge",children:r.length})]}),r.length>0&&Ut.jsx("div",{className:"detail-panel-tags-list",children:r.map(e=>Ut.jsx(xL,{tag:e,onRemove:()=>R(e.id)},e.id))}),Ut.jsx(yL,{allTags:i,fileTags:r,orchestratorUrl:t,projectPath:n,onAddTag:I,onCreateTag:L})]}),Ut.jsxs("div",{className:"detail-panel-section",children:[Ut.jsxs("div",{className:"detail-panel-section-row",children:[Ut.jsx("span",{className:"detail-panel-label",children:"Notes"}),Ut.jsx("button",{className:"detail-panel-icon-btn",onClick:O,title:v?"Save notes":"Edit notes",type:"button",children:v?Ut.jsx(hk,{size:14}):Ut.jsx(rk,{size:14})})]}),v?Ut.jsx("textarea",{ref:k,className:"detail-panel-notes-textarea",value:f,onChange:e=>g(e.target.value),placeholder:"Add notes about this file...",rows:4}):Ut.jsx("div",{className:"detail-panel-notes-display",children:f||Ut.jsx("span",{className:"detail-panel-notes-empty",children:"No notes"})})]}),Ut.jsxs("div",{className:"detail-panel-section detail-panel-metadata",children:[Ut.jsxs("button",{className:"detail-panel-section-toggle",onClick:()=>b(e=>!e),type:"button",children:[x?Ut.jsx(uE,{size:14}):Ut.jsx(pE,{size:14}),Ut.jsx("span",{className:"detail-panel-label",children:"File Info"})]}),x&&Ut.jsxs("div",{className:"detail-panel-meta-grid",children:[Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-icon",children:Ut.jsx($E,{size:13})}),Ut.jsx("span",{className:"detail-panel-meta-key",children:"Name"}),Ut.jsx("span",{className:"detail-panel-meta-value",title:e.name,children:e.name})]}),Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-icon",children:N?Ut.jsx(jE,{size:13}):Ut.jsx(kE,{size:13})}),Ut.jsx("span",{className:"detail-panel-meta-key",children:"Type"}),Ut.jsx("span",{className:"detail-panel-meta-value",children:N?"Video":"Image"})]}),Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-icon",children:Ut.jsx($E,{size:13})}),Ut.jsx("span",{className:"detail-panel-meta-key",children:"Extension"}),Ut.jsx("span",{className:"detail-panel-meta-value",children:e.extension})]}),p&&Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-icon",children:Ut.jsx(kE,{size:13})}),Ut.jsx("span",{className:"detail-panel-meta-key",children:"Dimensions"}),Ut.jsxs("span",{className:"detail-panel-meta-value",children:[p.width," ",""," ",p.height]})]}),Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-icon",children:Ut.jsx(FE,{size:13})}),Ut.jsx("span",{className:"detail-panel-meta-key",children:"Size"}),Ut.jsx("span",{className:"detail-panel-meta-value",children:bL(e.size)})]}),Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-icon",children:Ut.jsx(cE,{size:13})}),Ut.jsx("span",{className:"detail-panel-meta-key",children:"Created"}),Ut.jsx("span",{className:"detail-panel-meta-value",children:_L(e.created)})]}),Ut.jsxs("div",{className:"detail-panel-meta-row",children:[Ut.jsx("span",{className:"detail-panel-meta-icon",children:Ut.jsx(xE,{size:13})}),Ut.jsx("span",{className:"detail-panel-meta-key",children:"Modified"}),Ut.jsx("span",{className:"detail-panel-meta-value",children:_L(e.modified)})]})]})]}),P&&(u||S)&&Ut.jsxs("div",{className:"detail-panel-section detail-panel-png-metadata",children:[Ut.jsxs("button",{className:"detail-panel-section-toggle",onClick:()=>w(e=>!e),type:"button",children:[_?Ut.jsx(uE,{size:14}):Ut.jsx(pE,{size:14}),Ut.jsx("span",{className:"detail-panel-label",children:"PNG Metadata"})]}),_&&Ut.jsxs("div",{className:"detail-panel-meta-grid",children:[S&&!u&&Ut.jsx("div",{className:"detail-panel-meta-loading",children:"Loading metadata"}),u&&Object.entries(u).map(([e,t])=>F(e,t))]})]})]})]})}function SL({label:e,content:t}){const[n,a]=Tt.useState(!1);return Ut.jsxs("div",{className:"detail-panel-png-subsection",children:[Ut.jsxs("button",{className:"detail-panel-section-toggle",onClick:()=>a(e=>!e),type:"button",children:[n?Ut.jsx(uE,{size:12}):Ut.jsx(pE,{size:12}),Ut.jsx("span",{className:"detail-panel-meta-key",children:e})]}),n&&Ut.jsx("pre",{className:"detail-panel-png-pre",children:t})]})}function ML(){const e=SR(e=>e.filterType),t=SR(e=>e.filterRating),n=SR(e=>e.filterTags),a=SR(e=>e.searchQuery),r=SR(e=>e.allTags),i=SR(e=>e.setFilterType),s=SR(e=>e.setFilterRating),o=SR(e=>e.setFilterTags),l=SR(e=>e.setSearchQuery),c="all"!==e,d=t>0,u=n.length>0,h=a.trim().length>0;if(!(c||d||u||h))return null;const p=new Map;for(const m of r)p.set(m.id,m);return Ut.jsxs("div",{className:"filter-bar",children:[c&&Ut.jsxs("span",{className:"filter-bar-chip",children:[Ut.jsx("span",{className:"filter-bar-chip-label",children:"image"===e?"Images only":"Videos only"}),Ut.jsx("button",{className:"filter-bar-chip-remove",onClick:()=>i("all"),title:"Remove type filter",children:Ut.jsx(Nk,{size:12})})]}),d&&Ut.jsxs("span",{className:"filter-bar-chip",children:[Ut.jsxs("span",{className:"filter-bar-chip-label",children:[""," ",t,""]}),Ut.jsx("button",{className:"filter-bar-chip-remove",onClick:()=>s(0),title:"Remove rating filter",children:Ut.jsx(Nk,{size:12})})]}),n.map(e=>{const t=p.get(e);return t?Ut.jsxs("span",{className:"filter-bar-chip filter-bar-chip--tag",style:{borderColor:t.color},children:[Ut.jsx("span",{className:"filter-bar-chip-dot",style:{background:t.color}}),Ut.jsx("span",{className:"filter-bar-chip-label",children:t.name}),Ut.jsx("button",{className:"filter-bar-chip-remove",onClick:()=>function(e){o(n.filter(t=>t!==e))}(e),title:`Remove tag "${t.name}"`,children:Ut.jsx(Nk,{size:12})})]},e):null}),h&&Ut.jsxs("span",{className:"filter-bar-chip",children:[Ut.jsxs("span",{className:"filter-bar-chip-label",children:["",a,""]}),Ut.jsx("button",{className:"filter-bar-chip-remove",onClick:()=>l(""),title:"Remove search filter",children:Ut.jsx(Nk,{size:12})})]}),Ut.jsx("button",{className:"filter-bar-clear-all",onClick:function(){i("all"),s(0),o([]),l("")},children:"Clear all"})]})}function CL(e,t){if(!t)return[e];const n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),a=new RegExp(`(${n})`,"gi");return e.split(a).map((e,t)=>a.test(e)?Ut.jsx("mark",{children:e},t):e)}function EL(e){const t=e.includes("\\")?"\\":"/",n=e.split(t);return n[n.length-1]||e}function kL({orchestratorUrl:e,projectPath:t,currentPath:n,onSelectResult:a,onClose:r}){const{searchQuery:i,setSearchQuery:s}=SR(),[o,l]=Tt.useState("all"),[c,d]=Tt.useState([]),[u,h]=Tt.useState(0),[p,m]=Tt.useState(!1),[f,g]=Tt.useState(!1),v=Tt.useRef(null),y=Tt.useRef(null);Tt.useEffect(()=>{var e;null==(e=y.current)||e.focus()},[]);const x=Tt.useCallback(async a=>{const r=a.trim();if(!r)return d([]),h(0),void g(!1);m(!0),g(!0);try{const a=await async function(e,t,n,a,r){return aI(`${e}/api/gallery/search`,{project_path:t,query:n,folder_path:a,max_results:r})}(e,t,r,n||void 0,100);if(a.success){let e=a.results;"filename"===o?e=e.filter(e=>"filename"===e.match_field):"prompt"===o&&(e=e.filter(e=>"filename"!==e.match_field)),d(e),h(e.length)}else d([]),h(0)}catch{d([]),h(0)}finally{m(!1)}},[e,t,n,o]),b=Tt.useCallback(e=>{const t=e.target.value;s(t),v.current&&clearTimeout(v.current),v.current=setTimeout(()=>{x(t)},300)},[s,x]);Tt.useEffect(()=>{i.trim()&&x(i)},[o]);const _=Tt.useCallback(()=>{var e;s(""),d([]),h(0),g(!1),null==(e=y.current)||e.focus()},[s]);return Ut.jsxs("div",{className:"search-panel",children:[Ut.jsxs("div",{className:"search-panel-header",children:[Ut.jsxs("span",{className:"search-panel-header-title",children:["Search",f&&!p&&Ut.jsxs("span",{className:"search-panel-header-count",children:[u," result",1!==u?"s":""]})]}),Ut.jsx("button",{className:"search-panel-close-btn",onClick:r,title:"Close search",children:Ut.jsx(Nk,{size:16})})]}),Ut.jsxs("div",{className:"search-panel-input-wrapper",children:[Ut.jsx(mk,{size:14,className:"search-panel-input-icon"}),Ut.jsx("input",{ref:y,className:"search-panel-input",type:"text",placeholder:"Search files...",value:i,onChange:b}),i&&Ut.jsx("button",{className:"search-panel-clear-btn",onClick:_,title:"Clear search",children:Ut.jsx(Nk,{size:14})})]}),Ut.jsx("div",{className:"search-panel-scope",children:["all","filename","prompt"].map(e=>Ut.jsx("button",{className:"search-panel-scope-btn"+(o===e?" search-panel-scope-btn--active":""),onClick:()=>l(e),children:"all"===e?"All":"filename"===e?"Filename":"Prompt text"},e))}),Ut.jsxs("div",{className:"search-panel-results",children:[p&&Ut.jsxs("div",{className:"search-panel-loading",children:[Ut.jsx("span",{className:"search-panel-spinner"}),"Searching..."]}),!p&&f&&0===c.length&&Ut.jsx("div",{className:"search-panel-empty",children:"No results found"}),!p&&c.map(e=>{return Ut.jsxs("button",{className:"search-panel-result-item",onClick:()=>a(e.file_path),title:e.file_path,children:[Ut.jsxs("div",{className:"search-panel-result-name",children:[(t=e.match_field,"filename"===t?Ut.jsx(kE,{size:14}):Ut.jsx(NE,{size:14})),Ut.jsx("span",{className:"search-panel-result-filename",children:EL(e.rel_path||e.file_path)})]}),e.match_context&&Ut.jsx("div",{className:"search-panel-result-context",children:CL(e.match_context,i)})]},e.file_path);var t})]})]})}function TL(e,t){const n=e.indexOf(t);if(-1===n)return e;let a=e.slice(n+t.length);return(a.startsWith("/")||a.startsWith("\\"))&&(a=a.slice(1)),a}function NL({orchestratorUrl:e,projectPath:t,totalFiles:n,allFilePaths:a,onMove:r,onTrash:i,onCompare:s,onRefresh:o}){const l=SR(e=>e.selectedFiles),c=SR(e=>e.selectAll),d=SR(e=>e.clearSelection),u=SR(e=>e.allTags),[h,p]=Tt.useState(!1),[m,f]=Tt.useState(!1),[g,v]=Tt.useState(!1),y=Tt.useRef(null),x=Tt.useRef(null);Tt.useEffect(()=>{function e(e){y.current&&!y.current.contains(e.target)&&p(!1),x.current&&!x.current.contains(e.target)&&f(!1)}return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const b=Array.from(l),_=Tt.useCallback(async n=>{if(!g){v(!0),p(!1);try{const a={};for(const e of b)a[TL(e,t)]=n;await uI(e,t,a),o()}catch(a){console.error("BatchBar: failed to set ratings",a)}finally{v(!1)}}},[g,b,e,t,o]),w=Tt.useCallback(async n=>{if(!g){v(!0),f(!1);try{await Promise.all(b.map(a=>pI(e,t,TL(a,t),[n],"add"))),o()}catch(a){console.error("BatchBar: failed to add tag",a)}finally{v(!1)}}},[g,b,e,t,o]),S=Tt.useCallback(async n=>{if(!g){v(!0),f(!1);try{await Promise.all(b.map(a=>pI(e,t,TL(a,t),[n],"remove"))),o()}catch(a){console.error("BatchBar: failed to remove tag",a)}finally{v(!1)}}},[g,b,e,t,o]);if(0===l.size)return null;return Ut.jsxs("div",{className:"batch-bar",children:[Ut.jsxs("div",{className:"batch-bar-info",children:[Ut.jsxs("span",{className:"batch-bar-count",children:[l.size," file",1!==l.size?"s":""," selected"]}),l.size<n&&Ut.jsxs("button",{className:"batch-bar-select-all",onClick:()=>c(a),title:"Select all files",children:[Ut.jsx(vk,{size:14}),"Select All"]}),Ut.jsxs("button",{className:"batch-bar-clear",onClick:d,title:"Clear selection",children:[Ut.jsx(yk,{size:14}),"Clear"]})]}),Ut.jsxs("div",{className:"batch-bar-actions",children:[Ut.jsxs("div",{className:"batch-bar-dropdown-wrapper",ref:y,children:[Ut.jsxs("button",{className:"batch-bar-btn",onClick:()=>{p(e=>!e),f(!1)},disabled:g,title:"Set rating on selected files",children:[Ut.jsx(bk,{size:14}),"Rate"]}),h&&Ut.jsx("div",{className:"batch-bar-dropdown",children:[0,1,2,3,4,5].map(e=>Ut.jsx("button",{className:"batch-bar-dropdown-item",onClick:()=>_(e),children:0===e?Ut.jsx("span",{className:"batch-bar-dropdown-label",children:"No rating"}):Ut.jsx("span",{className:"batch-bar-dropdown-stars",children:Array.from({length:e},(e,t)=>Ut.jsx(bk,{size:12,fill:"#f5c542",color:"#f5c542"},t))})},e))})]}),Ut.jsxs("div",{className:"batch-bar-dropdown-wrapper",ref:x,children:[Ut.jsxs("button",{className:"batch-bar-btn",onClick:()=>{f(e=>!e),p(!1)},disabled:g,title:"Add or remove tag on selected files",children:[Ut.jsx(_k,{size:14}),"Tag"]}),m&&Ut.jsx("div",{className:"batch-bar-dropdown batch-bar-dropdown--tags",children:0===u.length?Ut.jsx("div",{className:"batch-bar-dropdown-empty",children:"No tags defined"}):Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{className:"batch-bar-dropdown-section-label",children:"Add tag"}),u.map(e=>Ut.jsxs("button",{className:"batch-bar-dropdown-item",onClick:()=>w(e.id),children:[Ut.jsx("span",{className:"batch-bar-tag-dot",style:{background:e.color}}),e.name]},`add-${e.id}`)),Ut.jsx("div",{className:"batch-bar-dropdown-divider"}),Ut.jsx("div",{className:"batch-bar-dropdown-section-label",children:"Remove tag"}),u.map(e=>Ut.jsxs("button",{className:"batch-bar-dropdown-item batch-bar-dropdown-item--remove",onClick:()=>S(e.id),children:[Ut.jsx("span",{className:"batch-bar-tag-dot",style:{background:e.color}}),e.name]},`rm-${e.id}`))]})})]}),Ut.jsxs("button",{className:"batch-bar-btn",onClick:()=>r(b),disabled:g,title:"Move selected files",children:[Ut.jsx(RE,{size:14}),"Move"]}),Ut.jsxs("button",{className:"batch-bar-btn",onClick:()=>s(b),disabled:g||2!==l.size,title:2===l.size?"Compare selected files":"Select exactly 2 files to compare",children:[Ut.jsx(bE,{size:14}),"Compare"]}),Ut.jsxs("button",{className:"batch-bar-btn batch-bar-btn--danger",onClick:()=>i(b),disabled:g,title:"Trash selected files",children:[Ut.jsx(Ck,{size:14}),"Trash"]})]})]})}function PL({file:e,files:t,orchestratorUrl:n,onClose:a,onNavigate:r}){const[i,s]=Tt.useState(!1),o=t.findIndex(t=>t.path===e.path),l=t.length,c=`${n}/api/serve-image?path=${encodeURIComponent(e.path)}`,d=Tt.useCallback(()=>{if(l<=1)return;const e=o<=0?l-1:o-1;s(!1),r(t[e])},[o,l,t,r]),u=Tt.useCallback(()=>{if(l<=1)return;const e=o>=l-1?0:o+1;s(!1),r(t[e])},[o,l,t,r]);Tt.useEffect(()=>{function e(e){switch(e.key){case"Escape":a();break;case"ArrowLeft":d();break;case"ArrowRight":u()}}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[a,d,u]);const h=Tt.useCallback(e=>{e.target===e.currentTarget&&a()},[a]),p=Tt.useCallback(()=>{s(e=>!e)},[]),m=[];return e.width&&e.height&&m.push(`${e.width} x ${e.height}`),e.size&&m.push(function(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,t)).toFixed(0===t?0:1)} ${["B","KB","MB","GB"][t]}`}(e.size)),Gh.createPortal(Ut.jsxs("div",{className:"gallery-lightbox-backdrop",onClick:h,children:[Ut.jsxs("div",{className:"gallery-lightbox-header",children:[Ut.jsxs("div",{className:"gallery-lightbox-header-left",children:[Ut.jsx("span",{className:"gallery-lightbox-filename",children:e.name}),m.length>0&&Ut.jsx("span",{className:"gallery-lightbox-info",children:m.join("  |  ")})]}),Ut.jsx("button",{className:"gallery-lightbox-close",onClick:a,title:"Close (Esc)",children:Ut.jsx(Nk,{size:20})})]}),Ut.jsx("div",{className:"gallery-lightbox-media",onClick:h,children:"video"===e.type?Ut.jsx("video",{className:"gallery-lightbox-video",src:c,controls:!0,autoPlay:!0,loop:!0,onClick:e=>e.stopPropagation()}):Ut.jsx("img",{className:"gallery-lightbox-image"+(i?" gallery-lightbox-image--zoomed":""),src:c,alt:e.name,draggable:!1,style:{cursor:i?"zoom-out":"zoom-in"},onClick:e=>{e.stopPropagation(),p()}})}),"image"===e.type&&Ut.jsx("button",{className:"gallery-lightbox-zoom-btn",onClick:p,title:i?"Fit to screen":"Zoom to 100%",children:i?Ut.jsx(Ak,{size:18}):Ut.jsx(jk,{size:18})}),l>1&&Ut.jsx("button",{className:"gallery-lightbox-nav gallery-lightbox-nav--left",onClick:d,title:"Previous (Left Arrow)",children:Ut.jsx(hE,{size:32})}),l>1&&Ut.jsx("button",{className:"gallery-lightbox-nav gallery-lightbox-nav--right",onClick:u,title:"Next (Right Arrow)",children:Ut.jsx(pE,{size:32})}),l>1&&Ut.jsxs("div",{className:"gallery-lightbox-position",children:[o+1," / ",l]})]}),document.body)}function jL(e,t){return`${e}/api/serve-image?path=${encodeURIComponent(t.path)}`}function AL({urlA:e,urlB:t,scaleMode:n}){const a=Tt.useRef(null);Tt.useEffect(()=>{const n=a.current;if(!n)return;const r=n.getContext("2d");if(!r)return;const i=new Image,s=new Image;i.crossOrigin="anonymous",s.crossOrigin="anonymous";let o=0;function l(){if(o++,o<2)return;const e=Math.max(i.naturalWidth,s.naturalWidth),t=Math.max(i.naturalHeight,s.naturalHeight);n.width=e,n.height=t,r.drawImage(i,0,0,e,t);const a=r.getImageData(0,0,e,t);r.clearRect(0,0,e,t),r.drawImage(s,0,0,e,t);const l=r.getImageData(0,0,e,t),c=r.createImageData(e,t);for(let n=0;n<a.data.length;n+=4)c.data[n]=Math.abs(a.data[n]-l.data[n]),c.data[n+1]=Math.abs(a.data[n+1]-l.data[n+1]),c.data[n+2]=Math.abs(a.data[n+2]-l.data[n+2]),c.data[n+3]=255;r.putImageData(c,0,0)}i.onload=l,s.onload=l,i.src=e,s.src=t},[e,t]);const r="original"===n?{}:"fill"===n?{width:"100%",height:"100%",objectFit:"cover"}:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"};return Ut.jsx("div",{className:"compare-view-difference-container",style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",background:"#000",overflow:"original"===n?"auto":"hidden"},children:Ut.jsx("canvas",{ref:a,className:"compare-view-difference-canvas",style:r})})}function RL({files:e,orchestratorUrl:t,onClose:n}){const[a,r]=Tt.useState("slider"),[i,s]=Tt.useState("fit"),[o,l]=Tt.useState(50),[c,d]=Tt.useState({w:0,h:0}),u=Tt.useRef(null),h=Tt.useRef(!1),p=e[0],m=e[1],f=jL(t,p),g=jL(t,m),v=function(e,t){const[n,a]=Tt.useState(null);return Tt.useEffect(()=>{let n=!1;const r=new Image,i=new Image;r.crossOrigin="anonymous",i.crossOrigin="anonymous";let s=0;function o(){s++,s<2||n||a({wA:r.naturalWidth,hA:r.naturalHeight,wB:i.naturalWidth,hB:i.naturalHeight})}return r.onload=o,i.onload=o,r.src=e,i.src=t,()=>{n=!0}},[e,t]),n}(f,g);Tt.useEffect(()=>{const e=u.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:n}=t.contentRect;d({w:e,h:n})}});return t.observe(e),()=>t.disconnect()},[]),Tt.useEffect(()=>{function e(e){"Escape"===e.key&&n()}return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[n]);const y=Tt.useCallback(e=>{const t=u.current;if(!t)return 50;const n=t.getBoundingClientRect(),a=(e-n.left)/n.width*100;return Math.max(0,Math.min(100,a))},[]),x=Tt.useCallback(e=>{e.preventDefault(),h.current=!0,document.body.style.cursor="col-resize",document.body.style.userSelect="none"},[]),b=Tt.useCallback(e=>{h.current&&l(y(e.clientX))},[y]),_=Tt.useCallback(()=>{h.current&&(h.current=!1,document.body.style.cursor="",document.body.style.userSelect="")},[]);Tt.useEffect(()=>(window.addEventListener("mousemove",b),window.addEventListener("mouseup",_),()=>{window.removeEventListener("mousemove",b),window.removeEventListener("mouseup",_)}),[b,_]);const w="fill"===i?{width:"100%",height:"100%",objectFit:"cover",display:"block"}:"original"===i?{display:"block"}:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain",display:"block"},S="original"===i?"auto":"hidden",M="fill"===i?"cover":"contain",C="original"===i&&v?{width:Math.max(v.wA,v.wB),height:Math.max(v.hA,v.hB)}:null,E=Ut.jsx("div",{className:"compare-view-backdrop",onClick:n,children:Ut.jsxs("div",{className:"compare-view",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"compare-view-header",children:[Ut.jsx("span",{className:"compare-view-label compare-view-label--left",title:p.name,children:p.name}),Ut.jsxs("div",{className:"compare-view-mode-toggle",children:[Ut.jsxs("button",{className:"compare-view-mode-btn"+("side-by-side"===a?" compare-view-mode-btn--active":""),onClick:()=>r("side-by-side"),title:"Side by Side",children:[Ut.jsx(bE,{size:14}),"Side by Side"]}),Ut.jsxs("button",{className:"compare-view-mode-btn"+("slider"===a?" compare-view-mode-btn--active":""),onClick:()=>r("slider"),title:"Slider",children:[Ut.jsx(VE,{size:14}),"Slider"]}),Ut.jsxs("button",{className:"compare-view-mode-btn"+("difference"===a?" compare-view-mode-btn--active":""),onClick:()=>r("difference"),title:"Difference",children:[Ut.jsx(lE,{size:14}),"Difference"]})]}),Ut.jsxs("div",{className:"compare-view-scale-toggle",children:[Ut.jsxs("button",{className:"compare-view-scale-btn"+("fit"===i?" compare-view-scale-btn--active":""),onClick:()=>s("fit"),title:"Fit  scale to fit viewport",children:[Ut.jsx(ZE,{size:13}),"Fit"]}),Ut.jsxs("button",{className:"compare-view-scale-btn"+("fill"===i?" compare-view-scale-btn--active":""),onClick:()=>s("fill"),title:"Fill  fill viewport (may crop)",children:[Ut.jsx(KE,{size:13}),"Fill"]}),Ut.jsxs("button",{className:"compare-view-scale-btn"+("original"===i?" compare-view-scale-btn--active":""),onClick:()=>s("original"),title:"Original  native resolution (may scroll)",children:[Ut.jsx(pk,{size:13}),"1:1"]})]}),Ut.jsx("span",{className:"compare-view-label compare-view-label--right",title:m.name,children:m.name}),Ut.jsx("button",{className:"compare-view-close-btn",onClick:n,title:"Close (Esc)",children:Ut.jsx(Nk,{size:18})})]}),Ut.jsx("div",{className:"compare-view-content",ref:u,children:"side-by-side"===a?Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("div",{className:"compare-view-side",style:{width:`${o}%`,overflow:S},children:[Ut.jsx("img",{src:f,alt:p.name,style:w,draggable:!1}),Ut.jsx("span",{className:"compare-view-side-label",children:p.name})]}),Ut.jsx("div",{className:"compare-view-divider",style:{left:`${o}%`},onMouseDown:x,children:Ut.jsx("div",{className:"compare-view-divider-handle"})}),Ut.jsxs("div",{className:"compare-view-side",style:{width:100-o+"%",overflow:S},children:[Ut.jsx("img",{src:g,alt:m.name,style:w,draggable:!1}),Ut.jsx("span",{className:"compare-view-side-label",children:m.name})]})]}):"slider"===a?Ut.jsxs("div",{className:"compare-view-slider-container"+("original"===i?" compare-view-slider-container--original":""),style:C?{width:C.width,height:C.height}:void 0,children:[Ut.jsx("img",{src:g,alt:m.name,className:"compare-view-slider-img compare-view-slider-img--normalized",style:{objectFit:"original"===i?void 0:M},draggable:!1}),Ut.jsx("div",{className:"compare-view-slider-clip",style:{width:`${o}%`},children:Ut.jsx("img",{src:f,alt:p.name,className:"compare-view-slider-img compare-view-slider-img--normalized",style:{objectFit:"original"===i?void 0:M,width:c.w>0?c.w:"100%",height:c.h>0?c.h:"100%"},draggable:!1})}),Ut.jsx("div",{className:"compare-view-slider-line",style:{left:`${o}%`},onMouseDown:x,children:Ut.jsx("div",{className:"compare-view-slider-handle"})})]}):Ut.jsx(AL,{urlA:f,urlB:g,scaleMode:i})})]})});return Gh.createPortal(E,document.body)}const IL=new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric"});function LL(e){return function(e){const t=new Date(1e3*e),n=new Date;return t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate()}(e)?"Today":function(e){const t=new Date(1e3*e),n=new Date;return n.setDate(n.getDate()-1),t.getFullYear()===n.getFullYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate()}(e)?"Yesterday":IL.format(new Date(1e3*e))}function DL(e){const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function UL({files:e,orchestratorUrl:t,onSelectFile:n}){const[a,r]=Tt.useState(()=>new Set),i=Tt.useMemo(()=>{const t=new Map;for(const a of e){const e=DL(a.created),n=t.get(e);n?n.push(a):t.set(e,[a])}const n=[];for(const[e,a]of t)n.push({key:e,label:LL(a[0].created),files:a});return n.sort((e,t)=>t.key.localeCompare(e.key)),n},[e]),s=i.length;return 0===e.length?Ut.jsx("div",{className:"timeline-view",children:Ut.jsx("div",{className:"timeline-view-empty",children:"No files to display"})}):Ut.jsxs("div",{className:"timeline-view",children:[Ut.jsxs("div",{className:"timeline-view-summary",children:[Ut.jsx(xE,{size:14}),Ut.jsxs("span",{children:[e.length," file",1!==e.length?"s":""," over"," ",s," day",1!==s?"s":""]})]}),Ut.jsx("div",{className:"timeline-view-entries",children:i.map((e,s)=>Ut.jsxs("div",{className:"timeline-view-entry",children:[Ut.jsxs("div",{className:"timeline-view-date",children:[Ut.jsx("div",{className:"timeline-view-dot"}),s<i.length-1&&Ut.jsx("div",{className:"timeline-view-line"}),Ut.jsxs("div",{className:"timeline-view-date-info",children:[Ut.jsxs("span",{className:"timeline-view-date-label",children:[Ut.jsx(cE,{size:13}),e.label]}),Ut.jsxs("span",{className:"timeline-view-date-count",children:[e.files.length," file",1!==e.files.length?"s":""]})]})]}),Ut.jsx("div",{className:"timeline-view-thumbnails",children:e.files.map(e=>{const i=`${t}/api/serve-image?path=${encodeURIComponent(e.path)}`,s=a.has(e.path);return Ut.jsx("button",{className:"timeline-view-thumb",title:e.name,onClick:()=>n(e),children:s?Ut.jsx("div",{className:"timeline-view-thumb-placeholder",children:"?"}):Ut.jsx("img",{className:"timeline-view-thumb-img",src:i,alt:e.name,loading:"lazy",onError:()=>{return t=e.path,void r(e=>{const n=new Set(e);return n.add(t),n});var t}})},e.path)})})]},e.key))})]})}function OL(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:e<1073741824?`${(e/1048576).toFixed(1)} MB`:`${(e/1073741824).toFixed(2)} GB`}function FL(e){const t=new Date(1e3*e);return t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})+" "+t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0})}function zL({orchestratorUrl:e,projectPath:t,currentPath:n,onClose:a,onTrash:r}){const[i,s]=Tt.useState([]),[o,l]=Tt.useState(0),[c,d]=Tt.useState(!1),[u,h]=Tt.useState(!1),[p,m]=Tt.useState(null),[f,g]=Tt.useState(new Set),[v,y]=Tt.useState(new Set),x=Tt.useCallback(async()=>{d(!0),m(null),g(new Set),y(new Set);try{const a=await async function(e,t,n){return aI(`${e}/api/gallery/find-duplicates`,{folder_path:t,project_path:n})}(e,n,t);a.success?(s(a.groups),l(a.wasted_space),y(new Set(a.groups.map(e=>e.hash)))):m(a.message||"Scan failed")}catch(a){m(a instanceof Error?a.message:"Failed to scan for duplicates")}finally{d(!1),h(!0)}},[e,n,t]);Tt.useEffect(()=>{x()},[x]),Tt.useEffect(()=>{const e=e=>{"Escape"===e.key&&a()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[a]);const b=Tt.useCallback(e=>{g(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},[]),_=Tt.useCallback(e=>{y(t=>{const n=new Set(t);return n.has(e)?n.delete(e):n.add(e),n})},[]),w=Tt.useCallback(e=>{const t=[...e.files].sort((e,t)=>t.modified-e.modified),n=t.slice(1).map(e=>e.path);g(t=>{const a=new Set(t);return e.files.forEach(e=>a.delete(e.path)),n.forEach(e=>a.add(e)),a})},[]),S=Tt.useCallback(e=>{const t=[...e.files].sort((e,t)=>e.modified-t.modified),n=t.slice(1).map(e=>e.path);g(t=>{const a=new Set(t);return e.files.forEach(e=>a.delete(e.path)),n.forEach(e=>a.add(e)),a})},[]),M=Tt.useCallback(()=>{const e=new Set;for(const t of i){const n=[...t.files].sort((e,t)=>t.modified-e.modified);n.slice(1).forEach(t=>e.add(t.path))}g(e)},[i]),C=Tt.useCallback(()=>{0!==f.size&&r(Array.from(f))},[f,r]),E=i.reduce((e,t)=>e+t.files.length,0),k=Ut.jsx("div",{className:"dup-finder-backdrop",onMouseDown:e=>{e.target===e.currentTarget&&a()},children:Ut.jsxs("div",{className:"dup-finder-modal",onClick:e=>e.stopPropagation(),children:[Ut.jsxs("div",{className:"dup-finder-header",children:[Ut.jsxs("div",{className:"dup-finder-header-title",children:[Ut.jsx(mk,{size:16}),Ut.jsx("span",{children:"Duplicate Finder"})]}),Ut.jsxs("div",{className:"dup-finder-header-actions",children:[Ut.jsxs("button",{className:"dup-finder-scan-btn",onClick:x,disabled:c,children:[Ut.jsx(mk,{size:14}),"Re-scan"]}),Ut.jsx("button",{className:"dup-finder-close-btn",onClick:a,children:Ut.jsx(Nk,{size:16})})]})]}),c&&Ut.jsxs("div",{className:"dup-finder-loading",children:[Ut.jsx("div",{className:"dup-finder-spinner"}),Ut.jsx("span",{children:"Scanning for duplicates..."})]}),p&&!c&&Ut.jsx("div",{className:"dup-finder-error",children:p}),!c&&!p&&u&&0===i.length&&Ut.jsxs("div",{className:"dup-finder-empty",children:[Ut.jsx(gE,{size:40}),Ut.jsx("span",{children:"No duplicates found"})]}),!c&&!p&&i.length>0&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{className:"dup-finder-summary",children:Ut.jsxs("span",{children:["Found ",Ut.jsx("strong",{children:i.length})," duplicate group",1!==i.length?"s":""," ","(",E," files, ",OL(o)," wasted)"]})}),Ut.jsxs("div",{className:"dup-finder-actions",children:[Ut.jsx("button",{className:"dup-finder-auto-btn",onClick:M,children:"Auto-select: Keep Newest"}),Ut.jsxs("div",{className:"dup-finder-actions-right",children:[Ut.jsxs("span",{className:"dup-finder-selected-count",children:[f.size," selected"]}),Ut.jsxs("button",{className:"dup-finder-trash-btn",disabled:0===f.size,onClick:C,children:[Ut.jsx(Ck,{size:14}),"Trash Selected"]})]})]}),Ut.jsx("div",{className:"dup-finder-groups",children:i.map(t=>{const n=v.has(t.hash);return Ut.jsxs("div",{className:"dup-finder-group",children:[Ut.jsxs("button",{className:"dup-finder-group-header",onClick:()=>_(t.hash),children:[Ut.jsx("span",{className:"dup-finder-group-chevron",children:n?Ut.jsx(uE,{size:14}):Ut.jsx(pE,{size:14})}),Ut.jsxs("span",{className:"dup-finder-group-info",children:[Ut.jsxs("strong",{children:[t.files.length," copies"]}),Ut.jsxs("span",{className:"dup-finder-group-size",children:[OL(t.size)," each"]})]}),Ut.jsxs("span",{className:"dup-finder-group-actions",onClick:e=>e.stopPropagation(),children:[Ut.jsx("button",{className:"dup-finder-keep-btn",onClick:()=>w(t),title:"Select all except the newest file",children:"Keep Newest"}),Ut.jsx("button",{className:"dup-finder-keep-btn",onClick:()=>S(t),title:"Select all except the oldest file",children:"Keep Oldest"})]})]}),n&&Ut.jsx("div",{className:"dup-finder-file-list",children:t.files.map(t=>{const n=f.has(t.path);return Ut.jsxs("label",{className:"dup-finder-file"+(n?" dup-finder-file--selected":""),children:[Ut.jsx("input",{type:"checkbox",className:"dup-finder-file-check",checked:n,onChange:()=>b(t.path)}),Ut.jsx("img",{className:"dup-finder-file-thumb",src:(a=t.path,`${e}/api/serve-image?path=${encodeURIComponent(a)}`),alt:t.name,loading:"lazy"}),Ut.jsxs("div",{className:"dup-finder-file-info",children:[Ut.jsx("span",{className:"dup-finder-file-name",children:t.name}),Ut.jsx("span",{className:"dup-finder-file-path",children:t.path}),Ut.jsx("span",{className:"dup-finder-file-date",children:FL(t.modified)})]})]},t.path);var a})})]},t.hash)})})]})]})});return Gh.createPortal(k,document.body)}const BL={overlay:{position:"fixed",inset:0,zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.6)"},dialog:{background:"var(--color-bg-secondary, #1e1e2e)",border:"1px solid var(--color-border, #333)",borderRadius:8,width:400,boxShadow:"0 12px 40px rgba(0,0,0,0.5)",color:"var(--color-text, #e0e0e0)",fontSize:13},header:{padding:"16px 20px 12px",borderBottom:"1px solid var(--color-border, #333)",fontWeight:600,fontSize:15},body:{padding:"16px 20px",display:"flex",flexDirection:"column",gap:10},targetInfo:{fontSize:12,color:"var(--color-text-muted, #888)",marginBottom:4},optionBtn:{display:"flex",alignItems:"center",gap:10,padding:"10px 14px",borderRadius:6,border:"1px solid var(--color-border, #333)",background:"var(--color-bg-primary, #141420)",color:"var(--color-text, #e0e0e0)",cursor:"pointer",fontSize:13,fontWeight:500,transition:"all 0.15s",width:"100%",textAlign:"left"},optionBtnHover:{borderColor:"var(--color-accent, #5b9aff)",background:"rgba(91, 154, 255, 0.08)"},newFolderRow:{display:"flex",gap:8,alignItems:"center"},input:{flex:1,padding:"7px 10px",fontSize:13,background:"var(--color-bg-primary, #141420)",color:"var(--color-text, #e0e0e0)",border:"1px solid var(--color-accent, #5b9aff)",borderRadius:4,outline:"none",boxSizing:"border-box"},createBtn:{padding:"7px 14px",borderRadius:4,border:"1px solid var(--color-accent, #5b9aff)",background:"var(--color-accent, #3b82f6)",color:"#fff",cursor:"pointer",fontSize:13,fontWeight:500,whiteSpace:"nowrap"},footer:{display:"flex",justifyContent:"flex-end",padding:"12px 20px",borderTop:"1px solid var(--color-border, #333)"},cancelBtn:{padding:"6px 16px",borderRadius:4,border:"1px solid var(--color-border, #444)",background:"var(--color-bg-secondary, #1e1e2e)",color:"var(--color-text, #e0e0e0)",cursor:"pointer",fontSize:13,fontWeight:500},statusMsg:{fontSize:12,padding:"8px 12px",borderRadius:4,background:"var(--color-bg-primary, #141420)",border:"1px solid var(--color-border, #333)"},errorMsg:{color:"#f87171",borderColor:"#ef4444"},successMsg:{color:"#4ade80",borderColor:"#22c55e"}};function HL({filePaths:e,targetFolder:t,orchestratorUrl:n,projectPath:a,onMoved:r,onClose:i}){const[s,o]=Tt.useState("choose"),[l,c]=Tt.useState("New Folder"),[d,u]=Tt.useState(null),[h,p]=Tt.useState(!1),[m,f]=Tt.useState(null),g=Tt.useRef(null),v=t.split(/[/\\]/).filter(Boolean).pop()||"folder",y=e.length;Tt.useEffect(()=>{"newFolder"===s&&g.current&&(g.current.focus(),g.current.select())},[s]),Tt.useEffect(()=>{if(h){const e=setTimeout(()=>{r()},800);return()=>clearTimeout(e)}},[h,r]),Tt.useEffect(()=>{function e(e){"Escape"===e.key&&i()}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[i]);const x=Tt.useCallback(async()=>{var r,i;o("moving"),u(null);try{const s=await sI(n,e,t,a,"rename");(null==(r=s.errors)?void 0:r.length)>0?(u(`Moved ${(null==(i=s.moved)?void 0:i.length)||0} files, ${s.errors.length} errors`),o("choose")):p(!0)}catch(s){u(s instanceof Error?s.message:"Move failed"),o("choose")}},[n,e,t,a]),b=Tt.useCallback(async()=>{var r,i;const s=l.trim();if(s){o("moving"),u(null);try{const l=await oI(n,t,s);if(!l.success)return u(l.message||"Failed to create folder"),void o("newFolder");const c=l.created_path,d=await sI(n,e,c,a,"rename");(null==(r=d.errors)?void 0:r.length)>0?(u(`Moved ${(null==(i=d.moved)?void 0:i.length)||0} files, ${d.errors.length} errors`),o("newFolder")):p(!0)}catch(c){u(c instanceof Error?c.message:"Operation failed"),o("newFolder")}}},[n,e,t,a,l]),_=Tt.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),b()):"Escape"===e.key&&o("choose")},[b]),w=Tt.useCallback(e=>{e.target===e.currentTarget&&i()},[i]),S=Ut.jsx("div",{style:BL.overlay,onClick:w,children:Ut.jsxs("div",{style:BL.dialog,role:"dialog","aria-modal":"true",children:[Ut.jsxs("div",{style:BL.header,children:["Move ",y," file",1!==y?"s":""]}),Ut.jsxs("div",{style:BL.body,children:[Ut.jsxs("div",{style:BL.targetInfo,children:["Dropped onto: ",Ut.jsx("strong",{children:v})]}),d&&Ut.jsx("div",{style:{...BL.statusMsg,...BL.errorMsg},children:d}),h&&Ut.jsx("div",{style:{...BL.statusMsg,...BL.successMsg},children:"Files moved successfully"}),"choose"===s&&!h&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsxs("button",{type:"button",style:{...BL.optionBtn,..."move"===m?BL.optionBtnHover:{}},onMouseEnter:()=>f("move"),onMouseLeave:()=>f(null),onClick:x,children:[Ut.jsx(LE,{size:16}),Ut.jsxs("span",{style:{flex:1},children:['Move to "',v,'"']}),Ut.jsx(sE,{size:14,style:{opacity:.5}})]}),Ut.jsxs("button",{type:"button",style:{...BL.optionBtn,..."new"===m?BL.optionBtnHover:{}},onMouseEnter:()=>f("new"),onMouseLeave:()=>f(null),onClick:()=>o("newFolder"),children:[Ut.jsx(IE,{size:16}),Ut.jsx("span",{style:{flex:1},children:"Create new subfolder and move"}),Ut.jsx(sE,{size:14,style:{opacity:.5}})]})]}),"newFolder"===s&&!h&&Ut.jsxs("div",{style:BL.newFolderRow,children:[Ut.jsx("input",{ref:g,style:BL.input,value:l,onChange:e=>c(e.target.value),onKeyDown:_,placeholder:"Folder name"}),Ut.jsx("button",{type:"button",style:{...BL.createBtn,...l.trim()?{}:{opacity:.4,cursor:"not-allowed"}},disabled:!l.trim(),onClick:b,children:"Create & Move"})]}),"moving"===s&&!h&&Ut.jsx("div",{style:{...BL.statusMsg,color:"var(--color-text-muted, #888)"},children:"Moving files..."})]}),Ut.jsx("div",{style:BL.footer,children:Ut.jsx("button",{type:"button",style:BL.cancelBtn,onClick:i,children:h?"Close":"Cancel"})})]})});return Wh.createPortal(S,document.body)}const $L={overlay:{position:"fixed",inset:0,zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.6)"},dialog:{background:"var(--color-bg-secondary, #1e1e2e)",border:"1px solid var(--color-border, #333)",borderRadius:8,width:420,boxShadow:"0 12px 40px rgba(0,0,0,0.5)",color:"var(--color-text, #e0e0e0)",fontSize:13},header:{padding:"16px 20px 12px",borderBottom:"1px solid var(--color-border, #333)",fontWeight:600,fontSize:15,display:"flex",alignItems:"center",gap:8},body:{padding:"16px 20px",display:"flex",flexDirection:"column",gap:12},label:{fontSize:12,color:"var(--color-text-muted, #888)"},input:{width:"100%",padding:"8px 10px",fontSize:13,background:"var(--color-bg-primary, #141420)",color:"var(--color-text, #e0e0e0)",border:"1px solid var(--color-border, #444)",borderRadius:4,outline:"none",boxSizing:"border-box"},footer:{display:"flex",justifyContent:"flex-end",gap:8,padding:"12px 20px",borderTop:"1px solid var(--color-border, #333)"},btn:{padding:"6px 16px",borderRadius:4,border:"1px solid var(--color-border, #444)",background:"var(--color-bg-secondary, #1e1e2e)",color:"var(--color-text, #e0e0e0)",cursor:"pointer",fontSize:13,fontWeight:500},btnPrimary:{background:"var(--color-accent, #3b82f6)",color:"#fff",border:"1px solid var(--color-accent, #3b82f6)"},btnDisabled:{opacity:.4,cursor:"not-allowed"},statusMsg:{fontSize:12,padding:"8px 12px",borderRadius:4,background:"var(--color-bg-primary, #141420)",border:"1px solid var(--color-border, #333)"},errorMsg:{color:"#f87171",borderColor:"#ef4444"},successMsg:{color:"#4ade80",borderColor:"#22c55e"}};function VL({files:e,currentFolder:t,orchestratorUrl:n,projectPath:a,onMoved:r,onClose:i}){const[s,o]=Tt.useState("New Folder"),[l,c]=Tt.useState(!1),[d,u]=Tt.useState(null),[h,p]=Tt.useState(!1),m=Tt.useRef(null);Tt.useEffect(()=>{m.current&&(m.current.focus(),m.current.select())},[]),Tt.useEffect(()=>{function e(e){"Escape"===e.key&&i()}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[i]),Tt.useEffect(()=>{if(h){const e=setTimeout(()=>{r()},800);return()=>clearTimeout(e)}},[h,r]);const f=Tt.useCallback(async()=>{var r,i;const o=s.trim();if(o&&!l){c(!0),u(null);try{const s=await oI(n,t,o);if(!s.success)return u(s.message||"Failed to create folder"),void c(!1);const l=e.map(e=>e.path),d=await sI(n,l,s.created_path,a,"rename");(null==(r=d.errors)?void 0:r.length)>0?(u(`Moved ${(null==(i=d.moved)?void 0:i.length)||0} files, ${d.errors.length} failed`),c(!1)):p(!0)}catch(d){u(d instanceof Error?d.message:"Operation failed"),c(!1)}}},[s,l,n,t,e,a]),g=Tt.useCallback(e=>{"Enter"===e.key&&(e.preventDefault(),f())},[f]),v=Tt.useCallback(e=>{e.target===e.currentTarget&&i()},[i]),y=s.trim().length>0&&!l&&!h,x=Ut.jsx("div",{style:$L.overlay,onClick:v,children:Ut.jsxs("div",{style:$L.dialog,role:"dialog","aria-modal":"true",children:[Ut.jsxs("div",{style:$L.header,children:[Ut.jsx(IE,{size:18}),"Move ",e.length," file",1!==e.length?"s":""," to New Folder"]}),Ut.jsxs("div",{style:$L.body,children:[d&&Ut.jsx("div",{style:{...$L.statusMsg,...$L.errorMsg},children:d}),h&&Ut.jsx("div",{style:{...$L.statusMsg,...$L.successMsg},children:"Files moved successfully"}),!h&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{style:$L.label,children:"Folder name"}),Ut.jsx("input",{ref:m,style:$L.input,value:s,onChange:e=>o(e.target.value),onKeyDown:g,placeholder:"Enter folder name",disabled:l})]}),l&&!h&&Ut.jsx("div",{style:{...$L.statusMsg,color:"var(--color-text-muted, #888)"},children:"Creating folder and moving files..."})]}),Ut.jsxs("div",{style:$L.footer,children:[Ut.jsx("button",{type:"button",style:$L.btn,onClick:i,children:h?"Close":"Cancel"}),!h&&Ut.jsx("button",{type:"button",style:{...$L.btn,...$L.btnPrimary,...y?{}:$L.btnDisabled},disabled:!y,onClick:f,children:l?"Moving...":"Create & Move"})]})]})});return Wh.createPortal(x,document.body)}function WL(e,t){if(!e||!t)return[];const n=(e.startsWith(t)?e.slice(t.length).replace(/^[/\\]/,""):"").split(/[/\\]/).filter(Boolean),a=[{name:"Root",path:t}];let r=t;for(const i of n)r=r+"/"+i,a.push({name:i,path:r});return a}function GL({orchestratorUrl:e,projectPath:t,isActive:n=!0}){const{folderTree:a,currentPath:r,isLoading:i,isLoadingFiles:s,error:o,showDetailPanel:l,viewMode:c,showTrashBin:d,setShowTrashBin:u,showSearchPanel:h,setShowSearchPanel:p,selectedFiles:m,currentFiles:f,detailFile:g,allTags:v,ratings:y,setFolderTree:x,setCurrentFiles:b,setCurrentPath:_,setBreadcrumbs:w,setAllTags:S,setRatings:M,setDetailFile:C,setShowDetailPanel:E,updateRating:k,setIsLoading:T,setIsLoadingFiles:N,setError:P,sortField:j,sortDirection:A,thumbnailSize:R,filterType:I,filterRating:L,filterTags:D,setViewMode:U,setSortField:O,setSortDirection:F,setThumbnailSize:z,setFilterType:B,setFilterRating:H,setFilterTags:$,resetGallery:V,lightboxFile:W,setLightboxFile:G,compareFiles:X,setCompareFiles:q,showDuplicateFinder:K,setShowDuplicateFinder:Y,showTimeline:J}=SR(),Z=Tt.useRef(t);Z.current=t;const[Q,ee]=Tt.useState(null),[te,ne]=Tt.useState(null),[ae,re]=Tt.useState(null),[ie,se]=Tt.useState(null),[oe,le]=Tt.useState(null),[ce,de]=Tt.useState(null),[ue,he]=Tt.useState(250),pe=Tt.useRef(!1),me=Tt.useRef(0),fe=Tt.useCallback(async n=>{if(!e||!t)return;const a=++me.current;N(!0);try{const r=await async function(e,t,n){return aI(`${e}/api/gallery/scan-folder`,{folder_path:t,project_path:n})}(e,n,t);if(a!==me.current)return;r.success?b(r.files):b([])}catch(r){if(a!==me.current)return;console.warn("Failed to load folder files:",r),b([])}finally{a===me.current&&N(!1)}},[e,t,b,N]),ge=Tt.useCallback(async()=>{if(t&&e){T(!0),P(null);try{const[n,a,r,i]=await Promise.all([iI(e,t),dI(e,t).catch(()=>({success:!1,ratings:{}})),hI(e,t).catch(()=>({success:!1,tags:[]})),mI(e,t).catch(()=>null)]);if(Z.current!==t)return;n.success&&x(n.folders),a.success&&M(a.ratings),r.success&&S(r.tags);let s="";if((null==i?void 0:i.success)&&i.view){const e=i.view;if(e.view_mode&&U(e.view_mode),e.sort_field&&O(e.sort_field),e.sort_direction&&F(e.sort_direction),e.thumbnail_size&&z(e.thumbnail_size),e.current_path&&(s=e.current_path,_(e.current_path),w(WL(e.current_path,t))),e.filters_json)try{const t=JSON.parse(e.filters_json);t.filterType&&B(t.filterType),void 0!==t.filterRating&&H(t.filterRating),t.filterTags&&$(t.filterTags)}catch{}}s||(_(t),w(WL(t,t)));const o=s||t;await fe(o)}catch(n){Z.current===t&&P(n instanceof Error?n.message:"Failed to load gallery data")}finally{Z.current===t&&T(!1)}}},[e,t,fe,x,b,M,S,T,P,_,w,U,O,F,z,B,H,$]),ve=Tt.useRef("");Tt.useEffect(()=>{n&&t&&ve.current!==t&&(V(),ve.current=t,T(!0),ge())},[t,n]);const ye=Tt.useRef(null);Tt.useEffect(()=>{if(n&&t&&e)return ye.current&&clearTimeout(ye.current),ye.current=setTimeout(()=>{(async function(e,t){return aI(`${e}/api/gallery/views`,t)})(e,{project_path:t,name:"default",view_mode:c,sort_field:j,sort_direction:A,thumbnail_size:R,filters_json:JSON.stringify({filterType:I,filterRating:L,filterTags:D}),current_path:r||"",folder_tree_state:"{}"}).catch(()=>{})},1500),()=>{ye.current&&clearTimeout(ye.current)}},[e,t,c,j,A,R,I,L,D,r]);const xe=Tt.useCallback(e=>{_(e),w(WL(e,t)),fe(e)},[t,_,w,fe]),be=Tt.useCallback(async()=>{if(!t||!e)return;const n=SR.getState().currentPath||t;try{const a=await iI(e,t);a.success&&x(a.folders),await fe(n)}catch(a){console.warn("Refresh failed:",a)}},[e,t,fe,x]),_e=Tt.useCallback((e,t)=>{const n=e[0],a=m.has(n)?Array.from(m):e;le({filePaths:a,targetFolder:t})},[m]),we=Tt.useCallback(()=>{le(null),be()},[be]),Se=Tt.useCallback(()=>{le(null)},[]),Me=Tt.useCallback(async(n,a)=>{try{if((await oI(e,n,a)).success){const{expandedFolders:a}=SR.getState();a.has(n)||SR.getState().toggleFolder(n);const r=await iI(e,t);r.success&&x(r.folders)}}catch(r){console.error("Failed to create folder:",r)}},[e,t,x]),Ce=Tt.useCallback((e,t)=>{e.preventDefault(),ee({x:e.clientX,y:e.clientY,file:t})},[]),Ee=Tt.useCallback(e=>m.has(e.path)&&m.size>1?f.filter(e=>m.has(e.path)):[e],[m,f]),ke=Tt.useCallback(async n=>{try{await cI(e,n.map(e=>e.path),t),be()}catch{}},[e,t,be]),Te=Tt.useCallback(()=>{P(null)},[P]),Ne=Tt.useCallback(()=>{E(!1),C(null)},[E,C]),Pe=Tt.useCallback(async(n,a)=>{k(n,a);try{await uI(e,t,{[n]:a})}catch{}},[e,t,k]),je=Tt.useCallback(async(n,a,r)=>{try{await pI(e,t,n,a,r),be()}catch{}},[e,t,be]),Ae=Tt.useCallback(async(n,a)=>{try{const r=await async function(e,t,n,a){return aI(`${e}/api/gallery/tags`,{project_path:t,name:n,color:a})}(e,t,n,a);if(r.success){const n=await hI(e,t);n.success&&S(n.tags)}}catch{}},[e,t,S]),Re=Tt.useCallback(async e=>{const n=e.includes("\\")?"\\":"/",a=e.split(n);a.pop();const r=a.join(n)||t;_(r),w(WL(r,t)),await fe(r);const{selectFile:i,clearSelection:s,currentFiles:o}=SR.getState();s(),i(e);const l=o.find(t=>t.path===e);l&&(C(l),E(!0)),p(!1)},[t,fe,_,w,C,E,p]),Ie=Tt.useCallback(e=>{const t=f.filter(t=>e.includes(t.path));t.length>0&&re(t)},[f]),Le=Tt.useCallback(e=>{const t=f.filter(t=>e.includes(t.path));t.length>0&&ke(t)},[f,ke]),De=Tt.useCallback(e=>{G(e)},[G]),Ue=Tt.useCallback(e=>{G(e)},[G]),Oe=Tt.useCallback(e=>{const t=f.filter(e=>m.has(e.path));t.length>=2&&q(t.slice(0,2))},[f,m,q]),Fe=Tt.useCallback(e=>{const t=f.filter(t=>e.includes(t.path));t.length>=2&&q(t.slice(0,2))},[f,q]),ze=Tt.useCallback(async n=>{try{await cI(e,n,t),Y(!1),be()}catch{}},[e,t,Y,be]);Tt.useEffect(()=>{if(l&&1===m.size){const e=Array.from(m)[0],t=f.find(t=>t.path===e);t&&t.path!==(null==g?void 0:g.path)&&C(t)}},[m,l,f,null==g?void 0:g.path,C]),Tt.useEffect(()=>{function e(e){const t=e.target;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName||t.isContentEditable)return;if(document.querySelector(".gallery-batch-rename-backdrop, .gallery-move-overlay, .gallery-rename-backdrop, .gallery-lightbox-backdrop, .compare-view-backdrop, .dup-finder-backdrop, .gallery-trash-backdrop")&&"Escape"!==e.key)return;const n=e.ctrlKey||e.metaKey;if("Escape"===e.key){const e=SR.getState();return void(e.lightboxFile?e.setLightboxFile(null):e.compareFiles?e.setCompareFiles(null):e.showDuplicateFinder?e.setShowDuplicateFinder(!1):e.showSearchPanel?e.setShowSearchPanel(!1):e.showDetailPanel?(e.setShowDetailPanel(!1),e.setDetailFile(null)):e.showTrashBin?e.setShowTrashBin(!1):e.selectedFiles.size>0&&e.clearSelection())}if("Delete"===e.key||"Backspace"===e.key){const t=SR.getState();if(t.selectedFiles.size>0){e.preventDefault();const n=f.filter(e=>t.selectedFiles.has(e.path));n.length>0&&ke(n)}return}if(n&&"a"===e.key){e.preventDefault();const{selectAll:t}=SR.getState();return void t(f.map(e=>e.path))}if(n&&"d"===e.key)return e.preventDefault(),void SR.getState().clearSelection();if(n&&"f"===e.key){e.preventDefault();const t=SR.getState();return void t.setShowSearchPanel(!t.showSearchPanel)}if(n&&"i"===e.key){e.preventDefault();const t=SR.getState();if(t.showDetailPanel)t.setShowDetailPanel(!1),t.setDetailFile(null);else if(1===t.selectedFiles.size){const e=Array.from(t.selectedFiles)[0],n=f.find(t=>t.path===e);n&&(t.setDetailFile(n),t.setShowDetailPanel(!0))}return}if("Enter"===e.key){const e=SR.getState();if(1===e.selectedFiles.size){const t=Array.from(e.selectedFiles)[0],n=f.find(e=>e.path===t);n&&e.setLightboxFile(n)}return}if(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(e.key)){e.preventDefault();const t=SR.getState();if(0===f.length)return;let n=-1;t.lastSelectedFile&&(n=f.findIndex(e=>e.path===t.lastSelectedFile));let a=0;return a="ArrowRight"===e.key||"ArrowDown"===e.key?n<f.length-1?n+1:0:n>0?n-1:f.length-1,t.clearSelection(),void t.selectFile(f[a].path)}if(!n&&e.key>="0"&&e.key<="5"){const t=parseInt(e.key,10),n=SR.getState();return void(n.selectedFiles.size>0&&n.selectedFiles.forEach(e=>{const n=f.find(t=>t.path===e);n&&Pe(n.rel_path,t)}))}if(!n&&("t"===e.key||"T"===e.key)){const e=SR.getState();return void e.setShowTimeline(!e.showTimeline)}}return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[f,ke,Pe]);const Be=Tt.useCallback(e=>{e.preventDefault(),pe.current=!0;const t=e.clientX,n=ue;function a(e){if(!pe.current)return;const a=e.clientX-t,r=Math.max(180,Math.min(400,n+a));he(r)}document.addEventListener("mousemove",a),document.addEventListener("mouseup",function e(){pe.current=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",e),document.body.style.cursor="",document.body.style.userSelect=""}),document.body.style.cursor="col-resize",document.body.style.userSelect="none"},[ue]);return t?Ut.jsxs("div",{className:"gallery-ui",children:[Ut.jsxs("aside",{className:"gallery-sidebar",style:{width:ue},children:[Ut.jsxs("div",{className:"gallery-sidebar-header",children:[Ut.jsx("span",{className:"gallery-sidebar-title",children:"Folders"}),Ut.jsx("button",{className:"gallery-sidebar-refresh-btn",onClick:be,title:"Refresh folder tree",type:"button",children:Ut.jsx(ck,{size:14})})]}),Ut.jsx("div",{className:"gallery-sidebar-content",children:Ut.jsx(ER,{folders:a,currentPath:r,projectPath:t,onNavigate:xe,onDropFiles:_e,onCreateFolder:Me})})]}),Ut.jsx("div",{className:"gallery-sidebar-resize-handle",onMouseDown:Be}),Ut.jsxs("section",{className:"gallery-main",children:[Ut.jsxs("div",{className:"gallery-toolbar-area",children:[Ut.jsx(PR,{onRefresh:be,orchestratorUrl:e,projectPath:t}),Ut.jsx(kR,{crumbs:WL(r||t,t),onNavigate:xe}),Ut.jsx(nI,{orchestratorUrl:e,folderPath:r||t}),Ut.jsx(ML,{})]}),h&&Ut.jsx("div",{className:"gallery-search-panel-anchor",children:Ut.jsx(kL,{orchestratorUrl:e,projectPath:t,currentPath:r||t,onSelectResult:Re,onClose:()=>p(!1)})}),o&&Ut.jsxs("div",{className:"gallery-error-banner",children:[Ut.jsx("span",{children:o}),Ut.jsx("button",{className:"gallery-error-dismiss",onClick:Te,"aria-label":"Dismiss error",children:""})]}),Ut.jsxs("div",{className:"gallery-content",children:[(i||s)&&Ut.jsx("div",{className:"gallery-loading-overlay",children:Ut.jsx("div",{className:"spinner"})}),J?Ut.jsx(UL,{files:f,orchestratorUrl:e,onSelectFile:De}):"list"===c?Ut.jsx(QR,{orchestratorUrl:e,projectPath:t,onContextMenu:Ce,onDoubleClick:De}):"masonry"===c?Ut.jsx(tI,{orchestratorUrl:e,projectPath:t,onContextMenu:Ce,onDoubleClick:De}):Ut.jsx(KR,{orchestratorUrl:e,projectPath:t,onContextMenu:Ce,onDoubleClick:De}),Ut.jsx(NL,{orchestratorUrl:e,projectPath:t,totalFiles:f.length,allFilePaths:f.map(e=>e.path),onMove:Ie,onTrash:Le,onCompare:Fe,onRefresh:be})]})]}),l&&g&&Ut.jsx("aside",{className:"gallery-detail-panel",children:Ut.jsx(wL,{file:g,orchestratorUrl:e,projectPath:t,rating:y[g.rel_path]??0,fileTags:g.tags??[],allTags:v,onRatingChange:Pe,onTagsChange:je,onClose:Ne,onCreateTag:Ae})}),Q&&Ut.jsx(fI,{x:Q.x,y:Q.y,file:Q.file,selectedFiles:m,onClose:()=>ee(null),onOpen:De,onRename:e=>{ee(null),ne(e)},onMove:e=>{ee(null),re(Ee(e[0]))},onMoveToNewFolder:e=>{ee(null),de(Ee(e[0]))},onBatchRename:e=>{ee(null),se(Ee(e[0]))},onTrash:e=>{ee(null),ke(Ee(e[0]))},onCompare:e=>{ee(null),Oe(e)},onInfo:e=>{ee(null),C(e),E(!0)}}),te&&Ut.jsx(vI,{file:te,orchestratorUrl:e,projectPath:t,onClose:()=>ne(null),onRenamed:be}),ae&&Ut.jsx(AI,{files:ae,orchestratorUrl:e,projectPath:t,folderTree:a,onClose:()=>re(null),onMoved:be}),ce&&Ut.jsx(VL,{files:ce,currentFolder:r||t,orchestratorUrl:e,projectPath:t,onMoved:()=>{de(null),be()},onClose:()=>de(null)}),ie&&Ut.jsx(LI,{files:ie,orchestratorUrl:e,projectPath:t,onClose:()=>se(null),onRenamed:be}),d&&Ut.jsx(FI,{orchestratorUrl:e,projectPath:t,onClose:()=>u(!1),onRestored:be}),oe&&Ut.jsx(HL,{filePaths:oe.filePaths,targetFolder:oe.targetFolder,orchestratorUrl:e,projectPath:t,onMoved:we,onClose:Se}),W&&Ut.jsx(PL,{file:W,files:f,orchestratorUrl:e,onClose:()=>G(null),onNavigate:Ue}),X&&X.length>=2&&Ut.jsx(RL,{files:X,orchestratorUrl:e,onClose:()=>q(null)}),K&&Ut.jsx(zL,{orchestratorUrl:e,projectPath:t,currentPath:r||t,onClose:()=>Y(!1),onTrash:ze})]}):Ut.jsx("div",{className:"gallery-ui",children:Ut.jsx("div",{className:"gallery-empty-state",children:"Open a project in Storyboard to browse the gallery"})})}function XL(){const[e,t]=Tt.useState({status:"processing",message:"Processing authorization..."});Tt.useEffect(()=>{(async()=>{const e=new URLSearchParams(window.location.search),n=e.get("code"),a=e.get("state"),r=e.get("error"),i=e.get("error_description");if(r)return t({status:"error",message:"Authorization failed",error:i||r}),void(window.opener&&window.opener.postMessage({type:"oauth_callback",error:r,error_description:i},window.location.origin));if(!n)return t({status:"error",message:"Missing authorization code",error:"No authorization code received from provider"}),void(window.opener&&window.opener.postMessage({type:"oauth_callback",error:"missing_code",error_description:"No authorization code received"},window.location.origin));const s=sessionStorage.getItem("oauth_state"),o=sessionStorage.getItem("oauth_provider");if(!a||a!==s)return t({status:"error",message:"Security validation failed",error:"State mismatch - possible CSRF attack. Please try again."}),void(window.opener&&window.opener.postMessage({type:"oauth_callback",error:"state_mismatch",error_description:"State parameter mismatch"},window.location.origin));if(!o)return t({status:"error",message:"Session expired",error:"Provider information not found. Please try again."}),void(window.opener&&window.opener.postMessage({type:"oauth_callback",error:"no_provider",error_description:"Provider session data missing"},window.location.origin));try{t({status:"processing",message:"Exchanging authorization code for tokens..."});const e=`${window.location.origin}/oauth/callback`,r=await Dm.exchangeOAuthCode(o,n,a,e);if(!r.success||!r.access_token)throw new Error("Token exchange failed - no access token received");sessionStorage.removeItem("oauth_state"),sessionStorage.removeItem("oauth_provider"),t({status:"success",message:"Authorization successful! You can close this window."}),window.opener&&(window.opener.postMessage({type:"oauth_callback",access_token:r.access_token,refresh_token:r.refresh_token,token_type:r.token_type,expires_in:r.expires_in,scope:r.scope},window.location.origin),setTimeout(()=>{window.close()},1500))}catch(l){const e=l instanceof Error?l.message:"Unknown error";t({status:"error",message:"Token exchange failed",error:e}),window.opener&&window.opener.postMessage({type:"oauth_callback",error:"token_exchange_failed",error_description:e},window.location.origin)}})()},[]);const n={fontSize:"3rem",marginBottom:"1rem"},a={fontSize:"1.25rem",fontWeight:600,marginBottom:"0.5rem"},r={fontSize:"0.9rem",color:"#a0a0a0",marginBottom:"1rem"};return Ut.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",padding:"2rem",fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',backgroundColor:"#1a1a2e",color:"#eaeaea"},children:[Ut.jsx("style",{children:"\n          @keyframes spin {\n            to { transform: rotate(360deg); }\n          }\n        "}),Ut.jsxs("div",{style:{backgroundColor:"#16213e",borderRadius:"12px",padding:"2rem",maxWidth:"400px",width:"100%",textAlign:"center",boxShadow:"0 4px 20px rgba(0, 0, 0, 0.3)"},children:["processing"===e.status&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{style:{width:"40px",height:"40px",border:"3px solid #2a3a5e",borderTopColor:"#4a9eff",borderRadius:"50%",animation:"spin 1s linear infinite",marginBottom:"1rem"}}),Ut.jsx("div",{style:a,children:e.message}),Ut.jsx("div",{style:r,children:"Please wait..."})]}),"success"===e.status&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{style:n,children:""}),Ut.jsx("div",{style:a,children:e.message}),Ut.jsx("div",{style:r,children:"This window will close automatically."})]}),"error"===e.status&&Ut.jsxs(Ut.Fragment,{children:[Ut.jsx("div",{style:n,children:""}),Ut.jsx("div",{style:a,children:e.message}),e.error&&Ut.jsx("div",{style:{fontSize:"0.85rem",color:"#ff6b6b",backgroundColor:"rgba(255, 107, 107, 0.1)",padding:"0.75rem",borderRadius:"6px",marginTop:"1rem"},children:e.error}),Ut.jsx("button",{style:{marginTop:"1.5rem",padding:"0.75rem 1.5rem",backgroundColor:"#4a9eff",color:"white",border:"none",borderRadius:"6px",cursor:"pointer",fontSize:"0.9rem",fontWeight:500},onClick:()=>window.close(),children:"Close Window"})]})]})]})}class qL extends Tt.Component{constructor(e){super(e),Le(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null})}),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){var n,a;console.error("ErrorBoundary caught an error:",e),console.error("Component stack:",t.componentStack),this.setState({errorInfo:t}),null==(a=(n=this.props).onError)||a.call(n,e,t)}render(){return this.state.hasError?this.props.fallback?this.props.fallback:Ut.jsx("div",{style:KL.container,children:Ut.jsxs("div",{style:KL.card,children:[Ut.jsx("div",{style:KL.iconContainer,children:Ut.jsx("span",{style:KL.icon,children:"!"})}),Ut.jsx("h2",{style:KL.title,children:"Something went wrong"}),Ut.jsx("p",{style:KL.message,children:"An unexpected error occurred. Please try again or refresh the page."}),this.state.error&&Ut.jsxs("details",{style:KL.details,children:[Ut.jsx("summary",{style:KL.summary,children:"Error Details"}),Ut.jsx("pre",{style:KL.errorText,children:this.state.error.toString()}),this.state.errorInfo&&Ut.jsx("pre",{style:KL.stackTrace,children:this.state.errorInfo.componentStack})]}),Ut.jsxs("div",{style:KL.buttonContainer,children:[Ut.jsx("button",{onClick:this.handleReset,style:KL.button,children:"Try Again"}),Ut.jsx("button",{onClick:()=>window.location.reload(),style:KL.secondaryButton,children:"Refresh Page"})]})]})}):this.props.children}}const KL={container:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"100vh",backgroundColor:"#0d1117",padding:"20px",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'},card:{backgroundColor:"#161b22",borderRadius:"12px",padding:"40px",maxWidth:"500px",width:"100%",textAlign:"center",boxShadow:"0 8px 24px rgba(0, 0, 0, 0.4)",border:"1px solid #30363d"},iconContainer:{width:"64px",height:"64px",borderRadius:"50%",backgroundColor:"rgba(248, 81, 73, 0.1)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 20px"},icon:{fontSize:"32px",color:"#f85149",fontWeight:"bold"},title:{color:"#e6edf3",fontSize:"24px",fontWeight:600,marginBottom:"12px",margin:"0 0 12px 0"},message:{color:"#8b949e",fontSize:"14px",lineHeight:1.6,marginBottom:"24px",margin:"0 0 24px 0"},details:{backgroundColor:"#0d1117",borderRadius:"8px",padding:"12px",marginBottom:"24px",textAlign:"left",border:"1px solid #30363d"},summary:{color:"#8b949e",cursor:"pointer",fontSize:"13px",fontWeight:500},errorText:{color:"#f85149",fontSize:"12px",marginTop:"12px",whiteSpace:"pre-wrap",wordBreak:"break-word",margin:"12px 0 0 0"},stackTrace:{color:"#8b949e",fontSize:"11px",marginTop:"8px",whiteSpace:"pre-wrap",wordBreak:"break-word",maxHeight:"200px",overflow:"auto",margin:"8px 0 0 0"},buttonContainer:{display:"flex",gap:"12px",justifyContent:"center"},button:{backgroundColor:"#238636",color:"#ffffff",border:"none",borderRadius:"6px",padding:"10px 20px",fontSize:"14px",fontWeight:500,cursor:"pointer",transition:"background-color 0.2s"},secondaryButton:{backgroundColor:"#21262d",color:"#c9d1d9",border:"1px solid #30363d",borderRadius:"6px",padding:"10px 20px",fontSize:"14px",fontWeight:500,cursor:"pointer",transition:"background-color 0.2s"}},YL=window.location.pathname.includes("/oauth/callback")||window.location.search.includes("code=")||window.location.search.includes("error="),JL=[{id:"cinema",label:"Cinema Prompt Engineering",icon:""},{id:"storyboard",label:"Storyboard",icon:""},{id:"gallery",label:"Gallery",icon:""}];function ZL(){const[e,t]=Tt.useState("cinema"),[n,a]=Tt.useState(()=>{try{const e=localStorage.getItem("storyboard_project_settings");if(e){return JSON.parse(e).path||""}}catch{}return""}),[r,i]=Tt.useState(()=>{try{const e=localStorage.getItem("storyboard_project_settings");if(e){return JSON.parse(e).orchestratorUrl||""}}catch{}return""});return Tt.useEffect(()=>{if("gallery"!==e)return;const t=setInterval(()=>{try{const e=localStorage.getItem("storyboard_project_settings");if(e){const t=JSON.parse(e);t.path&&a(t.path),t.orchestratorUrl&&i(t.orchestratorUrl)}}catch{}},2e3);return()=>clearInterval(t)},[e]),Ut.jsxs("div",{className:"directors-console",children:[Ut.jsxs("nav",{className:"directors-console__nav",children:[Ut.jsxs("div",{className:"directors-console__logo",children:[Ut.jsx("span",{className:"logo-icon",children:""}),Ut.jsx("span",{className:"logo-text",children:"Director's Console"})]}),Ut.jsx("div",{className:"directors-console__tabs",children:JL.map(n=>Ut.jsxs("button",{className:"tab-button "+(e===n.id?"active":""),onClick:()=>t(n.id),children:[Ut.jsx("span",{className:"tab-icon",children:n.icon}),Ut.jsx("span",{className:"tab-label",children:n.label})]},n.id))})]}),Ut.jsxs("main",{className:"directors-console__content",children:[Ut.jsx("div",{style:{display:"cinema"===e?"contents":"none"},children:Ut.jsx(qL,{children:Ut.jsx(Gg,{})})}),Ut.jsx("div",{style:{display:"storyboard"===e?"contents":"none"},children:Ut.jsx(qL,{children:Ut.jsx(wR,{})})}),Ut.jsx("div",{style:{display:"gallery"===e?"contents":"none"},children:Ut.jsx(qL,{children:Ut.jsx(GL,{orchestratorUrl:r,projectPath:n,isActive:"gallery"===e})})})]})]})}function QL(){return YL?Ut.jsx(XL,{}):Ut.jsx(qL,{children:Ut.jsx(ZL,{})})}const eD=new qp;Ot.createRoot(document.getElementById("root")).render(Ut.jsx(Nt.StrictMode,{children:Ut.jsx(Yp,{client:eD,children:Ut.jsx(QL,{})})}));
